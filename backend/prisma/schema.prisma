// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  free
  pro
  clinic
  enterprise
}

enum SubscriptionStatus {
  active
  paused
  cancelled
}

enum UserRole {
  owner
  admin
  dietitian
}

enum Gender {
  male
  female
  other
}

enum ActivityLevel {
  sedentary
  lightly_active
  moderately_active
  very_active
}

enum DietPlanStatus {
  draft
  active
  completed
  paused
}

enum DietPlanVisibility {
  private
  org_shared
  public
}

enum MealType {
  breakfast
  lunch
  snack
  dinner
}

enum MealLogStatus {
  pending
  eaten
  skipped
  substituted
}

enum NoteType {
  SOAP
  DAP
  other
}

enum RecipientType {
  user
  client
}

enum DeliveryStatus {
  pending
  delivered
  failed
}

enum InvitationStatus {
  pending
  accepted
  expired
}

enum InvoiceStatus {
  unpaid
  sent
  paid
  cancelled
}

enum ReferralSource {
  doctor
  dietitian
  client_referral
  social_media
  website
  other
}

// ============ MODELS ============

model Organization {
  id                    String             @id @default(uuid())
  name                  String             @unique
  slug                  String             @unique @default("")
  description           String?
  logoUrl               String?
  phone                 String?
  email                 String?
  address               String?
  city                  String?
  country               String             @default("IN")
  timezone              String             @default("Asia/Kolkata")
  subscriptionTier      SubscriptionTier   @default(free)
  subscriptionStatus    SubscriptionStatus @default(active)
  subscriptionExpiresAt DateTime?
  maxClients            Int                @default(10)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  deletedAt             DateTime?
  isActive              Boolean            @default(true)

  // Relations
  users            User[]
  clients          Client[]
  dietPlans        DietPlan[]
  foodItems        FoodItem[]
  mealLogs         MealLog[]
  weightLogs       WeightLog[]
  bodyMeasurements BodyMeasurement[]
  sessionNotes     SessionNote[]
  notifications    Notification[]
  activityLogs     ActivityLog[]
  invoices         Invoice[]
  invitations      Invitation[]
  clientReports    ClientReport[]

  @@index([subscriptionStatus])
  @@index([isActive])
}

model User {
  id              String    @id @default(uuid())
  orgId           String
  clerkUserId     String?   @unique
  role            UserRole
  email           String
  fullName        String
  phone           String?
  profilePhotoUrl String?
  licenseNumber   String?
  specialization  String?
  bio             String?
  mfaEnabled      Boolean   @default(false)
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  isActive        Boolean   @default(true)

  // Relations
  organization        Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  clientsPrimary      Client[]      @relation("PrimaryDietitian")
  createdDietPlans    DietPlan[]    @relation("DietPlanCreator")
  createdFoodItems    FoodItem[]    @relation("FoodItemCreator")
  reviewedMealLogs    MealLog[]     @relation("MealLogReviewer")
  createdSessionNotes SessionNote[] @relation("SessionNoteCreator")
  createdInvoices     Invoice[]     @relation("InvoiceCreator")
  activityLogs        ActivityLog[] @relation("UserActivityLog")

  pushTokens String[] @default([]) // Expo push tokens

  @@unique([orgId, email])
  @@index([orgId])
  @@index([clerkUserId])
  @@index([role])
}

model Client {
  id                    String         @id @default(uuid())
  orgId                 String
  primaryDietitianId    String
  email                 String
  phone                 String
  fullName              String
  dateOfBirth           DateTime?      @db.Date
  gender                Gender?
  profilePhotoUrl       String?
  heightCm              Decimal?       @db.Decimal(5, 2)
  currentWeightKg       Decimal?       @db.Decimal(5, 2)
  targetWeightKg        Decimal?       @db.Decimal(5, 2)
  targetCalories        Int?
  targetProteinG        Decimal?       @db.Decimal(5, 1)
  targetCarbsG          Decimal?       @db.Decimal(5, 1)
  targetFatsG           Decimal?       @db.Decimal(5, 1)
  activityLevel         ActivityLevel?
  dietaryPreferences    String[]
  allergies             String[]
  medicalConditions     String[]
  medications           String[]
  healthNotes           String?
  emergencyContactName  String?
  emergencyContactPhone String?
  onboardingCompleted   Boolean        @default(false)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  deletedAt             DateTime?
  createdByUserId       String?
  isActive              Boolean        @default(true)

  // Validation Tags (for diet validation engine)
  intolerances      String[] @default([]) // Separate from allergies (e.g., lactose)
  dietPattern       String? // "vegetarian", "vegan", "non_veg", "pescatarian"
  eggAllowed        Boolean  @default(true)
  eggAvoidDays      String[] @default([]) // ["tuesday", "thursday"]
  dislikes          String[] @default([]) // Food names client dislikes
  avoidCategories   String[] @default([]) // ["fried_foods", "processed"]
  labDerivedTags    String[] @default([]) // ["vitamin_d_deficiency", "high_cholesterol"]
  likedFoods        String[] @default([]) // Food IDs client likes
  preferredCuisines String[] @default([]) // ["indian", "mughlai"]
  foodRestrictions  Json     @default("[]") // Array of FoodRestriction objects for flexible restrictions

  // Referral tracking
  referralSource      ReferralSource?
  referralSourceName  String? // Doctor/Dietitian name if applicable
  referralSourcePhone String? // Contact phone for referrer
  referralCode        String?
  referredByClientId  String?

  // Relations
  organization     Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  primaryDietitian User              @relation("PrimaryDietitian", fields: [primaryDietitianId], references: [id])
  medicalProfile   MedicalProfile?
  dietPlans        DietPlan[]
  mealLogs         MealLog[]
  weightLogs       WeightLog[]
  bodyMeasurements BodyMeasurement[]
  sessionNotes     SessionNote[]
  invoices         Invoice[]
  referralBenefit  ReferralBenefit?
  clientReports    ClientReport[]
  preferences      ClientPreferences?

  // Self-referential relation for client referrals
  referredByClient Client?  @relation("ClientReferrals", fields: [referredByClientId], references: [id])
  referredClients  Client[] @relation("ClientReferrals")

  pushTokens String[] @default([]) // Expo push tokens
  refreshTokens ClientRefreshToken[]

  @@unique([orgId, email])
  @@unique([orgId, referralCode])
  @@index([orgId])
  @@index([primaryDietitianId])
  @@index([isActive])
  @@index([referralCode])
  @@index([referredByClientId])
  @@index([orgId, isActive, createdAt])
  @@index([dietPattern])
}

model ClientRefreshToken {
  id        String   @id @default(uuid())
  clientId  String
  tokenHash String   @unique
  familyId  String
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([familyId])
}

model MedicalProfile {
  id                  String   @id @default(uuid())
  clientId            String   @unique
  diagnoses           String[]
  allergies           String[]
  intolerances        String[]
  medications         String[]
  supplements         String[]
  surgeries           String[]
  familyHistory       String?
  healthNotes         String?
  dietaryRestrictions String?
  labValues           Json?
  labDate             DateTime?
  labDerivedTags      String[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  updatedByUserId     String?

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model DietPlan {
  id               String             @id @default(uuid())
  orgId            String
  clientId         String? // Optional for templates
  createdByUserId  String
  name             String
  description      String?
  startDate        DateTime           @db.Date
  endDate          DateTime?          @db.Date
  targetCalories   Int?
  targetProteinG   Decimal?           @db.Decimal(5, 1)
  targetCarbsG     Decimal?           @db.Decimal(5, 1)
  targetFatsG      Decimal?           @db.Decimal(5, 1)
  targetFiberG     Decimal?           @db.Decimal(5, 1)
  notesForClient   String?
  internalNotes    String?
  status           DietPlanStatus     @default(draft)
  isTemplate       Boolean            @default(false)
  templateCategory String?
  visibility       DietPlanVisibility @default(private)
  publishedAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  deletedAt        DateTime?
  isActive         Boolean            @default(true)

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client?      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  creator      User         @relation("DietPlanCreator", fields: [createdByUserId], references: [id])
  meals        Meal[]

  @@index([orgId])
  @@index([clientId])
  @@index([status])
  @@index([isTemplate])
  @@index([orgId, status, createdAt])
  @@index([clientId, status])
}

model Meal {
  id               String    @id @default(uuid())
  planId           String
  dayOfWeek        Int?
  mealDate         DateTime? @db.Date
  sequenceNumber   Int?
  mealType         MealType
  timeOfDay        String?
  name             String
  description      String?
  instructions     String?
  servingSizeNotes String?
  totalCalories    Int?
  totalProteinG    Decimal?  @db.Decimal(5, 1)
  totalCarbsG      Decimal?  @db.Decimal(5, 1)
  totalFatsG       Decimal?  @db.Decimal(5, 1)
  totalFiberG      Decimal?  @db.Decimal(5, 1)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  createdByUserId  String?

  // Relations
  dietPlan  DietPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  foodItems MealFoodItem[]
  mealLogs  MealLog[]

  @@index([planId])
  @@index([mealDate])
  @@index([createdByUserId])
}

model FoodItem {
  id              String   @id @default(uuid())
  orgId           String?
  name            String
  brand           String?
  category        String
  subCategory     String?
  servingSizeG    Decimal  @default(100) @db.Decimal(6, 2)
  calories        Int
  proteinG        Decimal? @db.Decimal(5, 1)
  carbsG          Decimal? @db.Decimal(5, 1)
  fatsG           Decimal? @db.Decimal(5, 1)
  fiberG          Decimal? @db.Decimal(5, 1)
  sodiumMg        Decimal? @db.Decimal(7, 2)
  sugarG          Decimal? @db.Decimal(5, 1)
  isVerified      Boolean  @default(false)
  source          String?
  barcode         String?
  allergenFlags   String[]
  dietaryTags     String[]
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  updatedByUserId String?

  // Validation Tags (for diet validation engine)
  nutritionTags       String[] @default([]) // ["high_protein", "low_carb", "high_sugar"]
  healthFlags         String[] @default([]) // ["diabetic_caution", "heart_caution"]
  cuisineTags         String[] @default([]) // ["indian", "chinese", "mughlai"]
  processingLevel     String? // "raw", "minimally_processed", "processed", "ultra_processed"
  mealSuitabilityTags String[] @default([]) // ["good_for_breakfast", "too_heavy_for_night"]
  dietaryCategory     String? // "vegan", "vegetarian", "veg_with_egg", "non_veg"

  // Relations
  organization  Organization?  @relation(fields: [orgId], references: [id], onDelete: SetNull)
  creator       User?          @relation("FoodItemCreator", fields: [createdByUserId], references: [id])
  mealFoodItems MealFoodItem[]

  @@index([orgId])
  @@index([category])
  @@index([orgId, category])
}

model MealFoodItem {
  id        String   @id @default(uuid())
  mealId    String
  foodId    String
  quantityG Decimal  @db.Decimal(6, 2)
  calories  Int?
  proteinG  Decimal? @db.Decimal(5, 1)
  carbsG    Decimal? @db.Decimal(5, 1)
  fatsG     Decimal? @db.Decimal(5, 1)
  fiberG    Decimal? @db.Decimal(5, 1)
  sortOrder Int      @default(0)
  notes           String?
  optionGroup     Int      @default(0) // 0 = default, 1+ = alternative meal options
  optionLabel     String?              // e.g. "Oatmeal Bowl", "Egg Plate"
  createdAt       DateTime @default(now())
  deletedAt       DateTime?
  createdByUserId String?

  // Relations
  meal     Meal     @relation(fields: [mealId], references: [id], onDelete: Cascade)
  foodItem FoodItem @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([mealId])
  @@index([foodId])
  @@index([mealId, optionGroup])
  @@index([createdByUserId])
}

model MealLog {
  id                    String        @id @default(uuid())
  orgId                 String
  clientId              String
  mealId                String
  scheduledDate         DateTime      @db.Date
  scheduledTime         String?
  status                MealLogStatus @default(pending)
  mealPhotoUrl          String?
  mealPhotoSmallUrl     String?
  photoUploadedAt       DateTime?
  aiFoodRecognition     Json?
  clientNotes           String?
  dietitianFeedback     String?
  dietitianFeedbackAt   DateTime?
  reviewedByUserId      String?
  substituteDescription String?
  substituteCaloriesEst Int?
  loggedAt              DateTime?

  // Option tracking (for meals with alternatives)
  chosenOptionGroup Int? // which option the client chose (null = default option 0)

  // Compliance Tracking
  complianceScore  Int? // 0-100
  complianceColor  String? // GREEN, YELLOW, RED
  complianceIssues String[] @default([]) // ["portion_exceeded", "forbidden_food"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  meal         Meal         @relation(fields: [mealId], references: [id], onDelete: Cascade)
  reviewer     User?        @relation("MealLogReviewer", fields: [reviewedByUserId], references: [id])

  @@unique([clientId, mealId, scheduledDate])
  @@index([orgId])
  @@index([clientId])
  @@index([scheduledDate])
  @@index([status])
  @@index([orgId, status, scheduledDate])
  @@index([clientId, scheduledDate])
}

model WeightLog {
  id                       String   @id @default(uuid())
  orgId                    String
  clientId                 String
  weightKg                 Decimal  @db.Decimal(5, 2)
  logDate                  DateTime @db.Date
  logTime                  String?
  notes                    String?
  progressPhotoUrl         String?
  bmi                      Decimal? @db.Decimal(4, 2)
  weightChangeFromPrevious Decimal? @db.Decimal(5, 2)
  isOutlier                Boolean  @default(false)
  createdAt                DateTime @default(now())
  deletedAt                DateTime?
  createdByUserId          String?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, logDate])
  @@index([orgId])
  @@index([clientId])
  @@index([clientId, logDate])
}

model BodyMeasurement {
  id                String   @id @default(uuid())
  orgId             String
  clientId          String
  logDate           DateTime @db.Date
  chestCm           Decimal? @db.Decimal(5, 2)
  waistCm           Decimal? @db.Decimal(5, 2)
  hipsCm            Decimal? @db.Decimal(5, 2)
  thighsCm          Decimal? @db.Decimal(5, 2)
  armsCm            Decimal? @db.Decimal(5, 2)
  bodyFatPercentage Decimal? @db.Decimal(4, 2)
  notes             String?
  createdAt         DateTime @default(now())
  deletedAt         DateTime?
  createdByUserId   String?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([clientId])
}

model SessionNote {
  id              String    @id @default(uuid())
  orgId           String
  clientId        String
  createdByUserId String
  noteType        NoteType
  title           String
  subjective      String?
  objective       String?
  assessment      String?
  plan            String?
  internalNotes   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  creator      User         @relation("SessionNoteCreator", fields: [createdByUserId], references: [id])

  @@index([orgId])
  @@index([clientId])
}

model Notification {
  id                String         @id @default(uuid())
  recipientId       String
  recipientType     RecipientType
  orgId             String
  type              String
  category          String?
  title             String
  message           String
  icon              String?
  deepLink          String?
  relatedEntityType String?
  relatedEntityId   String?
  isRead            Boolean        @default(false)
  readAt            DateTime?
  sentViaChannels   String[]       @default(["push"])
  deliveryStatus    DeliveryStatus @default(pending)
  createdAt         DateTime       @default(now())
  expiresAt         DateTime       @default(dbgenerated("NOW() + INTERVAL '30 days'"))

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([recipientId, recipientType])
  @@index([isRead])
  @@index([orgId])
  @@index([recipientId, recipientType, isRead, createdAt])
}

model ActivityLog {
  id           String   @id @default(uuid())
  orgId        String
  userId       String?
  userType     String?
  action       String
  entityType   String?
  entityId     String?
  oldValues    Json?
  newValues    Json?
  changeDesc   String?
  ipAddress    String?
  userAgent    String?
  status       String   @default("success")
  errorMessage String?
  metadata     Json?
  createdAt    DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User?        @relation("UserActivityLog", fields: [userId], references: [id])

  @@index([orgId])
  @@index([userId])
  @@index([action])
}

model Invoice {
  id              String        @id @default(uuid())
  orgId           String
  clientId        String
  createdByUserId String
  invoiceNumber   String        @unique
  issueDate       DateTime      @db.Date
  dueDate         DateTime      @db.Date
  currency        String        @default("INR")
  subtotal        Decimal       @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  status          InvoiceStatus @default(unpaid)
  notes           String?
  sentAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  creator      User         @relation("InvoiceCreator", fields: [createdByUserId], references: [id])

  @@index([orgId])
  @@index([clientId])
  @@index([status])
}

model Invitation {
  id        String   @id @default(uuid())
  email     String
  role      UserRole
  token     String   @unique
  orgId     String
  expiresAt DateTime
  status    InvitationStatus @default(pending)
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([token])
  @@index([email])
}

model ReferralBenefit {
  id               String   @id @default(uuid())
  clientId         String   @unique
  referralCount    Int      @default(0)
  freeMonthsEarned Int      @default(0)
  freeMonthsUsed   Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model ClientReport {
  id         String   @id @default(uuid())
  orgId      String
  clientId   String
  fileName   String
  fileUrl    String
  fileType   String // pdf, image
  reportType String? // blood_test, scan, prescription, other
  notes      String?
  uploadedAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([orgId])
}

model ClientPreferences {
  id               String   @id @default(uuid())
  clientId         String   @unique
  breakfastTime    String?
  lunchTime        String?
  dinnerTime       String?
  snackTime        String?
  canCook          Boolean  @default(true)
  kitchenAvailable Boolean  @default(true)
  hasDietaryCook   Boolean  @default(false)
  weekdayActivity  String?
  weekendActivity  String?
  sportOrHobby     String?
  generalNotes     String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}
