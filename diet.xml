This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.opencode/
  plans/
    TECH-SPEC-IMPLEMENTATION.md
backend/
  prisma/
    migrations/
      20251207194046_init/
        migration.sql
      migration_lock.toml
    schema.prisma
  scripts/
    deduplicate-meallogs.ts
    seedCommonFoods.ts
    setup-garage.sh
    setup-test-data.ts
  src/
    config/
      compliance.config.ts
      validation-rules.config.ts
    controllers/
      adminReferral.controller.ts
      auth.controller.ts
      client.controller.ts
      clientAuth.controller.ts
      compliance.controller.ts
      dashboard.controller.ts
      dietPlan.controller.ts
      foodItem.controller.ts
      meal.controller.ts
      mealLog.controller.ts
      notification.controller.ts
      onboarding.controller.ts
      organization.controller.ts
      referral.controller.ts
      reports.controller.ts
      share.controller.ts
      team.controller.ts
      validation.controller.ts
      weightLog.controller.ts
    errors/
      AppError.ts
    middleware/
      auth.middleware.ts
      clientAuth.middleware.ts
      errorHandler.ts
      testAuth.middleware.ts
      upload.middleware.ts
      validation.middleware.ts
    routes/
      adminReferral.routes.ts
      auth.routes.ts
      client.routes.ts
      clientApi.routes.ts
      clientAuth.routes.ts
      compliance.routes.ts
      dashboard.routes.ts
      dietPlan.routes.ts
      foodItem.routes.ts
      meal.routes.ts
      mealLog.routes.ts
      media.routes.ts
      notification.routes.ts
      onboarding.routes.ts
      organization.routes.ts
      referral.routes.ts
      reports.routes.ts
      share.routes.ts
      team.routes.ts
      test.routes.ts
      validation.routes.ts
      weightLog.routes.ts
    schemas/
      backend.xml
      client.schema.ts
      dietPlan.schema.ts
      foodItem.schema.ts
      mealLog.schema.ts
      organization.schema.ts
      weightLog.schema.ts
    services/
      client.service.ts
      compliance.service.ts
      dietPlan.service.ts
      foodItem.service.ts
      foodTagging.service.ts
      lab.service.ts
      meal.service.ts
      mealLog.service.ts
      notification.service.ts
      onboarding.service.ts
      storage.service.ts
      validationEngine.service.ts
      weightLog.service.ts
    types/
      auth.types.ts
      medical.types.ts
      validation.types.ts
    utils/
      asyncHandler.ts
      emailService.ts
      lab-reference-ranges.ts
      logger.ts
      nutritionCalculator.ts
      pdfGenerator.ts
      prisma.ts
      queryFilters.ts
      responseHelpers.ts
      validation-rules.ts
    app.ts
    server.ts
  tests/
    validationEngine.test.ts
  .env.example
  .gitignore
  package.json
  prisma.config.ts
  tsconfig.json
client-app/
  app/
    (auth)/
      _layout.tsx
      login.tsx
      verify.tsx
    (onboarding)/
      _layout.tsx
      complete.tsx
      step1.tsx
      step2.tsx
      step3.tsx
      step4.tsx
      step5.tsx
      step6.tsx
    (tabs)/
      home/
        meal/
          [id].tsx
        _layout.tsx
        index.tsx
      notifications/
        _layout.tsx
        index.tsx
      profile/
        _layout.tsx
        body-profile.tsx
        dietary-info.tsx
        index.tsx
        preferences.tsx
        referral.tsx
        reports.tsx
      progress/
        _layout.tsx
        index.tsx
      weight/
        _layout.tsx
        index.tsx
      _layout.tsx
    _layout.tsx
    index.tsx
  assets/
    adaptive-icon.png
    favicon.png
    icon.png
    splash-icon.png
  components/
    BottomTabBar.tsx
    Card.tsx
    EmptyState.tsx
    LoadingScreen.tsx
    MealCard.tsx
    OfflineBanner.tsx
    StatusBadge.tsx
    Toast.tsx
  constants/
    theme.ts
  contexts/
    AuthContext.tsx
  hooks/
    useAdherence.ts
    useAuth.ts
    useMealLog.ts
    useMeals.ts
    useNetworkStatus.ts
    useOnboarding.ts
    useWeight.ts
  services/
    api.ts
  store/
    authStore.ts
  types/
    index.ts
  utils/
    errorHandler.ts
  .gitignore
  .npmrc
  app.json
  package.json
  tsconfig.json
Design/
  mobileapp/
    dietician's_remark_detail/
      code.html
      screen.png
    home_/
      _today’s_meals/
        code.html
        screen.png
    log_meal_screen/
      code.html
      screen.png
    notifications_(inbox)/
      code.html
      screen.png
    progress_tab/
      code.html
      screen.png
    settings/
      profile/
        code.html
        screen.png
    weight_tracking/
      code.html
      screen.png
  website/
    Design/
      analytics/
        progress/
          code.html
          screen.png
      client_list/
        code.html
        screen.png
      client_profile_view/
        code.html
        screen.png
      dashboard_home/
        code.html
        screen.png
      diet_options_library/
        code.html
        screen.png
      diet_plan_builder_flow/
        code.html
        screen.png
      diet_plan_creation_page_1/
        code.html
        screen.png
      diet_plan_creation_page_2/
        code.html
        screen.png
      diet_plan_creation_page_3/
        code.html
        screen.png
      landingpage/
        code.html
        screen.png
      meal_photo_review_queue/
        code.html
        screen.png
      team_dieticians/
        code.html
        screen.png
doc/
  00-overview.md
  01-backend-architecture.md
  02-frontend-dashboard.md
  03-mobile-app.md
  04-database-schema.md
  05-food-validation-engine.md
  06-compliance-service.md
  07-onboarding-flow.md
  08-code-quality-testing.md
  09-notifications-push.md
  10-session-notes-invoicing.md
  11-mobile-screens-completion.md
  12-dashboard-pages-completion.md
frontend/
  src/
    app/
      dashboard/
        analytics/
          page.tsx
        clients/
          [id]/
            page.tsx
          new/
            page.tsx
          page.tsx
        diet-plans/
          [id]/
            page.tsx
          new/
            page.tsx
          page.tsx
        food-library/
          page.tsx
        referrals/
          page.tsx
        reviews/
          page.tsx
        settings/
          page.tsx
        team/
          page.tsx
        layout.tsx
        page.tsx
      fonts/
        GeistMonoVF.woff
        GeistVF.woff
      join/
        page.tsx
      sign-in/
        [[...sign-in]]/
          page.tsx
      sign-up/
        [[...sign-up]]/
          page.tsx
      favicon.ico
      globals.css
      layout.tsx
      page.tsx
      providers.tsx
    components/
      diet-plan/
        client-info-card.tsx
        client-restrictions-summary.tsx
        client-selector.tsx
        day-navigator.tsx
        meal-editor.tsx
        medical-sidebar.tsx
        nutrition-summary.tsx
        template-sidebar.tsx
        validation-alert.tsx
      modals/
        add-client-modal.tsx
        add-food-modal.tsx
        create-food-item-modal.tsx
        invite-member-modal.tsx
      ui/
        modal.tsx
      error-boundary.tsx
    lib/
      api/
        use-api-client.ts
      hooks/
        use-clients.ts
        use-compliance.ts
        use-dashboard.ts
        use-diet-plans.ts
        use-food-items.ts
        use-meal-builder.ts
        use-meal-logs.ts
        use-medical-summary.ts
        use-profile.ts
        use-team.ts
        use-validation.ts
      types/
        diet-plan.types.ts
      utils/
        formatters.ts
      utils.ts
    middleware.ts
  .env.local.example
  .eslintrc.json
  .gitignore
  next.config.mjs
  package.json
  postcss.config.mjs
  README.md
  tailwind.config.ts
  tsconfig.json
.gitignore
dev-all.sh
DietKaro-Complete-System-Spec.md
FOOD_VALIDATION_TECH_SPEC.md
human.html
info.txt
medical-log-analysis-spec.md
remaining.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="backend/src/schemas/backend.xml">
This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
client.schema.ts
dietPlan.schema.ts
foodItem.schema.ts
mealLog.schema.ts
organization.schema.ts
weightLog.schema.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="client.schema.ts">
import { z } from 'zod';

export const createClientSchema = z.object({
    fullName: z.string().min(2, 'Full name must be at least 2 characters'),
    email: z.string().email('Invalid email format'),
    phone: z.string().min(10, 'Phone must be at least 10 characters'),
    dateOfBirth: z.string().optional(),
    gender: z.enum(['male', 'female', 'other']).optional(),
    heightCm: z.number().min(50).max(300).optional(),
    currentWeightKg: z.number().min(10).max(500).optional(),
    targetWeightKg: z.number().min(10).max(500).optional(),
    targetCalories: z.number().min(500).max(10000).optional().nullable(),
    targetProteinG: z.number().min(0).max(500).optional().nullable(),
    targetCarbsG: z.number().min(0).max(1000).optional().nullable(),
    targetFatsG: z.number().min(0).max(500).optional().nullable(),
    activityLevel: z.enum(['sedentary', 'light', 'moderate', 'active', 'very_active']).optional(),
    primaryDietitianId: z.string().uuid().optional(),
    dietaryPreferences: z.array(z.string().min(1).max(100)).max(30).optional().default([]),
    allergies: z.array(z.string().min(1).max(100)).max(20).optional().default([]),
    medicalConditions: z.array(z.string().min(1).max(100)).max(20).optional().default([]),
    medications: z.array(z.string().min(1).max(100)).max(30).optional().default([]),
    healthNotes: z.string().optional()
});

export const updateClientSchema = createClientSchema.partial();

export const clientIdParamSchema = z.object({
    id: z.string().uuid('Invalid client ID')
});

export type CreateClientInput = z.infer<typeof createClientSchema>;
export type UpdateClientInput = z.infer<typeof updateClientSchema>;
</file>

<file path="dietPlan.schema.ts">
import { z } from 'zod';

export const createDietPlanSchema = z.object({
    clientId: z.string().uuid('Invalid client ID'),
    name: z.string().min(2, 'Plan name must be at least 2 characters'),
    description: z.string().optional(),
    startDate: z.string().refine((val) => !isNaN(Date.parse(val)), 'Invalid start date'),
    endDate: z.string().refine((val) => !isNaN(Date.parse(val)), 'Invalid end date').optional(),
    targetCalories: z.number().min(500).max(10000).optional(),
    targetProteinG: z.number().min(0).max(500).optional(),
    targetCarbsG: z.number().min(0).max(1000).optional(),
    targetFatsG: z.number().min(0).max(500).optional(),
    targetFiberG: z.number().min(0).max(200).optional(),
    notesForClient: z.string().optional(),
    internalNotes: z.string().optional(),
    meals: z.array(z.object({
        dayIndex: z.number().min(0).max(6).optional(),
        mealDate: z.string().optional(),
        mealType: z.string(),
        timeOfDay: z.string().optional(),
        title: z.string(),
        description: z.string().optional(),
        instructions: z.string().optional(),
        foodItems: z.array(z.object({
            foodId: z.string().uuid(),
            quantity: z.number().min(0),
            notes: z.string().optional()
        })).optional()
    })).optional(),
    options: z.object({
        saveAsTemplate: z.boolean().optional(),
        templateCategory: z.string().optional()
    }).optional()
});

export const updateDietPlanSchema = createDietPlanSchema.partial().omit({ clientId: true });

export type CreateDietPlanInput = z.infer<typeof createDietPlanSchema>;
export type UpdateDietPlanInput = z.infer<typeof updateDietPlanSchema>;
</file>

<file path="foodItem.schema.ts">
import { z } from 'zod';

// Create Food Item
export const createFoodItemSchema = z.object({
    name: z.string().min(1, 'Name is required').max(255),
    brand: z.string().max(100).optional(),
    category: z.string().min(1, 'Category is required'),
    subCategory: z.string().optional(),
    servingSizeG: z.number().positive().default(100),
    calories: z.number().int().min(0),
    proteinG: z.number().min(0).optional(),
    carbsG: z.number().min(0).optional(),
    fatsG: z.number().min(0).optional(),
    fiberG: z.number().min(0).optional(),
    sodiumMg: z.number().min(0).optional(),
    sugarG: z.number().min(0).optional(),
    barcode: z.string().optional(),
    allergenFlags: z.array(z.string()).default([]),
    dietaryTags: z.array(z.string()).default([])
});

export type CreateFoodItemInput = z.infer<typeof createFoodItemSchema>;

// Update Food Item
export const updateFoodItemSchema = createFoodItemSchema.partial();

export type UpdateFoodItemInput = z.infer<typeof updateFoodItemSchema>;

// Add Food to Meal
export const addFoodToMealSchema = z.object({
    foodId: z.string().uuid(),
    quantityG: z.number().positive(),
    notes: z.string().optional()
});

export type AddFoodToMealInput = z.infer<typeof addFoodToMealSchema>;

// Update Food in Meal
export const updateMealFoodItemSchema = z.object({
    quantityG: z.number().positive().optional(),
    notes: z.string().optional()
});

export type UpdateMealFoodItemInput = z.infer<typeof updateMealFoodItemSchema>;
</file>

<file path="mealLog.schema.ts">
import { z } from 'zod';

export const createMealLogSchema = z.object({
    clientId: z.string().uuid('Invalid client ID'),
    mealId: z.string().uuid('Invalid meal ID'),
    scheduledDate: z.string().refine((val) => !isNaN(Date.parse(val)), 'Invalid scheduled date'),
    scheduledTime: z.string().optional()
});

export const updateMealLogSchema = z.object({
    status: z.enum(['pending', 'eaten', 'substituted', 'skipped']).optional(),
    photoUrl: z.string().url().optional(),
    clientNotes: z.string().optional(),
    substituteDescription: z.string().optional(),
    substituteCaloriesEst: z.number().optional()
});

export const reviewMealLogSchema = z.object({
    dietitianFeedback: z.string().optional(),
    status: z.enum(['pending', 'eaten', 'substituted', 'skipped']).optional(),
    overrideCalories: z.number().optional()
});

export const mealLogQuerySchema = z.object({
    clientId: z.string().uuid().optional(),
    dateFrom: z.string().optional(),
    dateTo: z.string().optional(),
    status: z.enum(['pending', 'eaten', 'substituted', 'skipped']).optional(),
    page: z.string().optional().default('1'),
    pageSize: z.string().optional().default('20'),
    sortBy: z.string().optional().default('scheduledDate')
});

export type CreateMealLogInput = z.infer<typeof createMealLogSchema>;
export type UpdateMealLogInput = z.infer<typeof updateMealLogSchema>;
export type ReviewMealLogInput = z.infer<typeof reviewMealLogSchema>;
</file>

<file path="organization.schema.ts">
import { z } from 'zod';

export const createOrganizationSchema = z.object({
    name: z.string().min(2, 'Organization name must be at least 2 characters'),
    description: z.string().optional(),
    email: z.string().email('Invalid email format').optional(),
    phone: z.string().optional(),
    address: z.string().optional(),
    city: z.string().optional(),
    country: z.string().default('IN'),
    timezone: z.string().default('Asia/Kolkata')
});

export type CreateOrganizationInput = z.infer<typeof createOrganizationSchema>;
</file>

<file path="weightLog.schema.ts">
import { z } from 'zod';

export const createWeightLogSchema = z.object({
    logDate: z.string().refine((val) => !isNaN(Date.parse(val)), 'Invalid log date'),
    logTime: z.string().optional(),
    weightKg: z.number().min(10, 'Weight must be at least 10kg').max(500, 'Weight must be less than 500kg'),
    notes: z.string().optional(),
    progressPhotoUrl: z.string().url().optional()
});

export const weightLogQuerySchema = z.object({
    clientId: z.string().uuid('Invalid client ID'),
    dateFrom: z.string().optional(),
    dateTo: z.string().optional(),
    page: z.string().optional().default('1'),
    pageSize: z.string().optional().default('100')
});

export type CreateWeightLogInput = z.infer<typeof createWeightLogSchema>;
</file>

</files>
</file>

<file path="Design/mobileapp/home_/_today’s_meals/code.html">
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex h-auto min-h-screen w-full flex-col bg-[#f8fcf9] justify-between group/design-root overflow-x-hidden"
      style="--select-button-svg: url('data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724px%27 height=%2724px%27 fill=%27rgb(76,154,102)%27 viewBox=%270 0 256 256%27%3e%3cpath d=%27M181.66,170.34a8,8,0,0,1,0,11.32l-48,48a8,8,0,0,1-11.32,0l-48-48a8,8,0,0,1,11.32-11.32L128,212.69l42.34-42.35A8,8,0,0,1,181.66,170.34Zm-96-84.68L128,43.31l42.34,42.35a8,8,0,0,0,11.32-11.32l-48-48a8,8,0,0,0-11.32,0l-48,48A8,8,0,0,0,85.66,85.66Z%27%3e%3c/path%3e%3c/svg%3e'); font-family: Manrope, &quot;Noto Sans&quot;, sans-serif;"
    >
      <div>
        <div class="flex items-center bg-[#f8fcf9] p-4 pb-2 justify-between">
          <div class="flex size-12 shrink-0 items-center">
            <div
              class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBI6BZqDAVJILMHj1ollqNY2dXErmVVwy85KhGIahpmjJIC_5a5GGBDYSBCJq0q0Id8MHmTZ_14XhWgGib1j10n6CB7uZbmytwN1lmIxnQIEWiI7fDeRn_997q9mnqIzH-QI-1MgcclBMBSHIXq0mH-4LvCLquhZWXnp3ff2JiK0Es1qkz6sy0zzRe0vTSkjUdkApEauq2ePpN09JtWWzYDOtmODr7A-ab3706y9DIB3EAw4Uj_nsc9naakMtw4VES2-EzaID1rHzGE");'
            ></div>
          </div>
          <div class="flex w-12 items-center justify-end">
            <button
              class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 bg-transparent text-[#0d1b12] gap-2 text-base font-bold leading-normal tracking-[0.015em] min-w-0 p-0"
            >
              <div class="text-[#0d1b12]" data-icon="Gear" data-size="24px" data-weight="regular">
                <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                  <path
                    d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Zm88-29.84q.06-2.16,0-4.32l14.92-18.64a8,8,0,0,0,1.48-7.06,107.21,107.21,0,0,0-10.88-26.25,8,8,0,0,0-6-3.93l-23.72-2.64q-1.48-1.56-3-3L186,40.54a8,8,0,0,0-3.94-6,107.71,107.71,0,0,0-26.25-10.87,8,8,0,0,0-7.06,1.49L130.16,40Q128,40,125.84,40L107.2,25.11a8,8,0,0,0-7.06-1.48A107.6,107.6,0,0,0,73.89,34.51a8,8,0,0,0-3.93,6L67.32,64.27q-1.56,1.49-3,3L40.54,70a8,8,0,0,0-6,3.94,107.71,107.71,0,0,0-10.87,26.25,8,8,0,0,0,1.49,7.06L40,125.84Q40,128,40,130.16L25.11,148.8a8,8,0,0,0-1.48,7.06,107.21,107.21,0,0,0,10.88,26.25,8,8,0,0,0,6,3.93l23.72,2.64q1.49,1.56,3,3L70,215.46a8,8,0,0,0,3.94,6,107.71,107.71,0,0,0,26.25,10.87,8,8,0,0,0,7.06-1.49L125.84,216q2.16.06,4.32,0l18.64,14.92a8,8,0,0,0,7.06,1.48,107.21,107.21,0,0,0,26.25-10.88,8,8,0,0,0,3.93-6l2.64-23.72q1.56-1.48,3-3L215.46,186a8,8,0,0,0,6-3.94,107.71,107.71,0,0,0,10.87-26.25,8,8,0,0,0-1.49-7.06Zm-16.1-6.5a73.93,73.93,0,0,1,0,8.68,8,8,0,0,0,1.74,5.48l14.19,17.73a91.57,91.57,0,0,1-6.23,15L187,173.11a8,8,0,0,0-5.1,2.64,74.11,74.11,0,0,1-6.14,6.14,8,8,0,0,0-2.64,5.1l-2.51,22.58a91.32,91.32,0,0,1-15,6.23l-17.74-14.19a8,8,0,0,0-5-1.75h-.48a73.93,73.93,0,0,1-8.68,0,8,8,0,0,0-5.48,1.74L100.45,215.8a91.57,91.57,0,0,1-15-6.23L82.89,187a8,8,0,0,0-2.64-5.1,74.11,74.11,0,0,1-6.14-6.14,8,8,0,0,0-5.1-2.64L46.43,170.6a91.32,91.32,0,0,1-6.23-15l14.19-17.74a8,8,0,0,0,1.74-5.48,73.93,73.93,0,0,1,0-8.68,8,8,0,0,0-1.74-5.48L40.2,100.45a91.57,91.57,0,0,1,6.23-15L69,82.89a8,8,0,0,0,5.1-2.64,74.11,74.11,0,0,1,6.14-6.14A8,8,0,0,0,82.89,69L85.4,46.43a91.32,91.32,0,0,1,15-6.23l17.74,14.19a8,8,0,0,0,5.48,1.74,73.93,73.93,0,0,1,8.68,0,8,8,0,0,0,5.48-1.74L155.55,40.2a91.57,91.57,0,0,1,15,6.23L173.11,69a8,8,0,0,0,2.64,5.1,74.11,74.11,0,0,1,6.14,6.14,8,8,0,0,0,5.1,2.64l22.58,2.51a91.32,91.32,0,0,1,6.23,15l-14.19,17.74A8,8,0,0,0,199.87,123.66Z"
                  ></path>
                </svg>
              </div>
            </button>
          </div>
        </div>
        <h1 class="text-[#0d1b12] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 text-left pb-3 pt-5">Hello, Sarah!</h1>
        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
          <label class="flex flex-col min-w-40 flex-1">
            <select
              class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d1b12] focus:outline-0 focus:ring-0 border border-[#cfe7d7] bg-[#f8fcf9] focus:border-[#cfe7d7] h-14 bg-[image:--select-button-svg] placeholder:text-[#4c9a66] p-[15px] text-base font-normal leading-normal"
            >
              <option value="one"></option>
              <option value="two">two</option>
              <option value="three">three</option>
            </select>
          </label>
        </div>
        <h2 class="text-[#0d1b12] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Next Meals</h2>
        <div class="p-4">
          <div class="flex items-stretch justify-between gap-4 rounded-lg">
            <div class="flex flex-[2_2_0px] flex-col gap-4">
              <div class="flex flex-col gap-1">
                <p class="text-[#4c9a66] text-sm font-normal leading-normal">Breakfast</p>
                <p class="text-[#0d1b12] text-base font-bold leading-tight">Oatmeal with Berries</p>
                <p class="text-[#4c9a66] text-sm font-normal leading-normal">Planned for 8:00 AM</p>
              </div>
              <button
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 flex-row-reverse bg-[#e7f3eb] text-[#0d1b12] pr-2 gap-1 text-sm font-medium leading-normal w-fit"
              >
                <div class="text-[#0d1b12]" data-icon="Clock" data-size="18px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"
                    ></path>
                  </svg>
                </div>
                <span class="truncate">Waiting</span>
              </button>
            </div>
            <div
              class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-lg flex-1"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBQz8Pv9KIh572IafeQ7APBZfy79qQm6qj-KYBMaV43sQCSIO54e_5wa6FU2eGl3xf-w0ueckUulKjqiMwWgKetH1GOi9k3q76_-HKkwVlvfQYVVG7o1dOCgoqxRoOxWGSLK4LM_JR8ngmNlWkxvT-HgQZXP8GWFBJ8jREZZXMYD6FElRa9u9IZs40Ft0Fn3MzLfKOYtr4mtIq7GwxBoVIo2jS9Pmx5gINmBR_TzjVuAENkM7ORV8JTLGPa5LjzH1LQ11zcGPVP8PhH");'
            ></div>
          </div>
        </div>
        <div class="flex justify-stretch">
          <div class="flex flex-1 gap-3 flex-wrap px-4 py-3 justify-between">
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Upload Photo</span>
            </button>
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Mark as Eaten</span>
            </button>
          </div>
        </div>
        <div class="flex justify-stretch">
          <div class="flex flex-1 gap-3 flex-wrap px-4 py-3 justify-between">
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Skipped</span>
            </button>
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Substitute</span>
            </button>
          </div>
        </div>
        <div class="p-4">
          <div class="flex items-stretch justify-between gap-4 rounded-lg">
            <div class="flex flex-[2_2_0px] flex-col gap-4">
              <div class="flex flex-col gap-1">
                <p class="text-[#4c9a66] text-sm font-normal leading-normal">Snack</p>
                <p class="text-[#0d1b12] text-base font-bold leading-tight">Apple Slices with Almond Butter</p>
                <p class="text-[#4c9a66] text-sm font-normal leading-normal">Planned for 10:30 AM</p>
              </div>
              <button
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 flex-row-reverse bg-[#e7f3eb] text-[#0d1b12] pr-2 gap-1 text-sm font-medium leading-normal w-fit"
              >
                <div class="text-[#0d1b12]" data-icon="Clock" data-size="18px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"
                    ></path>
                  </svg>
                </div>
                <span class="truncate">Waiting</span>
              </button>
            </div>
            <div
              class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-lg flex-1"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuA9lftq20Q_sSt4-zUosxbvq_hqs1CBfNlRYZCvbK3r3sDXiYi1eHqdOoIZIrZCgbEh2cpizR9AR9v--ih267ab00inBhfI-zwXkUZ9Q2AGZ1BvPL9d3AdsVcydo9Q0Ty9Fh82wpD70JvJau2Qyoy3wiBpiKgtjfH3oxjHH0MuY_-R70LhGOq5fOjZKXatKL6ettjPHEfN1YbVw-ChsvTn-hoZW6JLyagjz56Vn5kQLcKxP5CW1Bg3p1Sb9KTA_299J-VBqk55a7vm6");'
            ></div>
          </div>
        </div>
        <div class="flex justify-stretch">
          <div class="flex flex-1 gap-3 flex-wrap px-4 py-3 justify-between">
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Upload Photo</span>
            </button>
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Mark as Eaten</span>
            </button>
          </div>
        </div>
        <div class="flex justify-stretch">
          <div class="flex flex-1 gap-3 flex-wrap px-4 py-3 justify-between">
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Skipped</span>
            </button>
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Substitute</span>
            </button>
          </div>
        </div>
        <div class="p-4">
          <div class="flex items-stretch justify-between gap-4 rounded-lg">
            <div class="flex flex-[2_2_0px] flex-col gap-4">
              <div class="flex flex-col gap-1">
                <p class="text-[#4c9a66] text-sm font-normal leading-normal">Lunch</p>
                <p class="text-[#0d1b12] text-base font-bold leading-tight">Grilled Chicken Salad</p>
                <p class="text-[#4c9a66] text-sm font-normal leading-normal">Planned for 1:00 PM</p>
              </div>
              <button
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 flex-row-reverse bg-[#e7f3eb] text-[#0d1b12] pr-2 gap-1 text-sm font-medium leading-normal w-fit"
              >
                <div class="text-[#0d1b12]" data-icon="Clock" data-size="18px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"
                    ></path>
                  </svg>
                </div>
                <span class="truncate">Waiting</span>
              </button>
            </div>
            <div
              class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-lg flex-1"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBqY5Jo-t5RZuFLO-DmQQzke7DbIbBwHfG55B8nWXch3wqhWq2ABM1FJakRL--2Ec0K87SmnlGbU3nxyAnpgAE4CGDi466U2q3vHG0E5t711MR8lh-9TbJclJOmrelJZ2EI2gp_cPPiwuxE2PV6q7mJE2ASieeyVHDvI_ko3R0sdFzoRWrSdL3k7Lr2OyEusQrWMF1Vp6YVxuYT9TbvoL99FeXXNZaBjNnPbV4X_NxK-cpN5O_GHGtqXcLkq3hKJrfD0G-K3cjZTdX8");'
            ></div>
          </div>
        </div>
        <div class="flex justify-stretch">
          <div class="flex flex-1 gap-3 flex-wrap px-4 py-3 justify-between">
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Upload Photo</span>
            </button>
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Mark as Eaten</span>
            </button>
          </div>
        </div>
        <div class="flex justify-stretch">
          <div class="flex flex-1 gap-3 flex-wrap px-4 py-3 justify-between">
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Skipped</span>
            </button>
            <button
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Substitute</span>
            </button>
          </div>
        </div>
        <h2 class="text-[#0d1b12] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Today's Progress</h2>
        <div class="flex flex-col gap-3 p-4">
          <div class="flex gap-6 justify-between">
            <p class="text-[#0d1b12] text-base font-medium leading-normal">Calories</p>
            <p class="text-[#0d1b12] text-sm font-normal leading-normal">1200/2000</p>
          </div>
          <div class="rounded bg-[#cfe7d7]"><div class="h-2 rounded bg-[#13ec5b]" style="width: 60%;"></div></div>
        </div>
        <div class="flex flex-col gap-3 p-4">
          <div class="flex gap-6 justify-between">
            <p class="text-[#0d1b12] text-base font-medium leading-normal">Protein</p>
            <p class="text-[#0d1b12] text-sm font-normal leading-normal">75g/100g</p>
          </div>
          <div class="rounded bg-[#cfe7d7]"><div class="h-2 rounded bg-[#13ec5b]" style="width: 75%;"></div></div>
        </div>
        <div class="flex flex-col gap-3 p-4">
          <div class="flex gap-6 justify-between">
            <p class="text-[#0d1b12] text-base font-medium leading-normal">Carbs</p>
            <p class="text-[#0d1b12] text-sm font-normal leading-normal">150g/300g</p>
          </div>
          <div class="rounded bg-[#cfe7d7]"><div class="h-2 rounded bg-[#13ec5b]" style="width: 50%;"></div></div>
        </div>
        <div class="flex flex-col gap-3 p-4">
          <div class="flex gap-6 justify-between">
            <p class="text-[#0d1b12] text-base font-medium leading-normal">Fat</p>
            <p class="text-[#0d1b12] text-sm font-normal leading-normal">40g/50g</p>
          </div>
          <div class="rounded bg-[#cfe7d7]"><div class="h-2 rounded bg-[#13ec5b]" style="width: 80%;"></div></div>
        </div>
      </div>
      <div>
        <div class="flex justify-end overflow-hidden px-5 pb-5">
          <button
            class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-14 px-5 bg-[#13ec5b] text-[#0d1b12] text-base font-bold leading-normal tracking-[0.015em] min-w-0 gap-4 pl-4 pr-6"
          >
            <div class="text-[#0d1b12]" data-icon="Plus" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path>
              </svg>
            </div>
            <span class="truncate">Log Next Meal</span>
          </button>
        </div>
        <div class="h-5 bg-[#f8fcf9]"></div>
      </div>
    </div>
  </body>
</html>
</file>

<file path=".opencode/plans/TECH-SPEC-IMPLEMENTATION.md">
# DietKaro Technical Specification - Implementation Roadmap

**Version:** 1.0  
**Date:** January 21, 2026  
**Purpose:** Complete implementation guide for remaining features  
**Business Goal:** Enable dietitians to efficiently create personalized diet plans by collecting comprehensive client data and providing intelligent validation

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Current State Analysis](#2-current-state-analysis)
3. [Phase 1: Complete Client Onboarding](#3-phase-1-complete-client-onboarding)
4. [Phase 2: Validation Engine Enhancements](#4-phase-2-validation-engine-enhancements)
5. [Phase 3: Dashboard & Client Management](#5-phase-3-dashboard--client-management)
6. [Phase 4: Medical Log Analysis (AI)](#6-phase-4-medical-log-analysis-ai)
7. [Database Schema Changes](#7-database-schema-changes)
8. [API Endpoints Summary](#8-api-endpoints-summary)
9. [Technical Dependencies](#9-technical-dependencies)
10. [Risk Assessment & Mitigations](#10-risk-assessment--mitigations)

---

## 1. Executive Summary

### 1.1 Business Objective

DietKaro is a multi-tenant SaaS platform for dietitians. The core business value is:

1. **Collect comprehensive client health data** through mobile app onboarding
2. **Validate food choices in real-time** against client restrictions
3. **Enable efficient diet plan creation** with intelligent alerts
4. **Track client progress** through meal logging and measurements

### 1.2 Current Implementation Status

| Component | Completion | Critical Gaps |
|-----------|------------|---------------|
| Backend Infrastructure | 85% | Missing AI integration |
| Client Mobile App | 60% | Incomplete onboarding flow |
| Dietitian Dashboard | 70% | Missing medical summary sidebar |
| Validation Engine | 75% | Missing repetition & strength checks |
| AI/RAG Extraction | 0% | Not started (code in different branch, not merged) |

### 1.3 Priority Order

| Priority | Feature | Business Impact | Effort |
|----------|---------|-----------------|--------|
| **P1** | Complete Onboarding | Can't personalize plans without data | 4-5 days |
| **P2** | Validation Engine | Dietitians need accurate food alerts | 2 days |
| **P3** | Dashboard Enhancements | Better UX for diet planning | 3 days |
| **P4** | AI Medical Extraction | Nice-to-have automation | 5+ days |

---

## 2. Current State Analysis

### 2.1 What's Working

#### Backend (Node.js/Express)
- Authentication: Clerk (dietitian dashboard) + Custom JWT (client app)
- File Storage: S3-compatible (Garage) with image compression
- Validation Engine: Core rules implemented (allergies, diet patterns, day restrictions)
- API Structure: RESTful endpoints for all core entities
- Database: PostgreSQL with Prisma ORM, 18 models

#### Client Mobile App (React Native/Expo)
- Auth flow: OTP-based phone login
- Onboarding: 5 screens (basic info, diet pattern, allergies, restrictions, dislikes)
- Main tabs: Home (today's meals), Weight tracking, Progress, Profile
- Meal logging with photo upload

#### Dietitian Dashboard (Next.js)
- Client list and management
- Diet plan creation with meal scheduling
- Food item database with search
- Real-time validation alerts (RED/YELLOW/GREEN borders)

### 2.2 What's Missing

#### Database Models (Not Created)
- `LabReport` - For AI-extracted lab data
- `LabResult` - Individual biomarker records
- `ClientPreferences` - Meal timing, cooking constraints

#### Database Fields (Missing on Existing Models)
- `Client`: `occupation`, `activityNotes`, `preferredCookMethods`
- `MedicalProfile`: `extractedReports`, `labValues`, `derivedRiskFlags`
- `FoodItem`: `mayContainTraces`, numeric `confidence`, verification tracking

#### Client App Screens (Not Implemented)
- Medical History & Lab Reports input
- Body Measurements capture
- Review & Submit summary screen
- Likes & Preferred Cuisines (only dislikes captured)

#### Validation Rules (Not Implemented)
- Strong vs mild dislike differentiation
- Weekly food repetition warnings
- Ultra-processed food caution for diabetics
- Goal-aligned positive nudges
- `avoidCategories` checking

---

## 3. Phase 1: Complete Client Onboarding

### 3.1 Overview

**Goal:** Collect all necessary client data during mobile app onboarding to enable personalized diet planning.

**Current State:** 5 screens capturing partial data  
**Target State:** 7+ screens capturing comprehensive data

### 3.2 Screen-by-Screen Specification

---

#### Screen 1: Basic Profile (ENHANCE)

**Current:** Captures height, weight, target weight, gender, activity level  
**Enhancement Needed:** Add name, date of birth, phone

**UI Components:**

| Field | Type | Validation | Required |
|-------|------|------------|----------|
| Full Name | Text Input | Min 2 chars | Yes |
| Date of Birth | Date Picker | Age 13-100 years | Yes |
| Phone | Phone Input | Valid Indian format (+91) | Pre-filled from login |
| Profile Photo | Image Picker | Max 5MB, JPEG/PNG | No |
| Height | Number + Unit | 100-250 cm | Yes |
| Current Weight | Number | 20-300 kg | Yes |
| Target Weight | Number | 20-300 kg | Yes |
| Gender | Radio (Male/Female/Other) | - | Yes |
| Activity Level | Picker | sedentary/light/moderate/very_active | Yes |

**Backend Endpoint:** `POST /api/v1/client/onboarding/step1`

**Logic:**
1. Validate all fields client-side before submission
2. Calculate age from DOB
3. Calculate BMI from height/weight
4. If age < 18, show parental consent notice
5. Store in `Client` table

**Data Stored:**
```typescript
{
  fullName: string,
  dateOfBirth: Date,
  phone: string,
  profilePhotoUrl?: string,
  heightCm: number,
  currentWeightKg: number,
  targetWeightKg: number,
  gender: "male" | "female" | "other",
  activityLevel: "sedentary" | "light" | "moderate" | "very_active"
}
```

---

#### Screen 2: Medical History (NEW)

**Purpose:** Capture health conditions, medications, and family history for medical-aware diet planning.

**Why Important:** 
- Pre-diabetes needs low-sugar recommendations
- Heart conditions need low-sodium, low-cholesterol
- Medications can have food interactions
- Family history indicates genetic predisposition

**UI Components:**

| Field | Type | Options | Required |
|-------|------|---------|----------|
| Medical Conditions | Multi-select Chips | [diabetes, pre_diabetes, hypertension, heart_disease, thyroid, PCOS, cholesterol, kidney_issues, liver_issues, anemia, obesity] | No |
| Custom Condition | Text Input | Free text | No |
| Current Medications | Tag Input | Free text, comma separated | No |
| Supplements | Tag Input | Free text | No |
| Past Surgeries | Text Area | Free text | No |
| Family History | Multi-select | [diabetes, heart_disease, hypertension, cancer, obesity] | No |
| Health Notes | Text Area | Free text for additional context | No |

**Backend Endpoint:** `POST /api/v1/client/onboarding/step2`

**Logic:**
1. For each selected condition, auto-generate `labDerivedTags`:
   - `pre_diabetes` → add tag `sugar_caution`
   - `heart_disease` → add tag `cholesterol_caution`
   - `hypertension` → add tag `sodium_caution`
2. Store medications for drug-food interaction checks (future)
3. Family history informs risk assessment

**Data Stored:**
```typescript
{
  medicalConditions: string[],
  medications: string[],
  supplements: string[],
  surgeries: string,
  familyHistory: string[],
  healthNotes: string
}
// Also updates MedicalProfile relation
```

---

#### Screen 3: Allergies & Intolerances (EXISTS - MINOR ENHANCEMENT)

**Current State:** Working, captures allergies and intolerances  
**Enhancement:** Add severity level for allergies (mild/severe/life-threatening)

**UI Components:**

| Field | Type | Options |
|-------|------|---------|
| Allergies | Multi-select + Custom | [peanuts, tree_nuts, milk, eggs, wheat, soy, fish, shellfish, sesame] |
| Allergy Severity | Per-item dropdown | mild/severe/life_threatening |
| Intolerances | Multi-select + Custom | [lactose, gluten, fructose, histamine, caffeine] |

**Logic:**
1. Life-threatening allergies → Always RED blocking
2. Severe allergies → RED blocking
3. Mild allergies → RED blocking but with different message
4. Intolerances → RED blocking (treat same as allergies for safety)

**Data Stored:**
```typescript
{
  allergies: Array<{ name: string, severity: "mild" | "severe" | "life_threatening" }>,
  intolerances: string[]
}
```

---

#### Screen 4: Diet Pattern & Restrictions (EXISTS - WORKING)

**Current State:** Working well with presets for religious fasting  
**No changes needed**

**Features:**
- Diet pattern selection (vegetarian, vegan, non-veg, pescatarian, eggetarian)
- Egg preference with day restrictions
- Religious presets (Hindu Fasting, Jain, Catholic Friday, Islamic Halal, Navratri)

---

#### Screen 5: Food Preferences (ENHANCE)

**Current State:** Only captures dislikes  
**Enhancement Needed:** Add likes, preferred cuisines, meal timing

**UI Components:**

| Section | Field | Type |
|---------|-------|------|
| **Likes** | Liked Foods | Searchable multi-select from FoodItem database |
| **Likes** | Preferred Cuisines | Multi-select chips: [indian, south_indian, mughlai, chinese, continental, mediterranean, thai] |
| **Likes** | Preferred Cooking Methods | Multi-select: [grilled, steamed, baked, stir_fried, raw] |
| **Dislikes** | Disliked Foods | Multi-select + custom (existing) |
| **Dislikes** | Dislike Strength | Per-item: mild (can eat if needed) / strong (never) |
| **Dislikes** | Avoid Categories | Multi-select: [fried_foods, processed_meat, canned_foods, sugary_drinks] |
| **Timing** | Breakfast Time | Time picker |
| **Timing** | Lunch Time | Time picker |
| **Timing** | Dinner Time | Time picker |
| **Timing** | Snack Time | Time picker (optional) |

**Backend Endpoint:** `POST /api/v1/client/onboarding/step5`

**Logic:**
1. Liked foods stored as `foodId[]` for GREEN nudges during planning
2. Dislike strength determines RED vs YELLOW in validation
3. Meal timing used for meal scheduling defaults
4. Preferred cuisines show GREEN badges on matching foods

**Data Stored:**
```typescript
{
  likedFoods: string[], // Food IDs
  preferredCuisines: string[],
  preferredCookMethods: string[],
  dislikes: Array<{ name: string, strength: "mild" | "strong" }>,
  avoidCategories: string[],
  mealTiming: {
    breakfast: string, // "07:00"
    lunch: string,
    dinner: string,
    snack?: string
  }
}
```

---

#### Screen 6: Body Measurements (NEW)

**Purpose:** Baseline measurements for progress tracking and goal setting.

**Why Important:**
- Track fat loss vs muscle gain (scale doesn't tell full story)
- Waist measurement indicates visceral fat (health risk indicator)
- Provides motivation when clients see inch loss

**UI Components:**

| Field | Type | Unit | Required |
|-------|------|------|----------|
| Chest | Number | cm/inches (toggle) | No |
| Waist | Number | cm/inches | Yes |
| Stomach at Navel | Number | cm/inches | No |
| Hips | Number | cm/inches | No |
| Upper Thighs | Number | cm/inches | No |
| Upper Arms | Number | cm/inches | No |
| Calves | Number | cm/inches | No |
| Body Fat % | Number | % | No |
| Measurement Date | Date | - | Yes (default: today) |
| Notes | Text | - | No |

**Backend Endpoint:** `POST /api/v1/client/onboarding/step6`

**Logic:**
1. Allow unit toggle (metric/imperial) - convert and store as cm
2. Waist measurement triggers health warnings if in danger zone:
   - Men: >102cm (40in) = high risk
   - Women: >88cm (35in) = high risk
3. Calculate waist-to-hip ratio for health indicator
4. Store as first `BodyMeasurement` record

**Data Stored:**
```typescript
{
  chestCm: number,
  waistCm: number,
  stomachCm: number,
  hipsCm: number,
  thighsCm: number,
  armsCm: number,
  calfCm: number,
  bodyFatPercentage?: number,
  logDate: Date,
  notes?: string
}
```

---

#### Screen 7: Review & Submit (NEW)

**Purpose:** Allow client to review all entered data before submission.

**Why Important:**
- Reduces errors from accidental selections
- Gives confidence that data is correct
- Required for medical data accuracy

**UI Layout:**
```
+------------------------------------------+
|  Review Your Profile                      |
+------------------------------------------+
|                                           |
|  Basic Info                        [Edit] |
|  - Name: Gaurav Kumar                     |
|  - Age: 47                                |
|  - Height: 178 cm                         |
|  - Weight: 92 kg -> 82 kg (Goal)          |
|  - Activity: Moderate                     |
|                                           |
|  Medical History                   [Edit] |
|  - Conditions: Pre-diabetes, Belly fat    |
|  - Medications: None                      |
|  - Family: Diabetes (mother's side)       |
|                                           |
|  Allergies                         [Edit] |
|  - None recorded                          |
|                                           |
|  Diet Pattern                      [Edit] |
|  - Vegetarian + Egg                       |
|  - Avoid eggs: Tuesday, Thursday          |
|                                           |
|  Preferences                       [Edit] |
|  - Likes: Egg roll, Dal makhani           |
|  - Dislikes: Bitter gourd                 |
|  - Cuisines: Indian, Mughlai              |
|                                           |
|  Measurements                      [Edit] |
|  - Waist: 39.5 inches                     |
|  - Date: Jan 15, 2026                     |
|                                           |
|  [ ] I confirm this information is        |
|      accurate to the best of my knowledge |
|                                           |
|  [       Submit & Continue        ]       |
|                                           |
+------------------------------------------+
```

**Backend Endpoint:** `POST /api/v1/client/onboarding/complete`

**Logic:**
1. Display all data grouped by category
2. Each section has [Edit] button → navigates back to that step
3. Checkbox for confirmation (required)
4. On submit:
   - Set `Client.onboardingCompleted = true`
   - Trigger notification to assigned dietitian
   - Generate initial `labDerivedTags` from conditions
   - Navigate to main app

---

### 3.3 Onboarding Navigation Flow

```
Login -> OTP Verify -> Check onboardingCompleted
                           |
                           +-- true -> Main App (Tabs)
                           |
                           +-- false -> Onboarding Flow
                                           |
    +--------------------------------------+
    |
    v
Step 1 (Basic) -> Step 2 (Medical) -> Step 3 (Allergies) -> Step 4 (Restrictions)
                                                                    |
                                                                    v
                              Step 7 (Review) <- Step 6 (Measurements) <- Step 5 (Preferences)
                                    |
                                    v
                              Submit -> Main App
```

### 3.4 Backend Service Changes

#### File: `backend/src/services/onboarding.service.ts`

**Current Methods:**
- `saveStep1()` - Basic info
- `saveStep2()` - Diet pattern
- `saveStep3()` - Allergies
- `saveStep4()` - Restrictions
- `saveStep5()` - Dislikes only

**Required Updates:**
1. `saveStep1()` - Add `fullName`, `dateOfBirth`
2. `saveStep2Medical()` - NEW: Medical history
3. `saveStep5()` - Add likes, cuisines, meal timing, dislike strength
4. `saveStep6()` - NEW: Body measurements
5. `completeOnboarding()` - Finalize and trigger notifications

**New Helper Methods:**
```typescript
// Generate lab-derived tags from conditions
generateDerivedTags(conditions: string[]): string[] {
  const tagMap = {
    'pre_diabetes': ['sugar_caution', 'high_gi_caution'],
    'diabetes': ['sugar_caution', 'high_gi_caution', 'diabetic'],
    'heart_disease': ['cholesterol_caution', 'sodium_caution'],
    'hypertension': ['sodium_caution'],
    'cholesterol': ['cholesterol_caution', 'saturated_fat_caution'],
    'kidney_issues': ['protein_caution', 'sodium_caution'],
    'anemia': ['iron_needed'],
    'PCOS': ['sugar_caution', 'insulin_resistance']
  };
  // Return unique tags
}

// Calculate health risk indicators
calculateRiskIndicators(client: Client): RiskIndicators {
  // BMI calculation
  // Waist-to-hip ratio
  // Age-adjusted targets
}
```

---

## 4. Phase 2: Validation Engine Enhancements

### 4.1 Overview

**Goal:** Improve the validation engine to provide more accurate and comprehensive food-client compatibility checks.

**File:** `backend/src/services/validationEngine.service.ts`

### 4.2 Gap Analysis

| Rule | Spec | Current Status | Priority |
|------|------|----------------|----------|
| Strong dislike blocking | RED | All dislikes are YELLOW | HIGH |
| Weekly repetition warning | YELLOW if >4x/week | Not implemented | MEDIUM |
| `avoidCategories` check | YELLOW | Field unused | MEDIUM |
| Ultra-processed + diabetes | YELLOW | Not implemented | MEDIUM |
| Goal-aligned nudge | GREEN | Not implemented | LOW |
| `mayContainTraces` check | YELLOW | Field doesn't exist | LOW |

### 4.3 Implementation Details

---

#### 4.3.1 Strong Dislike Blocking (HIGH)

**Current Behavior:** All dislikes return YELLOW (caution)  
**Required Behavior:** Strong dislikes return RED (blocking)

**Schema Change Needed:**
```prisma
// Client model - change dislikes from String[] to Json
dislikes  Json    @default("[]")  // Array<{ name: string, strength: "mild" | "strong" }>
```

**Validation Logic:**
```typescript
private checkDislikes(food: FoodTags, clientTags: ClientTags): ValidationAlert | null {
  for (const dislike of clientTags.dislikes) {
    if (food.name.toLowerCase().includes(dislike.name.toLowerCase())) {
      if (dislike.strength === 'strong') {
        return {
          type: 'dislike',
          severity: ValidationSeverity.RED,
          message: `STRONG DISLIKE: Client strongly dislikes ${food.name}`,
          canAdd: false
        };
      } else {
        return {
          type: 'dislike',
          severity: ValidationSeverity.YELLOW,
          message: `MILD DISLIKE: Client prefers to avoid ${food.name}`,
          recommendation: 'Consider alternatives if available',
          canAdd: true
        };
      }
    }
  }
  return null;
}
```

**UI Impact:**
- Onboarding step 5: Add strength toggle for each dislike
- Dashboard: Strong dislikes show RED border, mild shows YELLOW

---

#### 4.3.2 Weekly Repetition Warning (MEDIUM)

**Purpose:** Warn dietitians when a food item is used too frequently in a week.

**Why Important:**
- Nutritional variety is healthier
- Clients get bored of repetitive meals
- Some foods (eggs) have cholesterol limits

**Validation Context Addition:**
```typescript
interface ValidationContext {
  currentDay: string;
  mealType: string;
  weeklyUsage: Record<string, number>;  // { "food_id_123": 3, "food_id_456": 5 }
}
```

**Validation Logic:**
```typescript
private checkRepetition(food: FoodTags, context: ValidationContext): ValidationAlert | null {
  const usageCount = context.weeklyUsage?.[food.id] || 0;
  
  // Specific limits for certain foods
  const limits: Record<string, number> = {
    'eggs': 4,        // Cholesterol concern
    'red_meat': 2,    // Heart health
    'default': 5      // General variety
  };
  
  const limit = limits[food.category] || limits['default'];
  
  if (usageCount >= limit) {
    return {
      type: 'repetition',
      severity: ValidationSeverity.YELLOW,
      message: `REPETITION: ${food.name} used ${usageCount} times this week`,
      recommendation: `Consider variety. Limit: ${limit}x per week`,
      canAdd: true
    };
  }
  return null;
}
```

**API Change:**
The diet plan creation UI must pass `weeklyUsage` context when calling validation:
```typescript
// Frontend must calculate and send:
POST /api/v1/diet-validation/check
{
  clientId: "...",
  foodId: "...",
  context: {
    currentDay: "monday",
    mealType: "breakfast",
    weeklyUsage: {
      "food_eggs_001": 3  // Already used 3 times this week
    }
  }
}
```

---

#### 4.3.3 Avoid Categories Check (MEDIUM)

**Current Issue:** `client.avoidCategories` is loaded but never checked.

**Purpose:** Warn when food belongs to a category the client wants to avoid.

**Validation Logic:**
```typescript
private checkAvoidCategories(food: FoodTags, clientTags: ClientTags): ValidationAlert | null {
  if (!clientTags.avoidCategories?.length) return null;
  
  const categoryMapping: Record<string, string[]> = {
    'fried_foods': ['deep_fried', 'fried', 'crispy'],
    'processed_meat': ['sausage', 'bacon', 'ham', 'salami'],
    'sugary_drinks': ['soda', 'cola', 'sweetened_beverage'],
    'canned_foods': ['canned', 'preserved'],
    'ultra_processed': ['ultra_processed']
  };
  
  for (const avoidCat of clientTags.avoidCategories) {
    const keywords = categoryMapping[avoidCat] || [avoidCat];
    
    const matchesCategory = keywords.some(kw => 
      food.category?.includes(kw) || 
      food.processingLevel?.includes(kw) ||
      food.cuisineTags?.includes(kw)
    );
    
    if (matchesCategory) {
      return {
        type: 'category_avoid',
        severity: ValidationSeverity.YELLOW,
        message: `CATEGORY: Client prefers to avoid ${avoidCat}`,
        recommendation: 'Consider healthier alternatives',
        canAdd: true
      };
    }
  }
  return null;
}
```

---

#### 4.3.4 Ultra-Processed + Diabetes Warning (MEDIUM)

**Purpose:** Warn when ultra-processed foods are added for diabetic/pre-diabetic clients.

**Why Important:** Ultra-processed foods typically have high glycemic index.

**Validation Logic:**
```typescript
// Add to checkMedicalConditions method
if (
  (clientTags.medicalConditions.has('pre_diabetes') || 
   clientTags.medicalConditions.has('diabetes')) &&
  food.processingLevel === 'ultra_processed'
) {
  alerts.push({
    type: 'medical',
    severity: ValidationSeverity.YELLOW,
    message: 'ULTRA-PROCESSED: High glycemic impact for diabetic client',
    recommendation: 'Prefer whole foods or minimally processed alternatives',
    canAdd: true
  });
}
```

---

#### 4.3.5 Goal-Aligned Positive Nudge (LOW)

**Purpose:** Show GREEN badges for foods that align with client's health goal.

**Schema Addition:**
```prisma
// Client model
goal  String?  // "weight_loss" | "muscle_gain" | "maintenance" | "health_improvement"
```

**Validation Logic:**
```typescript
private checkGoalAlignment(food: FoodTags, clientTags: ClientTags): ValidationAlert | null {
  if (!clientTags.goal) return null;
  
  const goalFoodMatches: Record<string, { tags: string[], message: string }> = {
    'weight_loss': {
      tags: ['high_protein', 'low_calorie', 'high_fiber', 'low_fat'],
      message: 'GOAL-ALIGNED: Great for weight loss - high protein, low calorie'
    },
    'muscle_gain': {
      tags: ['high_protein', 'complex_carbs'],
      message: 'GOAL-ALIGNED: Good for muscle building - protein rich'
    },
    'health_improvement': {
      tags: ['vitamin_rich', 'antioxidant', 'heart_healthy', 'low_sodium'],
      message: 'GOAL-ALIGNED: Nutrient dense and heart healthy'
    }
  };
  
  const goalConfig = goalFoodMatches[clientTags.goal];
  if (!goalConfig) return null;
  
  const matchingTags = goalConfig.tags.filter(tag => 
    food.nutritionTags?.includes(tag)
  );
  
  if (matchingTags.length >= 2) {
    return {
      type: 'goal_match',
      severity: ValidationSeverity.GREEN,
      message: goalConfig.message,
      canAdd: true
    };
  }
  return null;
}
```

---

### 4.4 Validation Engine Testing Checklist

| Test Case | Input | Expected Output |
|-----------|-------|-----------------|
| Strong dislike | Client dislikes "mushroom" (strong), food = "Mushroom Curry" | RED, canAdd: false |
| Mild dislike | Client dislikes "okra" (mild), food = "Bhindi Masala" | YELLOW, canAdd: true |
| Repetition limit | Eggs used 4x this week, adding 5th | YELLOW warning |
| Avoid category | Client avoids "fried_foods", food = "Samosa" | YELLOW warning |
| Diabetic + processed | Client has pre_diabetes, food processingLevel = "ultra_processed" | YELLOW warning |
| Goal match | Client goal = "weight_loss", food = high protein + low calorie | GREEN badge |
| Allergy | Client allergic to peanuts, food contains peanuts | RED, canAdd: false |
| Day restriction | Client avoids eggs on Tuesday, today = Tuesday | RED, canAdd: false |

---

## 5. Phase 3: Dashboard & Client Management

### 5.1 Overview

**Goal:** Enhance the dietitian dashboard to show comprehensive client medical summary during diet planning.

### 5.2 Medical Summary Sidebar Component

**Purpose:** Always-visible sidebar showing client health data while creating diet plans.

**Location:** `frontend/src/components/clients/MedicalSummarySidebar.tsx`

**Layout:**
```
+-------------------------------------+
|  Client Photo & Name                |
|  178cm, 92kg -> 82kg (Goal: -10kg)  |
|  Age: 47, Male, Moderate Activity   |
+-------------------------------------+
|                                     |
|  RED - BLOCKING RESTRICTIONS        |
|  ----------------------------       |
|  Allergies: Peanuts (severe)        |
|  Intolerances: Lactose              |
|  Diet: Vegetarian + Egg             |
|  Egg Avoid: Tue, Thu                |
|  Strong Dislikes: Mushroom          |
|                                     |
|  YELLOW - CAUTION FLAGS             |
|  ----------------------------       |
|  Conditions:                        |
|  - Pre-diabetes (HbA1c 6.3%)        |
|  - Heart concerns                   |
|                                     |
|  Lab Alerts:                        |
|  - Vitamin D: 23 (low)              |
|  - B12: 155 (low)                   |
|  - hs-CRP: 4.1 (elevated)           |
|                                     |
|  Avoid Categories:                  |
|  - Fried foods                      |
|  - Ultra-processed                  |
|                                     |
|  GREEN - PREFERENCES                |
|  ----------------------------       |
|  Likes: Egg roll, Dal makhani       |
|  Cuisines: Indian, Mughlai          |
|  Cooking: Grilled, Steamed          |
|                                     |
|  CONTEXT                            |
|  ----------------------------       |
|  Mild Dislikes: Bitter gourd        |
|  Activity: Sat/Sun morning sport    |
|  Meal Times: B:7am L:12pm D:7:30pm  |
|                                     |
|  [View Full Profile]                |
|                                     |
+-------------------------------------+
```

**Data Sources:**
```typescript
interface MedicalSummaryData {
  // From Client
  fullName: string;
  profilePhotoUrl?: string;
  heightCm: number;
  currentWeightKg: number;
  targetWeightKg: number;
  dateOfBirth: Date;
  gender: string;
  activityLevel: string;
  
  // Blocking (RED)
  allergies: Array<{ name: string, severity: string }>;
  intolerances: string[];
  dietPattern: string;
  eggAllowed: boolean;
  eggAvoidDays: string[];
  strongDislikes: string[];
  
  // Caution (YELLOW)
  medicalConditions: string[];
  labDerivedTags: string[];
  avoidCategories: string[];
  mildDislikes: string[];
  
  // Positive (GREEN)
  likedFoods: string[];
  preferredCuisines: string[];
  preferredCookMethods: string[];
  
  // Context
  mealTiming?: {
    breakfast: string;
    lunch: string;
    dinner: string;
  };
  activityNotes?: string;
  
  // From MedicalProfile
  labValues?: {
    hba1c?: number;
    vitaminD?: number;
    vitaminB12?: number;
    hsCRP?: number;
  };
}
```

**API Endpoint:** `GET /api/v1/clients/:clientId/medical-summary`

**Response:** Aggregated data from Client + MedicalProfile + ClientPreferences

### 5.3 Food Search with Validation Integration

**Current:** Food search shows basic food cards with nutrition  
**Enhancement:** Real-time validation badges on each food card

**UI Enhancement:**
```
+-------------------------------------------------------+
| Search Foods: [eggs________________]                   |
+-------------------------------------------------------+
|                                                        |
|  +--------------+  +--------------+  +--------------+ |
|  | YELLOW       |  | RED          |  | GREEN        | |
|  | ------------ |  | ------------ |  | ------------ | |
|  | Omelette     |  | Egg Curry    |  | Boiled Egg   | |
|  |              |  |              |  |              | |
|  | 155 kcal     |  | 180 kcal     |  | 78 kcal      | |
|  | P:11 C:1 F:12|  | P:12 C:8 F:11|  | P:6 C:0 F:5  | |
|  |              |  |              |  |              | |
|  | ! Cholesterol|  | X Tuesday    |  | + High prot  | |
|  | Used 3x      |  | restriction  |  | + Low cal    | |
|  |              |  |              |  |              | |
|  | [Add Anyway] |  | [Blocked]    |  | [+ Add]      | |
|  +--------------+  +--------------+  +--------------+ |
|                                                        |
+-------------------------------------------------------+
```

**Batch Validation:**
When loading food search results, call batch validation API:
```typescript
POST /api/v1/diet-validation/batch
{
  clientId: "...",
  foodIds: ["food1", "food2", "food3", ...],
  context: {
    currentDay: "tuesday",
    mealType: "breakfast",
    weeklyUsage: { ... }
  }
}
```

---

## 6. Phase 4: Medical Log Analysis (AI)

### 6.1 Overview

**Goal:** Automatically extract biomarker data from uploaded medical reports using AI/OCR.

**Priority:** P4 (Future enhancement - core workflow works without this)

**Dependencies:**
- OpenAI GPT-4o API (for vision/OCR)
- LabReport and LabResult database models

### 6.2 System Flow

```
Client uploads PDF/Image (blood_test.pdf)
           |
           v
+---------------------------+
|  1. Upload to S3          |  <- Existing functionality
+---------------------------+
           |
           v
+---------------------------+
|  2. Create ClientReport   |  <- Existing functionality
|     record                |
+---------------------------+
           |
           v (Manual trigger or auto)
+---------------------------+
|  3. Send to AI Service    |  <- NEW
|     - Download from S3    |
|     - Convert to base64   |
|     - Send to GPT-4o      |
+---------------------------+
           |
           v
+---------------------------+
|  4. Parse AI Response     |  <- NEW
|     - Extract biomarkers  |
|     - Normalize names     |
|     - Compare to ranges   |
|     - Score confidence    |
+---------------------------+
           |
           v
+---------------------------+
|  5. Store Results         |  <- NEW
|     - Create LabReport    |
|     - Create LabResults   |
|     - Status: REVIEW_NEEDED
+---------------------------+
           |
           v
+---------------------------+
|  6. Dietitian Reviews     |  <- NEW UI
|     - Verify values       |
|     - Approve/Correct     |
+---------------------------+
           |
           v
+---------------------------+
|  7. Update Client Tags    |
|     - Add labDerivedTags  |
|     - Update MedicalProfile
+---------------------------+
```

### 6.3 AI Service Implementation

**File:** `backend/src/services/labAnalysis.service.ts`

**Key Methods:**

```typescript
class LabAnalysisService {
  
  // Trigger analysis for a report
  async analyzeReport(reportId: string): Promise<LabReport>
  
  // Call OpenAI GPT-4o Vision API
  private async extractWithAI(imageBase64: string): Promise<RawExtraction>
  
  // Normalize biomarker names to standard keys
  private normalizeBiomarker(rawName: string): string
  
  // Compare value to reference range
  private assessStatus(value: number, low: number, high: number): Status
  
  // Generate client tags from results
  private generateLabDerivedTags(results: LabResult[]): string[]
  
  // Get historical trend for a biomarker
  async getBiomarkerTrend(clientId: string, biomarker: string): Promise<TrendData>
}
```

**AI Prompt Strategy:**

```typescript
const systemPrompt = `You are a medical laboratory report analyzer. 
Extract all test results from the provided medical report image.

For each test found, extract:
1. Test Name (exactly as written)
2. Value (numeric)
3. Unit (e.g., mg/dL, g/dL)
4. Reference Range (if shown)

Return as JSON array:
[
  {
    "testName": "Hemoglobin",
    "value": 14.2,
    "unit": "g/dL",
    "referenceLow": 13.0,
    "referenceHigh": 17.0
  }
]

If you cannot read a value clearly, set confidence < 0.7.
If reference range is missing, omit those fields.
Only return valid JSON, no explanations.`;
```

**Biomarker Normalization Map:**

```typescript
const biomarkerNormalization: Record<string, string> = {
  // Hemoglobin variants
  'hemoglobin': 'hemoglobin',
  'haemoglobin': 'hemoglobin',
  'hgb': 'hemoglobin',
  'hb': 'hemoglobin',
  
  // HbA1c variants
  'hba1c': 'hba1c',
  'glycated hemoglobin': 'hba1c',
  'glycosylated hemoglobin': 'hba1c',
  
  // Vitamin D variants
  'vitamin d': 'vitamin_d',
  'vit d': 'vitamin_d',
  '25-oh vitamin d': 'vitamin_d',
  '25-hydroxyvitamin d': 'vitamin_d',
  
  // ... extensive mapping
};
```

**Tag Generation Rules:**

| Biomarker | Condition | Generated Tag |
|-----------|-----------|---------------|
| HbA1c > 6.5% | Diabetic range | `diabetes`, `sugar_caution` |
| HbA1c 5.7-6.4% | Pre-diabetic | `pre_diabetes`, `sugar_caution` |
| Vitamin D < 20 | Deficiency | `vitamin_d_deficiency` |
| Vitamin D 20-30 | Insufficient | `vitamin_d_low` |
| B12 < 200 | Deficiency | `b12_deficiency` |
| Total Cholesterol > 200 | High | `high_cholesterol`, `cholesterol_caution` |
| Hemoglobin < 12 (F) / < 13 (M) | Anemia | `anemia`, `iron_needed` |
| TSH > 4.5 | Hypothyroid | `hypothyroid` |
| hs-CRP > 3 | High inflammation | `high_inflammation` |

### 6.4 API Endpoints

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/v1/reports/:id/analyze` | Trigger AI analysis |
| GET | `/api/v1/reports/:id/analysis` | Get analysis results |
| PATCH | `/api/v1/reports/:id/analysis/results/:resultId` | Correct a result |
| POST | `/api/v1/reports/:id/analysis/approve` | Approve and apply tags |
| GET | `/api/v1/clients/:clientId/biomarker-trends` | Historical biomarker data |

### 6.5 Dashboard UI Components

**1. Analysis Status Badge (on report list)**
```
[PENDING] - Not analyzed yet
[PROCESSING] - AI extraction in progress
[REVIEW_NEEDED] - Ready for dietitian review
[COMPLETED] - Approved and applied
[FAILED] - Analysis failed, needs manual entry
```

**2. Results Review Modal**
- Table of extracted biomarkers
- Inline editing for corrections
- Color-coded status (LOW/NORMAL/HIGH/CRITICAL)
- Confidence indicator
- Bulk approve button

**3. Trend Visualization**
- Line chart showing biomarker over time
- Reference range shaded area
- Date labels on x-axis
- Interactive tooltips

### 6.6 Cost Considerations

**OpenAI GPT-4o Vision Pricing:**
- ~$0.01 per image (standard quality)
- ~$0.03 per image (high quality for detailed reports)

**Estimated Monthly Cost:**
- 100 clients x 2 reports/month = 200 analyses
- 200 x $0.03 = ~$6/month

**Fallback Strategy:**
- If AI fails, show manual entry form
- Store failure reason for debugging
- Allow retry after 24 hours

---

## 7. Database Schema Changes

### 7.1 New Models

```prisma
// =======================================================
// LAB ANALYSIS MODELS (Phase 4)
// =======================================================

model LabReport {
  id              String        @id @default(uuid())
  clientReportId  String        @unique
  clientId        String
  
  // Analysis metadata
  status          LabReportStatus @default(PENDING)
  analyzedAt      DateTime?
  approvedAt      DateTime?
  approvedByUserId String?
  
  // Extracted metadata
  labName         String?
  collectionDate  DateTime?
  reportType      String?       // "blood_test", "urine_test", "thyroid_panel"
  
  // AI metadata
  aiProvider      String?       // "openai_gpt4o"
  aiModelVersion  String?
  rawExtraction   Json?         // Store raw AI response for debugging
  processingTimeMs Int?
  
  // Results
  results         LabResult[]
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  clientReport    ClientReport  @relation(fields: [clientReportId], references: [id])
  client          Client        @relation(fields: [clientId], references: [id])
  approvedBy      User?         @relation(fields: [approvedByUserId], references: [id])
  
  @@index([clientId])
  @@index([status])
}

enum LabReportStatus {
  PENDING
  PROCESSING
  REVIEW_NEEDED
  COMPLETED
  FAILED
}

model LabResult {
  id              String    @id @default(uuid())
  labReportId     String
  
  // Biomarker data
  biomarkerKey    String    // Normalized: "hemoglobin", "hba1c"
  displayName     String    // Original: "Haemoglobin", "HbA1c"
  value           Float
  unit            String?
  
  // Reference range
  referenceLow    Float?
  referenceHigh   Float?
  referenceNote   String?   // "Normal: 13-17 g/dL"
  
  // Assessment
  status          BiomarkerStatus
  severity        String?   // "mild", "moderate", "severe"
  
  // AI metadata
  confidence      Float     @default(1.0)  // 0-1
  wasManuallyEdited Boolean @default(false)
  
  // Generated tags
  generatedTags   String[]  @default([])
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  labReport       LabReport @relation(fields: [labReportId], references: [id], onDelete: Cascade)
  
  @@index([labReportId])
  @@index([biomarkerKey])
}

enum BiomarkerStatus {
  CRITICAL_LOW
  LOW
  NORMAL
  HIGH
  CRITICAL_HIGH
}

// =======================================================
// CLIENT PREFERENCES MODEL (Phase 1)
// =======================================================

model ClientPreferences {
  id              String    @id @default(uuid())
  clientId        String    @unique
  
  // Meal timing
  breakfastTime   String?   // "07:00"
  lunchTime       String?   // "12:30"
  dinnerTime      String?   // "19:30"
  snackTime       String?   // "15:00"
  
  // Cooking constraints
  canCook         Boolean   @default(true)
  kitchenAvailable Boolean  @default(true)
  hasDietaryCook  Boolean   @default(false)
  
  // Activity context
  weekdayActivity String?   // "sedentary_office"
  weekendActivity String?   // "active_sports"
  sportOrHobby    String?   // "morning cricket match"
  
  // Notes
  generalNotes    String?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  client          Client    @relation(fields: [clientId], references: [id])
}
```

### 7.2 Model Updates

```prisma
// =======================================================
// CLIENT MODEL UPDATES
// =======================================================

model Client {
  // ... existing fields ...
  
  // ADD: Missing fields from spec
  occupation          String?
  activityNotes       String?
  preferredCookMethods String[]  @default([])
  goal                String?    // "weight_loss", "muscle_gain", "maintenance"
  
  // CHANGE: dislikes from String[] to Json for strength
  dislikes            Json       @default("[]")  // Array<{ name: string, strength: "mild" | "strong" }>
  
  // ADD: Relations
  labReports          LabReport[]
  preferences         ClientPreferences?
}

// =======================================================
// MEDICAL PROFILE MODEL UPDATES
// =======================================================

model MedicalProfile {
  // ... existing fields ...
  
  // ADD: AI extraction storage
  extractedReports    Json[]    @default([])  // Historical extractions
  
  // ADD: Structured lab values (latest)
  labValues           Json?     // { hba1c: 6.3, vitaminD: 23, ... }
  
  // ADD: Computed risk flags
  derivedRiskFlags    String[]  @default([])  // ["pre_diabetes", "vitamin_d_deficiency"]
  
  // ADD: Last lab update tracking
  labValuesUpdatedAt  DateTime?
}

// =======================================================
// FOOD ITEM MODEL UPDATES
// =======================================================

model FoodItem {
  // ... existing fields ...
  
  // ADD: Trace allergens (for cross-contamination warnings)
  mayContainTraces    String[]  @default([])
  
  // CHANGE: confidence from Boolean to Int
  // isVerified Boolean -> keep
  confidence          Int       @default(0)  // 0-100
  
  // ADD: Verification tracking
  verifiedByUserId    String?
  verifiedAt          DateTime?
  requiresReviewAt    DateTime?
  lastReviewReason    String?
  
  // Relations
  verifiedBy          User?     @relation(fields: [verifiedByUserId], references: [id])
}
```

### 7.3 Migration Strategy

**Step 1:** Add new columns with defaults (non-breaking)
**Step 2:** Migrate data where needed
**Step 3:** Create new models
**Step 4:** Add relations

```bash
# Generate migration
npx prisma migrate dev --name add_lab_analysis_and_preferences

# If data migration needed, create a script
npx tsx scripts/migrate-dislikes-to-json.ts
```

---

## 8. API Endpoints Summary

### 8.1 New Endpoints

| Method | Endpoint | Purpose | Phase |
|--------|----------|---------|-------|
| POST | `/api/v1/client/onboarding/step2-medical` | Save medical history | P1 |
| POST | `/api/v1/client/onboarding/step6-measurements` | Save body measurements | P1 |
| POST | `/api/v1/client/onboarding/complete` | Finalize onboarding | P1 |
| GET | `/api/v1/clients/:id/medical-summary` | Aggregated client health data | P3 |
| POST | `/api/v1/reports/:id/analyze` | Trigger AI analysis | P4 |
| GET | `/api/v1/reports/:id/analysis` | Get analysis results | P4 |
| PATCH | `/api/v1/reports/:id/analysis/results/:resultId` | Edit a result | P4 |
| POST | `/api/v1/reports/:id/analysis/approve` | Approve analysis | P4 |
| GET | `/api/v1/clients/:id/biomarker-trends` | Historical biomarker data | P4 |

### 8.2 Updated Endpoints

| Method | Endpoint | Changes | Phase |
|--------|----------|---------|-------|
| POST | `/api/v1/client/onboarding/step1` | Add fullName, dateOfBirth | P1 |
| POST | `/api/v1/client/onboarding/step5` | Add likes, cuisines, dislike strength | P1 |
| POST | `/api/v1/diet-validation/check` | Accept weeklyUsage in context | P2 |
| POST | `/api/v1/diet-validation/batch` | Accept weeklyUsage in context | P2 |

---

## 9. Technical Dependencies

### 9.1 Current Dependencies (No Changes Needed for P1-P3)

The existing stack is sufficient for Phases 1-3:
- Express 5.x (Backend)
- Prisma 6.x (ORM)
- React Native/Expo (Mobile)
- Next.js 14 (Dashboard)

### 9.2 New Dependencies for Phase 4 (AI)

```json
{
  "dependencies": {
    "openai": "^4.x"           // GPT-4o Vision API
  }
}
```

**Environment Variables (Phase 4):**
```bash
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o
LAB_ANALYSIS_ENABLED=true
```

### 9.3 Optional Future Dependencies

```json
{
  "dependencies": {
    "@pinecone-database/pinecone": "^2.x",  // Vector DB for RAG
    "langchain": "^0.1.x"                    // LLM orchestration
  }
}
```

---

## 10. Risk Assessment & Mitigations

### 10.1 Technical Risks

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| AI extraction accuracy | HIGH | MEDIUM | Mandatory dietitian review, manual override |
| Schema migration breaks app | HIGH | LOW | Test migrations in staging, backup data |
| Mobile app update required | MEDIUM | HIGH | Version API, support old clients temporarily |
| Performance with batch validation | MEDIUM | MEDIUM | LRU cache already implemented, monitor latency |

### 10.2 Business Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| Clients abandon long onboarding | MEDIUM | Add progress indicator, save partial data |
| Dietitians overwhelmed with reviews | MEDIUM | Priority queue, batch approval |
| Wrong tag causes health issue | HIGH | Conservative defaults (YELLOW not GREEN), disclaimer |

### 10.3 Security Considerations

| Concern | Current Status | Action Needed |
|---------|----------------|---------------|
| Medical data privacy (HIPAA) | Basic encryption | Add audit logging, data retention policies |
| AI sending data to OpenAI | N/A | Anonymize data before sending, use EU endpoint |
| Allergy data accuracy | Manual entry | Mark AI-extracted as "unverified" until approved |

---

## 11. Timeline Estimate

| Phase | Tasks | Duration | Dependencies |
|-------|-------|----------|--------------|
| **P1** | Onboarding screens + backend | 4-5 days | None |
| **P2** | Validation engine updates | 2 days | P1 (for dislike strength) |
| **P3** | Dashboard sidebar + batch validation | 3 days | P1, P2 |
| **P4** | AI lab analysis | 5+ days | P1 schema changes |

**Total:** ~2-3 weeks for P1-P3, +1 week for P4

---

## 12. Success Metrics

| Metric | Current | Target | How to Measure |
|--------|---------|--------|----------------|
| Onboarding completion rate | Unknown | >80% | Analytics on step dropoff |
| Validation accuracy | ~75% | >95% | Compare AI validation vs dietitian corrections |
| Diet plan creation time | Unknown | <10 min | Track time from start to publish |
| AI extraction accuracy | N/A | >85% | Compare AI vs approved values |

---

## Appendix A: File Structure Changes

```
backend/src/
├── controllers/
│   ├── onboarding.controller.ts    # UPDATE: new steps
│   └── labAnalysis.controller.ts   # NEW: AI analysis endpoints
├── services/
│   ├── onboarding.service.ts       # UPDATE: new methods
│   ├── validationEngine.service.ts # UPDATE: new rules
│   └── labAnalysis.service.ts      # NEW: AI integration
├── schemas/
│   ├── onboarding.schema.ts        # UPDATE: new validations
│   └── labAnalysis.schema.ts       # NEW: request/response schemas
├── routes/
│   └── labAnalysis.routes.ts       # NEW: analysis endpoints
└── types/
    ├── validation.types.ts         # UPDATE: weeklyUsage, goal
    └── labAnalysis.types.ts        # NEW: AI types

client-app/app/(onboarding)/
├── step1.tsx                       # UPDATE: add name, DOB
├── step2-medical.tsx               # NEW: medical history
├── step3.tsx                       # Minor: allergy severity
├── step4.tsx                       # No changes
├── step5.tsx                       # UPDATE: likes, cuisines, strength
├── step6-measurements.tsx          # NEW: body measurements
├── step7-review.tsx                # NEW: review screen
└── complete.tsx                    # No changes

frontend/src/components/
├── clients/
│   └── MedicalSummarySidebar.tsx   # NEW: sidebar component
└── lab-analysis/
    ├── AnalysisResultsTable.tsx    # NEW: results display
    ├── BiomarkerTrendChart.tsx     # NEW: trend visualization
    └── ReviewApprovalModal.tsx     # NEW: approval UI
```

---

## Appendix B: Glossary

| Term | Definition |
|------|------------|
| **Biomarker** | Measurable health indicator (e.g., HbA1c, Vitamin D) |
| **Client Tags** | Stored restrictions/preferences used for validation |
| **Food Tags** | Stored attributes of food items (allergens, nutrition) |
| **Lab Derived Tags** | Auto-generated tags from lab results |
| **Validation Engine** | Real-time service that checks food-client compatibility |
| **RAG** | Retrieval-Augmented Generation (AI + knowledge base) |
| **Severity** | RED (blocking), YELLOW (warning), GREEN (positive) |

---

*End of Technical Specification*
</file>

<file path="backend/prisma/migrations/20251207194046_init/migration.sql">
-- CreateEnum
CREATE TYPE "public"."SubscriptionTier" AS ENUM ('free', 'pro', 'clinic', 'enterprise');

-- CreateEnum
CREATE TYPE "public"."SubscriptionStatus" AS ENUM ('active', 'paused', 'cancelled');

-- CreateEnum
CREATE TYPE "public"."UserRole" AS ENUM ('owner', 'admin', 'dietitian');

-- CreateEnum
CREATE TYPE "public"."Gender" AS ENUM ('male', 'female', 'other');

-- CreateEnum
CREATE TYPE "public"."ActivityLevel" AS ENUM ('sedentary', 'lightly_active', 'moderately_active', 'very_active');

-- CreateEnum
CREATE TYPE "public"."DietPlanStatus" AS ENUM ('draft', 'active', 'completed', 'paused');

-- CreateEnum
CREATE TYPE "public"."DietPlanVisibility" AS ENUM ('private', 'org_shared', 'public');

-- CreateEnum
CREATE TYPE "public"."MealType" AS ENUM ('breakfast', 'lunch', 'snack', 'dinner');

-- CreateEnum
CREATE TYPE "public"."MealLogStatus" AS ENUM ('pending', 'eaten', 'skipped', 'substituted');

-- CreateEnum
CREATE TYPE "public"."NoteType" AS ENUM ('SOAP', 'DAP', 'other');

-- CreateEnum
CREATE TYPE "public"."RecipientType" AS ENUM ('user', 'client');

-- CreateEnum
CREATE TYPE "public"."DeliveryStatus" AS ENUM ('pending', 'delivered', 'failed');

-- CreateEnum
CREATE TYPE "public"."InvoiceStatus" AS ENUM ('unpaid', 'sent', 'paid', 'cancelled');

-- CreateTable
CREATE TABLE "public"."Organization" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "logoUrl" TEXT,
    "phone" TEXT,
    "email" TEXT,
    "address" TEXT,
    "city" TEXT,
    "country" TEXT NOT NULL DEFAULT 'IN',
    "timezone" TEXT NOT NULL DEFAULT 'Asia/Kolkata',
    "subscriptionTier" "public"."SubscriptionTier" NOT NULL DEFAULT 'free',
    "subscriptionStatus" "public"."SubscriptionStatus" NOT NULL DEFAULT 'active',
    "subscriptionExpiresAt" TIMESTAMP(3),
    "maxClients" INTEGER NOT NULL DEFAULT 10,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),
    "isActive" BOOLEAN NOT NULL DEFAULT true,

    CONSTRAINT "Organization_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."User" (
    "id" TEXT NOT NULL,
    "orgId" TEXT NOT NULL,
    "clerkUserId" TEXT,
    "role" "public"."UserRole" NOT NULL,
    "email" TEXT NOT NULL,
    "fullName" TEXT NOT NULL,
    "phone" TEXT,
    "profilePhotoUrl" TEXT,
    "licenseNumber" TEXT,
    "specialization" TEXT,
    "bio" TEXT,
    "mfaEnabled" BOOLEAN NOT NULL DEFAULT false,
    "lastLoginAt" TIMESTAMP(3),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),
    "isActive" BOOLEAN NOT NULL DEFAULT true,

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."Client" (
    "id" TEXT NOT NULL,
    "orgId" TEXT NOT NULL,
    "primaryDietitianId" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "phone" TEXT NOT NULL,
    "fullName" TEXT NOT NULL,
    "dateOfBirth" DATE,
    "gender" "public"."Gender",
    "profilePhotoUrl" TEXT,
    "heightCm" DECIMAL(5,2),
    "currentWeightKg" DECIMAL(5,2),
    "targetWeightKg" DECIMAL(5,2),
    "activityLevel" "public"."ActivityLevel",
    "dietaryPreferences" TEXT[],
    "allergies" TEXT[],
    "medicalConditions" TEXT[],
    "medications" TEXT[],
    "healthNotes" TEXT,
    "emergencyContactName" TEXT,
    "emergencyContactPhone" TEXT,
    "onboardingCompleted" BOOLEAN NOT NULL DEFAULT false,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),
    "createdByUserId" TEXT,
    "isActive" BOOLEAN NOT NULL DEFAULT true,

    CONSTRAINT "Client_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."MedicalProfile" (
    "id" TEXT NOT NULL,
    "clientId" TEXT NOT NULL,
    "diagnoses" TEXT[],
    "allergies" TEXT[],
    "intolerances" TEXT[],
    "medications" TEXT[],
    "supplements" TEXT[],
    "surgeries" TEXT[],
    "familyHistory" TEXT,
    "healthNotes" TEXT,
    "dietaryRestrictions" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "updatedByUserId" TEXT,

    CONSTRAINT "MedicalProfile_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."DietPlan" (
    "id" TEXT NOT NULL,
    "orgId" TEXT NOT NULL,
    "clientId" TEXT NOT NULL,
    "createdByUserId" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "startDate" DATE NOT NULL,
    "endDate" DATE,
    "targetCalories" INTEGER,
    "targetProteinG" DECIMAL(5,1),
    "targetCarbsG" DECIMAL(5,1),
    "targetFatsG" DECIMAL(5,1),
    "targetFiberG" DECIMAL(5,1),
    "notesForClient" TEXT,
    "internalNotes" TEXT,
    "status" "public"."DietPlanStatus" NOT NULL DEFAULT 'draft',
    "isTemplate" BOOLEAN NOT NULL DEFAULT false,
    "templateCategory" TEXT,
    "visibility" "public"."DietPlanVisibility" NOT NULL DEFAULT 'private',
    "publishedAt" TIMESTAMP(3),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),
    "isActive" BOOLEAN NOT NULL DEFAULT true,

    CONSTRAINT "DietPlan_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."Meal" (
    "id" TEXT NOT NULL,
    "planId" TEXT NOT NULL,
    "dayOfWeek" INTEGER,
    "mealDate" DATE,
    "sequenceNumber" INTEGER,
    "mealType" "public"."MealType" NOT NULL,
    "timeOfDay" TEXT,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "instructions" TEXT,
    "servingSizeNotes" TEXT,
    "totalCalories" INTEGER,
    "totalProteinG" DECIMAL(5,1),
    "totalCarbsG" DECIMAL(5,1),
    "totalFatsG" DECIMAL(5,1),
    "totalFiberG" DECIMAL(5,1),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Meal_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."FoodItem" (
    "id" TEXT NOT NULL,
    "orgId" TEXT,
    "name" TEXT NOT NULL,
    "brand" TEXT,
    "category" TEXT NOT NULL,
    "subCategory" TEXT,
    "servingSizeG" DECIMAL(6,2) NOT NULL DEFAULT 100,
    "calories" INTEGER NOT NULL,
    "proteinG" DECIMAL(5,1),
    "carbsG" DECIMAL(5,1),
    "fatsG" DECIMAL(5,1),
    "fiberG" DECIMAL(5,1),
    "sodiumMg" DECIMAL(7,2),
    "sugarG" DECIMAL(5,1),
    "isVerified" BOOLEAN NOT NULL DEFAULT false,
    "source" TEXT,
    "barcode" TEXT,
    "allergenFlags" TEXT[],
    "dietaryTags" TEXT[],
    "createdByUserId" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "FoodItem_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."MealFoodItem" (
    "id" TEXT NOT NULL,
    "mealId" TEXT NOT NULL,
    "foodId" TEXT NOT NULL,
    "quantityG" DECIMAL(6,2) NOT NULL,
    "calories" INTEGER,
    "proteinG" DECIMAL(5,1),
    "carbsG" DECIMAL(5,1),
    "fatsG" DECIMAL(5,1),
    "fiberG" DECIMAL(5,1),
    "sortOrder" INTEGER NOT NULL DEFAULT 0,
    "notes" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "MealFoodItem_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."MealLog" (
    "id" TEXT NOT NULL,
    "orgId" TEXT NOT NULL,
    "clientId" TEXT NOT NULL,
    "mealId" TEXT NOT NULL,
    "scheduledDate" DATE NOT NULL,
    "scheduledTime" TEXT,
    "status" "public"."MealLogStatus" NOT NULL DEFAULT 'pending',
    "mealPhotoUrl" TEXT,
    "mealPhotoSmallUrl" TEXT,
    "photoUploadedAt" TIMESTAMP(3),
    "aiFoodRecognition" JSONB,
    "clientNotes" TEXT,
    "dietitianFeedback" TEXT,
    "dietitianFeedbackAt" TIMESTAMP(3),
    "reviewedByUserId" TEXT,
    "substituteDescription" TEXT,
    "substituteCaloriesEst" INTEGER,
    "loggedAt" TIMESTAMP(3),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "MealLog_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."WeightLog" (
    "id" TEXT NOT NULL,
    "orgId" TEXT NOT NULL,
    "clientId" TEXT NOT NULL,
    "weightKg" DECIMAL(5,2) NOT NULL,
    "logDate" DATE NOT NULL,
    "logTime" TEXT,
    "notes" TEXT,
    "progressPhotoUrl" TEXT,
    "bmi" DECIMAL(4,2),
    "weightChangeFromPrevious" DECIMAL(5,2),
    "isOutlier" BOOLEAN NOT NULL DEFAULT false,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "WeightLog_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."BodyMeasurement" (
    "id" TEXT NOT NULL,
    "orgId" TEXT NOT NULL,
    "clientId" TEXT NOT NULL,
    "logDate" DATE NOT NULL,
    "chestCm" DECIMAL(5,2),
    "waistCm" DECIMAL(5,2),
    "hipsCm" DECIMAL(5,2),
    "thighsCm" DECIMAL(5,2),
    "armsCm" DECIMAL(5,2),
    "bodyFatPercentage" DECIMAL(4,2),
    "notes" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "BodyMeasurement_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."SessionNote" (
    "id" TEXT NOT NULL,
    "orgId" TEXT NOT NULL,
    "clientId" TEXT NOT NULL,
    "createdByUserId" TEXT NOT NULL,
    "noteType" "public"."NoteType" NOT NULL,
    "title" TEXT NOT NULL,
    "subjective" TEXT,
    "objective" TEXT,
    "assessment" TEXT,
    "plan" TEXT,
    "internalNotes" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),

    CONSTRAINT "SessionNote_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."Notification" (
    "id" TEXT NOT NULL,
    "recipientId" TEXT NOT NULL,
    "recipientType" "public"."RecipientType" NOT NULL,
    "orgId" TEXT NOT NULL,
    "type" TEXT NOT NULL,
    "category" TEXT,
    "title" TEXT NOT NULL,
    "message" TEXT NOT NULL,
    "icon" TEXT,
    "deepLink" TEXT,
    "relatedEntityType" TEXT,
    "relatedEntityId" TEXT,
    "isRead" BOOLEAN NOT NULL DEFAULT false,
    "readAt" TIMESTAMP(3),
    "sentViaChannels" TEXT[] DEFAULT ARRAY['push']::TEXT[],
    "deliveryStatus" "public"."DeliveryStatus" NOT NULL DEFAULT 'pending',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "expiresAt" TIMESTAMP(3) NOT NULL DEFAULT NOW() + INTERVAL '30 days',

    CONSTRAINT "Notification_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."ActivityLog" (
    "id" TEXT NOT NULL,
    "orgId" TEXT NOT NULL,
    "userId" TEXT,
    "userType" TEXT,
    "action" TEXT NOT NULL,
    "entityType" TEXT,
    "entityId" TEXT,
    "oldValues" JSONB,
    "newValues" JSONB,
    "changeDesc" TEXT,
    "ipAddress" TEXT,
    "userAgent" TEXT,
    "status" TEXT NOT NULL DEFAULT 'success',
    "errorMessage" TEXT,
    "metadata" JSONB,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "ActivityLog_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "public"."Invoice" (
    "id" TEXT NOT NULL,
    "orgId" TEXT NOT NULL,
    "clientId" TEXT NOT NULL,
    "createdByUserId" TEXT NOT NULL,
    "invoiceNumber" TEXT NOT NULL,
    "issueDate" DATE NOT NULL,
    "dueDate" DATE NOT NULL,
    "currency" TEXT NOT NULL DEFAULT 'INR',
    "subtotal" DECIMAL(10,2) NOT NULL,
    "tax" DECIMAL(10,2) NOT NULL DEFAULT 0,
    "total" DECIMAL(10,2) NOT NULL,
    "status" "public"."InvoiceStatus" NOT NULL DEFAULT 'unpaid',
    "notes" TEXT,
    "sentAt" TIMESTAMP(3),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Invoice_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "Organization_name_key" ON "public"."Organization"("name");

-- CreateIndex
CREATE INDEX "Organization_subscriptionStatus_idx" ON "public"."Organization"("subscriptionStatus");

-- CreateIndex
CREATE INDEX "Organization_isActive_idx" ON "public"."Organization"("isActive");

-- CreateIndex
CREATE UNIQUE INDEX "User_clerkUserId_key" ON "public"."User"("clerkUserId");

-- CreateIndex
CREATE INDEX "User_orgId_idx" ON "public"."User"("orgId");

-- CreateIndex
CREATE INDEX "User_clerkUserId_idx" ON "public"."User"("clerkUserId");

-- CreateIndex
CREATE INDEX "User_role_idx" ON "public"."User"("role");

-- CreateIndex
CREATE UNIQUE INDEX "User_orgId_email_key" ON "public"."User"("orgId", "email");

-- CreateIndex
CREATE INDEX "Client_orgId_idx" ON "public"."Client"("orgId");

-- CreateIndex
CREATE INDEX "Client_primaryDietitianId_idx" ON "public"."Client"("primaryDietitianId");

-- CreateIndex
CREATE INDEX "Client_isActive_idx" ON "public"."Client"("isActive");

-- CreateIndex
CREATE UNIQUE INDEX "Client_orgId_email_key" ON "public"."Client"("orgId", "email");

-- CreateIndex
CREATE UNIQUE INDEX "MedicalProfile_clientId_key" ON "public"."MedicalProfile"("clientId");

-- CreateIndex
CREATE INDEX "MedicalProfile_clientId_idx" ON "public"."MedicalProfile"("clientId");

-- CreateIndex
CREATE INDEX "DietPlan_orgId_idx" ON "public"."DietPlan"("orgId");

-- CreateIndex
CREATE INDEX "DietPlan_clientId_idx" ON "public"."DietPlan"("clientId");

-- CreateIndex
CREATE INDEX "DietPlan_status_idx" ON "public"."DietPlan"("status");

-- CreateIndex
CREATE INDEX "DietPlan_isTemplate_idx" ON "public"."DietPlan"("isTemplate");

-- CreateIndex
CREATE INDEX "Meal_planId_idx" ON "public"."Meal"("planId");

-- CreateIndex
CREATE INDEX "Meal_mealDate_idx" ON "public"."Meal"("mealDate");

-- CreateIndex
CREATE INDEX "FoodItem_orgId_idx" ON "public"."FoodItem"("orgId");

-- CreateIndex
CREATE INDEX "FoodItem_category_idx" ON "public"."FoodItem"("category");

-- CreateIndex
CREATE INDEX "MealFoodItem_mealId_idx" ON "public"."MealFoodItem"("mealId");

-- CreateIndex
CREATE INDEX "MealFoodItem_foodId_idx" ON "public"."MealFoodItem"("foodId");

-- CreateIndex
CREATE INDEX "MealLog_orgId_idx" ON "public"."MealLog"("orgId");

-- CreateIndex
CREATE INDEX "MealLog_clientId_idx" ON "public"."MealLog"("clientId");

-- CreateIndex
CREATE INDEX "MealLog_scheduledDate_idx" ON "public"."MealLog"("scheduledDate");

-- CreateIndex
CREATE INDEX "MealLog_status_idx" ON "public"."MealLog"("status");

-- CreateIndex
CREATE INDEX "WeightLog_orgId_idx" ON "public"."WeightLog"("orgId");

-- CreateIndex
CREATE INDEX "WeightLog_clientId_idx" ON "public"."WeightLog"("clientId");

-- CreateIndex
CREATE UNIQUE INDEX "WeightLog_clientId_logDate_key" ON "public"."WeightLog"("clientId", "logDate");

-- CreateIndex
CREATE INDEX "BodyMeasurement_orgId_idx" ON "public"."BodyMeasurement"("orgId");

-- CreateIndex
CREATE INDEX "BodyMeasurement_clientId_idx" ON "public"."BodyMeasurement"("clientId");

-- CreateIndex
CREATE INDEX "SessionNote_orgId_idx" ON "public"."SessionNote"("orgId");

-- CreateIndex
CREATE INDEX "SessionNote_clientId_idx" ON "public"."SessionNote"("clientId");

-- CreateIndex
CREATE INDEX "Notification_recipientId_recipientType_idx" ON "public"."Notification"("recipientId", "recipientType");

-- CreateIndex
CREATE INDEX "Notification_isRead_idx" ON "public"."Notification"("isRead");

-- CreateIndex
CREATE INDEX "Notification_orgId_idx" ON "public"."Notification"("orgId");

-- CreateIndex
CREATE INDEX "ActivityLog_orgId_idx" ON "public"."ActivityLog"("orgId");

-- CreateIndex
CREATE INDEX "ActivityLog_userId_idx" ON "public"."ActivityLog"("userId");

-- CreateIndex
CREATE INDEX "ActivityLog_action_idx" ON "public"."ActivityLog"("action");

-- CreateIndex
CREATE UNIQUE INDEX "Invoice_invoiceNumber_key" ON "public"."Invoice"("invoiceNumber");

-- CreateIndex
CREATE INDEX "Invoice_orgId_idx" ON "public"."Invoice"("orgId");

-- CreateIndex
CREATE INDEX "Invoice_clientId_idx" ON "public"."Invoice"("clientId");

-- CreateIndex
CREATE INDEX "Invoice_status_idx" ON "public"."Invoice"("status");

-- AddForeignKey
ALTER TABLE "public"."User" ADD CONSTRAINT "User_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."Client" ADD CONSTRAINT "Client_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."Client" ADD CONSTRAINT "Client_primaryDietitianId_fkey" FOREIGN KEY ("primaryDietitianId") REFERENCES "public"."User"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."MedicalProfile" ADD CONSTRAINT "MedicalProfile_clientId_fkey" FOREIGN KEY ("clientId") REFERENCES "public"."Client"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."DietPlan" ADD CONSTRAINT "DietPlan_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."DietPlan" ADD CONSTRAINT "DietPlan_clientId_fkey" FOREIGN KEY ("clientId") REFERENCES "public"."Client"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."DietPlan" ADD CONSTRAINT "DietPlan_createdByUserId_fkey" FOREIGN KEY ("createdByUserId") REFERENCES "public"."User"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."Meal" ADD CONSTRAINT "Meal_planId_fkey" FOREIGN KEY ("planId") REFERENCES "public"."DietPlan"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."FoodItem" ADD CONSTRAINT "FoodItem_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."FoodItem" ADD CONSTRAINT "FoodItem_createdByUserId_fkey" FOREIGN KEY ("createdByUserId") REFERENCES "public"."User"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."MealFoodItem" ADD CONSTRAINT "MealFoodItem_mealId_fkey" FOREIGN KEY ("mealId") REFERENCES "public"."Meal"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."MealFoodItem" ADD CONSTRAINT "MealFoodItem_foodId_fkey" FOREIGN KEY ("foodId") REFERENCES "public"."FoodItem"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."MealLog" ADD CONSTRAINT "MealLog_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."MealLog" ADD CONSTRAINT "MealLog_clientId_fkey" FOREIGN KEY ("clientId") REFERENCES "public"."Client"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."MealLog" ADD CONSTRAINT "MealLog_mealId_fkey" FOREIGN KEY ("mealId") REFERENCES "public"."Meal"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."MealLog" ADD CONSTRAINT "MealLog_reviewedByUserId_fkey" FOREIGN KEY ("reviewedByUserId") REFERENCES "public"."User"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."WeightLog" ADD CONSTRAINT "WeightLog_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."WeightLog" ADD CONSTRAINT "WeightLog_clientId_fkey" FOREIGN KEY ("clientId") REFERENCES "public"."Client"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."BodyMeasurement" ADD CONSTRAINT "BodyMeasurement_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."BodyMeasurement" ADD CONSTRAINT "BodyMeasurement_clientId_fkey" FOREIGN KEY ("clientId") REFERENCES "public"."Client"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."SessionNote" ADD CONSTRAINT "SessionNote_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."SessionNote" ADD CONSTRAINT "SessionNote_clientId_fkey" FOREIGN KEY ("clientId") REFERENCES "public"."Client"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."SessionNote" ADD CONSTRAINT "SessionNote_createdByUserId_fkey" FOREIGN KEY ("createdByUserId") REFERENCES "public"."User"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."Notification" ADD CONSTRAINT "Notification_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."ActivityLog" ADD CONSTRAINT "ActivityLog_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."ActivityLog" ADD CONSTRAINT "ActivityLog_userId_fkey" FOREIGN KEY ("userId") REFERENCES "public"."User"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."Invoice" ADD CONSTRAINT "Invoice_orgId_fkey" FOREIGN KEY ("orgId") REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."Invoice" ADD CONSTRAINT "Invoice_clientId_fkey" FOREIGN KEY ("clientId") REFERENCES "public"."Client"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "public"."Invoice" ADD CONSTRAINT "Invoice_createdByUserId_fkey" FOREIGN KEY ("createdByUserId") REFERENCES "public"."User"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
</file>

<file path="backend/prisma/migrations/migration_lock.toml">
# Please do not edit this file manually
# It should be added in your version-control system (e.g., Git)
provider = "postgresql"
</file>

<file path="backend/scripts/deduplicate-meallogs.ts">
/**
 * Script to find and deduplicate MealLog entries
 * Run this BEFORE applying the unique constraint
 * 
 * Usage: npx ts-node scripts/deduplicate-meallogs.ts
 */

import prisma from '../src/utils/prisma';

async function findDuplicates() {
    console.log('🔍 Finding duplicate meal logs...\n');

    // Find duplicates using raw query
    const duplicates = await prisma.$queryRaw<Array<{
        clientId: string;
        mealId: string;
        scheduledDate: Date;
        count: bigint;
    }>>`
        SELECT "clientId", "mealId", "scheduledDate", COUNT(*) as count
        FROM "MealLog"
        GROUP BY "clientId", "mealId", "scheduledDate"
        HAVING COUNT(*) > 1
    `;

    console.log(`Found ${duplicates.length} duplicate groups\n`);

    for (const dup of duplicates) {
        console.log(`Duplicate: clientId=${dup.clientId.slice(0, 8)}..., mealId=${dup.mealId.slice(0, 8)}..., date=${dup.scheduledDate}, count=${dup.count}`);
    }

    return duplicates;
}

async function deduplicateMealLogs(dryRun = true) {
    console.log(`\n🧹 ${dryRun ? '[DRY RUN] ' : ''}Deduplicating meal logs...\n`);

    const duplicates = await findDuplicates();
    let deletedCount = 0;

    for (const dup of duplicates) {
        // Get all logs for this duplicate group
        const logs = await prisma.mealLog.findMany({
            where: {
                clientId: dup.clientId,
                mealId: dup.mealId,
                scheduledDate: dup.scheduledDate
            },
            orderBy: [
                { loggedAt: 'desc' },  // Prefer logged over pending
                { updatedAt: 'desc' }, // Prefer most recently updated
                { createdAt: 'desc' }  // Fallback to most recently created
            ]
        });

        // Keep the first (best) one, delete the rest
        const [keep, ...toDelete] = logs;

        console.log(`  Keeping log ${keep.id} (status: ${keep.status}, loggedAt: ${keep.loggedAt})`);

        for (const log of toDelete) {
            console.log(`  ${dryRun ? 'Would delete' : 'Deleting'} log ${log.id} (status: ${log.status})`);

            if (!dryRun) {
                await prisma.mealLog.delete({ where: { id: log.id } });
                deletedCount++;
            }
        }
    }

    console.log(`\n${dryRun ? 'Would delete' : 'Deleted'} ${dryRun ? duplicates.reduce((acc, d) => acc + Number(d.count) - 1, 0) : deletedCount} duplicate logs`);
}

async function main() {
    const args = process.argv.slice(2);
    const dryRun = !args.includes('--apply');

    if (dryRun) {
        console.log('⚠️  Running in DRY RUN mode. Use --apply to actually delete duplicates.\n');
    }

    try {
        await deduplicateMealLogs(dryRun);
    } catch (error) {
        console.error('Error:', error);
        process.exit(1);
    } finally {
        await prisma.$disconnect();
    }
}

main();
</file>

<file path="backend/scripts/seedCommonFoods.ts">
/**
 * Seed script for common Indian foods with tags
 * Run with: npx tsx scripts/seedCommonFoods.ts
 */

import prisma from '../src/utils/prisma';
import { foodTaggingService } from '../src/services/foodTagging.service';

interface FoodSeed {
    name: string;
    category: string;
    calories: number;
    proteinG?: number;
    carbsG?: number;
    fatsG?: number;
    fiberG?: number;
    sugarG?: number;
    sodiumMg?: number;
    dietaryCategory: string;
}

// Common Indian foods with nutrition per 100g
const COMMON_FOODS: FoodSeed[] = [
    // Breakfast items
    { name: 'Idli', category: 'Breakfast', calories: 39, proteinG: 1.5, carbsG: 8, fatsG: 0.2, fiberG: 0.3, dietaryCategory: 'vegetarian' },
    { name: 'Dosa', category: 'Breakfast', calories: 89, proteinG: 2, carbsG: 12, fatsG: 3.5, fiberG: 0.5, dietaryCategory: 'vegetarian' },
    { name: 'Upma', category: 'Breakfast', calories: 110, proteinG: 3, carbsG: 17, fatsG: 3.5, fiberG: 1, dietaryCategory: 'vegetarian' },
    { name: 'Poha', category: 'Breakfast', calories: 130, proteinG: 2.5, carbsG: 20, fatsG: 4, fiberG: 1, dietaryCategory: 'vegetarian' },
    { name: 'Paratha', category: 'Breakfast', calories: 260, proteinG: 5, carbsG: 32, fatsG: 12, fiberG: 2, dietaryCategory: 'vegetarian' },
    { name: 'Aloo Paratha', category: 'Breakfast', calories: 280, proteinG: 6, carbsG: 35, fatsG: 13, fiberG: 2.5, dietaryCategory: 'vegetarian' },
    { name: 'Egg Omelette', category: 'Breakfast', calories: 154, proteinG: 11, carbsG: 1, fatsG: 12, dietaryCategory: 'non_veg' },
    { name: 'Boiled Eggs (2)', category: 'Breakfast', calories: 155, proteinG: 13, carbsG: 1.1, fatsG: 11, dietaryCategory: 'non_veg' },
    { name: 'Cheela (Besan)', category: 'Breakfast', calories: 180, proteinG: 7, carbsG: 18, fatsG: 8, fiberG: 3, dietaryCategory: 'vegetarian' },

    // Rice & Rotis
    { name: 'White Rice (Cooked)', category: 'Grains', calories: 130, proteinG: 2.7, carbsG: 28, fatsG: 0.3, fiberG: 0.4, dietaryCategory: 'vegetarian' },
    { name: 'Brown Rice (Cooked)', category: 'Grains', calories: 111, proteinG: 2.6, carbsG: 23, fatsG: 0.9, fiberG: 1.8, dietaryCategory: 'vegetarian' },
    { name: 'Chapati (Wheat Roti)', category: 'Grains', calories: 71, proteinG: 2.7, carbsG: 15, fatsG: 0.4, fiberG: 1.9, dietaryCategory: 'vegetarian' },
    { name: 'Naan', category: 'Grains', calories: 262, proteinG: 8, carbsG: 45, fatsG: 5, fiberG: 2, dietaryCategory: 'vegetarian' },
    { name: 'Jeera Rice', category: 'Grains', calories: 150, proteinG: 3, carbsG: 30, fatsG: 2, fiberG: 0.5, dietaryCategory: 'vegetarian' },

    // Dals & Legumes
    { name: 'Dal Tadka', category: 'Legumes', calories: 116, proteinG: 6.5, carbsG: 16, fatsG: 3, fiberG: 4, dietaryCategory: 'vegetarian' },
    { name: 'Chana Masala', category: 'Legumes', calories: 180, proteinG: 8.5, carbsG: 26, fatsG: 4.5, fiberG: 6, dietaryCategory: 'vegetarian' },
    { name: 'Rajma', category: 'Legumes', calories: 140, proteinG: 7, carbsG: 22, fatsG: 2.5, fiberG: 5, dietaryCategory: 'vegetarian' },
    { name: 'Sambhar', category: 'Legumes', calories: 65, proteinG: 3, carbsG: 10, fatsG: 1.5, fiberG: 2.5, dietaryCategory: 'vegetarian' },
    { name: 'Dal Makhani', category: 'Legumes', calories: 180, proteinG: 7, carbsG: 20, fatsG: 8, fiberG: 5, dietaryCategory: 'vegetarian' },

    // Vegetables
    { name: 'Aloo Gobi', category: 'Vegetables', calories: 90, proteinG: 2, carbsG: 12, fatsG: 4, fiberG: 2.5, dietaryCategory: 'vegetarian' },
    { name: 'Bhindi Masala', category: 'Vegetables', calories: 85, proteinG: 2.5, carbsG: 8, fatsG: 5, fiberG: 3, dietaryCategory: 'vegetarian' },
    { name: 'Palak Paneer', category: 'Vegetables', calories: 200, proteinG: 10, carbsG: 8, fatsG: 15, fiberG: 2, dietaryCategory: 'vegetarian' },
    { name: 'Paneer Butter Masala', category: 'Vegetables', calories: 280, proteinG: 12, carbsG: 10, fatsG: 22, fiberG: 1, dietaryCategory: 'vegetarian' },
    { name: 'Mixed Veg Curry', category: 'Vegetables', calories: 100, proteinG: 3, carbsG: 12, fatsG: 4.5, fiberG: 3, dietaryCategory: 'vegetarian' },
    { name: 'Baingan Bharta', category: 'Vegetables', calories: 110, proteinG: 2, carbsG: 10, fatsG: 7, fiberG: 3, dietaryCategory: 'vegetarian' },

    // Non-Veg Curries
    { name: 'Butter Chicken', category: 'Non-Veg', calories: 245, proteinG: 16, carbsG: 6, fatsG: 18, dietaryCategory: 'non_veg' },
    { name: 'Chicken Curry', category: 'Non-Veg', calories: 180, proteinG: 18, carbsG: 4, fatsG: 10, dietaryCategory: 'non_veg' },
    { name: 'Mutton Curry', category: 'Non-Veg', calories: 250, proteinG: 20, carbsG: 5, fatsG: 17, dietaryCategory: 'non_veg' },
    { name: 'Fish Curry', category: 'Non-Veg', calories: 135, proteinG: 18, carbsG: 3, fatsG: 5.5, dietaryCategory: 'non_veg' },
    { name: 'Egg Curry', category: 'Non-Veg', calories: 150, proteinG: 10, carbsG: 5, fatsG: 10, dietaryCategory: 'non_veg' },
    { name: 'Chicken Biryani', category: 'Non-Veg', calories: 190, proteinG: 8, carbsG: 25, fatsG: 6, dietaryCategory: 'non_veg' },
    { name: 'Tandoori Chicken', category: 'Non-Veg', calories: 165, proteinG: 25, carbsG: 3, fatsG: 6, dietaryCategory: 'non_veg' },

    // Snacks
    { name: 'Samosa (1 pc)', category: 'Snacks', calories: 260, proteinG: 4, carbsG: 30, fatsG: 14, fiberG: 2, dietaryCategory: 'vegetarian' },
    { name: 'Pakora', category: 'Snacks', calories: 240, proteinG: 6, carbsG: 20, fatsG: 15, fiberG: 2, dietaryCategory: 'vegetarian' },
    { name: 'Vada Pav', category: 'Snacks', calories: 290, proteinG: 5, carbsG: 35, fatsG: 14, dietaryCategory: 'vegetarian' },
    { name: 'Pav Bhaji', category: 'Snacks', calories: 320, proteinG: 6, carbsG: 40, fatsG: 15, fiberG: 4, dietaryCategory: 'vegetarian' },
    { name: 'Bhel Puri', category: 'Snacks', calories: 150, proteinG: 3, carbsG: 25, fatsG: 4, fiberG: 2, dietaryCategory: 'vegetarian' },

    // Dairy
    { name: 'Curd (Dahi)', category: 'Dairy', calories: 60, proteinG: 3.4, carbsG: 5, fatsG: 3.3, dietaryCategory: 'vegetarian' },
    { name: 'Paneer (100g)', category: 'Dairy', calories: 265, proteinG: 18, carbsG: 2, fatsG: 21, dietaryCategory: 'vegetarian' },
    { name: 'Lassi (Sweet)', category: 'Dairy', calories: 100, proteinG: 3, carbsG: 18, fatsG: 2, sugarG: 15, dietaryCategory: 'vegetarian' },
    { name: 'Buttermilk (Chaas)', category: 'Dairy', calories: 25, proteinG: 2, carbsG: 3, fatsG: 0.5, dietaryCategory: 'vegetarian' },

    // Sweets
    { name: 'Gulab Jamun (1 pc)', category: 'Sweets', calories: 175, proteinG: 2, carbsG: 28, fatsG: 6, sugarG: 22, dietaryCategory: 'vegetarian' },
    { name: 'Rasgulla (1 pc)', category: 'Sweets', calories: 120, proteinG: 3, carbsG: 22, fatsG: 2, sugarG: 18, dietaryCategory: 'vegetarian' },
    { name: 'Kheer', category: 'Sweets', calories: 140, proteinG: 4, carbsG: 22, fatsG: 4, sugarG: 16, dietaryCategory: 'vegetarian' },
    { name: 'Jalebi (2 pcs)', category: 'Sweets', calories: 180, proteinG: 1, carbsG: 35, fatsG: 4, sugarG: 28, dietaryCategory: 'vegetarian' },

    // Fruits
    { name: 'Banana', category: 'Fruits', calories: 89, proteinG: 1.1, carbsG: 23, fatsG: 0.3, fiberG: 2.6, sugarG: 12, dietaryCategory: 'vegan' },
    { name: 'Apple', category: 'Fruits', calories: 52, proteinG: 0.3, carbsG: 14, fatsG: 0.2, fiberG: 2.4, sugarG: 10, dietaryCategory: 'vegan' },
    { name: 'Mango', category: 'Fruits', calories: 60, proteinG: 0.8, carbsG: 15, fatsG: 0.4, fiberG: 1.6, sugarG: 14, dietaryCategory: 'vegan' },
    { name: 'Papaya', category: 'Fruits', calories: 43, proteinG: 0.5, carbsG: 11, fatsG: 0.3, fiberG: 1.7, sugarG: 8, dietaryCategory: 'vegan' },

    // Beverages
    { name: 'Chai (with milk & sugar)', category: 'Beverages', calories: 65, proteinG: 2, carbsG: 10, fatsG: 2, sugarG: 8, dietaryCategory: 'vegetarian' },
    { name: 'Coffee (with milk)', category: 'Beverages', calories: 50, proteinG: 1.5, carbsG: 6, fatsG: 2, sugarG: 5, dietaryCategory: 'vegetarian' },
    { name: 'Nimbu Pani', category: 'Beverages', calories: 40, proteinG: 0, carbsG: 10, fatsG: 0, sugarG: 8, dietaryCategory: 'vegan' },
    { name: 'Coconut Water', category: 'Beverages', calories: 19, proteinG: 0.7, carbsG: 4, fatsG: 0.2, sugarG: 2.6, dietaryCategory: 'vegan' },
];

async function seedCommonFoods() {
    console.log('🌱 Starting food seed...\n');

    let created = 0;
    let skipped = 0;

    for (const food of COMMON_FOODS) {
        // Check if food already exists (by name)
        const existing = await prisma.foodItem.findFirst({
            where: {
                name: { equals: food.name, mode: 'insensitive' },
                orgId: null // Global foods
            }
        });

        if (existing) {
            console.log(`⏭️  Skipped (exists): ${food.name}`);
            skipped++;
            continue;
        }

        // Create food item
        const newFood = await prisma.foodItem.create({
            data: {
                orgId: null, // Global food
                name: food.name,
                category: food.category,
                servingSizeG: 100,
                calories: food.calories,
                proteinG: food.proteinG,
                carbsG: food.carbsG,
                fatsG: food.fatsG,
                fiberG: food.fiberG,
                sugarG: food.sugarG,
                sodiumMg: food.sodiumMg,
                dietaryCategory: food.dietaryCategory,
                isVerified: true,
                source: 'seed_data'
            }
        });

        // Auto-tag with detection
        await foodTaggingService.autoTagFood(newFood.id);

        console.log(`✅ Created: ${food.name} (${food.dietaryCategory})`);
        created++;
    }

    console.log(`\n📊 Summary: Created ${created}, Skipped ${skipped}`);
    console.log('✅ Seed complete!');
}

// Run
seedCommonFoods()
    .catch(console.error)
    .finally(() => prisma.$disconnect());
</file>

<file path="backend/scripts/setup-garage.sh">
#!/bin/bash
set -e

# Remove old container
docker rm -f garage 2>/dev/null || true

# Generate secret
SECRET=$(openssl rand -hex 32)
ADMIN_TOKEN="hereisthetoken"

echo "Secret: $SECRET"
echo "Admin Token: $ADMIN_TOKEN"

# Create config inside volume
docker run --rm -v garage-data:/data alpine sh -c "mkdir -p /data/meta /data/data && cat > /data/garage.toml << 'CONFIGEOF'
metadata_dir = \"/data/meta\"
data_dir     = \"/data/data\"
db_engine    = \"sqlite\"

replication_factor = 1

rpc_bind_addr = \"[::]:3901\"
rpc_secret    = \"REPLACEME_SECRET\"

[s3_api]
s3_region = \"garage\"
api_bind_addr = \"[::]:3900\"
root_domain = \".s3.garage.localhost\"

[admin]
api_bind_addr = \"[::]:3902\"
admin_token = \"REPLACEME_TOKEN\"
CONFIGEOF
chown -R 1000:1000 /data"

# Replace placeholders with actual values
docker run --rm -v garage-data:/data alpine sh -c "sed -i 's/REPLACEME_SECRET/$SECRET/g' /data/garage.toml && sed -i 's/REPLACEME_TOKEN/$ADMIN_TOKEN/g' /data/garage.toml && cat /data/garage.toml"

# Start Garage with config file
docker run -d --name garage \
  -p 3900:3900 \
  -p 3901:3901 \
  -p 3902:3902 \
  -v garage-data:/data \
  dxflrs/garage:v2.1.0 \
  /garage -c /data/garage.toml server

sleep 2
echo "=== Container Status ==="
docker ps --filter name=garage
echo ""
echo "=== Garage Logs ==="
docker logs garage --tail 30
</file>

<file path="backend/scripts/setup-test-data.ts">
// Quick setup script to create test data
// Run with: npx tsx scripts/setup-test-data.ts

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
    // Get Clerk user ID from command line or use placeholder
    const clerkUserId = process.argv[2];

    if (!clerkUserId) {
        console.log('Usage: npx tsx scripts/setup-test-data.ts <clerk-user-id>');
        console.log('\nTo find your Clerk user ID:');
        console.log('1. Go to https://dashboard.clerk.com');
        console.log('2. Click on Users');
        console.log('3. Find your user and copy the user_xxx ID');
        process.exit(1);
    }

    console.log('Setting up test data...\n');

    // Create organization
    let org = await prisma.organization.findFirst();
    if (!org) {
        org = await prisma.organization.create({
            data: {
                name: 'Diet Karo Clinic',
                email: 'admin@dietkaro.com',
                isActive: true,
            },
        });
        console.log('✓ Created organization:', org.name);
    } else {
        console.log('✓ Organization exists:', org.name);
    }

    // Create or update user
    let user = await prisma.user.findUnique({ where: { clerkUserId } });
    if (!user) {
        user = await prisma.user.create({
            data: {
                clerkUserId,
                email: 'dietitian@dietkaro.com',
                fullName: 'Test Dietitian',
                role: 'owner',
                orgId: org.id,
                isActive: true,
            },
        });
        console.log('✓ Created user:', user.fullName, `(${user.role})`);
    } else {
        console.log('✓ User exists:', user.fullName);
    }

    // Create sample client
    let client = await prisma.client.findFirst({ where: { orgId: org.id } });
    if (!client) {
        client = await prisma.client.create({
            data: {
                orgId: org.id,
                fullName: 'Priya Sharma',
                email: 'priya@example.com',
                phone: '+91 98765 43210',
                gender: 'female',
                heightCm: 165,
                currentWeightKg: 65,
                targetWeightKg: 58,
                primaryDietitianId: user.id,
                createdByUserId: user.id,
            },
        });
        console.log('✓ Created sample client:', client.fullName);
    }

    // Create sample food items
    const foodCount = await prisma.foodItem.count();
    if (foodCount === 0) {
        await prisma.foodItem.createMany({
            data: [
                { name: 'Oatmeal', category: 'grains', servingSizeG: 100, caloriesPer100g: 389, proteinPer100g: 17, carbsPer100g: 66, fatsPer100g: 7, isGlobal: true, isVerified: true },
                { name: 'Chicken Breast', category: 'proteins', servingSizeG: 100, caloriesPer100g: 165, proteinPer100g: 31, carbsPer100g: 0, fatsPer100g: 4, isGlobal: true, isVerified: true },
                { name: 'Brown Rice', category: 'grains', servingSizeG: 100, caloriesPer100g: 112, proteinPer100g: 2, carbsPer100g: 24, fatsPer100g: 1, isGlobal: true, isVerified: true },
                { name: 'Broccoli', category: 'vegetables', servingSizeG: 100, caloriesPer100g: 34, proteinPer100g: 3, carbsPer100g: 7, fatsPer100g: 0, isGlobal: true, isVerified: true },
                { name: 'Greek Yogurt', category: 'dairy', servingSizeG: 100, caloriesPer100g: 59, proteinPer100g: 10, carbsPer100g: 4, fatsPer100g: 0, isGlobal: true, isVerified: true },
                { name: 'Almonds', category: 'proteins', servingSizeG: 30, caloriesPer100g: 579, proteinPer100g: 21, carbsPer100g: 22, fatsPer100g: 50, isGlobal: true, isVerified: true },
            ],
        });
        console.log('✓ Created 6 sample food items');
    }

    console.log('\n✅ Setup complete! Restart your backend and try again.');
}

main()
    .catch(console.error)
    .finally(() => prisma.$disconnect());
</file>

<file path="backend/src/config/compliance.config.ts">
/**
 * Compliance Engine Configuration
 * Configurable weights, penalties, and thresholds for meal compliance scoring
 */

export const COMPLIANCE_CONFIG = {
    // Scoring weights (must sum to 100)
    WEIGHTS: {
        ON_TIME: Number(process.env.COMPLIANCE_WEIGHT_ON_TIME) || 20,
        PHOTO: Number(process.env.COMPLIANCE_WEIGHT_PHOTO) || 15,
        CORRECT_FOODS: Number(process.env.COMPLIANCE_WEIGHT_CORRECT_FOODS) || 30,
        PORTION_ACCURACY: Number(process.env.COMPLIANCE_WEIGHT_PORTION) || 20,
        DIETITIAN_APPROVED: Number(process.env.COMPLIANCE_WEIGHT_DIETITIAN) || 15,
    },

    // Penalties
    PENALTIES: {
        SUBSTITUTION: Number(process.env.COMPLIANCE_PENALTY_SUBSTITUTION) || -10,
        SKIPPED_SCORE: 0,
    },

    // Color thresholds
    THRESHOLDS: {
        GREEN_MIN: Number(process.env.COMPLIANCE_THRESHOLD_GREEN) || 85,
        YELLOW_MIN: Number(process.env.COMPLIANCE_THRESHOLD_YELLOW) || 60,
        // Below YELLOW_MIN = RED
    },

    // Timing
    ON_TIME_WINDOW_MINUTES: Number(process.env.COMPLIANCE_ON_TIME_WINDOW) || 30,

    // Portion accuracy: deviation beyond this % loses points proportionally
    PORTION_TOLERANCE_PCT: 0.15,

    // Trend detection: ±threshold to determine improving/declining
    TREND_THRESHOLD: 5,
};
</file>

<file path="backend/src/config/validation-rules.config.ts">
/**
 * Validation Engine Configuration
 * Configurable thresholds for food validation rules
 */

export const VALIDATION_CONFIG = {
    /** Max times a food can appear in a week before triggering a repetition warning */
    REPETITION_THRESHOLD: Number(process.env.VALIDATION_REPETITION_THRESHOLD) || 3,

    /** Max consecutive days a food can appear before triggering a spacing warning */
    REPETITION_MAX_CONSECUTIVE_DAYS: 2,

    /** Single food providing > this % of daily calorie target triggers warning */
    SINGLE_FOOD_CALORIE_WARN_PCT: 0.50,

    /** Single food providing > this % of any macro target triggers warning */
    SINGLE_FOOD_MACRO_WARN_PCT: 0.60,

    /** How long client tags stay cached (ms) */
    CACHE_TTL_MS: Number(process.env.VALIDATION_CACHE_TTL_MS) || 5 * 60 * 1000,

    /** Maximum number of client tag entries in LRU cache */
    MAX_CACHE_SIZE: Number(process.env.VALIDATION_MAX_CACHE_SIZE) || 50,
};
</file>

<file path="backend/src/controllers/adminReferral.controller.ts">
import { Response } from 'express';
import prisma from '../utils/prisma';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import logger from '../utils/logger';

/**
 * Get referral statistics for the organization (admin dashboard)
 */
export const getOrgReferralStats = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    // Get total clients with referral codes
    const clientsWithCodes = await prisma.client.count({
        where: {
            orgId: req.user.organizationId,
            referralCode: { not: null },
            isActive: true
        }
    });

    // Get total referred clients
    const referredClients = await prisma.client.count({
        where: {
            orgId: req.user.organizationId,
            referredByClientId: { not: null },
            isActive: true
        }
    });

    // Get referral source breakdown
    const referralSourceBreakdown = await prisma.client.groupBy({
        by: ['referralSource'],
        where: {
            orgId: req.user.organizationId,
            referralSource: { not: null },
            isActive: true
        },
        _count: { id: true }
    });

    // Get total free months earned/used
    const benefitsAggr = await prisma.referralBenefit.aggregate({
        where: {
            client: { orgId: req.user.organizationId }
        },
        _sum: {
            freeMonthsEarned: true,
            freeMonthsUsed: true,
            referralCount: true
        }
    });

    // Top referrers
    const topReferrers = await prisma.client.findMany({
        where: {
            orgId: req.user.organizationId,
            isActive: true,
            referredClients: { some: {} }
        },
        select: {
            id: true,
            fullName: true,
            referralCode: true,
            _count: { select: { referredClients: true } }
        },
        orderBy: {
            referredClients: { _count: 'desc' }
        },
        take: 10
    });

    res.status(200).json({
        success: true,
        data: {
            overview: {
                clientsWithCodes,
                referredClients,
                totalReferrals: benefitsAggr._sum.referralCount || 0,
                freeMonthsEarned: benefitsAggr._sum.freeMonthsEarned || 0,
                freeMonthsUsed: benefitsAggr._sum.freeMonthsUsed || 0,
                freeMonthsPending: (benefitsAggr._sum.freeMonthsEarned || 0) - (benefitsAggr._sum.freeMonthsUsed || 0)
            },
            referralSourceBreakdown: referralSourceBreakdown.map(item => ({
                source: item.referralSource,
                count: item._count.id
            })),
            topReferrers: topReferrers.map(client => ({
                id: client.id,
                name: client.fullName,
                code: client.referralCode,
                referralCount: client._count.referredClients
            }))
        }
    });
});

/**
 * Get list of clients referred by a specific client
 */
export const getClientReferrals = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const { page = '1', pageSize = '20' } = req.query;

    // Verify client belongs to org
    const client = await prisma.client.findFirst({
        where: { id: clientId, orgId: req.user.organizationId }
    });

    if (!client) throw AppError.notFound('Client not found');

    const skip = (Number(page) - 1) * Number(pageSize);
    const take = Number(pageSize);

    const [referrals, total] = await prisma.$transaction([
        prisma.client.findMany({
            where: {
                referredByClientId: clientId,
                isActive: true
            },
            select: {
                id: true,
                fullName: true,
                email: true,
                phone: true,
                createdAt: true
            },
            orderBy: { createdAt: 'desc' },
            skip,
            take
        }),
        prisma.client.count({
            where: {
                referredByClientId: clientId,
                isActive: true
            }
        })
    ]);

    // Get referral benefit info
    const benefit = await prisma.referralBenefit.findUnique({
        where: { clientId }
    });

    res.status(200).json({
        success: true,
        data: {
            referrer: {
                id: client.id,
                name: client.fullName,
                referralCode: client.referralCode
            },
            benefit: benefit ? {
                referralCount: benefit.referralCount,
                freeMonthsEarned: benefit.freeMonthsEarned,
                freeMonthsUsed: benefit.freeMonthsUsed,
                freeMonthsRemaining: benefit.freeMonthsEarned - benefit.freeMonthsUsed
            } : null,
            referrals
        },
        meta: {
            page: Number(page),
            pageSize: Number(pageSize),
            total,
            totalPages: Math.ceil(total / Number(pageSize))
        }
    });
});

/**
 * Get all clients with referral tracking info
 */
export const listClientsWithReferrals = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { page = '1', pageSize = '20', source, hasReferrals } = req.query;
    const skip = (Number(page) - 1) * Number(pageSize);
    const take = Number(pageSize);

    const where: any = {
        orgId: req.user.organizationId,
        isActive: true
    };

    if (source) {
        where.referralSource = String(source);
    }

    if (hasReferrals === 'true') {
        where.referredClients = { some: {} };
    }

    const [clients, total] = await prisma.$transaction([
        prisma.client.findMany({
            where,
            select: {
                id: true,
                fullName: true,
                email: true,
                phone: true,
                referralSource: true,
                referralSourceName: true,
                referralCode: true,
                createdAt: true,
                referredByClient: {
                    select: { id: true, fullName: true }
                },
                _count: { select: { referredClients: true } },
                referralBenefit: {
                    select: {
                        referralCount: true,
                        freeMonthsEarned: true,
                        freeMonthsUsed: true
                    }
                }
            },
            orderBy: { createdAt: 'desc' },
            skip,
            take
        }),
        prisma.client.count({ where })
    ]);

    res.status(200).json({
        success: true,
        data: clients.map(client => ({
            id: client.id,
            fullName: client.fullName,
            email: client.email,
            phone: client.phone,
            referralSource: client.referralSource,
            referralSourceName: client.referralSourceName,
            referralCode: client.referralCode,
            referredBy: client.referredByClient,
            referralCount: client._count.referredClients,
            benefit: client.referralBenefit,
            createdAt: client.createdAt
        })),
        meta: {
            page: Number(page),
            pageSize: Number(pageSize),
            total,
            totalPages: Math.ceil(total / Number(pageSize))
        }
    });
});

/**
 * Apply/redeem free month benefit for a client
 */
export const redeemFreeBenefit = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;

    // Verify client belongs to org
    const client = await prisma.client.findFirst({
        where: { id: clientId, orgId: req.user.organizationId }
    });

    if (!client) throw AppError.notFound('Client not found');

    const benefit = await prisma.referralBenefit.findUnique({
        where: { clientId }
    });

    if (!benefit) {
        throw AppError.badRequest('Client has no referral benefits');
    }

    const available = benefit.freeMonthsEarned - benefit.freeMonthsUsed;
    if (available <= 0) {
        throw AppError.badRequest('No free months available to redeem');
    }

    // Increment used count
    const updated = await prisma.referralBenefit.update({
        where: { clientId },
        data: {
            freeMonthsUsed: { increment: 1 }
        }
    });

    logger.info('Free month redeemed', {
        clientId,
        byUserId: req.user.id,
        remaining: updated.freeMonthsEarned - updated.freeMonthsUsed
    });

    res.status(200).json({
        success: true,
        data: {
            redeemed: true,
            freeMonthsEarned: updated.freeMonthsEarned,
            freeMonthsUsed: updated.freeMonthsUsed,
            freeMonthsRemaining: updated.freeMonthsEarned - updated.freeMonthsUsed
        }
    });
});
</file>

<file path="backend/src/controllers/auth.controller.ts">
import { Request, Response } from 'express';
import { clerkClient, getAuth } from '@clerk/express';
import prisma from '../utils/prisma';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import logger from '../utils/logger';

export const register = asyncHandler(async (req: Request, res: Response) => {
    const auth = getAuth(req);
    const clerkUserId = req.body.clerkUserId || auth.userId;

    if (!clerkUserId) {
        throw AppError.badRequest('Clerk user ID is required', 'MISSING_CLERK_USER');
    }

    const { email, fullName, role, orgId, phone, licenseNumber, specialization } = req.body;

    if (!email || !fullName || !role || !orgId) {
        throw AppError.badRequest('email, fullName, role, and orgId are required', 'MISSING_FIELDS');
    }

    try {
        await clerkClient.users.getUser(clerkUserId);
    } catch {
        throw AppError.badRequest('Invalid Clerk user ID', 'INVALID_CLERK_USER');
    }

    const existingUser = await prisma.user.findUnique({ where: { clerkUserId } });
    if (existingUser) {
        throw AppError.conflict('User already registered', 'USER_EXISTS');
    }

    const organization = await prisma.organization.findUnique({ where: { id: orgId } });
    if (!organization) {
        throw AppError.notFound('Organization not found', 'ORG_NOT_FOUND');
    }

    const user = await prisma.user.create({
        data: { clerkUserId, email, fullName, role, orgId, phone, licenseNumber, specialization, lastLoginAt: new Date() }
    });

    logger.info('User registered', { userId: user.id, clerkUserId, orgId });

    res.status(201).json({
        success: true,
        data: { id: user.id, organizationId: user.orgId, role: user.role, email: user.email, fullName: user.fullName, phone: user.phone, profilePhotoUrl: user.profilePhotoUrl, specialization: user.specialization }
    });
});

export const syncUser = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    await prisma.user.update({ where: { id: req.user.id }, data: { lastLoginAt: new Date() } });

    res.status(200).json({ success: true, data: { synced: true } });
});

export const getMe = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user || !req.dbUser) throw AppError.unauthorized();

    const user = req.dbUser;

    res.status(200).json({
        success: true,
        data: {
            id: user.id, organizationId: user.orgId, role: user.role, email: user.email,
            fullName: user.fullName, phone: user.phone, profilePhotoUrl: user.profilePhotoUrl,
            licenseNumber: user.licenseNumber, specialization: user.specialization, bio: user.bio,
            isActive: user.isActive, mfaEnabled: user.mfaEnabled, lastLoginAt: user.lastLoginAt,
            createdAt: user.createdAt, updatedAt: user.updatedAt
        }
    });
});

export const updateMe = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { fullName, phone, specialization, bio } = req.body;

    const updatedUser = await prisma.user.update({
        where: { id: req.user.id },
        data: {
            ...(fullName && { fullName }),
            ...(phone && { phone }),
            ...(specialization && { specialization }),
            ...(bio && { bio })
        }
    });

    logger.info('User profile updated', { userId: updatedUser.id });

    res.status(200).json({
        success: true,
        data: { id: updatedUser.id, fullName: updatedUser.fullName, phone: updatedUser.phone, specialization: updatedUser.specialization, bio: updatedUser.bio, updatedAt: updatedUser.updatedAt }
    });
});
</file>

<file path="backend/src/controllers/compliance.controller.ts">
import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { complianceService } from '../services/compliance.service';

export const getDailyAdherence = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const date = req.query.date ? new Date(req.query.date as string) : new Date();

    const data = await complianceService.calculateDailyAdherence(clientId, date);
    res.status(200).json({ success: true, data });
});

export const getWeeklyAdherence = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const weekStart = req.query.weekStart ? new Date(req.query.weekStart as string) : undefined;

    const data = await complianceService.calculateWeeklyAdherence(clientId, weekStart);
    res.status(200).json({ success: true, data });
});

export const getComplianceHistory = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const days = req.query.days ? parseInt(req.query.days as string) : 30;

    const data = await complianceService.getClientComplianceHistory(clientId, days);
    res.status(200).json({ success: true, data });
});
</file>

<file path="backend/src/controllers/dashboard.controller.ts">
import { Response } from 'express';
import prisma from '../utils/prisma';
import { AuthenticatedRequest } from '../types/auth.types';
import { asyncHandler } from '../utils/asyncHandler';
import { AppError } from '../errors/AppError';

export const getDashboardStats = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const orgId = req.user.organizationId;

    // Get counts
    const [
        totalClients,
        pendingReviews,
        activeDietPlans,
        recentClients,
        pendingMealLogs
    ] = await Promise.all([
        // Total active clients
        prisma.client.count({
            where: { orgId, isActive: true }
        }),
        // Pending meal log reviews
        prisma.mealLog.count({
            where: { orgId, status: 'pending' }
        }),
        // Active (published) diet plans
        prisma.dietPlan.count({
            where: { orgId, status: 'active' }
        }),
        // Recent clients (last 5)
        prisma.client.findMany({
            where: { orgId, isActive: true },
            orderBy: { updatedAt: 'desc' },
            take: 5,
            select: {
                id: true,
                fullName: true,
                updatedAt: true,
                createdAt: true
            }
        }),
        // Pending meal logs with client info
        prisma.mealLog.findMany({
            where: { orgId, status: 'pending' },
            orderBy: { scheduledDate: 'desc' },
            take: 5,
            include: {
                client: { select: { id: true, fullName: true } },
                meal: { select: { id: true, name: true, mealType: true } }
            }
        })
    ]);

    // Calculate average adherence (simplified - from last 30 days)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    const mealLogStats = await prisma.mealLog.groupBy({
        by: ['status'],
        where: {
            orgId,
            scheduledDate: { gte: thirtyDaysAgo }
        },
        _count: true
    });

    const totalMeals = mealLogStats.reduce((acc, s) => acc + s._count, 0);
    const eatenMeals = mealLogStats.find(s => s.status === 'eaten')?._count || 0;
    const adherencePercent = totalMeals > 0 ? Math.round((eatenMeals / totalMeals) * 100) : 0;

    // Weekly adherence breakdown
    const weeklyData: { day: string; value: number }[] = [];
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dayStart = new Date(date.setHours(0, 0, 0, 0));
        const dayEnd = new Date(date.setHours(23, 59, 59, 999));

        const dayMealLogs = await prisma.mealLog.groupBy({
            by: ['status'],
            where: {
                orgId,
                scheduledDate: { gte: dayStart, lte: dayEnd }
            },
            _count: true
        });

        const dayTotal = dayMealLogs.reduce((acc, s) => acc + s._count, 0);
        const dayEaten = dayMealLogs.find(s => s.status === 'eaten')?._count || 0;
        const dayPercent = dayTotal > 0 ? Math.round((dayEaten / dayTotal) * 100) : 0;

        weeklyData.push({
            day: days[dayStart.getDay()],
            value: dayPercent
        });
    }

    res.status(200).json({
        success: true,
        data: {
            stats: {
                totalClients,
                pendingReviews,
                activeDietPlans,
                adherencePercent
            },
            weeklyAdherence: weeklyData,
            recentClients: recentClients.map(c => ({
                id: c.id,
                name: c.fullName,
                avatar: c.fullName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2),
                status: 'active',
                lastActivity: c.updatedAt || c.createdAt
            })),
            pendingReviews: pendingMealLogs.map(m => ({
                id: m.id,
                client: m.client.fullName,
                meal: m.meal?.mealType || 'Meal',
                time: m.scheduledTime
            }))
        }
    });
});
</file>

<file path="backend/src/controllers/notification.controller.ts">
import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { notificationService } from '../services/notification.service';
import prisma from '../utils/prisma';

export const registerToken = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    // Can be called by Client (via some auth?) or User
    // Assuming req.user is populated. If it's a client app, we might need client auth middleware
    // For now, assuming this is for Users (Dietitians). Clients need separate auth flow or use same middleware if unified.

    // Check if it's a client or user. The `AuthenticatedRequest` typically implies User/Dietitian.
    // If we have client auth, we need to handle that.

    if (!req.user) throw AppError.unauthorized();

    const { token } = req.body;
    if (!token) throw AppError.badRequest('Token required', 'TOKEN_REQUIRED');

    // For now, this endpoint assumes it's the logged-in User
    await notificationService.registerDeviceToken(req.user.id, 'user', token);

    res.status(200).json({ success: true, message: 'Token registered' });
});

// Endpoint for Clients to register (if we expose it publicly or via client-auth)
export const registerClientToken = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    // Identify client from param or auth.
    // Ensure safety.
    const { clientId } = req.params;
    const { token } = req.body;

    // Check permissions (User allowed to update Client?)
    // Realistically, the CLIENT App calls this. But currently we use Clerk for Users.
    // If Client App uses Clerk, they have a User ID.
    // I'll skip this implementation detail and assume 'registerToken' is enough for now or I handle client mapping.

    res.status(501).json({ message: 'Not implemented for Clients yet' });
});


export const listNotifications = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { page = '1', pageSize = '20' } = req.query;
    const skip = (Number(page) - 1) * Number(pageSize);

    const [notifications, total] = await prisma.$transaction([
        prisma.notification.findMany({
            where: { recipientId: req.user.id, orgId: req.user.organizationId },
            orderBy: { createdAt: 'desc' },
            skip,
            take: Number(pageSize)
        }),
        prisma.notification.count({ where: { recipientId: req.user.id, orgId: req.user.organizationId } })
    ]);

    res.status(200).json({
        success: true,
        data: notifications,
        meta: { page: Number(page), pageSize: Number(pageSize), total }
    });
});

export const markRead = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { id } = req.params;

    await prisma.notification.updateMany({
        where: { id, recipientId: req.user.id },
        data: { isRead: true, readAt: new Date() }
    });

    res.status(200).json({ success: true });
});
</file>

<file path="backend/src/controllers/organization.controller.ts">
import { Response } from 'express';
import prisma from '../utils/prisma';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import logger from '../utils/logger';
import { CreateOrganizationInput } from '../schemas/organization.schema';

export const createOrganization = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    const data: CreateOrganizationInput = req.body;

    const existingOrg = await prisma.organization.findUnique({
        where: { name: data.name }
    });

    if (existingOrg) {
        throw AppError.conflict('Organization name already taken', 'ORG_EXISTS');
    }

    const organization = await prisma.organization.create({
        data: {
            name: data.name,
            description: data.description,
            email: data.email,
            phone: data.phone,
            address: data.address,
            city: data.city,
            country: data.country || 'IN',
            timezone: data.timezone || 'Asia/Kolkata'
        }
    });

    logger.info('Organization created', { orgId: organization.id, name: organization.name });

    res.status(201).json({
        success: true,
        data: organization
    });
});

export const getOrganization = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) {
        throw AppError.unauthorized();
    }

    const organization = await prisma.organization.findUnique({
        where: { id: req.user.organizationId },
        include: {
            _count: {
                select: { clients: true, users: true }
            }
        }
    });

    if (!organization) {
        throw AppError.notFound('Organization not found', 'ORG_NOT_FOUND');
    }

    res.status(200).json({
        success: true,
        data: {
            ...organization,
            currentClientCount: organization._count.clients,
            currentUserCount: organization._count.users
        }
    });
});
</file>

<file path="backend/src/controllers/referral.controller.ts">
import { Response } from 'express';
import prisma from '../utils/prisma';
import { ClientAuthRequest } from '../middleware/clientAuth.middleware';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import logger from '../utils/logger';
import crypto from 'crypto';

/**
 * Generate a unique referral code for the client
 * Format: 6 alphanumeric characters, uppercase
 */
function generateReferralCode(): string {
    return crypto.randomBytes(3).toString('hex').toUpperCase();
}

/**
 * Get or generate referral code for the authenticated client
 */
export const getReferralCode = asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    let client = await prisma.client.findUnique({
        where: { id: req.client.id },
        select: { id: true, referralCode: true, fullName: true }
    });

    if (!client) throw AppError.notFound('Client not found');

    // Generate referral code if not exists
    if (!client.referralCode) {
        let code = generateReferralCode();
        let attempts = 0;

        // Ensure uniqueness
        while (attempts < 10) {
            const existing = await prisma.client.findUnique({
                where: { referralCode: code }
            });
            if (!existing) break;
            code = generateReferralCode();
            attempts++;
        }

        client = await prisma.client.update({
            where: { id: req.client.id },
            data: { referralCode: code },
            select: { id: true, referralCode: true, fullName: true }
        });

        logger.info('Referral code generated', { clientId: req.client.id, code });
    }

    // Generate share message
    const shareMessage = `Hey! I'm using DietKaro for my nutrition journey and it's been amazing! 🥗\n\nUse my referral code: ${client.referralCode}\n\nDownload the app and start your health journey today!`;

    res.status(200).json({
        success: true,
        data: {
            referralCode: client.referralCode,
            shareMessage,
            whatsappLink: `https://wa.me/?text=${encodeURIComponent(shareMessage)}`
        }
    });
});

/**
 * Get referral statistics and benefits for the authenticated client
 */
export const getReferralStats = asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    // Get count of clients referred by this client
    const referredClientsCount = await prisma.client.count({
        where: { referredByClientId: req.client.id, isActive: true }
    });

    // Get or create referral benefit record
    let benefit = await prisma.referralBenefit.findUnique({
        where: { clientId: req.client.id }
    });

    if (!benefit) {
        benefit = await prisma.referralBenefit.create({
            data: {
                clientId: req.client.id,
                referralCount: referredClientsCount,
                freeMonthsEarned: Math.floor(referredClientsCount / 3), // 3 referrals = 1 free month
                freeMonthsUsed: 0
            }
        });
    } else if (benefit.referralCount !== referredClientsCount) {
        // Update if count changed
        benefit = await prisma.referralBenefit.update({
            where: { clientId: req.client.id },
            data: {
                referralCount: referredClientsCount,
                freeMonthsEarned: Math.floor(referredClientsCount / 3)
            }
        });
    }

    // Get list of referred clients (limited info)
    const referredClients = await prisma.client.findMany({
        where: { referredByClientId: req.client.id, isActive: true },
        select: {
            id: true,
            fullName: true,
            createdAt: true
        },
        orderBy: { createdAt: 'desc' },
        take: 10
    });

    res.status(200).json({
        success: true,
        data: {
            referralCount: referredClientsCount,
            freeMonthsEarned: benefit.freeMonthsEarned,
            freeMonthsUsed: benefit.freeMonthsUsed,
            freeMonthsRemaining: benefit.freeMonthsEarned - benefit.freeMonthsUsed,
            referralsUntilNextReward: 3 - (referredClientsCount % 3),
            referredClients: referredClients.map(c => ({
                name: c.fullName,
                joinedAt: c.createdAt
            }))
        }
    });
});

/**
 * Validate a referral code (for client onboarding)
 */
export const validateReferralCode = asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    const { code } = req.params;

    if (!code || code.length !== 6) {
        throw AppError.badRequest('Invalid referral code format');
    }

    const referrer = await prisma.client.findUnique({
        where: { referralCode: code.toUpperCase() },
        select: { id: true, fullName: true }
    });

    if (!referrer) {
        res.status(200).json({
            success: true,
            data: { valid: false }
        });
        return;
    }

    res.status(200).json({
        success: true,
        data: {
            valid: true,
            referrerName: referrer.fullName
        }
    });
});
</file>

<file path="backend/src/controllers/reports.controller.ts">
import { Response } from 'express';
import prisma from '../utils/prisma';
import { ClientAuthRequest } from '../middleware/clientAuth.middleware';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import logger from '../utils/logger';
import { S3Client, PutObjectCommand, DeleteObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';

// Initialize S3 client
const s3Client = new S3Client({
    region: process.env.AWS_REGION || 'ap-south-1',
    credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID || '',
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || '',
    },
});

const BUCKET_NAME = process.env.AWS_S3_BUCKET || 'dietconnect-uploads';

/**
 * Get list of reports for the authenticated client
 */
export const listReports = asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const { reportType, limit = '20' } = req.query;

    const where: any = {
        clientId: req.client.id
    };

    if (reportType) {
        where.reportType = String(reportType);
    }

    const reports = await prisma.clientReport.findMany({
        where,
        orderBy: { uploadedAt: 'desc' },
        take: Number(limit)
    });

    res.status(200).json({
        success: true,
        data: reports
    });
});

/**
 * Get presigned URL for uploading a report
 */
export const getUploadUrl = asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const { fileName, fileType, reportType } = req.body;

    if (!fileName || !fileType) {
        throw AppError.badRequest('fileName and fileType are required');
    }

    // Validate file type
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(fileType)) {
        throw AppError.badRequest('Invalid file type. Allowed: PDF, JPEG, PNG, WEBP');
    }

    // Generate unique key for S3
    const timestamp = Date.now();
    const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9.-]/g, '_');
    const key = `reports/${req.client.orgId}/${req.client.id}/${timestamp}-${sanitizedFileName}`;

    // Generate presigned URL for upload
    const command = new PutObjectCommand({
        Bucket: BUCKET_NAME,
        Key: key,
        ContentType: fileType,
    });

    const uploadUrl = await getSignedUrl(s3Client, command, { expiresIn: 3600 }); // 1 hour

    res.status(200).json({
        success: true,
        data: {
            uploadUrl,
            key,
            fileName,
            fileType,
            reportType
        }
    });
});

/**
 * Confirm upload and save report metadata
 */
export const createReport = asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const { key, fileName, fileType, reportType, notes } = req.body;

    if (!key || !fileName || !fileType) {
        throw AppError.badRequest('key, fileName, and fileType are required');
    }

    // Construct the file URL
    const fileUrl = `https://${BUCKET_NAME}.s3.${process.env.AWS_REGION || 'ap-south-1'}.amazonaws.com/${key}`;

    // Create report record
    const report = await prisma.clientReport.create({
        data: {
            orgId: req.client.orgId,
            clientId: req.client.id,
            fileName,
            fileUrl,
            fileType: fileType.startsWith('image/') ? 'image' : 'pdf',
            reportType: reportType || 'other',
            notes
        }
    });

    logger.info('Client report uploaded', {
        clientId: req.client.id,
        reportId: report.id,
        reportType
    });

    res.status(201).json({
        success: true,
        data: report
    });
});

/**
 * Delete a report
 */
export const deleteReport = asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const { id } = req.params;

    const report = await prisma.clientReport.findFirst({
        where: { id, clientId: req.client.id }
    });

    if (!report) {
        throw AppError.notFound('Report not found');
    }

    // Extract key from URL for S3 deletion
    const urlParts = report.fileUrl.split('.amazonaws.com/');
    if (urlParts.length === 2) {
        const key = urlParts[1];
        try {
            await s3Client.send(new DeleteObjectCommand({
                Bucket: BUCKET_NAME,
                Key: key
            }));
        } catch (error) {
            logger.warn('Failed to delete S3 object', { key, error });
        }
    }

    // Delete database record
    await prisma.clientReport.delete({
        where: { id }
    });

    logger.info('Client report deleted', { clientId: req.client.id, reportId: id });

    res.status(204).send();
});
</file>

<file path="backend/src/controllers/share.controller.ts">
import { Response } from 'express';
import prisma from '../utils/prisma';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import logger from '../utils/logger';
import { generateDietPlanPDF, generateMealPlanPrintHtml } from '../utils/pdfGenerator';
import { sendEmail, generateDietPlanEmailHtml } from '../utils/emailService';

/**
 * Generate and download PDF for a diet plan
 */
export const downloadDietPlanPdf = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { id } = req.params;

    const plan = await prisma.dietPlan.findFirst({
        where: { id, orgId: req.user.organizationId, isActive: true },
        include: {
            client: {
                select: { fullName: true, currentWeightKg: true, targetWeightKg: true }
            },
            meals: {
                orderBy: [{ dayOfWeek: 'asc' }, { sequenceNumber: 'asc' }],
                include: {
                    foodItems: {
                        orderBy: [{ optionGroup: 'asc' }, { sortOrder: 'asc' }],
                        include: { foodItem: true }
                    }
                }
            }
        }
    });

    if (!plan) throw AppError.notFound('Diet plan not found');

    // Generate PDF
    const doc = generateDietPlanPDF(plan);

    // Set response headers for PDF download
    const filename = `diet-plan-${plan.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.pdf`;
    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);

    // Pipe PDF to response
    doc.pipe(res);
    doc.end();

    logger.info('Diet plan PDF generated', { planId: id, userId: req.user.id });
});

/**
 * Get print-friendly HTML view of diet plan
 */
export const getDietPlanPrintView = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { id } = req.params;

    const plan = await prisma.dietPlan.findFirst({
        where: { id, orgId: req.user.organizationId, isActive: true },
        include: {
            client: {
                select: { fullName: true, currentWeightKg: true, targetWeightKg: true }
            },
            meals: {
                orderBy: [{ dayOfWeek: 'asc' }, { sequenceNumber: 'asc' }],
                include: {
                    foodItems: {
                        orderBy: [{ optionGroup: 'asc' }, { sortOrder: 'asc' }],
                        include: { foodItem: true }
                    }
                }
            }
        }
    });

    if (!plan) throw AppError.notFound('Diet plan not found');

    const html = generateMealPlanPrintHtml(plan);

    res.setHeader('Content-Type', 'text/html');
    res.send(html);

    logger.info('Diet plan print view generated', { planId: id, userId: req.user.id });
});

/**
 * Send diet plan via email to client
 */
export const emailDietPlan = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { id } = req.params;
    const { recipientEmail, customMessage } = req.body;

    const plan = await prisma.dietPlan.findFirst({
        where: { id, orgId: req.user.organizationId, isActive: true },
        include: {
            client: {
                select: {
                    fullName: true,
                    email: true,
                    currentWeightKg: true,
                    targetWeightKg: true
                }
            },
            creator: {
                select: { fullName: true }
            },
            meals: {
                orderBy: [{ dayOfWeek: 'asc' }, { sequenceNumber: 'asc' }],
                include: {
                    foodItems: {
                        orderBy: [{ optionGroup: 'asc' }, { sortOrder: 'asc' }],
                        include: { foodItem: true }
                    }
                }
            }
        }
    });

    if (!plan) throw AppError.notFound('Diet plan not found');

    // Use provided email or client's email
    const targetEmail = recipientEmail || plan.client?.email;
    if (!targetEmail) {
        throw AppError.badRequest('No email address provided or client has no email');
    }

    // Generate PDF as buffer
    const doc = generateDietPlanPDF(plan);
    const chunks: Buffer[] = [];

    await new Promise<void>((resolve, reject) => {
        doc.on('data', (chunk: Buffer) => chunks.push(chunk));
        doc.on('end', () => resolve());
        doc.on('error', reject);
        doc.end();
    });

    const pdfBuffer = Buffer.concat(chunks);

    // Generate email HTML
    const html = generateDietPlanEmailHtml(
        plan.name,
        plan.client?.fullName || 'Client',
        plan.creator?.fullName || 'Your Dietitian'
    );

    // Send email with PDF attachment
    const sent = await sendEmail({
        to: targetEmail,
        subject: `Your Diet Plan: ${plan.name}`,
        html: customMessage
            ? `<p>${customMessage}</p>${html}`
            : html,
        attachments: [
            {
                filename: `${plan.name.replace(/[^a-z0-9]/gi, '-')}.pdf`,
                content: pdfBuffer,
                contentType: 'application/pdf'
            }
        ]
    });

    if (!sent) {
        throw AppError.internal('Failed to send email');
    }

    logger.info('Diet plan emailed', { planId: id, to: targetEmail, userId: req.user.id });

    res.status(200).json({
        success: true,
        data: {
            sent: true,
            recipient: targetEmail
        }
    });
});

/**
 * Generate shareable WhatsApp link for diet plan
 */
export const getDietPlanShareLink = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { id } = req.params;

    const plan = await prisma.dietPlan.findFirst({
        where: { id, orgId: req.user.organizationId, isActive: true },
        include: {
            client: { select: { fullName: true, phone: true } }
        }
    });

    if (!plan) throw AppError.notFound('Diet plan not found');

    // Generate summary message for WhatsApp
    const message = `🥗 *${plan.name}*

Hi ${plan.client?.fullName || 'there'}!

Your personalized diet plan is ready. 

📊 Daily Targets:
${plan.targetCalories ? `• Calories: ${plan.targetCalories} kcal` : ''}
${plan.targetProteinG ? `• Protein: ${plan.targetProteinG}g` : ''}
${plan.targetCarbsG ? `• Carbs: ${plan.targetCarbsG}g` : ''}
${plan.targetFatsG ? `• Fats: ${plan.targetFatsG}g` : ''}

📱 Open the DietKaro app to view your complete meal plan!

Best regards,
Your Dietitian at DietKaro`;

    const whatsappLink = `https://wa.me/${plan.client?.phone?.replace(/[^0-9]/g, '') || ''}?text=${encodeURIComponent(message)}`;

    res.status(200).json({
        success: true,
        data: {
            message,
            whatsappLink,
            clientPhone: plan.client?.phone
        }
    });
});
</file>

<file path="backend/src/controllers/team.controller.ts">
import { Response } from 'express';
import prisma from '../utils/prisma';
import { AuthenticatedRequest } from '../types/auth.types';
import { asyncHandler } from '../utils/asyncHandler';
import { AppError } from '../errors/AppError';
import { clerkClient, getAuth } from '@clerk/express';

export const listTeamMembers = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const orgId = req.user.organizationId;

    const members = await prisma.user.findMany({
        where: { orgId, isActive: true },
        select: {
            id: true,
            fullName: true,
            email: true,
            phone: true,
            role: true,
            specialization: true,
            profilePhotoUrl: true,
            createdAt: true,
        },
        orderBy: { fullName: 'asc' }
    });

    // Get client counts separately
    const clientCounts = await prisma.client.groupBy({
        by: ['primaryDietitianId'],
        where: { orgId, isActive: true },
        _count: true
    });

    const countMap = new Map(clientCounts.map(c => [c.primaryDietitianId, c._count]));

    res.status(200).json({
        success: true,
        data: members.map(m => ({
            id: m.id,
            name: m.fullName,
            email: m.email,
            phone: m.phone,
            role: m.role,
            specialization: m.specialization,
            profilePhotoUrl: m.profilePhotoUrl,
            clientCount: countMap.get(m.id) || 0,
            avatar: m.fullName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)
        }))
    });
});

export const inviteMember = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    const { email, role } = req.body;

    if (!req.user) throw AppError.unauthorized();
    const orgId = req.user.organizationId;

    // Check if user already exists
    const existingUser = await prisma.user.findFirst({ where: { email } });
    if (existingUser) {
        throw AppError.conflict('User with this email already exists', 'USER_EXISTS');
    }

    // Generate token
    const token = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    const expiresAt = new Date();
    expiresAt.setDate(expiresAt.getDate() + 7); // 7 days expiry

    const invitation = await prisma.invitation.create({
        data: {
            email,
            role,
            orgId,
            token,
            expiresAt,
            status: 'pending'
        }
    });

    const inviteLink = `${process.env.FRONTEND_URL || 'http://localhost:3000'}/join?token=${token}`;

    console.log(`[Team] Invitation created for ${email}. Link: ${inviteLink}`);

    res.status(200).json({
        success: true,
        message: 'Invitation link generated',
        data: {
            inviteLink,
            invitation
        }
    });
});

export const validateInvite = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    const { token } = req.params;

    const invitation = await prisma.invitation.findUnique({
        where: { token },
        include: { organization: true }
    });

    if (!invitation || invitation.status !== 'pending' || invitation.expiresAt < new Date()) {
        throw AppError.badRequest('Invalid or expired invitation', 'INVALID_INVITE');
    }

    res.status(200).json({
        success: true,
        data: {
            email: invitation.email,
            orgName: invitation.organization.name,
            role: invitation.role
        }
    });
});

export const acceptInvite = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    const { token } = req.body;

    // Manual Auth Check since we removed requireAuth middleware
    // This allows us to handle users who exist in Clerk but not yet in our DB
    const auth = getAuth(req);
    if (!auth.userId) {
        throw AppError.unauthorized();
    }
    const clerkUserId = auth.userId;

    // 1. Validate Invitation
    const invitation = await prisma.invitation.findUnique({ where: { token } });

    if (!invitation || invitation.status !== 'pending' || invitation.expiresAt < new Date()) {
        throw AppError.badRequest('Invalid or expired invitation', 'INVALID_INVITE');
    }

    // 2. Check if DB User exists
    const dbUser = await prisma.user.findUnique({ where: { clerkUserId } });

    if (dbUser) {
        // User exists -> Update Org/Role
        // Optional: Check if email matches invitation.email
        await prisma.$transaction([
            prisma.user.update({
                where: { id: dbUser.id },
                data: {
                    orgId: invitation.orgId,
                    role: invitation.role,
                    isActive: true
                }
            }),
            prisma.invitation.update({
                where: { id: invitation.id },
                data: { status: 'accepted' }
            })
        ]);
    } else {
        // User DOES NOT exist -> Create new User
        // Fetch Clerk Name + Email 
        const clerkUser = await clerkClient.users.getUser(clerkUserId);
        const email = clerkUser.emailAddresses[0]?.emailAddress;

        if (!email) throw AppError.badRequest('Clerk user has no email', 'NO_EMAIL');
        // if (email !== invitation.email) throw AppError.forbidden('Invite email does not match logged in user');

        const fullName = `${clerkUser.firstName || ''} ${clerkUser.lastName || ''}`.trim() || 'Team Member';

        await prisma.$transaction([
            prisma.user.create({
                data: {
                    clerkUserId,
                    email,
                    fullName,
                    role: invitation.role,
                    orgId: invitation.orgId,
                    isActive: true
                }
            }),
            prisma.invitation.update({
                where: { id: invitation.id },
                data: { status: 'accepted' }
            })
        ]);
    }

    res.status(200).json({
        success: true,
        message: 'Joined organization successfully'
    });
});
</file>

<file path="backend/src/controllers/validation.controller.ts">
/**
 * Validation Controller
 * Handles diet validation API endpoints
 */

import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { validationEngine } from '../services/validationEngine.service';
import logger from '../utils/logger';

/**
 * POST /api/v1/diet-validation/check
 * Validate a single food item against client restrictions
 */
export const checkValidation = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId, foodId, context } = req.body;

    if (!clientId || !foodId) {
        throw AppError.badRequest('clientId and foodId are required');
    }

    if (!context?.currentDay || !context?.mealType) {
        throw AppError.badRequest('context.currentDay and context.mealType are required');
    }

    const startTime = Date.now();

    const result = await validationEngine.validate(clientId, foodId, context);

    logger.debug('Validation check completed', {
        clientId,
        foodId,
        severity: result.severity,
        processingTimeMs: Date.now() - startTime
    });

    res.status(200).json({
        success: true,
        data: result
    });
});

/**
 * POST /api/v1/diet-validation/batch
 * Validate multiple food items against client restrictions
 */
export const checkBatchValidation = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId, foodIds, context } = req.body;

    if (!clientId || !foodIds || !Array.isArray(foodIds)) {
        throw AppError.badRequest('clientId and foodIds array are required');
    }

    if (!context?.currentDay || !context?.mealType) {
        throw AppError.badRequest('context.currentDay and context.mealType are required');
    }

    if (foodIds.length > 50) {
        throw AppError.badRequest('Maximum 50 foods per batch');
    }

    const result = await validationEngine.validateBatch(clientId, foodIds, context);

    logger.debug('Batch validation completed', {
        clientId,
        foodCount: foodIds.length,
        processingTimeMs: result.processingTimeMs
    });

    res.status(200).json({
        success: true,
        data: result
    });
});

/**
 * POST /api/v1/diet-validation/invalidate-cache
 * Invalidate client cache (call when client tags are updated)
 */
export const invalidateCache = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.body;

    if (clientId) {
        validationEngine.invalidateClientCache(clientId);
        logger.info('Client validation cache invalidated', { clientId });
    } else {
        validationEngine.clearCache();
        logger.info('Entire validation cache cleared');
    }

    res.status(200).json({
        success: true,
        message: clientId ? `Cache invalidated for client ${clientId}` : 'Entire cache cleared'
    });
});
</file>

<file path="backend/src/errors/AppError.ts">
/**
 * Custom application error class for operational errors
 */
export class AppError extends Error {
    public readonly statusCode: number;
    public readonly code: string;
    public readonly isOperational: boolean;
    public readonly details?: unknown;

    constructor(
        message: string,
        statusCode: number = 500,
        code: string = 'INTERNAL_ERROR',
        isOperational: boolean = true,
        details?: unknown
    ) {
        super(message);
        this.statusCode = statusCode;
        this.code = code;
        this.isOperational = isOperational;
        this.details = details;

        Object.setPrototypeOf(this, AppError.prototype);
        Error.captureStackTrace(this, this.constructor);
    }

    // Common error factories
    static badRequest(message: string, code: string = 'BAD_REQUEST', details?: unknown) {
        return new AppError(message, 400, code, true, details);
    }

    static unauthorized(message: string = 'Authentication required', code: string = 'UNAUTHORIZED') {
        return new AppError(message, 401, code);
    }

    static forbidden(message: string = 'Access denied', code: string = 'FORBIDDEN') {
        return new AppError(message, 403, code);
    }

    static notFound(message: string = 'Resource not found', code: string = 'NOT_FOUND') {
        return new AppError(message, 404, code);
    }

    static conflict(message: string, code: string = 'CONFLICT') {
        return new AppError(message, 409, code);
    }

    static internal(message: string = 'Internal server error', code: string = 'INTERNAL_ERROR') {
        return new AppError(message, 500, code, false);
    }

    static validation(message: string, details?: unknown) {
        return new AppError(message, 400, 'VALIDATION_ERROR', true, details);
    }
}
</file>

<file path="backend/src/middleware/auth.middleware.ts">
import { Response, NextFunction } from 'express';
import { clerkClient, getAuth } from '@clerk/express';
import prisma from '../utils/prisma';
import { AuthenticatedRequest } from '../types/auth.types';

/**
 * Middleware to require authentication.
 * Uses Clerk's getAuth() to verify the session token.
 */
export const requireAuth = async (
    req: AuthenticatedRequest,
    res: Response,
    next: NextFunction
) => {
    try {
        // Get auth info from Clerk
        const auth = getAuth(req);

        if (!auth.userId) {
            return res.status(401).json({
                   success: false,
                error: {
                    code: 'UNAUTHORIZED',
                    message: 'Authentication required'
                }
            });
        }

        // Find user in our database by clerkUserId
        const dbUser = await prisma.user.findUnique({
            where: { clerkUserId: auth.userId },
            include: { organization: true }
        });

        if (!dbUser) {
            return res.status(401).json({
                success: false,
                error: {
                    code: 'USER_NOT_REGISTERED',
                    message: 'User not registered in the system. Please complete registration first.'
                }
            });
        }

        if (!dbUser.isActive) {
            return res.status(403).json({
                success: false,
                error: {
                    code: 'USER_INACTIVE',
                    message: 'User account is inactive'
                }
            });
        }

        // Attach user info to request
        req.user = {
            id: dbUser.id,
            clerkUserId: dbUser.clerkUserId!,
            organizationId: dbUser.orgId,
            role: dbUser.role,
            email: dbUser.email,
            fullName: dbUser.fullName
        };
        req.dbUser = dbUser;

        next();
    } catch (error) {
        console.error('Auth middleware error:', error);
        return res.status(401).json({
            success: false,
            error: {
                code: 'AUTH_ERROR',
                message: 'Authentication failed'
            }
        });
    }
};

/**
 * Role-based authorization middleware.
 * Must be used after requireAuth.
 */
export const requireRole = (...allowedRoles: string[]) => {
    return (req: AuthenticatedRequest, res: Response, next: NextFunction) => {
        if (!req.user) {
            return res.status(401).json({
                success: false,
                error: {
                    code: 'UNAUTHORIZED',
                    message: 'Authentication required'
                }
            });
        }

        if (!allowedRoles.includes(req.user.role)) {
            return res.status(403).json({
                success: false,
                error: {
                    code: 'FORBIDDEN',
                    message: 'You do not have permission to perform this action'
                }
            });
        }

        next();
    };
};
</file>

<file path="backend/src/middleware/clientAuth.middleware.ts">
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import prisma from '../utils/prisma';

export interface ClientAuthRequest extends Request {
    client?: {
        id: string;
        fullName: string;
        phone: string;
        email: string;
        orgId: string;
    };
}

const JWT_SECRET = process.env.CLIENT_JWT_SECRET || 'client-secret-change-in-production';

export const requireClientAuth = async (
    req: ClientAuthRequest,
    res: Response,
    next: NextFunction
) => {
    try {
        const authHeader = req.headers.authorization;
        if (!authHeader?.startsWith('Bearer ')) {
            return res.status(401).json({
                success: false,
                error: { code: 'UNAUTHORIZED', message: 'No token provided' },
            });
        }

        const token = authHeader.split(' ')[1];
        const decoded = jwt.verify(token, JWT_SECRET) as { clientId: string };

        const client = await prisma.client.findUnique({
            where: { id: decoded.clientId },
            select: {
                id: true,
                fullName: true,
                phone: true,
                email: true,
                orgId: true,
                isActive: true,
            },
        });

        if (!client || !client.isActive) {
            return res.status(401).json({
                success: false,
                error: { code: 'UNAUTHORIZED', message: 'Invalid or inactive client' },
            });
        }

        req.client = {
            id: client.id,
            fullName: client.fullName,
            phone: client.phone,
            email: client.email,
            orgId: client.orgId,
        };

        next();
    } catch (error) {
        return res.status(401).json({
            success: false,
            error: { code: 'UNAUTHORIZED', message: 'Invalid token' },
        });
    }
};

export const signClientToken = (clientId: string): string => {
    return jwt.sign({ clientId }, JWT_SECRET, { expiresIn: '30d' });
};
</file>

<file path="backend/src/middleware/errorHandler.ts">
import { Request, Response, NextFunction, ErrorRequestHandler } from 'express';
import { AppError } from '../errors/AppError';
import logger from '../utils/logger';
import { ZodError } from 'zod';
import { Prisma } from '@prisma/client';

/**
 * Global error handler middleware
 * Catches all errors and formats consistent responses
 */
export const errorHandler: ErrorRequestHandler = (
    err: Error,
    req: Request,
    res: Response,
    next: NextFunction
) => {
    // Log the error
    logger.error('Error caught by global handler', {
        error: err.message,
        stack: err.stack,
        path: req.path,
        method: req.method,
        body: req.body
    });

    // Handle Zod validation errors
    if (err instanceof ZodError) {
        return res.status(400).json({
            success: false,
            error: {
                code: 'VALIDATION_ERROR',
                message: 'Validation failed',
                details: err.issues.map((e: any) => ({
                    field: e.path.join('.'),
                    message: e.message
                }))
            }
        });
    }

    // Handle Prisma errors
    if (err instanceof Prisma.PrismaClientKnownRequestError) {
        if (err.code === 'P2002') {
            return res.status(409).json({
                success: false,
                error: {
                    code: 'CONFLICT',
                    message: 'A record with this value already exists'
                }
            });
        }
        if (err.code === 'P2025') {
            return res.status(404).json({
                success: false,
                error: {
                    code: 'NOT_FOUND',
                    message: 'Record not found'
                }
            });
        }
    }

    // Handle AppError (operational errors)
    if (err instanceof AppError) {
        const errorResponse: any = {
            code: err.code,
            message: err.message
        };
        if (err.details) {
            errorResponse.details = err.details;
        }
        return res.status(err.statusCode).json({
            success: false,
            error: errorResponse
        });
    }

    // Handle unknown errors (programming errors)
    const statusCode = 500;
    const message = process.env.NODE_ENV === 'production'
        ? 'Internal server error'
        : err.message;

    return res.status(statusCode).json({
        success: false,
        error: {
            code: 'INTERNAL_ERROR',
            message,
            ...(process.env.NODE_ENV !== 'production' ? { stack: err.stack } : {})
        }
    });
};

/**
 * 404 handler for undefined routes
 */
export const notFoundHandler = (req: Request, res: Response) => {
    res.status(404).json({
        success: false,
        error: {
            code: 'NOT_FOUND',
            message: `Route ${req.method} ${req.path} not found`
        }
    });
};
</file>

<file path="backend/src/middleware/testAuth.middleware.ts">
import { Response, NextFunction } from 'express';
import prisma from '../utils/prisma';
import { AuthenticatedRequest } from '../types/auth.types';

/**
 * TEST-ONLY middleware that bypasses Clerk auth for development testing.
 * Use X-Test-User-Id header to simulate an authenticated user.
 * 
 * DO NOT USE IN PRODUCTION!
 */
export const testAuthBypass = async (
    req: AuthenticatedRequest,
    res: Response,
    next: NextFunction
) => {
    try {
        const testUserId = req.headers['x-test-user-id'] as string;

        if (!testUserId) {
            return res.status(401).json({
                success: false,
                error: {
                    code: 'UNAUTHORIZED',
                    message: 'X-Test-User-Id header required for testing'
                }
            });
        }

        const dbUser = await prisma.user.findUnique({
            where: { id: testUserId },
            include: { organization: true }
        });

        if (!dbUser) {
            return res.status(401).json({
                success: false,
                error: {
                    code: 'USER_NOT_FOUND',
                    message: 'Test user not found'
                }
            });
        }

        req.user = {
            id: dbUser.id,
            clerkUserId: dbUser.clerkUserId || 'test-clerk-id',
            organizationId: dbUser.orgId,
            role: dbUser.role,
            email: dbUser.email,
            fullName: dbUser.fullName
        };
        req.dbUser = dbUser;

        next();
    } catch (error) {
        console.error('Test auth error:', error);
        return res.status(500).json({
            success: false,
            error: { code: 'INTERNAL_ERROR', message: 'Test auth failed' }
        });
    }
};
</file>

<file path="backend/src/middleware/upload.middleware.ts">
import multer from 'multer';
import { Request } from 'express';
import { AppError } from '../errors/AppError';

// Memory storage for processing before S3 upload
const storage = multer.memoryStorage();

// File filter for images only
const imageFilter = (req: Request, file: Express.Multer.File, cb: multer.FileFilterCallback) => {
    const allowedMimes = ['image/jpeg', 'image/png', 'image/webp', 'image/heic', 'image/heif'];

    if (allowedMimes.includes(file.mimetype)) {
        cb(null, true);
    } else {
        cb(new AppError('Only image files are allowed (JPEG, PNG, WebP, HEIC)', 400, 'INVALID_FILE_TYPE'));
    }
};

// Multer configuration
export const upload = multer({
    storage,
    fileFilter: imageFilter,
    limits: {
        fileSize: 10 * 1024 * 1024, // 10MB max
        files: 1
    }
});

// Single photo upload middleware
export const uploadSinglePhoto = upload.single('photo');

export default upload;
</file>

<file path="backend/src/middleware/validation.middleware.ts">
import { Request, Response, NextFunction } from 'express';
import { ZodSchema, ZodError } from 'zod';

/**
 * Validation middleware factory
 * Validates request body, query, and params against Zod schemas
 */
export const validate = (schema: ZodSchema) => {
    return async (req: Request, res: Response, next: NextFunction) => {
        try {
            await schema.parseAsync({
                body: req.body,
                query: req.query,
                params: req.params
            });
            next();
        } catch (error) {
            if (error instanceof ZodError) {
                return res.status(400).json({
                    success: false,
                    error: {
                        code: 'VALIDATION_ERROR',
                        message: 'Validation failed',
                        details: error.issues.map((e: any) => ({
                            field: e.path.slice(1).join('.'),
                            message: e.message
                        }))
                    }
                });
            }
            next(error);
        }
    };
};

/**
 * Validate only request body
 */
export const validateBody = (schema: ZodSchema) => {
    return async (req: Request, res: Response, next: NextFunction) => {
        try {
            req.body = await schema.parseAsync(req.body);
            next();
        } catch (error) {
            if (error instanceof ZodError) {
                return res.status(400).json({
                    success: false,
                    error: {
                        code: 'VALIDATION_ERROR',
                        message: 'Validation failed',
                        details: error.issues.map((e: any) => ({
                            field: e.path.join('.'),
                            message: e.message
                        }))
                    }
                });
            }
            next(error);
        }
    };
};
</file>

<file path="backend/src/routes/adminReferral.routes.ts">
import { Router } from 'express';
import { requireAuth } from '../middleware/auth.middleware';
import {
    getOrgReferralStats,
    getClientReferrals,
    listClientsWithReferrals,
    redeemFreeBenefit,
} from '../controllers/adminReferral.controller';

const router = Router();

// All routes require authentication
router.use(requireAuth);

// Get overall referral statistics for the org
router.get('/stats', getOrgReferralStats);

// Get list of clients with their referral info
router.get('/clients', listClientsWithReferrals);

// Get referrals made by a specific client
router.get('/clients/:clientId/referrals', getClientReferrals);

// Redeem a free month for a client
router.post('/clients/:clientId/redeem', redeemFreeBenefit);

export default router;
</file>

<file path="backend/src/routes/auth.routes.ts">
import { Router } from 'express';
import { register, syncUser, getMe, updateMe } from '../controllers/auth.controller';
import { requireAuth } from '../middleware/auth.middleware';

const router = Router();

// Public route - called after Clerk signup
router.post('/register', register);

// Protected routes - require valid Clerk token
router.post('/sync', requireAuth, syncUser);
router.get('/me', requireAuth, getMe);
router.patch('/me', requireAuth, updateMe);

export default router;
</file>

<file path="backend/src/routes/clientAuth.routes.ts">
import { Router } from 'express';
import { requestOTP, verifyOTP, getClientProfile, updateClientProfile } from '../controllers/clientAuth.controller';
import { requireClientAuth } from '../middleware/clientAuth.middleware';

const router = Router();

// Public routes
router.post('/request-otp', requestOTP);
router.post('/verify-otp', verifyOTP);

// Protected routes (require client JWT)
router.get('/me', requireClientAuth, getClientProfile);
router.patch('/me', requireClientAuth, updateClientProfile);

export default router;
</file>

<file path="backend/src/routes/compliance.routes.ts">
import { Router } from 'express';
import {
    getDailyAdherence,
    getWeeklyAdherence,
    getComplianceHistory,
} from '../controllers/compliance.controller';
import { requireAuth } from '../middleware/auth.middleware';

const router = Router({ mergeParams: true });

router.use(requireAuth);

router.get('/daily', getDailyAdherence);
router.get('/weekly', getWeeklyAdherence);
router.get('/history', getComplianceHistory);

export default router;
</file>

<file path="backend/src/routes/dashboard.routes.ts">
import { Router } from 'express';
import { requireAuth } from '../middleware/auth.middleware';
import { getDashboardStats } from '../controllers/dashboard.controller';

const router = Router();

router.get('/stats', requireAuth, getDashboardStats);

export default router;
</file>

<file path="backend/src/routes/meal.routes.ts">
import { Router } from 'express';
import { addMealToPlan, updateMeal, deleteMeal } from '../controllers/meal.controller';
import { addFoodToMeal, updateMealFoodItem, removeFoodFromMeal } from '../controllers/foodItem.controller';
import { requireAuth } from '../middleware/auth.middleware';

const router = Router();

router.use(requireAuth);

// Meal CRUD
router.post('/', addMealToPlan);
router.patch('/:id', updateMeal);
router.delete('/:id', deleteMeal);

// Meal Food Items
router.post('/:mealId/food-items', addFoodToMeal);
router.patch('/:mealId/food-items/:itemId', updateMealFoodItem);
router.delete('/:mealId/food-items/:itemId', removeFoodFromMeal);

export default router;
</file>

<file path="backend/src/routes/mealLog.routes.ts">
import { Router } from 'express';
import {
    createMealLog,
    listMealLogs,
    getMealLog,
    updateMealLog,
    reviewMealLog,
    uploadMealPhoto
} from '../controllers/mealLog.controller';
import { requireAuth } from '../middleware/auth.middleware';
import { uploadSinglePhoto } from '../middleware/upload.middleware';

const router = Router();

router.use(requireAuth);

router.post('/', createMealLog);
router.get('/', listMealLogs);
router.get('/:id', getMealLog);
router.patch('/:id', updateMealLog);
router.patch('/:id/review', reviewMealLog);
router.post('/:id/photo', uploadSinglePhoto, uploadMealPhoto);

export default router;
</file>

<file path="backend/src/routes/media.routes.ts">
import { Router, Request, Response } from 'express';
import { S3Client, GetObjectCommand } from '@aws-sdk/client-s3';
import { Readable } from 'stream';

const router = Router();

// S3/Garage Configuration (reuse from storage service)
const s3Client = new S3Client({
    endpoint: process.env.S3_ENDPOINT || 'http://localhost:3900',
    region: process.env.S3_REGION || 'garage',
    credentials: {
        accessKeyId: process.env.S3_ACCESS_KEY || '',
        secretAccessKey: process.env.S3_SECRET_KEY || ''
    },
    forcePathStyle: true
});

const BUCKET = process.env.S3_BUCKET || 'dietkaro-media';

/**
 * GET /media/:prefix/:orgId/:entityId/:filename
 * Proxy endpoint to serve images from S3/Garage
 */
router.get('/:prefix/:orgId/:entityId/:filename', async (req: Request, res: Response) => {
    try {
        const { prefix, orgId, entityId, filename } = req.params;
        const key = `${prefix}/${orgId}/${entityId}/${filename}`;

        const command = new GetObjectCommand({
            Bucket: BUCKET,
            Key: key
        });

        const response = await s3Client.send(command);

        // Set content type
        res.setHeader('Content-Type', response.ContentType || 'image/jpeg');
        res.setHeader('Cache-Control', 'public, max-age=31536000'); // Cache for 1 year
        res.setHeader('Content-Length', response.ContentLength?.toString() || '0');

        // Stream the response
        if (response.Body instanceof Readable) {
            response.Body.pipe(res);
        } else if (response.Body) {
            const chunks: Buffer[] = [];
            const readable = response.Body as any;
            for await (const chunk of readable) {
                chunks.push(chunk);
            }
            res.send(Buffer.concat(chunks));
        } else {
            res.status(404).json({ success: false, error: { code: 'NOT_FOUND', message: 'Image not found' } });
        }
    } catch (error: any) {
        if (error.name === 'NoSuchKey') {
            return res.status(404).json({ success: false, error: { code: 'NOT_FOUND', message: 'Image not found' } });
        }
        console.error('Error fetching image:', error);
        res.status(500).json({ success: false, error: { code: 'INTERNAL_ERROR', message: 'Failed to fetch image' } });
    }
});

export default router;
</file>

<file path="backend/src/routes/notification.routes.ts">
import { Router } from 'express';
import { requireAuth } from '../middleware/auth.middleware';
import { registerToken, listNotifications, markRead } from '../controllers/notification.controller';

const router = Router();

router.use(requireAuth);

router.post('/device-token', registerToken);
router.get('/', listNotifications);
router.patch('/:id/read', markRead);

export default router;
</file>

<file path="backend/src/routes/organization.routes.ts">
import { Router } from 'express';
import { createOrganization, getOrganization } from '../controllers/organization.controller';
import { requireAuth, requireRole } from '../middleware/auth.middleware';

const router = Router();

// Public route for creating new organizations (during onboarding)
router.post('/', createOrganization);

// Protected routes
router.get('/', requireAuth, getOrganization);

export default router;
</file>

<file path="backend/src/routes/referral.routes.ts">
import { Router } from 'express';
import { getReferralCode, getReferralStats, validateReferralCode } from '../controllers/referral.controller';
import { requireClientAuth } from '../middleware/clientAuth.middleware';

const router = Router();

// All routes require client authentication
router.use(requireClientAuth);

// Get or generate referral code
router.get('/code', getReferralCode);

// Get referral statistics and benefits
router.get('/stats', getReferralStats);

// Validate a referral code
router.get('/validate/:code', validateReferralCode);

export default router;
</file>

<file path="backend/src/routes/reports.routes.ts">
import { Router } from 'express';
import { listReports, getUploadUrl, createReport, deleteReport } from '../controllers/reports.controller';
import { requireClientAuth } from '../middleware/clientAuth.middleware';

const router = Router();

// All routes require client authentication
router.use(requireClientAuth);

// List client's reports
router.get('/', listReports);

// Get presigned upload URL
router.post('/upload-url', getUploadUrl);

// Create/confirm report after upload
router.post('/', createReport);

// Delete a report
router.delete('/:id', deleteReport);

export default router;
</file>

<file path="backend/src/routes/share.routes.ts">
import { Router } from 'express';
import { requireAuth } from '../middleware/auth.middleware';
import {
    downloadDietPlanPdf,
    getDietPlanPrintView,
    emailDietPlan,
    getDietPlanShareLink,
} from '../controllers/share.controller';

const router = Router();

// All routes require authentication
router.use(requireAuth);

// PDF download
router.get('/diet-plans/:id/pdf', downloadDietPlanPdf);

// Print-friendly HTML view
router.get('/diet-plans/:id/print', getDietPlanPrintView);

// Email diet plan to client
router.post('/diet-plans/:id/email', emailDietPlan);

// Get WhatsApp share link
router.get('/diet-plans/:id/whatsapp', getDietPlanShareLink);

export default router;
</file>

<file path="backend/src/routes/team.routes.ts">
import { Router } from 'express';
import { requireAuth } from '../middleware/auth.middleware';
import { listTeamMembers, inviteMember, validateInvite, acceptInvite } from '../controllers/team.controller';

const router = Router();


router.get('/', requireAuth, listTeamMembers);
router.post('/invite', requireAuth, inviteMember);
router.get('/invitation/:token', validateInvite); // Public route
router.post('/join', acceptInvite);

export default router;
</file>

<file path="backend/src/routes/test.routes.ts">
/**
 * Test-only routes for development testing without Clerk
 * Only loaded when NODE_ENV !== 'production'
 */
import { Router } from 'express';
import prisma from '../utils/prisma';

const testRouter = Router();

// Lazy imports to avoid loading test middleware in production
const { testAuthBypass } = require('../middleware/testAuth.middleware');

// Import controllers
const clientController = require('../controllers/client.controller');
const dietPlanController = require('../controllers/dietPlan.controller');
const mealController = require('../controllers/meal.controller');
const mealLogController = require('../controllers/mealLog.controller');
const weightLogController = require('../controllers/weightLog.controller');
const foodItemController = require('../controllers/foodItem.controller');
const validationController = require('../controllers/validation.controller');

// Setup test org and user
testRouter.post('/setup', async (req: any, res: any) => {
    try {
        let org = await prisma.organization.findFirst({
            where: { name: 'Test Organization' },
        });

        if (!org) {
            org = await prisma.organization.create({
                data: {
                    name: 'Test Organization',
                    email: 'test@test.com',
                    phone: '+919999999999',
                    city: 'Delhi',
                },
            });
        }

        let user = await prisma.user.findFirst({
            where: { email: 'testuser@test.com' },
        });

        if (!user) {
            user = await prisma.user.create({
                data: {
                    clerkUserId: 'test-clerk-id-123',
                    email: 'testuser@test.com',
                    fullName: 'Test Dietitian',
                    role: 'admin',
                    orgId: org.id,
                },
            });
        }

        res.json({
            success: true,
            data: {
                organizationId: org.id,
                userId: user.id,
                message: 'Use X-Test-User-Id header with userId for authenticated requests',
            },
        });
    } catch (error) {
        console.error('Test setup error:', error);
        res.status(500).json({ success: false, error: 'Setup failed' });
    }
});

// Clients
testRouter.post('/clients', testAuthBypass, clientController.createClient);
testRouter.get('/clients', testAuthBypass, clientController.listClients);
testRouter.get('/clients/:id', testAuthBypass, clientController.getClient);
testRouter.patch('/clients/:id', testAuthBypass, clientController.updateClient);
testRouter.get('/clients/:id/progress', testAuthBypass, clientController.getClientProgress);
testRouter.post('/clients/:clientId/weight-logs', testAuthBypass, weightLogController.createWeightLog);
testRouter.get('/clients/:clientId/weight-logs', testAuthBypass, weightLogController.listWeightLogs);

// Diet Plans
testRouter.post('/diet-plans', testAuthBypass, dietPlanController.createDietPlan);
testRouter.get('/diet-plans', testAuthBypass, dietPlanController.listDietPlans);
testRouter.get('/diet-plans/:id', testAuthBypass, dietPlanController.getDietPlan);
testRouter.patch('/diet-plans/:id', testAuthBypass, dietPlanController.updateDietPlan);
testRouter.post('/diet-plans/:id/publish', testAuthBypass, dietPlanController.publishDietPlan);

// Meals
testRouter.post('/meals', testAuthBypass, mealController.addMealToPlan);
testRouter.patch('/meals/:id', testAuthBypass, mealController.updateMeal);
testRouter.delete('/meals/:id', testAuthBypass, mealController.deleteMeal);

// Meal Logs
testRouter.post('/meal-logs', testAuthBypass, mealLogController.createMealLog);
testRouter.get('/meal-logs', testAuthBypass, mealLogController.listMealLogs);
testRouter.get('/meal-logs/:id', testAuthBypass, mealLogController.getMealLog);
testRouter.patch('/meal-logs/:id', testAuthBypass, mealLogController.updateMealLog);
testRouter.patch('/meal-logs/:id/review', testAuthBypass, mealLogController.reviewMealLog);

// Photo uploads
const { uploadSinglePhoto } = require('../middleware/upload.middleware');
testRouter.post('/meal-logs/:id/photo', testAuthBypass, uploadSinglePhoto, mealLogController.uploadMealPhoto);
testRouter.post('/weight-logs/:id/photo', testAuthBypass, uploadSinglePhoto, weightLogController.uploadProgressPhoto);

// Weight Logs
testRouter.post('/weight-logs', testAuthBypass, weightLogController.createWeightLogGeneral);
testRouter.get('/weight-logs', testAuthBypass, weightLogController.listAllWeightLogs);

// Food Items
testRouter.post('/food-items', testAuthBypass, foodItemController.createFoodItem);
testRouter.get('/food-items', testAuthBypass, foodItemController.listFoodItems);
testRouter.get('/food-items/:id', testAuthBypass, foodItemController.getFoodItem);
testRouter.patch('/food-items/:id', testAuthBypass, foodItemController.updateFoodItem);
testRouter.delete('/food-items/:id', testAuthBypass, foodItemController.deleteFoodItem);

// Meal Food Items
testRouter.post('/meals/:mealId/food-items', testAuthBypass, foodItemController.addFoodToMeal);
testRouter.patch('/meals/:mealId/food-items/:itemId', testAuthBypass, foodItemController.updateMealFoodItem);
testRouter.delete('/meals/:mealId/food-items/:itemId', testAuthBypass, foodItemController.removeFoodFromMeal);

// Diet Validation
testRouter.post('/diet-validation/check', testAuthBypass, validationController.checkValidation);
testRouter.post('/diet-validation/batch', testAuthBypass, validationController.checkBatchValidation);
testRouter.post('/diet-validation/invalidate-cache', testAuthBypass, validationController.invalidateCache);

export default testRouter;
</file>

<file path="backend/src/routes/validation.routes.ts">
/**
 * Validation Routes
 * Diet validation API endpoints
 */

import { Router } from 'express';
import { requireAuth } from '../middleware/auth.middleware';
import {
    checkValidation,
    checkBatchValidation,
    invalidateCache
} from '../controllers/validation.controller';

const router = Router();

// All routes require authentication
router.use(requireAuth);

// POST /api/v1/diet-validation/check - Single food validation
router.post('/check', checkValidation);

// POST /api/v1/diet-validation/batch - Batch food validation
router.post('/batch', checkBatchValidation);

// POST /api/v1/diet-validation/invalidate-cache - Clear cache
router.post('/invalidate-cache', invalidateCache);

export default router;
</file>

<file path="backend/src/routes/weightLog.routes.ts">
import { Router } from 'express';
import {
    createWeightLogGeneral,
    listAllWeightLogs,
    uploadProgressPhoto
} from '../controllers/weightLog.controller';
import { requireAuth } from '../middleware/auth.middleware';
import { uploadSinglePhoto } from '../middleware/upload.middleware';

const router = Router();

router.use(requireAuth);

router.post('/', createWeightLogGeneral);
router.get('/', listAllWeightLogs);
router.post('/:id/photo', uploadSinglePhoto, uploadProgressPhoto);

export default router;
</file>

<file path="backend/src/schemas/dietPlan.schema.ts">
import { z } from 'zod';

export const createDietPlanSchema = z.object({
    clientId: z.string().uuid('Invalid client ID'),
    name: z.string().min(2, 'Plan name must be at least 2 characters'),
    description: z.string().optional(),
    startDate: z.string().refine((val) => !isNaN(Date.parse(val)), 'Invalid start date'),
    endDate: z.string().refine((val) => !isNaN(Date.parse(val)), 'Invalid end date').optional(),
    targetCalories: z.number().min(500).max(10000).optional(),
    targetProteinG: z.number().min(0).max(500).optional(),
    targetCarbsG: z.number().min(0).max(1000).optional(),
    targetFatsG: z.number().min(0).max(500).optional(),
    targetFiberG: z.number().min(0).max(200).optional(),
    notesForClient: z.string().optional(),
    internalNotes: z.string().optional(),
    meals: z.array(z.object({
        dayIndex: z.number().min(0).max(6).optional(),
        mealDate: z.string().optional(),
        mealType: z.string(),
        timeOfDay: z.string().optional(),
        title: z.string(),
        description: z.string().optional(),
        instructions: z.string().optional(),
        foodItems: z.array(z.object({
            foodId: z.string().uuid(),
            quantity: z.number().min(0),
            notes: z.string().optional(),
            optionGroup: z.number().int().min(0).optional(),
            optionLabel: z.string().optional()
        })).optional()
    })).optional(),
    options: z.object({
        saveAsTemplate: z.boolean().optional(),
        templateCategory: z.string().optional()
    }).optional()
});

export const updateDietPlanSchema = createDietPlanSchema.partial().omit({ clientId: true });

export type CreateDietPlanInput = z.infer<typeof createDietPlanSchema>;
export type UpdateDietPlanInput = z.infer<typeof updateDietPlanSchema>;
</file>

<file path="backend/src/schemas/foodItem.schema.ts">
import { z } from 'zod';

// Create Food Item
export const createFoodItemSchema = z.object({
    name: z.string().min(1, 'Name is required').max(255),
    brand: z.string().max(100).optional(),
    category: z.string().min(1, 'Category is required'),
    subCategory: z.string().optional(),
    servingSizeG: z.number().positive().default(100),
    calories: z.number().int().min(0),
    proteinG: z.number().min(0).optional(),
    carbsG: z.number().min(0).optional(),
    fatsG: z.number().min(0).optional(),
    fiberG: z.number().min(0).optional(),
    sodiumMg: z.number().min(0).optional(),
    sugarG: z.number().min(0).optional(),
    barcode: z.string().optional(),
    allergenFlags: z.array(z.string()).default([]),
    dietaryTags: z.array(z.string()).default([])
});

export type CreateFoodItemInput = z.infer<typeof createFoodItemSchema>;

// Update Food Item
export const updateFoodItemSchema = createFoodItemSchema.partial();

export type UpdateFoodItemInput = z.infer<typeof updateFoodItemSchema>;

// Add Food to Meal
export const addFoodToMealSchema = z.object({
    foodId: z.string().uuid(),
    quantityG: z.number().positive(),
    notes: z.string().optional()
});

export type AddFoodToMealInput = z.infer<typeof addFoodToMealSchema>;

// Update Food in Meal
export const updateMealFoodItemSchema = z.object({
    quantityG: z.number().positive().optional(),
    notes: z.string().optional()
});

export type UpdateMealFoodItemInput = z.infer<typeof updateMealFoodItemSchema>;
</file>

<file path="backend/src/schemas/mealLog.schema.ts">
import { z } from 'zod';

export const createMealLogSchema = z.object({
    clientId: z.string().uuid('Invalid client ID'),
    mealId: z.string().uuid('Invalid meal ID'),
    scheduledDate: z.string().refine((val) => !isNaN(Date.parse(val)), 'Invalid scheduled date'),
    scheduledTime: z.string().optional()
});

export const updateMealLogSchema = z.object({
    status: z.enum(['pending', 'eaten', 'substituted', 'skipped']).optional(),
    photoUrl: z.string().url().optional(),
    clientNotes: z.string().optional(),
    substituteDescription: z.string().optional(),
    substituteCaloriesEst: z.number().optional(),
    chosenOptionGroup: z.number().int().min(0).optional()
});

export const reviewMealLogSchema = z.object({
    dietitianFeedback: z.string().optional(),
    status: z.enum(['pending', 'eaten', 'substituted', 'skipped']).optional(),
    overrideCalories: z.number().optional()
});

export const mealLogQuerySchema = z.object({
    clientId: z.string().uuid().optional(),
    dateFrom: z.string().optional(),
    dateTo: z.string().optional(),
    status: z.enum(['pending', 'eaten', 'substituted', 'skipped']).optional(),
    page: z.string().optional().default('1'),
    pageSize: z.string().optional().default('20'),
    sortBy: z.string().optional().default('scheduledDate')
});

export type CreateMealLogInput = z.infer<typeof createMealLogSchema>;
export type UpdateMealLogInput = z.infer<typeof updateMealLogSchema>;
export type ReviewMealLogInput = z.infer<typeof reviewMealLogSchema>;
</file>

<file path="backend/src/schemas/organization.schema.ts">
import { z } from 'zod';

export const createOrganizationSchema = z.object({
    name: z.string().min(2, 'Organization name must be at least 2 characters'),
    description: z.string().optional(),
    email: z.string().email('Invalid email format').optional(),
    phone: z.string().optional(),
    address: z.string().optional(),
    city: z.string().optional(),
    country: z.string().default('IN'),
    timezone: z.string().default('Asia/Kolkata')
});

export type CreateOrganizationInput = z.infer<typeof createOrganizationSchema>;
</file>

<file path="backend/src/schemas/weightLog.schema.ts">
import { z } from 'zod';

export const createWeightLogSchema = z.object({
    logDate: z.string().refine((val) => !isNaN(Date.parse(val)), 'Invalid log date'),
    logTime: z.string().optional(),
    weightKg: z.number().min(10, 'Weight must be at least 10kg').max(500, 'Weight must be less than 500kg'),
    notes: z.string().optional(),
    progressPhotoUrl: z.string().url().optional()
});

export const weightLogQuerySchema = z.object({
    clientId: z.string().uuid('Invalid client ID'),
    dateFrom: z.string().optional(),
    dateTo: z.string().optional(),
    page: z.string().optional().default('1'),
    pageSize: z.string().optional().default('100')
});

export type CreateWeightLogInput = z.infer<typeof createWeightLogSchema>;
</file>

<file path="backend/src/services/dietPlan.service.ts">
import prisma from '../utils/prisma';
import { AppError } from '../errors/AppError';
import logger from '../utils/logger';
import { buildPaginationParams, buildPaginationMeta } from '../utils/queryFilters';
import { CreateDietPlanInput, UpdateDietPlanInput } from '../schemas/dietPlan.schema';

export class DietPlanService {
    async createPlan(data: CreateDietPlanInput, orgId: string, userId: string) {
        const isTemplate = data.options?.saveAsTemplate || false;
        const clientId = data.clientId;

        if (!isTemplate) {
            if (!clientId) {
                throw AppError.badRequest('clientId is required for non-template diet plans', 'CLIENT_ID_REQUIRED');
            }
            const client = await prisma.client.findFirst({ where: { id: clientId, orgId } });
            if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');
        }

        const dietPlan = await prisma.dietPlan.create({
            data: {
                organization: { connect: { id: orgId } },
                client: clientId ? { connect: { id: clientId } } : undefined,
                creator: { connect: { id: userId } },
                name: data.name,
                description: data.description,
                startDate: new Date(data.startDate),
                endDate: data.endDate ? new Date(data.endDate) : null,
                targetCalories: data.targetCalories,
                targetProteinG: data.targetProteinG,
                targetCarbsG: data.targetCarbsG,
                targetFatsG: data.targetFatsG,
                targetFiberG: data.targetFiberG,
                notesForClient: data.notesForClient,
                internalNotes: data.internalNotes,
                status: 'draft',
                isTemplate,
                templateCategory: data.options?.templateCategory,
                meals: data.meals?.length
                    ? {
                          create: data.meals.map((meal: any, index: number) => ({
                              dayOfWeek: meal.dayIndex,
                              mealDate: meal.mealDate ? new Date(meal.mealDate) : null,
                              sequenceNumber: index,
                              mealType: meal.mealType,
                              timeOfDay: meal.timeOfDay,
                              name: meal.title,
                              description: meal.description,
                              instructions: meal.instructions,
                              foodItems: meal.foodItems?.length
                                  ? {
                                        create: meal.foodItems.map((item: any, sortOrder: number) => ({
                                            foodId: item.foodId,
                                            quantityG: item.quantity,
                                            notes: item.notes,
                                            sortOrder,
                                            optionGroup: item.optionGroup ?? 0,
                                            optionLabel: item.optionLabel ?? null,
                                        })),
                                    }
                                  : undefined,
                          })),
                      }
                    : undefined,
            },
            include: {
                client: { select: { id: true, fullName: true } },
                creator: { select: { id: true, fullName: true } },
                meals: { include: { foodItems: { orderBy: [{ optionGroup: 'asc' }, { sortOrder: 'asc' }], include: { foodItem: true } } } },
            },
        });

        logger.info(isTemplate ? 'Diet plan template created' : 'Diet plan created', { planId: dietPlan.id, clientId });
        return dietPlan;
    }

    async getPlan(planId: string, orgId: string) {
        const dietPlan = await prisma.dietPlan.findFirst({
            where: { id: planId, orgId, isActive: true },
            include: {
                client: { select: { id: true, fullName: true, currentWeightKg: true, targetWeightKg: true } },
                creator: { select: { id: true, fullName: true } },
                meals: {
                    orderBy: [{ dayOfWeek: 'asc' }, { sequenceNumber: 'asc' }],
                    include: { foodItems: { orderBy: [{ optionGroup: 'asc' }, { sortOrder: 'asc' }], include: { foodItem: true } } },
                },
            },
        });

        if (!dietPlan) throw AppError.notFound('Diet plan not found', 'PLAN_NOT_FOUND');
        return dietPlan;
    }

    async listPlans(orgId: string, query: any) {
        const { clientId, status, isTemplate } = query;
        const pagination = buildPaginationParams(query.page, query.pageSize);

        const where: any = { orgId, isActive: true };
        if (clientId) where.clientId = String(clientId);
        if (status) where.status = String(status);
        if (isTemplate !== undefined) where.isTemplate = isTemplate === 'true';

        const [plans, total] = await prisma.$transaction([
            prisma.dietPlan.findMany({
                where,
                skip: pagination.skip,
                take: pagination.take,
                orderBy: { createdAt: 'desc' },
                include: {
                    client: { select: { id: true, fullName: true } },
                    creator: { select: { id: true, fullName: true } },
                    _count: { select: { meals: true } },
                },
            }),
            prisma.dietPlan.count({ where }),
        ]);

        return {
            plans: plans.map((p) => ({ ...p, mealCount: p._count.meals })),
            meta: buildPaginationMeta(total, pagination),
        };
    }

    async updatePlan(planId: string, data: UpdateDietPlanInput, orgId: string) {
        const existing = await prisma.dietPlan.findFirst({ where: { id: planId, orgId } });
        if (!existing) throw AppError.notFound('Diet plan not found', 'PLAN_NOT_FOUND');

        const updated = await prisma.dietPlan.update({
            where: { id: planId },
            data: {
                ...(data.name && { name: data.name }),
                ...(data.description !== undefined && { description: data.description }),
                ...(data.startDate && { startDate: new Date(data.startDate) }),
                ...(data.endDate !== undefined && { endDate: data.endDate ? new Date(data.endDate) : null }),
                ...(data.targetCalories !== undefined && { targetCalories: data.targetCalories }),
                ...(data.targetProteinG !== undefined && { targetProteinG: data.targetProteinG }),
                ...(data.targetCarbsG !== undefined && { targetCarbsG: data.targetCarbsG }),
                ...(data.targetFatsG !== undefined && { targetFatsG: data.targetFatsG }),
                ...(data.targetFiberG !== undefined && { targetFiberG: data.targetFiberG }),
                ...(data.notesForClient !== undefined && { notesForClient: data.notesForClient }),
                ...(data.internalNotes !== undefined && { internalNotes: data.internalNotes }),
            },
        });

        logger.info('Diet plan updated', { planId: updated.id });
        return updated;
    }

    async publishPlan(planId: string, orgId: string) {
        const plan = await prisma.dietPlan.findFirst({
            where: { id: planId, orgId },
            include: { meals: true },
        });

        if (!plan) throw AppError.notFound('Diet plan not found', 'PLAN_NOT_FOUND');

        const updated = await prisma.dietPlan.update({
            where: { id: planId },
            data: { status: 'active', publishedAt: new Date() },
        });

        logger.info('Diet plan published', { planId: updated.id });
        return {
            planId: updated.id,
            status: updated.status,
            publishedAt: updated.publishedAt,
            mealLogsCreated: plan.meals.length,
        };
    }

    async assignTemplateToClient(templateId: string, body: any, orgId: string, userId: string) {
        const { clientId, startDate, name } = body;

        if (!clientId) throw AppError.badRequest('clientId is required', 'CLIENT_ID_REQUIRED');
        if (!startDate) throw AppError.badRequest('startDate is required', 'START_DATE_REQUIRED');

        const template = await prisma.dietPlan.findFirst({
            where: { id: templateId, orgId, isTemplate: true, isActive: true },
            include: { meals: { include: { foodItems: true } } },
        });

        if (!template) throw AppError.notFound('Template not found', 'TEMPLATE_NOT_FOUND');

        const client = await prisma.client.findFirst({ where: { id: clientId, orgId } });
        if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        const newPlan = await prisma.dietPlan.create({
            data: {
                organization: { connect: { id: orgId } },
                client: { connect: { id: clientId } },
                creator: { connect: { id: userId } },
                name: name || `${template.name} - ${client.fullName}`,
                description: template.description,
                startDate: new Date(startDate),
                targetCalories: template.targetCalories,
                targetProteinG: template.targetProteinG,
                targetCarbsG: template.targetCarbsG,
                targetFatsG: template.targetFatsG,
                targetFiberG: template.targetFiberG,
                notesForClient: template.notesForClient,
                internalNotes: template.internalNotes,
                status: 'draft',
                isTemplate: false,
                meals: {
                    create: template.meals.map((meal, index) => ({
                        dayOfWeek: meal.dayOfWeek,
                        mealDate: null,
                        sequenceNumber: meal.sequenceNumber ?? index,
                        mealType: meal.mealType,
                        timeOfDay: meal.timeOfDay,
                        name: meal.name,
                        description: meal.description,
                        instructions: meal.instructions,
                        servingSizeNotes: meal.servingSizeNotes,
                        foodItems: meal.foodItems.length
                            ? {
                                  create: meal.foodItems.map((item, sortOrder) => ({
                                      foodId: item.foodId,
                                      quantityG: item.quantityG,
                                      notes: item.notes,
                                      sortOrder: item.sortOrder ?? sortOrder,
                                      optionGroup: item.optionGroup,
                                      optionLabel: item.optionLabel,
                                  })),
                              }
                            : undefined,
                    })),
                },
            },
            include: {
                client: { select: { id: true, fullName: true } },
                creator: { select: { id: true, fullName: true } },
                meals: { include: { foodItems: { orderBy: [{ optionGroup: 'asc' }, { sortOrder: 'asc' }], include: { foodItem: true } } } },
            },
        });

        logger.info('Template assigned to client', { templateId, newPlanId: newPlan.id, clientId });
        return newPlan;
    }
}

export const dietPlanService = new DietPlanService();
</file>

<file path="backend/src/services/foodItem.service.ts">
import prisma from '../utils/prisma';
import { AppError } from '../errors/AppError';
import logger from '../utils/logger';
import { buildPaginationParams, buildPaginationMeta } from '../utils/queryFilters';
import { scaleNutrition } from '../utils/nutritionCalculator';
import { CreateFoodItemInput, UpdateFoodItemInput } from '../schemas/foodItem.schema';

export class FoodItemService {
    async createFoodItem(data: CreateFoodItemInput, orgId: string, userId: string) {
        const foodItem = await prisma.foodItem.create({
            data: {
                orgId,
                name: data.name,
                brand: data.brand,
                category: data.category,
                subCategory: data.subCategory,
                servingSizeG: data.servingSizeG || 100,
                calories: data.calories,
                proteinG: data.proteinG,
                carbsG: data.carbsG,
                fatsG: data.fatsG,
                fiberG: data.fiberG,
                sodiumMg: data.sodiumMg,
                sugarG: data.sugarG,
                barcode: data.barcode,
                allergenFlags: data.allergenFlags || [],
                dietaryTags: data.dietaryTags || [],
                createdByUserId: userId,
                isVerified: false,
                source: 'user_created',
            },
        });

        logger.info('Food item created', { foodItemId: foodItem.id, name: foodItem.name });
        return foodItem;
    }

    async listFoodItems(orgId: string, query: any) {
        const { q, category, orgScope = 'all', isVerified, sortBy = 'name' } = query;
        const pagination = buildPaginationParams(query.page, query.pageSize);

        const where: any = {
            OR: [{ orgId: null }, { orgId }],
        };

        if (orgScope === 'org_only') {
            where.OR = [{ orgId }];
        } else if (orgScope === 'global_only') {
            where.OR = [{ orgId: null }];
        }

        if (q) {
            where.AND = [
                {
                    OR: [
                        { name: { contains: String(q), mode: 'insensitive' } },
                        { brand: { contains: String(q), mode: 'insensitive' } },
                    ],
                },
            ];
        }

        if (category) where.category = String(category);
        if (isVerified !== undefined) where.isVerified = isVerified === 'true';

        const [foodItems, total] = await prisma.$transaction([
            prisma.foodItem.findMany({
                where,
                skip: pagination.skip,
                take: pagination.take,
                orderBy: { [String(sortBy)]: 'asc' },
                include: { creator: { select: { id: true, fullName: true } } },
            }),
            prisma.foodItem.count({ where }),
        ]);

        return { foodItems, meta: buildPaginationMeta(total, pagination) };
    }

    async getFoodItem(foodItemId: string, orgId: string) {
        const foodItem = await prisma.foodItem.findFirst({
            where: {
                id: foodItemId,
                OR: [{ orgId: null }, { orgId }],
            },
            include: { creator: { select: { id: true, fullName: true } } },
        });

        if (!foodItem) throw AppError.notFound('Food item not found', 'FOOD_NOT_FOUND');
        return foodItem;
    }

    async updateFoodItem(foodItemId: string, data: UpdateFoodItemInput, orgId: string) {
        const existing = await prisma.foodItem.findFirst({ where: { id: foodItemId, orgId } });
        if (!existing) throw AppError.notFound('Food item not found or cannot be edited', 'FOOD_NOT_FOUND');

        const updated = await prisma.foodItem.update({
            where: { id: foodItemId },
            data: {
                ...(data.name && { name: data.name }),
                ...(data.brand !== undefined && { brand: data.brand }),
                ...(data.category && { category: data.category }),
                ...(data.subCategory !== undefined && { subCategory: data.subCategory }),
                ...(data.servingSizeG && { servingSizeG: data.servingSizeG }),
                ...(data.calories !== undefined && { calories: data.calories }),
                ...(data.proteinG !== undefined && { proteinG: data.proteinG }),
                ...(data.carbsG !== undefined && { carbsG: data.carbsG }),
                ...(data.fatsG !== undefined && { fatsG: data.fatsG }),
                ...(data.fiberG !== undefined && { fiberG: data.fiberG }),
                ...(data.sodiumMg !== undefined && { sodiumMg: data.sodiumMg }),
                ...(data.sugarG !== undefined && { sugarG: data.sugarG }),
                ...(data.barcode !== undefined && { barcode: data.barcode }),
                ...(data.allergenFlags && { allergenFlags: data.allergenFlags }),
                ...(data.dietaryTags && { dietaryTags: data.dietaryTags }),
            },
        });

        logger.info('Food item updated', { foodItemId: updated.id });
        return updated;
    }

    async deleteFoodItem(foodItemId: string, orgId: string) {
        const existing = await prisma.foodItem.findFirst({ where: { id: foodItemId, orgId } });
        if (!existing) throw AppError.notFound('Food item not found or cannot be deleted', 'FOOD_NOT_FOUND');

        const usageCount = await prisma.mealFoodItem.count({ where: { foodId: foodItemId } });
        if (usageCount > 0) {
            throw AppError.conflict(`Cannot delete: food item is used in ${usageCount} meal(s)`, 'FOOD_IN_USE');
        }

        await prisma.foodItem.delete({ where: { id: foodItemId } });
        logger.info('Food item deleted', { foodItemId });
    }

    async addFoodToMeal(mealId: string, body: any, orgId: string) {
        const { foodId, quantityG, notes } = body;

        const meal = await prisma.meal.findFirst({
            where: { id: mealId },
            include: { dietPlan: true },
        });

        if (!meal || meal.dietPlan.orgId !== orgId) {
            throw AppError.notFound('Meal not found', 'MEAL_NOT_FOUND');
        }

        const foodItem = await prisma.foodItem.findFirst({
            where: { id: foodId, OR: [{ orgId: null }, { orgId }] },
        });

        if (!foodItem) throw AppError.notFound('Food item not found', 'FOOD_NOT_FOUND');

        const nutrition = scaleNutrition(foodItem, quantityG);

        const maxSortOrder = await prisma.mealFoodItem.aggregate({
            where: { mealId },
            _max: { sortOrder: true },
        });

        const mealFoodItem = await prisma.mealFoodItem.create({
            data: {
                mealId,
                foodId,
                quantityG,
                calories: nutrition.calories,
                proteinG: nutrition.proteinG,
                carbsG: nutrition.carbsG,
                fatsG: nutrition.fatsG,
                fiberG: nutrition.fiberG,
                notes,
                sortOrder: (maxSortOrder._max.sortOrder || 0) + 1,
            },
            include: { foodItem: true },
        });

        logger.info('Food added to meal', { mealId, foodId, mealFoodItemId: mealFoodItem.id });
        return mealFoodItem;
    }

    async updateMealFoodItem(mealId: string, itemId: string, body: any, orgId: string) {
        const { quantityG, notes } = body;

        const existing = await prisma.mealFoodItem.findFirst({
            where: { id: itemId, mealId },
            include: { meal: { include: { dietPlan: true } }, foodItem: true },
        });

        if (!existing || existing.meal.dietPlan.orgId !== orgId) {
            throw AppError.notFound('Meal food item not found', 'ITEM_NOT_FOUND');
        }

        let updateData: any = {};
        if (notes !== undefined) updateData.notes = notes;

        if (quantityG) {
            const nutrition = scaleNutrition(existing.foodItem, quantityG);
            updateData = {
                ...updateData,
                quantityG,
                calories: nutrition.calories,
                proteinG: nutrition.proteinG,
                carbsG: nutrition.carbsG,
                fatsG: nutrition.fatsG,
                fiberG: nutrition.fiberG,
            };
        }

        const updated = await prisma.mealFoodItem.update({
            where: { id: itemId },
            data: updateData,
            include: { foodItem: true },
        });

        logger.info('Meal food item updated', { itemId });
        return updated;
    }

    async removeFoodFromMeal(mealId: string, itemId: string, orgId: string) {
        const existing = await prisma.mealFoodItem.findFirst({
            where: { id: itemId, mealId },
            include: { meal: { include: { dietPlan: true } } },
        });

        if (!existing || existing.meal.dietPlan.orgId !== orgId) {
            throw AppError.notFound('Meal food item not found', 'ITEM_NOT_FOUND');
        }

        await prisma.mealFoodItem.delete({ where: { id: itemId } });
        logger.info('Food removed from meal', { mealId, itemId });
    }
}

export const foodItemService = new FoodItemService();
</file>

<file path="backend/src/services/foodTagging.service.ts">
/**
 * Food Tagging Service
 * Auto-detects and manages food tags for validation engine
 */

import prisma from '../utils/prisma';
import logger from '../utils/logger';

// ============ DIETARY CATEGORY DETECTION ============

const NON_VEG_KEYWORDS = [
    'chicken', 'mutton', 'lamb', 'beef', 'pork', 'fish', 'prawn', 'shrimp',
    'crab', 'lobster', 'salmon', 'tuna', 'meat', 'bacon', 'ham', 'sausage',
    'turkey', 'duck', 'goat', 'keema', 'tikka', 'tandoori', 'kebab',
    'biryani chicken', 'butter chicken', 'fish curry', 'fish fry'
];

const EGG_KEYWORDS = ['egg', 'omelette', 'omelet', 'scrambled', 'boiled egg', 'fried egg'];

const DAIRY_KEYWORDS = [
    'milk', 'cheese', 'paneer', 'curd', 'yogurt', 'yoghurt', 'butter', 'ghee',
    'cream', 'kheer', 'lassi', 'raita', 'shrikhand', 'kulfi'
];

const VEGAN_INDICATORS = [
    'vegan', 'plant-based', 'dairy-free', 'no milk', 'no cheese'
];

// ============ ALLERGEN MAPPING ============

const ALLERGEN_KEYWORDS: Record<string, string[]> = {
    eggs: ['egg', 'omelette', 'omelet', 'mayonnaise', 'mayo'],
    milk: ['milk', 'cheese', 'paneer', 'curd', 'yogurt', 'cream', 'butter', 'ghee', 'kheer', 'kulfi'],
    peanuts: ['peanut', 'groundnut', 'mungfali'],
    tree_nuts: ['almond', 'cashew', 'walnut', 'pistachio', 'badam', 'kaju'],
    wheat: ['wheat', 'roti', 'chapati', 'paratha', 'naan', 'bread', 'pasta', 'maida'],
    gluten: ['wheat', 'barley', 'rye', 'bread', 'pasta', 'noodles'],
    soy: ['soy', 'soya', 'tofu', 'tempeh'],
    fish: ['fish', 'salmon', 'tuna', 'mackerel', 'sardine'],
    shellfish: ['prawn', 'shrimp', 'crab', 'lobster', 'mussel', 'oyster'],
    sesame: ['sesame', 'til', 'tahini'],
    lactose: ['milk', 'cream', 'ice cream', 'cheese'],
};

// ============ NUTRITION TAG THRESHOLDS ============

const NUTRITION_THRESHOLDS = {
    high_protein: { field: 'proteinG', min: 20 },
    low_protein: { field: 'proteinG', max: 5 },
    high_carb: { field: 'carbsG', min: 50 },
    low_carb: { field: 'carbsG', max: 10 },
    high_fat: { field: 'fatsG', min: 20 },
    low_fat: { field: 'fatsG', max: 3 },
    high_fiber: { field: 'fiberG', min: 5 },
    high_sugar: { field: 'sugarG', min: 15 },
    low_sugar: { field: 'sugarG', max: 2 },
    high_sodium: { field: 'sodiumMg', min: 500 },
    low_sodium: { field: 'sodiumMg', max: 100 },
    high_calorie: { field: 'calories', min: 400 },
    low_calorie: { field: 'calories', max: 100 },
};

// ============ HEALTH FLAGS ============

const HEALTH_FLAG_RULES: Record<string, (food: any) => boolean> = {
    diabetic_caution: (food) => (food.sugarG || 0) > 10 || (food.carbsG || 0) > 40,
    heart_caution: (food) => (food.fatsG || 0) > 15 || (food.sodiumMg || 0) > 400,
    cholesterol_caution: (food) => food.name.toLowerCase().includes('egg') || food.name.toLowerCase().includes('butter'),
    kidney_caution: (food) => (food.sodiumMg || 0) > 500 || (food.proteinG || 0) > 25,
};

// ============ SERVICE CLASS ============

export class FoodTaggingService {

    /**
     * Auto-detect dietary category from food name
     */
    detectDietaryCategory(name: string, currentCategory?: string | null): string | null {
        const nameLower = name.toLowerCase();

        // Check if explicitly marked
        if (VEGAN_INDICATORS.some(v => nameLower.includes(v))) {
            return 'vegan';
        }

        // Check for non-veg
        if (NON_VEG_KEYWORDS.some(kw => nameLower.includes(kw))) {
            return 'non_veg';
        }

        // Check for egg (veg_with_egg)
        if (EGG_KEYWORDS.some(kw => nameLower.includes(kw))) {
            return 'veg_with_egg';
        }

        // Check for dairy (vegetarian but not vegan)
        if (DAIRY_KEYWORDS.some(kw => nameLower.includes(kw))) {
            return 'vegetarian';
        }

        // Default to vegetarian for unknown Indian foods
        return currentCategory || 'vegetarian';
    }

    /**
     * Auto-detect allergens from food name
     */
    detectAllergens(name: string, existingAllergens: string[] = []): string[] {
        const nameLower = name.toLowerCase();
        const detected = new Set(existingAllergens.map(a => a.toLowerCase()));

        for (const [allergen, keywords] of Object.entries(ALLERGEN_KEYWORDS)) {
            if (keywords.some(kw => nameLower.includes(kw))) {
                detected.add(allergen);
            }
        }

        return Array.from(detected);
    }

    /**
     * Calculate nutrition tags from macros
     */
    calculateNutritionTags(food: {
        calories: number;
        proteinG?: number | null;
        carbsG?: number | null;
        fatsG?: number | null;
        fiberG?: number | null;
        sugarG?: number | null;
        sodiumMg?: number | null;
    }): string[] {
        const tags: string[] = [];

        for (const [tag, rule] of Object.entries(NUTRITION_THRESHOLDS)) {
            const value = (food as any)[rule.field];
            if (value == null) continue;

            if ('min' in rule && value >= rule.min) {
                tags.push(tag);
            } else if ('max' in rule && value <= rule.max) {
                tags.push(tag);
            }
        }

        return tags;
    }

    /**
     * Calculate health flags based on nutrition
     */
    calculateHealthFlags(food: any): string[] {
        const flags: string[] = [];

        for (const [flag, checker] of Object.entries(HEALTH_FLAG_RULES)) {
            if (checker(food)) {
                flags.push(flag);
            }
        }

        return flags;
    }

    /**
     * Auto-tag a single food item
     */
    async autoTagFood(foodId: string): Promise<any> {
        const food = await prisma.foodItem.findUnique({
            where: { id: foodId }
        });

        if (!food) {
            throw new Error('Food item not found');
        }

        const dietaryCategory = this.detectDietaryCategory(food.name, food.dietaryCategory);
        const allergenFlags = this.detectAllergens(food.name, food.allergenFlags);
        const nutritionTags = this.calculateNutritionTags({
            calories: food.calories,
            proteinG: food.proteinG ? Number(food.proteinG) : null,
            carbsG: food.carbsG ? Number(food.carbsG) : null,
            fatsG: food.fatsG ? Number(food.fatsG) : null,
            fiberG: food.fiberG ? Number(food.fiberG) : null,
            sugarG: food.sugarG ? Number(food.sugarG) : null,
            sodiumMg: food.sodiumMg ? Number(food.sodiumMg) : null,
        });
        const healthFlags = this.calculateHealthFlags({
            ...food,
            proteinG: food.proteinG ? Number(food.proteinG) : null,
            carbsG: food.carbsG ? Number(food.carbsG) : null,
            fatsG: food.fatsG ? Number(food.fatsG) : null,
            sugarG: food.sugarG ? Number(food.sugarG) : null,
            sodiumMg: food.sodiumMg ? Number(food.sodiumMg) : null,
        });

        const updated = await prisma.foodItem.update({
            where: { id: foodId },
            data: {
                dietaryCategory,
                allergenFlags,
                nutritionTags,
                healthFlags
            }
        });

        logger.info('Food item auto-tagged', {
            foodId,
            name: food.name,
            dietaryCategory,
            allergenFlags,
            nutritionTags: nutritionTags.length,
            healthFlags: healthFlags.length
        });

        return updated;
    }

    /**
     * Bulk auto-tag all food items (or a subset)
     */
    async bulkAutoTag(options: { orgId?: string; limit?: number } = {}): Promise<{
        processed: number;
        updated: number;
    }> {
        const where: any = {};
        if (options.orgId) {
            where.orgId = options.orgId;
        }

        const foods = await prisma.foodItem.findMany({
            where,
            take: options.limit || 1000
        });

        let updated = 0;

        for (const food of foods) {
            try {
                await this.autoTagFood(food.id);
                updated++;
            } catch (error) {
                logger.warn('Failed to auto-tag food', { foodId: food.id, error });
            }
        }

        return { processed: foods.length, updated };
    }

    /**
     * Update specific tags for a food item
     */
    async updateFoodTags(foodId: string, tags: {
        dietaryCategory?: string;
        allergenFlags?: string[];
        nutritionTags?: string[];
        healthFlags?: string[];
        cuisineTags?: string[];
        processingLevel?: string;
        mealSuitabilityTags?: string[];
    }): Promise<any> {
        const updated = await prisma.foodItem.update({
            where: { id: foodId },
            data: tags
        });

        logger.info('Food tags updated', { foodId, tags: Object.keys(tags) });

        return updated;
    }
}

// Export singleton instance
export const foodTaggingService = new FoodTaggingService();
</file>

<file path="backend/src/services/lab.service.ts">
/**
 * Lab Values Service
 * Handles saving lab results, auto-deriving risk tags, syncing to Client
 */

import prisma from '../utils/prisma';
import { LAB_REFERENCE_RANGES, VALID_LAB_KEYS } from '../utils/lab-reference-ranges';
import { validationEngine } from './validationEngine.service';
import { AppError } from '../errors/AppError';
import logger from '../utils/logger';
import type { LabAlert } from '../types/medical.types';

interface SaveLabValuesInput {
    clientId: string;
    orgId: string;
    userId: string;
    labValues: Record<string, number>;
    labDate: string;
}

class LabService {
    /**
     * Save lab values, auto-derive risk tags, sync to Client table
     */
    async saveLabValues(input: SaveLabValuesInput) {
        const { clientId, orgId, userId, labValues, labDate } = input;

        // Verify client belongs to org
        const client = await prisma.client.findFirst({
            where: { id: clientId, orgId, isActive: true },
        });
        if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        // Validate lab value keys
        const cleanedValues: Record<string, number> = {};
        for (const [key, value] of Object.entries(labValues)) {
            if (!VALID_LAB_KEYS.includes(key)) continue;
            if (typeof value !== 'number' || isNaN(value) || value < 0) continue;
            cleanedValues[key] = value;
        }

        if (Object.keys(cleanedValues).length === 0) {
            throw AppError.badRequest('No valid lab values provided');
        }

        // Derive risk tags
        const { derivedTags, alerts } = this.deriveRiskFlags(cleanedValues);

        // Upsert MedicalProfile with lab data
        const medicalProfile = await prisma.medicalProfile.upsert({
            where: { clientId },
            create: {
                clientId,
                labValues: cleanedValues,
                labDate: new Date(labDate),
                labDerivedTags: derivedTags,
                updatedByUserId: userId,
            },
            update: {
                labValues: cleanedValues,
                labDate: new Date(labDate),
                labDerivedTags: derivedTags,
                updatedByUserId: userId,
            },
        });

        // Sync derived tags to Client table for validation engine
        await prisma.client.update({
            where: { id: clientId },
            data: { labDerivedTags: derivedTags },
        });

        // Invalidate validation cache so next food validation uses new tags
        validationEngine.invalidateClientCache(clientId);

        logger.info('Lab values saved', {
            clientId,
            derivedTags,
            alertCount: alerts.filter(a => a.status !== 'normal').length,
        });

        return { medicalProfile, alerts, derivedTags };
    }

    /**
     * Get lab values with computed alerts for a client
     */
    async getLabValues(clientId: string, orgId: string) {
        const client = await prisma.client.findFirst({
            where: { id: clientId, orgId, isActive: true },
            select: { id: true },
        });
        if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        const profile = await prisma.medicalProfile.findUnique({
            where: { clientId },
            select: {
                labValues: true,
                labDate: true,
                labDerivedTags: true,
            },
        });

        if (!profile?.labValues) {
            return { labValues: null, labDate: null, alerts: [], derivedTags: [] };
        }

        const labValues = profile.labValues as Record<string, number>;
        const { alerts, derivedTags } = this.deriveRiskFlags(labValues);

        return {
            labValues,
            labDate: profile.labDate,
            alerts,
            derivedTags,
        };
    }

    /**
     * Pure function: derive risk tags and alerts from raw lab values
     */
    deriveRiskFlags(labValues: Record<string, number>): {
        derivedTags: string[];
        alerts: LabAlert[];
    } {
        const derivedTags = new Set<string>();
        const alerts: LabAlert[] = [];

        for (const [key, value] of Object.entries(labValues)) {
            if (value === null || value === undefined) continue;

            const range = LAB_REFERENCE_RANGES[key];
            if (!range) continue;

            // Determine status
            let status: LabAlert['status'] = 'normal';
            let derivedTag: string | undefined;

            // Check critical ranges first
            if (range.criticalHigh && value >= range.criticalHigh[0]) {
                status = 'critical';
            } else if (range.criticalLow && value <= range.criticalLow[1]) {
                status = 'critical';
            } else if (range.warningHigh && value >= range.warningHigh[0]) {
                status = 'warning';
            } else if (range.warningLow && value <= range.warningLow[1]) {
                status = 'warning';
            } else if (range.optimal && value >= range.optimal[0] && value <= range.optimal[1]) {
                status = 'optimal';
            }

            // Run derivation rules
            for (const rule of range.derivedTags) {
                if (rule.condition(value)) {
                    derivedTags.add(rule.tag);
                    derivedTag = rule.tag;
                }
            }

            const normalRange = `${range.normal[0]}–${range.normal[1]} ${range.unit}`;

            alerts.push({
                name: range.name,
                value,
                unit: range.unit,
                status,
                normalRange,
                derivedTag,
            });
        }

        return {
            derivedTags: Array.from(derivedTags),
            alerts,
        };
    }
}

export const labService = new LabService();
</file>

<file path="backend/src/services/meal.service.ts">
import prisma from '../utils/prisma';
import { AppError } from '../errors/AppError';
import logger from '../utils/logger';

export class MealService {
    async addMealToPlan(body: any, orgId: string) {
        const { planId, dayIndex, mealDate, mealType, timeOfDay, title, description, instructions, foodItems } = body;

        if (!planId || !mealType || !title) {
            throw AppError.badRequest('planId, mealType, and title are required', 'MISSING_FIELDS');
        }

        const plan = await prisma.dietPlan.findFirst({ where: { id: planId, orgId } });
        if (!plan) throw AppError.notFound('Diet plan not found', 'PLAN_NOT_FOUND');

        const meal = await prisma.meal.create({
            data: {
                planId,
                dayOfWeek: dayIndex,
                mealDate: mealDate ? new Date(mealDate) : null,
                mealType,
                timeOfDay,
                name: title,
                description,
                instructions,
                foodItems: foodItems?.length
                    ? {
                          create: foodItems.map((item: any, sortOrder: number) => ({
                              foodId: item.foodId,
                              quantityG: item.quantity,
                              notes: item.notes,
                              sortOrder,
                              optionGroup: item.optionGroup ?? 0,
                              optionLabel: item.optionLabel ?? null,
                          })),
                      }
                    : undefined,
            },
            include: { foodItems: { orderBy: [{ optionGroup: 'asc' }, { sortOrder: 'asc' }], include: { foodItem: true } } },
        });

        logger.info('Meal added to plan', { mealId: meal.id, planId });
        return meal;
    }

    async updateMeal(mealId: string, body: any, orgId: string) {
        const { title, description, instructions, timeOfDay } = body;

        const meal = await prisma.meal.findUnique({
            where: { id: mealId },
            include: { dietPlan: true },
        });

        if (!meal || meal.dietPlan.orgId !== orgId) {
            throw AppError.notFound('Meal not found', 'MEAL_NOT_FOUND');
        }

        const updated = await prisma.meal.update({
            where: { id: mealId },
            data: {
                ...(title && { name: title }),
                ...(description !== undefined && { description }),
                ...(instructions !== undefined && { instructions }),
                ...(timeOfDay !== undefined && { timeOfDay }),
            },
        });

        logger.info('Meal updated', { mealId: updated.id });
        return updated;
    }

    async deleteMeal(mealId: string, orgId: string) {
        const meal = await prisma.meal.findUnique({
            where: { id: mealId },
            include: { dietPlan: true },
        });

        if (!meal || meal.dietPlan.orgId !== orgId) {
            throw AppError.notFound('Meal not found', 'MEAL_NOT_FOUND');
        }

        await prisma.meal.delete({ where: { id: mealId } });
        logger.info('Meal deleted', { mealId });
    }
}

export const mealService = new MealService();
</file>

<file path="backend/src/services/notification.service.ts">
import prisma from '../utils/prisma';
import logger from '../utils/logger';
// import { Expo } from 'expo-server-sdk'; // TODO: Install expo-server-sdk

// const expo = new Expo();

export class NotificationService {

    /**
     * registerDeviceToken
     * Adds a push token to the user or client profile
     */
    async registerDeviceToken(entityId: string, entityType: 'client' | 'user', token: string) {
        if (entityType === 'client') {
            const client = await prisma.client.findUnique({ where: { id: entityId } });
            if (!client) return;
            const tokens = new Set(client.pushTokens);
            tokens.add(token);
            await prisma.client.update({
                where: { id: entityId },
                data: { pushTokens: Array.from(tokens) }
            });
        } else {
            const user = await prisma.user.findUnique({ where: { id: entityId } });
            if (!user) return;
            const tokens = new Set(user.pushTokens);
            tokens.add(token);
            await prisma.user.update({
                where: { id: entityId },
                data: { pushTokens: Array.from(tokens) }
            });
        }
        logger.info('Device token registered', { entityId, entityType });
    }

    /**
     * sendNotification
     * Sends a push notification and saves to DB
     */
    async sendNotification(
        recipientId: string,
        recipientType: 'client' | 'user',
        orgId: string,
        title: string,
        message: string,
        data: any = {},
        category?: string
    ) {
        // 1. Save to DB
        const notification = await prisma.notification.create({
            data: {
                recipientId,
                recipientType: recipientType === 'client' ? 'client' : 'user',
                orgId,
                type: 'push',
                category,
                title,
                message,
                relatedEntityType: data.entityType,
                relatedEntityId: data.entityId,
                deliveryStatus: 'pending'
            }
        });

        // 2. Get tokens
        let tokens: string[] = [];
        if (recipientType === 'client') {
            const client = await prisma.client.findUnique({ where: { id: recipientId } });
            tokens = client?.pushTokens || [];
        } else {
            const user = await prisma.user.findUnique({ where: { id: recipientId } });
            tokens = user?.pushTokens || [];
        }

        if (tokens.length === 0) {
            logger.warn('No tokens found for recipient', { recipientId });
            return notification;
        }

        // 3. Send via Expo (Placeholder)
        // const messages = tokens.map(token => ({
        //     to: token,
        //     sound: 'default',
        //     title,
        //     body: message,
        //     data: { ...data, notificationId: notification.id },
        // }));

        // await expo.sendPushNotificationsAsync(messages);

        logger.info('Notification sent (simulated)', { recipientId, title });

        // Update status
        await prisma.notification.update({
            where: { id: notification.id },
            data: { deliveryStatus: 'delivered', sentViaChannels: ['push_simulated'] }
        });

        return notification;
    }
}

export const notificationService = new NotificationService();
</file>

<file path="backend/src/services/storage.service.ts">
import { S3Client, PutObjectCommand, DeleteObjectCommand, GetObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';
import sharp from 'sharp';
import logger from '../utils/logger';

// S3/Garage Configuration
const s3Client = new S3Client({
    endpoint: process.env.S3_ENDPOINT || 'http://localhost:3900',
    region: process.env.S3_REGION || 'garage',
    credentials: {
        accessKeyId: process.env.S3_ACCESS_KEY || '',
        secretAccessKey: process.env.S3_SECRET_KEY || ''
    },
    forcePathStyle: true // Required for Garage/MinIO
});

const BUCKET = process.env.S3_BUCKET || 'dietkaro-media';

// Default presigned URL expiration (1 hour)
const PRESIGNED_URL_EXPIRY = 3600;

// Image processing options
const COMPRESSION_QUALITY = 80;
const THUMBNAIL_SIZE = 200;
const MAX_WIDTH = 1920;

/**
 * Compress image to JPEG with quality optimization
 */
export async function compressImage(buffer: Buffer): Promise<Buffer> {
    return sharp(buffer)
        .rotate() // Auto-rotate based on EXIF
        .resize(MAX_WIDTH, MAX_WIDTH, {
            fit: 'inside',
            withoutEnlargement: true
        })
        .jpeg({ quality: COMPRESSION_QUALITY, progressive: true })
        .toBuffer();
}

/**
 * Create thumbnail from image
 */
export async function createThumbnail(buffer: Buffer, size: number = THUMBNAIL_SIZE): Promise<Buffer> {
    return sharp(buffer)
        .rotate()
        .resize(size, size, {
            fit: 'cover',
            position: 'center'
        })
        .jpeg({ quality: 75 })
        .toBuffer();
}

/**
 * Upload buffer to S3/Garage and return the key
 */
export async function uploadToS3(
    buffer: Buffer,
    key: string,
    contentType: string = 'image/jpeg'
): Promise<string> {
    const command = new PutObjectCommand({
        Bucket: BUCKET,
        Key: key,
        Body: buffer,
        ContentType: contentType
    });

    await s3Client.send(command);
    logger.info('Uploaded to S3', { key });

    return key;
}

/**
 * Generate presigned URL for reading an object
 */
export async function getPresignedUrl(key: string, expiresIn: number = PRESIGNED_URL_EXPIRY): Promise<string> {
    const command = new GetObjectCommand({
        Bucket: BUCKET,
        Key: key
    });

    const url = await getSignedUrl(s3Client, command, { expiresIn });
    return url;
}

/**
 * Generate presigned URLs for multiple keys
 */
export async function getPresignedUrls(keys: string[], expiresIn: number = PRESIGNED_URL_EXPIRY): Promise<Record<string, string>> {
    const urls: Record<string, string> = {};

    await Promise.all(
        keys.map(async (key) => {
            if (key) {
                urls[key] = await getPresignedUrl(key, expiresIn);
            }
        })
    );

    return urls;
}

/**
 * Delete object from S3/Garage
 */
export async function deleteFromS3(key: string): Promise<void> {
    const command = new DeleteObjectCommand({
        Bucket: BUCKET,
        Key: key
    });

    await s3Client.send(command);
    logger.info('Deleted from S3', { key });
}

/**
 * Process and upload image with compression + thumbnail
 * Returns keys for generating presigned URLs later
 */
export async function processAndUploadImage(
    buffer: Buffer,
    prefix: 'meal-photos' | 'weight-photos',
    orgId: string,
    entityId: string
): Promise<{ fullUrl: string; thumbUrl: string; fullKey: string; thumbKey: string }> {
    // Generate keys
    const timestamp = Date.now();
    const fullKey = `${prefix}/${orgId}/${entityId}/${timestamp}-full.jpg`;
    const thumbKey = `${prefix}/${orgId}/${entityId}/${timestamp}-thumb.jpg`;

    // Process images
    const [compressedBuffer, thumbnailBuffer] = await Promise.all([
        compressImage(buffer),
        createThumbnail(buffer)
    ]);

    // Upload both
    await Promise.all([
        uploadToS3(compressedBuffer, fullKey),
        uploadToS3(thumbnailBuffer, thumbKey)
    ]);

    // Generate media proxy URLs (these work without presigning)
    const baseUrl = process.env.API_BASE_URL || 'http://localhost:3000';
    const fullUrl = `${baseUrl}/media/${fullKey}`;
    const thumbUrl = `${baseUrl}/media/${thumbKey}`;

    logger.info('Image processed and uploaded', {
        prefix,
        entityId,
        originalSize: buffer.length,
        compressedSize: compressedBuffer.length,
        thumbnailSize: thumbnailBuffer.length,
        compressionRatio: Math.round((1 - compressedBuffer.length / buffer.length) * 100) + '%'
    });

    return { fullUrl, thumbUrl, fullKey, thumbKey };
}

/**
 * Storage service interface for controllers
 */
export const StorageService = {
    uploadMealPhoto: async (buffer: Buffer, orgId: string, mealLogId: string) => {
        return processAndUploadImage(buffer, 'meal-photos', orgId, mealLogId);
    },

    uploadWeightPhoto: async (buffer: Buffer, orgId: string, weightLogId: string) => {
        return processAndUploadImage(buffer, 'weight-photos', orgId, weightLogId);
    },

    getPresignedUrl,
    getPresignedUrls,

    deleteImage: async (key: string) => {
        return deleteFromS3(key);
    }
};

export default StorageService;
</file>

<file path="backend/src/services/weightLog.service.ts">
import prisma from '../utils/prisma';
import { AppError } from '../errors/AppError';
import logger from '../utils/logger';
import { buildPaginationParams, buildPaginationMeta, buildDateFilter } from '../utils/queryFilters';
import { CreateWeightLogInput } from '../schemas/weightLog.schema';

export class WeightLogService {
    async createWeightLog(data: CreateWeightLogInput, clientId: string, orgId: string) {
        const client = await prisma.client.findFirst({ where: { id: clientId, orgId } });
        if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        let bmi: number | null = null;
        if (client.heightCm) {
            const heightM = Number(client.heightCm) / 100;
            bmi = Math.round((data.weightKg / (heightM * heightM)) * 10) / 10;
        }

        const previousLog = await prisma.weightLog.findFirst({
            where: { clientId },
            orderBy: { logDate: 'desc' },
        });

        let weightChange: number | null = null;
        if (previousLog) {
            weightChange = Math.round((data.weightKg - Number(previousLog.weightKg)) * 100) / 100;
        }

        const isOutlier = weightChange !== null && Math.abs(weightChange) > 3;

        const weightLog = await prisma.weightLog.create({
            data: {
                orgId,
                clientId,
                logDate: new Date(data.logDate),
                logTime: data.logTime,
                weightKg: data.weightKg,
                bmi,
                weightChangeFromPrevious: weightChange,
                notes: data.notes,
                progressPhotoUrl: data.progressPhotoUrl,
                isOutlier,
            },
        });

        await prisma.client.update({
            where: { id: clientId },
            data: { currentWeightKg: data.weightKg },
        });

        logger.info('Weight log created', { weightLogId: weightLog.id, clientId, weightKg: data.weightKg });

        return {
            id: weightLog.id,
            clientId: weightLog.clientId,
            logDate: weightLog.logDate,
            logTime: weightLog.logTime,
            weightKg: Number(weightLog.weightKg),
            bmi: weightLog.bmi ? Number(weightLog.bmi) : null,
            weightChange: weightLog.weightChangeFromPrevious ? Number(weightLog.weightChangeFromPrevious) : null,
            notes: weightLog.notes,
            isOutlier: weightLog.isOutlier,
            createdAt: weightLog.createdAt,
        };
    }

    async listWeightLogs(clientId: string, orgId: string, query: any) {
        const client = await prisma.client.findFirst({ where: { id: clientId, orgId } });
        if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        const pagination = buildPaginationParams(query.page, query.pageSize || '100');
        const dateFilter = buildDateFilter(query.dateFrom, query.dateTo);

        const where: any = { clientId, orgId };
        if (dateFilter) where.logDate = dateFilter;

        const [weightLogs, total] = await prisma.$transaction([
            prisma.weightLog.findMany({
                where,
                skip: pagination.skip,
                take: pagination.take,
                orderBy: { [String(query.sortBy || 'logDate')]: 'asc' },
            }),
            prisma.weightLog.count({ where }),
        ]);

        let totalStartWeight: number | null = null;
        let totalEndWeight: number | null = null;
        let totalWeightLoss: number | null = null;
        let averageWeightLossPerWeek: number | null = null;

        if (weightLogs.length > 0) {
            totalStartWeight = Number(weightLogs[0].weightKg);
            totalEndWeight = Number(weightLogs[weightLogs.length - 1].weightKg);
            totalWeightLoss = Math.round((totalStartWeight - totalEndWeight) * 100) / 100;

            const firstDate = new Date(weightLogs[0].logDate);
            const lastDate = new Date(weightLogs[weightLogs.length - 1].logDate);
            const weeksDiff = Math.max(1, Math.round((lastDate.getTime() - firstDate.getTime()) / (7 * 24 * 60 * 60 * 1000)));
            averageWeightLossPerWeek = Math.round((totalWeightLoss / weeksDiff) * 100) / 100;
        }

        return {
            data: weightLogs.map((log) => ({
                id: log.id,
                logDate: log.logDate,
                logTime: log.logTime,
                weightKg: Number(log.weightKg),
                bmi: log.bmi ? Number(log.bmi) : null,
                weightChange: log.weightChangeFromPrevious ? Number(log.weightChangeFromPrevious) : null,
                notes: log.notes,
                progressPhotoUrl: log.progressPhotoUrl,
                isOutlier: log.isOutlier,
            })),
            meta: {
                ...buildPaginationMeta(total, pagination),
                totalStartWeight,
                totalEndWeight,
                totalWeightLoss,
                averageWeightLossPerWeek,
            },
        };
    }

    async uploadProgressPhoto(weightLogId: string, fileBuffer: Buffer, fileSize: number, orgId: string) {
        const weightLog = await prisma.weightLog.findFirst({ where: { id: weightLogId, orgId } });
        if (!weightLog) throw AppError.notFound('Weight log not found', 'WEIGHT_LOG_NOT_FOUND');

        const { StorageService } = await import('./storage.service');

        const { fullUrl, thumbUrl } = await StorageService.uploadWeightPhoto(fileBuffer, orgId, weightLogId);

        const updated = await prisma.weightLog.update({
            where: { id: weightLogId },
            data: { progressPhotoUrl: fullUrl },
        });

        logger.info('Progress photo uploaded', { weightLogId, fullUrl, thumbUrl, originalSize: fileSize });

        return {
            id: updated.id,
            progressPhotoUrl: updated.progressPhotoUrl,
            progressPhotoThumbUrl: thumbUrl,
        };
    }
}

export const weightLogService = new WeightLogService();
</file>

<file path="backend/src/types/auth.types.ts">
import { Request } from 'express';
import { User } from '@prisma/client';

export interface AuthenticatedUser {
    id: string;
    clerkUserId: string;
    organizationId: string;
    role: string;
    email: string;
    fullName: string;
}

export interface AuthenticatedRequest extends Request {
    user?: AuthenticatedUser;
    dbUser?: User;
}
</file>

<file path="backend/src/types/medical.types.ts">
/**
 * Medical & Lab Values Types
 * Used by lab service, medical summary, and validation engine
 */

// ============ LAB VALUES ============

export interface LabValues {
    // Diabetes markers
    hba1c?: number;
    fastingGlucose?: number;
    postprandialGlucose?: number;

    // Lipid profile
    totalCholesterol?: number;
    ldl?: number;
    hdl?: number;
    triglycerides?: number;
    vldl?: number;

    // Vitamins & minerals
    vitaminD?: number;
    vitaminB12?: number;
    iron?: number;
    ferritin?: number;
    calcium?: number;

    // Thyroid
    tsh?: number;
    t3?: number;
    t4?: number;

    // Kidney function
    creatinine?: number;
    bun?: number;
    uricAcid?: number;

    // Liver function
    sgot?: number;
    sgpt?: number;

    // Blood
    hemoglobin?: number;
}

// ============ LAB ALERT ============

export interface LabAlert {
    name: string;
    value: number;
    unit: string;
    status: 'critical' | 'warning' | 'normal' | 'optimal';
    normalRange: string;
    derivedTag?: string;
}

// ============ MEDICAL SUMMARY ============

export interface MedicalSummary {
    // From Client table
    allergies: string[];
    intolerances: string[];
    dietPattern: string | null;
    eggAllowed: boolean;
    eggAvoidDays: string[];
    medicalConditions: string[];
    dislikes: string[];
    likedFoods: string[];
    avoidCategories: string[];

    // From MedicalProfile table
    diagnoses: string[];
    medications: string[];
    supplements: string[];
    surgeries: string[];
    familyHistory: string | null;
    healthNotes: string | null;

    // Lab data
    labAlerts: LabAlert[];
    labDate: string | null;
    labDerivedTags: string[];

    // Computed
    criticalCount: number;
    warningCount: number;
    lastUpdated: string;
}

// ============ LAB REFERENCE RANGE ============

export interface LabRange {
    name: string;
    unit: string;
    optimal?: [number, number];
    normal: [number, number];
    warningLow?: [number, number];
    warningHigh?: [number, number];
    criticalLow?: [number, number];
    criticalHigh?: [number, number];
    derivedTags: {
        condition: (value: number) => boolean;
        tag: string;
    }[];
}
</file>

<file path="backend/src/utils/asyncHandler.ts">
import { Request, Response, NextFunction, RequestHandler } from 'express';

/**
 * Wraps async route handlers to catch errors and pass them to next()
 * Eliminates the need for try-catch in every controller
 */
export const asyncHandler = (fn: RequestHandler): RequestHandler => {
    return (req: Request, res: Response, next: NextFunction) => {
        Promise.resolve(fn(req, res, next)).catch(next);
    };
};
</file>

<file path="backend/src/utils/emailService.ts">
import nodemailer from 'nodemailer';
import logger from './logger';

interface EmailOptions {
    to: string;
    subject: string;
    html: string;
    attachments?: Array<{
        filename: string;
        content: Buffer | string;
        contentType?: string;
    }>;
}

// Create transporter - uses environment variables for configuration
const createTransporter = () => {
    // For production, use actual SMTP credentials
    if (process.env.SMTP_HOST) {
        return nodemailer.createTransport({
            host: process.env.SMTP_HOST,
            port: parseInt(process.env.SMTP_PORT || '587'),
            secure: process.env.SMTP_SECURE === 'true',
            auth: {
                user: process.env.SMTP_USER,
                pass: process.env.SMTP_PASS,
            },
        });
    }

    // For development, use ethereal email (fake SMTP for testing)
    logger.warn('No SMTP configuration found, emails will be logged only');
    return null;
};

export async function sendEmail(options: EmailOptions): Promise<boolean> {
    const transporter = createTransporter();

    const mailOptions = {
        from: process.env.EMAIL_FROM || '"DietKaro" <noreply@dietkaro.com>',
        to: options.to,
        subject: options.subject,
        html: options.html,
        attachments: options.attachments,
    };

    if (!transporter) {
        // Development mode - just log the email
        logger.info('Email would be sent (dev mode):', {
            to: options.to,
            subject: options.subject,
            hasAttachments: !!options.attachments?.length,
        });
        return true;
    }

    try {
        const info = await transporter.sendMail(mailOptions);
        logger.info('Email sent successfully', {
            messageId: info.messageId,
            to: options.to,
        });
        return true;
    } catch (error) {
        logger.error('Failed to send email', { error, to: options.to });
        return false;
    }
}

export function generateDietPlanEmailHtml(
    planName: string,
    clientName: string,
    dietitianName: string,
    previewUrl?: string
): string {
    return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #111827; max-width: 600px; margin: 0 auto; padding: 20px;">
    <div style="text-align: center; padding: 20px 0;">
        <h1 style="color: #17cf54; margin: 0;">🥗 DietKaro</h1>
    </div>
    
    <div style="background: #f9fafb; border-radius: 12px; padding: 24px; margin: 20px 0;">
        <h2 style="margin-top: 0;">Hello ${clientName}! 👋</h2>
        <p>Your personalized diet plan <strong>"${planName}"</strong> is ready!</p>
        <p>Your dietitian ${dietitianName} has created this plan especially for you. Please find your detailed meal plan attached as a PDF.</p>
    </div>
    
    ${previewUrl ? `
    <div style="text-align: center; margin: 24px 0;">
        <a href="${previewUrl}" style="display: inline-block; background: #17cf54; color: #111827; text-decoration: none; padding: 12px 32px; border-radius: 8px; font-weight: 600;">View Online</a>
    </div>
    ` : ''}
    
    <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; margin: 20px 0;">
        <h3 style="margin-top: 0; font-size: 14px; color: #6b7280;">Tips for Success:</h3>
        <ul style="margin: 0; padding-left: 20px; color: #374151;">
            <li>Follow the meal times as closely as possible</li>
            <li>Stay hydrated - drink at least 2-3 liters of water daily</li>
            <li>Log your meals in the app to track progress</li>
            <li>Reach out to your dietitian if you have questions</li>
        </ul>
    </div>
    
    <div style="text-align: center; padding: 20px 0; color: #9ca3af; font-size: 12px;">
        <p>This email was sent by DietKaro on behalf of ${dietitianName}</p>
        <p>If you have questions, contact your dietitian or reply to this email.</p>
    </div>
</body>
</html>`;
}
</file>

<file path="backend/src/utils/lab-reference-ranges.ts">
/**
 * Lab Reference Ranges and Risk Flag Derivation Rules
 * Used by LabService to auto-derive health risk tags from lab values
 */

import { LabRange } from '../types/medical.types';

export const LAB_REFERENCE_RANGES: Record<string, LabRange> = {
    // ============ DIABETES MARKERS ============

    hba1c: {
        name: 'HbA1c',
        unit: '%',
        normal: [0, 5.6],
        warningHigh: [5.7, 6.4],
        criticalHigh: [6.5, 20],
        derivedTags: [
            { condition: (v) => v >= 6.5, tag: 'diabetic' },
            { condition: (v) => v >= 5.7 && v < 6.5, tag: 'pre_diabetic' },
        ],
    },
    fastingGlucose: {
        name: 'Fasting Glucose',
        unit: 'mg/dL',
        normal: [70, 99],
        warningHigh: [100, 125],
        criticalHigh: [126, 500],
        criticalLow: [0, 54],
        derivedTags: [
            { condition: (v) => v >= 126, tag: 'diabetic' },
            { condition: (v) => v >= 100 && v < 126, tag: 'pre_diabetic' },
        ],
    },
    postprandialGlucose: {
        name: 'PP Glucose',
        unit: 'mg/dL',
        normal: [70, 139],
        warningHigh: [140, 199],
        criticalHigh: [200, 600],
        derivedTags: [
            { condition: (v) => v >= 200, tag: 'diabetic' },
            { condition: (v) => v >= 140 && v < 200, tag: 'pre_diabetic' },
        ],
    },

    // ============ LIPID PROFILE ============

    totalCholesterol: {
        name: 'Total Cholesterol',
        unit: 'mg/dL',
        normal: [0, 199],
        warningHigh: [200, 239],
        criticalHigh: [240, 500],
        derivedTags: [
            { condition: (v) => v >= 240, tag: 'high_cholesterol' },
            { condition: (v) => v >= 200 && v < 240, tag: 'borderline_cholesterol' },
        ],
    },
    ldl: {
        name: 'LDL Cholesterol',
        unit: 'mg/dL',
        normal: [0, 99],
        warningHigh: [100, 159],
        criticalHigh: [160, 500],
        derivedTags: [
            { condition: (v) => v >= 160, tag: 'high_cholesterol' },
        ],
    },
    hdl: {
        name: 'HDL Cholesterol',
        unit: 'mg/dL',
        optimal: [60, 200],
        normal: [40, 200],
        warningLow: [30, 39],
        criticalLow: [0, 29],
        derivedTags: [
            { condition: (v) => v < 40, tag: 'low_hdl' },
        ],
    },
    triglycerides: {
        name: 'Triglycerides',
        unit: 'mg/dL',
        normal: [0, 149],
        warningHigh: [150, 199],
        criticalHigh: [200, 2000],
        derivedTags: [
            { condition: (v) => v >= 200, tag: 'high_triglycerides' },
        ],
    },
    vldl: {
        name: 'VLDL',
        unit: 'mg/dL',
        normal: [5, 30],
        warningHigh: [31, 40],
        criticalHigh: [41, 200],
        derivedTags: [],
    },

    // ============ VITAMINS & MINERALS ============

    vitaminD: {
        name: 'Vitamin D',
        unit: 'ng/mL',
        optimal: [40, 100],
        normal: [30, 100],
        warningLow: [20, 29],
        criticalLow: [0, 19],
        derivedTags: [
            { condition: (v) => v < 20, tag: 'severe_vitamin_d_deficiency' },
            { condition: (v) => v < 30, tag: 'vitamin_d_deficiency' },
        ],
    },
    vitaminB12: {
        name: 'Vitamin B12',
        unit: 'pg/mL',
        normal: [200, 900],
        warningLow: [150, 199],
        criticalLow: [0, 149],
        derivedTags: [
            { condition: (v) => v < 200, tag: 'b12_deficiency' },
        ],
    },
    iron: {
        name: 'Iron',
        unit: 'mcg/dL',
        normal: [60, 170],
        warningLow: [40, 59],
        criticalLow: [0, 39],
        derivedTags: [
            { condition: (v) => v < 60, tag: 'iron_deficiency' },
        ],
    },
    ferritin: {
        name: 'Ferritin',
        unit: 'ng/mL',
        normal: [12, 300],
        warningLow: [8, 11],
        criticalLow: [0, 7],
        derivedTags: [
            { condition: (v) => v < 12, tag: 'iron_deficiency' },
        ],
    },
    calcium: {
        name: 'Calcium',
        unit: 'mg/dL',
        normal: [8.5, 10.5],
        warningLow: [7.5, 8.4],
        criticalLow: [0, 7.4],
        warningHigh: [10.6, 12.0],
        criticalHigh: [12.1, 20],
        derivedTags: [
            { condition: (v) => v < 8.5, tag: 'calcium_deficiency' },
        ],
    },

    // ============ THYROID ============

    tsh: {
        name: 'TSH',
        unit: 'mIU/L',
        normal: [0.4, 4.0],
        warningHigh: [4.1, 10.0],
        criticalHigh: [10.1, 100],
        warningLow: [0.1, 0.39],
        criticalLow: [0, 0.09],
        derivedTags: [
            { condition: (v) => v > 4.0, tag: 'hypothyroid' },
            { condition: (v) => v < 0.4, tag: 'hyperthyroid' },
        ],
    },
    t3: {
        name: 'T3',
        unit: 'ng/dL',
        normal: [80, 200],
        warningLow: [60, 79],
        criticalLow: [0, 59],
        derivedTags: [],
    },
    t4: {
        name: 'T4',
        unit: 'mcg/dL',
        normal: [5.0, 12.0],
        warningLow: [3.5, 4.9],
        criticalLow: [0, 3.4],
        derivedTags: [],
    },

    // ============ KIDNEY FUNCTION ============

    creatinine: {
        name: 'Creatinine',
        unit: 'mg/dL',
        normal: [0.6, 1.2],
        warningHigh: [1.3, 1.9],
        criticalHigh: [2.0, 20],
        derivedTags: [
            { condition: (v) => v > 1.2, tag: 'kidney_caution' },
        ],
    },
    bun: {
        name: 'BUN',
        unit: 'mg/dL',
        normal: [7, 20],
        warningHigh: [21, 30],
        criticalHigh: [31, 200],
        derivedTags: [],
    },
    uricAcid: {
        name: 'Uric Acid',
        unit: 'mg/dL',
        normal: [3.5, 7.2],
        warningHigh: [7.3, 9.0],
        criticalHigh: [9.1, 20],
        derivedTags: [
            { condition: (v) => v > 7.2, tag: 'high_uric_acid' },
        ],
    },

    // ============ LIVER FUNCTION ============

    sgot: {
        name: 'SGOT (AST)',
        unit: 'U/L',
        normal: [8, 45],
        warningHigh: [46, 100],
        criticalHigh: [101, 1000],
        derivedTags: [],
    },
    sgpt: {
        name: 'SGPT (ALT)',
        unit: 'U/L',
        normal: [7, 56],
        warningHigh: [57, 120],
        criticalHigh: [121, 1000],
        derivedTags: [],
    },

    // ============ BLOOD ============

    hemoglobin: {
        name: 'Hemoglobin',
        unit: 'g/dL',
        normal: [12, 17.5],
        warningLow: [10, 11.9],
        criticalLow: [0, 9.9],
        derivedTags: [
            { condition: (v) => v < 12, tag: 'anemia' },
        ],
    },
};

/**
 * Valid lab value keys for input validation
 */
export const VALID_LAB_KEYS = Object.keys(LAB_REFERENCE_RANGES);
</file>

<file path="backend/src/utils/logger.ts">
import winston from 'winston';
import path from 'path';

const { combine, timestamp, printf, colorize, errors } = winston.format;

// Custom format for console output
const consoleFormat = printf(({ level, message, timestamp, stack, ...meta }) => {
    const metaStr = Object.keys(meta).length ? JSON.stringify(meta) : '';
    if (stack) {
        return `${timestamp} [${level}]: ${message}\n${stack}`;
    }
    return `${timestamp} [${level}]: ${message} ${metaStr}`;
});

// Custom format for file/JSON output
const jsonFormat = printf(({ level, message, timestamp, ...meta }) => {
    return JSON.stringify({ timestamp, level, message, ...meta });
});

// Create logger instance
const logger = winston.createLogger({
    level: process.env.LOG_LEVEL || 'info',
    format: combine(
        timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
        errors({ stack: true })
    ),
    defaultMeta: { service: 'diet-connect-api' },
    transports: [
        // Console transport with colors
        new winston.transports.Console({
            format: combine(
                colorize(),
                consoleFormat
            )
        })
    ]
});

// Add file transport in production
if (process.env.NODE_ENV === 'production') {
    logger.add(new winston.transports.File({
        filename: path.join(process.cwd(), 'logs', 'error.log'),
        level: 'error',
        format: jsonFormat
    }));

    logger.add(new winston.transports.File({
        filename: path.join(process.cwd(), 'logs', 'combined.log'),
        format: jsonFormat
    }));
}

export default logger;
</file>

<file path="backend/src/utils/nutritionCalculator.ts">
/**
 * Shared nutrition calculation utilities
 * Eliminates duplication across controllers
 */

interface FoodNutrition {
    calories: number;
    proteinG: number | null | any;
    carbsG: number | null | any;
    fatsG: number | null | any;
    fiberG: number | null | any;
    servingSizeG: number | any;
}

export interface ScaledNutrition {
    calories: number;
    proteinG: number | null;
    carbsG: number | null;
    fatsG: number | null;
    fiberG: number | null;
}

/**
 * Scale nutrition values based on quantity vs serving size
 */
export function scaleNutrition(food: FoodNutrition, quantityG: number): ScaledNutrition {
    const servingSize = Number(food.servingSizeG) || 100;
    const multiplier = quantityG / servingSize;

    return {
        calories: Math.round(food.calories * multiplier),
        proteinG: food.proteinG != null ? Math.round(Number(food.proteinG) * multiplier * 10) / 10 : null,
        carbsG: food.carbsG != null ? Math.round(Number(food.carbsG) * multiplier * 10) / 10 : null,
        fatsG: food.fatsG != null ? Math.round(Number(food.fatsG) * multiplier * 10) / 10 : null,
        fiberG: food.fiberG != null ? Math.round(Number(food.fiberG) * multiplier * 10) / 10 : null,
    };
}

/**
 * Sum nutrition across multiple food items
 */
export function sumNutrition(items: ScaledNutrition[]): ScaledNutrition {
    return items.reduce(
        (totals, item) => ({
            calories: totals.calories + item.calories,
            proteinG: (totals.proteinG ?? 0) + (item.proteinG ?? 0),
            carbsG: (totals.carbsG ?? 0) + (item.carbsG ?? 0),
            fatsG: (totals.fatsG ?? 0) + (item.fatsG ?? 0),
            fiberG: (totals.fiberG ?? 0) + (item.fiberG ?? 0),
        }),
        { calories: 0, proteinG: 0, carbsG: 0, fatsG: 0, fiberG: 0 }
    );
}
</file>

<file path="backend/src/utils/pdfGenerator.ts">
import PDFDocument from 'pdfkit';
import { DietPlan, Meal, MealFoodItem, FoodItem, Client } from '@prisma/client';

type MealWithFoodItems = Meal & {
    foodItems: (MealFoodItem & { foodItem: FoodItem })[];
};

type DietPlanWithRelations = DietPlan & {
    client: Pick<Client, 'fullName' | 'currentWeightKg' | 'targetWeightKg'> | null;
    meals: MealWithFoodItems[];
};

const COLORS = {
    primary: '#17cf54',
    dark: '#111827',
    gray: '#6b7280',
    lightGray: '#e5e7eb',
};

const MEAL_TYPE_LABELS: Record<string, string> = {
    breakfast: '🌅 Breakfast',
    lunch: '☀️ Lunch',
    snack: '🍎 Snack',
    dinner: '🌙 Dinner',
};

export function generateDietPlanPDF(plan: DietPlanWithRelations): PDFKit.PDFDocument {
    const doc = new PDFDocument({
        size: 'A4',
        margins: { top: 50, bottom: 50, left: 50, right: 50 },
        info: {
            Title: `Diet Plan - ${plan.name}`,
            Author: 'DietKaro',
            Subject: 'Personalized Diet Plan',
        },
    });

    // Header
    doc.fontSize(24)
        .fillColor(COLORS.dark)
        .text(plan.name, { align: 'center' });

    if (plan.client?.fullName) {
        doc.fontSize(14)
            .fillColor(COLORS.gray)
            .text(`Prepared for: ${plan.client.fullName}`, { align: 'center' });
    }

    doc.moveDown();

    // Date Range
    const startDate = new Date(plan.startDate).toLocaleDateString('en-IN', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
    });
    const endDate = plan.endDate
        ? new Date(plan.endDate).toLocaleDateString('en-IN', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
        })
        : 'Ongoing';

    doc.fontSize(11)
        .fillColor(COLORS.gray)
        .text(`Duration: ${startDate} - ${endDate}`, { align: 'center' });

    doc.moveDown(2);

    // Nutritional Targets Card
    if (plan.targetCalories) {
        doc.rect(50, doc.y, 495, 80).fill('#f3f4f6');
        const boxY = doc.y + 15;

        doc.fillColor(COLORS.dark)
            .fontSize(12)
            .text('Daily Nutritional Targets', 60, boxY, { underline: true });

        const targetY = boxY + 25;
        const colWidth = 120;

        doc.fontSize(10).fillColor(COLORS.gray);
        doc.text(`Calories: ${plan.targetCalories || '-'} kcal`, 60, targetY);
        doc.text(`Protein: ${plan.targetProteinG || '-'} g`, 60 + colWidth, targetY);
        doc.text(`Carbs: ${plan.targetCarbsG || '-'} g`, 60 + colWidth * 2, targetY);
        doc.text(`Fats: ${plan.targetFatsG || '-'} g`, 60 + colWidth * 3, targetY);

        if (plan.targetFiberG) {
            doc.text(`Fiber: ${plan.targetFiberG} g`, 60, targetY + 20);
        }

        doc.y = boxY + 80;
    }

    doc.moveDown(2);

    // Group meals by day
    const mealsByDay = new Map<number, MealWithFoodItems[]>();
    plan.meals.forEach((meal) => {
        const day = meal.dayOfWeek ?? 0;
        if (!mealsByDay.has(day)) {
            mealsByDay.set(day, []);
        }
        mealsByDay.get(day)!.push(meal);
    });

    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    // Meals by Day
    Array.from(mealsByDay.entries())
        .sort(([a], [b]) => a - b)
        .forEach(([dayIndex, meals]) => {
            // Day Header
            doc.fontSize(16)
                .fillColor(COLORS.dark)
                .text(dayNames[dayIndex] || `Day ${dayIndex + 1}`, { underline: true });

            doc.moveDown(0.5);

            // Sort meals by type
            const mealOrder = ['breakfast', 'lunch', 'snack', 'dinner'];
            meals
                .sort((a, b) => mealOrder.indexOf(a.mealType) - mealOrder.indexOf(b.mealType))
                .forEach((meal) => {
                    // Meal Header
                    doc.fontSize(13)
                        .fillColor(COLORS.primary)
                        .text(MEAL_TYPE_LABELS[meal.mealType] || meal.mealType);

                    if (meal.timeOfDay) {
                        doc.fontSize(10)
                            .fillColor(COLORS.gray)
                            .text(`Time: ${meal.timeOfDay}`);
                    }

                    doc.fontSize(12)
                        .fillColor(COLORS.dark)
                        .text(meal.name);

                    if (meal.description) {
                        doc.fontSize(10)
                            .fillColor(COLORS.gray)
                            .text(meal.description);
                    }

                    // Food Items — grouped by optionGroup
                    if (meal.foodItems.length > 0) {
                        doc.moveDown(0.3);

                        // Group food items by optionGroup
                        const optionGroups = new Map<number, typeof meal.foodItems>();
                        meal.foodItems.forEach((item) => {
                            const group = (item as any).optionGroup ?? 0;
                            if (!optionGroups.has(group)) optionGroups.set(group, []);
                            optionGroups.get(group)!.push(item);
                        });

                        const sortedGroups = Array.from(optionGroups.entries()).sort(([a], [b]) => a - b);
                        const hasAlternatives = sortedGroups.length > 1;

                        sortedGroups.forEach(([groupNum, items], groupIndex) => {
                            if (hasAlternatives) {
                                const label = (items[0] as any).optionLabel || `Option ${String.fromCharCode(65 + groupNum)}`;
                                doc.fontSize(10)
                                    .fillColor(COLORS.primary)
                                    .text(`  ${label}:`);
                            }

                            items.forEach((item) => {
                                const foodName = item.foodItem?.name || 'Unknown food';
                                const quantity = item.quantityG ? `${item.quantityG}g` : '';
                                const calories = item.foodItem?.calories
                                    ? `${Math.round((item.foodItem.calories * (Number(item.quantityG) || 100)) / 100)} kcal`
                                    : '';

                                doc.fontSize(10)
                                    .fillColor(COLORS.dark)
                                    .text(`    • ${foodName} ${quantity}`, {
                                        continued: !!calories,
                                    });

                                if (calories) {
                                    doc.fillColor(COLORS.gray).text(` — ${calories}`);
                                }
                            });

                            // OR divider between option groups
                            if (hasAlternatives && groupIndex < sortedGroups.length - 1) {
                                doc.moveDown(0.2)
                                    .fontSize(9)
                                    .fillColor(COLORS.gray)
                                    .text('                         — OR —', { align: 'left' })
                                    .moveDown(0.2);
                            }
                        });
                    }

                    // Instructions
                    if (meal.instructions) {
                        doc.moveDown(0.3)
                            .fontSize(9)
                            .fillColor(COLORS.gray)
                            .text(`📝 ${meal.instructions}`);
                    }

                    doc.moveDown();
                });

            doc.moveDown();

            // Page break check
            if (doc.y > 700) {
                doc.addPage();
            }
        });

    // Notes for Client
    if (plan.notesForClient) {
        doc.addPage();
        doc.fontSize(16)
            .fillColor(COLORS.dark)
            .text('Notes & Guidelines', { underline: true });

        doc.moveDown()
            .fontSize(11)
            .fillColor(COLORS.gray)
            .text(plan.notesForClient, { align: 'left', lineGap: 4 });
    }

    // Footer on last page
    doc.fontSize(8)
        .fillColor(COLORS.lightGray)
        .text(
            `Generated by DietKaro on ${new Date().toLocaleDateString('en-IN')}`,
            50,
            780,
            { align: 'center', width: 495 }
        );

    return doc;
}

export function generateMealPlanPrintHtml(plan: DietPlanWithRelations): string {
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    // Group meals by day
    const mealsByDay = new Map<number, MealWithFoodItems[]>();
    plan.meals.forEach((meal) => {
        const day = meal.dayOfWeek ?? 0;
        if (!mealsByDay.has(day)) {
            mealsByDay.set(day, []);
        }
        mealsByDay.get(day)!.push(meal);
    });

    const mealOrder = ['breakfast', 'lunch', 'snack', 'dinner'];

    let daysHtml = '';
    Array.from(mealsByDay.entries())
        .sort(([a], [b]) => a - b)
        .forEach(([dayIndex, meals]) => {
            let mealsHtml = '';
            meals
                .sort((a, b) => mealOrder.indexOf(a.mealType) - mealOrder.indexOf(b.mealType))
                .forEach((meal) => {
                    // Group food items by optionGroup
                    const optionGroups = new Map<number, typeof meal.foodItems>();
                    meal.foodItems.forEach((item) => {
                        const group = (item as any).optionGroup ?? 0;
                        if (!optionGroups.has(group)) optionGroups.set(group, []);
                        optionGroups.get(group)!.push(item);
                    });

                    const sortedGroups = Array.from(optionGroups.entries()).sort(([a], [b]) => a - b);
                    const hasAlts = sortedGroups.length > 1;

                    let foodItemsHtml = '';
                    sortedGroups.forEach(([groupNum, items], groupIdx) => {
                        if (hasAlts) {
                            const label = (items[0] as any).optionLabel || `Option ${String.fromCharCode(65 + groupNum)}`;
                            foodItemsHtml += `<div class="option-label">${label}</div>`;
                        }
                        const listItems = items
                            .map((item) => {
                                const foodName = item.foodItem?.name || 'Unknown';
                                const qty = item.quantityG ? `${item.quantityG}g` : '';
                                return `<li>${foodName} ${qty}</li>`;
                            })
                            .join('');
                        foodItemsHtml += `<ul class="food-items">${listItems}</ul>`;

                        if (hasAlts && groupIdx < sortedGroups.length - 1) {
                            foodItemsHtml += `<div class="or-divider">— OR —</div>`;
                        }
                    });

                    mealsHtml += `
                    <div class="meal">
                        <div class="meal-type">${MEAL_TYPE_LABELS[meal.mealType] || meal.mealType}</div>
                        <div class="meal-name">${meal.name}</div>
                        ${meal.description ? `<p class="description">${meal.description}</p>` : ''}
                        ${foodItemsHtml}
                        ${meal.instructions ? `<p class="instructions">📝 ${meal.instructions}</p>` : ''}
                    </div>
                `;
                });

            daysHtml += `
            <div class="day">
                <h2>${dayNames[dayIndex] || `Day ${dayIndex + 1}`}</h2>
                ${mealsHtml}
            </div>
        `;
        });

    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diet Plan - ${plan.name}</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #111827; line-height: 1.5; padding: 40px; max-width: 800px; margin: 0 auto; }
        h1 { font-size: 28px; text-align: center; margin-bottom: 8px; }
        .subtitle { text-align: center; color: #6b7280; margin-bottom: 32px; }
        .targets { background: #f3f4f6; padding: 16px 24px; border-radius: 12px; display: flex; gap: 24px; justify-content: center; margin-bottom: 32px; flex-wrap: wrap; }
        .target { text-align: center; }
        .target-value { font-size: 24px; font-weight: 700; color: #17cf54; }
        .target-label { font-size: 12px; color: #6b7280; }
        .day { margin-bottom: 32px; page-break-inside: avoid; }
        .day h2 { font-size: 20px; border-bottom: 2px solid #17cf54; padding-bottom: 8px; margin-bottom: 16px; }
        .meal { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .meal-type { font-size: 14px; color: #17cf54; font-weight: 600; }
        .meal-name { font-size: 16px; font-weight: 600; margin: 4px 0; }
        .description { font-size: 14px; color: #6b7280; margin: 8px 0; }
        .food-items { margin: 12px 0; padding-left: 20px; }
        .food-items li { font-size: 14px; margin: 4px 0; }
        .instructions { font-size: 13px; color: #6b7280; font-style: italic; }
        .option-label { font-size: 13px; font-weight: 600; color: #17cf54; margin: 8px 0 4px 0; }
        .or-divider { text-align: center; color: #9ca3af; font-size: 12px; margin: 8px 0; font-weight: 500; }
        .notes { background: #f9fafb; padding: 20px; border-radius: 12px; margin-top: 32px; }
        .notes h3 { font-size: 16px; margin-bottom: 12px; }
        .notes p { font-size: 14px; color: #374151; }
        @media print { body { padding: 20px; } .day { page-break-inside: avoid; } }
    </style>
</head>
<body>
    <h1>${plan.name}</h1>
    ${plan.client?.fullName ? `<p class="subtitle">Prepared for: ${plan.client.fullName}</p>` : ''}
    
    ${plan.targetCalories ? `
    <div class="targets">
        <div class="target"><div class="target-value">${plan.targetCalories}</div><div class="target-label">Calories</div></div>
        ${plan.targetProteinG ? `<div class="target"><div class="target-value">${plan.targetProteinG}g</div><div class="target-label">Protein</div></div>` : ''}
        ${plan.targetCarbsG ? `<div class="target"><div class="target-value">${plan.targetCarbsG}g</div><div class="target-label">Carbs</div></div>` : ''}
        ${plan.targetFatsG ? `<div class="target"><div class="target-value">${plan.targetFatsG}g</div><div class="target-label">Fats</div></div>` : ''}
    </div>
    ` : ''}
    
    ${daysHtml}
    
    ${plan.notesForClient ? `<div class="notes"><h3>Notes & Guidelines</h3><p>${plan.notesForClient}</p></div>` : ''}
</body>
</html>`;
}
</file>

<file path="backend/src/utils/queryFilters.ts">
/**
 * Shared query filter and pagination utilities
 * Eliminates duplication across controllers
 */

export interface PaginationParams {
    skip: number;
    take: number;
    page: number;
    pageSize: number;
}

export interface PaginationMeta {
    page: number;
    pageSize: number;
    total: number;
    totalPages: number;
    hasNextPage: boolean;
    hasPreviousPage: boolean;
}

/**
 * Parse page/pageSize from query params
 */
export function buildPaginationParams(page?: string | any, pageSize?: string | any): PaginationParams {
    const p = Math.max(1, Number(page) || 1);
    const ps = Math.min(100, Math.max(1, Number(pageSize) || 20));
    return {
        page: p,
        pageSize: ps,
        skip: (p - 1) * ps,
        take: ps,
    };
}

/**
 * Build pagination meta for response
 */
export function buildPaginationMeta(total: number, params: PaginationParams): PaginationMeta {
    const totalPages = Math.ceil(total / params.pageSize);
    return {
        page: params.page,
        pageSize: params.pageSize,
        total,
        totalPages,
        hasNextPage: params.page < totalPages,
        hasPreviousPage: params.page > 1,
    };
}

/**
 * Build date range filter for Prisma
 */
export function buildDateFilter(dateFrom?: string | any, dateTo?: string | any): Record<string, Date> | undefined {
    if (!dateFrom && !dateTo) return undefined;

    const filter: Record<string, Date> = {};
    if (dateFrom) filter.gte = new Date(String(dateFrom));
    if (dateTo) filter.lte = new Date(String(dateTo));
    return filter;
}

/**
 * Build search filter for Prisma (OR across multiple fields)
 */
export function buildSearchFilter(search: string | undefined, fields: string[]): any[] | undefined {
    if (!search) return undefined;
    return fields.map((field) => ({
        [field]: { contains: String(search), mode: 'insensitive' },
    }));
}
</file>

<file path="backend/src/utils/responseHelpers.ts">
/**
 * Standardized response helpers
 */

import { PaginationMeta } from './queryFilters';

export function successResponse<T>(data: T) {
    return { success: true as const, data };
}

export function paginatedResponse<T>(data: T[], meta: PaginationMeta) {
    return { success: true as const, data, meta };
}
</file>

<file path="backend/src/server.ts">
import 'dotenv/config'; // Prevents hoisting issues
import app from './app';

const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});
</file>

<file path="backend/.env.example">
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/dietkaro

# Clerk Authentication
CLERK_SECRET_KEY=sk_test_xxx
CLERK_PUBLISHABLE_KEY=pk_test_xxx

# Garage/S3 Storage
S3_ENDPOINT=http://localhost:3900
S3_REGION=garage
S3_BUCKET=dietkaro-media
S3_ACCESS_KEY=your-garage-access-key
S3_SECRET_KEY=your-garage-secret-key
S3_PUBLIC_URL=http://localhost:3900/dietkaro-media

# App
PORT=3000
NODE_ENV=development
LOG_LEVEL=info
</file>

<file path="backend/prisma.config.ts">
import { defineConfig } from "@prisma/config";
import dotenv from "dotenv";

// Load .env file
dotenv.config();

export default defineConfig({
  schema: "./prisma/schema.prisma",

  datasource: {
    db: {
      provider: "postgresql",
      url: process.env.DATABASE_URL
    }
  }
});
</file>

<file path="backend/tsconfig.json">
{
    "compilerOptions": {
        "target": "es2020",
        "module": "commonjs",
        "outDir": "./dist",
        "rootDir": "./src",
        "strict": true,
        "esModuleInterop": true,
        "skipLibCheck": true,
        "forceConsistentCasingInFileNames": true
    },
    "include": [
        "src/**/*"
    ],
    "exclude": [
        "node_modules"
    ]
}
</file>

<file path="client-app/app/(auth)/_layout.tsx">
import { Slot } from 'expo-router';

export default function AuthLayout() {
    return <Slot />;
}
</file>

<file path="client-app/app/(onboarding)/step6.tsx">
import { View, Text, StyleSheet, TouchableOpacity, ScrollView, TextInput, Alert, ActivityIndicator } from 'react-native';
import { useState } from 'react';
import { useRouter } from 'expo-router';
import { Ruler } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../constants/theme';
import { onboardingApi } from '../../services/api';

export default function BodyMeasurementsScreen() {
    const router = useRouter();
    const [chest, setChest] = useState('');
    const [waist, setWaist] = useState('');
    const [hips, setHips] = useState('');
    const [thighs, setThighs] = useState('');
    const [arms, setArms] = useState('');
    const [bodyFat, setBodyFat] = useState('');
    const [saving, setSaving] = useState(false);

    const validateMeasurement = (value: string, label: string): boolean => {
        if (!value) return true; // all optional
        const num = parseFloat(value);
        if (isNaN(num) || num < 20 || num > 200) {
            Alert.alert('Invalid Value', `${label} must be between 20 and 200 cm.`);
            return false;
        }
        return true;
    };

    const validateBodyFat = (value: string): boolean => {
        if (!value) return true;
        const num = parseFloat(value);
        if (isNaN(num) || num < 3 || num > 60) {
            Alert.alert('Invalid Value', 'Body fat % must be between 3 and 60.');
            return false;
        }
        return true;
    };

    const handleSave = async () => {
        if (!validateMeasurement(chest, 'Chest')) return;
        if (!validateMeasurement(waist, 'Waist')) return;
        if (!validateMeasurement(hips, 'Hips')) return;
        if (!validateMeasurement(thighs, 'Thighs')) return;
        if (!validateMeasurement(arms, 'Arms')) return;
        if (!validateBodyFat(bodyFat)) return;

        setSaving(true);
        try {
            await onboardingApi.saveStep(6, {
                chestCm: chest ? parseFloat(chest) : undefined,
                waistCm: waist ? parseFloat(waist) : undefined,
                hipsCm: hips ? parseFloat(hips) : undefined,
                thighsCm: thighs ? parseFloat(thighs) : undefined,
                armsCm: arms ? parseFloat(arms) : undefined,
                bodyFatPercentage: bodyFat ? parseFloat(bodyFat) : undefined,
            });
            router.replace('/(onboarding)/complete');
        } catch (error) {
            Alert.alert('Error', 'Failed to save. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    const handleSkip = () => {
        router.replace('/(onboarding)/complete');
    };

    return (
        <ScrollView style={styles.container} contentContainerStyle={styles.content}>
            <View style={styles.headerIcon}>
                <Ruler size={32} color={Colors.primaryDark} />
            </View>
            <Text style={styles.title}>Body Measurements</Text>
            <Text style={styles.subtitle}>
                Help your dietitian track your progress more accurately. All fields are optional.
            </Text>

            <View style={styles.row}>
                <View style={[styles.formGroup, { flex: 1, marginRight: 10 }]}>
                    <Text style={styles.label}>Chest (cm)</Text>
                    <TextInput
                        style={styles.input}
                        value={chest}
                        onChangeText={setChest}
                        keyboardType="numeric"
                        placeholder="e.g. 95"
                    />
                </View>
                <View style={[styles.formGroup, { flex: 1 }]}>
                    <Text style={styles.label}>Waist (cm)</Text>
                    <TextInput
                        style={styles.input}
                        value={waist}
                        onChangeText={setWaist}
                        keyboardType="numeric"
                        placeholder="e.g. 80"
                    />
                </View>
            </View>

            <View style={styles.row}>
                <View style={[styles.formGroup, { flex: 1, marginRight: 10 }]}>
                    <Text style={styles.label}>Hips (cm)</Text>
                    <TextInput
                        style={styles.input}
                        value={hips}
                        onChangeText={setHips}
                        keyboardType="numeric"
                        placeholder="e.g. 95"
                    />
                </View>
                <View style={[styles.formGroup, { flex: 1 }]}>
                    <Text style={styles.label}>Thighs (cm)</Text>
                    <TextInput
                        style={styles.input}
                        value={thighs}
                        onChangeText={setThighs}
                        keyboardType="numeric"
                        placeholder="e.g. 55"
                    />
                </View>
            </View>

            <View style={styles.row}>
                <View style={[styles.formGroup, { flex: 1, marginRight: 10 }]}>
                    <Text style={styles.label}>Arms (cm)</Text>
                    <TextInput
                        style={styles.input}
                        value={arms}
                        onChangeText={setArms}
                        keyboardType="numeric"
                        placeholder="e.g. 32"
                    />
                </View>
                <View style={[styles.formGroup, { flex: 1 }]}>
                    <Text style={styles.label}>Body Fat %</Text>
                    <TextInput
                        style={styles.input}
                        value={bodyFat}
                        onChangeText={setBodyFat}
                        keyboardType="decimal-pad"
                        placeholder="e.g. 22"
                    />
                </View>
            </View>

            <TouchableOpacity
                style={[styles.button, saving && styles.buttonDisabled]}
                onPress={handleSave}
                disabled={saving}
            >
                {saving ? (
                    <ActivityIndicator color={Colors.surface} />
                ) : (
                    <Text style={styles.buttonText}>Save & Continue</Text>
                )}
            </TouchableOpacity>

            <TouchableOpacity
                style={styles.skipButton}
                onPress={handleSkip}
                disabled={saving}
            >
                <Text style={styles.skipButtonText}>Skip for now</Text>
            </TouchableOpacity>
        </ScrollView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.surface,
    },
    content: {
        padding: Spacing.xxl,
    },
    headerIcon: {
        marginBottom: Spacing.lg,
    },
    title: {
        fontSize: 24,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textMuted,
        marginBottom: Spacing.xxxl,
        lineHeight: 22,
    },
    row: {
        flexDirection: 'row',
    },
    formGroup: {
        marginBottom: Spacing.xl,
    },
    label: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    input: {
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: Spacing.lg,
        fontSize: FontSizes.lg,
        backgroundColor: Colors.background,
    },
    button: {
        backgroundColor: Colors.primaryDark,
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.xl,
        shadowColor: Colors.primaryDark,
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.2,
        shadowRadius: 8,
        elevation: 4,
    },
    buttonDisabled: {
        opacity: 0.6,
    },
    buttonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    },
    skipButton: {
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.md,
    },
    skipButtonText: {
        color: Colors.textMuted,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.medium,
    },
});
</file>

<file path="client-app/app/(tabs)/home/_layout.tsx">
import { Slot } from 'expo-router';

export default function HomeLayout() {
    return <Slot />;
}
</file>

<file path="client-app/app/(tabs)/notifications/_layout.tsx">
import { Slot } from 'expo-router';

export default function NotificationsLayout() {
    return <Slot />;
}
</file>

<file path="client-app/app/(tabs)/profile/_layout.tsx">
import { Slot } from 'expo-router';

export default function ProfileLayout() {
    return <Slot />;
}
</file>

<file path="client-app/app/(tabs)/profile/body-profile.tsx">
import { View, Text, StyleSheet, ScrollView, TextInput, TouchableOpacity, ActivityIndicator, Alert } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useRouter } from 'expo-router';
import { useState, useEffect } from 'react';
import { ArrowLeft, Ruler, User } from 'lucide-react-native';
import { Picker } from '@react-native-picker/picker';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../../constants/theme';
import { onboardingApi } from '../../../services/api';
import { useToast } from '../../../components/Toast';

export default function BodyProfileScreen() {
    const router = useRouter();
    const toast = useToast();

    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(false);

    // Basic info (step 1)
    const [height, setHeight] = useState('');
    const [currentWeight, setCurrentWeight] = useState('');
    const [targetWeight, setTargetWeight] = useState('');
    const [gender, setGender] = useState('male');
    const [activityLevel, setActivityLevel] = useState('sedentary');

    // Body measurements (step 6)
    const [chest, setChest] = useState('');
    const [waist, setWaist] = useState('');
    const [hips, setHips] = useState('');
    const [thighs, setThighs] = useState('');
    const [arms, setArms] = useState('');
    const [bodyFat, setBodyFat] = useState('');

    useEffect(() => {
        fetchData();
    }, []);

    const fetchData = async () => {
        try {
            const response = await onboardingApi.getStatus();
            const { stepsData } = response.data.data;

            // Step 1
            if (stepsData.step1) {
                setHeight(stepsData.step1.heightCm ? String(stepsData.step1.heightCm) : '');
                setCurrentWeight(stepsData.step1.currentWeightKg ? String(stepsData.step1.currentWeightKg) : '');
                setTargetWeight(stepsData.step1.targetWeightKg ? String(stepsData.step1.targetWeightKg) : '');
                setGender(stepsData.step1.gender || 'male');
                setActivityLevel(stepsData.step1.activityLevel || 'sedentary');
            }

            // Step 6
            if (stepsData.step6) {
                setChest(stepsData.step6.chestCm ? String(stepsData.step6.chestCm) : '');
                setWaist(stepsData.step6.waistCm ? String(stepsData.step6.waistCm) : '');
                setHips(stepsData.step6.hipsCm ? String(stepsData.step6.hipsCm) : '');
                setThighs(stepsData.step6.thighsCm ? String(stepsData.step6.thighsCm) : '');
                setArms(stepsData.step6.armsCm ? String(stepsData.step6.armsCm) : '');
                setBodyFat(stepsData.step6.bodyFatPercentage ? String(stepsData.step6.bodyFatPercentage) : '');
            }
        } catch (error) {
            // Defaults
        } finally {
            setLoading(false);
        }
    };

    const validateMeasurement = (value: string, label: string): boolean => {
        if (!value) return true;
        const num = parseFloat(value);
        if (isNaN(num) || num < 20 || num > 200) {
            Alert.alert('Invalid Value', `${label} must be between 20 and 200 cm.`);
            return false;
        }
        return true;
    };

    const handleSave = async () => {
        if (!height) {
            Alert.alert('Required', 'Please enter your height.');
            return;
        }

        // Validate measurements
        if (!validateMeasurement(chest, 'Chest')) return;
        if (!validateMeasurement(waist, 'Waist')) return;
        if (!validateMeasurement(hips, 'Hips')) return;
        if (!validateMeasurement(thighs, 'Thighs')) return;
        if (!validateMeasurement(arms, 'Arms')) return;
        if (bodyFat) {
            const bf = parseFloat(bodyFat);
            if (isNaN(bf) || bf < 3 || bf > 60) {
                Alert.alert('Invalid Value', 'Body fat % must be between 3 and 60.');
                return;
            }
        }

        setSaving(true);
        try {
            // Save basic info
            await onboardingApi.saveStep(1, {
                heightCm: parseFloat(height),
                currentWeightKg: currentWeight ? parseFloat(currentWeight) : undefined,
                targetWeightKg: targetWeight ? parseFloat(targetWeight) : undefined,
                gender,
                activityLevel,
            });

            // Save measurements only if any provided
            const hasMeasurements = chest || waist || hips || thighs || arms || bodyFat;
            if (hasMeasurements) {
                await onboardingApi.saveStep(6, {
                    chestCm: chest ? parseFloat(chest) : undefined,
                    waistCm: waist ? parseFloat(waist) : undefined,
                    hipsCm: hips ? parseFloat(hips) : undefined,
                    thighsCm: thighs ? parseFloat(thighs) : undefined,
                    armsCm: arms ? parseFloat(arms) : undefined,
                    bodyFatPercentage: bodyFat ? parseFloat(bodyFat) : undefined,
                });
            }

            toast.showToast({ title: 'Saved', message: 'Your body profile has been updated.', variant: 'success' });
        } catch (error) {
            Alert.alert('Error', 'Failed to save. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    if (loading) {
        return (
            <SafeAreaView style={styles.container} edges={['top']}>
                <View style={styles.loadingContainer}>
                    <ActivityIndicator size="large" color={Colors.primaryDark} />
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            {/* Header */}
            <View style={styles.header}>
                <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
                    <ArrowLeft size={24} color={Colors.text} />
                </TouchableOpacity>
                <Text style={styles.headerTitle}>Body Profile</Text>
                <View style={{ width: 40 }} />
            </View>

            <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>

                {/* Basic Info */}
                <View style={styles.section}>
                    <View style={styles.sectionHeader}>
                        <User size={20} color={Colors.primaryDark} />
                        <Text style={styles.sectionTitle}>Basic Info</Text>
                    </View>

                    <View style={styles.formGroup}>
                        <Text style={styles.label}>Height (cm)</Text>
                        <TextInput
                            style={styles.input}
                            value={height}
                            onChangeText={setHeight}
                            keyboardType="numeric"
                            placeholder="e.g. 175"
                            placeholderTextColor={Colors.textMuted}
                        />
                    </View>

                    <View style={styles.row}>
                        <View style={[styles.formGroup, { flex: 1, marginRight: 10 }]}>
                            <Text style={styles.label}>Current Weight (kg)</Text>
                            <TextInput
                                style={[styles.input, styles.readOnlyInput]}
                                value={currentWeight ? `${currentWeight}` : '--'}
                                editable={false}
                            />
                            <Text style={styles.helperText}>Update via weight log</Text>
                        </View>
                        <View style={[styles.formGroup, { flex: 1 }]}>
                            <Text style={styles.label}>Target Weight (kg)</Text>
                            <TextInput
                                style={styles.input}
                                value={targetWeight}
                                onChangeText={setTargetWeight}
                                keyboardType="numeric"
                                placeholder="e.g. 65"
                                placeholderTextColor={Colors.textMuted}
                            />
                        </View>
                    </View>

                    <View style={styles.formGroup}>
                        <Text style={styles.label}>Gender</Text>
                        <View style={styles.pickerContainer}>
                            <Picker
                                selectedValue={gender}
                                onValueChange={setGender}
                            >
                                <Picker.Item label="Male" value="male" />
                                <Picker.Item label="Female" value="female" />
                                <Picker.Item label="Other" value="other" />
                            </Picker>
                        </View>
                    </View>

                    <View style={styles.formGroup}>
                        <Text style={styles.label}>Activity Level</Text>
                        <View style={styles.pickerContainer}>
                            <Picker
                                selectedValue={activityLevel}
                                onValueChange={setActivityLevel}
                            >
                                <Picker.Item label="Sedentary (Little/no exercise)" value="sedentary" />
                                <Picker.Item label="Lightly Active (1-3 days/week)" value="lightly_active" />
                                <Picker.Item label="Moderately Active (3-5 days/week)" value="moderately_active" />
                                <Picker.Item label="Very Active (6-7 days/week)" value="very_active" />
                                <Picker.Item label="Extremely Active (Physical job)" value="extremely_active" />
                            </Picker>
                        </View>
                    </View>
                </View>

                {/* Body Measurements */}
                <View style={styles.section}>
                    <View style={styles.sectionHeader}>
                        <Ruler size={20} color={Colors.primaryDark} />
                        <Text style={styles.sectionTitle}>Body Measurements</Text>
                    </View>
                    <Text style={styles.sectionSubtitle}>All measurements are optional (in cm)</Text>

                    <View style={styles.row}>
                        <View style={[styles.formGroup, { flex: 1, marginRight: 10 }]}>
                            <Text style={styles.label}>Chest</Text>
                            <TextInput
                                style={styles.input}
                                value={chest}
                                onChangeText={setChest}
                                keyboardType="numeric"
                                placeholder="e.g. 95"
                                placeholderTextColor={Colors.textMuted}
                            />
                        </View>
                        <View style={[styles.formGroup, { flex: 1 }]}>
                            <Text style={styles.label}>Waist</Text>
                            <TextInput
                                style={styles.input}
                                value={waist}
                                onChangeText={setWaist}
                                keyboardType="numeric"
                                placeholder="e.g. 80"
                                placeholderTextColor={Colors.textMuted}
                            />
                        </View>
                    </View>

                    <View style={styles.row}>
                        <View style={[styles.formGroup, { flex: 1, marginRight: 10 }]}>
                            <Text style={styles.label}>Hips</Text>
                            <TextInput
                                style={styles.input}
                                value={hips}
                                onChangeText={setHips}
                                keyboardType="numeric"
                                placeholder="e.g. 95"
                                placeholderTextColor={Colors.textMuted}
                            />
                        </View>
                        <View style={[styles.formGroup, { flex: 1 }]}>
                            <Text style={styles.label}>Thighs</Text>
                            <TextInput
                                style={styles.input}
                                value={thighs}
                                onChangeText={setThighs}
                                keyboardType="numeric"
                                placeholder="e.g. 55"
                                placeholderTextColor={Colors.textMuted}
                            />
                        </View>
                    </View>

                    <View style={styles.row}>
                        <View style={[styles.formGroup, { flex: 1, marginRight: 10 }]}>
                            <Text style={styles.label}>Arms</Text>
                            <TextInput
                                style={styles.input}
                                value={arms}
                                onChangeText={setArms}
                                keyboardType="numeric"
                                placeholder="e.g. 32"
                                placeholderTextColor={Colors.textMuted}
                            />
                        </View>
                        <View style={[styles.formGroup, { flex: 1 }]}>
                            <Text style={styles.label}>Body Fat %</Text>
                            <TextInput
                                style={styles.input}
                                value={bodyFat}
                                onChangeText={setBodyFat}
                                keyboardType="decimal-pad"
                                placeholder="e.g. 22"
                                placeholderTextColor={Colors.textMuted}
                            />
                        </View>
                    </View>
                </View>

                {/* Save Button */}
                <TouchableOpacity
                    style={[styles.saveButton, saving && styles.saveButtonDisabled]}
                    onPress={handleSave}
                    disabled={saving}
                >
                    {saving ? (
                        <ActivityIndicator color={Colors.surface} />
                    ) : (
                        <Text style={styles.saveButtonText}>Save Changes</Text>
                    )}
                </TouchableOpacity>

                <View style={{ height: 40 }} />
            </ScrollView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    loadingContainer: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
    },
    backButton: {
        width: 40,
        height: 40,
        borderRadius: 20,
        justifyContent: 'center',
        alignItems: 'center',
    },
    headerTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    scrollView: {
        flex: 1,
        paddingHorizontal: Spacing.lg,
    },
    section: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        padding: Spacing.lg,
        marginBottom: Spacing.lg,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    sectionHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        marginBottom: Spacing.sm,
    },
    sectionTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    sectionSubtitle: {
        fontSize: FontSizes.sm,
        color: Colors.textMuted,
        marginBottom: Spacing.lg,
    },
    formGroup: {
        marginBottom: Spacing.lg,
    },
    row: {
        flexDirection: 'row',
    },
    label: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.medium,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    input: {
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: Spacing.md,
        fontSize: FontSizes.lg,
        backgroundColor: Colors.background,
        color: Colors.text,
    },
    readOnlyInput: {
        backgroundColor: '#f3f4f6',
        color: Colors.textMuted,
    },
    helperText: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
        marginTop: 4,
    },
    pickerContainer: {
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        backgroundColor: Colors.background,
        overflow: 'hidden',
    },
    saveButton: {
        backgroundColor: Colors.primaryDark,
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.sm,
        shadowColor: Colors.primaryDark,
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.2,
        shadowRadius: 8,
        elevation: 4,
    },
    saveButtonDisabled: {
        opacity: 0.6,
    },
    saveButtonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    },
});
</file>

<file path="client-app/app/(tabs)/profile/dietary-info.tsx">
import { View, Text, StyleSheet, ScrollView, TouchableOpacity, TextInput, Switch, ActivityIndicator, Alert } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useRouter } from 'expo-router';
import { useState, useEffect } from 'react';
import { ArrowLeft, Leaf, Fish, Egg, Plus, AlertTriangle, ThumbsDown, ThumbsUp } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../../constants/theme';
import { onboardingApi } from '../../../services/api';
import { useToast } from '../../../components/Toast';

const DIET_PATTERNS = [
    { id: 'vegetarian', name: 'Vegetarian', icon: Leaf, desc: 'No meat, fish, or poultry. Dairy allowed.' },
    { id: 'vegan', name: 'Vegan', icon: Leaf, desc: 'Plant-based only. No animal products.' },
    { id: 'non_veg', name: 'Non-Vegetarian', icon: Fish, desc: 'Includes meat, fish, and poultry.' },
    { id: 'eggetarian', name: 'Eggetarian', icon: Egg, desc: 'Vegetarian + Eggs.' },
    { id: 'pescatarian', name: 'Pescatarian', icon: Fish, desc: 'Vegetarian + Fish/Seafood.' },
];

const COMMON_ALLERGENS = [
    'Peanuts', 'Tree Nuts', 'Milk', 'Eggs', 'Wheat', 'Soy', 'Fish', 'Shellfish'
];

const COMMON_DISLIKES = [
    'Mushrooms', 'Eggplant', 'Bitter Gourd', 'Okra', 'Seafood', 'Coriander', 'Papaya'
];

const COMMON_LIKED_FOODS = [
    'Paneer', 'Chicken', 'Rice', 'Dal', 'Roti', 'Eggs', 'Fish', 'Salad'
];

const CUISINES = [
    'North Indian', 'South Indian', 'Chinese', 'Continental', 'Mediterranean', 'Bengali', 'Gujarati', 'Punjabi'
];

export default function DietaryInfoScreen() {
    const router = useRouter();
    const toast = useToast();

    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(false);

    // Step 2: Diet pattern
    const [dietPattern, setDietPattern] = useState('vegetarian');
    const [eggAllowed, setEggAllowed] = useState(false);

    // Step 3: Allergies
    const [allergies, setAllergies] = useState<string[]>([]);
    const [customAllergy, setCustomAllergy] = useState('');
    const [intolerances, setIntolerances] = useState<string[]>([]);

    // Step 5: Preferences
    const [dislikes, setDislikes] = useState<string[]>([]);
    const [customDislike, setCustomDislike] = useState('');
    const [likedFoods, setLikedFoods] = useState<string[]>([]);
    const [preferredCuisines, setPreferredCuisines] = useState<string[]>([]);

    useEffect(() => {
        fetchData();
    }, []);

    const fetchData = async () => {
        try {
            const response = await onboardingApi.getStatus();
            const { stepsData } = response.data.data;

            // Step 2
            if (stepsData.step2) {
                setDietPattern(stepsData.step2.dietPattern || 'vegetarian');
                setEggAllowed(stepsData.step2.eggAllowed ?? false);
            }

            // Step 3
            if (stepsData.step3) {
                setAllergies(stepsData.step3.allergies || []);
                setIntolerances(stepsData.step3.intolerances || []);
            }

            // Step 5
            if (stepsData.step5) {
                setDislikes(stepsData.step5.dislikes || []);
                setLikedFoods(stepsData.step5.likedFoods || []);
                setPreferredCuisines(stepsData.step5.preferredCuisines || []);
            }
        } catch (error) {
            // First time or error — use defaults
        } finally {
            setLoading(false);
        }
    };

    const toggleItem = (list: string[], setList: (items: string[]) => void, item: string) => {
        if (list.includes(item)) {
            setList(list.filter(i => i !== item));
        } else {
            setList([...list, item]);
        }
    };

    const addCustomAllergy = () => {
        if (customAllergy.trim() && !allergies.includes(customAllergy.trim())) {
            setAllergies([...allergies, customAllergy.trim()]);
            setCustomAllergy('');
        }
    };

    const addCustomDislike = () => {
        if (customDislike.trim() && !dislikes.includes(customDislike.trim())) {
            setDislikes([...dislikes, customDislike.trim()]);
            setCustomDislike('');
        }
    };

    const handleSave = async () => {
        setSaving(true);
        try {
            await onboardingApi.saveStep(2, {
                dietPattern,
                eggAllowed: dietPattern === 'vegetarian' ? eggAllowed : dietPattern === 'eggetarian',
            });
            await onboardingApi.saveStep(3, { allergies, intolerances });
            await onboardingApi.saveStep(5, { dislikes, likedFoods, preferredCuisines });

            toast.showToast({ title: 'Saved', message: 'Your dietary info has been updated.', variant: 'success' });
        } catch (error) {
            Alert.alert('Error', 'Failed to save. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    if (loading) {
        return (
            <SafeAreaView style={styles.container} edges={['top']}>
                <View style={styles.loadingContainer}>
                    <ActivityIndicator size="large" color={Colors.primaryDark} />
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            {/* Header */}
            <View style={styles.header}>
                <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
                    <ArrowLeft size={24} color={Colors.text} />
                </TouchableOpacity>
                <Text style={styles.headerTitle}>Dietary Info</Text>
                <View style={{ width: 40 }} />
            </View>

            <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>

                {/* Section 1: Diet Pattern */}
                <View style={styles.section}>
                    <Text style={styles.sectionTitle}>Diet Pattern</Text>
                    <View style={styles.patterns}>
                        {DIET_PATTERNS.map((pattern) => (
                            <TouchableOpacity
                                key={pattern.id}
                                style={[
                                    styles.patternCard,
                                    dietPattern === pattern.id && styles.selectedCard
                                ]}
                                onPress={() => setDietPattern(pattern.id)}
                            >
                                <View style={styles.patternIcon}>
                                    <pattern.icon size={22} color={dietPattern === pattern.id ? Colors.primaryDark : Colors.textMuted} />
                                </View>
                                <View style={styles.patternText}>
                                    <Text style={[
                                        styles.patternName,
                                        dietPattern === pattern.id && styles.selectedText
                                    ]}>{pattern.name}</Text>
                                    <Text style={styles.patternDesc}>{pattern.desc}</Text>
                                </View>
                                <View style={[
                                    styles.radio,
                                    dietPattern === pattern.id && styles.selectedRadio
                                ]} />
                            </TouchableOpacity>
                        ))}
                    </View>

                    {dietPattern === 'vegetarian' && (
                        <View style={styles.eggOption}>
                            <Text style={styles.eggLabel}>Do you eat eggs?</Text>
                            <Switch
                                value={eggAllowed}
                                onValueChange={setEggAllowed}
                                trackColor={{ false: Colors.border, true: Colors.primaryDark }}
                                thumbColor={Colors.surface}
                            />
                        </View>
                    )}
                </View>

                {/* Section 2: Allergies */}
                <View style={styles.section}>
                    <Text style={styles.sectionTitle}>Allergies & Intolerances</Text>
                    <Text style={styles.sectionSubtitle}>Select any foods you're allergic to</Text>

                    <View style={styles.chipContainer}>
                        {COMMON_ALLERGENS.map((item) => (
                            <TouchableOpacity
                                key={item}
                                style={[styles.chip, allergies.includes(item) && styles.chipAllergy]}
                                onPress={() => toggleItem(allergies, setAllergies, item)}
                            >
                                <Text style={[styles.chipText, allergies.includes(item) && styles.chipAllergyText]}>
                                    {item}
                                </Text>
                            </TouchableOpacity>
                        ))}
                    </View>

                    <View style={styles.inputRow}>
                        <TextInput
                            style={styles.textInput}
                            value={customAllergy}
                            onChangeText={setCustomAllergy}
                            placeholder="Add other allergy..."
                            placeholderTextColor={Colors.textMuted}
                            onSubmitEditing={addCustomAllergy}
                        />
                        <TouchableOpacity style={styles.addButton} onPress={addCustomAllergy}>
                            <Plus size={20} color={Colors.surface} />
                        </TouchableOpacity>
                    </View>

                    {allergies.length > 0 && (
                        <View style={styles.warningBanner}>
                            <AlertTriangle size={18} color={Colors.error} />
                            <Text style={styles.warningText}>
                                Excluding: {allergies.join(', ')}
                            </Text>
                        </View>
                    )}
                </View>

                {/* Section 3: Food Preferences */}
                <View style={styles.section}>
                    <View style={styles.sectionHeader}>
                        <ThumbsDown size={18} color={Colors.textMuted} />
                        <Text style={styles.sectionTitle}>Foods You Dislike</Text>
                    </View>
                    <View style={styles.chipContainer}>
                        {COMMON_DISLIKES.map((item) => (
                            <TouchableOpacity
                                key={item}
                                style={[styles.chip, dislikes.includes(item) && styles.chipDislike]}
                                onPress={() => toggleItem(dislikes, setDislikes, item)}
                            >
                                <Text style={[styles.chipText, dislikes.includes(item) && styles.chipDislikeText]}>
                                    {item}
                                </Text>
                            </TouchableOpacity>
                        ))}
                    </View>
                    <View style={styles.inputRow}>
                        <TextInput
                            style={styles.textInput}
                            value={customDislike}
                            onChangeText={setCustomDislike}
                            placeholder="Add other..."
                            placeholderTextColor={Colors.textMuted}
                            onSubmitEditing={addCustomDislike}
                        />
                        <TouchableOpacity style={styles.addButton} onPress={addCustomDislike}>
                            <Plus size={20} color={Colors.surface} />
                        </TouchableOpacity>
                    </View>
                </View>

                <View style={styles.section}>
                    <View style={styles.sectionHeader}>
                        <ThumbsUp size={18} color={Colors.primaryDark} />
                        <Text style={styles.sectionTitle}>Foods You Enjoy</Text>
                    </View>
                    <View style={styles.chipContainer}>
                        {COMMON_LIKED_FOODS.map((item) => (
                            <TouchableOpacity
                                key={item}
                                style={[styles.chip, likedFoods.includes(item) && styles.chipLike]}
                                onPress={() => toggleItem(likedFoods, setLikedFoods, item)}
                            >
                                <Text style={[styles.chipText, likedFoods.includes(item) && styles.chipLikeText]}>
                                    {item}
                                </Text>
                            </TouchableOpacity>
                        ))}
                    </View>
                </View>

                <View style={styles.section}>
                    <Text style={styles.sectionTitle}>Preferred Cuisines</Text>
                    <View style={styles.chipContainer}>
                        {CUISINES.map((item) => (
                            <TouchableOpacity
                                key={item}
                                style={[styles.chip, preferredCuisines.includes(item) && styles.chipLike]}
                                onPress={() => toggleItem(preferredCuisines, setPreferredCuisines, item)}
                            >
                                <Text style={[styles.chipText, preferredCuisines.includes(item) && styles.chipLikeText]}>
                                    {item}
                                </Text>
                            </TouchableOpacity>
                        ))}
                    </View>
                </View>

                {/* Save Button */}
                <TouchableOpacity
                    style={[styles.saveButton, saving && styles.saveButtonDisabled]}
                    onPress={handleSave}
                    disabled={saving}
                >
                    {saving ? (
                        <ActivityIndicator color={Colors.surface} />
                    ) : (
                        <Text style={styles.saveButtonText}>Save Changes</Text>
                    )}
                </TouchableOpacity>

                <View style={{ height: 40 }} />
            </ScrollView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    loadingContainer: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
    },
    backButton: {
        width: 40,
        height: 40,
        borderRadius: 20,
        justifyContent: 'center',
        alignItems: 'center',
    },
    headerTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    scrollView: {
        flex: 1,
        paddingHorizontal: Spacing.lg,
    },
    section: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        padding: Spacing.lg,
        marginBottom: Spacing.lg,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    sectionHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        marginBottom: Spacing.md,
    },
    sectionTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    sectionSubtitle: {
        fontSize: FontSizes.sm,
        color: Colors.textMuted,
        marginBottom: Spacing.md,
    },
    // Diet pattern cards
    patterns: {
        gap: Spacing.sm,
    },
    patternCard: {
        flexDirection: 'row',
        alignItems: 'center',
        padding: Spacing.md,
        borderRadius: BorderRadius.md,
        borderWidth: 1,
        borderColor: Colors.borderLight,
    },
    selectedCard: {
        borderColor: Colors.primaryDark,
        backgroundColor: Colors.surfaceSecondary,
    },
    patternIcon: {
        marginRight: Spacing.md,
    },
    patternText: {
        flex: 1,
    },
    patternName: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    selectedText: {
        color: Colors.primaryDark,
    },
    patternDesc: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
        marginTop: 2,
    },
    radio: {
        width: 18,
        height: 18,
        borderRadius: 9,
        borderWidth: 2,
        borderColor: Colors.border,
    },
    selectedRadio: {
        borderColor: Colors.primaryDark,
        backgroundColor: Colors.primaryDark,
    },
    eggOption: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginTop: Spacing.lg,
        padding: Spacing.md,
        backgroundColor: Colors.background,
        borderRadius: BorderRadius.md,
    },
    eggLabel: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.medium,
        color: Colors.text,
    },
    // Chips
    chipContainer: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: Spacing.sm,
        marginBottom: Spacing.md,
    },
    chip: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: 10,
        borderRadius: BorderRadius.xl,
        backgroundColor: Colors.background,
        borderWidth: 1,
        borderColor: Colors.borderLight,
    },
    chipText: {
        color: Colors.textMuted,
        fontWeight: FontWeights.medium,
        fontSize: FontSizes.sm,
    },
    chipAllergy: {
        backgroundColor: '#fee2e2',
        borderColor: Colors.error,
    },
    chipAllergyText: {
        color: Colors.error,
        fontWeight: FontWeights.semibold,
    },
    chipDislike: {
        backgroundColor: '#e5e7eb',
        borderColor: '#9ca3af',
    },
    chipDislikeText: {
        color: '#111',
        fontWeight: FontWeights.semibold,
    },
    chipLike: {
        backgroundColor: Colors.surfaceSecondary,
        borderColor: Colors.primaryDark,
    },
    chipLikeText: {
        color: Colors.primaryDark,
        fontWeight: FontWeights.semibold,
    },
    // Input row
    inputRow: {
        flexDirection: 'row',
        gap: Spacing.sm,
    },
    textInput: {
        flex: 1,
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: Spacing.md,
        fontSize: FontSizes.md,
        backgroundColor: Colors.background,
        color: Colors.text,
    },
    addButton: {
        width: 48,
        height: 48,
        borderRadius: BorderRadius.md,
        backgroundColor: Colors.text,
        justifyContent: 'center',
        alignItems: 'center',
    },
    // Warning
    warningBanner: {
        flexDirection: 'row',
        backgroundColor: '#fef2f2',
        padding: Spacing.md,
        borderRadius: BorderRadius.md,
        marginTop: Spacing.md,
        alignItems: 'center',
        gap: Spacing.sm,
    },
    warningText: {
        flex: 1,
        color: '#b91c1c',
        fontSize: FontSizes.sm,
        lineHeight: 20,
    },
    // Save button
    saveButton: {
        backgroundColor: Colors.primaryDark,
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.sm,
        shadowColor: Colors.primaryDark,
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.2,
        shadowRadius: 8,
        elevation: 4,
    },
    saveButtonDisabled: {
        opacity: 0.6,
    },
    saveButtonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    },
});
</file>

<file path="client-app/app/(tabs)/profile/preferences.tsx">
import { View, Text, StyleSheet, ScrollView, TextInput, Switch, TouchableOpacity, ActivityIndicator, Alert } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useRouter } from 'expo-router';
import { useState, useEffect } from 'react';
import { Clock, ChefHat, Activity, ArrowLeft } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../../constants/theme';
import { preferencesApi } from '../../../services/api';
import { useToast } from '../../../components/Toast';

const ACTIVITY_LEVELS = ['Sedentary', 'Light', 'Moderate', 'Active', 'Very Active'];

export default function PreferencesScreen() {
    const router = useRouter();
    const toast = useToast();

    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(false);

    // Meal timings
    const [breakfastTime, setBreakfastTime] = useState('');
    const [lunchTime, setLunchTime] = useState('');
    const [dinnerTime, setDinnerTime] = useState('');
    const [snackTime, setSnackTime] = useState('');

    // Kitchen & cooking
    const [canCook, setCanCook] = useState(true);
    const [kitchenAvailable, setKitchenAvailable] = useState(true);
    const [hasDietaryCook, setHasDietaryCook] = useState(false);

    // Lifestyle
    const [weekdayActivity, setWeekdayActivity] = useState('');
    const [weekendActivity, setWeekendActivity] = useState('');
    const [sportOrHobby, setSportOrHobby] = useState('');
    const [generalNotes, setGeneralNotes] = useState('');

    useEffect(() => {
        fetchPreferences();
    }, []);

    const fetchPreferences = async () => {
        try {
            const response = await preferencesApi.get();
            const prefs = response.data.data;
            if (prefs) {
                setBreakfastTime(prefs.breakfastTime || '');
                setLunchTime(prefs.lunchTime || '');
                setDinnerTime(prefs.dinnerTime || '');
                setSnackTime(prefs.snackTime || '');
                setCanCook(prefs.canCook);
                setKitchenAvailable(prefs.kitchenAvailable);
                setHasDietaryCook(prefs.hasDietaryCook);
                setWeekdayActivity(prefs.weekdayActivity || '');
                setWeekendActivity(prefs.weekendActivity || '');
                setSportOrHobby(prefs.sportOrHobby || '');
                setGeneralNotes(prefs.generalNotes || '');
            }
        } catch (error) {
            // First time — no preferences yet, use defaults
        } finally {
            setLoading(false);
        }
    };

    const validateTime = (value: string): boolean => {
        if (!value) return true;
        return /^([01]\d|2[0-3]):([0-5]\d)$/.test(value);
    };

    const handleSave = async () => {
        // Validate time formats
        const times = { breakfastTime, lunchTime, dinnerTime, snackTime };
        for (const [field, value] of Object.entries(times)) {
            if (value && !validateTime(value)) {
                Alert.alert('Invalid Time', `${field.replace('Time', '')} time must be in HH:MM format (e.g., 08:00).`);
                return;
            }
        }

        setSaving(true);
        try {
            await preferencesApi.update({
                breakfastTime: breakfastTime || undefined,
                lunchTime: lunchTime || undefined,
                dinnerTime: dinnerTime || undefined,
                snackTime: snackTime || undefined,
                canCook,
                kitchenAvailable,
                hasDietaryCook,
                weekdayActivity: weekdayActivity || undefined,
                weekendActivity: weekendActivity || undefined,
                sportOrHobby: sportOrHobby || undefined,
                generalNotes: generalNotes || undefined,
            });
            toast.showToast({ title: 'Saved', message: 'Your preferences have been updated.', variant: 'success' });
        } catch (error) {
            Alert.alert('Error', 'Failed to save preferences. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    if (loading) {
        return (
            <SafeAreaView style={styles.container} edges={['top']}>
                <View style={styles.loadingContainer}>
                    <ActivityIndicator size="large" color={Colors.primaryDark} />
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            {/* Header */}
            <View style={styles.header}>
                <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
                    <ArrowLeft size={24} color={Colors.text} />
                </TouchableOpacity>
                <Text style={styles.headerTitle}>My Preferences</Text>
                <View style={{ width: 40 }} />
            </View>

            <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
                {/* Meal Timings */}
                <View style={styles.section}>
                    <View style={styles.sectionHeader}>
                        <Clock size={20} color={Colors.primaryDark} />
                        <Text style={styles.sectionTitle}>Meal Timings</Text>
                    </View>
                    <Text style={styles.sectionSubtitle}>When do you usually eat? (HH:MM format)</Text>

                    <View style={styles.timeRow}>
                        <View style={styles.timeField}>
                            <Text style={styles.label}>Breakfast</Text>
                            <TextInput
                                style={styles.timeInput}
                                value={breakfastTime}
                                onChangeText={setBreakfastTime}
                                placeholder="08:00"
                                placeholderTextColor={Colors.textMuted}
                                keyboardType="numbers-and-punctuation"
                                maxLength={5}
                            />
                        </View>
                        <View style={styles.timeField}>
                            <Text style={styles.label}>Lunch</Text>
                            <TextInput
                                style={styles.timeInput}
                                value={lunchTime}
                                onChangeText={setLunchTime}
                                placeholder="13:00"
                                placeholderTextColor={Colors.textMuted}
                                keyboardType="numbers-and-punctuation"
                                maxLength={5}
                            />
                        </View>
                    </View>
                    <View style={styles.timeRow}>
                        <View style={styles.timeField}>
                            <Text style={styles.label}>Dinner</Text>
                            <TextInput
                                style={styles.timeInput}
                                value={dinnerTime}
                                onChangeText={setDinnerTime}
                                placeholder="19:30"
                                placeholderTextColor={Colors.textMuted}
                                keyboardType="numbers-and-punctuation"
                                maxLength={5}
                            />
                        </View>
                        <View style={styles.timeField}>
                            <Text style={styles.label}>Snack</Text>
                            <TextInput
                                style={styles.timeInput}
                                value={snackTime}
                                onChangeText={setSnackTime}
                                placeholder="16:00"
                                placeholderTextColor={Colors.textMuted}
                                keyboardType="numbers-and-punctuation"
                                maxLength={5}
                            />
                        </View>
                    </View>
                </View>

                {/* Kitchen & Cooking */}
                <View style={styles.section}>
                    <View style={styles.sectionHeader}>
                        <ChefHat size={20} color={Colors.primaryDark} />
                        <Text style={styles.sectionTitle}>Kitchen & Cooking</Text>
                    </View>

                    <View style={styles.switchRow}>
                        <View style={styles.switchLabel}>
                            <Text style={styles.switchTitle}>Can you cook?</Text>
                            <Text style={styles.switchSubtitle}>Do you prepare your own meals?</Text>
                        </View>
                        <Switch
                            value={canCook}
                            onValueChange={setCanCook}
                            trackColor={{ false: Colors.border, true: Colors.primary }}
                            thumbColor={Colors.surface}
                        />
                    </View>

                    <View style={styles.switchRow}>
                        <View style={styles.switchLabel}>
                            <Text style={styles.switchTitle}>Kitchen available?</Text>
                            <Text style={styles.switchSubtitle}>Access to a kitchen for cooking</Text>
                        </View>
                        <Switch
                            value={kitchenAvailable}
                            onValueChange={setKitchenAvailable}
                            trackColor={{ false: Colors.border, true: Colors.primary }}
                            thumbColor={Colors.surface}
                        />
                    </View>

                    <View style={[styles.switchRow, { borderBottomWidth: 0 }]}>
                        <View style={styles.switchLabel}>
                            <Text style={styles.switchTitle}>Have a dietary cook?</Text>
                            <Text style={styles.switchSubtitle}>Someone who cooks diet-specific meals</Text>
                        </View>
                        <Switch
                            value={hasDietaryCook}
                            onValueChange={setHasDietaryCook}
                            trackColor={{ false: Colors.border, true: Colors.primary }}
                            thumbColor={Colors.surface}
                        />
                    </View>
                </View>

                {/* Lifestyle */}
                <View style={styles.section}>
                    <View style={styles.sectionHeader}>
                        <Activity size={20} color={Colors.primaryDark} />
                        <Text style={styles.sectionTitle}>Lifestyle</Text>
                    </View>

                    <Text style={styles.label}>Weekday Activity Level</Text>
                    <View style={styles.chipContainer}>
                        {ACTIVITY_LEVELS.map((level) => (
                            <TouchableOpacity
                                key={level}
                                style={[styles.chip, weekdayActivity === level && styles.chipSelected]}
                                onPress={() => setWeekdayActivity(weekdayActivity === level ? '' : level)}
                            >
                                <Text style={[styles.chipText, weekdayActivity === level && styles.chipTextSelected]}>
                                    {level}
                                </Text>
                            </TouchableOpacity>
                        ))}
                    </View>

                    <Text style={styles.label}>Weekend Activity Level</Text>
                    <View style={styles.chipContainer}>
                        {ACTIVITY_LEVELS.map((level) => (
                            <TouchableOpacity
                                key={level}
                                style={[styles.chip, weekendActivity === level && styles.chipSelected]}
                                onPress={() => setWeekendActivity(weekendActivity === level ? '' : level)}
                            >
                                <Text style={[styles.chipText, weekendActivity === level && styles.chipTextSelected]}>
                                    {level}
                                </Text>
                            </TouchableOpacity>
                        ))}
                    </View>

                    <Text style={styles.label}>Sport or Hobby</Text>
                    <TextInput
                        style={styles.input}
                        value={sportOrHobby}
                        onChangeText={setSportOrHobby}
                        placeholder="e.g., Swimming, Yoga, Cricket"
                        placeholderTextColor={Colors.textMuted}
                    />

                    <Text style={[styles.label, { marginTop: Spacing.lg }]}>General Notes</Text>
                    <TextInput
                        style={[styles.input, styles.textArea]}
                        value={generalNotes}
                        onChangeText={setGeneralNotes}
                        placeholder="Any other preferences or notes for your dietitian..."
                        placeholderTextColor={Colors.textMuted}
                        multiline
                        numberOfLines={4}
                        textAlignVertical="top"
                    />
                </View>

                {/* Save Button */}
                <TouchableOpacity
                    style={[styles.saveButton, saving && styles.saveButtonDisabled]}
                    onPress={handleSave}
                    disabled={saving}
                >
                    {saving ? (
                        <ActivityIndicator color={Colors.surface} />
                    ) : (
                        <Text style={styles.saveButtonText}>Save Preferences</Text>
                    )}
                </TouchableOpacity>

                <View style={{ height: 40 }} />
            </ScrollView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    loadingContainer: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
    },
    backButton: {
        width: 40,
        height: 40,
        borderRadius: 20,
        justifyContent: 'center',
        alignItems: 'center',
    },
    headerTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    scrollView: {
        flex: 1,
        paddingHorizontal: Spacing.lg,
    },
    section: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        padding: Spacing.lg,
        marginBottom: Spacing.lg,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    sectionHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        marginBottom: Spacing.sm,
    },
    sectionTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    sectionSubtitle: {
        fontSize: FontSizes.sm,
        color: Colors.textMuted,
        marginBottom: Spacing.lg,
    },
    label: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.medium,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    timeRow: {
        flexDirection: 'row',
        gap: Spacing.md,
        marginBottom: Spacing.md,
    },
    timeField: {
        flex: 1,
    },
    timeInput: {
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: Spacing.md,
        fontSize: FontSizes.lg,
        backgroundColor: Colors.background,
        color: Colors.text,
        textAlign: 'center',
    },
    switchRow: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingVertical: Spacing.md,
        borderBottomWidth: 1,
        borderBottomColor: Colors.borderLight,
    },
    switchLabel: {
        flex: 1,
        marginRight: Spacing.md,
    },
    switchTitle: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.medium,
        color: Colors.text,
    },
    switchSubtitle: {
        fontSize: FontSizes.sm,
        color: Colors.textMuted,
        marginTop: 2,
    },
    chipContainer: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: Spacing.sm,
        marginBottom: Spacing.lg,
    },
    chip: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: 10,
        borderRadius: BorderRadius.xl,
        backgroundColor: Colors.background,
        borderWidth: 1,
        borderColor: Colors.borderLight,
    },
    chipSelected: {
        backgroundColor: Colors.surfaceSecondary,
        borderColor: Colors.primaryDark,
    },
    chipText: {
        fontSize: FontSizes.sm,
        color: Colors.textMuted,
        fontWeight: FontWeights.medium,
    },
    chipTextSelected: {
        color: Colors.primaryDark,
        fontWeight: FontWeights.semibold,
    },
    input: {
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: Spacing.md,
        fontSize: FontSizes.md,
        backgroundColor: Colors.background,
        color: Colors.text,
    },
    textArea: {
        minHeight: 100,
    },
    saveButton: {
        backgroundColor: Colors.primaryDark,
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.sm,
        shadowColor: Colors.primaryDark,
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.2,
        shadowRadius: 8,
        elevation: 4,
    },
    saveButtonDisabled: {
        opacity: 0.6,
    },
    saveButtonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    },
});
</file>

<file path="client-app/app/(tabs)/progress/_layout.tsx">
import { Slot } from 'expo-router';

export default function ProgressLayout() {
    return <Slot />;
}
</file>

<file path="client-app/app/(tabs)/weight/_layout.tsx">
import { Slot } from 'expo-router';

export default function WeightLayout() {
    return <Slot />;
}
</file>

<file path="client-app/components/Card.tsx">
import React from 'react';
import { View, StyleSheet, ViewStyle, StyleProp } from 'react-native';
import { Colors, BorderRadius, Spacing, Shadows } from '../constants/theme';

interface CardProps {
    children: React.ReactNode;
    variant?: 'default' | 'elevated';
    style?: StyleProp<ViewStyle>;
    padding?: number;
}

export function Card({ children, variant = 'default', style, padding }: CardProps) {
    return (
        <View
            style={[
                styles.base,
                variant === 'elevated' && styles.elevated,
                padding !== undefined && { padding },
                style,
            ]}
        >
            {children}
        </View>
    );
}

const styles = StyleSheet.create({
    base: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        borderWidth: 1,
        borderColor: Colors.border,
        padding: Spacing.lg,
        ...Shadows.md,
    },
    elevated: {
        borderWidth: 0,
        ...Shadows.lg,
    },
});
</file>

<file path="client-app/components/EmptyState.tsx">
import React from 'react';
import { View, Text, TouchableOpacity, StyleSheet } from 'react-native';
import { Colors, FontSizes, FontWeights, Spacing, BorderRadius } from '../constants/theme';

interface EmptyStateProps {
    icon: React.ReactNode;
    title: string;
    subtitle?: string;
    action?: {
        label: string;
        onPress: () => void;
    };
}

export function EmptyState({ icon, title, subtitle, action }: EmptyStateProps) {
    return (
        <View style={styles.container}>
            {icon}
            <Text style={styles.title}>{title}</Text>
            {subtitle && <Text style={styles.subtitle}>{subtitle}</Text>}
            {action && (
                <TouchableOpacity style={styles.actionButton} onPress={action.onPress}>
                    <Text style={styles.actionText}>{action.label}</Text>
                </TouchableOpacity>
            )}
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        alignItems: 'center',
        paddingVertical: 48,
        paddingHorizontal: Spacing.xxxl,
    },
    title: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginTop: Spacing.lg,
        textAlign: 'center',
    },
    subtitle: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
        textAlign: 'center',
        marginTop: Spacing.sm,
        lineHeight: 20,
    },
    actionButton: {
        marginTop: Spacing.lg,
        backgroundColor: Colors.primary,
        paddingHorizontal: Spacing.xxl,
        paddingVertical: Spacing.md,
        borderRadius: BorderRadius.md,
    },
    actionText: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
});
</file>

<file path="client-app/components/LoadingScreen.tsx">
import React from 'react';
import { View, Text, ActivityIndicator, StyleSheet } from 'react-native';
import { Colors, FontSizes, Spacing } from '../constants/theme';

interface LoadingScreenProps {
    message?: string;
}

export function LoadingScreen({ message }: LoadingScreenProps) {
    return (
        <View style={styles.container}>
            <ActivityIndicator size="large" color={Colors.primary} />
            {message && <Text style={styles.message}>{message}</Text>}
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
        backgroundColor: Colors.background,
    },
    message: {
        marginTop: Spacing.lg,
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
    },
});
</file>

<file path="client-app/components/OfflineBanner.tsx">
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { WifiOff } from 'lucide-react-native';
import { useNetworkStatus } from '../hooks/useNetworkStatus';
import { Colors, FontSizes, FontWeights, Spacing } from '../constants/theme';

export function OfflineBanner() {
    const { isConnected } = useNetworkStatus();

    if (isConnected) return null;

    return (
        <View style={styles.banner}>
            <WifiOff size={16} color={Colors.surface} />
            <Text style={styles.text}>No internet connection</Text>
        </View>
    );
}

const styles = StyleSheet.create({
    banner: {
        backgroundColor: Colors.error,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: Spacing.sm,
        paddingVertical: Spacing.sm,
    },
    text: {
        color: Colors.surface,
        fontSize: FontSizes.sm,
        fontWeight: FontWeights.medium,
    },
});
</file>

<file path="client-app/components/StatusBadge.tsx">
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { StatusColors, BorderRadius, FontSizes, FontWeights, Spacing } from '../constants/theme';

interface StatusBadgeProps {
    status: keyof typeof StatusColors;
    size?: 'sm' | 'md';
}

export function StatusBadge({ status, size = 'sm' }: StatusBadgeProps) {
    const config = StatusColors[status];
    const isSmall = size === 'sm';

    return (
        <View style={[
            styles.badge,
            { backgroundColor: config.bg },
            isSmall ? styles.badgeSm : styles.badgeMd,
        ]}>
            <Text style={[
                styles.text,
                { color: config.text },
                isSmall ? styles.textSm : styles.textMd,
            ]}>
                {config.label}
            </Text>
        </View>
    );
}

const styles = StyleSheet.create({
    badge: {
        borderRadius: BorderRadius.md,
        alignSelf: 'flex-start',
    },
    badgeSm: {
        paddingHorizontal: Spacing.sm,
        paddingVertical: 2,
    },
    badgeMd: {
        paddingHorizontal: Spacing.md,
        paddingVertical: Spacing.xs,
    },
    text: {
        fontWeight: FontWeights.semibold,
    },
    textSm: {
        fontSize: FontSizes.xs,
    },
    textMd: {
        fontSize: FontSizes.sm,
    },
});
</file>

<file path="client-app/components/Toast.tsx">
import React, { createContext, useCallback, useContext, useRef, useState } from 'react';
import { Animated, StyleSheet, Text, TouchableOpacity, View } from 'react-native';
import { X } from 'lucide-react-native';
import { Colors, FontSizes, FontWeights, BorderRadius, Spacing } from '../constants/theme';

type ToastVariant = 'success' | 'error' | 'warning' | 'info';

interface ToastConfig {
    title: string;
    message?: string;
    variant: ToastVariant;
    duration?: number;
    action?: { label: string; onPress: () => void };
}

interface ToastContextValue {
    showToast: (config: ToastConfig) => void;
}

const ToastContext = createContext<ToastContextValue | null>(null);

export function useToast(): ToastContextValue {
    const context = useContext(ToastContext);
    if (!context) throw new Error('useToast must be used within ToastProvider');
    return context;
}

const variantColors: Record<ToastVariant, { bg: string; border: string; text: string }> = {
    success: { bg: '#d1fae5', border: Colors.success, text: '#065f46' },
    error: { bg: '#fee2e2', border: Colors.error, text: '#991b1b' },
    warning: { bg: '#fef3c7', border: Colors.warning, text: '#92400e' },
    info: { bg: '#e0e7ff', border: Colors.info, text: '#3730a3' },
};

export function ToastProvider({ children }: { children: React.ReactNode }) {
    const [toast, setToast] = useState<ToastConfig | null>(null);
    const translateY = useRef(new Animated.Value(-100)).current;
    const timeoutRef = useRef<ReturnType<typeof setTimeout>>(undefined);

    const hideToast = useCallback(() => {
        Animated.timing(translateY, {
            toValue: -100,
            duration: 200,
            useNativeDriver: true,
        }).start(() => setToast(null));
    }, [translateY]);

    const showToast = useCallback((config: ToastConfig) => {
        if (timeoutRef.current) clearTimeout(timeoutRef.current);

        setToast(config);
        Animated.timing(translateY, {
            toValue: 0,
            duration: 300,
            useNativeDriver: true,
        }).start();

        timeoutRef.current = setTimeout(hideToast, config.duration || 3000);
    }, [translateY, hideToast]);

    const colors = toast ? variantColors[toast.variant] : variantColors.info;

    return (
        <ToastContext.Provider value={{ showToast }}>
            {children}
            {toast && (
                <Animated.View
                    style={[
                        styles.container,
                        { backgroundColor: colors.bg, borderLeftColor: colors.border, transform: [{ translateY }] },
                    ]}
                >
                    <View style={styles.content}>
                        <Text style={[styles.title, { color: colors.text }]}>{toast.title}</Text>
                        {toast.message && (
                            <Text style={[styles.message, { color: colors.text }]}>{toast.message}</Text>
                        )}
                        {toast.action && (
                            <TouchableOpacity onPress={toast.action.onPress} style={styles.actionButton}>
                                <Text style={[styles.actionText, { color: colors.border }]}>
                                    {toast.action.label}
                                </Text>
                            </TouchableOpacity>
                        )}
                    </View>
                    <TouchableOpacity onPress={hideToast} style={styles.closeButton}>
                        <X size={16} color={colors.text} />
                    </TouchableOpacity>
                </Animated.View>
            )}
        </ToastContext.Provider>
    );
}

const styles = StyleSheet.create({
    container: {
        position: 'absolute',
        top: 60,
        left: Spacing.lg,
        right: Spacing.lg,
        borderRadius: BorderRadius.md,
        borderLeftWidth: 4,
        padding: Spacing.lg,
        flexDirection: 'row',
        alignItems: 'flex-start',
        zIndex: 9999,
        elevation: 10,
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.15,
        shadowRadius: 12,
    },
    content: {
        flex: 1,
    },
    title: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
    },
    message: {
        fontSize: FontSizes.sm,
        marginTop: Spacing.xs,
        lineHeight: 18,
    },
    actionButton: {
        marginTop: Spacing.sm,
    },
    actionText: {
        fontSize: FontSizes.sm,
        fontWeight: FontWeights.bold,
    },
    closeButton: {
        padding: Spacing.xs,
        marginLeft: Spacing.sm,
    },
});
</file>

<file path="client-app/hooks/useAdherence.ts">
import { useQuery } from '@tanstack/react-query';
import { adherenceApi } from '../services/api';

export function useDailyAdherence(date?: string) {
    return useQuery({
        queryKey: ['adherence', 'daily', date],
        queryFn: async () => {
            const { data } = await adherenceApi.getDaily(date);
            return data.data;
        },
        staleTime: 60 * 1000,
    });
}

export function useWeeklyAdherence(weekStart?: string) {
    return useQuery({
        queryKey: ['adherence', 'weekly', weekStart],
        queryFn: async () => {
            const { data } = await adherenceApi.getWeekly(weekStart);
            return data.data;
        },
        staleTime: 60 * 1000,
    });
}

export function useComplianceHistory(days: number = 30) {
    return useQuery({
        queryKey: ['adherence', 'history', days],
        queryFn: async () => {
            const { data } = await adherenceApi.getHistory(days);
            return data.data;
        },
        staleTime: 60 * 1000,
    });
}
</file>

<file path="client-app/hooks/useNetworkStatus.ts">
import { useState, useEffect } from 'react';
import NetInfo, { NetInfoState } from '@react-native-community/netinfo';

interface NetworkStatus {
    isConnected: boolean;
    isInternetReachable: boolean | null;
}

export function useNetworkStatus(): NetworkStatus {
    const [status, setStatus] = useState<NetworkStatus>({
        isConnected: true,
        isInternetReachable: null,
    });

    useEffect(() => {
        const unsubscribe = NetInfo.addEventListener((state: NetInfoState) => {
            setStatus({
                isConnected: state.isConnected ?? false,
                isInternetReachable: state.isInternetReachable,
            });
        });
        return () => unsubscribe();
    }, []);

    return status;
}
</file>

<file path="client-app/hooks/useOnboarding.ts">
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { onboardingApi } from '../services/api';

export function useOnboardingStatus() {
    return useQuery({
        queryKey: ['onboarding', 'status'],
        queryFn: async () => {
            const { data } = await onboardingApi.getStatus();
            return data.data;
        },
        staleTime: 30 * 1000,
    });
}

export function useSaveOnboardingStep() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async ({ step, data }: { step: number; data: any }) => {
            const response = await onboardingApi.saveStep(step, data);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['onboarding', 'status'] });
        },
    });
}

export function useCompleteOnboarding() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async () => {
            const response = await onboardingApi.complete();
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['onboarding', 'status'] });
        },
    });
}
</file>

<file path="client-app/utils/errorHandler.ts">
import { AxiosError } from 'axios';
import { ApiErrorResponse } from '../types';

export interface AppError {
    title: string;
    message: string;
    isRetryable: boolean;
    statusCode?: number;
}

function isAxiosError(error: unknown): error is AxiosError {
    return (error as AxiosError)?.isAxiosError === true;
}

function getHttpTitle(status: number): string {
    if (status === 401) return 'Session Expired';
    if (status === 403) return 'Access Denied';
    if (status === 404) return 'Not Found';
    if (status === 409) return 'Conflict';
    if (status === 422) return 'Validation Error';
    if (status === 429) return 'Too Many Requests';
    if (status >= 500) return 'Server Error';
    return 'Request Failed';
}

function getHttpMessage(status: number): string {
    if (status === 401) return 'Please log in again.';
    if (status === 403) return 'You do not have permission for this action.';
    if (status === 409) return 'This entry already exists.';
    if (status === 429) return 'Please wait a moment before trying again.';
    if (status >= 500) return 'Something went wrong on our end. Please try again.';
    return 'An error occurred. Please try again.';
}

/**
 * Normalizes any error into a structured AppError.
 * Handles AxiosErrors, network errors, timeouts, and generic JS errors.
 */
export function normalizeError(error: unknown): AppError {
    // Timeout
    if (isAxiosError(error) && error.code === 'ECONNABORTED') {
        return {
            title: 'Request Timeout',
            message: 'The server took too long to respond. Please try again.',
            isRetryable: true,
        };
    }

    // Axios error with response (server returned an error status)
    if (isAxiosError(error) && error.response) {
        const status = error.response.status;
        const apiError = error.response.data as ApiErrorResponse | undefined;
        const message = apiError?.message || getHttpMessage(status);

        return {
            title: getHttpTitle(status),
            message,
            isRetryable: status >= 500 || status === 408 || status === 429,
            statusCode: status,
        };
    }

    // Network error (no response received)
    if (isAxiosError(error) && !error.response) {
        return {
            title: 'Connection Error',
            message: 'Please check your internet connection and try again.',
            isRetryable: true,
        };
    }

    // Generic JS error
    if (error instanceof Error) {
        return {
            title: 'Error',
            message: error.message,
            isRetryable: false,
        };
    }

    return {
        title: 'Unexpected Error',
        message: 'Something went wrong. Please try again.',
        isRetryable: true,
    };
}
</file>

<file path="client-app/.npmrc">
legacy-peer-deps=true
</file>

<file path="client-app/app.json">
{
  "expo": {
    "name": "DietConnect",
    "slug": "dietconnect-client",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./assets/icon.png",
    "scheme": "dietconnect",
    "userInterfaceStyle": "light",
    "newArchEnabled": true,
    "splash": {
      "image": "./assets/splash-icon.png",
      "resizeMode": "contain",
      "backgroundColor": "#17cf54"
    },
    "ios": {
      "supportsTablet": true,
      "bundleIdentifier": "com.dietconnect.client"
    },
    "android": {
      "adaptiveIcon": {
        "foregroundImage": "./assets/adaptive-icon.png",
        "backgroundColor": "#17cf54"
      },
      "package": "com.dietconnect.client",
      "edgeToEdgeEnabled": true
    },
    "web": {
      "favicon": "./assets/favicon.png",
      "bundler": "metro"
    },
    "plugins": [
      "expo-router"
    ],
    "experiments": {
      "typedRoutes": true
    }
  }
}
</file>

<file path="client-app/tsconfig.json">
{
  "extends": "expo/tsconfig.base",
  "compilerOptions": {
    "strict": true
  },
  "include": [
    "**/*.ts",
    "**/*.tsx",
    ".expo/types/**/*.ts",
    "expo-env.d.ts"
  ]
}
</file>

<file path="Design/mobileapp/dietician's_remark_detail/code.html">
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex h-auto min-h-screen w-full flex-col bg-[#f8fcf9] justify-between group/design-root overflow-x-hidden"
      style='font-family: Manrope, "Noto Sans", sans-serif;'
    >
      <div>
        <div class="flex items-center bg-[#f8fcf9] p-4 pb-2 justify-between">
          <div class="text-[#0d1b12] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
            </svg>
          </div>
          <h2 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Feedback</h2>
        </div>
        <h3 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Today</h3>
        <div class="flex w-full flex-row items-start justify-start gap-3 p-4">
          <div
            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0"
            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuByCJqz3zSssqcysf4CwRTzdxxc9R0EoWlrQlSO2ju0MtzJ4V6UbrrLNZl0vgkjMen3bqcnAkgkX7IRDrmz1lqHNCjfONIrJBEZPFVBAXih_p7OqmZSR4WiOARxuRb7FEujfY_oHqE1DZJ0G7RUwmIFfuIiHLtDnSQn2W3lsns5nxWKPuPOqWLNqKUhArpn-GHod7TWlOr0bDK2wg8cbCBloWMhPa0shrJ7PQAPGCl_1K7q9l-sdU00s9kRsCSVtc9V6Spk4l73bWJ7");'
          ></div>
          <div class="flex h-full flex-1 flex-col items-start justify-start">
            <div class="flex w-full flex-row items-start justify-start gap-x-3">
              <p class="text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]">Dr. Anya Sharma</p>
              <p class="text-[#4c9a66] text-sm font-normal leading-normal">10:30 AM</p>
            </div>
            <p class="text-[#0d1b12] text-sm font-normal leading-normal">
              Your meal looks great! The portion size is perfect, and the variety of vegetables is commendable. Keep up the good work!
            </p>
          </div>
        </div>
        <div class="flex w-full grow bg-[#f8fcf9] @container py-3">
          <div class="w-full gap-1 overflow-hidden bg-[#f8fcf9] @[480px]:gap-2 aspect-[3/2] flex">
            <div
              class="w-full bg-center bg-no-repeat bg-cover aspect-auto rounded-none flex-1"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAQtfqbuCjtfgMyUtpj87dPy6dvMU0Xft3M2usehDJKQRrjXwBwPg0IkaJ395I5DeBAdsG1n2PriVH2ifAc8QHXUQgkpoFr1B65ZoF6JRYNkIWq3zaWVSMrl-j0dR3amJ5WevW7N7LxSJqS76ee5uxu6ca4GutQmk0JyrSvOwT142PGh-0OK3oWcCLkj3zKd6WmHkLIxWKQIKYZQYNoI03p_hjSFCi4mLthiaAYLFKWVYzi2s8P-dafkd_WhuqlxJzZxaHv55_32_1D");'
            ></div>
          </div>
        </div>
        <div class="flex flex-wrap gap-4 px-4 py-2 py-2">
          <div class="flex items-center justify-center gap-2 px-3 py-2">
            <div class="text-[#4c9a66]" data-icon="ThumbsUp" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M234,80.12A24,24,0,0,0,216,72H160V56a40,40,0,0,0-40-40,8,8,0,0,0-7.16,4.42L75.06,96H32a16,16,0,0,0-16,16v88a16,16,0,0,0,16,16H204a24,24,0,0,0,23.82-21l12-96A24,24,0,0,0,234,80.12ZM32,112H72v88H32ZM223.94,97l-12,96a8,8,0,0,1-7.94,7H88V105.89l36.71-73.43A24,24,0,0,1,144,56V80a8,8,0,0,0,8,8h64a8,8,0,0,1,7.94,9Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">12</p>
          </div>
          <div class="flex items-center justify-center gap-2 px-3 py-2">
            <div class="text-[#4c9a66]" data-icon="ThumbsDown" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M239.82,157l-12-96A24,24,0,0,0,204,40H32A16,16,0,0,0,16,56v88a16,16,0,0,0,16,16H75.06l37.78,75.58A8,8,0,0,0,120,240a40,40,0,0,0,40-40V184h56a24,24,0,0,0,23.82-27ZM72,144H32V56H72Zm150,21.29a7.88,7.88,0,0,1-6,2.71H152a8,8,0,0,0-8,8v24a24,24,0,0,1-19.29,23.54L88,150.11V56H204a8,8,0,0,1,7.94,7l12,96A7.87,7.87,0,0,1,222,165.29Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">2</p>
          </div>
          <div class="flex items-center justify-center gap-2 px-3 py-2">
            <div class="text-[#4c9a66]" data-icon="Smiley" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216ZM80,108a12,12,0,1,1,12,12A12,12,0,0,1,80,108Zm96,0a12,12,0,1,1-12-12A12,12,0,0,1,176,108Zm-1.07,48c-10.29,17.79-27.4,28-46.93,28s-36.63-10.2-46.92-28a8,8,0,1,1,13.84-8c7.47,12.91,19.21,20,33.08,20s25.61-7.1,33.07-20a8,8,0,0,1,13.86,8Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">5</p>
          </div>
        </div>
      </div>
      <div>
        <div class="flex gap-2 border-t border-[#e7f3eb] bg-[#f8fcf9] px-4 pb-3 pt-2">
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="House" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M218.83,103.77l-80-75.48a1.14,1.14,0,0,1-.11-.11,16,16,0,0,0-21.53,0l-.11.11L37.17,103.77A16,16,0,0,0,32,115.55V208a16,16,0,0,0,16,16H96a16,16,0,0,0,16-16V160h32v48a16,16,0,0,0,16,16h48a16,16,0,0,0,16-16V115.55A16,16,0,0,0,218.83,103.77ZM208,208H160V160a16,16,0,0,0-16-16H112a16,16,0,0,0-16,16v48H48V115.55l.11-.1L128,40l79.9,75.43.11.1Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Home</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="PresentationChart" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M216,40H136V24a8,8,0,0,0-16,0V40H40A16,16,0,0,0,24,56V176a16,16,0,0,0,16,16H79.36L57.75,219a8,8,0,0,0,12.5,10l29.59-37h56.32l29.59,37a8,8,0,1,0,12.5-10l-21.61-27H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,136H40V56H216V176ZM104,120v24a8,8,0,0,1-16,0V120a8,8,0,0,1,16,0Zm32-16v40a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm32-16v56a8,8,0,0,1-16,0V88a8,8,0,0,1,16,0Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Progress</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-[#0d1b12]" href="#">
            <div class="text-[#0d1b12] flex h-8 items-center justify-center" data-icon="Bell" data-size="24px" data-weight="fill">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#0d1b12] text-xs font-medium leading-normal tracking-[0.015em]">Notifications</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="User" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Profile</p>
          </a>
        </div>
        <div class="h-5 bg-[#f8fcf9]"></div>
      </div>
    </div>
  </body>
</html>
</file>

<file path="Design/mobileapp/log_meal_screen/code.html">
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex h-auto min-h-screen w-full flex-col bg-[#f8fcf9] justify-between group/design-root overflow-x-hidden"
      style="--select-button-svg: url('data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724px%27 height=%2724px%27 fill=%27rgb(76,154,102)%27 viewBox=%270 0 256 256%27%3e%3cpath d=%27M181.66,170.34a8,8,0,0,1,0,11.32l-48,48a8,8,0,0,1-11.32,0l-48-48a8,8,0,0,1,11.32-11.32L128,212.69l42.34-42.35A8,8,0,0,1,181.66,170.34Zm-96-84.68L128,43.31l42.34,42.35a8,8,0,0,0,11.32-11.32l-48-48a8,8,0,0,0-11.32,0l-48,48A8,8,0,0,0,85.66,85.66Z%27%3e%3c/path%3e%3c/svg%3e'); font-family: Manrope, &quot;Noto Sans&quot;, sans-serif;"
    >
      <div>
        <div class="flex items-center bg-[#f8fcf9] p-4 pb-2 justify-between">
          <div class="text-[#0d1b12] flex size-12 shrink-0 items-center" data-icon="X" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path
                d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"
              ></path>
            </svg>
          </div>
          <h2 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Log Meal</h2>
        </div>
        <div class="flex w-full grow bg-[#f8fcf9] @container py-3">
          <div class="w-full gap-1 overflow-hidden bg-[#f8fcf9] @[480px]:gap-2 aspect-[3/2] flex">
            <div
              class="w-full bg-center bg-no-repeat bg-cover aspect-auto rounded-none flex-1"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuB0E5cY2MxeEHD4ZyzJkwwk8VYaNicPvPChIE4Ari5ne-ZWBckmoF4KNZK7Pf94e7v4i0Kz19CeZUIA8CE85SSvt_koxicW4TT4mdQpGIPWGrOw2xL88d7Hm_PZ4wrxUcDdvHyNamD2RR1M4J9Xn9mZwdf5xTpN0jz7DX3nGEkevJ3Pj6gUOwIvIUi_WtZm2-4dOvMubrS-TLLvzYPYIN4GqSgDOR6GDECxKMQamwk81cDyT-QuNfHUNQTlYKoE6SpON4vysAGCC1qx");'
            ></div>
          </div>
        </div>
        <h3 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Meal Type</h3>
        <div class="flex flex-wrap gap-3 p-4">
          <label
            class="text-sm font-medium leading-normal flex items-center justify-center rounded-lg border border-[#cfe7d7] px-4 h-11 text-[#0d1b12] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-[#13ec5b] relative cursor-pointer"
          >
            Breakfast
            <input type="radio" class="invisible absolute" name="fdafd399-187f-4876-9181-7f211ec339ec" />
          </label>
          <label
            class="text-sm font-medium leading-normal flex items-center justify-center rounded-lg border border-[#cfe7d7] px-4 h-11 text-[#0d1b12] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-[#13ec5b] relative cursor-pointer"
          >
            Lunch
            <input type="radio" class="invisible absolute" name="fdafd399-187f-4876-9181-7f211ec339ec" />
          </label>
          <label
            class="text-sm font-medium leading-normal flex items-center justify-center rounded-lg border border-[#cfe7d7] px-4 h-11 text-[#0d1b12] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-[#13ec5b] relative cursor-pointer"
          >
            Dinner
            <input type="radio" class="invisible absolute" name="fdafd399-187f-4876-9181-7f211ec339ec" />
          </label>
          <label
            class="text-sm font-medium leading-normal flex items-center justify-center rounded-lg border border-[#cfe7d7] px-4 h-11 text-[#0d1b12] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-[#13ec5b] relative cursor-pointer"
          >
            Snack
            <input type="radio" class="invisible absolute" name="fdafd399-187f-4876-9181-7f211ec339ec" />
          </label>
          <label
            class="text-sm font-medium leading-normal flex items-center justify-center rounded-lg border border-[#cfe7d7] px-4 h-11 text-[#0d1b12] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-[#13ec5b] relative cursor-pointer"
          >
            Substituted
            <input type="radio" class="invisible absolute" name="fdafd399-187f-4876-9181-7f211ec339ec" />
          </label>
        </div>
        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
          <label class="flex flex-col min-w-40 flex-1">
            <p class="text-[#0d1b12] text-base font-medium leading-normal pb-2">Scheduled Time</p>
            <select
              class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d1b12] focus:outline-0 focus:ring-0 border-none bg-[#e7f3eb] focus:border-none h-14 bg-[image:--select-button-svg] placeholder:text-[#4c9a66] p-4 text-base font-normal leading-normal"
            >
              <option value="one">Select Time</option>
              <option value="two">two</option>
              <option value="three">three</option>
            </select>
          </label>
        </div>
        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
          <label class="flex flex-col min-w-40 flex-1">
            <p class="text-[#0d1b12] text-base font-medium leading-normal pb-2">Notes (Optional)</p>
            <textarea
              placeholder="Add any notes about your meal"
              class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d1b12] focus:outline-0 focus:ring-0 border-none bg-[#e7f3eb] focus:border-none min-h-36 placeholder:text-[#4c9a66] p-4 text-base font-normal leading-normal"
            ></textarea>
          </label>
        </div>
      </div>
      <div>
        <div class="flex px-4 py-3">
          <button
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 flex-1 bg-[#13ec5b] text-[#0d1b12] text-base font-bold leading-normal tracking-[0.015em]"
          >
            <span class="truncate">Submit</span>
          </button>
        </div>
        <p class="text-[#4c9a66] text-sm font-normal leading-normal pb-3 pt-1 px-4 text-center">Meal logged! Waiting for review.</p>
        <div class="flex gap-2 border-t border-[#e7f3eb] bg-[#f8fcf9] px-4 pb-3 pt-2">
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-[#0d1b12]" href="#">
            <div class="text-[#0d1b12] flex h-8 items-center justify-center" data-icon="House" data-size="24px" data-weight="fill">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M224,115.55V208a16,16,0,0,1-16,16H168a16,16,0,0,1-16-16V168a8,8,0,0,0-8-8H112a8,8,0,0,0-8,8v40a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V115.55a16,16,0,0,1,5.17-11.78l80-75.48.11-.11a16,16,0,0,1,21.53,0,1.14,1.14,0,0,0,.11.11l80,75.48A16,16,0,0,1,224,115.55Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#0d1b12] text-xs font-medium leading-normal tracking-[0.015em]">Home</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="PresentationChart" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M216,40H136V24a8,8,0,0,0-16,0V40H40A16,16,0,0,0,24,56V176a16,16,0,0,0,16,16H79.36L57.75,219a8,8,0,0,0,12.5,10l29.59-37h56.32l29.59,37a8,8,0,1,0,12.5-10l-21.61-27H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,136H40V56H216V176ZM104,120v24a8,8,0,0,1-16,0V120a8,8,0,0,1,16,0Zm32-16v40a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm32-16v56a8,8,0,0,1-16,0V88a8,8,0,0,1,16,0Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Progress</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="Bell" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Notifications</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="User" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Profile</p>
          </a>
        </div>
        <div class="h-5 bg-[#f8fcf9]"></div>
      </div>
    </div>
  </body>
</html>
</file>

<file path="Design/mobileapp/notifications_(inbox)/code.html">
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex h-auto min-h-screen w-full flex-col bg-[#f8fcf9] justify-between group/design-root overflow-x-hidden"
      style='font-family: Manrope, "Noto Sans", sans-serif;'
    >
      <div>
        <div class="flex items-center bg-[#f8fcf9] p-4 pb-2 justify-between">
          <h2 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pl-12">Inbox</h2>
          <div class="flex w-12 items-center justify-end">
            <button
              class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 bg-transparent text-[#0d1b12] gap-2 text-base font-bold leading-normal tracking-[0.015em] min-w-0 p-0"
            >
              <div class="text-[#0d1b12]" data-icon="Gear" data-size="24px" data-weight="regular">
                <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                  <path
                    d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Zm88-29.84q.06-2.16,0-4.32l14.92-18.64a8,8,0,0,0,1.48-7.06,107.21,107.21,0,0,0-10.88-26.25,8,8,0,0,0-6-3.93l-23.72-2.64q-1.48-1.56-3-3L186,40.54a8,8,0,0,0-3.94-6,107.71,107.71,0,0,0-26.25-10.87,8,8,0,0,0-7.06,1.49L130.16,40Q128,40,125.84,40L107.2,25.11a8,8,0,0,0-7.06-1.48A107.6,107.6,0,0,0,73.89,34.51a8,8,0,0,0-3.93,6L67.32,64.27q-1.56,1.49-3,3L40.54,70a8,8,0,0,0-6,3.94,107.71,107.71,0,0,0-10.87,26.25,8,8,0,0,0,1.49,7.06L40,125.84Q40,128,40,130.16L25.11,148.8a8,8,0,0,0-1.48,7.06,107.21,107.21,0,0,0,10.88,26.25,8,8,0,0,0,6,3.93l23.72,2.64q1.49,1.56,3,3L70,215.46a8,8,0,0,0,3.94,6,107.71,107.71,0,0,0,26.25,10.87,8,8,0,0,0,7.06-1.49L125.84,216q2.16.06,4.32,0l18.64,14.92a8,8,0,0,0,7.06,1.48,107.21,107.21,0,0,0,26.25-10.88,8,8,0,0,0,3.93-6l2.64-23.72q1.56-1.48,3-3L215.46,186a8,8,0,0,0,6-3.94,107.71,107.71,0,0,0,10.87-26.25,8,8,0,0,0-1.49-7.06Zm-16.1-6.5a73.93,73.93,0,0,1,0,8.68,8,8,0,0,0,1.74,5.48l14.19,17.73a91.57,91.57,0,0,1-6.23,15L187,173.11a8,8,0,0,0-5.1,2.64,74.11,74.11,0,0,1-6.14,6.14,8,8,0,0,0-2.64,5.1l-2.51,22.58a91.32,91.32,0,0,1-15,6.23l-17.74-14.19a8,8,0,0,0-5-1.75h-.48a73.93,73.93,0,0,1-8.68,0,8,8,0,0,0-5.48,1.74L100.45,215.8a91.57,91.57,0,0,1-15-6.23L82.89,187a8,8,0,0,0-2.64-5.1,74.11,74.11,0,0,1-6.14-6.14,8,8,0,0,0-5.1-2.64L46.43,170.6a91.32,91.32,0,0,1-6.23-15l14.19-17.74a8,8,0,0,0,1.74-5.48,73.93,73.93,0,0,1,0-8.68,8,8,0,0,0-1.74-5.48L40.2,100.45a91.57,91.57,0,0,1,6.23-15L69,82.89a8,8,0,0,0,5.1-2.64,74.11,74.11,0,0,1,6.14-6.14A8,8,0,0,0,82.89,69L85.4,46.43a91.32,91.32,0,0,1,15-6.23l17.74,14.19a8,8,0,0,0,5.48,1.74,73.93,73.93,0,0,1,8.68,0,8,8,0,0,0,5.48-1.74L155.55,40.2a91.57,91.57,0,0,1,15,6.23L173.11,69a8,8,0,0,0,2.64,5.1,74.11,74.11,0,0,1,6.14,6.14,8,8,0,0,0,5.1,2.64l22.58,2.51a91.32,91.32,0,0,1,6.23,15l-14.19,17.74A8,8,0,0,0,199.87,123.66Z"
                  ></path>
                </svg>
              </div>
            </button>
          </div>
        </div>
        <div class="flex items-center gap-4 bg-[#f8fcf9] px-4 min-h-[72px] py-2">
          <div
            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-fit"
            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDUR03QGHhrh6KYbfte2s_-KxCSQ02mJFmec8r1bHD7nJdYsPP4MreRamZN5xs2yF_wM79uywvqasf8vgwq-ZOBjZVl8U8_nPp7-R1jdoPnc6XcLGmE-i0ZqY6K79h-gdJp0L8ZvnUlljoarp2OCNIOO60YWUqD-5vp0ib_ab02aepGzqkurCu_e-bXCiIsrN6FZjhart1OtXySzcpzR954HxqfkBDeLCxf6RqLNlEQg7hl_dsyZ5pPLhL7PyvnwwNwvnR_nYkMlliA");'
          ></div>
          <div class="flex flex-col justify-center">
            <p class="text-[#0d1b12] text-base font-medium leading-normal line-clamp-1">Dr. Anya approved your lunch photo</p>
            <p class="text-[#4c9a66] text-sm font-normal leading-normal line-clamp-2">1d</p>
          </div>
        </div>
        <div class="flex items-center gap-4 bg-[#f8fcf9] px-4 min-h-[72px] py-2">
          <div
            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-fit"
            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBLinbjKwioKdKlgt3M8T7awHpni04x8J0G8Q0bEZsKor0YlCu4y9zL5iI3rutzpyuqzZrpXOMQBL0vxVOO8WriXnqm-w1rGd8RYeA6FCPRE8JCM9TaUDjR00YOXh0izF9KDFTCSF8t_KaUFkjtRx6_JJNpw6IKjGa6bQQ2o3qW_yFZlPkWC65FDFgDB0jHePNKZkN2LP3JP4LrV7bgp-YvRa4AH2AMuMZmcBquVIM2JnxrMWQJJZQqNSRHDdcKYn1fi7ESQVYN5pI8");'
          ></div>
          <div class="flex flex-col justify-center">
            <p class="text-[#0d1b12] text-base font-medium leading-normal line-clamp-1">Don't forget to log your dinner!</p>
            <p class="text-[#4c9a66] text-sm font-normal leading-normal line-clamp-2">2d</p>
          </div>
        </div>
        <div class="flex items-center gap-4 bg-[#f8fcf9] px-4 min-h-[72px] py-2">
          <div
            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-fit"
            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBHMiPcUlZGutG7zHll46dBrGnqDNvXNAH4ghieAQ10UNhrir_igyLiSgooHaH6B11N_xRwg1DSQyBNFb6ySc9HGeRjHWMB1ZXoXt85dBiQm3j-liBPyLUwOhI2c5P96aE-vhY69QRa96j7bT85JaNtgiDEB6kLlHWIIp3BWoNxhkv6bm0gibeW84oGMXk-NrKLyklYSQSfsuHcPtxrZttv4OMtNurRbron5i-Oz6_4pAJg5v3VGsX5n7w7pNrkQB3kk15iKupgaVKy");'
          ></div>
          <div class="flex flex-col justify-center">
            <p class="text-[#0d1b12] text-base font-medium leading-normal line-clamp-1">Dr. Anya approved your breakfast photo</p>
            <p class="text-[#4c9a66] text-sm font-normal leading-normal line-clamp-2">3d</p>
          </div>
        </div>
        <div class="flex items-center gap-4 bg-[#f8fcf9] px-4 min-h-[72px] py-2">
          <div
            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-fit"
            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDAyjPHyc-QjR2dUaoNvQAswzquRLoopXckA8eITsUOTNLBFbv17NPkVYurYvsswv4AbjlgEwpQrfKAH9CjMqUSs3TLWGGO1M-sExgHeiJeO8_20Hqyrlvyj1Ou9bgrI2q7WiFGAqVWfJCzia-vdJZseXWG8qMaAMnjc_MesAa8i4U40RXsEClltKFHC9htk5pnJilWuOmvlbFXfjeDswVDeZM3a3JyZg-Yl1bRjG2MntgB3RJynlYWQVZ8-LYPPgtgYoK3V8ZzgKRi");'
          ></div>
          <div class="flex flex-col justify-center">
            <p class="text-[#0d1b12] text-base font-medium leading-normal line-clamp-1">Don't forget to log your lunch!</p>
            <p class="text-[#4c9a66] text-sm font-normal leading-normal line-clamp-2">4d</p>
          </div>
        </div>
        <div class="flex items-center gap-4 bg-[#f8fcf9] px-4 min-h-[72px] py-2">
          <div
            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-fit"
            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAkYqB5tbLH76yQg7B5v770Nl3EDpIWqEzKyJn5Z4MVOczNnY2QjjqDapZAkTxRdsz9LbP3zo5yuZhulSE0HRAEU7ASNO5M0NpZM6P0QSo6cooQpUAkP5Rq19XK-MPNuVbM0rdD6lO7d2Wxu4Z30LLJ6aQQTjbA2PYGQtDVJ_U2GiajMjJWfxm2iUfr-hd3S6f7dCKQXG2AXFVlu8Pv8dINs8hZZSCi3T_Pi1OnLuSLWoJAk0dcXm8WmMzjzAkf--wPytFxymxpG8r6");'
          ></div>
          <div class="flex flex-col justify-center">
            <p class="text-[#0d1b12] text-base font-medium leading-normal line-clamp-1">Dr. Anya approved your dinner photo</p>
            <p class="text-[#4c9a66] text-sm font-normal leading-normal line-clamp-2">5d</p>
          </div>
        </div>
      </div>
      <div>
        <div class="flex gap-2 border-t border-[#e7f3eb] bg-[#f8fcf9] px-4 pb-3 pt-2">
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="House" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M218.83,103.77l-80-75.48a1.14,1.14,0,0,1-.11-.11,16,16,0,0,0-21.53,0l-.11.11L37.17,103.77A16,16,0,0,0,32,115.55V208a16,16,0,0,0,16,16H96a16,16,0,0,0,16-16V160h32v48a16,16,0,0,0,16,16h48a16,16,0,0,0,16-16V115.55A16,16,0,0,0,218.83,103.77ZM208,208H160V160a16,16,0,0,0-16-16H112a16,16,0,0,0-16,16v48H48V115.55l.11-.1L128,40l79.9,75.43.11.1Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Home</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="PresentationChart" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M216,40H136V24a8,8,0,0,0-16,0V40H40A16,16,0,0,0,24,56V176a16,16,0,0,0,16,16H79.36L57.75,219a8,8,0,0,0,12.5,10l29.59-37h56.32l29.59,37a8,8,0,1,0,12.5-10l-21.61-27H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,136H40V56H216V176ZM104,120v24a8,8,0,0,1-16,0V120a8,8,0,0,1,16,0Zm32-16v40a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm32-16v56a8,8,0,0,1-16,0V88a8,8,0,0,1,16,0Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Progress</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-[#0d1b12]" href="#">
            <div class="text-[#0d1b12] flex h-8 items-center justify-center" data-icon="Bell" data-size="24px" data-weight="fill">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#0d1b12] text-xs font-medium leading-normal tracking-[0.015em]">Notifications</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="User" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Profile</p>
          </a>
        </div>
        <div class="h-5 bg-[#f8fcf9]"></div>
      </div>
    </div>
  </body>
</html>
</file>

<file path="Design/mobileapp/progress_tab/code.html">
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex h-auto min-h-screen w-full flex-col bg-[#f8fcf9] justify-between group/design-root overflow-x-hidden"
      style='font-family: Manrope, "Noto Sans", sans-serif;'
    >
      <div>
        <div class="flex items-center bg-[#f8fcf9] p-4 pb-2 justify-between">
          <div class="text-[#0d1b12] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
            </svg>
          </div>
          <h2 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Progress</h2>
        </div>
        <div class="flex flex-wrap gap-3 px-4 py-3">
          <div class="flex min-w-[111px] flex-1 basis-[fit-content] flex-col gap-2 rounded-lg border border-[#cfe7d7] p-3 items-center text-center">
            <p class="text-[#0d1b12] tracking-light text-2xl font-bold leading-tight">14</p>
            <div class="flex items-center gap-2"><p class="text-[#4c9a66] text-sm font-normal leading-normal">Adherence streak</p></div>
          </div>
          <div class="flex min-w-[111px] flex-1 basis-[fit-content] flex-col gap-2 rounded-lg border border-[#cfe7d7] p-3 items-center text-center">
            <p class="text-[#0d1b12] tracking-light text-2xl font-bold leading-tight">77%</p>
            <div class="flex items-center gap-2"><p class="text-[#4c9a66] text-sm font-normal leading-normal">On track this week</p></div>
          </div>
        </div>
        <h2 class="text-[#0d1b12] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Milestones</h2>
        <div class="flex overflow-y-auto [-ms-scrollbar-style:none] [scrollbar-width:none] [&amp;::-webkit-scrollbar]:hidden">
          <div class="flex items-stretch p-4 gap-3">
            <div class="flex h-full flex-1 flex-col gap-4 rounded-lg min-w-40">
              <div
                class="w-full bg-center bg-no-repeat aspect-square bg-cover rounded-lg flex flex-col"
                style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuC9GxNfO7srVvuJvM1h7kvU1HiuCR37cNAzW0JajLXckSv3vRNMA9ACuh3gYd44zcey0XiktM2YOkFW-1jc-VH5vp-MfhNxA0Lgb5XP3ZHNa-SRf6AlPqWbiAnI5VlyAagnUK2DhWX8aa1Ike83464p8WpRUYzkjKFLaQ0Qyv6l2AdwZvPXhZc38wPs5fmAMMk8awoBtYVlpYwdDTorNj5PLkd2QtrKYuOHmHhot_O22ZUFIymd210pzabADz95Wi20mjEcMABP_lUD");'
              ></div>
              <p class="text-[#0d1b12] text-base font-medium leading-normal">5kg lost</p>
            </div>
            <div class="flex h-full flex-1 flex-col gap-4 rounded-lg min-w-40">
              <div
                class="w-full bg-center bg-no-repeat aspect-square bg-cover rounded-lg flex flex-col"
                style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuC4iW3MZ0FXRPYTpr3kP0aOEPPpeoFzat9JkCRL3w1DAO1x55GlJJIH2PTedd5mq9EGCliovkPTee9clklaiSgff8vJ5Myvg9MH6waaIiWhBBoKN_d35kk69013tE6y3QpguiCNmQta2pYtY4ZTRE1ucyT6HY0s4ocfv0Ax2ZghVUNtDP7p6InjKBn6WCJR9VA59J43lhACiFLPlsyFkIPAYQR-6xyGkkok34w3DgR1rgHA18OgoAqbR9oTrwAOqpq8_Q3CHmzO9pbt");'
              ></div>
              <p class="text-[#0d1b12] text-base font-medium leading-normal">10kg lost</p>
            </div>
            <div class="flex h-full flex-1 flex-col gap-4 rounded-lg min-w-40">
              <div
                class="w-full bg-center bg-no-repeat aspect-square bg-cover rounded-lg flex flex-col"
                style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBlIfGuyeZYp0AuoFrfYhhzP9nOTd6cDO4uy0a3D2FnO3aCaAIO-uQ8gpo_4pvNbuxXFIAZ062oxlVlac6oGAyx4ojjxFCZKmYsvcQNuydL5eWfr51GwEZeewWrHawL1ryJvoh5yi7Y_3yMhwiLqKlY2pRFDpZzhAETWfRgeoi-1TXo46LDmr9NKlAPrCzYPcDnKw7oP_tPmDZBhDtcPwlQwn87spt07A4mc5UbhxXoBKVSlB7KCp8Fva81vvUWDudb6DtWvqZ-Ev8R");'
              ></div>
              <p class="text-[#0d1b12] text-base font-medium leading-normal">15kg lost</p>
            </div>
          </div>
        </div>
        <h2 class="text-[#0d1b12] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Weight history</h2>
        <div class="flex flex-wrap gap-4 px-4 py-6">
          <div class="flex min-w-72 flex-1 flex-col gap-2">
            <p class="text-[#0d1b12] text-base font-medium leading-normal">Weight</p>
            <p class="text-[#0d1b12] tracking-light text-[32px] font-bold leading-tight truncate">75kg</p>
            <div class="flex gap-1">
              <p class="text-[#4c9a66] text-base font-normal leading-normal">Last 30 days</p>
              <p class="text-[#e72a08] text-base font-medium leading-normal">-2%</p>
            </div>
            <div class="flex min-h-[180px] flex-1 flex-col gap-8 py-4">
              <svg width="100%" height="148" viewBox="-3 0 478 150" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
                <path
                  d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25V149H326.769H0V109Z"
                  fill="url(#paint0_linear_1131_5935)"
                ></path>
                <path
                  d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25"
                  stroke="#4c9a66"
                  stroke-width="3"
                  stroke-linecap="round"
                ></path>
                <defs>
                  <linearGradient id="paint0_linear_1131_5935" x1="236" y1="1" x2="236" y2="149" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#e7f3eb"></stop>
                    <stop offset="1" stop-color="#e7f3eb" stop-opacity="0"></stop>
                  </linearGradient>
                </defs>
              </svg>
              <div class="flex justify-around">
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">10/10</p>
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">10/17</p>
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">10/24</p>
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">10/31</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div><div class="h-5 bg-[#f8fcf9]"></div></div>
    </div>
  </body>
</html>
</file>

<file path="Design/mobileapp/settings/profile/code.html">
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex h-auto min-h-screen w-full flex-col bg-[#f8fcf9] justify-between group/design-root overflow-x-hidden"
      style='font-family: Manrope, "Noto Sans", sans-serif;'
    >
      <div>
        <div class="flex items-center bg-[#f8fcf9] p-4 pb-2 justify-between">
          <div class="text-[#0d1b12] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
            </svg>
          </div>
          <h2 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Settings</h2>
        </div>
        <div class="flex p-4 @container">
          <div class="flex w-full flex-col gap-4 @[520px]:flex-row @[520px]:justify-between @[520px]:items-center">
            <div class="flex gap-4">
              <div
                class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-32 w-32"
                style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCtMLXSUFpEx1EAJjRQiReiqu58cetfxO6YnzIQps94P0EY0FHwSLVXExr9P52n9m_sIh_WSCcznR6-p-Fax5jYfvNzVyJ51K1aoYejX0JGJwLpaFNT-ndrLhVvwrfs6QFQn6NepKZg-WIp34jHZ2B7D_QvQ0DfRMUgaGM4JcLCVUn1wj67GsAsTkuDj9HIqWNKFZxykkWtNjVQDtMhd3w51IwGNsjk_ICXimGgPLaiaU83sz1ufayjQqSFOOrXHGeUyDPw3hjEDbHi");'
              ></div>
              <div class="flex flex-col justify-center">
                <p class="text-[#0d1b12] text-[22px] font-bold leading-tight tracking-[-0.015em]">Sophia Carter</p>
                <p class="text-[#4c9a66] text-base font-normal leading-normal">Client</p>
              </div>
            </div>
          </div>
        </div>
        <h3 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Profile</h3>
        <div class="flex items-center gap-4 bg-[#f8fcf9] px-4 min-h-[72px] py-2">
          <div class="text-[#0d1b12] flex items-center justify-center rounded-lg bg-[#e7f3eb] shrink-0 size-12" data-icon="User" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path
                d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"
              ></path>
            </svg>
          </div>
          <div class="flex flex-col justify-center">
            <p class="text-[#0d1b12] text-base font-medium leading-normal line-clamp-1">Profile</p>
            <p class="text-[#4c9a66] text-sm font-normal leading-normal line-clamp-2">Edit your profile</p>
          </div>
        </div>
        <div class="flex items-center gap-4 bg-[#f8fcf9] px-4 min-h-[72px] py-2">
          <div class="text-[#0d1b12] flex items-center justify-center rounded-lg bg-[#e7f3eb] shrink-0 size-12" data-icon="Target" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path
                d="M221.87,83.16A104.1,104.1,0,1,1,195.67,49l22.67-22.68a8,8,0,0,1,11.32,11.32l-96,96a8,8,0,0,1-11.32-11.32l27.72-27.72a40,40,0,1,0,17.87,31.09,8,8,0,1,1,16-.9,56,56,0,1,1-22.38-41.65L184.3,60.39a87.88,87.88,0,1,0,23.13,29.67,8,8,0,0,1,14.44-6.9Z"
              ></path>
            </svg>
          </div>
          <div class="flex flex-col justify-center">
            <p class="text-[#0d1b12] text-base font-medium leading-normal line-clamp-1">Goal Weight</p>
            <p class="text-[#4c9a66] text-sm font-normal leading-normal line-clamp-2">Set your goal weight</p>
          </div>
        </div>
        <h3 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Notifications</h3>
        <div class="flex items-center gap-4 bg-[#f8fcf9] px-4 min-h-[72px] py-2 justify-between">
          <div class="flex items-center gap-4">
            <div class="text-[#0d1b12] flex items-center justify-center rounded-lg bg-[#e7f3eb] shrink-0 size-12" data-icon="Bell" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                ></path>
              </svg>
            </div>
            <div class="flex flex-col justify-center">
              <p class="text-[#0d1b12] text-base font-medium leading-normal line-clamp-1">Meal Reminders</p>
              <p class="text-[#4c9a66] text-sm font-normal leading-normal line-clamp-2">Remind me about meals</p>
            </div>
          </div>
          <div class="shrink-0">
            <label
              class="relative flex h-[31px] w-[51px] cursor-pointer items-center rounded-full border-none bg-[#e7f3eb] p-0.5 has-[:checked]:justify-end has-[:checked]:bg-[#13ec5b]"
            >
              <div class="h-full w-[27px] rounded-full bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
              <input type="checkbox" class="invisible absolute" />
            </label>
          </div>
        </div>
        <h3 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Support</h3>
        <div class="flex items-center gap-4 bg-[#f8fcf9] px-4 min-h-[72px] py-2">
          <div class="text-[#0d1b12] flex items-center justify-center rounded-lg bg-[#e7f3eb] shrink-0 size-12" data-icon="Question" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path
                d="M140,180a12,12,0,1,1-12-12A12,12,0,0,1,140,180ZM128,72c-22.06,0-40,16.15-40,36v4a8,8,0,0,0,16,0v-4c0-11,10.77-20,24-20s24,9,24,20-10.77,20-24,20a8,8,0,0,0-8,8v8a8,8,0,0,0,16,0v-.72c18.24-3.35,32-17.9,32-35.28C168,88.15,150.06,72,128,72Zm104,56A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"
              ></path>
            </svg>
          </div>
          <div class="flex flex-col justify-center">
            <p class="text-[#0d1b12] text-base font-medium leading-normal line-clamp-1">Help &amp; FAQ</p>
            <p class="text-[#4c9a66] text-sm font-normal leading-normal line-clamp-2">Get help with the app</p>
          </div>
        </div>
      </div>
      <div>
        <div class="flex px-4 py-3">
          <button
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 flex-1 bg-[#e7f3eb] text-[#0d1b12] text-sm font-bold leading-normal tracking-[0.015em]"
          >
            <span class="truncate">Logout</span>
          </button>
        </div>
        <div class="flex gap-2 border-t border-[#e7f3eb] bg-[#f8fcf9] px-4 pb-3 pt-2">
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="House" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M218.83,103.77l-80-75.48a1.14,1.14,0,0,1-.11-.11,16,16,0,0,0-21.53,0l-.11.11L37.17,103.77A16,16,0,0,0,32,115.55V208a16,16,0,0,0,16,16H96a16,16,0,0,0,16-16V160h32v48a16,16,0,0,0,16,16h48a16,16,0,0,0,16-16V115.55A16,16,0,0,0,218.83,103.77ZM208,208H160V160a16,16,0,0,0-16-16H112a16,16,0,0,0-16,16v48H48V115.55l.11-.1L128,40l79.9,75.43.11.1Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Home</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="PresentationChart" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M216,40H136V24a8,8,0,0,0-16,0V40H40A16,16,0,0,0,24,56V176a16,16,0,0,0,16,16H79.36L57.75,219a8,8,0,0,0,12.5,10l29.59-37h56.32l29.59,37a8,8,0,1,0,12.5-10l-21.61-27H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,136H40V56H216V176ZM104,120v24a8,8,0,0,1-16,0V120a8,8,0,0,1,16,0Zm32-16v40a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm32-16v56a8,8,0,0,1-16,0V88a8,8,0,0,1,16,0Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Progress</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="Bell" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Notifications</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-[#0d1b12]" href="#">
            <div class="text-[#0d1b12] flex h-8 items-center justify-center" data-icon="User" data-size="24px" data-weight="fill">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M230.93,220a8,8,0,0,1-6.93,4H32a8,8,0,0,1-6.92-12c15.23-26.33,38.7-45.21,66.09-54.16a72,72,0,1,1,73.66,0c27.39,8.95,50.86,27.83,66.09,54.16A8,8,0,0,1,230.93,220Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#0d1b12] text-xs font-medium leading-normal tracking-[0.015em]">Profile</p>
          </a>
        </div>
        <div class="h-5 bg-[#f8fcf9]"></div>
      </div>
    </div>
  </body>
</html>
</file>

<file path="Design/mobileapp/weight_tracking/code.html">
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex h-auto min-h-screen w-full flex-col bg-[#f8fcf9] justify-between group/design-root overflow-x-hidden"
      style='font-family: Manrope, "Noto Sans", sans-serif;'
    >
      <div>
        <div class="flex items-center bg-[#f8fcf9] p-4 pb-2 justify-between">
          <div class="text-[#0d1b12] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
            </svg>
          </div>
          <h2 class="text-[#0d1b12] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Weight Tracking</h2>
        </div>
        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
          <label class="flex flex-col min-w-40 flex-1">
            <p class="text-[#0d1b12] text-base font-medium leading-normal pb-2">Current Weight</p>
            <input
              class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d1b12] focus:outline-0 focus:ring-0 border-none bg-[#e7f3eb] focus:border-none h-14 placeholder:text-[#4c9a66] p-4 text-base font-normal leading-normal"
              value=""
            />
          </label>
        </div>
        <div class="flex flex-wrap gap-4 px-4 py-6">
          <div class="flex min-w-72 flex-1 flex-col gap-2">
            <p class="text-[#0d1b12] text-base font-medium leading-normal">Weight Progress</p>
            <p class="text-[#0d1b12] tracking-light text-[32px] font-bold leading-tight truncate">72.5 kg</p>
            <p class="text-[#4c9a66] text-base font-normal leading-normal">Last 8 Weeks</p>
            <div class="flex min-h-[180px] flex-1 flex-col gap-8 py-4">
              <svg width="100%" height="148" viewBox="-3 0 478 150" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
                <path
                  d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25V149H326.769H0V109Z"
                  fill="url(#paint0_linear_1131_5935)"
                ></path>
                <path
                  d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25"
                  stroke="#4c9a66"
                  stroke-width="3"
                  stroke-linecap="round"
                ></path>
                <defs>
                  <linearGradient id="paint0_linear_1131_5935" x1="236" y1="1" x2="236" y2="149" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#e7f3eb"></stop>
                    <stop offset="1" stop-color="#e7f3eb" stop-opacity="0"></stop>
                  </linearGradient>
                </defs>
              </svg>
              <div class="flex justify-around">
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 1</p>
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 2</p>
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 3</p>
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 4</p>
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 5</p>
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 6</p>
                <p class="text-[#4c9a66] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 7</p>
              </div>
            </div>
          </div>
        </div>
        <div class="flex flex-col gap-3 p-4">
          <div class="flex gap-6 justify-between"><p class="text-[#0d1b12] text-base font-medium leading-normal">Goal: 65 kg</p></div>
          <div class="rounded bg-[#cfe7d7]"><div class="h-2 rounded bg-[#13ec5b]" style="width: 75%;"></div></div>
          <p class="text-[#4c9a66] text-sm font-normal leading-normal">7.5 kg to go</p>
        </div>
      </div>
      <div>
        <div class="flex justify-end overflow-hidden px-5 pb-5">
          <button
            class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-14 px-5 bg-[#13ec5b] text-[#0d1b12] text-base font-bold leading-normal tracking-[0.015em] min-w-0 gap-4 pl-4 pr-6"
          >
            <div class="text-[#0d1b12]" data-icon="PencilSimple" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.68,147.31,64l24-24L216,84.68Z"
                ></path>
              </svg>
            </div>
            <span class="truncate">Update Weight</span>
          </button>
        </div>
        <div class="flex gap-2 border-t border-[#e7f3eb] bg-[#f8fcf9] px-4 pb-3 pt-2">
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="House" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M218.83,103.77l-80-75.48a1.14,1.14,0,0,1-.11-.11,16,16,0,0,0-21.53,0l-.11.11L37.17,103.77A16,16,0,0,0,32,115.55V208a16,16,0,0,0,16,16H96a16,16,0,0,0,16-16V160h32v48a16,16,0,0,0,16,16h48a16,16,0,0,0,16-16V115.55A16,16,0,0,0,218.83,103.77ZM208,208H160V160a16,16,0,0,0-16-16H112a16,16,0,0,0-16,16v48H48V115.55l.11-.1L128,40l79.9,75.43.11.1Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Home</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-[#0d1b12]" href="#">
            <div class="text-[#0d1b12] flex h-8 items-center justify-center" data-icon="PresentationChart" data-size="24px" data-weight="fill">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M216,40H136V24a8,8,0,0,0-16,0V40H40A16,16,0,0,0,24,56V176a16,16,0,0,0,16,16H79.36L57.75,219a8,8,0,0,0,12.5,10l29.59-37h56.32l29.59,37a8,8,0,1,0,12.5-10l-21.61-27H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40ZM104,144a8,8,0,0,1-16,0V120a8,8,0,0,1,16,0Zm32,0a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm32,0a8,8,0,0,1-16,0V88a8,8,0,0,1,16,0Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#0d1b12] text-xs font-medium leading-normal tracking-[0.015em]">Progress</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="Bell" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Notifications</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-[#4c9a66]" href="#">
            <div class="text-[#4c9a66] flex h-8 items-center justify-center" data-icon="User" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"
                ></path>
              </svg>
            </div>
            <p class="text-[#4c9a66] text-xs font-medium leading-normal tracking-[0.015em]">Profile</p>
          </a>
        </div>
        <div class="h-5 bg-[#f8fcf9]"></div>
      </div>
    </div>
  </body>
</html>
</file>

<file path="Design/website/Design/analytics/progress/code.html">
<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dietician Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#4A90E2",
              "secondary": "#50E3C2",
              "danger": "#F5A623",
              "background-light": "#F4F7FA",
              "background-dark": "#112116",
              "neutral-text": "#4A4A4A",
              "neutral-border": "#E0E0E0",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-neutral-text dark:text-gray-200">
<div class="relative flex min-h-screen w-full flex-col">
<div class="flex h-full flex-1">
<!-- SideNavBar -->
<aside class="flex w-64 flex-col gap-8 border-r border-neutral-border/80 bg-white dark:bg-background-dark dark:border-neutral-border/20 p-4">
<div class="flex items-center gap-3 px-2">
<span class="material-symbols-outlined text-primary text-3xl">health_and_safety</span>
<h1 class="text-xl font-bold text-neutral-text dark:text-white">NutriTrack</h1>
</div>
<div class="flex h-full flex-col justify-between">
<div class="flex flex-col gap-2">
<a class="flex items-center gap-3 rounded-lg bg-primary/20 dark:bg-primary/30 px-3 py-2 text-primary dark:text-white" href="#">
<span class="material-symbols-outlined">dashboard</span>
<p class="text-sm font-semibold">Dashboard</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 text-neutral-text/80 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10" href="#">
<span class="material-symbols-outlined">group</span>
<p class="text-sm font-medium">Clients</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 text-neutral-text/80 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10" href="#">
<span class="material-symbols-outlined">chat_bubble</span>
<p class="text-sm font-medium">Messages</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 text-neutral-text/80 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10" href="#">
<span class="material-symbols-outlined">settings</span>
<p class="text-sm font-medium">Settings</p>
</a>
</div>
<div class="flex flex-col">
<div class="mb-4 flex gap-3 border-t border-neutral-border/80 dark:border-neutral-border/20 pt-4">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Dr. Emily Carter" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuA96o5wzzpqKQwmSanszsJuVP8eH5xjp8ZNsLL7hXw8hJK01o9Amkz2ZoxXpeKj0XfzckJzsJ7uXIEznoSEYfNAoHjGxFRu-V_B1xP0E5yzRy44iBtBRIi3m3eSm35bzyCu5xgB44faAVd9OS9V3j6HdKomQCR6Sy1jPvt7LL0UKmH11dgtZVVvbcLMTZKNa2P6kAStJ-ektWtNo8FeLY6MnKqNK0H_bXLuUmCzGjbQ8h3r5y66nagMsh3Lt0nJQdNmVWbrSjjIsuZL");'></div>
<div class="flex flex-col">
<h1 class="text-neutral-text dark:text-white text-base font-medium leading-normal">Dr. Emily Carter</h1>
<p class="text-neutral-text/70 dark:text-gray-400 text-sm font-normal leading-normal">Dietician</p>
</div>
</div>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 text-neutral-text/80 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10" href="#">
<span class="material-symbols-outlined">logout</span>
<p class="text-sm font-medium">Log Out</p>
</a>
</div>
</div>
</aside>
<!-- Main Content -->
<main class="flex-1 overflow-y-auto p-8">
<div class="mx-auto flex w-full max-w-7xl flex-col gap-8">
<!-- PageHeading & Chips -->
<div class="flex flex-wrap items-start justify-between gap-4">
<div class="flex flex-col gap-2">
<p class="text-3xl font-bold leading-tight tracking-tight text-neutral-text dark:text-white">Progress Overview</p>
<p class="text-base font-normal leading-normal text-neutral-text/70 dark:text-gray-400">Here is your clients' progress for this month.</p>
</div>
<div class="flex items-center gap-2">
<div class="flex gap-2">
<button class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-white dark:bg-white/10 px-4 text-neutral-text dark:text-gray-200 shadow-sm border border-neutral-border dark:border-neutral-border/20">
<p class="text-sm font-medium leading-normal">This Month</p>
<span class="material-symbols-outlined text-lg">expand_more</span>
</button>
</div>
<button class="flex h-10 cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-primary px-4 text-white text-sm font-bold shadow-sm">
<span class="truncate">Export Report</span>
</button>
</div>
</div>
<!-- Stats -->
<div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
<div class="flex flex-1 flex-col gap-2 rounded-xl bg-white dark:bg-background-dark p-6 shadow-sm border border-neutral-border dark:border-neutral-border/20">
<p class="text-base font-medium leading-normal text-neutral-text dark:text-gray-300">Total Clients This Month</p>
<p class="tracking-light text-3xl font-bold leading-tight text-neutral-text dark:text-white">42</p>
<div class="flex items-center gap-1 text-secondary">
<span class="material-symbols-outlined text-lg">arrow_upward</span>
<p class="text-sm font-medium leading-normal">+5%</p>
</div>
</div>
<div class="flex flex-1 flex-col gap-2 rounded-xl bg-white dark:bg-background-dark p-6 shadow-sm border border-neutral-border dark:border-neutral-border/20">
<p class="text-base font-medium leading-normal text-neutral-text dark:text-gray-300">Overall Adherence</p>
<p class="tracking-light text-3xl font-bold leading-tight text-neutral-text dark:text-white">85%</p>
<div class="flex items-center gap-1 text-secondary">
<span class="material-symbols-outlined text-lg">arrow_upward</span>
<p class="text-sm font-medium leading-normal">+2.1%</p>
</div>
</div>
<div class="flex flex-1 flex-col gap-2 rounded-xl bg-white dark:bg-background-dark p-6 shadow-sm border border-neutral-border dark:border-neutral-border/20">
<p class="text-base font-medium leading-normal text-neutral-text dark:text-gray-300">Avg. Weight Loss</p>
<p class="tracking-light text-3xl font-bold leading-tight text-neutral-text dark:text-white">2.5 lbs</p>
<div class="flex items-center gap-1 text-danger">
<span class="material-symbols-outlined text-lg">arrow_downward</span>
<p class="text-sm font-medium leading-normal">-0.5 lbs</p>
</div>
</div>
</div>
<!-- Charts -->
<div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
<div class="flex flex-1 flex-col gap-2 rounded-xl border border-neutral-border dark:border-neutral-border/20 bg-white dark:bg-background-dark p-6 shadow-sm">
<p class="text-base font-medium leading-normal text-neutral-text dark:text-gray-300">Meals Logged Per Week</p>
<p class="tracking-light text-3xl font-bold leading-tight truncate text-neutral-text dark:text-white">1,234</p>
<div class="flex items-center gap-1">
<p class="text-sm font-normal leading-normal text-neutral-text/70 dark:text-gray-400">Last 8 Weeks</p>
<p class="text-sm font-medium leading-normal text-secondary">+12%</p>
</div>
<div class="flex min-h-[180px] flex-1 flex-col gap-8 py-4">
<svg fill="none" height="100%" preserveaspectratio="none" viewbox="-3 0 478 150" width="100%" xmlns="http://www.w3.org/2000/svg">
<path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25V149H326.769H0V109Z" fill="url(#chart-gradient-1)"></path>
<path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25" stroke="#4A90E2" stroke-linecap="round" stroke-width="3"></path>
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="chart-gradient-1" x1="236" x2="236" y1="1" y2="149">
<stop stop-color="#4A90E2" stop-opacity="0.2"></stop>
<stop offset="1" stop-color="#4A90E2" stop-opacity="0"></stop>
</lineargradient>
</defs>
</svg>
</div>
</div>
<div class="flex flex-1 flex-col gap-2 rounded-xl border border-neutral-border dark:border-neutral-border/20 bg-white dark:bg-background-dark p-6 shadow-sm">
<p class="text-base font-medium leading-normal text-neutral-text dark:text-gray-300">Adherence Over Time</p>
<p class="tracking-light text-3xl font-bold leading-tight truncate text-neutral-text dark:text-white">85%</p>
<div class="flex items-center gap-1">
<p class="text-sm font-normal leading-normal text-neutral-text/70 dark:text-gray-400">Last 90 Days</p>
<p class="text-sm font-medium leading-normal text-secondary">+2.1%</p>
</div>
<div class="flex min-h-[180px] flex-1 flex-col gap-8 py-4">
<svg fill="none" height="100%" preserveaspectratio="none" viewbox="-3 0 478 150" width="100%" xmlns="http://www.w3.org/2000/svg">
<path d="M0 81C18.1538 81 18.1538 121 36.3077 121C54.4615 121 54.4615 101 72.6154 101C90.7692 101 90.7692 61 108.923 61C127.077 61 127.077 33 145.231 33C163.385 33 163.385 41 181.538 41C199.692 41 199.692 21 217.846 21C236 21 236 45 254.154 45C272.308 45 272.308 1 290.462 1C308.615 1 308.615 25 326.769 25C344.923 25 344.923 81 363.077 81C381.231 81 381.231 109 399.385 109C417.538 109 417.538 129 435.692 129C453.846 129 453.846 149 472 149V149H0V81Z" fill="url(#chart-gradient-2)"></path>
<path d="M0 81C18.1538 81 18.1538 121 36.3077 121C54.4615 121 54.4615 101 72.6154 101C90.7692 101 90.7692 61 108.923 61C127.077 61 127.077 33 145.231 33C163.385 33 163.385 41 181.538 41C199.692 41 199.692 21 217.846 21C236 21 236 45 254.154 45C272.308 45 272.308 1 290.462 1C308.615 1 308.615 25 326.769 25C344.923 25 344.923 81 363.077 81C381.231 81 381.231 109 399.385 109C417.538 109 417.538 129 435.692 129C453.846 129 453.846 149 472 149" stroke="#4A90E2" stroke-linecap="round" stroke-width="3"></path>
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="chart-gradient-2" x1="236" x2="236" y1="1" y2="149">
<stop stop-color="#4A90E2" stop-opacity="0.2"></stop>
<stop offset="1" stop-color="#4A90E2" stop-opacity="0"></stop>
</lineargradient>
</defs>
</svg>
</div>
</div>
</div>
<!-- Client Tables -->
<div class="grid grid-cols-1 gap-6 xl:grid-cols-2">
<div class="flex flex-col gap-4 rounded-xl border border-neutral-border dark:border-neutral-border/20 bg-white dark:bg-background-dark p-6 shadow-sm">
<h3 class="text-lg font-semibold text-neutral-text dark:text-white">Top Clients by Progress</h3>
<div class="overflow-x-auto">
<table class="w-full text-left">
<thead>
<tr class="border-b border-neutral-border dark:border-neutral-border/20">
<th class="p-3 text-sm font-semibold text-neutral-text/70 dark:text-gray-400">Client Name</th>
<th class="p-3 text-sm font-semibold text-neutral-text/70 dark:text-gray-400">Progress</th>
<th class="p-3 text-sm font-semibold text-neutral-text/70 dark:text-gray-400">Adherence</th>
</tr>
</thead>
<tbody>
<tr class="border-b border-neutral-border dark:border-neutral-border/20">
<td class="p-3 whitespace-nowrap"><div class="flex items-center gap-3"><img class="size-8 rounded-full object-cover" data-alt="Client avatar" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDoQBH58-UOFb0Rve-570SZJHw1vywLmyD9bBbGA8r8yRZL1mefbhhG_ZWz1vtoh7Xz7oMO20OhnWAStn4MlFVxGdmCXduy9BICGw-C4qTsSTyXb5mLI8kY-PiTQsu1Mh3YeeBNUp6j40CcGHSOOcz9dwZ8mJAy5G-yg118GiDa1te_CWf6kQ85NnGQxDdTArPD2FHccLUcjZQ2RWS01COkPyfPwwNXV4HCwGml86o4O5gA2YBEoZ-zehhddqazpsdkBKTo3CDzdEed"/><span class="font-medium text-neutral-text dark:text-gray-200">Olivia Martinez</span></div></td>
<td class="p-3 text-sm text-secondary font-medium">-8 lbs</td>
<td class="p-3 text-sm text-neutral-text dark:text-gray-300">95%</td>
</tr>
<tr class="border-b border-neutral-border dark:border-neutral-border/20">
<td class="p-3 whitespace-nowrap"><div class="flex items-center gap-3"><img class="size-8 rounded-full object-cover" data-alt="Client avatar" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBsevW0g05AmLMZmT39Kvmun2gqseQGYbSJpkMgrVn7jn3Fuy0Lw_UQodlK7uiRbtbolVuocHp8Igm51E8asjsFb8FLC8f1I5CeAlQ9ryhSmDWnQ1tW3IVjfE6ahrehdQm7crHK9N-fF8VgqRUs7_xC0YkiNo44EX7ycOPr00INSkWlOpErD_FEAb0pePAhWsjonBmoZeGxCjofR1z3KMrtT7JeLw7qOseZ1sUH2t4moJRAaALDkq0jSFv1eB3YiP_3pIvsc2xceNUg"/><span class="font-medium text-neutral-text dark:text-gray-200">Liam Wilson</span></div></td>
<td class="p-3 text-sm text-secondary font-medium">-7.5 lbs</td>
<td class="p-3 text-sm text-neutral-text dark:text-gray-300">92%</td>
</tr>
<tr>
<td class="p-3 whitespace-nowrap"><div class="flex items-center gap-3"><img class="size-8 rounded-full object-cover" data-alt="Client avatar" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBuJr8JpLuLZFYFIC5zGyoB09MhvwSiktgyQxCyqTxnwJCBna4H-XozQm2NkT_XmatpfO7GgPG_-sUXtbSKxpBze4Tx8eTwx70X4ZShfv_e4R-eJY82twmGjnMJqBLr3hdiXKDHIMpRK0WqcJG2ir7B-IEzMk45yvfzyWEtmcqrikGYhn0CBhDKxZvB4zeS2rVkejxDgpJkM_xrrAv_-IIDbUsQbKNyF58plDfVrmkFI4vUGJEeDK2_71ndZakWOsb3aeay9h0eaMJo"/><span class="font-medium text-neutral-text dark:text-gray-200">Sophia Garcia</span></div></td>
<td class="p-3 text-sm text-secondary font-medium">-6 lbs</td>
<td class="p-3 text-sm text-neutral-text dark:text-gray-300">88%</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="flex flex-col gap-4 rounded-xl border border-neutral-border dark:border-neutral-border/20 bg-white dark:bg-background-dark p-6 shadow-sm">
<h3 class="text-lg font-semibold text-neutral-text dark:text-white">At-Risk Clients</h3>
<div class="overflow-x-auto">
<table class="w-full text-left">
<thead>
<tr class="border-b border-neutral-border dark:border-neutral-border/20">
<th class="p-3 text-sm font-semibold text-neutral-text/70 dark:text-gray-400">Client Name</th>
<th class="p-3 text-sm font-semibold text-neutral-text/70 dark:text-gray-400">Last Logged</th>
<th class="p-3 text-sm font-semibold text-neutral-text/70 dark:text-gray-400">Action</th>
</tr>
</thead>
<tbody>
<tr class="border-b border-neutral-border dark:border-neutral-border/20">
<td class="p-3 whitespace-nowrap"><div class="flex items-center gap-3"><img class="size-8 rounded-full object-cover" data-alt="Client avatar" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDvfeBZRNDokJuyigYOf7swYYkUhcZeq8Xa__GY1nx6LPsRIBkKOlm-X3S7CCX9TkVhl50-V4XS5_A8paBFtAwCvhjQJr0y6s7CMQBVw5YLwOHBysOvxVZi_68LD9nk2jz4bov0dRPbT_bKffz_dM8MEl2HfxLPSjVkOA-wZ3pKD25NciXlckzsqa7HR9hQqn5gLPd3z6ZH2zqSpffTGClkOHqPk8_tF7y-SFjW19J2ixpk6UZDKuEeJQun3yB7i0emQuAeiFNuOpT_"/><span class="font-medium text-neutral-text dark:text-gray-200">Noah Rodriguez</span></div></td>
<td class="p-3"><span class="rounded-full bg-danger/20 px-2 py-1 text-xs font-medium text-danger dark:bg-danger/30 dark:text-yellow-300">5 days ago</span></td>
<td class="p-3"><button class="h-8 rounded-lg border border-primary px-3 text-xs font-bold text-primary hover:bg-primary/10">Contact</button></td>
</tr>
<tr class="border-b border-neutral-border dark:border-neutral-border/20">
<td class="p-3 whitespace-nowrap"><div class="flex items-center gap-3"><img class="size-8 rounded-full object-cover" data-alt="Client avatar" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBcaW5B33q5kD_u9KGU3AmSxrvuahqJcGW6n9otbtVf88GpP8aicI8-eJU_L2uxIrmjxYYF-HsJ4rOIU16cHSq4VShtus50x3FchpFU5qgnHissAlF4UUa9am4VBvRQ6cP0jZ2BYkwSHFaUVeCFtgvNkYIXu8rH1rEX7LBN0CaQ1PXePQ2-GZhg9BwMAUawPHKdHVS85pvHELEF0KNPHW31XAiD_1Huk-FyVfc5B9TxLfkfuFXyqcn5MrQkxJ-yQGOFHXk-CjvrMkkF"/><span class="font-medium text-neutral-text dark:text-gray-200">Isabella Lee</span></div></td>
<td class="p-3"><span class="rounded-full bg-danger/20 px-2 py-1 text-xs font-medium text-danger dark:bg-danger/30 dark:text-yellow-300">8 days ago</span></td>
<td class="p-3"><button class="h-8 rounded-lg border border-primary px-3 text-xs font-bold text-primary hover:bg-primary/10">Contact</button></td>
</tr>
<tr>
<td class="p-3 whitespace-nowrap"><div class="flex items-center gap-3"><img class="size-8 rounded-full object-cover" data-alt="Client avatar" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBly7oECncXOyMEjr6iphhmrneD1AviVdZkSUpLQA2lkn74vpCkxrCpQFQ67rmXAuCivi006wjpKgz27JIm2Y0aSnM_XeQrKvT3jBNwdgHdquAMoQ0arCckvwvW3Z76evPk8qKbI4Ae8Zkbk1_8_UVlzdp1MBl1W1Y4K-YkKeImSU7MoKgODtdkfD-TGmGxFEeTzRDxARqW3xLoSie2G5tHzo2xlwQxDHD7FHrJ3PntCtppTtQlj8-_XrYOFHlAcBLgT_1XovuBL7sJ"/><span class="font-medium text-neutral-text dark:text-gray-200">James Walker</span></div></td>
<td class="p-3"><span class="rounded-full bg-danger/20 px-2 py-1 text-xs font-medium text-danger dark:bg-danger/30 dark:text-yellow-300">12 days ago</span></td>
<td class="p-3"><button class="h-8 rounded-lg border border-primary px-3 text-xs font-bold text-primary hover:bg-primary/10">Contact</button></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</main>
</div>
</div>
</body></html>
</file>

<file path="Design/website/Design/client_list/code.html">
<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Clients Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2E8B57",
                        "background-light": "#f6f8f6",
                        "background-dark": "#112116",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24;
            font-size: 24px;
        }

        .material-symbols-outlined.fill {
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#333333] dark:text-gray-200">
<div class="relative flex min-h-screen w-full">
<!-- SideNavBar -->
<aside class="flex flex-col w-64 bg-background-light dark:bg-background-dark border-r border-gray-200 dark:border-gray-700 p-4">
<div class="flex flex-col gap-4">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Dr. Evelyn Reed" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCVKYm04hSTTeeF3YO6cfvZlMYr1q04JowA4yldgWIrDtLeAt4sMI9U0aXqoDOePN7ZIe8rRe-Fa6Bm-tGrQlkdpOYzox3JUw-bfj2v1G0D8vTudIUoXSmjj06sKkvj2juoov0_vWpK-OgEOu6mL-IeGEPHlV21lH1vSyetcobaoyXbty1cWjlxSOOiCAYFqHsKXoAGeTq7gyALhozqZU8KvRR5UYL41Jy-VYOMtukDUi_f9B5BwtBv-IJsJ9lMmIEgYDahCDGBfdXi");'></div>
<div class="flex flex-col">
<h1 class="text-[#333333] dark:text-gray-100 text-base font-medium leading-normal">Dr. Evelyn Reed</h1>
<p class="text-primary text-sm font-normal leading-normal">Dietician</p>
</div>
</div>
<nav class="flex flex-col gap-2 mt-4">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-[#333333] dark:text-gray-300 hover:bg-primary/20 dark:hover:bg-primary/30" href="#">
<span class="material-symbols-outlined">dashboard</span>
<p class="text-sm font-medium leading-normal">Dashboard</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary font-bold" href="#">
<span class="material-symbols-outlined fill">group</span>
<p class="text-sm font-medium leading-normal">Clients</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-[#333333] dark:text-gray-300 hover:bg-primary/20 dark:hover:bg-primary/30" href="#">
<span class="material-symbols-outlined">mail</span>
<p class="text-sm font-medium leading-normal">Messages</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-[#333333] dark:text-gray-300 hover:bg-primary/20 dark:hover:bg-primary/30" href="#">
<span class="material-symbols-outlined">calendar_month</span>
<p class="text-sm font-medium leading-normal">Appointments</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-[#333333] dark:text-gray-300 hover:bg-primary/20 dark:hover:bg-primary/30" href="#">
<span class="material-symbols-outlined">bar_chart</span>
<p class="text-sm font-medium leading-normal">Reports</p>
</a>
</nav>
</div>
<div class="mt-auto flex flex-col gap-1">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-[#333333] dark:text-gray-300 hover:bg-primary/20 dark:hover:bg-primary/30" href="#">
<span class="material-symbols-outlined">settings</span>
<p class="text-sm font-medium leading-normal">Settings</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-[#333333] dark:text-gray-300 hover:bg-primary/20 dark:hover:bg-primary/30" href="#">
<span class="material-symbols-outlined">help</span>
<p class="text-sm font-medium leading-normal">Help</p>
</a>
</div>
</aside>
<!-- Main Content -->
<main class="flex-1 p-8 overflow-y-auto">
<div class="max-w-7xl mx-auto">
<!-- PageHeading -->
<header class="flex flex-wrap justify-between items-center gap-4 mb-6">
<h1 class="text-[#333333] dark:text-gray-100 text-4xl font-black leading-tight tracking-[-0.033em]">Clients</h1>
<button class="flex items-center justify-center gap-2 h-10 px-4 bg-primary text-white rounded-lg text-sm font-medium shadow-sm hover:bg-primary/90 transition-colors">
<span class="material-symbols-outlined">add</span>
                        Add New Client
                    </button>
</header>
<!-- Search and Filters -->
<div class="flex flex-col md:flex-row gap-4 mb-6">
<!-- SearchBar -->
<div class="flex-grow">
<label class="flex flex-col h-12 w-full">
<div class="flex w-full flex-1 items-stretch rounded-lg h-full bg-gray-100 dark:bg-gray-800">
<div class="text-primary flex items-center justify-center pl-4">
<span class="material-symbols-outlined">search</span>
</div>
<input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden text-[#333333] dark:text-gray-200 focus:outline-0 focus:ring-0 border-none bg-transparent h-full placeholder:text-gray-500 dark:placeholder:text-gray-400 pl-2 text-base font-normal leading-normal" placeholder="Search by name, phone, or email..." value=""/>
</div>
</label>
</div>
<!-- Chips -->
<div class="flex gap-2 p-2 items-center flex-wrap">
<button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-primary text-white px-4">
<p class="text-sm font-medium leading-normal">All</p>
</button>
<button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-gray-200 dark:bg-gray-700 px-4 text-[#333333] dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">
<p class="text-sm font-medium leading-normal">Active</p>
</button>
<button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-gray-200 dark:bg-gray-700 px-4 text-[#333333] dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">
<p class="text-sm font-medium leading-normal">At risk</p>
</button>
<button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-gray-200 dark:bg-gray-700 px-4 text-[#333333] dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">
<p class="text-sm font-medium leading-normal">Completed</p>
</button>
</div>
</div>
<!-- Table -->
<div class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 bg-background-light dark:bg-background-dark">
<div class="overflow-x-auto">
<table class="w-full">
<thead>
<tr class="bg-gray-50 dark:bg-gray-800">
<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Client</th>
<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Phone</th>
<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Weight (current/goal)</th>
<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Dietician</th>
<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Last Activity</th>
<th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-200 dark:divide-gray-700">
<tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Liam Johnson" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuClpPYXi8g_JHAhR2x5GUM2eOMNTlq9zyAkLAxumUuxoG2g-daiIuVU0KkukCkEJkCCPViwSSTZYT-q3TRXuV_uYbnIhzZgKnDMhnC38JIrqViDc2xPN7meycyowvPFec9W2fdlPbqfwLcjXGsZNx_gcovpjuMSyrlqCR-SBpKZvtAHFEB0KwG1mrfN2cBxTzJTDGuG-6R9rUPLKw3nj7iHuqUvyspTNg_6NqOsrvfW7vMErxFKG_PVt37_XLZH-5YPVok2svg_69Ja");'></div>
<span class="font-medium">Liam Johnson</span>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">(555) 123-4567</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">155 lbs / 150 lbs</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">Dr. Reed</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">2 days ago</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<div class="flex items-center gap-2">
<button class="text-primary hover:underline">View</button>
<button class="text-primary hover:underline">Message</button>
<button class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><span class="material-symbols-outlined">more_vert</span></button>
</div>
</td>
</tr>
<tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Olivia Smith" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCRkdQpFiXZdrd2gCSIwJISAKEwTt4rLdkzgH7gFGmAjzEyyzmAg5Fjr-QEA139Ucmo1d9SYuaSvoEIooB5MatX2cKZCQmyqmq_Wk7Rw6jX-rgn3qO6t6rMIT2LFmhX_S15hx2ppXx11AMwCOnq0R3N4zOb-VCh4dvwJC22p5YDMS27t5qa21xZ0RzKc5ZC-_T4v0cXqZ3xF5hxacE3tV18yUl059ff7BQLiI3nuKA8JSg_zVOc9bmFulmrO9MOWzBk3O0g-BM2Guza");'></div>
<div class="flex items-center gap-2">
<span class="font-medium">Olivia Smith</span>
<div class="size-2.5 rounded-full bg-[#F5A623]" data-alt="At risk status indicator"></div>
</div>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">(555) 987-6543</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">130 lbs / 125 lbs</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">Dr. Reed</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">1 day ago</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<div class="flex items-center gap-2">
<button class="text-primary hover:underline">View</button>
<button class="text-primary hover:underline">Message</button>
<button class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><span class="material-symbols-outlined">more_vert</span></button>
</div>
</td>
</tr>
<tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Noah Brown" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCQNLWfd8V00kqcYfX5nTyRd92GGtqAqz6x-M02AwjIonTgK0Eh9M6jMrcwaUfFqilM2UI8EOxB4gOGrfzuaS8dbDQE9suhVpYEj7N_MBEr3i-ZSN-yzX8AdfR3hpOdnO70SjAu4dpsrTGt4cCQRkDH7pjcOgZ2lln7mAMgdk7ai476WszDe2Z5VL44iGGaG5c3wi7yt8HBa35Ai3iMpJUmdau-SCRfasQnQhgXVUy83P27gwIERA3E9_rBEdoDheESznzC2poQox_L");'></div>
<span class="font-medium">Noah Brown</span>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">(555) 234-5678</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">180 lbs / 170 lbs</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">Dr. Singh</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">5 days ago</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<div class="flex items-center gap-2">
<button class="text-primary hover:underline">View</button>
<button class="text-primary hover:underline">Message</button>
<button class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><span class="material-symbols-outlined">more_vert</span></button>
</div>
</td>
</tr>
<tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Emma Davis" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBnjMX4DmGvAS29EbxSzQYEZjxHy-eM9BOPRQ4gWnYGbvjvINY2ISuzCIi0n9IpgPJC0eze--mOIYEdei2MVwpu7MB2JAhUpgL0I4VDuBErBiPA8CmlIsXSAQQ86a2jQZeDf9nB8x6S34OaTifpDwpqo6OBDq4IslVPXXiJxB2YzcH382_MA_V_x067EC3hdQN7xJ9BqkhKZKJLIeEcZ939x1apYskf21NeDetpQYcLKsu04GVj6Aw5hCgx98EIzqJvVoFz4AvPzSeJ");'></div>
<span class="font-medium">Emma Davis</span>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">(555) 876-5432</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">145 lbs / 140 lbs</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">Dr. Reed</td>
<td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-300">1 week ago</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<div class="flex items-center gap-2">
<button class="text-primary hover:underline">View</button>
<button class="text-primary hover:underline">Message</button>
<button class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><span class="material-symbols-outlined">more_vert</span></button>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- Pagination -->
<div class="flex items-center justify-between mt-6 px-1">
<p class="text-sm text-gray-600 dark:text-gray-400">
                        Showing <span class="font-medium">1</span>-<span class="font-medium">10</span> of <span class="font-medium">86</span> clients
                    </p>
<div class="flex items-center gap-2">
<button class="flex items-center justify-center size-9 rounded-lg border border-gray-300 dark:border-gray-600 bg-background-light dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50" disabled="">
<span class="material-symbols-outlined text-lg">chevron_left</span>
</button>
<button class="flex items-center justify-center size-9 rounded-lg border border-gray-300 dark:border-gray-600 bg-background-light dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined text-lg">chevron_right</span>
</button>
</div>
</div>
</div>
</main>
</div>
</body></html>
</file>

<file path="Design/website/Design/client_profile_view/code.html">
<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Client Profile Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#17cf54",
              "background-light": "#f6f8f6",
              "background-dark": "#112116",
              "surface-light": "#ffffff",
              "surface-dark": "#1a2c20",
              "text-primary-light": "#0e1b12",
              "text-primary-dark": "#e8f3ec",
              "text-secondary-light": "#4e9767",
              "text-secondary-dark": "#a3d3b3",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {
              "DEFAULT": "0.25rem",
              "lg": "0.5rem",
              "xl": "0.75rem",
              "full": "9999px"
            },
          },
        },
      }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-primary-light dark:text-text-primary-dark">
<div class="relative flex min-h-screen w-full flex-col">
<div class="flex h-full grow flex-row">
<!-- SideNavBar -->
<aside class="flex w-64 flex-col justify-between border-r border-gray-200/50 dark:border-white/10 bg-surface-light dark:bg-surface-dark p-4">
<div class="flex flex-col gap-4">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Dr. Emily Carter" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBeuNG6PVKxJgMaU8p57o3Zf3xoBswZ9iiX-l7Y-1MJ4PoFjqP0647K7fs-mEW3NdVeDw48VyGfgL8d4knMqShcWyrkf1GBkHmeSj7ARnkJTmGtj3P61fJsgjL3QVEIz1_SO06yTWzKqPVRtYEjSY68ADIPe8JzQFJJXMJtvxIPzvJSaM1fRqkWYj9VH4A_GU5dT02o6FiQwuz3GC77mXhqyGSX6xtz0fcXaRMdLcnpkCfL9NvC_4XnyXb7s8IUApqSIqq_UUzDmgNO");'></div>
<div class="flex flex-col">
<h1 class="text-text-primary-light dark:text-text-primary-dark text-base font-medium leading-normal">Dr. Emily Carter</h1>
<p class="text-text-secondary-light dark:text-text-secondary-dark text-sm font-normal leading-normal">Dietician</p>
</div>
</div>
<nav class="flex flex-col gap-2">
<a class="flex items-center gap-3 rounded-lg px-3 py-2 text-text-primary-light dark:text-text-primary-dark hover:bg-primary/10" href="#">
<span class="material-symbols-outlined">dashboard</span>
<p class="text-sm font-medium leading-normal">Dashboard</p>
</a>
<a class="flex items-center gap-3 rounded-lg bg-primary/20 px-3 py-2 text-text-primary-light dark:text-text-primary-dark" href="#">
<span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">group</span>
<p class="text-sm font-medium leading-normal">Clients</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 text-text-primary-light dark:text-text-primary-dark hover:bg-primary/10" href="#">
<span class="material-symbols-outlined">chat_bubble</span>
<p class="text-sm font-medium leading-normal">Messages</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 text-text-primary-light dark:text-text-primary-dark hover:bg-primary/10" href="#">
<span class="material-symbols-outlined">menu_book</span>
<p class="text-sm font-medium leading-normal">Meal Plans</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 text-text-primary-light dark:text-text-primary-dark hover:bg-primary/10" href="#">
<span class="material-symbols-outlined">settings</span>
<p class="text-sm font-medium leading-normal">Settings</p>
</a>
</nav>
</div>
<div class="flex flex-col gap-1">
<a class="flex items-center gap-3 rounded-lg px-3 py-2 text-text-primary-light dark:text-text-primary-dark hover:bg-primary/10" href="#">
<span class="material-symbols-outlined">help</span>
<p class="text-sm font-medium leading-normal">Help Center</p>
</a>
</div>
</aside>
<!-- Main Content -->
<main class="flex-1 overflow-y-auto">
<div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
<!-- ToolBar & ProfileHeader -->
<header class="flex flex-col gap-6">
<div class="flex flex-wrap items-center justify-between gap-4">
<button class="flex items-center gap-2 p-2 text-text-secondary-light dark:text-text-secondary-dark hover:text-text-primary-light dark:hover:text-text-primary-dark">
<span class="material-symbols-outlined">arrow_back</span>
<span class="text-sm font-medium">Back to Clients</span>
</button>
<button class="flex items-center justify-center gap-2 rounded-lg bg-primary px-4 h-10 text-sm font-bold leading-normal text-white hover:opacity-90">
<span class="material-symbols-outlined" style="font-size: 20px; font-variation-settings: 'FILL' 1;">send</span>
<span>Send Message</span>
</button>
</div>
<div class="flex w-full flex-col gap-4 @container md:flex-row md:items-center md:justify-between">
<div class="flex items-center gap-4">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-24 w-24 md:h-32 md:w-32" data-alt="Profile picture of Jessica Williams" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCjxoEAsPbVDDUJ8ik9VOO2la8Ji7KmbvWzMTY9siKHHBAhFQ3_ETlPgiD74BvHpYTbafsVCIHi-H1jaSkc5y1iGkoQU-1ssp1qUBSO3JYD8Ryqvo1QHBuXING_xj8THqMEB3S3o-ZTjK4O2cfNk_renQ1EQtmCxejE4CeH2I8INEojOtdzSQUIECfdvuDVVcjY18ELEDBfGGCGe1ArAZZ7K_HqWdjjK_FM9p_OqTCif5GJvsoorI8LQXNxy2wEWqq0xwgw7OfHD3k5");'></div>
<div class="flex flex-col justify-center">
<p class="text-text-primary-light dark:text-text-primary-dark text-2xl md:text-[28px] font-bold leading-tight tracking-[-0.015em]">Jessica Williams</p>
<p class="text-text-secondary-light dark:text-text-secondary-dark text-base font-normal leading-normal">Age: 32, Gender: Female</p>
<p class="text-text-secondary-light dark:text-text-secondary-dark text-base font-normal leading-normal">Last login: 2 hours ago</p>
</div>
</div>
</div>
</header>
<!-- Key Metrics: Charts & ProgressBar -->
<section class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2">
<div class="flex flex-col gap-2 rounded-xl bg-surface-light dark:bg-surface-dark p-4 shadow-sm">
<p class="text-text-primary-light dark:text-text-primary-dark text-base font-medium leading-normal">Weight Trend</p>
<div class="flex items-baseline gap-2">
<p class="text-text-primary-light dark:text-text-primary-dark tracking-light text-3xl font-bold leading-tight truncate">155.2 lbs</p>
<div class="flex gap-1">
<p class="text-text-secondary-light dark:text-text-secondary-dark text-sm font-normal">Last 30 Days</p>
<p class="text-red-600 dark:text-red-400 text-sm font-medium">-1.8 lbs</p>
</div>
</div>
<div class="flex h-32 flex-1 flex-col justify-end">
<svg fill="none" preserveaspectratio="none" viewbox="0 0 472 100" width="100%" xmlns="http://www.w3.org/2000/svg">
<path d="M0 72.6667C18.1538 72.6667 18.1538 14 36.3077 14C54.4615 14 54.4615 27.3333 72.6154 27.3333C90.7692 27.3333 90.7692 62 108.923 62C127.077 62 127.077 22 145.231 22C163.385 22 163.385 67.3333 181.538 67.3333C199.692 67.3333 199.692 40.6667 217.846 40.6667C236 40.6667 236 30 254.154 30C272.308 30 272.308 80.6667 290.462 80.6667C308.615 80.6667 308.615 99.3333 326.769 99.3333C344.923 99.3333 344.923 0.666667 363.077 0.666667C381.231 0.666667 381.231 54 399.385 54C417.538 54 417.538 86 435.692 86C453.846 86 453.846 16.6667 472 16.6667" stroke="#17cf54" stroke-linecap="round" stroke-width="3"></path>
</svg>
</div>
</div>
<div class="flex flex-col gap-3 rounded-xl bg-surface-light dark:bg-surface-dark p-4 shadow-sm">
<div class="flex items-center justify-between gap-6">
<p class="text-text-primary-light dark:text-text-primary-dark text-base font-medium leading-normal">Adherence Score</p>
<p class="text-primary text-2xl font-bold">85%</p>
</div>
<div class="h-2 rounded-full bg-primary/20"><div class="h-2 rounded-full bg-primary" style="width: 85%;"></div></div>
<p class="text-text-secondary-light dark:text-text-secondary-dark text-sm">Jessica has logged 18 of 21 meals this week.</p>
<div class="mt-auto flex flex-col gap-2">
<h3 class="font-medium text-base text-text-primary-light dark:text-text-primary-dark">Weekly Goal</h3>
<p class="text-text-secondary-light dark:text-text-secondary-dark text-sm">Increase daily water intake to 8 glasses.</p>
</div>
</div>
</section>
<!-- Tab Navigation and Content -->
<section class="mt-8">
<div class="border-b border-gray-200/80 dark:border-white/10">
<nav aria-label="Tabs" class="-mb-px flex space-x-6">
<a class="whitespace-nowrap border-b-2 border-primary px-1 pb-3 text-sm font-semibold text-primary" href="#">Overview</a>
<a class="whitespace-nowrap border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-text-secondary-light dark:text-text-secondary-dark hover:border-gray-300 dark:hover:border-gray-500 hover:text-text-primary-light dark:hover:text-text-primary-dark" href="#">Diet Plan</a>
<a class="whitespace-nowrap border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-text-secondary-light dark:text-text-secondary-dark hover:border-gray-300 dark:hover:border-gray-500 hover:text-text-primary-light dark:hover:text-text-primary-dark" href="#">Meal Logs</a>
<a class="whitespace-nowrap border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-text-secondary-light dark:text-text-secondary-dark hover:border-gray-300 dark:hover:border-gray-500 hover:text-text-primary-light dark:hover:text-text-primary-dark" href="#">Progress</a>
</nav>
</div>
<!-- Tab Content Panel -->
<div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-3">
<div class="flex flex-col gap-4 rounded-xl bg-surface-light dark:bg-surface-dark p-4 shadow-sm">
<div class="flex items-center gap-3">
<div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
<span class="material-symbols-outlined">restaurant</span>
</div>
<h3 class="text-base font-semibold text-text-primary-light dark:text-text-primary-dark">Next Meal</h3>
</div>
<p class="text-text-secondary-light dark:text-text-secondary-dark">Lunch (12:30 PM)</p>
<p class="text-lg font-medium text-text-primary-light dark:text-text-primary-dark">Grilled Chicken Salad</p>
<p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">with mixed greens, cherry tomatoes, and a light vinaigrette.</p>
</div>
<div class="flex flex-col gap-4 rounded-xl bg-surface-light dark:bg-surface-dark p-4 shadow-sm">
<div class="flex items-center gap-3">
<div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
<span class="material-symbols-outlined">flag</span>
</div>
<h3 class="text-base font-semibold text-text-primary-light dark:text-text-primary-dark">Current Diet Plan</h3>
</div>
<p class="text-text-secondary-light dark:text-text-secondary-dark">Active since Oct 24, 2023</p>
<p class="text-lg font-medium text-text-primary-light dark:text-text-primary-dark">Week 3 - High Protein</p>
<p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Focused on muscle retention during caloric deficit.</p>
</div>
<div class="flex flex-col gap-4 rounded-xl bg-surface-light dark:bg-surface-dark p-4 shadow-sm">
<div class="flex items-center gap-3">
<div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
<span class="material-symbols-outlined">rate_review</span>
</div>
<h3 class="text-base font-semibold text-text-primary-light dark:text-text-primary-dark">Latest Feedback</h3>
</div>
<p class="text-text-secondary-light dark:text-text-secondary-dark">From Yesterday's Dinner Log</p>
<blockquote class="border-l-4 border-primary/30 pl-4">
<p class="text-sm italic text-text-primary-light dark:text-text-primary-dark">"Felt a bit hungry after this meal. Maybe I can add more vegetables next time?"</p>
</blockquote>
</div>
</div>
</section>
</div>
</main>
</div>
</div>
</body></html>
</file>

<file path="Design/website/Design/dashboard_home/code.html">
<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>HealthTrack Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#4A90E2",
              "accent": "#50E3C2",
              "background-light": "#F8F9FA",
              "background-dark": "#1a1a1a",
              "text-light": "#333333",
              "text-dark": "#E0E0E0",
              "border-light": "#E0E0E0",
              "border-dark": "#333333",
              "card-light": "#ffffff",
              "card-dark": "#2c2c2c",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">
<div class="flex h-screen">
<!-- SideNavBar -->
<aside class="flex w-64 flex-col border-r border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark">
<div class="flex h-full flex-col justify-between p-4">
<div class="flex flex-col gap-8">
<div class="flex items-center gap-3 px-3 py-2">
<div class="text-primary size-8">
<svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_6_535)">
<path clip-rule="evenodd" d="M47.2426 24L24 47.2426L0.757355 24L24 0.757355L47.2426 24ZM12.2426 21H35.7574L24 9.24264L12.2426 21Z" fill="currentColor" fill-rule="evenodd"></path>
</g>
<defs>
<clippath id="clip0_6_535"><rect fill="white" height="48" width="48"></rect></clippath>
</defs>
</svg>
</div>
<h1 class="text-text-light dark:text-text-dark text-xl font-bold">HealthTrack</h1>
</div>
<nav class="flex flex-col gap-2">
<a class="flex items-center gap-3 rounded-lg bg-primary/20 px-3 py-2 text-primary" href="#">
<span class="material-symbols-outlined">dashboard</span>
<p class="text-sm font-medium">Dashboard</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-800" href="#">
<span class="material-symbols-outlined">group</span>
<p class="text-sm font-medium">Clients</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-800" href="#">
<span class="material-symbols-outlined">description</span>
<p class="text-sm font-medium">Diet Plans</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-800" href="#">
<span class="material-symbols-outlined">restaurant_menu</span>
<p class="text-sm font-medium">Meals Library</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-800" href="#">
<span class="material-symbols-outlined">pie_chart</span>
<p class="text-sm font-medium">Progress &amp; Analytics</p>
</a>
<a class="flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-800" href="#">
<span class="material-symbols-outlined">settings</span>
<p class="text-sm font-medium">Settings</p>
</a>
</nav>
</div>
</div>
</aside>
<!-- Main Content -->
<div class="flex flex-1 flex-col overflow-y-auto">
<!-- TopNavBar -->
<header class="flex items-center justify-between border-b border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark px-6 py-3 sticky top-0 z-10">
<div class="flex-1">
<label class="relative flex min-w-40 max-w-sm items-center">
<span class="material-symbols-outlined absolute left-3 text-gray-500">search</span>
<input class="form-input h-10 w-full rounded-lg border-border-light bg-background-light dark:border-border-dark dark:bg-background-dark pl-10 pr-4 text-sm focus:border-primary focus:ring-primary" placeholder="Search clients, plans..." type="search"/>
</label>
</div>
<div class="flex items-center gap-4">
<button class="relative flex h-10 w-10 cursor-pointer items-center justify-center rounded-full bg-background-light hover:bg-gray-200 dark:bg-background-dark dark:hover:bg-gray-700">
<span class="material-symbols-outlined">notifications</span>
<span class="absolute top-1 right-1 flex h-2 w-2">
<span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-primary opacity-75"></span>
<span class="relative inline-flex h-2 w-2 rounded-full bg-primary"></span>
</span>
</button>
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="User avatar of Dr. Carter" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuC3H8R1akagJMY-o-httrLYn4iU7d8h-acf1hmjRiN0q2e_dRtFFcfulw6fiOInvX0R6PLkV_FA5mtde6uC-2BgZQN8204hXZNNlOnDatSLD0gPcfbI4vOWE09zKPNkJewZGnD2AhTiOaTaucRjsL0-Ka3czDucJDSHUTwD76mxR47RNXHwrmSKJeUfPJL_XwFUz1oNm_xpL7pAIvAgYjMlUqd6R7KHAt76ZRhzumCOeR9XEPDSsUT_QAyQw3tWBeWclOV7cr-0tpAl");'></div>
<div class="flex flex-col text-sm">
<span class="font-semibold">Dr. Olivia Carter</span>
<span class="text-gray-500 dark:text-gray-400">Dietician</span>
</div>
</div>
</div>
</header>
<!-- Main Panel Content -->
<main class="flex-1 p-6 lg:p-8">
<div class="flex flex-col gap-6">
<!-- Page Heading and Actions -->
<div class="flex flex-wrap items-center justify-between gap-4">
<p class="text-3xl font-bold tracking-tight">Welcome back, Dr. Carter!</p>
<div class="flex flex-wrap gap-3">
<button class="flex h-10 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-primary px-4 text-sm font-bold text-white transition-colors hover:bg-primary/90">
<span class="material-symbols-outlined" style="font-size: 20px;">add</span>
<span class="truncate">Add New Client</span>
</button>
<button class="flex h-10 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg border border-border-light dark:border-border-dark bg-card-light px-4 text-sm font-bold text-text-light hover:bg-gray-100 dark:bg-card-dark dark:text-text-dark dark:hover:bg-gray-700">
<span class="material-symbols-outlined" style="font-size: 20px;">add</span>
<span class="truncate">Create New Diet Plan</span>
</button>
</div>
</div>
<!-- Stats -->
<div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
<div class="flex flex-col gap-2 rounded-xl border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark p-6">
<p class="text-base font-medium text-gray-600 dark:text-gray-300">Total Active Clients</p>
<p class="text-3xl font-bold">42</p>
</div>
<div class="flex flex-col gap-2 rounded-xl border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark p-6">
<p class="text-base font-medium text-gray-600 dark:text-gray-300">Meals Awaiting Review</p>
<p class="text-3xl font-bold">15</p>
</div>
<div class="flex flex-col gap-2 rounded-xl border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark p-6">
<p class="text-base font-medium text-gray-600 dark:text-gray-300">Average Client Adherence</p>
<p class="text-3xl font-bold text-accent">82%</p>
</div>
<div class="flex flex-col gap-2 rounded-xl border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark p-6">
<p class="text-base font-medium text-gray-600 dark:text-gray-300">Upcoming Appointments</p>
<p class="text-3xl font-bold">3</p>
</div>
</div>
<!-- Chart/Graph Widget -->
<div class="rounded-xl border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark p-6">
<h3 class="mb-4 text-lg font-semibold">Weekly Adherence Overview</h3>
<div class="flex h-64 items-end justify-between gap-4">
<div class="flex h-full flex-col-reverse items-center gap-2">
<p class="text-xs text-gray-500">Mon</p>
<div class="w-8 rounded bg-primary/20" style="height: 70%;">
<div class="h-full w-full rounded bg-primary transition-all duration-300 hover:opacity-80" style="height: 100%;"></div>
</div>
</div>
<div class="flex h-full flex-col-reverse items-center gap-2">
<p class="text-xs text-gray-500">Tue</p>
<div class="w-8 rounded bg-primary/20" style="height: 85%;">
<div class="h-full w-full rounded bg-primary transition-all duration-300 hover:opacity-80" style="height: 100%;"></div>
</div>
</div>
<div class="flex h-full flex-col-reverse items-center gap-2">
<p class="text-xs text-gray-500">Wed</p>
<div class="w-8 rounded bg-primary/20" style="height: 60%;">
<div class="h-full w-full rounded bg-primary transition-all duration-300 hover:opacity-80" style="height: 100%;"></div>
</div>
</div>
<div class="flex h-full flex-col-reverse items-center gap-2">
<p class="text-xs text-gray-500">Thu</p>
<div class="w-8 rounded bg-accent/20" style="height: 95%;">
<div class="h-full w-full rounded bg-accent transition-all duration-300 hover:opacity-80" style="height: 100%;"></div>
</div>
</div>
<div class="flex h-full flex-col-reverse items-center gap-2">
<p class="text-xs text-gray-500">Fri</p>
<div class="w-8 rounded bg-primary/20" style="height: 75%;">
<div class="h-full w-full rounded bg-primary transition-all duration-300 hover:opacity-80" style="height: 100%;"></div>
</div>
</div>
<div class="flex h-full flex-col-reverse items-center gap-2">
<p class="text-xs text-gray-500">Sat</p>
<div class="w-8 rounded bg-primary/20" style="height: 80%;">
<div class="h-full w-full rounded bg-primary transition-all duration-300 hover:opacity-80" style="height: 100%;"></div>
</div>
</div>
<div class="flex h-full flex-col-reverse items-center gap-2">
<p class="text-xs text-gray-500">Sun</p>
<div class="w-8 rounded bg-primary/20" style="height: 55%;">
<div class="h-full w-full rounded bg-primary transition-all duration-300 hover:opacity-80" style="height: 100%;"></div>
</div>
</div>
</div>
</div>
</div>
</main>
</div>
</div>
</body></html>
</file>

<file path="Design/website/Design/diet_options_library/code.html">
<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Diet Options Library</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
<script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#17cf54",
              "background-light": "#f6f8f6",
              "background-dark": "#112116",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
<div class="relative flex min-h-screen w-full">
<!-- SideNavBar -->
<aside class="flex w-64 flex-col border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-background-dark p-4">
<div class="flex flex-col gap-4">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Dr. Emily Carter" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuClMAlm2rDfkBJlvgRRhspUKlMyAjhHEzn7GjuLDvjfESo4qyQOVVs3Imf-vVBRypCY-mHWt_Xme_XzCbZT2pLKxr2OOGLK641TEbN_gQOQc1lg8x8aJ_Mvsc1bk6zMVZN0hgehO7iFTM_TG7WLUDmmWitI69LH8qTVZVNAJECfbC1G5BmJfbXxqO4O3QiVUO91QeYkDhq8I-hUX5ns9u7sZNib71UlZPjU61Bau5ZdLidtuEzmLZ-zeBfqiBucJZnEnqW7I006nNMz");'></div>
<div class="flex flex-col">
<h1 class="text-[#0e1b12] dark:text-white text-base font-medium leading-normal">Dr. Emily Carter</h1>
<p class="text-[#4e9767] text-sm font-normal leading-normal">Dietician</p>
</div>
</div>
<div class="flex flex-col gap-2 mt-4">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 text-[#0e1b12] dark:text-white" href="#">
<span class="material-symbols-outlined">dashboard</span>
<p class="text-sm font-medium leading-normal">Dashboard</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 text-[#0e1b12] dark:text-white" href="#">
<span class="material-symbols-outlined">group</span>
<p class="text-sm font-medium leading-normal">Clients</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 text-[#0e1b12] dark:text-white" href="#">
<span class="material-symbols-outlined">restaurant_menu</span>
<p class="text-sm font-medium leading-normal">Meal Plans</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 text-[#0e1b12] dark:text-white" href="#">
<span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">menu_book</span>
<p class="text-sm font-medium leading-normal">Diet Library</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 text-[#0e1b12] dark:text-white" href="#">
<span class="material-symbols-outlined">settings</span>
<p class="text-sm font-medium leading-normal">Settings</p>
</a>
</div>
</div>
<div class="mt-auto">
<button class="flex w-full min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">New Client</span>
</button>
</div>
</aside>
<!-- Main Content -->
<main class="flex-1 p-8">
<div class="w-full max-w-7xl mx-auto">
<!-- PageHeading -->
<div class="flex flex-wrap justify-between items-center gap-4 mb-6">
<div class="flex flex-col gap-1">
<p class="text-[#0e1b12] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Diet Options Library</p>
<p class="text-[#4e9767] text-base font-normal leading-normal">Browse, search, and utilize pre-defined diet plans for your clients.</p>
</div>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Add New Diet</span>
</button>
</div>
<!-- Search and Filters -->
<div class="flex flex-col sm:flex-row gap-4 mb-4">
<!-- SearchBar -->
<div class="flex-grow">
<label class="flex flex-col min-w-40 h-12 w-full">
<div class="flex w-full flex-1 items-stretch rounded-lg h-full">
<div class="text-[#4e9767] flex border-none bg-white dark:bg-slate-800 items-center justify-center pl-4 rounded-l-lg border-r-0">
<span class="material-symbols-outlined">search</span>
</div>
<input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0e1b12] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-none bg-white dark:bg-slate-800 h-full placeholder:text-[#4e9767] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" placeholder="Search diets by name or keyword..." value=""/>
</div>
</label>
</div>
<!-- ToolBar -->
<div class="flex justify-between items-center gap-2">
<div class="flex gap-2 items-center bg-white dark:bg-slate-800 rounded-lg p-1">
<button class="p-2 text-[#0e1b12] dark:text-white rounded-md bg-primary/20">
<span class="material-symbols-outlined">grid_view</span>
</button>
<button class="p-2 text-[#0e1b12] dark:text-white rounded-md hover:bg-primary/20">
<span class="material-symbols-outlined">view_list</span>
</button>
<button class="p-2 text-[#0e1b12] dark:text-white rounded-md hover:bg-primary/20">
<span class="material-symbols-outlined">filter_list</span>
</button>
</div>
</div>
</div>
<!-- Chips -->
<div class="flex gap-3 mb-6 overflow-x-auto pb-2">
<div class="flex h-8 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-full bg-primary/20 px-4">
<p class="text-[#0e1b12] dark:text-white text-sm font-medium leading-normal">All</p>
</div>
<div class="flex h-8 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-full bg-white dark:bg-slate-800 px-4 hover:bg-primary/20">
<p class="text-[#0e1b12] dark:text-white text-sm font-medium leading-normal">Goal-based</p>
</div>
<div class="flex h-8 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-full bg-white dark:bg-slate-800 px-4 hover:bg-primary/20">
<p class="text-[#0e1b12] dark:text-white text-sm font-medium leading-normal">Condition-specific</p>
</div>
<div class="flex h-8 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-full bg-white dark:bg-slate-800 px-4 hover:bg-primary/20">
<p class="text-[#0e1b12] dark:text-white text-sm font-medium leading-normal">Lifestyle</p>
</div>
<div class="flex h-8 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-full bg-white dark:bg-slate-800 px-4 hover:bg-primary/20">
<p class="text-[#0e1b12] dark:text-white text-sm font-medium leading-normal">Popular</p>
</div>
</div>
<!-- Diet Cards Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
<!-- Card 1: Mediterranean -->
<div class="flex flex-col bg-white dark:bg-slate-800 rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-shadow duration-300">
<img class="h-40 w-full object-cover" data-alt="A vibrant salad with fresh vegetables, olives, and feta cheese, representing the Mediterranean diet." src="https://lh3.googleusercontent.com/aida-public/AB6AXuBvwMLtaqynlIDsBSd0YKS54HvGJkwt_MaeCc0CE1A2fU_Miywe2ls_fJcYBv6rWQ53tPvgGJNBM8ojS42XUlTpS-Uplv-QfweHsQgXHoLEIymqviOagwfgxTEARacdYdZlZCGyyY93yGX0D3-4_rxQh7jmzIU3CEDV8wrsjPO-bbTN9rV-Dd2B4iUOuo6dIygQvU9zP7K8iGA1wataaJ85B4BjV6MQ1URh6txrugGkvqXVrFcQOvBVNeYLERwQ9WtDC1i3ZybQZXa_"/>
<div class="p-5 flex flex-col flex-grow">
<h3 class="text-xl font-bold text-[#0e1b12] dark:text-white mb-2">Mediterranean Diet</h3>
<p class="text-sm text-slate-600 dark:text-slate-300 mb-4 flex-grow">A heart-healthy eating plan inspired by the traditional foods of Greece, Italy, and other countries that border the Mediterranean Sea.</p>
<div class="flex flex-wrap gap-2 mb-4">
<span class="text-xs font-semibold text-green-800 bg-green-100 rounded-full px-3 py-1">Heart-Healthy</span>
<span class="text-xs font-semibold text-blue-800 bg-blue-100 rounded-full px-3 py-1">Plant-Based</span>
<span class="text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full px-3 py-1">Rich in Omega-3s</span>
</div>
<div class="mt-auto flex flex-col sm:flex-row gap-2">
<button class="flex-1 text-center text-sm font-bold py-2 px-4 rounded-lg bg-primary/20 hover:bg-primary/30 text-[#0e1b12] dark:text-white">View Details</button>
<button class="flex-1 text-center text-sm font-bold py-2 px-4 rounded-lg bg-primary text-white hover:bg-primary/90">Apply Template</button>
</div>
</div>
</div>
<!-- Card 2: Keto -->
<div class="flex flex-col bg-white dark:bg-slate-800 rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-shadow duration-300">
<img class="h-40 w-full object-cover" data-alt="Grilled salmon with asparagus and lemon, a typical meal for a Ketogenic diet." src="https://lh3.googleusercontent.com/aida-public/AB6AXuDpSqmE6B0PS8KI4mdUhA9GJUNKwU7MvVAtfCJxive-aSjbztVTFCjXo9zuE0_Qw3slltVFBBlo3vCuo6xi24FnOccyw1u4L4eto2IS2tEHD-kdNwlGWnvJT9c0pu4N0a3kXZs95gXsNyAZO64ebJLIRrNtr5jsqpjCQbnaK2lc0hvhGJbjVwgrdN-A-LNJBX-nk_jvlaxyMUwbR40R9xHQWaQ69YUAkmNzO9RvLGxk9IuThKIBnXyFjezFi1kHM8XApqg6hHoDRja4"/>
<div class="p-5 flex flex-col flex-grow">
<h3 class="text-xl font-bold text-[#0e1b12] dark:text-white mb-2">Ketogenic Diet</h3>
<p class="text-sm text-slate-600 dark:text-slate-300 mb-4 flex-grow">A very low-carb, high-fat diet that involves drastically reducing carbohydrate intake and replacing it with fat to put your body into ketosis.</p>
<div class="flex flex-wrap gap-2 mb-4">
<span class="text-xs font-semibold text-red-800 bg-red-100 rounded-full px-3 py-1">Low-Carb</span>
<span class="text-xs font-semibold text-orange-800 bg-orange-100 rounded-full px-3 py-1">High-Fat</span>
<span class="text-xs font-semibold text-purple-800 bg-purple-100 rounded-full px-3 py-1">Weight Loss</span>
</div>
<div class="mt-auto flex flex-col sm:flex-row gap-2">
<button class="flex-1 text-center text-sm font-bold py-2 px-4 rounded-lg bg-primary/20 hover:bg-primary/30 text-[#0e1b12] dark:text-white">View Details</button>
<button class="flex-1 text-center text-sm font-bold py-2 px-4 rounded-lg bg-primary text-white hover:bg-primary/90">Apply Template</button>
</div>
</div>
</div>
<!-- Card 3: Vegan -->
<div class="flex flex-col bg-white dark:bg-slate-800 rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-shadow duration-300">
<img class="h-40 w-full object-cover" data-alt="A colorful bowl of various vegetables, grains, and legumes, representing a Vegan diet." src="https://lh3.googleusercontent.com/aida-public/AB6AXuB6dzbqTSRAVzukFPsAAV5P0fXKMH3u8FO8ZY_uou_lzMHOVR0FFIc3M11TaJ33h7434IUDGdMwlhAH3T8aHLrKdTdPmXplnIy46qUSSQCGokLhSUUFtaUNV6rxDsjhB1emXUvsuWtllS0zOl45k9_gKnZmTK2OanGo965QEBVYXGPUyqxiy6P69BQiPXxaVyFNlX3etHvGISmuPzpoKbNKeJrziBmOaXa9sBndCvz6IBwAXjES7fbcYaBJ7NqGKR_O_Pv7AF4lLGec"/>
<div class="p-5 flex flex-col flex-grow">
<h3 class="text-xl font-bold text-[#0e1b12] dark:text-white mb-2">Vegan Diet</h3>
<p class="text-sm text-slate-600 dark:text-slate-300 mb-4 flex-grow">Excludes all animal products, including meat, dairy, and eggs. It is based on plants (such as vegetables, grains, nuts and fruits).</p>
<div class="flex flex-wrap gap-2 mb-4">
<span class="text-xs font-semibold text-green-800 bg-green-100 rounded-full px-3 py-1">Plant-Based</span>
<span class="text-xs font-semibold text-indigo-800 bg-indigo-100 rounded-full px-3 py-1">Dairy-Free</span>
<span class="text-xs font-semibold text-pink-800 bg-pink-100 rounded-full px-3 py-1">Ethical</span>
</div>
<div class="mt-auto flex flex-col sm:flex-row gap-2">
<button class="flex-1 text-center text-sm font-bold py-2 px-4 rounded-lg bg-primary/20 hover:bg-primary/30 text-[#0e1b12] dark:text-white">View Details</button>
<button class="flex-1 text-center text-sm font-bold py-2 px-4 rounded-lg bg-primary text-white hover:bg-primary/90">Apply Template</button>
</div>
</div>
</div>
</div>
</div>
</main>
</div>
</body></html>
</file>

<file path="Design/website/Design/diet_plan_builder_flow/code.html">
<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Diet Plan Builder</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#17cf54",
              "background-light": "#f6f8f6",
              "background-dark": "#112116",
              "success": "#7ED321",
              "warning": "#F5A623",
              "error": "#D0021B",
              "text-light": "#0e1b12",
              "text-dark": "#e1e3e2",
              "surface-light": "#f8fcf9",
              "surface-dark": "#1a2c20",
              "border-light": "#d0e7d7",
              "border-dark": "#2a3f30",
              "muted-light": "#4e9767",
              "muted-dark": "#8a9f90",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
<div class="flex min-h-screen">
<!-- SideNavBar -->
<aside class="w-64 flex-shrink-0 bg-surface-light dark:bg-surface-dark border-r border-border-light dark:border-border-dark hidden lg:flex flex-col">
<div class="flex h-full min-h-[700px] flex-col justify-between p-4">
<div class="flex flex-col gap-4">
<div class="flex items-center gap-3 p-2">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Dr. Evelyn Reed" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBsAuKZx2sD-s02Grb1ZKJgvOIP1JaGBO2hXtstwkcx7_8SwtA1j_g_9i96dLJFqR8Z1956tMD2dwkAhzaJ2gD_NHEyuP4U2IWpu29ivjf_R2es5cgaPPtmT9yKT_v7ZKEl6MyTbHWg-XOmH2uvgRES5X49T0NbLc9ToRtqs4SXrtrjtgVt-f4x-TFQJdfwpKUwanL2Jg4iUdnitC6jc1-jcx6RM3wexpUmBIbjYM0x8vka1nyW0K4Uh8SGw6UOavnMRakN_COX9w9Q");'></div>
<div class="flex flex-col">
<h1 class="text-text-light dark:text-text-dark text-base font-medium leading-normal">Dr. Evelyn Reed</h1>
<p class="text-muted-light dark:text-muted-dark text-sm font-normal leading-normal">Dietician</p>
</div>
</div>
<nav class="flex flex-col gap-2">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 transition-colors" href="#">
<span class="material-symbols-outlined text-text-light dark:text-text-dark">dashboard</span>
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">Dashboard</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 transition-colors" href="#">
<span class="material-symbols-outlined text-text-light dark:text-text-dark">group</span>
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">Clients</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20" href="#">
<span class="material-symbols-outlined text-text-light dark:text-text-dark !font-bold">description</span>
<p class="text-text-light dark:text-text-dark text-sm font-bold leading-normal">Diet Plans</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 transition-colors" href="#">
<span class="material-symbols-outlined text-text-light dark:text-text-dark">book</span>
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">Templates</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 transition-colors" href="#">
<span class="material-symbols-outlined text-text-light dark:text-text-dark">pie_chart</span>
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">Analytics</p>
</a>
</nav>
</div>
<div class="flex flex-col gap-4">
<button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-text-light text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
<span class="truncate">New Plan</span>
</button>
<div class="flex flex-col gap-1">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 transition-colors" href="#">
<span class="material-symbols-outlined text-text-light dark:text-text-dark">settings</span>
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">Settings</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/20 transition-colors" href="#">
<span class="material-symbols-outlined text-text-light dark:text-text-dark">help</span>
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">Help</p>
</a>
</div>
</div>
</div>
</aside>
<!-- Main Content -->
<main class="flex-1 p-4 sm:p-6 lg:p-8">
<div class="max-w-7xl mx-auto">
<!-- PageHeading -->
<div class="flex flex-wrap justify-between gap-4 mb-6">
<div class="flex min-w-72 flex-col gap-2">
<p class="text-text-light dark:text-text-dark text-3xl md:text-4xl font-black leading-tight tracking-[-0.033em]">Create New Diet Plan</p>
<p class="text-muted-light dark:text-muted-dark text-base font-normal leading-normal">Follow the steps to build a personalized weekly diet plan for your client.</p>
</div>
</div>
<!-- ProgressBar -->
<div class="flex flex-col gap-2 mb-8">
<div class="flex gap-6 justify-between"><p class="text-text-light dark:text-text-dark text-base font-medium leading-normal">Step 1 of 3: Plan Setup</p></div>
<div class="rounded-full bg-border-light dark:bg-border-dark h-2"><div class="h-2 rounded-full bg-primary" style="width: 33%;"></div></div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
<div class="lg:col-span-2">
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-border-light dark:border-border-dark">
<!-- SectionHeader -->
<h2 class="text-text-light dark:text-text-dark text-xl font-bold leading-tight tracking-[-0.015em] pb-4 border-b border-border-light dark:border-border-dark">Plan Details</h2>
<!-- Form: Step 1 -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6">
<div class="md:col-span-2">
<label class="flex flex-col">
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal pb-2">Select Client</p>
<div class="relative">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-muted-light dark:text-muted-dark">search</span>
<select class="form-select w-full rounded-lg text-text-light dark:text-text-dark bg-background-light dark:bg-background-dark border-border-light dark:border-border-dark focus:ring-primary focus:border-primary h-12 pl-10 placeholder:text-muted-light dark:placeholder:text-muted-dark text-base font-normal leading-normal">
<option selected="">Search for a client by name...</option>
<option>James Rodriguez</option>
<option>Maria Garcia</option>
</select>
</div>
</label>
</div>
<div class="md:col-span-2">
<label class="flex flex-col">
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal pb-2">Plan Name</p>
<input class="form-input w-full rounded-lg text-text-light dark:text-text-dark bg-background-light dark:bg-background-dark border-border-light dark:border-border-dark focus:ring-primary focus:border-primary h-12 placeholder:text-muted-light dark:placeholder:text-muted-dark text-base font-normal leading-normal" placeholder="e.g., High-Protein Weight Loss" type="text"/>
</label>
</div>
<div>
<label class="flex flex-col">
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal pb-2">Start Date</p>
<input class="form-input w-full rounded-lg text-text-light dark:text-text-dark bg-background-light dark:bg-background-dark border-border-light dark:border-border-dark focus:ring-primary focus:border-primary h-12 placeholder:text-muted-light dark:placeholder:text-muted-dark text-base font-normal leading-normal" type="date"/>
</label>
</div>
<div>
<label class="flex flex-col">
<p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal pb-2">End Date</p>
<input class="form-input w-full rounded-lg text-text-light dark:text-text-dark bg-background-light dark:bg-background-dark border-border-light dark:border-border-dark focus:ring-primary focus:border-primary h-12 placeholder:text-muted-light dark:placeholder:text-muted-dark text-base font-normal leading-normal" type="date"/>
</label>
</div>
</div>
<div class="flex justify-end mt-8">
<button class="flex items-center justify-center gap-2 h-11 px-6 bg-primary text-text-light font-bold rounded-lg hover:opacity-90 transition-opacity">
<span>Next Step</span>
<span class="material-symbols-outlined">arrow_forward</span>
</button>
</div>
</div>
</div>
<!-- Summary Sidebar -->
<div class="lg:col-span-1 row-start-1 lg:row-start-auto">
<div class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-border-light dark:border-border-dark sticky top-8">
<h3 class="text-text-light dark:text-text-dark text-xl font-bold leading-tight tracking-[-0.015em] pb-4 border-b border-border-light dark:border-border-dark">Plan Summary</h3>
<div class="flex flex-col gap-5 pt-6">
<div class="text-center py-8 text-muted-light dark:text-muted-dark">
<p>Summary will appear once meals are added in the next step.</p>
</div>
<!-- Example of populated summary, hidden for now -->
<div class="hidden flex-col gap-5">
<div>
<div class="flex justify-between items-baseline mb-1">
<p class="text-text-light dark:text-text-dark font-medium">Avg. Daily Calories</p>
<p class="text-muted-light dark:text-muted-dark text-sm"><span class="text-success font-bold">1850</span> / 2000 kcal</p>
</div>
<div class="h-2 rounded-full bg-border-light dark:bg-border-dark"><div class="h-2 rounded-full bg-success" style="width: 92.5%;"></div></div>
</div>
<div>
<div class="flex justify-between items-baseline mb-1">
<p class="text-text-light dark:text-text-dark font-medium">Protein</p>
<p class="text-muted-light dark:text-muted-dark text-sm"><span class="text-warning font-bold">140g</span> / 150g</p>
</div>
<div class="h-2 rounded-full bg-border-light dark:bg-border-dark"><div class="h-2 rounded-full bg-warning" style="width: 93%;"></div></div>
</div>
<div>
<div class="flex justify-between items-baseline mb-1">
<p class="text-text-light dark:text-text-dark font-medium">Carbohydrates</p>
<p class="text-muted-light dark:text-muted-dark text-sm"><span class="text-success font-bold">205g</span> / 220g</p>
</div>
<div class="h-2 rounded-full bg-border-light dark:bg-border-dark"><div class="h-2 rounded-full bg-success" style="width: 93%;"></div></div>
</div>
<div>
<div class="flex justify-between items-baseline mb-1">
<p class="text-text-light dark:text-text-dark font-medium">Fat</p>
<p class="text-muted-light dark:text-muted-dark text-sm"><span class="text-error font-bold">75g</span> / 60g</p>
</div>
<div class="h-2 rounded-full bg-border-light dark:bg-border-dark"><div class="h-2 rounded-full bg-error" style="width: 100%;"></div></div>
</div>
</div>
</div>
<div class="flex flex-col gap-3 mt-8 pt-6 border-t border-border-light dark:border-border-dark">
<button class="w-full h-11 px-6 bg-primary text-text-light font-bold rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" disabled="">
                                    Publish Plan
                                </button>
<button class="w-full h-11 px-6 bg-primary/20 text-text-light dark:text-text-dark font-bold rounded-lg hover:bg-primary/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled="">
                                    Save as Template
                                </button>
</div>
</div>
</div>
</div>
</div>
</main>
</div>
</body></html>
</file>

<file path="Design/website/Design/diet_plan_creation_page_1/code.html">
<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Diet Plan Creation - Sarah Singh</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #e0e0e0;
            border-radius: 3px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
    </style>
<script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#17cf54",
              "background-light": "#f6f8f6",
              "background-dark": "#112116",
              "success": "#7ED321",
              "warning": "#F5A623",
              "error": "#D0021B",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-200">
<div class="flex flex-col h-screen">
<header class="flex items-center justify-between whitespace-nowrap border-b border-gray-200 dark:border-gray-700 px-6 py-3 bg-white dark:bg-gray-800 flex-shrink-0">
<div class="flex items-center gap-9">
<a class="flex items-center gap-2 text-gray-700 dark:text-gray-300 text-sm font-medium leading-normal" href="#">
<span class="material-symbols-outlined text-lg">arrow_back</span>
                    Back to Client
                </a>
<span class="text-gray-900 dark:text-white text-sm font-medium leading-normal">Client: Sarah Singh (28F)</span>
</div>
<div class="flex gap-2">
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-3">
<span class="material-symbols-outlined text-xl">visibility</span>
<span class="hidden sm:inline">Preview</span>
</button>
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-3">
<span class="material-symbols-outlined text-xl">download</span>
<span class="hidden sm:inline">Export</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Save as Draft</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Publish</span>
</button>
</div>
</header>
<main class="flex-grow grid grid-cols-12 gap-4 p-4 overflow-auto">
<aside class="col-span-3 flex flex-col gap-4 overflow-y-auto pr-2">
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" data-alt="Photo of Sarah Singh" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuA_mfGBlTQqbqWv8MiukpmpcdMKyoot_7VGTR9C8fop9lNumZzgPYbCu-QiZjXw6-RWx5hru5ihyNxKq2ttqVv2FZmOCeNblDNZb4lNdfRIVPfXXtrQEUb2FSfZq3m461r8eugVlFRScfL8MoqNwzgVFKNd-8EMeg5HvSQknPL05tPwV2bbWMekciSamP4BbVZ9eyfdQKkK3Xa2xiLM3Nwlbcu8JI3uVvb6e5wAOJ68-QfGk7bUE-evRyxiK2CMLt2-sQ6lA1rrw5HT");'></div>
<div class="flex flex-col">
<h1 class="text-gray-900 dark:text-white text-base font-medium leading-normal">Sarah Singh</h1>
<p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">28F, 165cm, 70kg</p>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<p class="text-gray-900 dark:text-white text-base font-medium leading-normal">Weight Trend</p>
<p class="text-gray-900 dark:text-white tracking-light text-[32px] font-bold leading-tight truncate">70kg <span class="text-gray-400 text-xl font-medium">/ Goal 65kg</span></p>
<div class="flex gap-1 items-center">
<p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">Last 30 Days</p>
<p class="text-error text-sm font-medium leading-normal flex items-center gap-1"><span class="material-symbols-outlined text-base">trending_down</span> -2kg</p>
</div>
<div class="flex min-h-[100px] flex-1 flex-col pt-4">
<svg fill="none" height="100" preserveAspectRatio="none" viewBox="-3 0 478 150" width="100%" xmlns="http://www.w3.org/2000/svg">
<path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25V149H326.769H0V109Z" fill="url(#paint0_linear_1131_5935_light)"></path>
<path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25" stroke="#4e9767" stroke-linecap="round" stroke-width="3"></path>
<defs>
<linearGradient gradientUnits="userSpaceOnUse" id="paint0_linear_1131_5935_light" x1="236" x2="236" y1="1" y2="149">
<stop stop-color="#e7f3eb"></stop>
<stop offset="1" stop-color="#e7f3eb" stop-opacity="0"></stop>
</linearGradient>
</defs>
</svg>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-3">Previous Plans</h3>
<div class="flex flex-col gap-1">
<div class="flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 p-2 rounded-lg cursor-pointer">
<div class="text-gray-800 dark:text-gray-200 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700 shrink-0 size-10">
<span class="material-symbols-outlined text-xl">description</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-gray-800 dark:text-gray-100 text-sm font-medium leading-normal line-clamp-1">High Protein Plan</p>
<p class="text-gray-500 dark:text-gray-400 text-xs font-normal leading-normal line-clamp-2">Created by Dr. Evans</p>
</div>
<p class="text-gray-400 dark:text-gray-500 text-xs font-normal leading-normal ml-auto">Nov 15, 2023</p>
</div>
<div class="flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 p-2 rounded-lg cursor-pointer">
<div class="text-gray-800 dark:text-gray-200 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700 shrink-0 size-10">
<span class="material-symbols-outlined text-xl">description</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-gray-800 dark:text-gray-100 text-sm font-medium leading-normal line-clamp-1">Keto Diet Start</p>
<p class="text-gray-500 dark:text-gray-400 text-xs font-normal leading-normal line-clamp-2">Created by You</p>
</div>
<p class="text-gray-400 dark:text-gray-500 text-xs font-normal leading-normal ml-auto">Oct 21, 2023</p>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-3">Medical Summary</h3>
<div class="flex flex-col gap-2">
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Diagnoses</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Hypertension, Pre-diabetic</p>
</details>
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group" open="">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Allergies</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Dairy, Peanuts, Shellfish</p>
</details>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-2">Notes &amp; Alerts</h3>
<textarea class="w-full h-24 p-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add a note for this client...">Client reports feeling bloated after high-carb meals. Monitor closely.</textarea>
</div>
</aside>
<section class="col-span-6 flex flex-col gap-4 overflow-y-auto">
<div class="flex-shrink-0 bg-white dark:bg-gray-800 p-2 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center text-center">
<button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400">chevron_left</span>
</button>
<div class="flex gap-1">
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 1 (Mon)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-white bg-primary">Dec 2 (Tue)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 3 (Wed)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 4 (Thu)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 5 (Fri)</button>
</div>
<button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400">chevron_right</span>
</button>
</div>
</div>
<div class="space-y-4">
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<div class="flex items-center gap-2">
<h3 class="text-lg font-semibold text-gray-900 dark:text-white">Breakfast</h3>
<input class="text-sm p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="time" value="08:00"/>
</div>
<p class="text-xs font-medium text-gray-500 dark:text-gray-400">350 Kcal | P:20g, C:45g, F:10g</p>
</div>
<div class="space-y-2 mb-3">
<div class="flex items-center gap-2 p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Oatmeal</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="1 cup"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
<div class="flex items-center gap-2 p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Blueberries</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="1/2 cup"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
</div>
<div class="flex gap-2">
<div class="relative flex-grow">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add food item..." type="text"/>
</div>
<button class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
<span class="material-symbols-outlined text-lg">menu_book</span>
<span>Templates</span>
</button>
</div>
<textarea class="mt-3 w-full p-2 text-xs border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add a note for the client..."></textarea>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<div class="flex items-center gap-2">
<h3 class="text-lg font-semibold text-gray-900 dark:text-white">Lunch</h3>
<input class="text-sm p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="time" value="13:00"/>
</div>
<p class="text-xs font-medium text-gray-500 dark:text-gray-400">650 Kcal | P:40g, C:60g, F:28g</p>
</div>
<div class="space-y-2 mb-3">
<div class="flex items-center gap-2 p-2 rounded-md bg-red-50 dark:bg-red-900/20 border border-error">
<span class="text-error mr-2"><span class="material-symbols-outlined text-lg">warning</span></span>
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Paneer Tikka</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="150g"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
<div class="flex items-center gap-2 p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Brown Rice</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="1 cup"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
</div>
<div class="flex gap-2">
<div class="relative flex-grow">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add food item..." type="text"/>
</div>
<button class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
<span class="material-symbols-outlined text-lg">menu_book</span>
<span>Templates</span>
</button>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<div class="flex items-center gap-2">
<h3 class="text-lg font-semibold text-gray-900 dark:text-white">Dinner</h3>
<input class="text-sm p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="time" value="19:30"/>
</div>
<p class="text-xs font-medium text-gray-500 dark:text-gray-400">0 Kcal | P:0g, C:0g, F:0g</p>
</div>
<div class="flex gap-2">
<div class="relative flex-grow">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add food item..." type="text"/>
</div>
<button class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
<span class="material-symbols-outlined text-lg">menu_book</span>
<span>Templates</span>
</button>
</div>
</div>
<button class="w-full flex items-center justify-center gap-2 py-3 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 hover:border-primary dark:hover:border-primary hover:text-primary dark:hover:text-primary transition-colors">
<span class="material-symbols-outlined">add_circle</span>
<span class="text-sm font-medium">Add meal +</span>
</button>
</div>
</section>
<aside class="col-span-3 flex flex-col gap-4 overflow-y-auto pl-2">
<div class="bg-error/10 dark:bg-error/20 border border-error p-4 rounded-lg">
<div class="flex items-start gap-3">
<span class="material-symbols-outlined text-error text-xl mt-0.5">error</span>
<div>
<h4 class="font-bold text-error">Allergy Warning</h4>
<p class="text-sm text-error/80 dark:text-error/90">You added Paneer (dairy). This client has a <span class="font-semibold">Dairy</span> allergy.</p>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal">Plan At-a-Glance</h3>
<span class="text-xs text-gray-500">Target: 1800 Kcal</span>
</div>
<div class="space-y-4">
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Today's Calories</span>
<span class="font-medium text-gray-600 dark:text-gray-400">1000 / 1800 kcal</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 55%"></div>
</div>
</div>
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Protein</span>
<span class="font-medium text-gray-600 dark:text-gray-400">60 / 90 g</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 66%"></div>
</div>
</div>
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Carbohydrates</span>
<span class="font-medium text-gray-600 dark:text-gray-400">105 / 200 g</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 52%"></div>
</div>
</div>
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Fat</span>
<span class="font-medium text-gray-600 dark:text-gray-400">38 / 60 g</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 63%"></div>
</div>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-3">Medical History</h3>
<div class="flex flex-col gap-2">
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Synopsis</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Client presents with hypertension and is classified as pre-diabetic. Key focus is on weight management and reducing sodium intake. Multiple food allergies require careful planning...</p>
</details>
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Recent Labs</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Fasting Glucose: 115 mg/dL (High)<br/>A1c: 5.9% (Elevated)</p>
</details>
</div>
</div>
</aside>
</main>
</div>
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl flex flex-col h-[90vh] overflow-hidden">
<header class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
<h2 class="text-lg font-semibold text-gray-900 dark:text-white">Add to Plan</h2>
<button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400">close</span>
</button>
</header>
<div class="p-4 flex-shrink-0">
<div class="flex gap-4">
<div class="relative flex-grow">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Search food, meals, or templates..." type="text"/>
</div>
<select class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-primary focus:border-primary dark:text-gray-300">
<option>Meal Type</option>
<option>Breakfast</option>
<option>Lunch</option>
<option>Dinner</option>
<option>Snack</option>
</select>
<select class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-primary focus:border-primary dark:text-gray-300">
<option>Cuisine</option>
<option>Italian</option>
<option>Indian</option>
<option>Mexican</option>
<option>Chinese</option>
</select>
</div>
<div class="flex gap-2 mt-4 text-sm">
<button class="px-3 py-1.5 rounded-full bg-primary/10 text-primary dark:bg-primary/20 font-medium">All</button>
<button class="px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">Food Items</button>
<button class="px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">My Meals</button>
<button class="px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">Templates</button>
</div>
</div>
<main class="flex-grow overflow-y-auto px-4">
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
<div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex flex-col hover:border-primary dark:hover:border-primary cursor-pointer transition-colors">
<div class="flex justify-between items-start mb-2">
<div>
<p class="font-semibold text-gray-900 dark:text-white">High-Protein Breakfast</p>
<span class="text-xs text-primary bg-primary/10 dark:bg-primary/20 px-2 py-0.5 rounded-full">Template</span>
</div>
<button class="p-1 text-gray-500 hover:text-primary"><span class="material-symbols-outlined">add_circle</span></button>
</div>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-3 flex-grow">Scrambled eggs, turkey sausage, and whole wheat toast.</p>
<div class="text-xs text-gray-500 dark:text-gray-400 flex justify-between items-center">
<span>450 Kcal</span>
<span>P: 35g</span>
<span>C: 30g</span>
<span>F: 20g</span>
</div>
</div>
<div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex flex-col hover:border-primary dark:hover:border-primary cursor-pointer transition-colors">
<div class="flex justify-between items-start mb-2">
<div>
<p class="font-semibold text-gray-900 dark:text-white">Chicken Salad Lunch</p>
<span class="text-xs text-blue-600 bg-blue-100 dark:bg-blue-900/40 dark:text-blue-300 px-2 py-0.5 rounded-full">My Meal</span>
</div>
<button class="p-1 text-gray-500 hover:text-primary"><span class="material-symbols-outlined">add_circle</span></button>
</div>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-3 flex-grow">Grilled chicken breast, mixed greens, cherry tomatoes, cucumbers, with a light vinaigrette.</p>
<div class="text-xs text-gray-500 dark:text-gray-400 flex justify-between items-center">
<span>350 Kcal</span>
<span>P: 40g</span>
<span>C: 10g</span>
<span>F: 18g</span>
</div>
</div>
<div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex flex-col hover:border-primary dark:hover:border-primary cursor-pointer transition-colors">
<div class="flex justify-between items-start mb-2">
<div>
<p class="font-semibold text-gray-900 dark:text-white">Apple</p>
<span class="text-xs text-purple-600 bg-purple-100 dark:bg-purple-900/40 dark:text-purple-300 px-2 py-0.5 rounded-full">Food Item</span>
</div>
<button class="p-1 text-gray-500 hover:text-primary"><span class="material-symbols-outlined">add_circle</span></button>
</div>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-3 flex-grow">1 medium (approx. 182g)</p>
<div class="text-xs text-gray-500 dark:text-gray-400 flex justify-between items-center">
<span>95 Kcal</span>
<span>P: 0.5g</span>
<span>C: 25g</span>
<span>F: 0.3g</span>
</div>
</div>
<div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex flex-col hover:border-primary dark:hover:border-primary cursor-pointer transition-colors">
<div class="flex justify-between items-start mb-2">
<div>
<p class="font-semibold text-gray-900 dark:text-white">Almonds</p>
<span class="text-xs text-purple-600 bg-purple-100 dark:bg-purple-900/40 dark:text-purple-300 px-2 py-0.5 rounded-full">Food Item</span>
</div>
<button class="p-1 text-gray-500 hover:text-primary"><span class="material-symbols-outlined">add_circle</span></button>
</div>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-3 flex-grow">1 ounce (approx. 23 nuts)</p>
<div class="text-xs text-gray-500 dark:text-gray-400 flex justify-between items-center">
<span>164 Kcal</span>
<span>P: 6g</span>
<span>C: 6g</span>
<span>F: 14g</span>
</div>
</div>
<div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex flex-col hover:border-primary dark:hover:border-primary cursor-pointer transition-colors">
<div class="flex justify-between items-start mb-2">
<div>
<p class="font-semibold text-gray-900 dark:text-white">Keto Dinner</p>
<span class="text-xs text-primary bg-primary/10 dark:bg-primary/20 px-2 py-0.5 rounded-full">Template</span>
</div>
<button class="p-1 text-gray-500 hover:text-primary"><span class="material-symbols-outlined">add_circle</span></button>
</div>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-3 flex-grow">Salmon with asparagus and lemon-butter sauce.</p>
<div class="text-xs text-gray-500 dark:text-gray-400 flex justify-between items-center">
<span>550 Kcal</span>
<span>P: 45g</span>
<span>C: 15g</span>
<span>F: 35g</span>
</div>
</div>
<div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex flex-col hover:border-primary dark:hover:border-primary cursor-pointer transition-colors">
<div class="flex justify-between items-start mb-2">
<div>
<p class="font-semibold text-gray-900 dark:text-white">Greek Yogurt</p>
<span class="text-xs text-purple-600 bg-purple-100 dark:bg-purple-900/40 dark:text-purple-300 px-2 py-0.5 rounded-full">Food Item</span>
</div>
<button class="p-1 text-gray-500 hover:text-primary"><span class="material-symbols-outlined">add_circle</span></button>
</div>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-3 flex-grow">1 container (170g), plain, non-fat</p>
<div class="text-xs text-gray-500 dark:text-gray-400 flex justify-between items-center">
<span>100 Kcal</span>
<span>P: 17g</span>
<span>C: 6g</span>
<span>F: 0g</span>
</div>
</div>
</div>
</main>
<footer class="flex-shrink-0 p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
<div class="flex justify-end gap-2">
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Cancel</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Add to Plan</span>
</button>
</div>
</footer>
</div>
</div>
</body></html>
</file>

<file path="Design/website/Design/diet_plan_creation_page_2/code.html">
<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Diet Plan Creation - Sarah Singh</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #e0e0e0;
            border-radius: 3px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
    </style>
<script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#17cf54",
              "background-light": "#f6f8f6",
              "background-dark": "#112116",
              "success": "#7ED321",
              "warning": "#F5A623",
              "error": "#D0021B",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-200">
<div class="flex flex-col h-screen">
<header class="flex items-center justify-between whitespace-nowrap border-b border-gray-200 dark:border-gray-700 px-6 py-3 bg-white dark:bg-gray-800 flex-shrink-0">
<div class="flex items-center gap-9">
<a class="flex items-center gap-2 text-gray-700 dark:text-gray-300 text-sm font-medium leading-normal" href="#">
<span class="material-symbols-outlined text-lg">arrow_back</span>
                    Back to Client
                </a>
<span class="text-gray-900 dark:text-white text-sm font-medium leading-normal">Client: Sarah Singh (28F)</span>
</div>
<div class="flex gap-2">
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-3">
<span class="material-symbols-outlined text-xl">visibility</span>
<span class="hidden sm:inline">Preview</span>
</button>
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-3">
<span class="material-symbols-outlined text-xl">download</span>
<span class="hidden sm:inline">Export</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Save as Draft</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Publish</span>
</button>
</div>
</header>
<main class="flex-grow grid grid-cols-12 gap-4 p-4 overflow-auto">
<aside class="col-span-3 flex flex-col gap-4 overflow-y-auto pr-2">
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" data-alt="Photo of Sarah Singh" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuA_mfGBlTQqbqWv8MiukpmpcdMKyoot_7VGTR9C8fop9lNumZzgPYbCu-QiZjXw6-RWx5hru5ihyNxKq2ttqVv2FZmOCeNblDNZb4lNdfRIVPfXXtrQEUb2FSfZq3m461r8eugVlFRScfL8MoqNwzgVFKNd-8EMeg5HvSQknPL05tPwV2bbWMekciSamP4BbVZ9eyfdQKkK3Xa2xiLM3Nwlbcu8JI3uVvb6e5wAOJ68-QfGk7bUE-evRyxiK2CMLt2-sQ6lA1rrw5HT");'></div>
<div class="flex flex-col">
<h1 class="text-gray-900 dark:text-white text-base font-medium leading-normal">Sarah Singh</h1>
<p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">28F, 165cm, 70kg</p>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<p class="text-gray-900 dark:text-white text-base font-medium leading-normal">Weight Trend</p>
<p class="text-gray-900 dark:text-white tracking-light text-[32px] font-bold leading-tight truncate">70kg <span class="text-gray-400 text-xl font-medium">/ Goal 65kg</span></p>
<div class="flex gap-1 items-center">
<p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">Last 30 Days</p>
<p class="text-error text-sm font-medium leading-normal flex items-center gap-1"><span class="material-symbols-outlined text-base">trending_down</span> -2kg</p>
</div>
<div class="flex min-h-[100px] flex-1 flex-col pt-4">
<svg fill="none" height="100" preserveAspectRatio="none" viewBox="-3 0 478 150" width="100%" xmlns="http://www.w3.org/2000/svg">
<path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25V149H326.769H0V109Z" fill="url(#paint0_linear_1131_5935_light)"></path>
<path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25" stroke="#4e9767" stroke-linecap="round" stroke-width="3"></path>
<defs>
<linearGradient gradientUnits="userSpaceOnUse" id="paint0_linear_1131_5935_light" x1="236" x2="236" y1="1" y2="149">
<stop stop-color="#e7f3eb"></stop>
<stop offset="1" stop-color="#e7f3eb" stop-opacity="0"></stop>
</linearGradient>
</defs>
</svg>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-3">Previous Plans</h3>
<div class="flex flex-col gap-1">
<div class="flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 p-2 rounded-lg cursor-pointer">
<div class="text-gray-800 dark:text-gray-200 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700 shrink-0 size-10">
<span class="material-symbols-outlined text-xl">description</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-gray-800 dark:text-gray-100 text-sm font-medium leading-normal line-clamp-1">High Protein Plan</p>
<p class="text-gray-500 dark:text-gray-400 text-xs font-normal leading-normal line-clamp-2">Created by Dr. Evans</p>
</div>
<p class="text-gray-400 dark:text-gray-500 text-xs font-normal leading-normal ml-auto">Nov 15, 2023</p>
</div>
<div class="flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 p-2 rounded-lg cursor-pointer">
<div class="text-gray-800 dark:text-gray-200 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700 shrink-0 size-10">
<span class="material-symbols-outlined text-xl">description</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-gray-800 dark:text-gray-100 text-sm font-medium leading-normal line-clamp-1">Keto Diet Start</p>
<p class="text-gray-500 dark:text-gray-400 text-xs font-normal leading-normal line-clamp-2">Created by You</p>
</div>
<p class="text-gray-400 dark:text-gray-500 text-xs font-normal leading-normal ml-auto">Oct 21, 2023</p>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-3">Medical Summary</h3>
<div class="flex flex-col gap-2">
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Diagnoses</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Hypertension, Pre-diabetic</p>
</details>
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group" open="">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Allergies</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Dairy, Peanuts, Shellfish</p>
</details>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-2">Notes &amp; Alerts</h3>
<textarea class="w-full h-24 p-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add a note for this client...">Client reports feeling bloated after high-carb meals. Monitor closely.</textarea>
</div>
</aside>
<section class="col-span-6 flex flex-col gap-4 overflow-y-auto">
<div class="flex-shrink-0 bg-white dark:bg-gray-800 p-2 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center text-center">
<button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400">chevron_left</span>
</button>
<div class="flex gap-1">
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 1 (Mon)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-white bg-primary">Dec 2 (Tue)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 3 (Wed)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 4 (Thu)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 5 (Fri)</button>
</div>
<button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400">chevron_right</span>
</button>
</div>
</div>
<div class="space-y-4">
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<div class="flex items-center gap-2">
<h3 class="text-lg font-semibold text-gray-900 dark:text-white">Breakfast</h3>
<input class="text-sm p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="time" value="08:00"/>
</div>
<p class="text-xs font-medium text-gray-500 dark:text-gray-400">350 Kcal | P:20g, C:45g, F:10g</p>
</div>
<div class="space-y-2 mb-3">
<div class="flex items-center gap-2 p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Oatmeal</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="1 cup"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
<div class="flex items-center gap-2 p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Blueberries</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="1/2 cup"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
</div>
<div class="flex gap-2">
<div class="relative flex-grow">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add food item..." type="text"/>
</div>
<button class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
<span class="material-symbols-outlined text-lg">menu_book</span>
<span>Templates</span>
</button>
</div>
<textarea class="mt-3 w-full p-2 text-xs border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add a note for the client..."></textarea>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<div class="flex items-center gap-2">
<h3 class="text-lg font-semibold text-gray-900 dark:text-white">Lunch</h3>
<input class="text-sm p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="time" value="13:00"/>
</div>
<p class="text-xs font-medium text-gray-500 dark:text-gray-400">650 Kcal | P:40g, C:60g, F:28g</p>
</div>
<div class="space-y-2 mb-3">
<div class="flex items-center gap-2 p-2 rounded-md bg-red-50 dark:bg-red-900/20 border border-error">
<span class="text-error mr-2"><span class="material-symbols-outlined text-lg">warning</span></span>
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Paneer Tikka</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="150g"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
<div class="flex items-center gap-2 p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Brown Rice</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="1 cup"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
</div>
<div class="flex gap-2">
<div class="relative flex-grow">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add food item..." type="text"/>
</div>
<button class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
<span class="material-symbols-outlined text-lg">menu_book</span>
<span>Templates</span>
</button>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<div class="flex items-center gap-2">
<h3 class="text-lg font-semibold text-gray-900 dark:text-white">Dinner</h3>
<input class="text-sm p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="time" value="19:30"/>
</div>
<p class="text-xs font-medium text-gray-500 dark:text-gray-400">0 Kcal | P:0g, C:0g, F:0g</p>
</div>
<div class="flex gap-2">
<div class="relative flex-grow">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add food item..." type="text"/>
</div>
<button class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
<span class="material-symbols-outlined text-lg">menu_book</span>
<span>Templates</span>
</button>
</div>
</div>
</div>
</section>
<aside class="col-span-3 flex flex-col gap-4 overflow-y-auto pl-2">
<div class="bg-error/10 dark:bg-error/20 border border-error p-4 rounded-lg">
<div class="flex items-start gap-3">
<span class="material-symbols-outlined text-error text-xl mt-0.5">error</span>
<div>
<h4 class="font-bold text-error">Allergy Warning</h4>
<p class="text-sm text-error/80 dark:text-error/90">You added Paneer (dairy). This client has a <span class="font-semibold">Dairy</span> allergy.</p>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal">Plan At-a-Glance</h3>
<span class="text-xs text-gray-500">Target: 1800 Kcal</span>
</div>
<div class="space-y-4">
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Today's Calories</span>
<span class="font-medium text-gray-600 dark:text-gray-400">1000 / 1800 kcal</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 55%"></div>
</div>
</div>
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Protein</span>
<span class="font-medium text-gray-600 dark:text-gray-400">60 / 90 g</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 66%"></div>
</div>
</div>
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Carbohydrates</span>
<span class="font-medium text-gray-600 dark:text-gray-400">105 / 200 g</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 52%"></div>
</div>
</div>
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Fat</span>
<span class="font-medium text-gray-600 dark:text-gray-400">38 / 60 g</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 63%"></div>
</div>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-3">Medical History</h3>
<div class="flex flex-col gap-2">
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Synopsis</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Client presents with hypertension and is classified as pre-diabetic. Key focus is on weight management and reducing sodium intake. Multiple food allergies require careful planning...</p>
</details>
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Recent Labs</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Fasting Glucose: 115 mg/dL (High)<br/>A1c: 5.9% (Elevated)</p>
</details>
</div>
</div>
</aside>
</main>
</div>
</body></html>
</file>

<file path="Design/website/Design/diet_plan_creation_page_3/code.html">
<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Diet Plan Creation - Sarah Singh</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        /* Simple scrollbar styling for a cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #e0e0e0;
            border-radius: 3px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
    </style>
<script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#17cf54",
              "background-light": "#f6f8f6",
              "background-dark": "#112116",
              "success": "#7ED321",
              "warning": "#F5A623",
              "error": "#D0021B",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-200">
<div class="flex flex-col h-screen">
<!-- Top Nav Bar -->
<header class="flex items-center justify-between whitespace-nowrap border-b border-gray-200 dark:border-gray-700 px-6 py-3 bg-white dark:bg-gray-800 flex-shrink-0">
<div class="flex items-center gap-9">
<a class="flex items-center gap-2 text-gray-700 dark:text-gray-300 text-sm font-medium leading-normal" href="#">
<span class="material-symbols-outlined text-lg">arrow_back</span>
                    Back to Client
                </a>
<span class="text-gray-900 dark:text-white text-sm font-medium leading-normal">Client: Sarah Singh (28F)</span>
</div>
<div class="flex gap-2">
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-3">
<span class="material-symbols-outlined text-xl">visibility</span>
<span class="hidden sm:inline">Preview</span>
</button>
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-3">
<span class="material-symbols-outlined text-xl">download</span>
<span class="hidden sm:inline">Export</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Save as Draft</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Publish</span>
</button>
</div>
</header>
<!-- Main Content Area -->
<main class="flex-grow grid grid-cols-12 gap-4 p-4 overflow-auto">
<!-- Left Sidebar Info Panel -->
<aside class="col-span-3 flex flex-col gap-4 overflow-y-auto pr-2">
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" data-alt="Photo of Sarah Singh" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuA_mfGBlTQqbqWv8MiukpmpcdMKyoot_7VGTR9C8fop9lNumZzgPYbCu-QiZjXw6-RWx5hru5ihyNxKq2ttqVv2FZmOCeNblDNZb4lNdfRIVPfXXtrQEUb2FSfZq3m461r8eugVlFRScfL8MoqNwzgVFKNd-8EMeg5HvSQknPL05tPwV2bbWMekciSamP4BbVZ9eyfdQKkK3Xa2xiLM3Nwlbcu8JI3uVvb6e5wAOJ68-QfGk7bUE-evRyxiK2CMLt2-sQ6lA1rrw5HT");'></div>
<div class="flex flex-col">
<h1 class="text-gray-900 dark:text-white text-base font-medium leading-normal">Sarah Singh</h1>
<p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">28F, 165cm, 70kg</p>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<p class="text-gray-900 dark:text-white text-base font-medium leading-normal">Weight Trend</p>
<p class="text-gray-900 dark:text-white tracking-light text-[32px] font-bold leading-tight truncate">70kg <span class="text-gray-400 text-xl font-medium">/ Goal 65kg</span></p>
<div class="flex gap-1 items-center">
<p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">Last 30 Days</p>
<p class="text-error text-sm font-medium leading-normal flex items-center gap-1"><span class="material-symbols-outlined text-base">trending_down</span> -2kg</p>
</div>
<div class="flex min-h-[100px] flex-1 flex-col pt-4">
<svg fill="none" height="100" preserveaspectratio="none" viewbox="-3 0 478 150" width="100%" xmlns="http://www.w3.org/2000/svg">
<path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25V149H326.769H0V109Z" fill="url(#paint0_linear_1131_5935_light)"></path>
<path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25" stroke="#4e9767" stroke-linecap="round" stroke-width="3"></path>
<defs>
<lineargradient gradientunits="userSpaceOnUse" id="paint0_linear_1131_5935_light" x1="236" x2="236" y1="1" y2="149">
<stop stop-color="#e7f3eb"></stop>
<stop offset="1" stop-color="#e7f3eb" stop-opacity="0"></stop>
</lineargradient>
</defs>
</svg>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-3">Previous Plans</h3>
<div class="flex flex-col gap-1">
<div class="flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 p-2 rounded-lg cursor-pointer">
<div class="text-gray-800 dark:text-gray-200 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700 shrink-0 size-10">
<span class="material-symbols-outlined text-xl">description</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-gray-800 dark:text-gray-100 text-sm font-medium leading-normal line-clamp-1">High Protein Plan</p>
<p class="text-gray-500 dark:text-gray-400 text-xs font-normal leading-normal line-clamp-2">Created by Dr. Evans</p>
</div>
<p class="text-gray-400 dark:text-gray-500 text-xs font-normal leading-normal ml-auto">Nov 15, 2023</p>
</div>
<div class="flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 p-2 rounded-lg cursor-pointer">
<div class="text-gray-800 dark:text-gray-200 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700 shrink-0 size-10">
<span class="material-symbols-outlined text-xl">description</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-gray-800 dark:text-gray-100 text-sm font-medium leading-normal line-clamp-1">Keto Diet Start</p>
<p class="text-gray-500 dark:text-gray-400 text-xs font-normal leading-normal line-clamp-2">Created by You</p>
</div>
<p class="text-gray-400 dark:text-gray-500 text-xs font-normal leading-normal ml-auto">Oct 21, 2023</p>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-3">Medical Summary</h3>
<div class="flex flex-col gap-2">
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Diagnoses</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Hypertension, Pre-diabetic</p>
</details>
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group" open="">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Allergies</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Dairy, Peanuts, Shellfish</p>
</details>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-2">Notes &amp; Alerts</h3>
<textarea class="w-full h-24 p-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add a note for this client...">Client reports feeling bloated after high-carb meals. Monitor closely.</textarea>
</div>
</aside>
<!-- Center Diet Plan Canvas -->
<section class="col-span-6 flex flex-col gap-4 overflow-y-auto">
<div class="flex-shrink-0 bg-white dark:bg-gray-800 p-2 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center text-center">
<button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400">chevron_left</span>
</button>
<div class="flex gap-1">
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 1 (Mon)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-white bg-primary">Dec 2 (Tue)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 3 (Wed)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 4 (Thu)</button>
<button class="px-3 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Dec 5 (Fri)</button>
</div>
<button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400">chevron_right</span>
</button>
</div>
</div>
<!-- Meal Cards -->
<div class="space-y-4">
<!-- Breakfast -->
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<div class="flex items-center gap-2">
<h3 class="text-lg font-semibold text-gray-900 dark:text-white">Breakfast</h3>
<input class="text-sm p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="time" value="08:00"/>
</div>
<p class="text-xs font-medium text-gray-500 dark:text-gray-400">350 Kcal | P:20g, C:45g, F:10g</p>
</div>
<div class="space-y-2 mb-3">
<div class="flex items-center gap-2 p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Oatmeal</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="1 cup"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
<div class="flex items-center gap-2 p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Blueberries</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="1/2 cup"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
</div>
<div class="relative">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add food item..." type="text"/>
</div>
<textarea class="mt-3 w-full p-2 text-xs border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add a note for the client..."></textarea>
</div>
<!-- Lunch -->
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<div class="flex items-center gap-2">
<h3 class="text-lg font-semibold text-gray-900 dark:text-white">Lunch</h3>
<input class="text-sm p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="time" value="13:00"/>
</div>
<p class="text-xs font-medium text-gray-500 dark:text-gray-400">650 Kcal | P:40g, C:60g, F:28g</p>
</div>
<div class="space-y-2 mb-3">
<div class="flex items-center gap-2 p-2 rounded-md bg-red-50 dark:bg-red-900/20 border border-error">
<span class="text-error mr-2"><span class="material-symbols-outlined text-lg">warning</span></span>
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Paneer Tikka</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="150g"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
<div class="flex items-center gap-2 p-2 rounded-md bg-gray-50 dark:bg-gray-700/50">
<span class="text-gray-800 dark:text-gray-200 text-sm font-medium flex-grow">Brown Rice</span>
<input class="w-20 text-sm text-right p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="text" value="1 cup"/>
<button class="p-1 text-gray-500 dark:text-gray-400 hover:text-error"><span class="material-symbols-outlined text-lg">delete</span></button>
</div>
</div>
<div class="relative">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add food item..." type="text"/>
</div>
</div>
<!-- Dinner -->
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<div class="flex items-center gap-2">
<h3 class="text-lg font-semibold text-gray-900 dark:text-white">Dinner</h3>
<input class="text-sm p-1 border border-gray-200 dark:border-gray-600 rounded-md bg-transparent dark:text-gray-300" type="time" value="19:30"/>
</div>
<p class="text-xs font-medium text-gray-500 dark:text-gray-400">0 Kcal | P:0g, C:0g, F:0g</p>
</div>
<div class="relative">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-md bg-transparent focus:ring-primary focus:border-primary dark:text-gray-300" placeholder="Add food item..." type="text"/>
</div>
</div>
</div>
</section>
<!-- Right Plan/Client Context -->
<aside class="col-span-3 flex flex-col gap-4 overflow-y-auto pl-2">
<div class="bg-error/10 dark:bg-error/20 border border-error p-4 rounded-lg">
<div class="flex items-start gap-3">
<span class="material-symbols-outlined text-error text-xl mt-0.5">error</span>
<div>
<h4 class="font-bold text-error">Allergy Warning</h4>
<p class="text-sm text-error/80 dark:text-error/90">You added Paneer (dairy). This client has a <span class="font-semibold">Dairy</span> allergy.</p>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-3">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal">Plan At-a-Glance</h3>
<span class="text-xs text-gray-500">Target: 1800 Kcal</span>
</div>
<div class="space-y-4">
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Today's Calories</span>
<span class="font-medium text-gray-600 dark:text-gray-400">1000 / 1800 kcal</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 55%"></div>
</div>
</div>
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Protein</span>
<span class="font-medium text-gray-600 dark:text-gray-400">60 / 90 g</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 66%"></div>
</div>
</div>
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Carbohydrates</span>
<span class="font-medium text-gray-600 dark:text-gray-400">105 / 200 g</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 52%"></div>
</div>
</div>
<div>
<div class="flex justify-between text-sm mb-1">
<span class="font-medium text-gray-800 dark:text-gray-200">Fat</span>
<span class="font-medium text-gray-600 dark:text-gray-400">38 / 60 g</span>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
<div class="bg-primary h-2 rounded-full" style="width: 63%"></div>
</div>
</div>
</div>
</div>
<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
<h3 class="text-gray-900 dark:text-white text-base font-medium leading-normal mb-3">Medical History</h3>
<div class="flex flex-col gap-2">
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Synopsis</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Client presents with hypertension and is classified as pre-diabetic. Key focus is on weight management and reducing sodium intake. Multiple food allergies require careful planning...</p>
</details>
<details class="flex flex-col rounded-lg bg-gray-50 dark:bg-gray-900/50 px-4 py-1 group">
<summary class="flex cursor-pointer items-center justify-between gap-6 py-2">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Recent Labs</p>
<span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-open:rotate-180 transition-transform">expand_more</span>
</summary>
<p class="text-gray-600 dark:text-gray-400 text-sm font-normal leading-normal pb-2">Fasting Glucose: 115 mg/dL (High)<br/>A1c: 5.9% (Elevated)</p>
</details>
</div>
</div>
</aside>
</main>
</div>
</body></html>
</file>

<file path="Design/website/Design/landingpage/code.html">
<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>NutriDash - Intelligent Nutrition Management</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<!-- Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#17cf54",
                        "background-light": "#f6f8f6",
                        "background-dark": "#112116",
                        "text-main": "#0e1b12",
                        "text-secondary": "#4e9767",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-main dark:text-white font-display overflow-x-hidden antialiased">
<!-- Navigation -->
<nav class="sticky top-0 z-50 w-full border-b border-[#e7f3eb] dark:border-white/10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md">
<div class="max-w-[1280px] mx-auto px-4 sm:px-10 py-3">
<div class="flex items-center justify-between whitespace-nowrap">
<div class="flex items-center gap-3 text-text-main dark:text-white">
<div class="flex items-center justify-center size-8 rounded-lg bg-primary/20 text-primary">
<span class="material-symbols-outlined text-[24px]">nutrition</span>
</div>
<h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">NutriDash</h2>
</div>
<div class="hidden md:flex flex-1 justify-end gap-8 items-center">
<div class="flex items-center gap-9">
<a class="text-sm font-medium hover:text-primary transition-colors" href="#">Features</a>
<a class="text-sm font-medium hover:text-primary transition-colors" href="#">Pricing</a>
<a class="text-sm font-medium hover:text-primary transition-colors" href="#">About</a>
</div>
<div class="flex gap-2">
<button class="flex items-center justify-center overflow-hidden rounded-lg h-9 px-4 bg-transparent hover:bg-black/5 dark:hover:bg-white/5 text-sm font-bold transition-colors">
<span>Login</span>
</button>
<button class="flex items-center justify-center overflow-hidden rounded-lg h-9 px-4 bg-primary hover:bg-primary/90 text-text-main text-sm font-bold transition-colors shadow-sm shadow-primary/20">
<span>Get Started</span>
</button>
</div>
</div>
<!-- Mobile Menu Icon -->
<div class="md:hidden flex items-center">
<button class="p-2 text-text-main dark:text-white">
<span class="material-symbols-outlined">menu</span>
</button>
</div>
</div>
</div>
</nav>
<!-- Hero Section -->
<div class="relative w-full">
<!-- Background decorative elements -->
<div class="absolute top-0 right-0 -z-10 w-1/2 h-full bg-gradient-to-l from-primary/5 to-transparent"></div>
<div class="layout-container flex flex-col justify-center">
<div class="px-4 md:px-10 lg:px-40 flex flex-1 justify-center py-10 lg:py-20">
<div class="layout-content-container flex flex-col max-w-[1280px] flex-1">
<div class="@container">
<div class="flex flex-col gap-10 lg:gap-16 lg:flex-row items-center">
<!-- Hero Content -->
<div class="flex flex-col gap-6 flex-1 text-center lg:text-left">
<div class="flex flex-col gap-4">
<div class="inline-flex items-center gap-2 self-center lg:self-start px-3 py-1 rounded-full bg-primary/10 border border-primary/20 text-xs font-bold text-primary uppercase tracking-wide">
<span class="size-2 rounded-full bg-primary animate-pulse"></span>
                                        New: AI Meal Planning
                                    </div>
<h1 class="text-4xl sm:text-5xl lg:text-6xl font-black leading-tight tracking-[-0.033em] text-text-main dark:text-white">
                                        Empower Your Practice with <span class="text-primary">Intelligent</span> Nutrition.
                                    </h1>
<h2 class="text-text-main/70 dark:text-white/70 text-lg font-normal leading-relaxed max-w-2xl mx-auto lg:mx-0">
                                        Streamline client tracking, automate meal plans, and visualize patient progress in one secure dashboard tailored for modern dieticians.
                                    </h2>
</div>
<div class="flex flex-wrap gap-3 justify-center lg:justify-start">
<button class="flex min-w-[140px] items-center justify-center rounded-lg h-12 px-6 bg-primary hover:bg-primary/90 text-text-main text-base font-bold transition-all shadow-lg shadow-primary/25">
                                        Start Free Trial
                                    </button>
<button class="flex min-w-[140px] items-center justify-center rounded-lg h-12 px-6 bg-white dark:bg-white/10 border border-[#e7f3eb] dark:border-white/10 hover:bg-[#f0fdf4] dark:hover:bg-white/20 text-text-main dark:text-white text-base font-bold transition-all">
                                        Book a Demo
                                    </button>
</div>
<div class="flex items-center justify-center lg:justify-start gap-4 pt-2">
<div class="flex -space-x-2">
<div class="size-8 rounded-full bg-gray-200 border-2 border-white dark:border-[#112116] bg-cover" data-alt="Portrait of a female user" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDghaDbjhAACb4EFl89i7zRxRK_Xudncr1reOFU4g6FLr0np0HclB3D2nyT8R3-fqeXI6JShZkNtx7shPUfXvEL7TyZSZKJp17qhLWwLgBholLEsyg9uySAcUUuRoIlhUv6dvH3-N0xCcEa2cVzgt1tsFi1vPGkVBPwpnW1C-txADm_OglB9TWMfXtQkPKwu0Y7c32o0KVlcVeFDr4MZMMaTJ6n1f3GgiOZt9V2aISqH47Pm5zI5TWlgTf9QemEn0PTgHGFKzgpvomQ');"></div>
<div class="size-8 rounded-full bg-gray-200 border-2 border-white dark:border-[#112116] bg-cover" data-alt="Portrait of a male user" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuAmtu7nsCZYduF9h10m3RlVcX4taNbLEQdsfffBXXEbw9uYy6N7NkMhxnJwHOzwY-1ow9lCSLjv3zFff5hYFNXlfgiPO2ZxF7fWVg66dlOeemCdBMlggIqApYY_w5X37fXtlIpKJaSychF6KtvqI3asmNRSXtoMm-lNUVH-KkhPBl4z2sUvGD7n2FH5MXZlAspJimCCmdxV2UspZNRp4JxaeFjFk_pK0in1oGGORrd8Ar2gWVAYbDf7Cbr2wfZneKOdpJvzy8onL-Rt');"></div>
<div class="size-8 rounded-full bg-gray-200 border-2 border-white dark:border-[#112116] bg-cover" data-alt="Portrait of a male user" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDqv4YdpwwhTTTQ61jVQRfzlKVMxLLsqeYOYbCONfc7BQu3SdtkA53EhJmI2f9cSOtUp3ohEEAJ2szccWN56lTcwY6Xf5eA1zYu6bcDEqLHxvaALVH_1gC1pO08Cl7UIrf-pWlSGgOcetsLDB58IvgpzPTgynl2RBK7IJNLO2C5wFUBWLdYqyiOmFhHFEu0qMWmansPpBvxdSlFfjwQZ-wK4PD2BPKATY4yTNRcbJO1ZTB1PvjwcNJGe8NoDD7Q9CT1wL16lveGeDu7');"></div>
<div class="flex items-center justify-center size-8 rounded-full bg-primary text-text-main text-[10px] font-bold border-2 border-white dark:border-[#112116]">+2k</div>
</div>
<p class="text-sm font-medium text-text-main/60 dark:text-white/60">Professionals trust us</p>
</div>
</div>
<!-- Hero Image -->
<div class="w-full lg:w-1/2 flex justify-center lg:justify-end relative">
<div class="absolute -inset-4 bg-primary/20 blur-3xl rounded-full opacity-30"></div>
<div class="relative w-full aspect-[4/3] rounded-xl overflow-hidden shadow-2xl border border-black/5 dark:border-white/10 bg-white dark:bg-[#1a2e20]">
<!-- Abstract UI representation -->
<div class="w-full h-full bg-cover bg-center bg-no-repeat" data-alt="Dashboard interface displaying charts and health metrics on a laptop screen" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBih9ymp3pJ4iQWQgZ4sgBoYEVcsmjOrXJxGVB_skTJbzoNdCtlgvnbIjTbGppGfLTnr_YxQyJtwWVZkVyIFNmICeQyYXJxDE1UCNVBzMG34C8n-4wm92zW3_lC45VOKShAKWb1BUvYbtaA2ZubFvfiM_zFpCSMXmDGF_jxO4y-jsNTCn5sxuuJbZmkx0wevS5Tzr85-CBmilXthV-F629fzCWsdeSki_wbabjgmIMMjxNFEFPgIzdK7Gr7Nd940TjIiw2sUbGrPZNn');"></div>
<!-- Floating Element 1 -->
<div class="absolute bottom-6 left-6 p-4 bg-white dark:bg-[#1e3324] rounded-lg shadow-lg border border-primary/10 flex items-center gap-3 animate-bounce" style="animation-duration: 3s;">
<div class="size-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-primary">
<span class="material-symbols-outlined">check_circle</span>
</div>
<div>
<p class="text-xs text-text-main/50 dark:text-white/50 font-medium">Daily Goal</p>
<p class="text-sm font-bold text-text-main dark:text-white">Meal Plan Added</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Section Header: Features -->
<div class="w-full bg-white dark:bg-[#16291d] py-16">
<div class="layout-container flex flex-col items-center">
<div class="px-4 md:px-10 max-w-[960px] text-center mb-12">
<span class="text-primary font-bold tracking-wider text-sm uppercase mb-2 block">Core Features</span>
<h2 class="text-3xl md:text-4xl font-bold leading-tight tracking-[-0.015em] text-text-main dark:text-white">
                    Everything you need to run a modern clinic
                </h2>
<p class="mt-4 text-text-main/60 dark:text-white/60 max-w-2xl mx-auto">
                    Focus on your patients while we handle the administration, planning, and tracking.
                </p>
</div>
<!-- Features Grid -->
<div class="px-4 md:px-10 max-w-[1280px] w-full">
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
<!-- Feature 1 -->
<div class="group flex flex-col gap-4 rounded-xl border border-[#d0e7d7] dark:border-white/10 bg-background-light dark:bg-background-dark p-6 transition-all hover:shadow-lg hover:border-primary/50">
<div class="size-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-text-main transition-colors">
<span class="material-symbols-outlined text-[28px]">restaurant_menu</span>
</div>
<div class="flex flex-col gap-2">
<h3 class="text-xl font-bold text-text-main dark:text-white">Smart Meal Planning</h3>
<p class="text-text-secondary dark:text-white/60 text-sm leading-relaxed">
                                AI-assisted drag-and-drop diet creation. Create balanced plans in seconds, not hours.
                            </p>
</div>
</div>
<!-- Feature 2 -->
<div class="group flex flex-col gap-4 rounded-xl border border-[#d0e7d7] dark:border-white/10 bg-background-light dark:bg-background-dark p-6 transition-all hover:shadow-lg hover:border-primary/50">
<div class="size-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-text-main transition-colors">
<span class="material-symbols-outlined text-[28px]">chat_bubble_outline</span>
</div>
<div class="flex flex-col gap-2">
<h3 class="text-xl font-bold text-text-main dark:text-white">Patient Portal</h3>
<p class="text-text-secondary dark:text-white/60 text-sm leading-relaxed">
                                Secure direct messaging, document sharing, and progress tracking for your clients.
                            </p>
</div>
</div>
<!-- Feature 3 -->
<div class="group flex flex-col gap-4 rounded-xl border border-[#d0e7d7] dark:border-white/10 bg-background-light dark:bg-background-dark p-6 transition-all hover:shadow-lg hover:border-primary/50">
<div class="size-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-text-main transition-colors">
<span class="material-symbols-outlined text-[28px]">monitoring</span>
</div>
<div class="flex flex-col gap-2">
<h3 class="text-xl font-bold text-text-main dark:text-white">Data Analytics</h3>
<p class="text-text-secondary dark:text-white/60 text-sm leading-relaxed">
                                Visualize health trends, weight changes, and adherence rates instantly with beautiful charts.
                            </p>
</div>
</div>
<!-- Feature 4 -->
<div class="group flex flex-col gap-4 rounded-xl border border-[#d0e7d7] dark:border-white/10 bg-background-light dark:bg-background-dark p-6 transition-all hover:shadow-lg hover:border-primary/50">
<div class="size-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-text-main transition-colors">
<span class="material-symbols-outlined text-[28px]">event_available</span>
</div>
<div class="flex flex-col gap-2">
<h3 class="text-xl font-bold text-text-main dark:text-white">Scheduling &amp; Booking</h3>
<p class="text-text-secondary dark:text-white/60 text-sm leading-relaxed">
                                Integrated calendar that syncs with Google and Outlook. Reduce no-shows with automated reminders.
                            </p>
</div>
</div>
<!-- Feature 5 -->
<div class="group flex flex-col gap-4 rounded-xl border border-[#d0e7d7] dark:border-white/10 bg-background-light dark:bg-background-dark p-6 transition-all hover:shadow-lg hover:border-primary/50">
<div class="size-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-text-main transition-colors">
<span class="material-symbols-outlined text-[28px]">verified_user</span>
</div>
<div class="flex flex-col gap-2">
<h3 class="text-xl font-bold text-text-main dark:text-white">HIPAA Compliant</h3>
<p class="text-text-secondary dark:text-white/60 text-sm leading-relaxed">
                                Enterprise-grade security keeps your patient data safe and compliant with global regulations.
                            </p>
</div>
</div>
<!-- Feature 6 -->
<div class="group flex flex-col gap-4 rounded-xl border border-[#d0e7d7] dark:border-white/10 bg-background-light dark:bg-background-dark p-6 transition-all hover:shadow-lg hover:border-primary/50">
<div class="size-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-text-main transition-colors">
<span class="material-symbols-outlined text-[28px]">smartphone</span>
</div>
<div class="flex flex-col gap-2">
<h3 class="text-xl font-bold text-text-main dark:text-white">Mobile Companion App</h3>
<p class="text-text-secondary dark:text-white/60 text-sm leading-relaxed">
                                Give patients a dedicated app to log meals, view plans, and stay connected on the go.
                            </p>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Stats Section -->
<div class="w-full bg-primary/5 border-y border-primary/10 py-12">
<div class="max-w-[1280px] mx-auto px-4 sm:px-10">
<div class="flex flex-wrap justify-around items-center gap-8 text-center">
<div class="flex flex-col gap-1">
<span class="text-4xl font-black text-text-main dark:text-white tracking-tight">10k+</span>
<span class="text-sm font-medium text-text-secondary uppercase tracking-wider">Professionals</span>
</div>
<div class="w-px h-12 bg-primary/20 hidden md:block"></div>
<div class="flex flex-col gap-1">
<span class="text-4xl font-black text-text-main dark:text-white tracking-tight">2M+</span>
<span class="text-sm font-medium text-text-secondary uppercase tracking-wider">Meal Plans Created</span>
</div>
<div class="w-px h-12 bg-primary/20 hidden md:block"></div>
<div class="flex flex-col gap-1">
<span class="text-4xl font-black text-text-main dark:text-white tracking-tight">98%</span>
<span class="text-sm font-medium text-text-secondary uppercase tracking-wider">Customer Satisfaction</span>
</div>
</div>
</div>
</div>
<!-- Testimonials Section -->
<div class="w-full py-20 bg-background-light dark:bg-background-dark">
<div class="layout-container flex flex-col items-center">
<div class="px-4 md:px-10 max-w-[960px] text-center mb-16">
<h2 class="text-3xl font-bold leading-tight tracking-[-0.015em] text-text-main dark:text-white">
                    Trusted by Top Nutritionists
                </h2>
</div>
<div class="px-4 md:px-10 max-w-[1280px] w-full">
<div class="grid grid-cols-1 md:grid-cols-3 gap-8">
<!-- Card 1 -->
<div class="flex flex-col justify-between p-8 bg-white dark:bg-[#16291d] rounded-2xl shadow-sm border border-[#e7f3eb] dark:border-white/5">
<div class="mb-6 text-primary">
<span class="material-symbols-outlined text-4xl">format_quote</span>
</div>
<p class="text-lg text-text-main dark:text-white/90 font-medium leading-relaxed mb-8">
                            "NutriDash cut my administrative time in half. The meal planning tool is intuitive and my clients love the mobile app. It's a game changer."
                        </p>
<div class="flex items-center gap-4">
<div class="size-12 rounded-full bg-cover bg-center" data-alt="Portrait of Dr. Sarah Chen" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCHeRzfG33d56VwzPgXHjPSZfDmpbBeNW8QIToEJlAU_x5BggfpDJIOmgM2sTy5hx_52BJbxFlWgxjfmZs9X1d7tDJ_2fawJIzEjK1VcNu--eQcgJ6Elxh8KD-m8Z7gIR52dt4IxrpLygyCha3Lxaod_gVmvtm_E3xhKK77Ni4QDKeCEqLZuEC0946UT_rcYoxprS75x6Z7rmqXjvo7ekP2RmtY9acajYQ6R8PmWewLdKD_EJDrg7SJk644S1LpeQTB0R-f31On4X_i');"></div>
<div>
<h4 class="font-bold text-text-main dark:text-white">Dr. Sarah Chen</h4>
<p class="text-sm text-text-secondary">Clinical Dietician</p>
</div>
</div>
</div>
<!-- Card 2 -->
<div class="flex flex-col justify-between p-8 bg-white dark:bg-[#16291d] rounded-2xl shadow-sm border border-[#e7f3eb] dark:border-white/5 relative">
<!-- Decorative bg -->
<div class="absolute top-0 right-0 p-8 opacity-10 pointer-events-none">
<svg fill="none" height="100" viewbox="0 0 100 100" width="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" fill="#17cf54" r="50"></circle></svg>
</div>
<div class="mb-6 text-primary">
<span class="material-symbols-outlined text-4xl">format_quote</span>
</div>
<p class="text-lg text-text-main dark:text-white/90 font-medium leading-relaxed mb-8">
                            "Finally, a dashboard that looks good and works even better. The analytics feature helps me show tangible progress to my patients, which boosts retention."
                        </p>
<div class="flex items-center gap-4">
<div class="size-12 rounded-full bg-cover bg-center" data-alt="Portrait of Marcus Johnson" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuAEERF2__oRF6h6ghkZZbHEEV3mVFinYWtHLAz2lUaeddS1dGFxDCVMozBMWYyPDwgY3EYOnduJfKJKK4tw-cP92W-P3BbZV4FOxiDQJS-1Vu9ddQoeT9fhqunK8l3XVKxretCID8RzJF_c-qurlOzvBOqDswlA0YntPNlz-7Ga9mS3DjfCFn1xgtqFkRkC7KsnA-rdT-2Sf8MHwZyFe8z0rGfffj2i339TtL45XZG47MH_oBsLfjx_P_04Rno32xztjIp_22UBuPFm');"></div>
<div>
<h4 class="font-bold text-text-main dark:text-white">Marcus Johnson</h4>
<p class="text-sm text-text-secondary">Sports Nutritionist</p>
</div>
</div>
</div>
<!-- Card 3 -->
<div class="flex flex-col justify-between p-8 bg-white dark:bg-[#16291d] rounded-2xl shadow-sm border border-[#e7f3eb] dark:border-white/5">
<div class="mb-6 text-primary">
<span class="material-symbols-outlined text-4xl">format_quote</span>
</div>
<p class="text-lg text-text-main dark:text-white/90 font-medium leading-relaxed mb-8">
                            "The automated compliance features give me peace of mind. I can manage more clients without feeling overwhelmed. Highly recommended."
                        </p>
<div class="flex items-center gap-4">
<div class="size-12 rounded-full bg-cover bg-center" data-alt="Portrait of Elena Rodriguez" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBdV4njegtYcL_wJtNPYa-zXNit1bvvCKI7d-6jVcKxH3R86HnI-mH6HHTtQotMGLjL0VJDKi4jpWgmId_OmApxs47lp5m3Pm-njXMBWSqJKj377T3SYQISSFt5Ptpt5XtBN-IrCtB6c_senI6q-oYjCCTMAIGPG_aO38UOii5_-WRSH3heK2_qAegJ8dVwFI8y_nXJm66uYbCRQUVSs8DxQB1ebPpaKkUutH3ONjk4HXI_71P9VweFBAndI9-WeJalmbwM_2EiW1aN');"></div>
<div>
<h4 class="font-bold text-text-main dark:text-white">Elena Rodriguez</h4>
<p class="text-sm text-text-secondary">Private Practice Owner</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- CTA Section -->
<div class="py-20 px-4">
<div class="max-w-[1280px] mx-auto bg-[#0e1b12] rounded-3xl overflow-hidden relative">
<!-- Background Pattern -->
<div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#17cf54 1px, transparent 1px); background-size: 30px 30px;"></div>
<div class="relative z-10 flex flex-col md:flex-row items-center justify-between p-10 md:p-16 gap-10">
<div class="flex flex-col gap-6 max-w-2xl">
<h2 class="text-3xl md:text-5xl font-bold text-white leading-tight">Ready to modernize your practice?</h2>
<p class="text-white/80 text-lg">Join thousands of health professionals using NutriDash to deliver better care.</p>
<div class="flex flex-col sm:flex-row gap-4 pt-4">
<button class="flex items-center justify-center rounded-lg h-12 px-8 bg-primary hover:bg-primary/90 text-[#0e1b12] text-base font-bold transition-all shadow-lg shadow-primary/30">
                            Get Started Now
                        </button>
<button class="flex items-center justify-center rounded-lg h-12 px-8 bg-white/10 hover:bg-white/20 text-white text-base font-bold transition-all border border-white/20">
                            Contact Sales
                        </button>
</div>
</div>
<div class="hidden lg:block relative">
<div class="size-64 bg-primary/20 rounded-full blur-3xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
<span class="material-symbols-outlined text-[200px] text-primary/30 rotate-12">spa</span>
</div>
</div>
</div>
</div>
<!-- Footer -->
<footer class="bg-white dark:bg-[#0e1b12] border-t border-[#e7f3eb] dark:border-white/10 pt-16 pb-8">
<div class="max-w-[1280px] mx-auto px-4 sm:px-10">
<div class="grid grid-cols-2 md:grid-cols-4 gap-10 mb-16">
<!-- Brand Col -->
<div class="col-span-2 md:col-span-1 flex flex-col gap-6">
<div class="flex items-center gap-2 text-text-main dark:text-white">
<div class="size-6 rounded bg-primary/20 text-primary flex items-center justify-center">
<span class="material-symbols-outlined text-[18px]">nutrition</span>
</div>
<span class="font-bold text-lg">NutriDash</span>
</div>
<p class="text-sm text-text-main/60 dark:text-white/60">
                        The all-in-one platform for nutrition professionals to manage clients, plans, and payments.
                    </p>
<div class="flex gap-4">
<a class="text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#"><span class="material-symbols-outlined">public</span></a>
<a class="text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#"><span class="material-symbols-outlined">mail</span></a>
</div>
</div>
<!-- Links Col 1 -->
<div class="flex flex-col gap-4">
<h4 class="font-bold text-text-main dark:text-white">Product</h4>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Features</a>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Pricing</a>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Case Studies</a>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Reviews</a>
</div>
<!-- Links Col 2 -->
<div class="flex flex-col gap-4">
<h4 class="font-bold text-text-main dark:text-white">Company</h4>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">About</a>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Careers</a>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Contact</a>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Partners</a>
</div>
<!-- Links Col 3 -->
<div class="flex flex-col gap-4">
<h4 class="font-bold text-text-main dark:text-white">Legal</h4>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Privacy Policy</a>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Terms of Service</a>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">Cookie Policy</a>
<a class="text-sm text-text-main/60 hover:text-primary dark:text-white/60 transition-colors" href="#">HIPAA</a>
</div>
</div>
<div class="border-t border-[#e7f3eb] dark:border-white/10 pt-8 flex flex-col md:flex-row justify-between items-center gap-4">
<p class="text-sm text-text-main/40 dark:text-white/40">© 2024 NutriDash Inc. All rights reserved.</p>
<div class="flex gap-6">
<!-- Simple language selector -->
<button class="flex items-center gap-2 text-sm text-text-main/60 dark:text-white/60 hover:text-primary">
<span class="material-symbols-outlined text-[18px]">language</span>
                        English (US)
                    </button>
</div>
</div>
</div>
</footer>
</body></html>
</file>

<file path="Design/website/Design/meal_photo_review_queue/code.html">
<!DOCTYPE html>

<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Meal Photo Review Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#17cf54",
              "background-light": "#f6f8f6",
              "background-dark": "#112116",
            },
            fontFamily: {
              "display": ["Inter"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
<style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="relative flex min-h-screen w-full">
<!-- Side Navigation Bar -->
<aside class="flex h-screen w-64 flex-col border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-[#1C2C21] p-4 flex-shrink-0">
<div class="flex flex-col gap-4">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Dr. Emily Carter" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuD0BKf2DiCvuew6HJWeI-8vqPhXF3AaVuYv5mpo7BXXwTP69BXWa7Iq1PzzKKmxwWWBzde8jIAHwm42yv_xTIup7AoZzKb3v8sRx8giqBz61t5NlMpC4aKggcxGfZ9FkrjXXI6RUf1TCBH6ysK0FAjdegojotBcEBUfUFw0qZYwDEiCaD9bqpQX_FkbWZH4cXMs6DfxQDC61DsbRwj65GInAqV8gb8tO_RoW58_BSfIPdVxDDXzIJGFVuWC32CIHAB5DXoAoIsCXNkD");'></div>
<div class="flex flex-col">
<h1 class="text-[#0e1b12] dark:text-gray-100 text-base font-medium leading-normal">Dr. Emily Carter</h1>
<p class="text-[#4e9767] dark:text-primary/80 text-sm font-normal leading-normal">Dietician</p>
</div>
</div>
<div class="flex flex-col gap-2 mt-4">
<a class="flex items-center gap-3 px-3 py-2 text-[#0e1b12] dark:text-gray-300 hover:bg-primary/10 rounded-lg" href="#">
<span class="material-symbols-outlined text-2xl">dashboard</span>
<p class="text-sm font-medium leading-normal">Dashboard</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 text-[#0e1b12] dark:text-gray-300 hover:bg-primary/10 rounded-lg" href="#">
<span class="material-symbols-outlined text-2xl">group</span>
<p class="text-sm font-medium leading-normal">Clients</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-[#0e1b12] dark:text-white" href="#">
<span class="material-symbols-outlined text-2xl">photo_camera</span>
<p class="text-sm font-medium leading-normal">Meal Review</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 text-[#0e1b12] dark:text-gray-300 hover:bg-primary/10 rounded-lg" href="#">
<span class="material-symbols-outlined text-2xl">mail</span>
<p class="text-sm font-medium leading-normal">Messages</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 text-[#0e1b12] dark:text-gray-300 hover:bg-primary/10 rounded-lg" href="#">
<span class="material-symbols-outlined text-2xl">bar_chart</span>
<p class="text-sm font-medium leading-normal">Reports</p>
</a>
</div>
</div>
<div class="mt-auto flex flex-col gap-4">
<button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">New Client</span>
</button>
<div class="flex flex-col gap-1">
<a class="flex items-center gap-3 px-3 py-2 text-[#0e1b12] dark:text-gray-300 hover:bg-primary/10 rounded-lg" href="#">
<span class="material-symbols-outlined text-2xl">settings</span>
<p class="text-sm font-medium leading-normal">Settings</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 text-[#0e1b12] dark:text-gray-300 hover:bg-primary/10 rounded-lg" href="#">
<span class="material-symbols-outlined text-2xl">help</span>
<p class="text-sm font-medium leading-normal">Help</p>
</a>
</div>
</div>
</aside>
<!-- Main Content Area -->
<main class="flex-1 grid grid-cols-1 xl:grid-cols-2 h-screen overflow-hidden">
<!-- Left Column: Meal Queue -->
<div class="flex flex-col bg-white dark:bg-[#1C2C21] border-r border-gray-200 dark:border-gray-800 h-screen overflow-y-auto">
<!-- Header -->
<div class="p-6 border-b border-gray-200 dark:border-gray-800 sticky top-0 bg-white dark:bg-[#1C2C21] z-10">
<div class="flex flex-wrap justify-between gap-3">
<p class="text-[#0e1b12] dark:text-white text-3xl font-black leading-tight tracking-[-0.033em]">Meal Photo Review</p>
</div>
</div>
<!-- Filters -->
<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
<div class="flex h-10 w-full items-center justify-center rounded-lg bg-primary/10 dark:bg-primary/20 p-1">
<label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-md px-2 has-[:checked]:bg-white dark:has-[:checked]:bg-background-dark has-[:checked]:shadow-sm has-[:checked]:text-[#0e1b12] dark:has-[:checked]:text-white text-[#4e9767] dark:text-primary/80 text-sm font-medium leading-normal">
<span class="truncate">All</span>
<input class="invisible w-0" name="meal-filter" type="radio" value="All"/>
</label>
<label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-md px-2 has-[:checked]:bg-white dark:has-[:checked]:bg-background-dark has-[:checked]:shadow-sm has-[:checked]:text-[#0e1b12] dark:has-[:checked]:text-white text-[#4e9767] dark:text-primary/80 text-sm font-medium leading-normal">
<span class="truncate">Unreviewed</span>
<input checked="" class="invisible w-0" name="meal-filter" type="radio" value="Unreviewed"/>
</label>
<label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-md px-2 has-[:checked]:bg-white dark:has-[:checked]:bg-background-dark has-[:checked]:shadow-sm has-[:checked]:text-[#0e1b12] dark:has-[:checked]:text-white text-[#4e9767] dark:text-primary/80 text-sm font-medium leading-normal">
<span class="truncate">Recent</span>
<input class="invisible w-0" name="meal-filter" type="radio" value="Recent"/>
</label>
</div>
</div>
<!-- Meal List -->
<div class="flex flex-col divide-y divide-gray-200 dark:divide-gray-800">
<div class="flex items-center gap-4 bg-primary/10 dark:bg-primary/20 px-6 min-h-[72px] py-3 justify-between cursor-pointer">
<div class="flex items-center gap-4">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-14 flex-shrink-0" data-alt="Profile picture of Jane Doe" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBrsn_NnWgsnxHTkkPVqQwNvgx4mhmrLTQVNYrGkfSEyZc8IgX2glCc8-CXaa9YEjsXmG4gCczwrguyFkBRHVhn37MzKAZte8bfbFnbiFlrn22aJq0nYuRAWY1EeUcGy9EMWVM0_hm6-fyrR8ysqE3OXKYJKos8YEmhWvDjjKj25ZH4Xm7W8IMRtM-4Z4_uErN9zrQCDeumubUCNdo0SoO47UXwWgmMTG3fDArMG56fzxahjAUIiJU6Yw6J-nKIkUNaMFvN8uLYDWLR");'></div>
<div class="flex flex-col justify-center">
<p class="text-[#0e1b12] dark:text-white text-base font-medium leading-normal line-clamp-1">Jane Doe</p>
<p class="text-[#4e9767] dark:text-primary/80 text-sm font-normal leading-normal line-clamp-2">Breakfast - Oct 26, 9:00 AM</p>
</div>
</div>
<div class="shrink-0">
<div class="flex size-7 items-center justify-center"><div class="size-3 rounded-full bg-yellow-500 animate-pulse"></div></div>
</div>
</div>
<div class="flex items-center gap-4 bg-transparent hover:bg-gray-100 dark:hover:bg-gray-800/50 px-6 min-h-[72px] py-3 justify-between cursor-pointer">
<div class="flex items-center gap-4">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-14 flex-shrink-0" data-alt="Profile picture of John Smith" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAo9fKgH9Z_NmfI5xplTs2weKlqSQ25oaLL7HDW8xXeOfymMmMXc6lO5gVO4io_uZ8kwVrjDEx_gOnMF6Ji2q63cBmvrr-A7OUSFfjhjq16sBe0Tetvm_UxEpDplk0CTYUrGsezZ6XYaIQAgawu04KFm_fAD4zDp5G1FnMYb_36eZHP6lXG4CUaAduuybi48yIt93EBTHfnkG3bbH8UcBvR16ooQkaUAeBsuOnFG--9Okf-3yJ1ftXuKld-ktsxRR7n2hPcAA-8wkbk");'></div>
<div class="flex flex-col justify-center">
<p class="text-[#0e1b12] dark:text-white text-base font-medium leading-normal line-clamp-1">John Smith</p>
<p class="text-[#4e9767] dark:text-primary/80 text-sm font-normal leading-normal line-clamp-2">Lunch - Oct 26, 1:15 PM</p>
</div>
</div>
<div class="shrink-0">
<div class="flex size-7 items-center justify-center"><div class="size-3 rounded-full bg-yellow-500"></div></div>
</div>
</div>
<div class="flex items-center gap-4 bg-transparent hover:bg-gray-100 dark:hover:bg-gray-800/50 px-6 min-h-[72px] py-3 justify-between cursor-pointer">
<div class="flex items-center gap-4">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-14 flex-shrink-0" data-alt="Profile picture of Sarah Johnson" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDjCNZE9oFQRF1A5125fb45KfRREjHyMuyC5FFKfAqPgbpltA5_vXCX32Mm9FjzX5qUkxKwuCKO9pK_9cTWZrV2RR6MZB9ZgHrtL29qJ9YXb3siW0IQhOcK410Pth0ijAClKQdohAjXun45kTqPGsc4nAa5bCbbVHUcFJMnpv1eLNRj73Z34ndtDYzvDvq2RiUrtlW-nBu1fZTcvK5zQBKiYbdXWznN9dGlYuZmo5pOKbtdBLB23VNlofKS5DHNd8TqmrLDI0GdLfkW");'></div>
<div class="flex flex-col justify-center">
<p class="text-[#0e1b12] dark:text-white text-base font-medium leading-normal line-clamp-1">Sarah Johnson</p>
<p class="text-[#4e9767] dark:text-primary/80 text-sm font-normal leading-normal line-clamp-2">Dinner - Oct 25, 7:30 PM</p>
</div>
</div>
<div class="shrink-0">
<div class="flex size-7 items-center justify-center"><div class="size-3 rounded-full bg-yellow-500"></div></div>
</div>
</div>
<div class="flex items-center gap-4 bg-transparent hover:bg-gray-100 dark:hover:bg-gray-800/50 px-6 min-h-[72px] py-3 justify-between cursor-pointer">
<div class="flex items-center gap-4">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-14 w-14 flex-shrink-0" data-alt="Profile picture of Michael Brown" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBAXMbk4TW4T1z5b7fBr7eJwTt-_zs2LFptokHpQRHduZ4EXBgpdcUXTik_vCB4YxUoLz-Iao8q-SgJVbR2L0e3hw5L8hiZtvtybFq8GBd_SNpH5aN_frx6Hjy4SezEF1EspxPiGAcM1aQHx1vZQhYch3nz9s7Ja3AtTEdftWNjSqrmBAdi7-7P2Pue6hza5jgAjn3OHpJLv7_XxsNhp91YnwoHf3ShjZ-OJTUFX_eYEu2scMuGQNtovXIAylYqgCR164n-v7cOZTgH");'></div>
<div class="flex flex-col justify-center">
<p class="text-[#0e1b12] dark:text-white text-base font-medium leading-normal line-clamp-1">Michael Brown</p>
<p class="text-[#4e9767] dark:text-primary/80 text-sm font-normal leading-normal line-clamp-2">Breakfast - Oct 25, 8:45 AM</p>
</div>
</div>
<div class="shrink-0">
<div class="flex size-7 items-center justify-center"><div class="size-3 rounded-full bg-green-600"></div></div>
</div>
</div>
</div>
</div>
<!-- Right Column: Review Panel -->
<div class="flex flex-col p-8 h-screen overflow-y-auto bg-background-light dark:bg-background-dark">
<div class="flex flex-col gap-6">
<!-- Image -->
<div class="w-full aspect-4/3 bg-gray-200 dark:bg-gray-800 rounded-xl bg-cover bg-center" data-alt="A healthy breakfast of avocado toast with a poached egg" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDpO5N3sfiBC2qP8m-MkHR8o7dhm1o8jZkh455PdnvcPAf4Gp-FRxiqnjKYdc-YzThjYg916ECqcSqAqMOt8rRcCpdyBzyeYBf-tM7J9PhKTHH41v09141gLmgjXcRHdEgDkMoVLGeVbSD56VvUcynflVqK9TY-oOjXYrNcnQCQw_TxHCbH0wXBEfDn7o-XfOHzyvhwA0eWvgcIsA0VLeFKRH5Pjc3d-lFcqSSgc1P-tCfqO9EwzyQE6OJsFj1HQjzuMkFV4lNQz4mw");'></div>
<!-- Client Info -->
<div>
<p class="text-sm text-gray-500 dark:text-gray-400">Reviewing Jane Doe's Breakfast</p>
<h2 class="text-2xl font-bold text-gray-800 dark:text-white mt-1">Avocado Toast with Egg</h2>
</div>
<!-- Action Radio Group -->
<div class="space-y-2">
<p class="text-sm font-medium text-gray-700 dark:text-gray-300">Mark as:</p>
<div class="grid grid-cols-3 gap-3">
<label class="flex cursor-pointer items-center justify-center rounded-lg p-3 text-center border has-[:checked]:bg-primary/20 dark:has-[:checked]:bg-primary/30 has-[:checked]:border-primary dark:border-gray-700 dark:text-white">
<input class="sr-only" name="meal_status" type="radio" value="eaten"/>
<span class="text-sm font-medium">Eaten</span>
</label>
<label class="flex cursor-pointer items-center justify-center rounded-lg p-3 text-center border has-[:checked]:bg-primary/20 dark:has-[:checked]:bg-primary/30 has-[:checked]:border-primary dark:border-gray-700 dark:text-white">
<input class="sr-only" name="meal_status" type="radio" value="skipped"/>
<span class="text-sm font-medium">Skipped</span>
</label>
<label class="flex cursor-pointer items-center justify-center rounded-lg p-3 text-center border has-[:checked]:bg-primary/20 dark:has-[:checked]:bg-primary/30 has-[:checked]:border-primary dark:border-gray-700 dark:text-white">
<input class="sr-only" name="meal_status" type="radio" value="substituted"/>
<span class="text-sm font-medium">Substituted</span>
</label>
</div>
</div>
<!-- Feedback Text Area -->
<div class="space-y-2">
<label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="feedback">Feedback</label>
<textarea class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-[#1C2C21] text-gray-800 dark:text-white focus:ring-primary focus:border-primary placeholder-gray-400 dark:placeholder-gray-500" id="feedback" placeholder="Provide feedback or suggestions..." rows="5"></textarea>
</div>
<!-- Action Button -->
<button class="flex w-full min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-12 px-4 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-green-600">
<span>Mark as Reviewed &amp; Next</span>
<span class="material-symbols-outlined">arrow_forward</span>
</button>
</div>
</div>
</main>
</div>
</body></html>
</file>

<file path="Design/website/Design/team_dieticians/code.html">
<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Team Dieticians</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#17cf54",
                        "background-light": "#f6f8f6",
                        "background-dark": "#112116",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
<div class="relative flex min-h-screen w-full">
<!-- Side Navigation Bar -->
<aside class="flex w-64 flex-col border-r border-gray-200/50 dark:border-gray-700/50 bg-background-light dark:bg-background-dark p-4">
<div class="flex flex-col gap-4">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Profile picture of Dr. Evelyn Reed" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDvkuzl67-V7FqioCauKs4Wlz_2btTl6qJbp5oKHgLgwPCgw5VyTxPdJyq7m79QY372mb6zVF7XW7gAT_9wQV8UDZpF8dM8HtIq9lCkKng9yeunOvf7llDjp4TfmRCT_sbTshNNe-yPx6sOQ14eJQereepuI4QmaJxRcgWJa2djfQWVZ-tyheID6uRoCXxLnHENasQraGqZ0QALTa20T026a4tY4vrGoOrpz4l5RtfCwmq4cOoYRGmabC8B5TrW8RNbFDDYkRTvrsbP");'></div>
<div class="flex flex-col">
<h1 class="text-gray-900 dark:text-gray-100 text-base font-medium leading-normal">Dr. Evelyn Reed</h1>
<p class="text-primary/80 dark:text-primary/70 text-sm font-normal leading-normal">e.reed@nutriwell.com</p>
</div>
</div>
</div>
<nav class="flex flex-col gap-2 mt-8">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200/60 dark:hover:bg-gray-800/60" href="#">
<span class="material-symbols-outlined text-gray-800 dark:text-gray-200">dashboard</span>
<p class="text-sm font-medium leading-normal">Dashboard</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200/60 dark:hover:bg-gray-800/60" href="#">
<span class="material-symbols-outlined text-gray-800 dark:text-gray-200">groups</span>
<p class="text-sm font-medium leading-normal">My Clients</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30" href="#">
<span class="material-symbols-outlined text-gray-900 dark:text-gray-50" style="font-variation-settings: 'FILL' 1;">group</span>
<p class="text-gray-900 dark:text-gray-50 text-sm font-medium leading-normal">Team Dieticians</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200/60 dark:hover:bg-gray-800/60" href="#">
<span class="material-symbols-outlined text-gray-800 dark:text-gray-200">folder</span>
<p class="text-sm font-medium leading-normal">Resources</p>
</a>
</nav>
<div class="mt-auto flex flex-col gap-4">
<div class="flex flex-col gap-1">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200/60 dark:hover:bg-gray-800/60" href="#">
<span class="material-symbols-outlined text-gray-800 dark:text-gray-200">settings</span>
<p class="text-sm font-medium leading-normal">Settings</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200/60 dark:hover:bg-gray-800/60" href="#">
<span class="material-symbols-outlined text-gray-800 dark:text-gray-200">help</span>
<p class="text-sm font-medium leading-normal">Help</p>
</a>
</div>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-gray-900 text-sm font-bold leading-normal tracking-[0.015em]">
<span class="truncate">Log Out</span>
</button>
</div>
</aside>
<!-- Main Content -->
<main class="flex-1 p-8 overflow-y-auto">
<div class="max-w-7xl mx-auto">
<!-- Page Heading -->
<header class="flex flex-wrap justify-between items-center gap-4 mb-8">
<div class="flex flex-col gap-2">
<h1 class="text-gray-900 dark:text-gray-50 text-4xl font-black leading-tight tracking-[-0.033em]">Team Dieticians</h1>
<p class="text-gray-600 dark:text-gray-400 text-base font-normal leading-normal">Manage and collaborate with other dieticians in your organization.</p>
</div>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary/20 dark:bg-primary/30 text-gray-900 dark:text-gray-50 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/30 dark:hover:bg-primary/40">
<span class="truncate">Add New Dietician</span>
</button>
</header>
<!-- Search and Filter Section -->
<div class="mb-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<!-- Search Bar -->
<div class="md:col-span-3">
<label class="flex flex-col min-w-40 h-12 w-full">
<div class="flex w-full flex-1 items-stretch rounded-lg h-full">
<div class="text-gray-600 dark:text-gray-400 flex border-none bg-gray-200/60 dark:bg-gray-800/60 items-center justify-center pl-4 rounded-l-lg border-r-0">
<span class="material-symbols-outlined">search</span>
</div>
<input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-gray-100 focus:outline-0 focus:ring-2 focus:ring-primary/50 border-none bg-gray-200/60 dark:bg-gray-800/60 h-full placeholder:text-gray-500 dark:placeholder:text-gray-400 px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" placeholder="Search by name or email..." value=""/>
</div>
</label>
</div>
<!-- Filter Chips -->
<div class="md:col-span-3 flex gap-3 overflow-x-auto pb-2">
<button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-gray-200/60 dark:bg-gray-800/60 pl-4 pr-2 hover:bg-gray-300/60 dark:hover:bg-gray-700/60">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Specialty</p>
<span class="material-symbols-outlined text-gray-800 dark:text-gray-200 text-base">expand_more</span>
</button>
<button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-gray-200/60 dark:bg-gray-800/60 pl-4 pr-2 hover:bg-gray-300/60 dark:hover:bg-gray-700/60">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Status</p>
<span class="material-symbols-outlined text-gray-800 dark:text-gray-200 text-base">expand_more</span>
</button>
<button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-gray-200/60 dark:bg-gray-800/60 pl-4 pr-2 hover:bg-gray-300/60 dark:hover:bg-gray-700/60">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Location</p>
<span class="material-symbols-outlined text-gray-800 dark:text-gray-200 text-base">expand_more</span>
</button>
<button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-gray-200/60 dark:bg-gray-800/60 pl-4 pr-2 hover:bg-gray-300/60 dark:hover:bg-gray-700/60">
<p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">More Filters</p>
<span class="material-symbols-outlined text-gray-800 dark:text-gray-200 text-base">expand_more</span>
</button>
</div>
</div>
</div>
<!-- Dieticians Table -->
<div class="overflow-x-auto bg-background-light dark:bg-background-dark">
<div class="flex overflow-hidden rounded-lg border border-gray-200/50 dark:border-gray-700/50">
<table class="w-full text-left">
<thead class="bg-gray-100/50 dark:bg-gray-900/50">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Name</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Client Load</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Contact</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-200/50 dark:divide-gray-700/50">
<tr class="hover:bg-gray-100/50 dark:hover:bg-gray-800/50">
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center">
<div class="flex-shrink-0 h-10 w-10">
<img class="h-10 w-10 rounded-full" data-alt="Profile picture of Dr. Alisha Grant" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDze53LkHF-SEL9QSQeFA8a5LdR55qW5VracK3RkXkLiVqZZmhFUPWBjO2anWaJXRYcEI4kMGZbgLzTbgRqXD17ofkPh4NsPHF6w-n8_QzoGFkB8w8C_qJ8cJukkZeD0JcIFWIVJ3zPpRCPOKoOYSJgVIXV4L1mYPfo_uALoDULFTrAhjZtHGq8pCBR-kx-DyuZ70y4zx7wqs8002sRJOSBO62IPHSiEOTcPXAtagEg5LdVo6YU5AAyZ03akzaTZdlLmEPeu-askG4V"/>
</div>
<div class="ml-4">
<div class="text-sm font-medium text-gray-900 dark:text-gray-100">Dr. Alisha Grant</div>
<div class="text-sm text-gray-500 dark:text-gray-400">Sports Nutrition</div>
</div>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center gap-3">
<div class="w-24 overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700"><div class="h-2 rounded-full bg-primary" style="width: 85%;"></div></div>
<p class="text-gray-900 dark:text-gray-100 text-sm font-medium leading-normal">75 / 90</p>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/20 text-primary-800 dark:bg-primary/30 dark:text-primary-200">
<span class="w-2 h-2 mr-1.5 bg-primary rounded-full"></span> Active
                                        </span>
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">a.grant@nutriwell.com</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<a class="text-primary hover:text-primary/80 dark:text-primary-400 dark:hover:text-primary-300" href="#">View Profile</a>
</td>
</tr>
<tr class="hover:bg-gray-100/50 dark:hover:bg-gray-800/50">
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center">
<div class="flex-shrink-0 h-10 w-10">
<img class="h-10 w-10 rounded-full" data-alt="Profile picture of Dr. Ben Carter" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDjK9YGdAzmMtoVqCx-0B6APQ32vMB1pjk_VXdGI4kmFo96M3Zafn2GFrnHkckQn8zzlauYvFJuhrsTw-OehyFngWmTp7Tw2zzjXyCt-dzBQXLJ4oB7vjp5Fs8-yrmcWH2hv_a2mMMo8oKtLQdzaFs5uMLQ_-L6W5CEiCZHF5VMb3sND84cLmpxsqfiIoWOAiDPceYMJ26CksiO37r9LPpcDHrs1IHKeKmxwcAtgVlWdO1smEICPtQY4f_M1HbVu8OulyqJqYjqNdgr"/>
</div>
<div class="ml-4">
<div class="text-sm font-medium text-gray-900 dark:text-gray-100">Dr. Ben Carter</div>
<div class="text-sm text-gray-500 dark:text-gray-400">Pediatric Nutrition</div>
</div>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center gap-3">
<div class="w-24 overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700"><div class="h-2 rounded-full bg-primary" style="width: 100%;"></div></div>
<p class="text-gray-900 dark:text-gray-100 text-sm font-medium leading-normal">95 / 95</p>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/20 text-primary-800 dark:bg-primary/30 dark:text-primary-200">
<span class="w-2 h-2 mr-1.5 bg-primary rounded-full"></span> Active
                                        </span>
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">b.carter@nutriwell.com</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<a class="text-primary hover:text-primary/80 dark:text-primary-400 dark:hover:text-primary-300" href="#">View Profile</a>
</td>
</tr>
<tr class="hover:bg-gray-100/50 dark:hover:bg-gray-800/50">
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center">
<div class="flex-shrink-0 h-10 w-10">
<img class="h-10 w-10 rounded-full" data-alt="Profile picture of Dr. Chloe Davis" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCXIxd6Dl9w36AZdbANOHqGut5Em0VjPxUiJV5CmGJlHux2qlKwbtZeVvjYUR_Xk7JisbcrD7cwG6BUbN5M63xK-50JBf9IZK57uizxz3FuAhtxP0akIDX5gjnO0a6B0pWsSPnMkx2UmP-xp91n190mOauZyCvR4vH6ImU0r1Dp38-m-As0fTau9OThrgGaH-nhhBM8LuGNFPharnTaw4ZuQlqmAgFhc-G_7-Ynhky3-LCf73OavvY-grKcCFLXiPY1nI_U-GuuEVZX"/>
</div>
<div class="ml-4">
<div class="text-sm font-medium text-gray-900 dark:text-gray-100">Dr. Chloe Davis</div>
<div class="text-sm text-gray-500 dark:text-gray-400">Clinical Nutrition</div>
</div>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center gap-3">
<div class="w-24 overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700"><div class="h-2 rounded-full bg-primary" style="width: 45%;"></div></div>
<p class="text-gray-900 dark:text-gray-100 text-sm font-medium leading-normal">40 / 90</p>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/20 text-primary-800 dark:bg-primary/30 dark:text-primary-200">
<span class="w-2 h-2 mr-1.5 bg-primary rounded-full"></span> Active
                                        </span>
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">c.davis@nutriwell.com</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<a class="text-primary hover:text-primary/80 dark:text-primary-400 dark:hover:text-primary-300" href="#">View Profile</a>
</td>
</tr>
<tr class="hover:bg-gray-100/50 dark:hover:bg-gray-800/50">
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center">
<div class="flex-shrink-0 h-10 w-10">
<img class="h-10 w-10 rounded-full" data-alt="Profile picture of Dr. David Evans" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDG9scHKbt2RVSRNFetEUcqyMCyU-isCO8v3MDK8YKFBVNPzfgRhTqRbGBKn-c7ngK8n70HUjWhHBJuWFsgVbNG_vm0Z5_Qiau-1Kgq80TQ8LtJqrJfVHXPuAgMVMR0nTkUAMRWGXh0EKpNTuloZEvNa7ut8_wp2LzXJBxTV7CbjyM3GHGRAUS_f66yL2RQynNGKOLCtQKWoGzJl_yomZ2M3VRuDxVubyJSpD1S51yJgEYCr8A240WTzs9umXyTI8s9iiw2GrR2p7Au"/>
</div>
<div class="ml-4">
<div class="text-sm font-medium text-gray-900 dark:text-gray-100">Dr. David Evans</div>
<div class="text-sm text-gray-500 dark:text-gray-400">Geriatric Nutrition</div>
</div>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
<div class="flex items-center gap-3">
<div class="w-24 overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700"><div class="h-2 rounded-full bg-yellow-500" style="width: 100%;"></div></div>
<p class="text-gray-900 dark:text-gray-100 text-sm font-medium leading-normal">100 / 100</p>
</div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
<span class="w-2 h-2 mr-1.5 bg-gray-500 rounded-full"></span> Inactive
                                        </span>
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">d.evans@nutriwell.com</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<a class="text-primary hover:text-primary/80 dark:text-primary-400 dark:hover:text-primary-300" href="#">View Profile</a>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</main>
</div>
</body></html>
</file>

<file path="doc/00-overview.md">
# DietKaro - Complete Implementation Roadmap

**Generated:** February 7, 2026
**Overall Score:** 6/10 - Functional Foundation, Needs Completion
**Total Estimated Effort:** ~40 days for fully launch-ready MVP

---

## Module Index

### Architecture & Quality (Modules 01-04, 08)

| # | Module | Priority | Effort | Score | Focus |
|---|--------|----------|--------|-------|-------|
| [01](01-backend-architecture.md) | Backend Architecture | P0 | 5-6 days | 5/10 | Extract service layer, fix fat controllers, DRY violations |
| [02](02-frontend-dashboard.md) | Frontend Dashboard Refactor | P1 | 3-4 days | 6/10 | Refactor 830-line page, extract components, remove dead code |
| [03](03-mobile-app.md) | Mobile App Quality | P1 | 3-4 days | 7/10 | Type safety, error handling, shared theme, reusable components |
| [04](04-database-schema.md) | Database Schema | P1 | 1-2 days | 9/10 | Soft deletes, compound indexes, missing models |
| [08](08-code-quality-testing.md) | Code Quality & Testing | P2 | 3-5 days | 3/10 | Tests (0% coverage), config extraction, TypeScript strictness |

### Core Feature Completion (Modules 05-07)

| # | Module | Priority | Effort | Score | Focus |
|---|--------|----------|--------|-------|-------|
| [05](05-food-validation-engine.md) | Food Validation Engine | P0 | 2-3 days | 7/10 | Complete missing rules (#7, #8), make configurable |
| [06](06-compliance-service.md) | Compliance Service | P0 | 2-3 days | 4/10 | Complete scoring, auto-triggers, API endpoints |
| [07](07-onboarding-flow.md) | Onboarding Flow | P0 | 2-3 days | 6/10 | Create Step 6, verify all steps save correctly |

### Feature Completion for Launch (Modules 09-12)

| # | Module | Priority | Effort | Score | Focus |
|---|--------|----------|--------|-------|-------|
| [09](09-notifications-push.md) | Notifications & Push | P1 | 3 days | 30% | Real push via Expo SDK, triggers, mobile integration |
| [10](10-session-notes-invoicing.md) | Session Notes, Invoicing, Activity Log | P2 | 4-5 days | 0% | CRUD for notes, invoices with PDF, audit trail |
| [11](11-mobile-screens-completion.md) | Mobile Screens Completion | P1 | 3-4 days | 65% | Notifications, progress chart, profile, offline |
| [12](12-dashboard-pages-completion.md) | Dashboard Pages & Deployment | P2 | 4-5 days | 65% | Analytics, settings, client detail tabs, Docker |

---

## Priority Execution Order

### Phase 1: P0 Critical (Weeks 1-2) - Architecture + Core Features

These block the MVP and must be done first:

```
Week 1:
  Day 1-3: Module 01 - Backend service layer extraction (unblocks everything)
  Day 3-5: Module 05 - Complete validation engine rules

Week 2:
  Day 1-2: Module 06 - Compliance service completion
  Day 3-4: Module 07 - Onboarding flow (Step 6 + verification)
  Day 5:   Module 04 - Database schema fixes (soft deletes, indexes)
```

### Phase 2: P1 Important (Weeks 3-4) - Quality + Engagement Features

```
Week 3:
  Day 1-2: Module 02 - Frontend refactoring (830-line page split)
  Day 3-4: Module 03 - Mobile app quality (types, errors, theme)
  Day 5:   Module 09 - Notifications push integration (Expo SDK)

Week 4:
  Day 1-2: Module 09 - Notification triggers + mobile screen
  Day 3-5: Module 11 - Mobile screens completion (progress, profile, notifications)
```

### Phase 3: P2 Completeness (Weeks 5-6) - Professional Tools + Deploy

```
Week 5:
  Day 1-3: Module 10 - Session notes + invoicing
  Day 4-5: Module 12 - Analytics page + settings page

Week 6:
  Day 1-2: Module 12 - Client detail tabs + share/export + deployment
  Day 3-5: Module 08 - Testing, config extraction, linting
```

---

## Cross-Module Dependencies

```
Module 01 (Backend Services)
  ├── unblocks ──> Module 06 (Compliance auto-triggers)
  ├── unblocks ──> Module 05 (Validation in service layer)
  ├── unblocks ──> Module 10 (Session notes + invoice services)
  └── unblocks ──> Module 08 (Testable service layer)

Module 04 (Schema: ClientPreferences)
  └── required by ──> Module 07 (Onboarding Step 5)

Module 03 (Mobile Theme)
  ├── should do before ──> Module 07 (Onboarding screens)
  └── should do before ──> Module 11 (Mobile screens completion)

Module 06 (Compliance Service)
  └── provides data for ──> Module 11 (Progress screen adherence)

Module 09 (Notifications Backend)
  └── required by ──> Module 11 (Mobile notifications screen)

Module 10 (Session Notes + Invoicing)
  └── wired into ──> Module 12 (Client detail tabs, invoice page)
```

---

## SOLID Principles Summary

| Principle | Current State | Modules That Fix It |
|-----------|--------------|-------------------|
| **S** - Single Responsibility | VIOLATED - Fat controllers, monolith page | 01, 02 |
| **O** - Open/Closed | VIOLATED - Hardcoded business rules | 05, 06, 08 |
| **L** - Liskov Substitution | OK | - |
| **I** - Interface Segregation | MINOR - No service interfaces | 01 |
| **D** - Dependency Inversion | VIOLATED - Direct Prisma in controllers | 01 |

## DRY Violations Summary

| Violation | Where | Module That Fixes It |
|-----------|-------|---------------------|
| Nutrition calculation code | 3 controllers | 01 (shared utility) |
| Date filtering patterns | 5 controllers | 01 (query filter builder) |
| Org ID verification | 16 controllers | 01 (service layer) |
| `getInitials()` helper | 3 frontend pages | 02 (shared formatters) |
| `formatTimeAgo()` helper | 2 frontend pages | 02 (shared formatters) |
| Color/theme constants | 17 mobile screens | 03 (shared theme) |
| Card shadow styles | 4+ mobile components | 03 (Card component) |

---

## Feature Coverage Matrix

After completing all 12 modules, here's what's covered:

### PRD Features

| Feature | Module | Status After |
|---------|--------|-------------|
| Auth (Clerk + OTP) | Existing | Done |
| Client CRUD | 01 (service extraction) | Done |
| Diet Plan Builder | 02 (refactor) | Done |
| Food Validation | 05 | Done |
| Meal Logging | 01, 11 | Done |
| Meal Photo Review | Existing (reviews page 95%) | Done |
| Weight Tracking | 11 (chart), Existing | Done |
| Compliance/Adherence | 06 | Done |
| Push Notifications | 09 | Done |
| Session Notes (SOAP) | 10 | Done |
| Invoicing | 10 | Done |
| Activity Audit Log | 10 | Done |
| Analytics Dashboard | 12 | Done |
| PDF Reports/Export | 12 (share buttons) | Done |
| Email Integration | 09 (email fallback) | Done |
| Referral System | Existing (90%) | Done |
| Team Management | Existing (85%) | Done |
| Client Onboarding | 07 | Done |
| Deployment (Docker) | 12 | Done |

### NOT Covered (P3 / Post-MVP)

| Feature | Reason |
|---------|--------|
| AI Food Recognition | Post-MVP, different branch |
| AI/RAG Medical Extraction | Post-MVP, 3+ days |
| Redis Caching | Optimization, not MVP |
| Grocery List Generation | PRD Phase 2 |
| Video Consultations | PRD Phase 2 |
| Wearable Integration | PRD Phase 2 |
| Multi-language Support | PRD Phase 2 |
| Advanced Reporting | PRD Phase 2 |
| Expand Food Database (200+ items) | Content task, not dev |

---

## Quick Reference: Key Files to Modify

### Backend (most changes)
- `backend/src/controllers/*.ts` - All 16 controllers need slimming
- `backend/src/services/` - 6+ new services to create
- `backend/src/utils/` - 3 new utilities (nutrition, filters, response)
- `backend/src/config/` - New directory for extracted configuration
- `backend/src/jobs/` - New directory for scheduled jobs (meal reminders)
- `backend/prisma/schema.prisma` - Schema updates

### Frontend
- `frontend/src/app/dashboard/diet-plans/new/page.tsx` - Split into components
- `frontend/src/app/dashboard/analytics/page.tsx` - Real data integration
- `frontend/src/app/dashboard/settings/page.tsx` - Complete all sections
- `frontend/src/app/dashboard/clients/[id]/page.tsx` - Tab navigation
- `frontend/src/components/diet-plan/` - 6+ new components
- `frontend/src/lib/hooks/` - 5+ new hooks
- `frontend/src/lib/utils/formatters.ts` - New shared utilities
- `frontend/src/lib/api/client.ts` - Delete (dead code)

### Mobile App
- `client-app/constants/theme.ts` - Expand with full theme
- `client-app/services/api.ts` - Fix response types
- `client-app/types/index.ts` - Add missing types
- `client-app/app/(tabs)/notifications/index.tsx` - Replace mock data
- `client-app/app/(tabs)/progress/index.tsx` - Real chart
- `client-app/app/(tabs)/profile/index.tsx` - Fix hardcoded values
- `client-app/app/(onboarding)/step6.tsx` - New screen
- `client-app/hooks/useNotifications.ts` - New hook
- `client-app/components/` - 5+ new reusable components

### Deployment
- `docker-compose.yml` - New
- `backend/Dockerfile` - New
- `frontend/Dockerfile` - New
- `nginx/nginx.conf` - New
- `.env.example` - Complete variable documentation

---

## Effort Summary

| Phase | Modules | Days | Cumulative |
|-------|---------|------|------------|
| Phase 1 (P0) | 01, 04, 05, 06, 07 | ~12 days | 12 days |
| Phase 2 (P1) | 02, 03, 09, 11 | ~13 days | 25 days |
| Phase 3 (P2) | 08, 10, 12 | ~14 days | 39 days |
| **Total** | **12 modules** | **~39 days** | |

After all 12 modules: the app covers every PRD MVP feature, has clean architecture, and is deployment-ready.
</file>

<file path="doc/01-backend-architecture.md">
# Module 1: Backend Architecture Refactoring

**Priority:** P0
**Effort:** 5-6 days
**Impact:** Fixes SRP, DRY, testability across the entire backend

---

## Current State

The backend follows an MVC-ish pattern where **all 16 controllers call Prisma directly**, bypassing any service abstraction. Only 6 services exist (compliance, foodTagging, notification, onboarding, storage, validationEngine), leaving the core CRUD domains without a service layer.

```
Current:  Routes -> Controllers -> Prisma (direct)
                        |
                    Services (partial, only for complex logic)

Target:   Routes -> Controllers -> Services -> Prisma
```

---

## What Needs To Be Done

### 1. Extract Service Layer for Core Domains

Each service should own all Prisma calls and business logic for its domain. Controllers should only handle request parsing, calling the service, and formatting the response.

#### 1.1 Create `ClientService` (`backend/src/services/client.service.ts`)

**Extract from:** `client.controller.ts` (328 lines)

| Method | Logic to extract | Source lines |
|--------|-----------------|--------------|
| `createClient(data, orgId, userId)` | Client creation + referral code generation | controller lines 43-137 |
| `generateUniqueReferralCode()` | Referral code loop with uniqueness check | controller lines 13-41 |
| `getClients(orgId, filters)` | List with pagination, search, status filter | controller list handler |
| `getClientById(clientId, orgId)` | Single client fetch with relations | controller get handler |
| `updateClient(clientId, data, orgId)` | Partial update | controller update handler |
| `deleteClient(clientId, orgId)` | Soft delete | controller delete handler |
| `getClientProgress(clientId, orgId)` | Weight trend + meal adherence calculation | controller lines 248-327 |
| `processReferralBenefit(referrerId)` | Referral count tracking and benefit tier logic | controller lines 102-128 |

**Key rule:** The referral benefit tier (`Math.floor(count / 3)`) should become a configurable constant, not hardcoded.

#### 1.2 Create `DietPlanService` (`backend/src/services/dietPlan.service.ts`)

**Extract from:** `dietPlan.controller.ts` (268 lines)

| Method | Logic to extract |
|--------|-----------------|
| `createPlan(data, orgId, userId)` | Nested meal + food item creation in transaction |
| `getPlan(planId, orgId)` | Fetch with nested meals/foods/nutrition |
| `updatePlan(planId, data, orgId)` | Metadata update |
| `publishPlan(planId, orgId)` | Status change + meal log generation |
| `assignTemplateToClient(planId, clientId, orgId)` | Template cloning with nested object mapping (lines 189-267) |
| `deletePlan(planId, orgId)` | Soft delete |

#### 1.3 Create `MealLogService` (`backend/src/services/mealLog.service.ts`)

**Extract from:** `mealLog.controller.ts` (319 lines)

| Method | Logic to extract |
|--------|-----------------|
| `getMealLogs(filters, orgId)` | List with date/status filtering |
| `getMealLog(mealLogId, orgId)` | Single log with nutrition calculation (lines 124-143) |
| `updateMealLog(mealLogId, data)` | Status update + compliance trigger |
| `reviewMealLog(mealLogId, feedback, userId)` | Dietitian review + notification |
| `calculateNutrition(mealLog)` | Nutrition math currently inline |

#### 1.4 Create `WeightLogService` (`backend/src/services/weightLog.service.ts`)

**Extract from:** `weightLog.controller.ts`

| Method | Logic to extract |
|--------|-----------------|
| `createWeightLog(data, clientId, orgId)` | BMI calculation, weight change from previous, outlier detection |
| `getWeightLogs(clientId, dateRange)` | List with trend data |
| `getWeightStats(clientId)` | Aggregated statistics |

#### 1.5 Create `FoodItemService` (`backend/src/services/foodItem.service.ts`)

**Extract from:** `foodItem.controller.ts` (620 lines)

| Method | Logic to extract |
|--------|-----------------|
| `searchFoodItems(query, orgId, filters)` | Search with org-scoped + global foods |
| `createFoodItem(data, orgId, userId)` | Creation + auto-tagging trigger |
| `updateFoodItem(foodId, data, orgId)` | Update + re-tag |
| `calculateScaledNutrition(food, quantityG)` | Nutrition scaling math (duplicated in 3 places) |

#### 1.6 Create `MealService` (`backend/src/services/meal.service.ts`)

**Extract from:** `meal.controller.ts` (94 lines)

| Method | Logic to extract |
|--------|-----------------|
| `addFoodToMeal(mealId, foodId, quantity)` | Food item addition with nutrition calc |
| `updateMeal(mealId, data)` | Meal metadata update |
| `removeFoodFromMeal(mealId, foodItemId)` | Deletion |

---

### 2. Create Shared Utilities

#### 2.1 Nutrition Calculator (`backend/src/utils/nutritionCalculator.ts`)

Currently duplicated in 3+ controllers:

```typescript
// Extract this repeated pattern:
export function scaleNutrition(food: FoodItem, quantityG: number) {
  const multiplier = quantityG / (food.servingSizeG || 100);
  return {
    calories: Math.round((food.calories || 0) * multiplier),
    proteinG: Math.round(((food.proteinG || 0) * multiplier) * 10) / 10,
    carbsG: Math.round(((food.carbsG || 0) * multiplier) * 10) / 10,
    fatsG: Math.round(((food.fatsG || 0) * multiplier) * 10) / 10,
    fiberG: Math.round(((food.fiberG || 0) * multiplier) * 10) / 10,
  };
}
```

#### 2.2 Query Filter Builder (`backend/src/utils/queryFilters.ts`)

Currently duplicated in 5+ controllers:

```typescript
// Extract repeated date/status/search filtering:
export function buildDateFilter(dateFrom?: string, dateTo?: string) { ... }
export function buildPaginationParams(page?: string, pageSize?: string) { ... }
export function buildSearchFilter(search?: string, fields: string[]) { ... }
```

#### 2.3 Response Helpers (`backend/src/utils/responseHelpers.ts`)

```typescript
// Standardize pagination meta across all list endpoints:
export function paginatedResponse<T>(data: T[], total: number, page: number, pageSize: number) { ... }
```

---

### 3. Standardize Service Export Pattern

Currently inconsistent:
- Some export singletons: `export const complianceService = new ComplianceService()`
- Some export objects: `export const StorageService = { ... }`
- Some export classes with no instantiation

**Standard to follow:**
```typescript
// All services: export class + singleton instance
export class ClientService {
  async createClient(...) { ... }
}
export const clientService = new ClientService();
```

---

### 4. Extract Test Routes from `app.ts`

Lines 74-187 of `app.ts` contain test-only routes with inline Prisma calls and controller imports. Move to:
- `backend/src/routes/test.routes.ts` (gated by `NODE_ENV !== 'production'`)

---

### 5. Add Missing Middleware

| Middleware | Purpose | File |
|-----------|---------|------|
| Request ID | Correlation ID for log tracing | `middleware/requestId.middleware.ts` |
| Rate Limiting | Protect against abuse | `middleware/rateLimit.middleware.ts` |
| Request Timeout | Prevent hanging requests | `middleware/timeout.middleware.ts` |

---

### 6. Standardize Validation Schema Usage

Currently some routes apply Zod validation, others accept raw `req.body`. Ensure every POST/PATCH route uses the `validate()` middleware from `validation.middleware.ts`.

**Audit needed:** Check each route file for missing `validate(schema)` calls.

---

## Definition of Done

- [ ] All 6 new services created with extracted logic
- [ ] Controllers reduced to <80 lines each (request parsing + service call + response)
- [ ] Zero direct Prisma imports in controllers
- [ ] Shared utilities created (nutrition, filters, response)
- [ ] Consistent service export pattern
- [ ] Test routes extracted from app.ts
- [ ] All routes use Zod validation middleware
- [ ] Existing functionality unchanged (no regressions)
</file>

<file path="doc/02-frontend-dashboard.md">
# Module 2: Frontend Dashboard Refactoring

**Priority:** P1
**Effort:** 3-4 days
**Impact:** Maintainability, component reusability, developer velocity

---

## Current State

The Next.js 14 dashboard has good foundational patterns (React Query hooks, Clerk auth, Modal component) but suffers from one monolithic page component, dead code, duplicated helpers, and missing error boundaries.

---

## What Needs To Be Done

### 1. Refactor `diet-plans/new/page.tsx` (830 lines -> ~250 + components)

**File:** `frontend/src/app/dashboard/diet-plans/new/page.tsx`

This is the single biggest maintainability problem in the frontend. It handles 7 concerns in one file.

#### 1.1 Extract `useMealBuilder` Hook

**Create:** `frontend/src/lib/hooks/use-meal-builder.ts`

Move all state and handlers (~300 lines) from the page:
- `weeklyMeals` state and setters
- `selectedDay` state
- `activeMealId`, `showAddFoodModal` state
- `handleAddFood()`, `handleRemoveFood()`, `handleUpdateQuantity()`
- `handleApplyTemplate()` (82 lines alone)
- `handleSave()` / `handlePublish()` (59 lines)
- Nutrition calculation logic

The hook should return:
```typescript
{
  weeklyMeals, selectedDay, setSelectedDay,
  activeMealId, setActiveMealId,
  addFood, removeFood, updateFoodQuantity,
  applyTemplate, isApplyingTemplate,
  save, publish, isSaving,
  dailyNutrition, // computed from weeklyMeals
}
```

#### 1.2 Extract Components

| Component | Source Lines | New File |
|-----------|-------------|----------|
| `<ClientSelector />` | 114-174 | `components/diet-plan/client-selector.tsx` |
| `<DayNavigator />` | 617-658 | `components/diet-plan/day-navigator.tsx` |
| `<MealEditor />` | 660-756 | `components/diet-plan/meal-editor.tsx` |
| `<NutritionSummary />` | 777-806 | `components/diet-plan/nutrition-summary.tsx` |
| `<TemplateSidebar />` | 579-611 | `components/diet-plan/template-sidebar.tsx` |
| `<ClientInfoCard />` | 548-561 | `components/diet-plan/client-info-card.tsx` |

After extraction, `diet-plans/new/page.tsx` should be ~200-250 lines: layout grid + component composition.

---

### 2. Remove Dead Code

#### 2.1 Delete `frontend/src/lib/api/client.ts`

This file creates a static axios instance that is **never used**. The actual API client is the hook-based one in `use-api-client.ts`. This file is misleading and confusing.

#### 2.2 Remove Unused `isPublicRoute` in `middleware.ts`

`isPublicRoute` is defined on line 4 but never referenced. Either use it or remove it.

---

### 3. Extract Shared Helper Functions

**Create:** `frontend/src/lib/utils/formatters.ts`

These functions are duplicated across 3+ pages:

```typescript
// Currently duplicated in: clients/page.tsx, clients/[id]/page.tsx, diet-plans/new/page.tsx
export function getInitials(name: string): string { ... }

// Currently duplicated in: dashboard/page.tsx, clients/page.tsx (as formatLastActivity)
export function formatTimeAgo(date: Date | string): string { ... }

// Currently in: clients/[id]/page.tsx only, but reusable
export function calculateAge(dob: string): number | null { ... }
```

Then update all pages to import from `@/lib/utils/formatters`.

---

### 4. Add Global Error Boundary

**Create:** `frontend/src/components/error-boundary.tsx`

Currently no React error boundary exists. If any component throws during render, the entire app crashes with no recovery.

```
Where to add:
- frontend/src/app/layout.tsx (wrap children)
- OR frontend/src/app/dashboard/layout.tsx (wrap dashboard)
```

The error boundary should:
- Catch render errors
- Show a user-friendly fallback UI
- Provide a "Try Again" button that resets the error state
- Log errors for debugging

---

### 5. Fix Hook Inconsistencies

#### 5.1 Type Confusion in `use-diet-plans.ts`

The hook has a `name` vs `title` confusion (acknowledged in a comment on line 31-32). The `CreateDietPlanInput` requires manual `name -> title` mapping in the mutation. Standardize to one field name across the API and frontend.

#### 5.2 Unused `queryClient` in `use-team.ts`

The `useTeam` hook doesn't use `queryClient` for mutations (inconsistent with all other hooks). Add cache invalidation on team mutations.

#### 5.3 Ephemeral Validation Cache in `use-validation.ts`

Validation results are stored in `useState` which resets on component remount. Consider:
- Using React Query's cache instead
- Or persisting to `sessionStorage`

Also add a cache size limit to prevent unbounded growth.

---

### 6. Create Hook Factory Pattern (Optional, P2)

All 8 hooks follow the same structure. A factory would reduce boilerplate:

**Create:** `frontend/src/lib/hooks/use-resource.ts`

```typescript
// Generic factory for list + CRUD hooks
export function useListResource<T>(resourceKey: string, endpoint: string, options?) { ... }
export function useMutateResource<T>(resourceKey: string, endpoint: string) { ... }
```

This would cut ~40% of code from each hook file.

---

### 7. Enhance Middleware

**File:** `frontend/src/middleware.ts`

Current middleware only calls `auth.protect()` which throws an error. It should redirect unauthenticated users:

```typescript
// Add redirect to sign-in instead of throwing
if (isProtectedRoute(request)) {
  const { userId } = await auth();
  if (!userId) {
    return NextResponse.redirect(new URL('/sign-in', request.url));
  }
}
```

---

### 8. Component Extraction for Client Detail Page

**File:** `frontend/src/app/dashboard/clients/[id]/page.tsx` (279 lines)

- Tab navigation buttons exist (lines 184-196) but no state/switching logic is implemented
- Extract tab content into separate components when implementing

---

## Definition of Done

- [ ] `diet-plans/new/page.tsx` reduced to ~250 lines with extracted components + hook
- [ ] 6 new components in `components/diet-plan/`
- [ ] `useMealBuilder` hook created
- [ ] Dead `lib/api/client.ts` removed
- [ ] Shared formatters extracted to `lib/utils/formatters.ts`
- [ ] All pages import from shared formatters (no duplicated helpers)
- [ ] Global error boundary added
- [ ] Hook type inconsistencies fixed
- [ ] Middleware redirect logic added
- [ ] Unused `isPublicRoute` removed or used
</file>

<file path="doc/03-mobile-app.md">
# Module 3: Mobile App (Client App) Improvements

**Priority:** P1
**Effort:** 3-4 days
**Impact:** User experience, stability, type safety

---

## Current State

The React Native (Expo) client app has good UX patterns (OTP auto-focus, weight charts, clean meal cards) but lacks proper error handling, type safety on API responses, shared theming, and has incomplete screens.

---

## What Needs To Be Done

### 1. Create Shared Theme System

**Problem:** Color constants, spacing, shadows, and card styles are duplicated in **17 files** with inline `StyleSheet.create()`.

**Create:** `client-app/constants/theme.ts` (expand existing file)

```
Current theme.ts likely has basic colors.
Needs to include:
- colors (primary, secondary, background, text, error, success, warning)
- spacing (xs, sm, md, lg, xl)
- borderRadius values
- shadow presets (cardShadow, modalShadow)
- typography (fontSize, fontWeight, lineHeight presets)
```

Then update all 17 screen files to import from theme instead of redefining colors inline.

**Files to update:**
- `app/(auth)/login.tsx`
- `app/(auth)/verify.tsx`
- `app/(onboarding)/step1.tsx` through `complete.tsx`
- `app/(tabs)/home/index.tsx`
- `app/(tabs)/weight/index.tsx`
- `app/(tabs)/progress/index.tsx`
- `app/(tabs)/profile/index.tsx`
- `app/(tabs)/notifications/index.tsx`

---

### 2. Fix API Response Type Safety

**Problem:** API responses use `unknown` type, losing all type safety.

**File:** `client-app/services/api.ts`

#### 2.1 Create Typed Response Wrapper

**Create:** `client-app/types/api.ts`

```typescript
interface ApiResponse<T> {
  success: boolean;
  data: T;
  error?: { code: string; message: string; };
  meta?: { page: number; pageSize: number; total: number; };
}
```

#### 2.2 Update All API Methods

Replace every `api.post<{ success: boolean; data: unknown }>` with the specific typed response.

**Methods to update in `services/api.ts`:**

| Method | Current Return | Should Return |
|--------|---------------|---------------|
| `requestOTP()` | `unknown` | `{ message: string; sessionToken: string }` |
| `verifyOTP()` | `unknown` | `{ accessToken: string; client: Client }` |
| `getTodayMeals()` | `unknown` | `MealLog[]` |
| `getMealDetail()` | `unknown` | `MealLog` |
| `logMeal()` | `unknown` | `MealLog` |
| `uploadPhoto()` | `unknown` | `{ photoUrl: string }` |
| `getWeightLogs()` | `unknown` | `WeightLog[]` |
| `createWeightLog()` | `unknown` | `WeightLog` |
| `getStats()` | `unknown` | `ClientStats` |

#### 2.3 Add Missing Type Definitions

**File:** `client-app/types/index.ts`

Add types that are referenced but not defined:
- `ClientStats` (for dashboard stats)
- `Notification` (for notifications screen)
- `OnboardingStep` (for onboarding flow)

---

### 3. Implement Global Error Handling

**Problem:** Errors show raw Alert.alert() with no retry, no offline awareness, no categorization.

#### 3.1 Create Error Handler Utility

**Create:** `client-app/utils/errorHandler.ts`

```
Responsibilities:
- Categorize errors (network, auth, validation, server)
- Show appropriate toast/alert per category
- Handle 401 -> redirect to login
- Handle network errors -> show offline banner
- Provide retry callback
```

#### 3.2 Create Toast Notification Component

**Create:** `client-app/components/Toast.tsx`

Replace `Alert.alert()` calls with toast notifications for non-critical messages (success, info). Keep Alert for destructive/blocking actions only.

#### 3.3 Add React Query Global Error Handler

**File:** `client-app/app/_layout.tsx` (where QueryClient is configured)

```
Add QueryClient defaultOptions:
- retry: 3 with exponential backoff
- onError: global error handler callback
- networkMode: 'offlineFirst' for offline support
```

#### 3.4 Update Individual Screens

| Screen | Current Error Handling | Improvement Needed |
|--------|----------------------|-------------------|
| `login.tsx` | Alert only, no retry | Add retry button, loading state |
| `verify.tsx` | Alert only | Add resend OTP countdown, retry |
| `weight/index.tsx` | Alert with generic message | Categorize errors (409 = duplicate, 500 = server) |
| `home/index.tsx` | React Query implicit | Add error state UI component |

---

### 4. Extract Reusable Components

**Problem:** UI patterns repeated across screens without extraction.

#### 4.1 `<Card />` Component

**Create:** `client-app/components/Card.tsx`

Used in: home, weight, progress, profile screens. Currently each has inline:
```
backgroundColor: '#fff', borderRadius: 16, padding: 20,
shadowColor: '#000', shadowOffset: {width: 0, height: 2}, shadowOpacity: 0.05
```

#### 4.2 `<StatusBadge />` Component

**Create:** `client-app/components/StatusBadge.tsx`

Used for meal status (pending, eaten, skipped, substituted). Currently inline in home/index.tsx.

#### 4.3 `<LoadingScreen />` Component

**Create:** `client-app/components/LoadingScreen.tsx`

Standardize loading states across all screens (currently each has its own spinner).

#### 4.4 `<EmptyState />` Component

**Create:** `client-app/components/EmptyState.tsx`

For when lists have no data (no meals today, no weight logs, no notifications).

---

### 5. Fix Auth Flow Issues

**File:** `client-app/app/(auth)/login.tsx`

| Issue | Fix |
|-------|-----|
| Hardcoded `+91` country code | Make configurable or add country picker |
| Phone validation (length only) | Add proper phone number validation |
| No loading overlay during API call | Add loading state to prevent double-tap |
| No error recovery | Add retry button on failure |

**File:** `client-app/app/(auth)/verify.tsx`

| Issue | Fix |
|-------|-----|
| No OTP resend countdown | Add 60s cooldown timer with resend button |
| No loading state | Show spinner during verification |

---

### 6. Fix State Duplication

**Problem:** Client data stored in both SecureStore (`authStore.ts`) AND in `useState` within hooks. This creates sync issues.

**Solution:** Use SecureStore as the single source of truth. Hooks should read from store, not maintain separate state copies.

---

### 7. Add Request Timeout Configuration

**File:** `client-app/services/api.ts`

Current timeout is 15s with no explanation. Set per-endpoint timeouts:
- Auth endpoints: 10s
- Photo upload: 60s
- Regular API: 15s

---

### 8. Implement Offline Awareness

**Create:** `client-app/hooks/useNetworkStatus.ts`

- Monitor network connectivity
- Show offline banner when disconnected
- Queue mutations for when back online (React Query offline mode)
- Show cached data when offline

---

## Definition of Done

- [ ] Shared theme system created and adopted across all 17 screen files
- [ ] All API responses properly typed (zero `unknown` types)
- [ ] Missing type definitions added (ClientStats, Notification, OnboardingStep)
- [ ] Global error handler created with categorized error handling
- [ ] Toast component replaces Alert.alert for non-critical messages
- [ ] React Query configured with retry and global error handler
- [ ] 4 reusable components extracted (Card, StatusBadge, LoadingScreen, EmptyState)
- [ ] Auth flow issues fixed (loading states, retry, OTP resend)
- [ ] State duplication between SecureStore and useState resolved
- [ ] Per-endpoint timeouts configured
</file>

<file path="doc/04-database-schema.md">
# Module 4: Database Schema Improvements

**Priority:** P1
**Effort:** 1-2 days
**Impact:** Data integrity, query performance, spec alignment

---

## Current State

The Prisma schema is the strongest part of the codebase (9/10). It has proper relations, 10+ enums, UUID primary keys, and multi-tenancy via `orgId`. However, there are inconsistencies in soft deletes, missing indexes, and a few spec-required models not yet created.

---

## What Needs To Be Done

### 1. Add Missing Soft Deletes

**Problem:** Soft deletes (`deletedAt DateTime?`) exist on some models but not others. If a record without soft delete is deleted, data is permanently lost.

| Model | Has `deletedAt`? | Action |
|-------|:---------------:|--------|
| Organization | Yes | No change |
| User | Yes | No change |
| Client | Yes | No change |
| DietPlan | Yes | No change |
| SessionNote | Yes | No change |
| **Meal** | **No** | **Add** |
| **MealLog** | **No** | **Add** |
| **WeightLog** | **No** | **Add** |
| **BodyMeasurement** | **No** | **Add** |
| **FoodItem** | **No** | **Add** |
| **MealFoodItem** | **No** | **Add** |
| **Invoice** | **No** | **Add** |

**For each model, add:**
```prisma
deletedAt DateTime?
```

**Then update all queries** that list these models to filter `where: { deletedAt: null }`. This affects:
- All controllers/services that query these tables
- Consider creating a Prisma middleware for automatic soft-delete filtering

---

### 2. Add Compound Indexes

**Problem:** Only single-column indexes exist. Common query patterns involve multiple columns.

**Add these compound indexes:**

```prisma
// Client - frequently filtered by org + status + creation
model Client {
  @@index([orgId, isActive, createdAt])
}

// DietPlan - filtered by org + status
model DietPlan {
  @@index([orgId, status, createdAt])
  @@index([clientId, status])
}

// MealLog - most common query pattern
model MealLog {
  @@index([orgId, status, scheduledDate])
  @@index([clientId, scheduledDate])
}

// WeightLog - time-series query
model WeightLog {
  @@index([clientId, logDate])
}

// Notification - recipient inbox query
model Notification {
  @@index([recipientId, recipientType, isRead, createdAt])
}

// FoodItem - search query
model FoodItem {
  @@index([orgId, category])
}
```

---

### 3. Add Missing Model: `ClientPreferences`

**Source:** `remaining.md` lists this as P1

This model stores client lifestyle data needed for better diet plan personalization.

```prisma
model ClientPreferences {
  id                String   @id @default(uuid())
  clientId          String   @unique
  breakfastTime     String?  // "06:00" - "10:00"
  lunchTime         String?  // "12:00" - "14:00"
  dinnerTime        String?  // "19:00" - "21:00"
  snackTime         String?  // "16:00" - "17:00"
  canCook           Boolean  @default(true)
  kitchenAvailable  Boolean  @default(true)
  hasDietaryCook    Boolean  @default(false)
  weekdayActivity   String?  // sedentary/light/moderate/active
  weekendActivity   String?  // sedentary/light/moderate/active
  sportOrHobby      String?
  generalNotes      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}
```

**Also add** the reverse relation on Client model:
```prisma
model Client {
  // ... existing fields
  preferences ClientPreferences?
}
```

---

### 4. Add `labValues` to MedicalProfile

**Source:** `remaining.md` lists this as P1

Lab values are needed for auto-derived risk flags and the validation engine.

```prisma
model MedicalProfile {
  // ... existing fields

  // Add these:
  labValues    Json?     // { hba1c: 6.8, vitaminD: 22, b12: 180, ... }
  labDate      DateTime? // When labs were last updated
  labDerivedTags String[] // Auto-computed: ["pre_diabetic", "vitamin_d_deficient"]
}
```

---

### 5. Add Audit Fields to Key Models

**Problem:** Most models lack `createdByUserId` / `updatedByUserId`, making it impossible to track who made changes.

**Add to these models:**

| Model | Add Field |
|-------|-----------|
| Meal | `createdByUserId String?` |
| MealFoodItem | `createdByUserId String?` |
| FoodItem | `updatedByUserId String?` (createdBy already exists) |
| WeightLog | `createdByUserId String?` |
| BodyMeasurement | `createdByUserId String?` |

---

### 6. Validate String Array Fields

**Problem:** Fields like `Client.allergies`, `Client.dislikes`, `Client.medicalConditions` are `String[]` with no value constraints. Invalid values can be inserted.

**Solution:** This is best handled at the API validation layer (Zod schemas), not the database. But document the expected values:

**Create:** Zod enum arrays in the relevant schemas:

```typescript
// In client.schema.ts
const VALID_ALLERGIES = ['peanuts', 'dairy', 'gluten', 'shellfish', 'eggs', 'soy', 'tree_nuts', 'fish', 'wheat', 'sesame'] as const;
const VALID_CONDITIONS = ['diabetes', 'pcos', 'thyroid', 'hypertension', 'heart_disease', 'kidney_disease', 'celiac', 'ibs'] as const;

// Allow both predefined and custom values
allergies: z.array(z.string().min(1).max(100)).max(20).optional()
```

---

### 7. Consider Prisma Middleware for Soft Deletes

Instead of manually adding `where: { deletedAt: null }` to every query, add a Prisma middleware:

**File:** `backend/src/utils/prisma.ts`

```typescript
// Automatically filter soft-deleted records on findMany/findFirst
prisma.$use(async (params, next) => {
  if (params.action === 'findMany' || params.action === 'findFirst') {
    if (SOFT_DELETE_MODELS.includes(params.model)) {
      params.args.where = { ...params.args.where, deletedAt: null };
    }
  }
  return next(params);
});
```

---

## Migration Plan

1. Create migration for soft delete fields (non-breaking, nullable columns)
2. Create migration for compound indexes (non-breaking, additive)
3. Create migration for ClientPreferences model (new table)
4. Create migration for MedicalProfile lab fields (additive)
5. Create migration for audit fields (additive)
6. Run `npx prisma migrate dev` for each
7. Update Zod schemas for array validation
8. Update queries to respect `deletedAt` filter

---

## Definition of Done

- [ ] `deletedAt` added to 7 models (Meal, MealLog, WeightLog, BodyMeasurement, FoodItem, MealFoodItem, Invoice)
- [ ] 6 compound indexes added
- [ ] ClientPreferences model created with relation to Client
- [ ] labValues + labDate + labDerivedTags added to MedicalProfile
- [ ] Audit fields added to 5 models
- [ ] Migrations run successfully
- [ ] All list queries updated to filter `deletedAt: null`
- [ ] Zod schemas updated for array field validation
</file>

<file path="doc/05-food-validation-engine.md">
# Module 5: Food Validation Engine Completion

**Priority:** P0 (Critical)
**Effort:** 2-3 days
**Impact:** Core feature - prevents unsafe food assignments to clients with medical conditions

---

## Current State

The validation engine exists at `backend/src/services/validationEngine.service.ts` with an LRU cache and basic structure. Types exist at `backend/src/types/validation.types.ts`. A controller and route exist. However, based on the FOOD_VALIDATION_TECH_SPEC.md, several validation rules are incomplete or missing.

**Implemented:** ~75% of backend validation logic
**Missing:** Repetition checks, strength/quantity checks, some frontend integration

---

## What Needs To Be Done

### 1. Complete Missing Validation Rules

Based on `FOOD_VALIDATION_TECH_SPEC.md`, ensure all 9 rules are implemented:

| Rule # | Name | Status | Severity |
|--------|------|--------|----------|
| 1 | Allergy Blocking | Likely done | RED (blocking) |
| 2 | Medical Condition Conflict | Likely done | RED/YELLOW |
| 3 | Intolerance Warning | Likely done | YELLOW |
| 4 | Dietary Preference Violation | Likely done | YELLOW |
| 5 | Disliked Food Warning | Likely done | YELLOW |
| 6 | Medication-Food Interaction | Check | RED |
| 7 | **Meal Repetition Check** | **Missing** | YELLOW |
| 8 | **Nutrition Strength Check** | **Missing** | YELLOW |
| 9 | **Meal Suitability Check** | Check | YELLOW |

#### 1.1 Implement Meal Repetition Check (Rule 7)

**Purpose:** Warn if the same food is assigned too frequently in a week.

**Logic needed in `validationEngine.service.ts`:**
```
Input: foodId, clientId, planId, dayOfWeek
Process:
  1. Query all meals in the same plan for the same week
  2. Count how many times this food appears
  3. If count >= 3 (configurable), return YELLOW warning
  4. Message: "This food appears {count} times this week. Consider variety."
```

**Requires:** Access to the diet plan's meal data during validation. Either:
- Pass the full plan context to the validator
- Or query the plan meals within the validation service

#### 1.2 Implement Nutrition Strength Check (Rule 8)

**Purpose:** Warn if a food's nutrition values are extreme for the client's targets.

**Logic needed:**
```
Input: food nutrition values, client's daily targets
Process:
  1. If single food > 50% of daily calorie target -> YELLOW
  2. If single food > 60% of any macro target -> YELLOW
  3. If food has 0 protein but client needs high protein -> INFO
  4. Message: "This food provides {pct}% of daily calorie target in one serving."
```

**Requires:** Client's daily targets from their active diet plan.

---

### 2. Make Validation Rules Configurable

**Problem:** Thresholds and rule parameters are hardcoded in the service.

**Create:** `backend/src/config/validation-rules.config.ts`

```typescript
export const VALIDATION_CONFIG = {
  REPETITION_THRESHOLD: Number(process.env.VALIDATION_REPETITION_THRESHOLD) || 3,
  SINGLE_FOOD_CALORIE_WARN_PCT: 0.50,
  SINGLE_FOOD_MACRO_WARN_PCT: 0.60,
  CACHE_TTL_MS: Number(process.env.VALIDATION_CACHE_TTL_MS) || 5 * 60 * 1000,
  MAX_CACHE_SIZE: Number(process.env.VALIDATION_MAX_CACHE_SIZE) || 50,
};
```

Update `validationEngine.service.ts` to import from this config instead of using inline numbers.

---

### 3. Review `validation-rules.ts` Utility

**File:** `backend/src/utils/validation-rules.ts`

This file exists but needs to be reviewed for:
- Completeness against the spec's 9 rules
- Whether it's properly used by the validation engine
- Whether rule definitions are data-driven or hardcoded

---

### 4. Complete Frontend Validation Integration

#### 4.1 Review `use-validation.ts` Hook

**File:** `frontend/src/lib/hooks/use-validation.ts` (183 lines)

Existing hook has:
- Single food validation
- Batch validation
- Caching strategy
- Style helpers for severity colors

**Check/fix:**
- Cache uses `useState` (ephemeral) - loses data on remount. Use React Query cache or sessionStorage instead.
- No cache size limit - could grow unbounded. Add max entries.
- Ensure batch validation is called when loading a plan (not just on individual food add).

#### 4.2 Review `validation-alert.tsx` Component

**File:** `frontend/src/components/diet-plan/validation-alert.tsx`

Ensure it:
- Shows RED alerts as blocking (prevent save/publish)
- Shows YELLOW alerts as dismissible warnings
- Groups alerts by severity
- Shows alert count badge on the diet plan builder

#### 4.3 Wire Validation into Diet Plan Builder

In the diet plan creation flow (`diet-plans/new/page.tsx` or the extracted `useMealBuilder` hook):
- Call `validateFood()` when adding a food to any meal
- Call `validateBatch()` when loading a template or switching clients
- Show validation alerts inline next to each food item
- Block publish if any RED alerts exist

---

### 5. Add Validation Endpoint Tests

**File:** `backend/tests/validationEngine.test.ts` (exists, check completeness)

Ensure test coverage for:

| Test Case | Priority |
|-----------|----------|
| Allergy blocking returns RED | P0 |
| Medical condition conflict (e.g., diabetes + sugar) | P0 |
| Medication interaction (e.g., warfarin + vitamin K) | P0 |
| Intolerance returns YELLOW | P1 |
| Dietary preference violation (e.g., vegetarian + meat) | P1 |
| Disliked food returns YELLOW | P1 |
| Repetition check (food appears 4x in week) | P1 |
| Nutrition strength check (>50% daily calories) | P2 |
| Meal suitability (breakfast-only food at dinner) | P2 |
| Cache hit (same request returns cached result) | P1 |
| Cache invalidation (client profile update clears cache) | P1 |

---

### 6. Ensure Cache Invalidation on Profile Changes

When a client's medical profile, allergies, or preferences change, the validation cache for that client must be invalidated.

**Check:** Does `validationEngine.invalidateClientCache(clientId)` get called from:
- `client.controller.ts` on PATCH `/clients/:id`
- `onboarding.service.ts` when onboarding steps are saved
- Any medical profile update endpoint

If not, add these calls.

---

## Definition of Done

- [ ] All 9 validation rules implemented and returning correct severity levels
- [ ] Repetition check (Rule 7) working with plan context
- [ ] Nutrition strength check (Rule 8) working with client targets
- [ ] Validation thresholds configurable via config file / env vars
- [ ] Frontend hook cache uses persistent storage (not just useState)
- [ ] Frontend hook has cache size limit
- [ ] Validation alerts shown inline in diet plan builder
- [ ] RED alerts block plan publishing
- [ ] Cache invalidation triggered on client profile changes
- [ ] Test coverage for all 9 rules + cache behavior
- [ ] `validation-rules.ts` utility reviewed and aligned with spec
</file>

<file path="doc/06-compliance-service.md">
# Module 6: Compliance Service

**Priority:** P0 (Critical)
**Effort:** 2-3 days
**Impact:** Core feature - measures how well clients follow their diet plans

---

## Current State

- Schema fields exist: `MealLog.complianceScore`, `MealLog.complianceColor`, `MealLog.complianceIssues`
- A `compliance.service.ts` file exists (108 lines) with basic `calculateCompliance()` and `calculateDailyAdherence()`
- But the service is incomplete: scoring is basic, no weekly aggregation, thresholds are hardcoded, and it's not auto-triggered

---

## What Needs To Be Done

### 1. Complete `ComplianceService` Methods

**File:** `backend/src/services/compliance.service.ts`

#### 1.1 Enhance `calculateMealCompliance(mealLog)`

Current implementation needs to score these factors:

| Factor | Points | Condition |
|--------|--------|-----------|
| Meal eaten on time | +20 | `loggedAt` within 30 min of `scheduledTime` |
| Photo uploaded | +15 | `mealPhotoUrl` is not null |
| Correct foods eaten | +30 | Status is `eaten` (not `substituted` or `skipped`) |
| Portion accuracy | +20 | No `complianceIssues` flagging portion problems |
| Dietitian approved | +15 | `dietitianFeedback` exists and is positive |
| Substitution made | -10 | Status is `substituted` |
| Skipped meal | =0 | Status is `skipped` (score is zero) |

**Total possible: 100 points per meal**

**Color mapping (make configurable):**
- GREEN: score >= 85
- YELLOW: score >= 60 and < 85
- RED: score < 60

#### 1.2 Implement `calculateDailyAdherence(clientId, date)`

```
Input: clientId, date
Process:
  1. Fetch all MealLogs for client on that date
  2. Calculate compliance score for each meal
  3. Return:
     - averageScore: mean of all meal scores
     - mealsLogged: count of non-pending meals
     - mealsTotal: total meals for the day
     - adherencePercentage: mealsLogged / mealsTotal * 100
     - color: based on averageScore
```

#### 1.3 Implement `calculateWeeklyAdherence(clientId, weekStartDate)`

```
Input: clientId, weekStartDate
Process:
  1. Get daily adherence for 7 days
  2. Return:
     - dailyBreakdown: array of 7 daily adherence objects
     - weeklyAverage: mean of daily averages
     - bestDay: highest scoring day
     - worstDay: lowest scoring day
     - totalMealsLogged: sum across week
     - totalMealsPlanned: sum across week
     - overallAdherencePercentage
     - trend: "improving" | "declining" | "stable" (compare to previous week)
```

#### 1.4 Implement `getClientComplianceHistory(clientId, dateRange)`

```
Input: clientId, startDate, endDate
Process:
  1. Get weekly adherence for each week in range
  2. Return array of weekly summaries for chart data
```

---

### 2. Make Thresholds Configurable

**Problem:** Compliance thresholds are hardcoded (lines 33-58 in current service):
- `variance > 0.2` (20%)
- `variance > 0.1` (10%)
- Score penalties: `10`, `30 * count`
- RED: `< 60`, YELLOW: `< 85`

**Create:** `backend/src/config/compliance.config.ts`

```typescript
export const COMPLIANCE_CONFIG = {
  // Scoring weights
  WEIGHT_ON_TIME: Number(process.env.COMPLIANCE_WEIGHT_ON_TIME) || 20,
  WEIGHT_PHOTO: Number(process.env.COMPLIANCE_WEIGHT_PHOTO) || 15,
  WEIGHT_CORRECT_FOODS: Number(process.env.COMPLIANCE_WEIGHT_CORRECT_FOODS) || 30,
  WEIGHT_PORTION: Number(process.env.COMPLIANCE_WEIGHT_PORTION) || 20,
  WEIGHT_APPROVED: Number(process.env.COMPLIANCE_WEIGHT_APPROVED) || 15,
  PENALTY_SUBSTITUTION: Number(process.env.COMPLIANCE_PENALTY_SUB) || 10,

  // Color thresholds
  GREEN_THRESHOLD: Number(process.env.COMPLIANCE_GREEN) || 85,
  YELLOW_THRESHOLD: Number(process.env.COMPLIANCE_YELLOW) || 60,

  // Time tolerance
  ON_TIME_TOLERANCE_MINUTES: Number(process.env.COMPLIANCE_TIME_TOLERANCE) || 30,
};
```

---

### 3. Auto-Trigger Compliance Calculation

**Problem:** Compliance calculation must run automatically when a meal log status changes, not be manually called.

#### 3.1 Trigger Points

Add compliance recalculation in these places:

| Trigger | Location | When |
|---------|----------|------|
| Meal logged | `mealLog.controller.ts` PATCH handler | When `status` changes to `eaten`/`skipped`/`substituted` |
| Photo uploaded | `mealLog.controller.ts` photo handler | When `mealPhotoUrl` is set |
| Dietitian review | `mealLog.controller.ts` review handler | When `dietitianFeedback` is set |

**Implementation:** After each trigger, call:
```typescript
const score = await complianceService.calculateMealCompliance(updatedMealLog);
await prisma.mealLog.update({
  where: { id: mealLogId },
  data: {
    complianceScore: score.score,
    complianceColor: score.color,
    complianceIssues: score.issues,
  }
});
```

**Better approach (once service layer is extracted):** This logic lives in `MealLogService.updateStatus()` which calls `complianceService` internally.

---

### 4. Create Compliance API Endpoints

**Create:** `backend/src/routes/compliance.routes.ts`

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/v1/clients/:clientId/adherence/daily?date=` | Daily adherence for a specific date |
| GET | `/api/v1/clients/:clientId/adherence/weekly?weekStart=` | Weekly adherence summary |
| GET | `/api/v1/clients/:clientId/adherence/history?from=&to=` | Compliance history for charts |

**Create:** `backend/src/controllers/compliance.controller.ts`

Thin controller that delegates to `complianceService` methods.

---

### 5. Frontend: Display Compliance Data

#### 5.1 Client Detail Page

**File:** `frontend/src/app/dashboard/clients/[id]/page.tsx`

Add a compliance section showing:
- Weekly adherence percentage (large number)
- Daily breakdown (7 colored dots: green/yellow/red)
- Trend indicator (arrow up/down/flat)
- "This week vs last week" comparison

#### 5.2 Dashboard Page

**File:** `frontend/src/app/dashboard/page.tsx`

Add to the dashboard overview:
- Average adherence across all clients
- Clients with declining adherence (alert list)
- Top performing clients

#### 5.3 Create Compliance Hook

**Create:** `frontend/src/lib/hooks/use-compliance.ts`

```typescript
export function useDailyAdherence(clientId: string, date: string) { ... }
export function useWeeklyAdherence(clientId: string, weekStart: string) { ... }
export function useComplianceHistory(clientId: string, from: string, to: string) { ... }
```

---

### 6. Mobile App: Show Compliance to Client

#### 6.1 Progress Screen

**File:** `client-app/app/(tabs)/progress/index.tsx`

Show the client their own compliance:
- This week's adherence percentage
- Daily meal completion status
- Streak counter (consecutive days with 100% logging)

#### 6.2 Home Screen Enhancement

**File:** `client-app/app/(tabs)/home/index.tsx`

Show today's adherence progress:
- "2 of 4 meals logged" progress bar
- Color-coded compliance after each meal

---

## Definition of Done

- [ ] `calculateMealCompliance()` scores all 7 factors with configurable weights
- [ ] `calculateDailyAdherence()` returns daily summary
- [ ] `calculateWeeklyAdherence()` returns weekly summary with trend
- [ ] `getClientComplianceHistory()` returns chart-ready data
- [ ] All thresholds configurable via config file / env vars
- [ ] Compliance auto-triggers on meal status change, photo upload, and review
- [ ] 3 API endpoints created (daily, weekly, history)
- [ ] Frontend hook created (`use-compliance.ts`)
- [ ] Client detail page shows weekly adherence
- [ ] Dashboard shows average adherence overview
- [ ] Mobile progress screen shows compliance
- [ ] Mobile home screen shows daily progress
</file>

<file path="doc/07-onboarding-flow.md">
# Module 7: Onboarding Flow Completion

**Priority:** P0 (Critical)
**Effort:** 2-3 days
**Impact:** Blocks user acquisition - clients can't fully onboard without all steps

---

## Current State

The mobile app onboarding has 5 step screens (`step1.tsx` through `step5.tsx`) plus a `complete.tsx` screen. The backend has an `onboarding.service.ts` (341 lines) with step definitions and preset data.

However, based on the spec:
- **Step 2 (Medical History)** - screen exists but needs verification of completeness
- **Step 6 (Body Measurements)** - screen does not exist
- Some steps may have incomplete submission logic (saving to API)

---

## What Needs To Be Done

### 1. Audit Existing Onboarding Steps

Review each step file for completeness:

| Step | File | Expected Content | Status |
|------|------|-----------------|--------|
| Step 1 - Basic Info | `step1.tsx` | Name, DOB, gender, height, weight, activity level | Verify |
| Step 2 - Medical History | `step2.tsx` | Conditions, medications, surgeries, family history | Verify |
| Step 3 - Allergies & Diet | `step3.tsx` | Allergies, intolerances, dietary preferences, dislikes | Verify |
| Step 4 - Goals | `step4.tsx` | Target weight, timeline, motivation | Verify |
| Step 5 - Lifestyle | `step5.tsx` | Meal timings, cooking ability, activity schedule | Verify |
| Step 6 - Body Measurements | **Missing** | Chest, waist, hips, thighs, arms, body fat % | **Create** |
| Complete | `complete.tsx` | Success screen with next steps | Verify |

**For each existing step, verify:**
- Form fields match what the backend `onboarding.service.ts` expects
- Data is saved to the correct API endpoint
- Validation is present on required fields
- Navigation to next step works after save
- Back navigation works without losing data
- Loading state shown during API calls
- Error handling with retry option

---

### 2. Create Step 6 - Body Measurements

**Create:** `client-app/app/(onboarding)/step6.tsx`

**UI Requirements:**

```
Title: "Body Measurements (Optional)"
Subtitle: "Help your dietitian track your progress more accurately"

Fields:
- Chest (cm): numeric input
- Waist (cm): numeric input
- Hips (cm): numeric input
- Thighs (cm): numeric input
- Arms (cm): numeric input
- Body Fat % (optional): numeric input with decimal

Unit Toggle: cm / inches (convert on submit)

Buttons:
- "Skip for now" -> navigate to complete
- "Save & Continue" -> save to API -> navigate to complete
```

**API Call:**
```
POST /api/v1/client/onboarding/step6
Body: {
  chestCm: number | null,
  waistCm: number | null,
  hipsCm: number | null,
  thighsCm: number | null,
  armsCm: number | null,
  bodyFatPercentage: number | null
}
```

**Validation:**
- All fields optional (step is skippable)
- If provided: min 20, max 200 for cm measurements
- Body fat: min 3, max 60

---

### 3. Ensure Backend Handles All Steps

**File:** `backend/src/services/onboarding.service.ts`

Verify the service has handlers for all 6 steps:

| Method | Saves To | Fields |
|--------|----------|--------|
| `saveStep1(clientId, data)` | Client table | fullName, dateOfBirth, gender, heightCm, currentWeightKg, activityLevel |
| `saveStep2(clientId, data)` | MedicalProfile | diagnoses, medications, surgeries, familyHistory |
| `saveStep3(clientId, data)` | Client + MedicalProfile | allergies, intolerances, dietaryPreferences, dislikes |
| `saveStep4(clientId, data)` | Client | targetWeightKg, goals, motivation |
| `saveStep5(clientId, data)` | ClientPreferences (if model exists) | mealTimings, canCook, activity |
| `saveStep6(clientId, data)` | BodyMeasurement | chest, waist, hips, thighs, arms, bodyFat |

**If Step 6 handler is missing, add it:**

```typescript
async saveStep6(clientId: string, data: Step6Data) {
  await prisma.bodyMeasurement.create({
    data: {
      clientId,
      orgId: client.orgId, // fetch from client
      logDate: new Date(),
      chestCm: data.chestCm,
      waistCm: data.waistCm,
      hipsCm: data.hipsCm,
      thighsCm: data.thighsCm,
      armsCm: data.armsCm,
      bodyFatPercentage: data.bodyFatPercentage,
    }
  });
}
```

---

### 4. Ensure Backend Endpoint Exists for Each Step

**File:** `backend/src/routes/onboarding.routes.ts`

Verify these endpoints exist:

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/v1/client/onboarding/status` | Get current progress (which steps complete) |
| POST | `/api/v1/client/onboarding/step1` | Save basic info |
| POST | `/api/v1/client/onboarding/step2` | Save medical history |
| POST | `/api/v1/client/onboarding/step3` | Save allergies/preferences |
| POST | `/api/v1/client/onboarding/step4` | Save goals |
| POST | `/api/v1/client/onboarding/step5` | Save lifestyle |
| POST | `/api/v1/client/onboarding/step6` | Save body measurements |
| POST | `/api/v1/client/onboarding/complete` | Mark onboarding as done |

---

### 5. Fix Step 5 Dependency on ClientPreferences Model

Step 5 (Lifestyle) saves meal timings, cooking ability, and activity schedule. This data should go to the `ClientPreferences` model.

**If `ClientPreferences` model doesn't exist yet** (see Module 4), Step 5 data may be getting lost or saved to the wrong table.

**Action:** Coordinate with Module 4 (Database Schema) to ensure `ClientPreferences` model exists before Step 5 can save correctly.

---

### 6. Add Progress Indicator

Both the mobile app and the onboarding service should track progress:

**Mobile app:** Show step progress bar (e.g., "Step 3 of 6") at top of each onboarding screen.

**Backend:** `getOnboardingStatus()` should return:
```json
{
  "currentStep": 3,
  "totalSteps": 6,
  "completedSteps": [1, 2],
  "skippedSteps": [],
  "percentComplete": 33
}
```

---

### 7. Handle Partial Onboarding

**Problem:** What if a user completes steps 1-3, closes the app, and returns?

**Expected behavior:**
1. On app open, check onboarding status via API
2. If `onboardingCompleted` is false, redirect to the next incomplete step
3. Allow going back to edit previously completed steps
4. Show previously entered data pre-filled in forms

**Files to update:**
- `client-app/app/index.tsx` (root router) - check onboarding status
- `client-app/app/(onboarding)/_layout.tsx` - determine starting step

---

### 8. Style Consistency

All onboarding screens should share the same visual style:
- Consistent header/progress bar
- Same button styles (primary green, secondary gray)
- Same input field styles
- Same spacing/padding
- Import from shared theme (see Module 3)

---

## Definition of Done

- [ ] All 6 step screens exist and render correctly
- [ ] Step 6 (Body Measurements) created with proper form and validation
- [ ] All steps save data to correct backend endpoints
- [ ] Backend has handlers for all 6 steps in onboarding.service.ts
- [ ] All 8 API endpoints exist and work correctly
- [ ] Progress indicator shows current step (e.g., "3 of 6")
- [ ] Partial onboarding resumes from correct step after app restart
- [ ] Previously entered data pre-fills when going back to a step
- [ ] Loading states shown during API calls
- [ ] Error handling with retry on each step
- [ ] Consistent styling across all onboarding screens
- [ ] Step 5 correctly saves to ClientPreferences model
- [ ] `onboardingCompleted` flag set to true after step 6 or complete
</file>

<file path="doc/08-code-quality-testing.md">
# Module 8: Code Quality, Testing & Configuration

**Priority:** P2
**Effort:** Ongoing (3-5 days initial, then continuous)
**Impact:** Long-term maintainability, reliability, developer confidence

---

## Current State

- **Test coverage: 0%** - Only one test file exists (`backend/tests/validationEngine.test.ts`), no frontend or mobile tests
- **TypeScript strictness: Partial** - `any` types used in controllers, no strict mode enforced
- **Hardcoded configuration: Widespread** - Business rules embedded in service code
- **Logging: Minimal** - No structured logging or request tracing
- **No CI/CD pipeline** visible in the codebase

---

## What Needs To Be Done

### 1. Extract All Hardcoded Configuration

Gather every hardcoded business value into configuration files.

**Create:** `backend/src/config/` directory with:

#### `backend/src/config/app.config.ts`
```
- DEFAULT_PAGE_SIZE: 20
- MAX_PAGE_SIZE: 100
- FILE_UPLOAD_MAX_SIZE_MB: 10
- PRESIGNED_URL_EXPIRY_SECONDS: 3600
- IMAGE_COMPRESSION_QUALITY: 80
- SESSION_EXPIRY_DAYS: 30
```

#### `backend/src/config/compliance.config.ts`
(See Module 6 for details)

#### `backend/src/config/validation.config.ts`
(See Module 5 for details)

#### `backend/src/config/referral.config.ts`
```
- REFERRALS_PER_BENEFIT: 3 (currently hardcoded as `Math.floor(count / 3)`)
- BENEFIT_TYPE: 'free_month'
```

#### `backend/src/config/nutrition.config.ts`
```
- NUTRITION_THRESHOLDS (currently hardcoded in foodTagging.service.ts lines 47-61)
- HEALTH_FLAG_RULES (currently hardcoded in foodTagging.service.ts lines 65-70)
- ALLERGEN_KEYWORDS (currently hardcoded in foodTagging.service.ts)
```

---

### 2. Fix TypeScript Strictness

#### 2.1 Eliminate `any` Types in Controllers

**Problem:** Multiple controllers use `const where: any = {}` for building Prisma queries.

**Fix:** Create typed filter interfaces:

```typescript
// backend/src/types/filters.ts
interface ClientFilters {
  orgId: string;
  isActive?: boolean;
  primaryDietitianId?: string;
  search?: string;
  deletedAt?: null;
}

interface DateRangeFilter {
  gte?: Date;
  lte?: Date;
}

interface PaginationParams {
  page: number;
  pageSize: number;
  sortBy: string;
  sortOrder: 'asc' | 'desc';
}
```

#### 2.2 Create Generic Response Types

**Create:** `backend/src/types/response.ts`

```typescript
interface ApiResponse<T> {
  success: boolean;
  data: T;
}

interface PaginatedResponse<T> {
  success: boolean;
  data: T[];
  meta: {
    page: number;
    pageSize: number;
    total: number;
    totalPages: number;
    hasNextPage: boolean;
    hasPreviousPage: boolean;
  };
}
```

Currently each controller reimplements the meta/pagination structure inline.

#### 2.3 Enable Strict TypeScript (Optional, P3)

```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
}
```

This will surface many issues. Fix incrementally, file by file.

---

### 3. Add Backend Tests

**Current:** 1 test file (`validationEngine.test.ts`)
**Target:** Unit tests for all services, integration tests for API endpoints

#### 3.1 Service Unit Tests (Priority)

| Test File | Service | Key Test Cases |
|-----------|---------|---------------|
| `compliance.service.test.ts` | ComplianceService | Score calculation, color assignment, edge cases |
| `foodTagging.service.test.ts` | FoodTaggingService | Category detection, allergen detection, bulk tagging |
| `onboarding.service.test.ts` | OnboardingService | Step saving, status tracking, preset application |
| `notification.service.test.ts` | NotificationService | Notification creation, delivery status |
| `storage.service.test.ts` | StorageService | Upload, compression, thumbnail generation |

**Once service layer is extracted (Module 1):**

| Test File | Service | Key Test Cases |
|-----------|---------|---------------|
| `client.service.test.ts` | ClientService | CRUD, referral code, progress calculation |
| `dietPlan.service.test.ts` | DietPlanService | Nested creation, publishing, template cloning |
| `mealLog.service.test.ts` | MealLogService | Status update, compliance trigger, nutrition calc |
| `weightLog.service.test.ts` | WeightLogService | BMI calculation, outlier detection, stats |
| `foodItem.service.test.ts` | FoodItemService | Search, nutrition scaling, auto-tag trigger |

#### 3.2 API Integration Tests

| Test File | Endpoints | Key Test Cases |
|-----------|-----------|---------------|
| `auth.integration.test.ts` | `/auth/*` | Login, token refresh, invalid credentials |
| `clients.integration.test.ts` | `/clients/*` | CRUD, pagination, search, medical profile |
| `dietPlans.integration.test.ts` | `/diet-plans/*` | Create with meals, publish, template |
| `mealLogs.integration.test.ts` | `/meal-logs/*` | Status update, review, photo upload |

#### 3.3 Test Setup

**Create:** `backend/tests/setup.ts`
- Configure test database (use `.env.test`)
- Seed test data before suites
- Clean up after suites
- Mock external services (S3, email, push notifications)

---

### 4. Add Frontend Tests

#### 4.1 Hook Tests

Using `@testing-library/react-hooks` or Vitest:

| Test File | Hook | Key Test Cases |
|-----------|------|---------------|
| `use-clients.test.ts` | useClients | Fetch list, pagination, search, create mutation |
| `use-diet-plans.test.ts` | useDietPlans | Fetch, create, publish mutation |
| `use-validation.test.ts` | useValidation | Validate food, batch validate, cache behavior |

#### 4.2 Component Tests

Using `@testing-library/react`:

| Test File | Component | Key Test Cases |
|-----------|-----------|---------------|
| `modal.test.tsx` | Modal | Open, close, escape key, overlay click |
| `add-food-modal.test.tsx` | AddFoodModal | Search, select, validation alert |
| `validation-alert.test.tsx` | ValidationAlert | RED/YELLOW/GREEN rendering |

#### 4.3 E2E Tests (P3)

Using Playwright or Cypress:
- Dietitian login -> create client -> create diet plan -> publish
- Meal log review flow
- Weight tracking flow

---

### 5. Add Structured Logging

#### 5.1 Backend Logging

**File:** `backend/src/utils/logger.ts`

Enhance with:
- Request ID tracking (correlate logs across a request lifecycle)
- Structured JSON format for production
- Log levels: error, warn, info, debug
- Request/response logging middleware (method, path, status, duration)

**Create:** `backend/src/middleware/requestLogger.middleware.ts`

```
Log for every request:
- Request ID (UUID)
- Method + path
- User ID (from auth)
- Response status code
- Response time in ms
```

#### 5.2 Mobile App Logging

**Create:** `client-app/utils/logger.ts`

- Log API calls with request/response (in dev mode)
- Log navigation events
- Log errors with stack traces
- Optionally send error logs to backend for monitoring

---

### 6. Add Request Correlation IDs

**Create:** `backend/src/middleware/requestId.middleware.ts`

```
- Generate UUID for each incoming request
- Attach to `req.requestId`
- Include in all log entries
- Return in response header: `X-Request-ID`
- Pass to downstream service calls
```

This enables tracing a single user action across all log entries.

---

### 7. Linting & Formatting Standardization

#### 7.1 Backend

**Verify/create:** `backend/.eslintrc.json`
- TypeScript ESLint rules
- No `any` warning
- Unused variable errors
- Consistent import ordering

**Verify/create:** `backend/.prettierrc`
- Consistent formatting across all files

#### 7.2 Frontend

**Verify existing:** `frontend/.eslintrc.json`
- Ensure React hooks rules enabled
- Ensure accessibility rules enabled

#### 7.3 Mobile App

**Create if missing:** `client-app/.eslintrc.json`
- React Native specific rules
- Expo specific rules

---

### 8. API Documentation

**Create:** `backend/src/docs/` or use Swagger/OpenAPI

Document all endpoints with:
- Request/response schemas
- Authentication requirements
- Error codes
- Rate limits

Consider using `swagger-jsdoc` + `swagger-ui-express` to auto-generate from JSDoc comments on routes.

---

### 9. Environment Variable Validation

**Create:** `backend/src/config/env.ts`

Validate all required environment variables at startup:
```typescript
const requiredVars = ['DATABASE_URL', 'CLERK_SECRET_KEY', 'S3_ENDPOINT', ...];

for (const varName of requiredVars) {
  if (!process.env[varName]) {
    throw new Error(`Missing required environment variable: ${varName}`);
  }
}
```

This prevents the app from starting with missing config and failing at runtime.

---

## Definition of Done

- [ ] All hardcoded business values extracted to config files
- [ ] `any` types replaced with proper TypeScript interfaces
- [ ] Generic response types created and used across controllers
- [ ] Backend service unit tests written (target: 80% coverage)
- [ ] API integration tests for core endpoints
- [ ] Frontend hook tests written
- [ ] Structured logging with request IDs implemented
- [ ] ESLint + Prettier configured consistently across all 3 codebases
- [ ] Environment variable validation at startup
- [ ] Test setup with test database and mocking configured
</file>

<file path="doc/09-notifications-push.md">
# Module 9: Notifications & Push System

**Priority:** P1
**Effort:** 3 days
**Impact:** Core engagement loop - clients need reminders and feedback alerts

---

## Current State

| Component | Completeness | Status |
|-----------|-------------|--------|
| `notification.service.ts` | 30% | Push completely simulated - Expo SDK commented out |
| `notification.controller.ts` | 70% | DB operations work, client token registration stubbed (501) |
| `notification.routes.ts` | 100% | All 3 routes defined |
| Mobile notifications screen | 40% | 100% mock/hardcoded data, no API integration |
| Dashboard notifications | N/A | No notification bell/inbox for dietitians |

**Core problem:** The notification service logs to console instead of actually sending push notifications. The Expo Server SDK import is commented out with a TODO.

---

## What Needs To Be Done

### 1. Install and Integrate Expo Push Notifications

**File:** `backend/src/services/notification.service.ts`

#### 1.1 Install Expo Server SDK

```
cd backend && npm install expo-server-sdk
```

#### 1.2 Replace Simulated Push with Real Implementation

The service currently has:
- Line 3: `// TODO: import Expo from 'expo-server-sdk'` (commented out)
- Lines 81-89: Commented-out Expo push logic
- Line 96: Returns `"push_simulated"` status

**Replace with:**
- Uncomment and configure Expo SDK
- Implement actual push sending with proper error handling
- Handle invalid push tokens (remove from DB)
- Handle rate limiting from Expo servers
- Implement receipt checking for delivery confirmation

#### 1.3 Implement Retry Logic

Push notifications can fail transiently. Add:
- 3 retries with exponential backoff
- Dead letter queue for permanently failed notifications
- Update `deliveryStatus` to `failed` with error reason after all retries exhausted

---

### 2. Fix Client Token Registration

**File:** `backend/src/controllers/notification.controller.ts`

Line 39: `registerClientToken` currently returns 501 (Not Implemented).

**Implement:**
```
POST /api/v1/client/notifications/device-token
Body: { token: "ExponentPushToken[xxx]", platform: "ios" | "android" }

Logic:
1. Validate token format (must be ExponentPushToken[...])
2. Store/update in DB linked to clientId
3. Remove old tokens for this client (one device per client for MVP)
```

---

### 3. Define Notification Triggers

Create notification events that auto-fire across the app:

| Trigger | Recipient | Type | When |
|---------|-----------|------|------|
| Meal reminder | Client | `meal_reminder` | At scheduled meal time (8am, 1pm, 4pm, 8pm) |
| Dietitian reviewed meal | Client | `dietitian_feedback` | When dietitian submits feedback |
| Client uploaded photo | Dietitian | `photo_uploaded` | When client logs a meal with photo |
| Weight logged | Dietitian | `weight_logged` | When client logs weight |
| Plan published | Client | `plan_published` | When dietitian publishes a diet plan |
| Weekly check-in | Client | `weekly_checkin` | Every Monday morning |
| Streak milestone | Client | `achievement` | At 7, 14, 30 day meal logging streaks |

#### 3.1 Add Notification Triggers to Existing Controllers

| Controller | Method | Notification to Send |
|------------|--------|---------------------|
| `mealLog.controller.ts` | PATCH (review) | `dietitian_feedback` to client |
| `mealLog.controller.ts` | PATCH (log meal) | `photo_uploaded` to dietitian |
| `weightLog.controller.ts` | POST | `weight_logged` to dietitian |
| `dietPlan.controller.ts` | POST (publish) | `plan_published` to client |

Add at the end of each handler (after the main operation succeeds):
```typescript
await notificationService.send({
  recipientId: clientId,
  recipientType: 'client',
  orgId,
  type: 'dietitian_feedback',
  title: 'Dr. Priya reviewed your lunch',
  message: 'Great choice! Keep it up.',
  deepLink: `/meals/${mealLogId}`,
});
```

#### 3.2 Implement Scheduled Notifications (Meal Reminders)

**Create:** `backend/src/jobs/mealReminder.job.ts`

This needs a job scheduler (e.g., `node-cron` or `bull` queue):
- Run every hour
- Query MealLogs where `scheduledTime` is within the next hour and status is `pending`
- Send push reminder to client: "Breakfast time! Log your meal"
- Don't resend if already reminded (track `reminderSentAt` or use a flag)

For MVP, a simple `setInterval` or `node-cron` is sufficient. No need for Redis/Bull yet.

---

### 4. Wire Up Mobile Notifications Screen

**File:** `client-app/app/(tabs)/notifications/index.tsx`

Currently 100% mock data (5 hardcoded notifications). Replace with real API integration.

#### 4.1 Create Notification Hook

**Create:** `client-app/hooks/useNotifications.ts`

```typescript
// Fetch real notifications from API
export function useNotifications() {
  return useQuery({
    queryKey: ['notifications'],
    queryFn: () => api.get('/client/notifications'),
    staleTime: 30 * 1000, // 30 seconds
  });
}

export function useMarkAsRead() {
  return useMutation({
    mutationFn: (id: string) => api.patch(`/client/notifications/${id}/read`),
    onSuccess: () => queryClient.invalidateQueries(['notifications']),
  });
}
```

#### 4.2 Update Notifications Screen

Replace mock data array with `useNotifications()` hook:
- Show loading spinner while fetching
- Show empty state if no notifications
- Pull-to-refresh support
- Mark as read on tap
- Navigate to deep link on tap (meal detail, weight log, etc.)
- Show unread badge count on bottom tab icon

#### 4.3 Register Push Token on App Launch

**File:** `client-app/app/_layout.tsx` or `client-app/hooks/useAuth.ts`

After successful login:
1. Request push notification permissions from user
2. Get Expo push token via `Notifications.getExpoPushTokenAsync()`
3. Send token to backend: `POST /client/notifications/device-token`
4. Store token locally to avoid re-registering on every launch

---

### 5. Add Unread Badge to Tab Bar

**File:** `client-app/components/BottomTabBar.tsx`

- Fetch unread notification count
- Show red badge dot on the notifications tab when count > 0
- Update count when notifications are marked as read

---

### 6. Dashboard Notification Bell (Dietitian Side)

**Create notification components for the dietitian dashboard:**

#### 6.1 Notification Bell Icon

**Add to:** `frontend/src/app/dashboard/layout.tsx` (header area)

- Bell icon in top-right header
- Red badge with unread count
- Dropdown panel showing recent notifications on click
- "View all" link to full notifications page

#### 6.2 Create Dietitian Notifications Hook

**Create:** `frontend/src/lib/hooks/use-notifications.ts`

```typescript
export function useNotifications() {
  return useQuery({
    queryKey: ['dietitian-notifications'],
    queryFn: () => apiClient.get('/notifications'),
    refetchInterval: 60 * 1000, // Poll every 60 seconds
  });
}
```

---

### 7. Email Notification Fallback

**File:** `backend/src/utils/emailService.ts`

Currently dev-mode only (logs to console without SMTP config).

#### 7.1 Configure for Production

- Set `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS` env vars
- Test with a real SMTP provider (SendGrid, AWS SES, or self-hosted Postfix per PRD)
- Ensure HTML email templates render correctly

#### 7.2 Add Email Fallback for Critical Notifications

For these notification types, also send an email if push fails:
- `plan_published` (client should know they have a new plan)
- `dietitian_feedback` (important for engagement)
- `weekly_checkin` (summary email)

---

## Definition of Done

- [ ] `expo-server-sdk` installed and integrated
- [ ] Push notifications actually send to real devices
- [ ] Client device token registration working (not 501)
- [ ] Invalid push token cleanup implemented
- [ ] 7 notification triggers wired into existing controllers
- [ ] Meal reminder job running on schedule
- [ ] Mobile notifications screen uses real API data (no mock data)
- [ ] Push token registered on app launch after login
- [ ] Pull-to-refresh on notifications screen
- [ ] Mark-as-read on tap with deep link navigation
- [ ] Unread badge on mobile tab bar
- [ ] Notification bell in dashboard header with dropdown
- [ ] Email service configured for production SMTP
- [ ] Email fallback for critical notification types
</file>

<file path="doc/10-session-notes-invoicing.md">
# Module 10: Session Notes, Invoicing & Activity Logging

**Priority:** P2
**Effort:** 4-5 days
**Impact:** Completes professional workflow tools for dietitians

---

## Current State

All three features have **database schemas ready** but no service layer, incomplete/missing controllers, and no frontend UI.

| Feature | Schema | Backend | Frontend | Mobile |
|---------|--------|---------|----------|--------|
| Session Notes (SOAP/DAP) | Yes | No service, no controller | No UI | N/A |
| Invoice System | Yes | No service, no controller | No UI | N/A |
| Activity Logging | Yes | No service | No UI | N/A |
| Tag Review Queue | Yes | No controller | No UI | N/A |

---

## Part A: Session Notes CRUD

### What Needs To Be Done

#### A1. Create Session Notes Service

**Create:** `backend/src/services/sessionNote.service.ts`

| Method | Purpose |
|--------|---------|
| `createNote(clientId, data, userId, orgId)` | Create SOAP/DAP note |
| `getNotes(clientId, orgId, filters)` | List notes with pagination |
| `getNote(noteId, orgId)` | Get single note with full content |
| `updateNote(noteId, data, orgId)` | Edit note |
| `deleteNote(noteId, orgId)` | Soft delete |

#### A2. Create Session Notes Controller & Routes

**Create:** `backend/src/controllers/sessionNote.controller.ts`
**Create:** `backend/src/routes/sessionNote.routes.ts`

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/v1/clients/:clientId/session-notes` | Create note |
| GET | `/api/v1/clients/:clientId/session-notes` | List notes for client |
| GET | `/api/v1/session-notes/:id` | Get full note |
| PATCH | `/api/v1/session-notes/:id` | Update note |
| DELETE | `/api/v1/session-notes/:id` | Soft delete |

**Register routes in `app.ts`.**

#### A3. Create Zod Schema

**Create:** `backend/src/schemas/sessionNote.schema.ts`

```typescript
const createSessionNoteSchema = z.object({
  noteType: z.enum(['SOAP', 'DAP', 'other']),
  title: z.string().min(1).max(255),
  subjective: z.string().optional(),
  objective: z.string().optional(),
  assessment: z.string().optional(),
  plan: z.string().optional(),
  internalNotes: z.string().optional(),
});
```

#### A4. Create Frontend Hook

**Create:** `frontend/src/lib/hooks/use-session-notes.ts`

```typescript
useSessionNotes(clientId)     // List notes
useSessionNote(noteId)        // Single note
useCreateSessionNote()        // Create mutation
useUpdateSessionNote()        // Update mutation
useDeleteSessionNote()        // Delete mutation
```

#### A5. Create Frontend UI

**Add to:** `frontend/src/app/dashboard/clients/[id]/page.tsx`

Add a "Session Notes" tab in the client detail page:
- List of notes (date, type, title, author)
- Click to expand full SOAP content
- "New Note" button opening a form
- SOAP fields: Subjective, Objective, Assessment, Plan
- Internal notes field (not visible to client)
- Edit/delete existing notes

---

## Part B: Invoice System

### What Needs To Be Done

#### B1. Create Invoice Service

**Create:** `backend/src/services/invoice.service.ts`

| Method | Purpose |
|--------|---------|
| `createInvoice(clientId, data, userId, orgId)` | Create with auto-generated invoice number |
| `getInvoices(orgId, filters)` | List with status/client filtering |
| `getInvoice(invoiceId, orgId)` | Single invoice with line items |
| `updateInvoice(invoiceId, data, orgId)` | Edit (only if unpaid) |
| `markAsPaid(invoiceId, orgId)` | Change status to paid |
| `sendInvoice(invoiceId, recipientEmail, orgId)` | Email with PDF attachment |
| `generateInvoiceNumber(orgId)` | Auto-increment: `INV-2026-00001` |

#### B2. Create Invoice Controller & Routes

**Create:** `backend/src/controllers/invoice.controller.ts`
**Create:** `backend/src/routes/invoice.routes.ts`

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/v1/invoices` | Create invoice |
| GET | `/api/v1/invoices` | List invoices (org-level) |
| GET | `/api/v1/invoices/:id` | Get invoice detail |
| PATCH | `/api/v1/invoices/:id` | Update invoice |
| POST | `/api/v1/invoices/:id/mark-paid` | Mark as paid |
| POST | `/api/v1/invoices/:id/send` | Email to client |
| GET | `/api/v1/invoices/:id/pdf` | Download PDF |

**Register routes in `app.ts`.**

#### B3. Create Invoice PDF Generator

**Add to:** `backend/src/utils/pdfGenerator.ts` or create `invoicePdfGenerator.ts`

Generate professional PDF invoice with:
- Organization logo and details
- Client name and details
- Invoice number, issue date, due date
- Line items table (description, quantity, unit price, total)
- Subtotal, tax, grand total
- Payment terms and notes
- "Paid" watermark stamp when status is paid

#### B4. Create Zod Schema

**Create:** `backend/src/schemas/invoice.schema.ts`

```typescript
const createInvoiceSchema = z.object({
  clientId: z.string().uuid(),
  issueDate: z.string(),
  dueDate: z.string(),
  currency: z.enum(['INR', 'USD']).default('INR'),
  lineItems: z.array(z.object({
    description: z.string().min(1),
    quantity: z.number().positive(),
    unitPrice: z.number().nonnegative(),
    taxPercentage: z.number().nonnegative().default(0),
  })).min(1),
  notes: z.string().optional(),
});
```

#### B5. Create Frontend UI

**Create:** `frontend/src/app/dashboard/invoices/page.tsx`

Invoice list page:
- Table: invoice number, client name, date, amount, status (unpaid/sent/paid)
- Status badge (color-coded)
- Filter by status, client, date range
- "Create Invoice" button

**Create:** `frontend/src/app/dashboard/invoices/new/page.tsx`

Create invoice form:
- Client selector dropdown
- Date pickers (issue, due)
- Dynamic line items (add/remove rows)
- Auto-calculate subtotal and total
- Notes field
- Preview PDF button
- Save as draft / Send now

**Create:** `frontend/src/app/dashboard/invoices/[id]/page.tsx`

Invoice detail page:
- Full invoice preview (styled like PDF)
- Action buttons: Edit, Send, Mark Paid, Download PDF
- Payment history

#### B6. Create Frontend Hook

**Create:** `frontend/src/lib/hooks/use-invoices.ts`

#### B7. Add Navigation

Add "Invoices" to the dashboard sidebar navigation.

---

## Part C: Activity Logging

### What Needs To Be Done

#### C1. Create Activity Logging Service

**Create:** `backend/src/services/activityLog.service.ts`

| Method | Purpose |
|--------|---------|
| `log(action, entityType, entityId, userId, orgId, metadata?)` | Create log entry |
| `getActivityLogs(orgId, filters)` | List with pagination |
| `getClientActivity(clientId, orgId)` | Activity for a specific client |

#### C2. Add Activity Logging Triggers

Insert `activityLogService.log()` calls in these existing controllers:

| Action | Controller | Event |
|--------|-----------|-------|
| `client_created` | client.controller | After client creation |
| `client_updated` | client.controller | After client update |
| `diet_plan_created` | dietPlan.controller | After plan creation |
| `diet_plan_published` | dietPlan.controller | After publish |
| `meal_log_reviewed` | mealLog.controller | After dietitian review |
| `user_login` | auth.controller | After successful login |
| `food_item_created` | foodItem.controller | After food creation |
| `invoice_created` | invoice.controller | After invoice creation |

#### C3. Create Activity Log Endpoints

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/v1/admin/activity-logs` | Org-level audit log (admin/owner) |
| GET | `/api/v1/clients/:clientId/activity` | Client-specific activity feed |

#### C4. Frontend UI

Add an activity feed in two places:
1. **Client detail page:** "Activity" tab showing recent actions for that client
2. **Admin settings:** "Audit Log" page showing all org activity (admin/owner only)

---

## Part D: Tag Review Queue

### What Needs To Be Done

#### D1. Add Tag Review Endpoints

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/v1/food-items/unverified` | List food items with auto-tags pending review |
| PATCH | `/api/v1/food-items/:id/verify` | Approve auto-generated tags |
| PATCH | `/api/v1/food-items/:id/reject` | Reject and reset tags |

#### D2. Frontend UI

**Create:** `frontend/src/app/dashboard/food-library/review/page.tsx`

Or add a "Review Queue" tab to the existing food library page:
- List of unverified food items with their auto-generated tags
- Show each tag with approve/reject buttons
- Allow editing tags before approving
- Bulk approve/reject actions

---

## Definition of Done

### Session Notes
- [ ] Service, controller, routes created and registered
- [ ] Zod validation schema applied
- [ ] Frontend hook created
- [ ] "Session Notes" tab in client detail page
- [ ] SOAP/DAP form with all fields
- [ ] Edit and soft-delete working

### Invoicing
- [ ] Service with auto-numbering, controller, routes created
- [ ] Invoice PDF generation working
- [ ] Email sending with PDF attachment working
- [ ] Invoices list page with filtering
- [ ] Create invoice form with dynamic line items
- [ ] Invoice detail page with actions (send, mark paid, download)
- [ ] "Invoices" added to sidebar navigation

### Activity Logging
- [ ] Service created with generic log method
- [ ] Logging triggers added to 8+ existing controllers
- [ ] Admin audit log page created
- [ ] Client activity feed in client detail page

### Tag Review
- [ ] 3 endpoints created (list unverified, verify, reject)
- [ ] Review queue UI in food library
</file>

<file path="doc/11-mobile-screens-completion.md">
# Module 11: Mobile App Screens Completion

**Priority:** P1
**Effort:** 3-4 days
**Impact:** Client-facing app must be fully functional for launch

---

## Current State

| Screen | Completeness | Key Issue |
|--------|-------------|-----------|
| Home (today's meals) | 85% | Working well |
| Meal detail/logging `[id].tsx` | 85% | Photo upload works, minor hardcoded values |
| Weight tracking | 90% | Excellent UI, chart is placeholder |
| **Progress** | **80%** | **Chart is just a line, no real visualization** |
| **Notifications** | **40%** | **100% mock data, no API integration** |
| **Profile** | **75%** | **Hardcoded values, missing sections** |
| Profile > Referral | Exists | Needs verification |
| Profile > Reports | Exists | Needs verification |

---

## What Needs To Be Done

### 1. Complete Notifications Screen

**File:** `client-app/app/(tabs)/notifications/index.tsx`

**Current state:** 5 hardcoded mock notifications, refresh is a TODO stub.

#### 1.1 Replace Mock Data with API Integration

- Remove hardcoded notification array (lines 19-60)
- Use `useNotifications()` hook (created in Module 9)
- Fetch from `GET /api/v1/client/notifications`

#### 1.2 Implement Real Functionality

| Feature | Current | Needed |
|---------|---------|--------|
| Data source | Hardcoded array | API via React Query |
| Pull-to-refresh | Stubbed (TODO comment) | `onRefresh` with query refetch |
| Mark as read | Not implemented | `PATCH /notifications/:id/read` on tap |
| Deep link navigation | Not implemented | Navigate to meal/weight screen on tap |
| Empty state | Exists | Keep as-is |
| Loading state | Not present | Add loading spinner |
| Error state | Not present | Add error with retry |
| Unread indicator | Hardcoded | Dynamic from API `isRead` field |

#### 1.3 Add Notification Type Icons

Map notification types to correct icons:
```
meal_reminder     -> Clock icon
dietitian_feedback -> CheckCircle icon
photo_uploaded    -> Camera icon
weight_logged     -> Scale icon
plan_published    -> FileText icon
achievement       -> Award icon
weekly_checkin    -> Calendar icon
```

---

### 2. Complete Progress Screen

**File:** `client-app/app/(tabs)/progress/index.tsx`

**Current state:** Weight input modal works, chart is a simple horizontal line placeholder.

#### 2.1 Add Real Weight Chart

Replace the placeholder line (lines 95-110) with an actual chart visualization.

**Options:**
- `react-native-chart-kit` (simple, works with Expo)
- `victory-native` (more customizable)
- `react-native-gifted-charts` (modern, performant)

The chart should show:
- X-axis: dates (last 8 weeks or configurable)
- Y-axis: weight in kg
- Line connecting data points
- Target weight as a horizontal dashed line
- Current weight highlighted
- Tap on data point to see exact value and date

#### 2.2 Add Compliance/Adherence Section

Below the weight chart, add a section showing (data from Module 6's compliance service):
- This week's meal adherence percentage
- Daily completion dots (7 dots, green/yellow/red/gray)
- Meal logging streak counter ("12 days in a row!")
- Comparison with last week

#### 2.3 Add Body Measurements Section (Optional)

If body measurements exist (from onboarding Step 6):
- Show latest measurements
- Show change from first measurement
- "Update Measurements" button

---

### 3. Complete Profile Screen

**File:** `client-app/app/(tabs)/profile/index.tsx`

**Current state:** Profile card works, logout works, several sections are stubbed.

#### 3.1 Fix Hardcoded Values

| Issue | Location | Fix |
|-------|----------|-----|
| Subscription renewal date shows `-- / -- / ----` | line 121 | Fetch from API or show plan end date |
| Privacy & Security shows "Coming Soon" alert | line 158 | Either implement or remove from menu |
| Help shows static alert with email | line 163 | Either link to support page or keep with real email |

#### 3.2 Wire Referral Screen

**File:** `client-app/app/(tabs)/profile/referral.tsx`

Verify this screen:
- Shows client's referral code
- Shows how many people they've referred
- Shows benefit earned (free months)
- Share referral code button (WhatsApp, copy to clipboard)

#### 3.3 Wire Reports Screen

**File:** `client-app/app/(tabs)/profile/reports.tsx`

Verify this screen:
- Lists uploaded medical reports
- Upload new report button (camera/gallery/file picker)
- View/download existing reports
- Integrates with reports controller (`GET /client/reports`)

#### 3.4 Add Edit Profile Functionality

Currently profile data is display-only. Add:
- "Edit" button on profile card
- Edit screen for: name, phone, profile photo
- Save changes via `PATCH /client/profile`

---

### 4. Enhance Meal Detail Screen

**File:** `client-app/app/(tabs)/home/meal/[id].tsx`

**Current state:** 85% complete, feature-rich.

#### 4.1 Fix Minor Issues

| Issue | Fix |
|-------|-----|
| Scheduled time display hardcoded via route params | Fetch from meal data |
| No image compression before upload | Add image compression (< 2MB as per PRD) |
| No upload progress indicator | Add progress bar during photo upload |

#### 4.2 Add Nutrition Info Display

When viewing a logged meal, show the planned nutrition:
- Calories, protein, carbs, fats
- Per-food-item breakdown (if available from meal's food items)

#### 4.3 Add Substitute Flow

When client selects "Substituted" status:
- Show text input for substitute description
- Optional: show food search to log what they actually ate
- Capture estimated calories of substitute

---

### 5. Improve Home Screen

**File:** `client-app/app/(tabs)/home/index.tsx`

#### 5.1 Add Daily Progress Bar

At the top of the home screen:
- "2 of 4 meals logged today" with progress bar
- Color: green when 100%, yellow when partial, gray when none

#### 5.2 Add Streak Counter

Below the date header:
- "Day 12 streak" with flame icon (if client has been logging consistently)
- Motivational message based on streak length

#### 5.3 Add Dietitian Feedback Badges

On each meal card, if the dietitian has reviewed it:
- Small badge showing review status
- Green check for positive, yellow warning for improvement needed

---

### 6. Handle Offline State

**Create:** `client-app/components/OfflineBanner.tsx`

Add to `_layout.tsx`:
- Detect network connectivity
- Show a banner at top: "You're offline. Data will sync when connected."
- Queue meal logs and weight entries for when back online
- React Query's `networkMode: 'offlineFirst'` handles this partially

---

### 7. Add Onboarding Prompt

If `onboardingCompleted` is false when the app launches, redirect to the onboarding flow instead of home screen.

**File:** `client-app/app/index.tsx` or `client-app/app/(tabs)/_layout.tsx`

Check on mount:
```
if (client.onboardingCompleted === false) {
  router.replace('/(onboarding)/step1');
}
```

---

## Definition of Done

- [ ] Notifications screen fetches real data from API (zero mock data)
- [ ] Pull-to-refresh, mark-as-read, deep link navigation working
- [ ] Notification type icons correctly mapped
- [ ] Progress screen has a real weight chart (not a placeholder line)
- [ ] Progress screen shows weekly adherence data
- [ ] Profile screen has no hardcoded values
- [ ] Referral screen verified and functional
- [ ] Reports screen verified and functional
- [ ] Edit profile functionality added
- [ ] Meal detail shows nutrition info
- [ ] Image compression before upload (< 2MB)
- [ ] Upload progress indicator on photo upload
- [ ] Home screen shows daily progress bar
- [ ] Offline banner component created
- [ ] Onboarding redirect works for incomplete onboarding
</file>

<file path="doc/12-dashboard-pages-completion.md">
# Module 12: Dashboard Pages Completion & Deployment

**Priority:** P2
**Effort:** 4-5 days
**Impact:** Completes the dietitian-facing dashboard for production

---

## Current State

| Page | Completeness | Key Issue |
|------|-------------|-----------|
| Dashboard (home) | 85% | Stats from API, but some values may be stale |
| Clients list | 90% | Production-ready |
| Client detail `[id]` | 75% | Tab switching not implemented, missing sections |
| Diet plans list | 85% | Working |
| Diet plan detail `[id]` | 80% | Working, edit mode exists |
| Diet plan new | 60% | 830-line monolith (covered in Module 02) |
| Food library | 85% | Working |
| **Reviews** | **95%** | **Production-ready** |
| **Referrals** | **90%** | **Production-ready** |
| **Analytics** | **60%** | **Simulated data, no real API** |
| **Settings** | **60%** | **4 sections show "Coming Soon"** |
| **Team** | 85% | Working, invite flow exists |

---

## What Needs To Be Done

### 1. Complete Analytics Page

**File:** `frontend/src/app/dashboard/analytics/page.tsx`

**Current state:** 4 stat cards work, but adherence data is randomly generated (`80 + Math.floor(Math.random() * 15)`), and the weekly chart has no real data.

#### 1.1 Create Analytics Backend Endpoint

**Create:** `backend/src/controllers/analytics.controller.ts`
**Create:** `backend/src/routes/analytics.routes.ts`

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/v1/analytics/overview` | Dashboard stats summary |
| GET | `/api/v1/analytics/adherence?period=weekly` | Adherence trend data |
| GET | `/api/v1/analytics/clients?metric=weight_change` | Client-level analytics |

**Overview endpoint should return:**
```json
{
  "totalClients": 45,
  "activeClients": 38,
  "activePlans": 32,
  "pendingReviews": 12,
  "averageAdherence": 78.5,
  "averageWeightChange": -1.8,
  "newClientsThisMonth": 5,
  "mealLogsThisWeek": 156
}
```

**Adherence endpoint should return:**
```json
{
  "period": "weekly",
  "data": [
    { "week": "2026-01-06", "adherence": 72 },
    { "week": "2026-01-13", "adherence": 75 },
    { "week": "2026-01-20", "adherence": 78 },
    { "week": "2026-01-27", "adherence": 81 }
  ],
  "trend": "improving"
}
```

#### 1.2 Create Analytics Hook

**Create:** `frontend/src/lib/hooks/use-analytics.ts`

```typescript
useAnalyticsOverview()    // Stats cards
useAdherenceTrend(period) // Chart data
useClientMetrics(metric)  // Client-level data
```

#### 1.3 Replace Simulated Data

Update `analytics/page.tsx`:
- Replace random adherence values with real API data
- Replace hardcoded weight loss with real aggregate
- Add a real chart library (recharts is already likely a dep with Next.js)
- Show real weekly adherence trend line chart
- Add date range picker for custom periods

#### 1.4 Add Analytics Sections

Expand the page with:
- **Client Performance Table**: Name, adherence %, weight change, last activity
- **Top Performing Clients**: Highest adherence this week
- **Clients Needing Attention**: Declining adherence, no logs in 3+ days
- **Meal Type Breakdown**: Which meals are most skipped (breakfast/lunch/dinner)

---

### 2. Complete Settings Page

**File:** `frontend/src/app/dashboard/settings/page.tsx`

**Current state:** Profile editing works. 4 sections show "Coming soon": Security, Language, Billing, Help.

#### 2.1 Security Section

Replace "Coming Soon" with:
- Password change (redirect to Clerk's password management)
- Two-factor authentication toggle (Clerk handles this)
- Active sessions list (Clerk provides this)

Since auth is via Clerk, most of this is linking to Clerk's hosted UI components.

#### 2.2 Organization Settings

Add a section for organization management (owner/admin only):
- Organization name, logo, description, contact info
- Timezone setting
- Subscription status display
- Uses existing `PATCH /organization` endpoint

#### 2.3 Notification Preferences

Current toggles exist but verify they save to the backend:
- Email notifications on/off
- Push notifications on/off
- Meal log alerts on/off
- Weekly summary on/off

#### 2.4 Billing Section (Owner Only)

- Show current subscription tier and status
- Show expiry date
- Link to upgrade (can be a simple contact link for MVP)
- Uses existing `GET /organization/subscription` endpoint

#### 2.5 Help & Support

Replace "Coming Soon" with:
- Link to documentation
- Support email with prefilled subject
- App version info

---

### 3. Complete Client Detail Page

**File:** `frontend/src/app/dashboard/clients/[id]/page.tsx`

**Current state:** 279 lines. Tab buttons exist but no tab switching logic.

#### 3.1 Implement Tab Navigation

The page shows buttons for different sections but they don't switch content. Implement:

| Tab | Content | Data Source |
|-----|---------|-------------|
| **Overview** | Demographics, vitals, current plan | Client API |
| **Diet Plans** | List of all plans for this client | Diet Plans API |
| **Meal Logs** | Recent meal logs with photos | Meal Logs API |
| **Weight** | Weight chart + history | Weight Logs API |
| **Session Notes** | SOAP/DAP notes list | Session Notes API (Module 10) |
| **Activity** | Recent activity feed | Activity Logs API (Module 10) |

Use `useState` for active tab, render appropriate content component.

#### 3.2 Add Medical Summary Panel

On the right side or as a collapsible panel, show the client's medical summary:
- Allergies (red badges)
- Medical conditions
- Medications
- Diet pattern
- Food dislikes
- Lab-derived flags

This uses the `ClientRestrictionsSummary` component that already exists.

#### 3.3 Add Quick Actions

Add action buttons:
- "Create Diet Plan" -> navigate to diet-plans/new with client pre-selected
- "Log Weight" -> inline weight entry
- "Add Session Note" -> open note form modal

---

### 4. Add Medical Summary Sidebar to Diet Plan Builder

**Source:** remaining.md P1 item

**Where:** Diet plan creation page (after Module 02 refactoring)

**Create:** `frontend/src/components/diet-plan/medical-sidebar.tsx`

This sidebar should be always visible while creating a diet plan, showing:
- Client allergies with red badges
- Intolerances with yellow badges
- Medical conditions
- Current medications
- Diet pattern
- Food dislikes
- Lab alerts (if lab values exist)

The existing `ClientRestrictionsSummary` component covers most of this. Wire it into the diet plan builder's left panel.

---

### 5. Add Share/Export Functionality

**Backend already exists:** `share.controller.ts` has PDF, print, email, WhatsApp endpoints.

#### 5.1 Add Share Buttons to Diet Plan Detail

**File:** `frontend/src/app/dashboard/diet-plans/[id]/page.tsx`

Add action buttons:
- "Download PDF" -> `GET /diet-plans/:id/pdf` (downloads file)
- "Print" -> `GET /diet-plans/:id/print` (opens print-friendly page)
- "Email to Client" -> `POST /diet-plans/:id/email` (shows confirmation)
- "Share via WhatsApp" -> `GET /diet-plans/:id/share-link` (opens WhatsApp)

---

### 6. Deployment Setup

**Priority:** P2 (needed before launch, not before feature development)

#### 6.1 Docker Compose

**Create:** `docker-compose.yml` at project root

Services:
- `postgres` - Database
- `backend` - Node.js API
- `frontend` - Next.js dashboard
- `nginx` - Reverse proxy with SSL

#### 6.2 Backend Dockerfile

**Create:** `backend/Dockerfile`

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY dist/ ./dist/
COPY prisma/ ./prisma/
RUN npx prisma generate
EXPOSE 3000
CMD ["node", "dist/server.js"]
```

#### 6.3 Frontend Dockerfile

**Create:** `frontend/Dockerfile`

```dockerfile
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:18-alpine
WORKDIR /app
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
EXPOSE 3001
CMD ["npm", "start"]
```

#### 6.4 Nginx Configuration

**Create:** `nginx/nginx.conf`

- Reverse proxy: `/api/*` -> backend:3000
- Reverse proxy: `/*` -> frontend:3001
- SSL termination with Let's Encrypt
- Gzip compression
- Static file caching headers
- Upload size limit (10MB for photos)

#### 6.5 Environment Files

**Create:** `.env.example` at root with all required variables documented.

Verify `backend/.env.example` has:
- DATABASE_URL
- CLERK_SECRET_KEY
- S3_ENDPOINT, S3_ACCESS_KEY, S3_SECRET_KEY, S3_BUCKET
- SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS
- EXPO_ACCESS_TOKEN (for push notifications)

---

## Definition of Done

### Analytics
- [ ] Backend analytics endpoints created (overview, adherence, clients)
- [ ] Analytics hook created
- [ ] Real data replaces all simulated/random values
- [ ] Weekly adherence chart renders with real data
- [ ] Client performance table added
- [ ] "Needs attention" alert list added

### Settings
- [ ] Security section links to Clerk password/2FA management
- [ ] Organization settings section for owner/admin
- [ ] Notification preferences save to backend
- [ ] Billing section shows subscription info
- [ ] Help section has support email link

### Client Detail
- [ ] Tab navigation implemented (6 tabs)
- [ ] Each tab renders appropriate content
- [ ] Medical summary panel visible
- [ ] Quick action buttons (create plan, log weight, add note)

### Share/Export
- [ ] PDF download button on diet plan detail
- [ ] Print view button
- [ ] Email to client button with confirmation
- [ ] WhatsApp share link

### Deployment
- [ ] docker-compose.yml working with all services
- [ ] Backend Dockerfile tested
- [ ] Frontend Dockerfile tested
- [ ] Nginx configured with SSL
- [ ] All env vars documented in .env.example
</file>

<file path="frontend/src/app/dashboard/clients/new/page.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

// Redirect to clients page - new client is handled via modal
export default function NewClientPage() {
    const router = useRouter();

    useEffect(() => {
        router.replace('/dashboard/clients');
    }, [router]);

    return (
        <div className="flex items-center justify-center h-64">
            <p className="text-gray-500">Redirecting...</p>
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/food-library/page.tsx">
'use client';

import { useState } from 'react';
import {
    Search,
    Plus,
    Grid,
    List,
    Loader2,
} from 'lucide-react';
import { useFoodItems, FoodItem } from '@/lib/hooks/use-food-items';
import { CreateFoodItemModal } from '@/components/modals/create-food-item-modal';

const categories = ['All', 'Grains', 'Proteins', 'Vegetables', 'Fruits', 'Dairy', 'Beverages'];

export default function FoodLibraryPage() {
    const [search, setSearch] = useState('');
    const [category, setCategory] = useState('All');
    const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [editingItem, setEditingItem] = useState<FoodItem | undefined>(undefined);

    // API hook
    const { data, isLoading, error } = useFoodItems({
        q: search || undefined,
        category: category !== 'All' ? category : undefined,
        pageSize: 50,
    });

    const foodItems = data?.data || [];

    const handleEdit = (item: FoodItem) => {
        setEditingItem(item);
        setShowCreateModal(true);
    };

    const handleCloseModal = () => {
        setShowCreateModal(false);
        setEditingItem(undefined);
    };

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-bold tracking-tight text-gray-900">Food Library</h1>
                    <p className="text-[#4e9767] mt-1">Browse and manage food items for diet plans.</p>
                </div>
                <button
                    onClick={() => setShowCreateModal(true)}
                    className="flex items-center gap-2 h-10 px-4 bg-[#17cf54] hover:bg-[#17cf54]/90 text-white rounded-lg text-sm font-bold transition-colors shadow-sm"
                >
                    <Plus className="w-4 h-4" />
                    Add Food Item
                </button>
            </div>

            {/* Search and Filters */}
            <div className="flex flex-col md:flex-row gap-4">
                {/* Search Bar */}
                <div className="flex-grow max-w-md">
                    <label className="flex h-12 w-full">
                        <div className="flex w-full flex-1 items-stretch rounded-lg h-full bg-gray-100">
                            <div className="flex items-center justify-center pl-4 text-[#4e9767]">
                                <Search className="w-5 h-5" />
                            </div>
                            <input
                                className="flex w-full min-w-0 flex-1 bg-transparent h-full placeholder:text-gray-400 pl-3 pr-4 text-base outline-none text-gray-900"
                                placeholder="Search food items..."
                                value={search}
                                onChange={(e) => setSearch(e.target.value)}
                            />
                        </div>
                    </label>
                </div>

                {/* View Mode Toggle */}
                <div className="flex items-center gap-2 ml-auto">
                    <button
                        onClick={() => setViewMode('grid')}
                        className={`p-2 rounded-lg ${viewMode === 'grid' ? 'bg-[#17cf54]/10 text-[#17cf54]' : 'text-gray-500 hover:bg-gray-100'}`}
                    >
                        <Grid className="w-5 h-5" />
                    </button>
                    <button
                        onClick={() => setViewMode('list')}
                        className={`p-2 rounded-lg ${viewMode === 'list' ? 'bg-[#17cf54]/10 text-[#17cf54]' : 'text-gray-500 hover:bg-gray-100'}`}
                    >
                        <List className="w-5 h-5" />
                    </button>
                </div>
            </div>

            {/* Category Chips */}
            <div className="flex gap-2 flex-wrap">
                {categories.map((cat) => (
                    <button
                        key={cat}
                        onClick={() => setCategory(cat)}
                        className={`flex h-8 shrink-0 items-center justify-center px-4 rounded-lg text-sm font-medium transition-colors ${category === cat
                            ? 'bg-[#17cf54] text-white'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                    >
                        {cat}
                    </button>
                ))}
            </div>

            {/* Loading */}
            {isLoading && (
                <div className="flex items-center justify-center py-12">
                    <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
                </div>
            )}

            {/* Error */}
            {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
                    Failed to load food items. Please try again.
                </div>
            )}

            {/* Empty */}
            {!isLoading && !error && foodItems.length === 0 && (
                <div className="text-center py-12 bg-white rounded-lg border border-gray-200">
                    <p className="text-gray-500">No food items found.</p>
                </div>
            )}

            {/* Grid View */}
            {!isLoading && foodItems.length > 0 && viewMode === 'grid' && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {foodItems.map((item: FoodItem) => (
                        <div
                            key={item.id}
                            className="flex flex-col rounded-xl border border-gray-200 bg-white overflow-hidden hover:shadow-lg transition-shadow group relative"
                        >
                            <div className="h-32 bg-gradient-to-br from-[#17cf54]/20 to-[#17cf54]/5 flex items-center justify-center relative">
                                <span className="text-4xl">🍽️</span>
                                {/* Edit Button Overlay */}
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        handleEdit(item);
                                    }}
                                    className="absolute top-2 right-2 p-1.5 bg-white/90 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white text-gray-600 hover:text-[#17cf54]"
                                    title="Edit Food Item"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /><path d="m15 5 4 4" /></svg>
                                </button>
                            </div>
                            <div className="p-4 flex flex-col flex-grow">
                                <div className="flex items-start justify-between gap-2 mb-2">
                                    <h3 className="font-semibold text-gray-900">{item.name}</h3>
                                    {item.isVerified && (
                                        <span className="px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">
                                            Verified
                                        </span>
                                    )}
                                </div>
                                <p className="text-sm text-gray-600 mb-3">
                                    {item.servingSize} serving
                                </p>
                                <div className="mt-auto grid grid-cols-4 gap-2 text-center text-xs">
                                    <div className="bg-gray-50 rounded p-2">
                                        <p className="font-bold text-gray-900">{item.nutrition?.calories || 0}</p>
                                        <p className="text-gray-500">kcal</p>
                                    </div>
                                    <div className="bg-gray-50 rounded p-2">
                                        <p className="font-bold text-gray-900">{item.nutrition?.proteinG || 0}g</p>
                                        <p className="text-gray-500">protein</p>
                                    </div>
                                    <div className="bg-gray-50 rounded p-2">
                                        <p className="font-bold text-gray-900">{item.nutrition?.carbsG || 0}g</p>
                                        <p className="text-gray-500">carbs</p>
                                    </div>
                                    <div className="bg-gray-50 rounded p-2">
                                        <p className="font-bold text-gray-900">{item.nutrition?.fatsG || 0}g</p>
                                        <p className="text-gray-500">fat</p>
                                    </div>
                                </div>
                                {item.dietaryTags?.length > 0 && (
                                    <div className="mt-3 flex flex-wrap gap-1">
                                        {item.dietaryTags.slice(0, 3).map((tag) => (
                                            <span key={tag} className="px-2 py-0.5 text-xs bg-[#17cf54]/10 text-[#17cf54] rounded-full">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {/* List View */}
            {!isLoading && foodItems.length > 0 && viewMode === 'list' && (
                <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <table className="w-full">
                        <thead>
                            <tr className="bg-gray-50">
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Serving</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Calories</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Protein</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Carbs</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fat</th>
                                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                            {foodItems.map((item: FoodItem) => (
                                <tr key={item.id} className="hover:bg-gray-50 group">
                                    <td className="px-6 py-4 font-medium text-gray-900">
                                        {item.name}
                                        {item.isVerified && (
                                            <span className="ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full">
                                                ✓
                                            </span>
                                        )}
                                    </td>
                                    <td className="px-6 py-4 text-gray-600 capitalize">{item.category}</td>
                                    <td className="px-6 py-4 text-gray-600">{item.servingSize}</td>
                                    <td className="px-6 py-4 text-gray-600">{item.nutrition?.calories || 0}</td>
                                    <td className="px-6 py-4 text-gray-600">{item.nutrition?.proteinG || 0}g</td>
                                    <td className="px-6 py-4 text-gray-600">{item.nutrition?.carbsG || 0}g</td>
                                    <td className="px-6 py-4 text-gray-600">{item.nutrition?.fatsG || 0}g</td>
                                    <td className="px-6 py-4 text-right">
                                        <button
                                            onClick={() => handleEdit(item)}
                                            className="p-1 text-gray-400 hover:text-[#17cf54] opacity-0 group-hover:opacity-100 transition-opacity"
                                            title="Edit"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /><path d="m15 5 4 4" /></svg>
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}

            <CreateFoodItemModal
                isOpen={showCreateModal}
                onClose={handleCloseModal}
                initialData={editingItem}
            />
        </div>
    );
}
</file>

<file path="frontend/src/app/sign-in/[[...sign-in]]/page.tsx">
import { SignIn } from '@clerk/nextjs';

export default function SignInPage() {
    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-50 to-teal-100">
            <div className="w-full max-w-md">
                <div className="text-center mb-8">
                    <h1 className="text-3xl font-bold text-emerald-800">DietConnect</h1>
                    <p className="text-gray-600 mt-2">Sign in to your account</p>
                </div>
                <SignIn
                    appearance={{
                        elements: {
                            formButtonPrimary: 'bg-emerald-600 hover:bg-emerald-700',
                            card: 'shadow-xl',
                        }
                    }}
                />
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/app/sign-up/[[...sign-up]]/page.tsx">
import { SignUp } from '@clerk/nextjs';

export default function SignUpPage() {
    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-50 to-teal-100">
            <div className="w-full max-w-md">
                <div className="text-center mb-8">
                    <h1 className="text-3xl font-bold text-emerald-800">DietConnect</h1>
                    <p className="text-gray-600 mt-2">Create your account</p>
                </div>
                <SignUp
                    appearance={{
                        elements: {
                            formButtonPrimary: 'bg-emerald-600 hover:bg-emerald-700',
                            card: 'shadow-xl',
                        }
                    }}
                />
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  color: var(--foreground);
  background: var(--background);
  font-family: Arial, Helvetica, sans-serif;
}

@layer utilities {
  .text-balance {
    text-wrap: balance;
  }
}
</file>

<file path="frontend/src/app/layout.tsx">
import type { Metadata } from "next";
import localFont from "next/font/local";
import "./globals.css";
import { ClerkProvider } from "@clerk/nextjs";
import { Providers } from "./providers";

const geistSans = localFont({
  src: "./fonts/GeistVF.woff",
  variable: "--font-geist-sans",
  weight: "100 900",
});
const geistMono = localFont({
  src: "./fonts/GeistMonoVF.woff",
  variable: "--font-geist-mono",
  weight: "100 900",
});

export const metadata: Metadata = {
  title: "DietConnect - Nutrition Practice Management",
  description: "Professional diet planning and client management for dietitians",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body
          className={`${geistSans.variable} ${geistMono.variable} antialiased`}
        >
          <Providers>{children}</Providers>
        </body>
      </html>
    </ClerkProvider>
  );
}
</file>

<file path="frontend/src/app/page.tsx">
import { auth } from '@clerk/nextjs/server';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import {
  Leaf,
  UtensilsCrossed,
  Users,
  BarChart3,
  Calendar,
  Shield,
  Smartphone,
  ArrowRight,
  Quote,
  CheckCircle,
  Menu,
} from 'lucide-react';

const features = [
  {
    icon: UtensilsCrossed,
    title: 'Smart Meal Planning',
    description: 'AI-assisted drag-and-drop diet creation. Create balanced plans in seconds, not hours.',
  },
  {
    icon: Users,
    title: 'Client Portal',
    description: 'Secure direct messaging, document sharing, and progress tracking for your clients.',
  },
  {
    icon: BarChart3,
    title: 'Data Analytics',
    description: 'Visualize health trends, weight changes, and adherence rates instantly with beautiful charts.',
  },
  {
    icon: Calendar,
    title: 'Scheduling & Booking',
    description: 'Integrated calendar that syncs with Google and Outlook. Reduce no-shows with automated reminders.',
  },
  {
    icon: Shield,
    title: 'Secure & Compliant',
    description: 'Enterprise-grade security keeps your patient data safe and compliant with regulations.',
  },
  {
    icon: Smartphone,
    title: 'Mobile Companion App',
    description: 'Give clients a dedicated app to log meals, view plans, and stay connected on the go.',
  },
];

const testimonials = [
  {
    quote: "Diet Karo cut my administrative time in half. The meal planning tool is intuitive and my clients love the mobile app. It's a game changer.",
    name: 'Dr. Priya Sharma',
    role: 'Clinical Dietician',
    avatar: 'PS',
  },
  {
    quote: "Finally, a dashboard that looks good and works even better. The analytics feature helps me show tangible progress to my patients.",
    name: 'Rahul Verma',
    role: 'Sports Nutritionist',
    avatar: 'RV',
  },
  {
    quote: "The automated compliance features give me peace of mind. I can manage more clients without feeling overwhelmed. Highly recommended.",
    name: 'Dr. Anjali Mehta',
    role: 'Private Practice Owner',
    avatar: 'AM',
  },
];

const stats = [
  { value: '10k+', label: 'Professionals' },
  { value: '2M+', label: 'Meal Plans Created' },
  { value: '98%', label: 'Customer Satisfaction' },
];

export default async function HomePage() {
  const { userId } = await auth();

  // If user is logged in, redirect to dashboard
  if (userId) {
    redirect('/dashboard');
  }

  return (
    <div className="min-h-screen bg-[#f6f8f6] text-[#0e1b12] font-sans antialiased overflow-x-hidden">
      {/* Navigation */}
      <nav className="sticky top-0 z-50 w-full border-b border-[#e7f3eb] bg-[#f6f8f6]/80 backdrop-blur-md">
        <div className="max-w-7xl mx-auto px-4 sm:px-10 py-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="flex items-center justify-center w-8 h-8 rounded-lg bg-[#17cf54]/20 text-[#17cf54]">
                <Leaf className="w-5 h-5" />
              </div>
              <span className="text-lg font-bold tracking-tight">Diet Karo</span>
            </div>
            <div className="hidden md:flex items-center gap-8">
              <a href="#features" className="text-sm font-medium hover:text-[#17cf54] transition-colors">Features</a>
              <a href="#pricing" className="text-sm font-medium hover:text-[#17cf54] transition-colors">Pricing</a>
              <a href="#about" className="text-sm font-medium hover:text-[#17cf54] transition-colors">About</a>
            </div>
            <div className="hidden md:flex items-center gap-2">
              <Link
                href="/sign-in"
                className="px-4 py-2 text-sm font-bold hover:bg-black/5 rounded-lg transition-colors"
              >
                Login
              </Link>
              <Link
                href="/sign-up"
                className="px-4 py-2 text-sm font-bold bg-[#17cf54] hover:bg-[#17cf54]/90 text-[#0e1b12] rounded-lg shadow-sm shadow-[#17cf54]/20 transition-colors"
              >
                Get Started
              </Link>
            </div>
            <button className="md:hidden p-2">
              <Menu className="w-6 h-6" />
            </button>
          </div>
        </div>
      </nav>

      {/* Hero Section */}
      <div className="relative w-full">
        <div className="absolute top-0 right-0 -z-10 w-1/2 h-full bg-gradient-to-l from-[#17cf54]/5 to-transparent" />
        <div className="max-w-7xl mx-auto px-4 md:px-10 lg:px-20 py-16 lg:py-24">
          <div className="flex flex-col lg:flex-row items-center gap-12 lg:gap-16">
            {/* Hero Content */}
            <div className="flex flex-col gap-6 flex-1 text-center lg:text-left">
              <div className="inline-flex items-center gap-2 self-center lg:self-start px-3 py-1 rounded-full bg-[#17cf54]/10 border border-[#17cf54]/20 text-xs font-bold text-[#17cf54] uppercase tracking-wide">
                <span className="w-2 h-2 rounded-full bg-[#17cf54] animate-pulse" />
                New: AI Meal Planning
              </div>
              <h1 className="text-4xl sm:text-5xl lg:text-6xl font-black leading-tight tracking-tight">
                Empower Your Practice with{' '}
                <span className="text-[#17cf54]">Intelligent</span> Nutrition.
              </h1>
              <p className="text-lg text-[#0e1b12]/70 max-w-2xl mx-auto lg:mx-0">
                Streamline client tracking, automate meal plans, and visualize patient progress in one secure dashboard tailored for modern dieticians.
              </p>
              <div className="flex flex-wrap gap-3 justify-center lg:justify-start">
                <Link
                  href="/sign-up"
                  className="flex items-center justify-center gap-2 min-w-[140px] h-12 px-6 bg-[#17cf54] hover:bg-[#17cf54]/90 text-[#0e1b12] text-base font-bold rounded-lg shadow-lg shadow-[#17cf54]/25 transition-all"
                >
                  Start Free Trial
                  <ArrowRight className="w-4 h-4" />
                </Link>
                <Link
                  href="/sign-in"
                  className="flex items-center justify-center min-w-[140px] h-12 px-6 bg-white border border-[#e7f3eb] hover:bg-[#f0fdf4] text-base font-bold rounded-lg transition-all"
                >
                  Book a Demo
                </Link>
              </div>
              <div className="flex items-center justify-center lg:justify-start gap-4 pt-2">
                <div className="flex -space-x-2">
                  {['PS', 'RK', 'AM'].map((initials, i) => (
                    <div
                      key={i}
                      className="w-8 h-8 rounded-full bg-[#17cf54]/20 border-2 border-white flex items-center justify-center text-xs font-bold text-[#17cf54]"
                    >
                      {initials}
                    </div>
                  ))}
                  <div className="w-8 h-8 rounded-full bg-[#17cf54] text-[#0e1b12] text-[10px] font-bold border-2 border-white flex items-center justify-center">
                    +2k
                  </div>
                </div>
                <p className="text-sm font-medium text-[#0e1b12]/60">Professionals trust us</p>
              </div>
            </div>

            {/* Hero Image */}
            <div className="w-full lg:w-1/2 flex justify-center lg:justify-end relative">
              <div className="absolute -inset-4 bg-[#17cf54]/20 blur-3xl rounded-full opacity-30" />
              <div className="relative w-full aspect-[4/3] rounded-xl overflow-hidden shadow-2xl border border-black/5 bg-white">
                <div className="w-full h-full bg-gradient-to-br from-[#f0fdf4] to-[#e7f3eb] flex items-center justify-center">
                  <div className="text-center p-8">
                    <div className="w-24 h-24 mx-auto bg-[#17cf54]/10 rounded-2xl flex items-center justify-center mb-4">
                      <UtensilsCrossed className="w-12 h-12 text-[#17cf54]" />
                    </div>
                    <h3 className="text-xl font-bold text-[#0e1b12]">Diet Dashboard</h3>
                    <p className="text-sm text-[#0e1b12]/60 mt-2">Analytics • Plans • Progress</p>
                  </div>
                </div>
                {/* Floating notification */}
                <div className="absolute bottom-6 left-6 p-4 bg-white rounded-lg shadow-lg border border-[#17cf54]/10 flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-[#17cf54]">
                    <CheckCircle className="w-5 h-5" />
                  </div>
                  <div>
                    <p className="text-xs text-[#0e1b12]/50 font-medium">Daily Goal</p>
                    <p className="text-sm font-bold text-[#0e1b12]">Meal Plan Added</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Features Section */}
      <div id="features" className="w-full bg-white py-20">
        <div className="max-w-7xl mx-auto px-4 md:px-10">
          <div className="text-center mb-12">
            <span className="text-[#17cf54] font-bold tracking-wider text-sm uppercase mb-2 block">
              Core Features
            </span>
            <h2 className="text-3xl md:text-4xl font-bold tracking-tight">
              Everything you need to run a modern clinic
            </h2>
            <p className="mt-4 text-[#0e1b12]/60 max-w-2xl mx-auto">
              Focus on your patients while we handle the administration, planning, and tracking.
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {features.map((feature, i) => (
              <div
                key={i}
                className="group flex flex-col gap-4 rounded-xl border border-[#d0e7d7] bg-[#f6f8f6] p-6 transition-all hover:shadow-lg hover:border-[#17cf54]/50"
              >
                <div className="w-12 h-12 rounded-lg bg-[#17cf54]/10 flex items-center justify-center text-[#17cf54] group-hover:bg-[#17cf54] group-hover:text-[#0e1b12] transition-colors">
                  <feature.icon className="w-6 h-6" />
                </div>
                <div>
                  <h3 className="text-xl font-bold">{feature.title}</h3>
                  <p className="text-[#4e9767] text-sm leading-relaxed mt-2">
                    {feature.description}
                  </p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Stats Section */}
      <div className="w-full bg-[#17cf54]/5 border-y border-[#17cf54]/10 py-12">
        <div className="max-w-7xl mx-auto px-4 sm:px-10">
          <div className="flex flex-wrap justify-around items-center gap-8 text-center">
            {stats.map((stat, i) => (
              <div key={i} className="flex flex-col gap-1">
                <span className="text-4xl font-black tracking-tight">{stat.value}</span>
                <span className="text-sm font-medium text-[#4e9767] uppercase tracking-wider">
                  {stat.label}
                </span>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Testimonials Section */}
      <div className="w-full py-20 bg-[#f6f8f6]">
        <div className="max-w-7xl mx-auto px-4 md:px-10">
          <div className="text-center mb-16">
            <h2 className="text-3xl font-bold tracking-tight">
              Trusted by Top Nutritionists
            </h2>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            {testimonials.map((testimonial, i) => (
              <div
                key={i}
                className="flex flex-col justify-between p-8 bg-white rounded-2xl shadow-sm border border-[#e7f3eb]"
              >
                <div className="mb-6 text-[#17cf54]">
                  <Quote className="w-10 h-10" />
                </div>
                <p className="text-lg font-medium leading-relaxed mb-8">
                  &ldquo;{testimonial.quote}&rdquo;
                </p>
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 rounded-full bg-[#17cf54]/20 flex items-center justify-center text-[#17cf54] font-bold">
                    {testimonial.avatar}
                  </div>
                  <div>
                    <h4 className="font-bold">{testimonial.name}</h4>
                    <p className="text-sm text-[#4e9767]">{testimonial.role}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* CTA Section */}
      <div className="py-20 px-4">
        <div className="max-w-7xl mx-auto bg-[#0e1b12] rounded-3xl overflow-hidden relative">
          <div
            className="absolute inset-0 opacity-20"
            style={{
              backgroundImage: 'radial-gradient(#17cf54 1px, transparent 1px)',
              backgroundSize: '30px 30px',
            }}
          />
          <div className="relative z-10 flex flex-col md:flex-row items-center justify-between p-10 md:p-16 gap-10">
            <div className="flex flex-col gap-6 max-w-2xl">
              <h2 className="text-3xl md:text-5xl font-bold text-white leading-tight">
                Ready to modernize your practice?
              </h2>
              <p className="text-white/80 text-lg">
                Join thousands of health professionals using Diet Karo to deliver better care.
              </p>
              <div className="flex flex-col sm:flex-row gap-4 pt-4">
                <Link
                  href="/sign-up"
                  className="flex items-center justify-center rounded-lg h-12 px-8 bg-[#17cf54] hover:bg-[#17cf54]/90 text-[#0e1b12] text-base font-bold shadow-lg shadow-[#17cf54]/30 transition-all"
                >
                  Get Started Now
                </Link>
                <Link
                  href="/sign-in"
                  className="flex items-center justify-center rounded-lg h-12 px-8 bg-white/10 hover:bg-white/20 text-white text-base font-bold border border-white/20 transition-all"
                >
                  Contact Sales
                </Link>
              </div>
            </div>
            <div className="hidden lg:block relative">
              <div className="w-64 h-64 bg-[#17cf54]/20 rounded-full blur-3xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" />
              <Leaf className="w-48 h-48 text-[#17cf54]/30 rotate-12" />
            </div>
          </div>
        </div>
      </div>

      {/* Footer */}
      <footer className="bg-white border-t border-[#e7f3eb] pt-16 pb-8">
        <div className="max-w-7xl mx-auto px-4 sm:px-10">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-10 mb-16">
            {/* Brand */}
            <div className="col-span-2 md:col-span-1 flex flex-col gap-6">
              <div className="flex items-center gap-2">
                <div className="w-6 h-6 rounded bg-[#17cf54]/20 text-[#17cf54] flex items-center justify-center">
                  <Leaf className="w-4 h-4" />
                </div>
                <span className="font-bold text-lg">Diet Karo</span>
              </div>
              <p className="text-sm text-[#0e1b12]/60">
                The all-in-one platform for nutrition professionals to manage clients, plans, and progress.
              </p>
            </div>
            {/* Links */}
            <div className="flex flex-col gap-4">
              <h4 className="font-bold">Product</h4>
              <a href="#" className="text-sm text-[#0e1b12]/60 hover:text-[#17cf54] transition-colors">Features</a>
              <a href="#" className="text-sm text-[#0e1b12]/60 hover:text-[#17cf54] transition-colors">Pricing</a>
              <a href="#" className="text-sm text-[#0e1b12]/60 hover:text-[#17cf54] transition-colors">Case Studies</a>
            </div>
            <div className="flex flex-col gap-4">
              <h4 className="font-bold">Company</h4>
              <a href="#" className="text-sm text-[#0e1b12]/60 hover:text-[#17cf54] transition-colors">About</a>
              <a href="#" className="text-sm text-[#0e1b12]/60 hover:text-[#17cf54] transition-colors">Careers</a>
              <a href="#" className="text-sm text-[#0e1b12]/60 hover:text-[#17cf54] transition-colors">Contact</a>
            </div>
            <div className="flex flex-col gap-4">
              <h4 className="font-bold">Legal</h4>
              <a href="#" className="text-sm text-[#0e1b12]/60 hover:text-[#17cf54] transition-colors">Privacy Policy</a>
              <a href="#" className="text-sm text-[#0e1b12]/60 hover:text-[#17cf54] transition-colors">Terms of Service</a>
              <a href="#" className="text-sm text-[#0e1b12]/60 hover:text-[#17cf54] transition-colors">Cookie Policy</a>
            </div>
          </div>
          <div className="border-t border-[#e7f3eb] pt-8 text-center">
            <p className="text-sm text-[#0e1b12]/40">
              © 2025 Diet Karo. All rights reserved.
            </p>
          </div>
        </div>
      </footer>
    </div>
  );
}
</file>

<file path="frontend/src/app/providers.tsx">
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useState } from 'react';

export function Providers({ children }: { children: React.ReactNode }) {
    const [queryClient] = useState(
        () =>
            new QueryClient({
                defaultOptions: {
                    queries: {
                        staleTime: 60 * 1000, // 1 minute
                        refetchOnWindowFocus: false,
                    },
                },
            })
    );

    return (
        <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
    );
}
</file>

<file path="frontend/src/components/diet-plan/client-info-card.tsx">
'use client';

import { getInitials } from '@/lib/utils/formatters';
import { ClientRestrictionsSummary } from './client-restrictions-summary';
import type { ClientData } from '@/lib/types/diet-plan.types';

interface ClientInfoCardProps {
    client: ClientData | null | undefined;
    isTemplateMode: boolean;
}

export function ClientInfoCard({ client, isTemplateMode }: ClientInfoCardProps) {
    if (isTemplateMode) {
        return (
            <>
                <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold">
                            T
                        </div>
                        <div>
                            <h1 className="text-gray-900 font-medium">Template</h1>
                            <p className="text-gray-500 text-sm">
                                Create reusable diet plan
                            </p>
                        </div>
                    </div>
                </div>
                <div className="bg-white p-4 rounded-lg border border-gray-200">
                    <h3 className="text-gray-900 font-medium mb-3">Template Tips</h3>
                    <ul className="text-sm text-gray-600 space-y-2">
                        <li>• Templates can be assigned to any client</li>
                        <li>• Meals will be copied when assigned</li>
                        <li>• Client-specific targets will be applied later</li>
                    </ul>
                </div>
            </>
        );
    }

    if (!client) return null;

    const initials = getInitials(client.fullName);

    return (
        <>
            {/* Client Card */}
            <div className="bg-white p-4 rounded-lg border border-gray-200">
                <div className="flex items-center gap-3">
                    <div className="w-12 h-12 rounded-full bg-[#17cf54]/20 flex items-center justify-center text-[#17cf54] font-bold">
                        {initials}
                    </div>
                    <div>
                        <h1 className="text-gray-900 font-medium">{client.fullName}</h1>
                        <p className="text-gray-500 text-sm">
                            {client.heightCm}cm, {client.currentWeightKg}kg <br />
                            Goal: {client.targetWeightKg}kg
                        </p>
                    </div>
                </div>
            </div>

            {/* Dietary Restrictions Summary */}
            <div className="bg-white p-4 rounded-lg border border-gray-200">
                <h3 className="text-gray-900 font-medium mb-3">Dietary Restrictions</h3>
                <ClientRestrictionsSummary
                    allergies={client.medicalProfile?.allergies || client.allergies || []}
                    intolerances={client.intolerances || []}
                    dietPattern={client.dietPattern}
                    medicalConditions={client.medicalProfile?.conditions || client.medicalConditions || []}
                    foodRestrictions={client.foodRestrictions || []}
                    dislikes={client.dislikes || []}
                    likedFoods={client.likedFoods || []}
                />
            </div>
        </>
    );
}
</file>

<file path="frontend/src/components/diet-plan/client-restrictions-summary.tsx">
'use client';

import { AlertTriangle, Ban, Heart, Shield, Calendar, Scale, Info } from 'lucide-react';
import type { FoodRestriction } from '@/lib/hooks/use-validation';

interface ClientRestrictionsSummaryProps {
    allergies?: string[];
    intolerances?: string[];
    dietPattern?: string | null;
    medicalConditions?: string[];
    foodRestrictions?: FoodRestriction[];
    dislikes?: string[];
    likedFoods?: string[];
    className?: string;
}

// Map diet pattern to display
const DIET_PATTERN_DISPLAY: Record<string, { label: string; color: string }> = {
    vegetarian: { label: 'Vegetarian', color: 'bg-green-100 text-green-700' },
    vegan: { label: 'Vegan', color: 'bg-emerald-100 text-emerald-700' },
    non_veg: { label: 'Non-Vegetarian', color: 'bg-orange-100 text-orange-700' },
    pescatarian: { label: 'Pescatarian', color: 'bg-blue-100 text-blue-700' },
    eggetarian: { label: 'Eggetarian', color: 'bg-yellow-100 text-yellow-700' },
};

// Format restriction for display
const formatRestriction = (r: FoodRestriction): string => {
    const target = r.foodCategory || r.foodName || 'Food';

    if (r.restrictionType === 'day_based') {
        const days = r.avoidDays?.map(d => d.charAt(0).toUpperCase() + d.slice(1, 3)).join(', ') || '';
        return `No ${target} on ${days}`;
    }
    if (r.restrictionType === 'always') {
        return `Never ${target}`;
    }
    if (r.restrictionType === 'quantity') {
        return `${target}: max ${r.maxGramsPerMeal}g/meal`;
    }
    if (r.restrictionType === 'time_based') {
        return `No ${target} during ${r.avoidMeals?.join(', ') || 'certain meals'}`;
    }
    if (r.restrictionType === 'frequency') {
        return `${target}: max ${r.maxPerWeek || r.maxPerDay}/week`;
    }
    return `${target} restricted`;
};

export function ClientRestrictionsSummary({
    allergies = [],
    intolerances = [],
    dietPattern,
    medicalConditions = [],
    foodRestrictions = [],
    dislikes = [],
    likedFoods = [],
    className = ''
}: ClientRestrictionsSummaryProps) {
    const hasAnyRestrictions =
        allergies.length > 0 ||
        intolerances.length > 0 ||
        dietPattern ||
        medicalConditions.length > 0 ||
        foodRestrictions.length > 0 ||
        dislikes.length > 0;

    if (!hasAnyRestrictions && likedFoods.length === 0) {
        return (
            <div className={`p-4 bg-gray-50 rounded-lg text-center text-gray-500 text-sm ${className}`}>
                <Info className="w-5 h-5 mx-auto mb-1 opacity-50" />
                No dietary restrictions recorded
            </div>
        );
    }

    return (
        <div className={`space-y-3 ${className}`}>
            {/* Allergies - RED */}
            {allergies.length > 0 && (
                <div className="p-3 bg-red-50 rounded-lg border border-red-100">
                    <div className="flex items-center gap-2 mb-2">
                        <Ban className="w-4 h-4 text-red-500" />
                        <span className="text-sm font-medium text-red-700">Allergies</span>
                    </div>
                    <div className="flex flex-wrap gap-1.5">
                        {allergies.map((allergy, i) => (
                            <span
                                key={i}
                                className="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full"
                            >
                                {allergy}
                            </span>
                        ))}
                    </div>
                </div>
            )}

            {/* Intolerances - RED */}
            {intolerances.length > 0 && (
                <div className="p-3 bg-red-50 rounded-lg border border-red-100">
                    <div className="flex items-center gap-2 mb-2">
                        <AlertTriangle className="w-4 h-4 text-red-500" />
                        <span className="text-sm font-medium text-red-700">Intolerances</span>
                    </div>
                    <div className="flex flex-wrap gap-1.5">
                        {intolerances.map((intolerance, i) => (
                            <span
                                key={i}
                                className="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full"
                            >
                                {intolerance}
                            </span>
                        ))}
                    </div>
                </div>
            )}

            {/* Diet Pattern - BLUE */}
            {dietPattern && (
                <div className="p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <div className="flex items-center gap-2">
                        <Shield className="w-4 h-4 text-blue-500" />
                        <span className="text-sm font-medium text-blue-700">Diet Pattern</span>
                    </div>
                    <span className={`mt-2 inline-block px-2 py-0.5 text-xs rounded-full ${DIET_PATTERN_DISPLAY[dietPattern]?.color || 'bg-gray-100 text-gray-700'
                        }`}>
                        {DIET_PATTERN_DISPLAY[dietPattern]?.label || dietPattern}
                    </span>
                </div>
            )}

            {/* Food Restrictions - ORANGE */}
            {foodRestrictions.length > 0 && (
                <div className="p-3 bg-orange-50 rounded-lg border border-orange-100">
                    <div className="flex items-center gap-2 mb-2">
                        <Calendar className="w-4 h-4 text-orange-500" />
                        <span className="text-sm font-medium text-orange-700">Food Restrictions</span>
                    </div>
                    <ul className="space-y-1">
                        {foodRestrictions.map((restriction, i) => (
                            <li key={i} className="flex items-start gap-2 text-xs text-orange-700">
                                <span className={`mt-0.5 w-2 h-2 rounded-full flex-shrink-0 ${restriction.severity === 'strict' ? 'bg-red-400' : 'bg-yellow-400'
                                    }`} />
                                <span>
                                    {formatRestriction(restriction)}
                                    {restriction.excludes && restriction.excludes.length > 0 && (
                                        <span className="text-green-600"> (except {restriction.excludes.join(', ')})</span>
                                    )}
                                </span>
                            </li>
                        ))}
                    </ul>
                </div>
            )}

            {/* Medical Conditions - YELLOW */}
            {medicalConditions.length > 0 && (
                <div className="p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                    <div className="flex items-center gap-2 mb-2">
                        <Scale className="w-4 h-4 text-yellow-600" />
                        <span className="text-sm font-medium text-yellow-700">Medical Conditions</span>
                    </div>
                    <div className="flex flex-wrap gap-1.5">
                        {medicalConditions.map((condition, i) => (
                            <span
                                key={i}
                                className="px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full"
                            >
                                {condition.replace(/_/g, ' ')}
                            </span>
                        ))}
                    </div>
                </div>
            )}

            {/* Dislikes - GRAY */}
            {dislikes.length > 0 && (
                <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div className="flex items-center gap-2 mb-2">
                        <span className="text-sm font-medium text-gray-600">Dislikes</span>
                    </div>
                    <div className="flex flex-wrap gap-1.5">
                        {dislikes.slice(0, 5).map((dislike, i) => (
                            <span
                                key={i}
                                className="px-2 py-0.5 bg-gray-200 text-gray-600 text-xs rounded-full"
                            >
                                {dislike}
                            </span>
                        ))}
                        {dislikes.length > 5 && (
                            <span className="px-2 py-0.5 text-gray-500 text-xs">
                                +{dislikes.length - 5} more
                            </span>
                        )}
                    </div>
                </div>
            )}

            {/* Liked Foods - GREEN */}
            {likedFoods.length > 0 && (
                <div className="p-3 bg-green-50 rounded-lg border border-green-100">
                    <div className="flex items-center gap-2 mb-2">
                        <Heart className="w-4 h-4 text-green-500" />
                        <span className="text-sm font-medium text-green-700">Favorites</span>
                    </div>
                    <div className="flex flex-wrap gap-1.5">
                        {likedFoods.slice(0, 5).map((food, i) => (
                            <span
                                key={i}
                                className="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full"
                            >
                                {food}
                            </span>
                        ))}
                        {likedFoods.length > 5 && (
                            <span className="px-2 py-0.5 text-green-600 text-xs">
                                +{likedFoods.length - 5} more
                            </span>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend/src/components/diet-plan/client-selector.tsx">
'use client';

import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { useState } from 'react';
import { Search, ChevronRight, Users } from 'lucide-react';
import { useClients } from '@/lib/hooks/use-clients';

export function ClientSelector() {
    const router = useRouter();
    const [searchTerm, setSearchTerm] = useState('');
    const { data: clientsData } = useClients(
        { search: searchTerm, pageSize: 10 }
    );

    return (
        <div className="flex flex-col items-center justify-center min-h-[60vh] p-8">
            <div className="w-full max-w-md space-y-6 text-center">
                <div className="w-16 h-16 bg-[#17cf54]/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Users className="w-8 h-8 text-[#17cf54]" />
                </div>
                <div>
                    <h2 className="text-2xl font-bold text-gray-900">Select a Client</h2>
                    <p className="text-gray-500 mt-2">Choose a client to start building their diet plan.</p>
                </div>

                <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                    <input
                        type="text"
                        placeholder="Search clients by name..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17cf54]/20 focus:border-[#17cf54] outline-none transition-all"
                        autoFocus
                    />
                </div>

                <div className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm text-left max-h-[300px] overflow-y-auto">
                    {!clientsData?.data?.length ? (
                        <div className="p-4 text-center text-gray-500 text-sm">
                            {searchTerm ? 'No clients found matching your search.' : 'Start typing to search...'}
                        </div>
                    ) : (
                        <div className="divide-y divide-gray-100">
                            {clientsData.data.map((c: { id: string; fullName: string; email: string }) => (
                                <button
                                    key={c.id}
                                    onClick={() => router.push(`/dashboard/diet-plans/new?clientId=${c.id}`)}
                                    className="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors group"
                                >
                                    <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 font-medium group-hover:bg-[#17cf54]/10 group-hover:text-[#17cf54]">
                                        {c.fullName.charAt(0)}
                                    </div>
                                    <div>
                                        <p className="font-semibold text-gray-900">{c.fullName}</p>
                                        <p className="text-xs text-gray-500">{c.email}</p>
                                    </div>
                                    <ChevronRight className="w-4 h-4 text-gray-400 ml-auto group-hover:text-[#17cf54]" />
                                </button>
                            ))}
                        </div>
                    )}
                </div>

                <div className="text-sm">
                    <span className="text-gray-500">Don&apos;t see the client? </span>
                    <Link href="/dashboard/clients" className="text-[#17cf54] font-medium hover:underline">
                        Add new client
                    </Link>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/components/diet-plan/day-navigator.tsx">
'use client';

import { ChevronLeft, ChevronRight } from 'lucide-react';

interface DayInfo {
    date: Date;
    label: string;
    day: string;
}

interface DayNavigatorProps {
    planDates: DayInfo[];
    selectedDayIndex: number;
    onSelectDay: (index: number) => void;
    isTemplateMode: boolean;
}

export function DayNavigator({ planDates, selectedDayIndex, onSelectDay, isTemplateMode }: DayNavigatorProps) {
    return (
        <div className="bg-white p-2 rounded-lg border border-gray-200 flex-shrink-0 sticky top-0 z-10">
            <div className="flex justify-between items-center">
                <button
                    onClick={() => onSelectDay(Math.max(0, selectedDayIndex - 1))}
                    className="p-2 rounded-full hover:bg-gray-100 disabled:opacity-30"
                    disabled={selectedDayIndex === 0}
                >
                    <ChevronLeft className="w-5 h-5 text-gray-600" />
                </button>
                <div className="flex gap-1 overflow-x-auto no-scrollbar">
                    {planDates.map((d, i) => (
                        <button
                            key={i}
                            onClick={() => onSelectDay(i)}
                            className={`px-3 py-2 text-sm font-medium rounded-md transition-colors min-w-[80px] ${selectedDayIndex === i
                                ? 'bg-[#17cf54] text-white'
                                : 'text-gray-500 hover:bg-gray-100'
                                }`}
                        >
                            {isTemplateMode ? (
                                <>
                                    <div className="text-xs opacity-80">Day</div>
                                    <div className="font-bold">{i + 1}</div>
                                </>
                            ) : (
                                <>
                                    <div className="text-xs opacity-80">{d.label}</div>
                                    <div className="font-bold">{d.day}</div>
                                </>
                            )}
                        </button>
                    ))}
                </div>
                <button
                    onClick={() => onSelectDay(Math.min(6, selectedDayIndex + 1))}
                    className="p-2 rounded-full hover:bg-gray-100 disabled:opacity-30"
                    disabled={selectedDayIndex === 6}
                >
                    <ChevronRight className="w-5 h-5 text-gray-600" />
                </button>
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/components/diet-plan/medical-sidebar.tsx">
'use client';

import { useState } from 'react';
import {
    AlertCircle,
    AlertTriangle,
    Ban,
    Heart,
    Shield,
    Calendar,
    Pill,
    ChevronDown,
    ChevronUp,
    TestTube,
    Loader2,
    Info,
} from 'lucide-react';
import { useMedicalSummary } from '@/lib/hooks/use-medical-summary';
import type { LabAlert } from '@/lib/hooks/use-medical-summary';

interface MedicalSidebarProps {
    clientId: string;
    className?: string;
}

// Diet pattern display mapping
const DIET_DISPLAY: Record<string, string> = {
    vegetarian: 'Vegetarian',
    vegan: 'Vegan',
    non_veg: 'Non-Vegetarian',
    pescatarian: 'Pescatarian',
    eggetarian: 'Eggetarian',
};

// Collapsible section component
function Section({
    title,
    icon,
    count,
    color,
    defaultOpen = false,
    children,
}: {
    title: string;
    icon: React.ReactNode;
    count?: number;
    color: string;
    defaultOpen?: boolean;
    children: React.ReactNode;
}) {
    const [open, setOpen] = useState(defaultOpen);

    return (
        <div className={`border rounded-lg ${color}`}>
            <button
                onClick={() => setOpen(!open)}
                className="w-full flex items-center justify-between p-3 text-left"
            >
                <div className="flex items-center gap-2">
                    {icon}
                    <span className="text-sm font-medium">{title}</span>
                    {count !== undefined && count > 0 && (
                        <span className="text-xs px-1.5 py-0.5 rounded-full bg-white/60 font-medium">
                            {count}
                        </span>
                    )}
                </div>
                {open ? (
                    <ChevronUp className="w-4 h-4 opacity-50" />
                ) : (
                    <ChevronDown className="w-4 h-4 opacity-50" />
                )}
            </button>
            {open && <div className="px-3 pb-3">{children}</div>}
        </div>
    );
}

function LabAlertItem({ alert }: { alert: LabAlert }) {
    const statusColors = {
        critical: 'text-red-700 bg-red-100',
        warning: 'text-yellow-700 bg-yellow-100',
        normal: 'text-green-700 bg-green-100',
        optimal: 'text-emerald-700 bg-emerald-100',
    };

    return (
        <div className="flex items-center justify-between text-xs py-1">
            <span className="text-gray-700">{alert.name}</span>
            <div className="flex items-center gap-2">
                <span className="font-medium text-gray-900">
                    {alert.value} {alert.unit}
                </span>
                <span className={`px-1.5 py-0.5 rounded text-[10px] font-medium ${statusColors[alert.status]}`}>
                    {alert.status === 'critical' ? 'HIGH' : alert.status === 'warning' ? 'WARN' : alert.status === 'optimal' ? 'OPT' : 'OK'}
                </span>
            </div>
        </div>
    );
}

function Chip({ children, color }: { children: React.ReactNode; color: string }) {
    return (
        <span className={`px-2 py-0.5 text-xs rounded-full ${color}`}>
            {children}
        </span>
    );
}

export function MedicalSidebar({ clientId, className = '' }: MedicalSidebarProps) {
    const { data: summary, isLoading, error } = useMedicalSummary(clientId);

    if (isLoading) {
        return (
            <div className={`bg-white p-4 rounded-lg border border-gray-200 ${className}`}>
                <div className="flex items-center justify-center py-6">
                    <Loader2 className="w-5 h-5 animate-spin text-gray-400" />
                </div>
            </div>
        );
    }

    if (error || !summary) {
        return (
            <div className={`bg-white p-4 rounded-lg border border-gray-200 ${className}`}>
                <p className="text-sm text-gray-500 text-center py-4">
                    <Info className="w-4 h-4 inline mr-1" />
                    Unable to load medical summary
                </p>
            </div>
        );
    }

    const criticalAlerts = summary.labAlerts.filter(a => a.status === 'critical');
    const warningAlerts = summary.labAlerts.filter(a => a.status === 'warning');
    const normalAlerts = summary.labAlerts.filter(a => a.status === 'normal' || a.status === 'optimal');

    const hasAnyData = summary.allergies.length > 0 ||
        summary.intolerances.length > 0 ||
        summary.dietPattern ||
        summary.medicalConditions.length > 0 ||
        summary.medications.length > 0 ||
        summary.labAlerts.length > 0 ||
        summary.dislikes.length > 0 ||
        summary.likedFoods.length > 0;

    return (
        <div className={`bg-white p-4 rounded-lg border border-gray-200 ${className}`}>
            <h3 className="text-gray-900 font-medium mb-3 flex items-center gap-2">
                <Shield className="w-4 h-4 text-[#17cf54]" />
                Medical Summary
            </h3>

            {!hasAnyData ? (
                <p className="text-sm text-gray-500 text-center py-4">
                    No medical data recorded
                </p>
            ) : (
                <div className="space-y-2">
                    {/* Critical Lab Alerts */}
                    {criticalAlerts.length > 0 && (
                        <Section
                            title="Critical Alerts"
                            icon={<AlertCircle className="w-4 h-4 text-red-500" />}
                            count={criticalAlerts.length}
                            color="bg-red-50 border-red-200"
                            defaultOpen={true}
                        >
                            <div className="space-y-1">
                                {criticalAlerts.map((alert, i) => (
                                    <LabAlertItem key={i} alert={alert} />
                                ))}
                            </div>
                        </Section>
                    )}

                    {/* Warning Lab Alerts */}
                    {warningAlerts.length > 0 && (
                        <Section
                            title="Warnings"
                            icon={<AlertTriangle className="w-4 h-4 text-yellow-500" />}
                            count={warningAlerts.length}
                            color="bg-yellow-50 border-yellow-200"
                            defaultOpen={true}
                        >
                            <div className="space-y-1">
                                {warningAlerts.map((alert, i) => (
                                    <LabAlertItem key={i} alert={alert} />
                                ))}
                            </div>
                        </Section>
                    )}

                    {/* Normal Lab Values (collapsed by default) */}
                    {normalAlerts.length > 0 && (
                        <Section
                            title="Normal Values"
                            icon={<TestTube className="w-4 h-4 text-green-500" />}
                            count={normalAlerts.length}
                            color="bg-green-50 border-green-200"
                        >
                            <div className="space-y-1">
                                {normalAlerts.map((alert, i) => (
                                    <LabAlertItem key={i} alert={alert} />
                                ))}
                            </div>
                        </Section>
                    )}

                    {/* Allergies & Intolerances */}
                    {(summary.allergies.length > 0 || summary.intolerances.length > 0) && (
                        <Section
                            title="Allergies & Intolerances"
                            icon={<Ban className="w-4 h-4 text-red-500" />}
                            count={summary.allergies.length + summary.intolerances.length}
                            color="bg-red-50 border-red-200"
                            defaultOpen={true}
                        >
                            <div className="flex flex-wrap gap-1.5">
                                {summary.allergies.map((a, i) => (
                                    <Chip key={`a-${i}`} color="bg-red-100 text-red-700">{a}</Chip>
                                ))}
                                {summary.intolerances.map((a, i) => (
                                    <Chip key={`i-${i}`} color="bg-red-100 text-red-600">{a}</Chip>
                                ))}
                            </div>
                        </Section>
                    )}

                    {/* Diet Pattern */}
                    {summary.dietPattern && (
                        <Section
                            title="Diet Pattern"
                            icon={<Shield className="w-4 h-4 text-blue-500" />}
                            color="bg-blue-50 border-blue-200"
                            defaultOpen={true}
                        >
                            <div className="text-sm">
                                <span className="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">
                                    {DIET_DISPLAY[summary.dietPattern] || summary.dietPattern}
                                </span>
                                {summary.eggAvoidDays.length > 0 && (
                                    <p className="text-xs text-blue-600 mt-1.5">
                                        No eggs: {summary.eggAvoidDays.map(d => d.charAt(0).toUpperCase() + d.slice(1)).join(', ')}
                                    </p>
                                )}
                            </div>
                        </Section>
                    )}

                    {/* Medical Conditions */}
                    {summary.medicalConditions.length > 0 && (
                        <Section
                            title="Conditions"
                            icon={<AlertTriangle className="w-4 h-4 text-yellow-600" />}
                            count={summary.medicalConditions.length}
                            color="bg-yellow-50 border-yellow-200"
                            defaultOpen={true}
                        >
                            <div className="flex flex-wrap gap-1.5">
                                {summary.medicalConditions.map((c, i) => (
                                    <Chip key={i} color="bg-yellow-100 text-yellow-700">
                                        {c.replace(/_/g, ' ')}
                                    </Chip>
                                ))}
                            </div>
                        </Section>
                    )}

                    {/* Medications */}
                    {summary.medications.length > 0 && (
                        <Section
                            title="Medications"
                            icon={<Pill className="w-4 h-4 text-purple-500" />}
                            count={summary.medications.length}
                            color="bg-purple-50 border-purple-200"
                        >
                            <div className="flex flex-wrap gap-1.5">
                                {summary.medications.map((m, i) => (
                                    <Chip key={i} color="bg-purple-100 text-purple-700">{m}</Chip>
                                ))}
                            </div>
                        </Section>
                    )}

                    {/* Dislikes & Likes */}
                    {(summary.dislikes.length > 0 || summary.likedFoods.length > 0) && (
                        <Section
                            title="Food Preferences"
                            icon={<Heart className="w-4 h-4 text-pink-500" />}
                            color="bg-gray-50 border-gray-200"
                        >
                            {summary.dislikes.length > 0 && (
                                <div className="mb-2">
                                    <p className="text-[10px] font-medium text-gray-500 uppercase mb-1">Dislikes</p>
                                    <div className="flex flex-wrap gap-1">
                                        {summary.dislikes.slice(0, 6).map((d, i) => (
                                            <Chip key={i} color="bg-gray-200 text-gray-600">{d}</Chip>
                                        ))}
                                        {summary.dislikes.length > 6 && (
                                            <span className="text-xs text-gray-400">+{summary.dislikes.length - 6}</span>
                                        )}
                                    </div>
                                </div>
                            )}
                            {summary.likedFoods.length > 0 && (
                                <div>
                                    <p className="text-[10px] font-medium text-gray-500 uppercase mb-1">Favorites</p>
                                    <div className="flex flex-wrap gap-1">
                                        {summary.likedFoods.slice(0, 6).map((f, i) => (
                                            <Chip key={i} color="bg-green-100 text-green-700">{f}</Chip>
                                        ))}
                                        {summary.likedFoods.length > 6 && (
                                            <span className="text-xs text-green-600">+{summary.likedFoods.length - 6}</span>
                                        )}
                                    </div>
                                </div>
                            )}
                        </Section>
                    )}

                    {/* Lab Date Footer */}
                    {summary.labDate && (
                        <p className="text-[10px] text-gray-400 text-center pt-1">
                            Lab date: {new Date(summary.labDate).toLocaleDateString()}
                        </p>
                    )}
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend/src/components/diet-plan/template-sidebar.tsx">
'use client';

import { BookOpen, Loader2 } from 'lucide-react';
import type { TemplateData } from '@/lib/types/diet-plan.types';

interface TemplateSidebarProps {
    templates: TemplateData[];
    applyingTemplateId: string | null;
    onApplyTemplate: (id: string) => void;
}

export function TemplateSidebar({ templates, applyingTemplateId, onApplyTemplate }: TemplateSidebarProps) {
    return (
        <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm mt-4 flex flex-col gap-3 max-h-[400px]">
            <h3 className="text-gray-900 font-medium flex items-center gap-2">
                <BookOpen className="w-4 h-4 text-[#17cf54]" />
                Saved Templates
            </h3>
            <div className="overflow-y-auto pr-1 space-y-2 flex-grow">
                {templates.length === 0 ? (
                    <p className="text-sm text-gray-500 italic text-center py-4">No templates found</p>
                ) : (
                    templates.map((t) => (
                        <button
                            key={t.id}
                            onClick={() => onApplyTemplate(t.id)}
                            disabled={applyingTemplateId === t.id}
                            className="w-full text-left p-3 rounded-lg border border-gray-100 hover:border-[#17cf54] hover:bg-[#17cf54]/5 transition-all group"
                        >
                            <div className="flex justify-between items-start">
                                <span className="font-medium text-gray-800 text-sm group-hover:text-[#17cf54] line-clamp-1">
                                    {t.name}
                                </span>
                                {applyingTemplateId === t.id && (
                                    <Loader2 className="w-3 h-3 animate-spin text-[#17cf54]" />
                                )}
                            </div>
                            <div className="flex items-center gap-2 mt-1 text-xs text-gray-500">
                                <span>{t.checkInFrequency || 'Flexible'}</span>
                            </div>
                        </button>
                    ))
                )}
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/components/diet-plan/validation-alert.tsx">
/**
 * Validation Alert Component
 * Displays validation messages with severity-based styling
 */

import React from 'react';
import { ValidationAlert as ValidationAlertType, ValidationSeverity } from '@/lib/hooks/use-validation';
import { AlertCircle, AlertTriangle, CheckCircle, Info } from 'lucide-react';

interface ValidationAlertProps {
    alerts: ValidationAlertType[];
}

export function ValidationAlert({ alerts }: ValidationAlertProps) {
    if (!alerts || alerts.length === 0) return null;

    return (
        <div className="space-y-2 mt-3">
            {alerts.map((alert, idx) => {
                const { bgColor, borderColor, textColor, IconComponent } = getSeverityStyles(alert.severity);

                return (
                    <div
                        key={idx}
                        className={`p-3 rounded-lg border-2 ${bgColor} ${borderColor} ${textColor} transition-all`}
                    >
                        <div className="flex items-start gap-2">
                            <IconComponent className="w-5 h-5 flex-shrink-0 mt-0.5" />
                            <div className="flex-1 min-w-0">
                                <p className="font-semibold text-sm leading-tight">{alert.message}</p>
                                {alert.recommendation && (
                                    <p className="text-xs mt-1.5 opacity-80 leading-tight">
                                        <span className="inline-block mr-1">💡</span>
                                        {alert.recommendation}
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>
                );
            })}
        </div>
    );
}

function getSeverityStyles(severity: ValidationSeverity) {
    switch (severity) {
        case 'RED':
            return {
                bgColor: 'bg-red-50 dark:bg-red-950/20',
                borderColor: 'border-red-300 dark:border-red-800',
                textColor: 'text-red-900 dark:text-red-200',
                IconComponent: AlertCircle,
            };
        case 'YELLOW':
            return {
                bgColor: 'bg-yellow-50 dark:bg-yellow-950/20',
                borderColor: 'border-yellow-300 dark:border-yellow-700',
                textColor: 'text-yellow-900 dark:text-yellow-200',
                IconComponent: AlertTriangle,
            };
        case 'GREEN':
            return {
                bgColor: 'bg-green-50 dark:bg-green-950/20',
                borderColor: 'border-green-300 dark:border-green-700',
                textColor: 'text-green-900 dark:text-green-200',
                IconComponent: CheckCircle,
            };
        default:
            return {
                bgColor: 'bg-gray-50 dark:bg-gray-900',
                borderColor: 'border-gray-300 dark:border-gray-700',
                textColor: 'text-gray-900 dark:text-gray-200',
                IconComponent: Info,
            };
    }
}
</file>

<file path="frontend/src/components/modals/add-client-modal.tsx">
'use client';

import { useState } from 'react';
import { Modal } from '@/components/ui/modal';
import { User, Phone, Mail, Calendar, Target, AlertCircle } from 'lucide-react';

interface AddClientModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSubmit?: (data: ClientFormData) => void;
}

interface ClientFormData {
    name: string;
    email: string;
    phone: string;
    dateOfBirth: string;
    gender: string;
    height: string;
    weight: string;
    targetWeight: string;
    allergies: string;
    medicalConditions: string;
}

export function AddClientModal({ isOpen, onClose, onSubmit }: AddClientModalProps) {
    const [formData, setFormData] = useState<ClientFormData>({
        name: '',
        email: '',
        phone: '',
        dateOfBirth: '',
        gender: '',
        height: '',
        weight: '',
        targetWeight: '',
        allergies: '',
        medicalConditions: '',
    });

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        onSubmit?.(formData);
        onClose();
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Add New Client" size="lg">
            <form onSubmit={handleSubmit} className="p-6 space-y-6">
                {/* Basic Info */}
                <div className="space-y-4">
                    <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-wider">
                        Basic Information
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Full Name *
                            </label>
                            <div className="relative">
                                <User className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                <input
                                    type="text"
                                    name="name"
                                    required
                                    value={formData.name}
                                    onChange={handleChange}
                                    className="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                    placeholder="Enter full name"
                                />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Email Address *
                            </label>
                            <div className="relative">
                                <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                <input
                                    type="email"
                                    name="email"
                                    required
                                    value={formData.email}
                                    onChange={handleChange}
                                    className="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                    placeholder="email@example.com"
                                />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Phone Number *
                            </label>
                            <div className="relative">
                                <Phone className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                <input
                                    type="tel"
                                    name="phone"
                                    required
                                    value={formData.phone}
                                    onChange={handleChange}
                                    className="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                    placeholder="+91 98765 43210"
                                />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Date of Birth *
                            </label>
                            <div className="relative">
                                <Calendar className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                <input
                                    type="date"
                                    name="dateOfBirth"
                                    required
                                    value={formData.dateOfBirth}
                                    onChange={handleChange}
                                    className="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Gender *
                            </label>
                            <select
                                name="gender"
                                required
                                value={formData.gender}
                                onChange={handleChange}
                                className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                            >
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                {/* Physical Info */}
                <div className="space-y-4">
                    <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-wider">
                        Physical Information
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Height (cm) *
                            </label>
                            <input
                                type="number"
                                name="height"
                                required
                                value={formData.height}
                                onChange={handleChange}
                                className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                placeholder="165"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Current Weight (kg) *
                            </label>
                            <input
                                type="number"
                                name="weight"
                                required
                                value={formData.weight}
                                onChange={handleChange}
                                className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                placeholder="70"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Target Weight (kg)
                            </label>
                            <div className="relative">
                                <Target className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                <input
                                    type="number"
                                    name="targetWeight"
                                    value={formData.targetWeight}
                                    onChange={handleChange}
                                    className="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                    placeholder="65"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                {/* Medical Info */}
                <div className="space-y-4">
                    <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                        <AlertCircle className="w-4 h-4 text-orange-500" />
                        Medical Information
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Allergies
                            </label>
                            <textarea
                                name="allergies"
                                value={formData.allergies}
                                onChange={handleChange}
                                rows={3}
                                className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                placeholder="Dairy, Peanuts, Shellfish..."
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Medical Conditions
                            </label>
                            <textarea
                                name="medicalConditions"
                                value={formData.medicalConditions}
                                onChange={handleChange}
                                rows={3}
                                className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                placeholder="Diabetes, Hypertension..."
                            />
                        </div>
                    </div>
                </div>

                {/* Actions */}
                <div className="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <button
                        type="button"
                        onClick={onClose}
                        className="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        className="px-4 py-2.5 text-sm font-bold text-white bg-[#17cf54] rounded-lg hover:bg-[#17cf54]/90 transition-colors"
                    >
                        Add Client
                    </button>
                </div>
            </form>
        </Modal>
    );
}
</file>

<file path="frontend/src/components/ui/modal.tsx">
'use client';

import { useEffect, useRef } from 'react';
import { X } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ModalProps {
    isOpen: boolean;
    onClose: () => void;
    title?: string;
    size?: 'sm' | 'md' | 'lg' | 'xl' | 'full';
    children: React.ReactNode;
    showCloseButton?: boolean;
}

const sizeClasses = {
    sm: 'max-w-md',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
    xl: 'max-w-4xl',
    full: 'max-w-6xl',
};

export function Modal({
    isOpen,
    onClose,
    title,
    size = 'md',
    children,
    showCloseButton = true,
}: ModalProps) {
    const overlayRef = useRef<HTMLDivElement>(null);

    // Close on escape key
    useEffect(() => {
        const handleEscape = (e: KeyboardEvent) => {
            if (e.key === 'Escape') onClose();
        };
        if (isOpen) {
            document.addEventListener('keydown', handleEscape);
            document.body.style.overflow = 'hidden';
        }
        return () => {
            document.removeEventListener('keydown', handleEscape);
            document.body.style.overflow = 'unset';
        };
    }, [isOpen, onClose]);

    if (!isOpen) return null;

    return (
        <div
            ref={overlayRef}
            className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
            onClick={(e) => {
                if (e.target === overlayRef.current) onClose();
            }}
        >
            <div
                className={cn(
                    'bg-white rounded-xl shadow-2xl w-full flex flex-col max-h-[90vh] overflow-hidden animate-in fade-in zoom-in-95 duration-200',
                    sizeClasses[size]
                )}
            >
                {/* Header */}
                {(title || showCloseButton) && (
                    <header className="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                        {title && (
                            <h2 className="text-lg font-semibold text-gray-900">{title}</h2>
                        )}
                        {showCloseButton && (
                            <button
                                onClick={onClose}
                                className="p-2 rounded-full hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition-colors ml-auto"
                            >
                                <X className="w-5 h-5" />
                            </button>
                        )}
                    </header>
                )}

                {/* Content */}
                <div className="flex-1 overflow-y-auto">{children}</div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/components/error-boundary.tsx">
'use client';

import { Component, ReactNode } from 'react';

interface Props {
    children: ReactNode;
    fallback?: ReactNode;
}

interface State {
    hasError: boolean;
    error: Error | null;
}

export class ErrorBoundary extends Component<Props, State> {
    constructor(props: Props) {
        super(props);
        this.state = { hasError: false, error: null };
    }

    static getDerivedStateFromError(error: Error): State {
        return { hasError: true, error };
    }

    componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
        console.error('ErrorBoundary caught:', error, errorInfo);
    }

    render() {
        if (this.state.hasError) {
            if (this.props.fallback) {
                return this.props.fallback;
            }

            return (
                <div className="flex flex-col items-center justify-center min-h-[50vh] p-8">
                    <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                        <svg className="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                    </div>
                    <h2 className="text-xl font-bold text-gray-900 mb-2">Something went wrong</h2>
                    <p className="text-gray-500 text-center mb-4 max-w-md">
                        An unexpected error occurred. Please try again.
                    </p>
                    <button
                        onClick={() => this.setState({ hasError: false, error: null })}
                        className="px-4 py-2 bg-[#17cf54] text-white rounded-lg font-medium hover:bg-[#17cf54]/90 transition-colors"
                    >
                        Try Again
                    </button>
                </div>
            );
        }

        return this.props.children;
    }
}
</file>

<file path="frontend/src/lib/api/use-api-client.ts">
'use client';

import { useAuth } from '@clerk/nextjs';
import { useMemo } from 'react';
import axios, { AxiosInstance } from 'axios';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';

export function useApiClient(): AxiosInstance {
    const { getToken } = useAuth();

    const client = useMemo(() => {
        const instance = axios.create({
            baseURL: `${API_URL}/api/v1`,
            headers: {
                'Content-Type': 'application/json',
            },
        });

        // Add auth token to every request
        instance.interceptors.request.use(async (config) => {
            try {
                const token = await getToken();
                if (token) {
                    config.headers.Authorization = `Bearer ${token}`;
                }
            } catch (error) {
                console.error('Error getting auth token:', error);
            }
            return config;
        });

        // Handle response errors
        instance.interceptors.response.use(
            (response) => response,
            (error) => {
                const message =
                    error.response?.data?.error?.message ||
                    error.message ||
                    'An unexpected error occurred';
                console.error('API Error:', message);
                return Promise.reject(error);
            }
        );

        return instance;
    }, [getToken]);

    return client;
}
</file>

<file path="frontend/src/lib/hooks/use-compliance.ts">
'use client';

import { useQuery } from '@tanstack/react-query';
import { useApiClient } from '../api/use-api-client';

// ============ TYPES ============

export type ComplianceColor = 'GREEN' | 'YELLOW' | 'RED';

export interface MealBreakdown {
    mealLogId: string;
    mealName: string;
    mealType: string;
    score: number | null;
    color: ComplianceColor | null;
    status: string;
    issues: string[];
}

export interface DailyAdherence {
    date: string;
    score: number;
    color: ComplianceColor;
    mealsLogged: number;
    mealsPlanned: number;
    mealBreakdown: MealBreakdown[];
}

export interface WeeklyAdherence {
    weekStart: string;
    weekEnd: string;
    averageScore: number;
    color: ComplianceColor;
    dailyBreakdown: DailyAdherence[];
    trend: 'improving' | 'declining' | 'stable';
}

export interface ComplianceHistoryEntry {
    date: string;
    score: number;
    color: ComplianceColor;
}

export interface ComplianceHistory {
    data: ComplianceHistoryEntry[];
    averageScore: number;
    bestDay: ComplianceHistoryEntry | null;
    worstDay: ComplianceHistoryEntry | null;
}

// ============ HOOKS ============

export function useWeeklyAdherence(clientId: string | null, weekStart?: string) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['compliance', 'weekly', clientId, weekStart],
        queryFn: async () => {
            const params = weekStart ? `?weekStart=${weekStart}` : '';
            const { data } = await api.get(`/clients/${clientId}/adherence/weekly${params}`);
            return data.data as WeeklyAdherence;
        },
        enabled: !!clientId,
        staleTime: 60 * 1000,
    });
}

export function useComplianceHistory(clientId: string | null, days: number = 30) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['compliance', 'history', clientId, days],
        queryFn: async () => {
            const { data } = await api.get(`/clients/${clientId}/adherence/history?days=${days}`);
            return data.data as ComplianceHistory;
        },
        enabled: !!clientId,
        staleTime: 60 * 1000,
    });
}
</file>

<file path="frontend/src/lib/hooks/use-dashboard.ts">
'use client';

import { useQuery } from '@tanstack/react-query';
import { useApiClient } from '../api/use-api-client';

export interface DashboardStats {
    stats: {
        totalClients: number;
        pendingReviews: number;
        activeDietPlans: number;
        adherencePercent: number;
    };
    weeklyAdherence: { day: string; value: number }[];
    recentClients: {
        id: string;
        name: string;
        avatar: string;
        status: string;
        lastActivity: string;
    }[];
    pendingReviews: {
        id: string;
        client: string;
        meal: string;
        time: string;
    }[];
}

export function useDashboardStats() {
    const api = useApiClient();

    return useQuery({
        queryKey: ['dashboard', 'stats'],
        queryFn: async () => {
            const { data } = await api.get('/dashboard/stats');
            return data.data as DashboardStats;
        },
        staleTime: 30 * 1000, // Refresh every 30 seconds
    });
}
</file>

<file path="frontend/src/lib/hooks/use-medical-summary.ts">
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useApiClient } from '../api/use-api-client';

// ============ TYPES ============

export interface LabAlert {
    name: string;
    value: number;
    unit: string;
    status: 'critical' | 'warning' | 'normal' | 'optimal';
    normalRange: string;
    derivedTag?: string;
}

export interface MedicalSummary {
    allergies: string[];
    intolerances: string[];
    dietPattern: string | null;
    eggAllowed: boolean;
    eggAvoidDays: string[];
    medicalConditions: string[];
    dislikes: string[];
    likedFoods: string[];
    avoidCategories: string[];

    diagnoses: string[];
    medications: string[];
    supplements: string[];
    surgeries: string[];
    familyHistory: string | null;
    healthNotes: string | null;

    labAlerts: LabAlert[];
    labDate: string | null;
    labDerivedTags: string[];

    criticalCount: number;
    warningCount: number;
    lastUpdated: string;
}

export interface LabValuesData {
    labValues: Record<string, number> | null;
    labDate: string | null;
    alerts: LabAlert[];
    derivedTags: string[];
}

// ============ HOOKS ============

export function useMedicalSummary(clientId: string) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['medical-summary', clientId],
        queryFn: async () => {
            const { data } = await api.get(`/clients/${clientId}/medical-summary`);
            return data.data as MedicalSummary;
        },
        enabled: !!clientId,
        staleTime: 5 * 60 * 1000,
    });
}

export function useLabValues(clientId: string) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['lab-values', clientId],
        queryFn: async () => {
            const { data } = await api.get(`/clients/${clientId}/lab-values`);
            return data.data as LabValuesData;
        },
        enabled: !!clientId,
    });
}

export function useSaveLabValues(clientId: string) {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (input: { labValues: Record<string, number>; labDate: string }) => {
            const { data } = await api.put(`/clients/${clientId}/lab-values`, input);
            return data.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['lab-values', clientId] });
            queryClient.invalidateQueries({ queryKey: ['medical-summary', clientId] });
            queryClient.invalidateQueries({ queryKey: ['clients', clientId] });
        },
    });
}
</file>

<file path="frontend/src/lib/hooks/use-profile.ts">
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useApiClient } from '../api/use-api-client';

export interface UserProfile {
    id: string;
    email: string;
    fullName: string;
    phone?: string;
    profilePhotoUrl?: string;
    specialization?: string;
    bio?: string;
    role: string;
    organizationId: string;
    isActive: boolean;
    mfaEnabled: boolean;
    lastLoginAt?: string;
    createdAt: string;
    updatedAt: string;
}

export function useProfile() {
    const api = useApiClient();

    return useQuery({
        queryKey: ['auth', 'me'],
        queryFn: async () => {
            const { data } = await api.get('/auth/me');
            return data.data as UserProfile;
        },
    });
}

export function useUpdateProfile() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (profileData: Partial<UserProfile>) => {
            const { data } = await api.patch('/auth/me', profileData);
            return data.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['auth', 'me'] });
        },
    });
}
</file>

<file path="frontend/src/lib/utils/formatters.ts">
/**
 * Shared formatting utilities used across dashboard pages
 */

export function getInitials(name?: string): string {
    if (!name) return '??';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

export function formatTimeAgo(date: Date | string): string {
    if (!date) return 'Never';
    const d = new Date(date);
    const now = new Date();
    const diff = now.getTime() - d.getTime();
    const hours = Math.floor(diff / (1000 * 60 * 60));
    if (hours < 1) return 'Just now';
    if (hours < 24) return `${hours} hours ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days} days ago`;
    return `${Math.floor(days / 7)} weeks ago`;
}

export function calculateAge(dob?: string): number | null {
    if (!dob) return null;
    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
}
</file>

<file path="frontend/src/lib/utils.ts">
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
    return twMerge(clsx(inputs));
}
</file>

<file path="frontend/.env.local.example">
# Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_your-key-here
CLERK_SECRET_KEY=sk_test_your-key-here

# API
NEXT_PUBLIC_API_URL=http://localhost:3000

# Clerk Routes
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard
</file>

<file path="frontend/.eslintrc.json">
{
  "extends": ["next/core-web-vitals", "next/typescript"]
}
</file>

<file path="frontend/next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {};

export default nextConfig;
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@clerk/nextjs": "^6.36.2",
    "@hookform/resolvers": "^5.2.2",
    "@tanstack/react-query": "^5.90.12",
    "axios": "^1.13.2",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.561.0",
    "next": "14.2.35",
    "next-themes": "^0.4.6",
    "react": "^18",
    "react-dom": "^18",
    "react-hook-form": "^7.68.0",
    "recharts": "^3.5.1",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.1.13"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "eslint": "^8",
    "eslint-config-next": "14.2.35",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  }
}
</file>

<file path="frontend/postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
  },
};

export default config;
</file>

<file path="frontend/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="frontend/tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      colors: {
        background: "var(--background)",
        foreground: "var(--foreground)",
      },
    },
  },
  plugins: [],
};
export default config;
</file>

<file path="frontend/tsconfig.json">
{
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

<file path="dev-all.sh">
#!/bin/bash

# Function to kill all background processes on script exit
cleanup() {
    echo "Stopping all services..."
    # Kill all child processes of this script
    pkill -P $$
    exit
}

# Trap SIGINT (Ctrl+C) and call cleanup
trap cleanup SIGINT SIGTERM

echo "======================================"
echo "Starting DietKaro Development Environment"
echo "======================================"

# Start Backend
echo "🚀 Starting Backend on PORT 3000..."
(cd backend && PORT=3000 npm run dev) &

# Start Frontend
echo "💻 Starting Frontend on PORT 3001..."
(cd frontend && PORT=3001 npm run dev) &

# Start Client App
echo "📱 Starting Client App (Expo)..."
(cd client-app && npm start) &

echo "======================================"
echo "All services are starting..."
echo "Backend API: http://localhost:3000"
echo "Frontend UI: http://localhost:3001"
echo "======================================"
echo "Press Ctrl+C to stop all services."

# Wait for all background processes
wait
</file>

<file path="DietKaro-Complete-System-Spec.md">
# DietKaro Complete System Specification

**Version:** 2.0 (Full Stack)  
**Date:** January 2026  
**Author:** DietKaro Engineering  
**Scope:** Client Mobile App + Dietitian Dashboard + Backend Services  

---

## Table of Contents

1. System Architecture Overview
2. Client-Side Onboarding Flow (Mobile App)
3. Dietitian-Side Diet Planning Flow (Dashboard)
4. Tag System & Validation Engine
5. RAG/AI Integration
6. Database Models
7. API Endpoints
8. Implementation Roadmap

---

# PART 1: SYSTEM ARCHITECTURE OVERVIEW

## 1.1 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                          DietKaro Ecosystem                          │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────────────┐              ┌──────────────────────────┐
│   CLIENT MOBILE APP      │              │  DIETITIAN DASHBOARD     │
│  (React Native/Expo)     │              │  (Next.js Web App)       │
│                          │              │                          │
│ • Onboarding            │              │ • Client Management      │
│ • Medical Records       │              │ • Diet Plan Creation     │
│ • Food Preferences      │              │ • Real-time Validation   │
│ • Meal Logging          │              │ • Tag Review Queue       │
│ • Progress Tracking     │              │ • Reports & Analytics    │
└──────────────┬───────────┘              └──────────┬───────────────┘
               │                                     │
               │         Shared Backend APIs        │
               │                                     │
               └─────────────────┬───────────────────┘
                                 │
                ┌────────────────┴────────────────┐
                │   Backend (Node.js/Express)     │
                │                                 │
                ├─ REST/GraphQL APIs             │
                ├─ Authentication (Clerk)         │
                ├─ File Upload Service            │
                ├─ Tag Generation Engine          │
                ├─ Validation Engine              │
                ├─ RAG/AI Services                │
                └─ Database Layer (Prisma)        │
                
               ┌───────────────────────────────────┐
               │     External Services             │
               │                                   │
               ├─ USDA FoodData API               │
               ├─ Open Food Facts API             │
               ├─ Gemini/Claude AI                │
               ├─ Vector DB (Pinecone/Chroma)     │
               ├─ PDF Processing                  │
               ├─ Image Processing                │
               └─ Email Service                    │
               
               ┌───────────────────────────────────┐
               │   Data Layer                      │
               │                                   │
               ├─ PostgreSQL (Main DB)            │
               ├─ Redis (Caching)                 │
               └─ S3 (File Storage)               │
```

## 1.2 Data Flow Overview

```
CLIENT JOURNEY:
1. Client downloads app & signs up
2. Client enters medical profile (onboarding)
3. Client uploads medical records (optional)
   └─ Backend: RAG extracts allergies → Stored as tags
4. Client sets dietary preferences & restrictions
5. Client data → Backend → Stored as CLIENT_TAGS
6. Dietitian invited → Views client profile in dashboard

DIETITIAN JOURNEY:
1. Dietitian logs in → Views client list
2. Selects client → Shows MEDICAL SUMMARY sidebar
3. Opens "Add Food Item" modal
4. Real-time validation: Food tags vs CLIENT_TAGS
5. Red borders = blocked, Yellow = warnings, Green = good match
6. Adds food to meal
```

---

# PART 2: CLIENT-SIDE ONBOARDING FLOW (Mobile App)

## 2.1 Onboarding Screens & Data Collection

### Screen 1: Basic Profile

**Captured Data:**
```json
{
  "fullName": "Gaurav Kumar",
  "dateOfBirth": "1979-01-15",
  "gender": "male",
  "phone": "+91-98765-43210",
  "heightCm": 178,
  "currentWeightKg": 92,
  "targetWeightKg": 82,
  "activityLevel": "moderate",
  "occupation": "homemaker",
  "referredBy": "BNI / Gaurav Kumar",
  "referrerDiscountCode": "BNI10"
}
```

**Technical Requirements:**
- Age/weight validation
- Image upload for profile photo
- Height/weight in metric (Indian standard)

---

### Screen 2: Medical History & Lab Reports

**Captured Data:**
```json
{
  "medicalHistory": {
    "conditions": ["belly_fat", "heart_pain", "pre_diabetes"],
    "pastDietHistory": "3 diet attempts: lost 8-10kg each, regained after 6-12 months",
    "currentMedications": [],
    "surgeries": [],
    "familyHistory": "diabetes on mother's side"
  },
  "labReports": {
    "tests": [
      {
        "name": "HbA1c",
        "value": 6.3,
        "unit": "%",
        "date": "2026-01-10",
        "referenceRange": "<5.7"
      },
      {
        "name": "Vitamin D",
        "value": 23.18,
        "unit": "ng/mL",
        "date": "2026-01-10",
        "referenceRange": "30-100"
      },
      {
        "name": "Vitamin B12",
        "value": 155,
        "unit": "pg/mL",
        "date": "2026-01-10",
        "referenceRange": "200-900"
      },
      {
        "name": "hs-CRP",
        "value": 4.1,
        "unit": "mg/L",
        "date": "2026-01-10",
        "referenceRange": "<3"
      }
    ]
  }
}
```

**UI Components:**
- Multi-select checkboxes for conditions
- Text input for medication names
- Lab value input (numeric)
- Date picker for lab date
- Reference range display for educational context

**Data Processing:**
- Validate lab ranges
- Auto-detect red flags (e.g., HbA1c > 6.5 = diabetic)
- Store raw values + derived risk tags

---

### Screen 3: Medical Records Upload

**Captured Data:**
```json
{
  "reports": [
    {
      "fileUrl": "s3://bucket/user_id/blood_test_2026_01.pdf",
      "fileName": "blood_test_2026_01.pdf",
      "fileType": "application/pdf",
      "uploadedAt": "2026-01-15T10:30:00Z",
      "extractedData": {
        "allergies": [],
        "intolerances": ["lactose"],  // RAG extracted
        "conditions": ["PCOS"],
        "medications": ["Metformin"],
        "confidenceScores": {
          "allergies": 0,
          "intolerances": 0.85,
          "conditions": 0.90,
          "medications": 0.95
        }
      }
    }
  ]
}
```

**Technical Implementation:**
- File upload to S3 with progress indicator
- Background job: RAG extraction (async)
- Show "Processing..." → "Extracted Data Ready for Review"
- Confidence scores shown to dietitian in review screen

**RAG Pipeline:**
```
User uploads PDF
    ↓
Backend job: Extract text (OCR) + structure with Gemini
    ↓
Parse into: [allergies, intolerances, conditions, medications]
    ↓
Score confidence per field
    ↓
Store in MedicalProfile.extractedReports
    ↓
Dietitian reviews + confirms
    ↓
Confirmed data → CLIENT_TAGS
```

---

### Screen 4: Dietary Preferences & Restrictions

**Captured Data:**
```json
{
  "dietPattern": "vegetarian_with_egg",  // Pure veg + egg allowed
  "eggRestrictions": {
    "allowed": true,
    "avoidDays": ["tuesday", "thursday"],
    "reason": "work_schedule"
  },
  "foodRestrictions": {
    "avoidFoods": [],
    "avoidCategories": ["fried_foods", "red_meat"],
    "preferrencesNotes": "prefer light breakfast, heavy lunch"
  },
  "religious": {
    "type": null,  // no specific restrictions
    "notes": ""
  },
  "medical": {
    "glutenSensitivity": false,
    "dairyIntolerance": false,
    "lactoseIntolerance": false,
    "notes": ""
  }
}
```

**UI Components:**
- Radio buttons: Veg / Non-veg / Vegan / Pescatarian
- If veg: Checkbox for "egg allowed"
- Day picker for egg restrictions (with reason)
- Multi-select for avoid categories
- Free-text for dietary notes

**Validation:**
- If vegan selected → egg automatically disabled
- If non-veg selected → all vegetarian restrictions grayed out

---

### Screen 5: Likes, Dislikes & Food Preferences

**Captured Data:**
```json
{
  "likes": {
    "foods": [
      "egg_roll",
      "chaap_roll",
      "dal_makhani",
      "paneer_tikka"
    ],
    "cuisines": ["indian", "mughlai"],
    "cookingMethods": ["grilled", "steamed"]
  },
  "dislikes": {
    "foods": ["bitter_gourd", "mushroom"],
    "flavors": ["very_spicy"],
    "textures": ["slippery"]
  },
  "mealTiming": {
    "breakfast": "6:00-7:00 AM",
    "lunch": "12:00-1:00 PM",
    "dinner": "7:30-8:00 PM",
    "snacks": "3:00 PM"
  },
  "activityPattern": {
    "weekday": "sedentary_office",
    "weekend": "early_morning_match"
  }
}
```

**UI Components:**
- Searchable multi-select for food items (auto-complete from database)
- Time picker for meal timings
- Activity pattern selector (sedentary, light, moderate, very active)

**Integration:**
- Sends food names to backend
- Backend finds matching FoodItems + retrieves their tags
- Stores preference links: `Client.likedFoods = [foodId, ...]`

---

### Screen 6: Body Measurements

**Captured Data:**
```json
{
  "measurements": {
    "upperArm": 12.5,        // inches
    "chest": 45,
    "waist": 39.5,
    "stomachAtNaval": 42,
    "belly2InchAbove": 41,
    "belly2InchBelow": 41,
    "hips": 41,
    "upperThigh": 24,
    "calf": 15,
    "measurementDate": "2026-01-15",
    "notes": "taken during morning fasting state"
  }
}
```

**UI Components:**
- Input fields for each measurement
- Unit selector (inches / cm)
- Photo upload for body measurements (optional)
- Notes field

**Storage:**
- Create `BodyMeasurement` record
- Calculate baseline for progress tracking

---

### Screen 7: Review & Submit

**UI:**
- Show summary of all entered data
- "Edit" buttons for each section
- Large "Confirm & Continue" button
- Privacy/terms acceptance checkbox

**Backend Processing:**
```
On submit:
1. Create Client record
2. Create MedicalProfile record
3. Create BodyMeasurement record
4. Create ClientPreferences record
5. Trigger RAG extraction job for uploaded documents
6. Generate initial CLIENT_TAGS from all inputs
7. Send notification to organization (dietitian review queue)
8. Return success screen
```

---

## 2.2 Client-Side Data Model (What Gets Stored)

### Database: Client Table

```prisma
model Client {
  id                    String      @id @default(cuid())
  orgId                 String
  primaryDietitianId    String
  
  // Basic Info
  email                 String      @unique
  phone                 String
  fullName              String
  dateOfBirth           DateTime
  gender                String
  profilePhotoUrl       String?
  
  // Physical
  heightCm              Decimal
  currentWeightKg       Decimal
  targetWeightKg        Decimal
  activityLevel         String      // sedentary, light, moderate, very_active
  
  // ╔════════════════════════════════════════════════╗
  // ║  CLIENT-LEVEL TAGS (Most Important!)          ║
  // ╚════════════════════════════════════════════════╝
  
  // What the client CAN'T eat
  allergies             String[]    @default([])      // ["shellfish", "sesame"]
  intolerances          String[]    @default([])      // ["lactose", "gluten"]
  
  // What the client WON'T eat
  dietPattern           String      // "vegetarian_with_egg"
  eggAvoidDays          String[]    @default([])      // ["tuesday", "thursday"]
  dislikes              String[]    @default([])      // ["bitter_gourd"]
  avoidCategories       String[]    @default([])      // ["fried_foods"]
  
  // Medical insights
  medicalConditions     String[]    @default([])      // ["pre_diabetes", "heart_pain"]
  labDerivedTags        String[]    @default([])      // ["vitamin_d_deficiency", "low_b12"]
  
  // What the client LIKES
  likedFoods            String[]    @default([])      // [foodId, foodId, ...]
  preferredCuisines     String[]    @default([])      // ["indian", "mughlai"]
  preferredCookMethods  String[]    @default([])      // ["grilled", "steamed"]
  
  // Context
  occupation            String?
  activityNotes         String?     // "Sat/Sun early morning match"
  referredBy            String?
  
  // Lifecycle
  onboardingCompleted   Boolean     @default(false)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  medicalProfile        MedicalProfile?
  bodyMeasurements      BodyMeasurement[]
  dietPlans             DietPlan[]
  mealLogs              MealLog[]
  preferences           ClientPreferences?
  organization          Organization @relation(fields: [orgId], references: [id])
  primaryDietitian      User @relation(fields: [primaryDietitianId], references: [id])
}
```

### Database: MedicalProfile Table

```prisma
model MedicalProfile {
  id                    String      @id @default(cuid())
  clientId              String      @unique
  
  // Doctor-provided info
  diagnoses             String?     // Free text
  allergies             String[]    @default([])
  intolerances          String[]    @default([])
  medications           String?     // Free text or JSON
  supplements           String?
  surgeries             String?
  familyHistory         String?
  
  // Extracted from documents
  extractedReports      Json[]      // Array of extracted report data
  
  // Lab data (structured)
  labValues             Json        // {
                                    //   "hba1c": 6.3,
                                    //   "vitaminD": 23.18,
                                    //   "vitaminB12": 155,
                                    //   "hsCRP": 4.1
                                    // }
  
  // Derived flags (computed from labs)
  derivedRiskFlags      String[]    // ["pre_diabetes", "vitamin_d_deficiency"]
  
  // Medical notes
  healthNotes           String?
  dietaryRestrictions   String?
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  updatedByUserId       String?
  
  // Relation
  client                Client @relation(fields: [clientId], references: [id])
}
```

### Database: ClientPreferences Table

```prisma
model ClientPreferences {
  id                    String      @id @default(cuid())
  clientId              String      @unique
  
  // Food preferences
  likedFoods            String[]    @default([])      // Food IDs
  dislikedFoods         String[]    @default([])      // Food names/IDs
  preferredCuisines     String[]    @default([])
  
  // Meal timing
  breakfastTime         String      // "06:00"
  lunchTime             String      // "12:00"
  dinnerTime            String      // "19:30"
  snackTime             String?
  
  // Activity
  activityPattern       String      // "sedentary", "light", etc.
  sportOrHobby          String?     // "early_morning_match"
  
  // Cooking constraints
  canCook               Boolean     // Can client cook or needs ready meals?
  kitchenAvailable      Boolean
  dietaryCook           Boolean     // Is there a dietary cook at home?
  
  // Notes
  generalNotes          String?
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relation
  client                Client @relation(fields: [clientId], references: [id])
}
```

---

# PART 3: DIETITIAN-SIDE DIET PLANNING FLOW (Dashboard)

## 3.1 Dashboard: Client List & Selection

**Screen: Client Management**

```
Left Sidebar:
├─ Search by client name
├─ Filter by status (Active, Pending, Completed)
└─ Sort by (Last Updated, New Clients)

Main Grid:
├─ Client Card
│  ├─ Profile Photo
│  ├─ Name, Age, Weight (current/goal)
│  ├─ Status badge (Onboarding, Active, Completed)
│  ├─ Last diet plan date
│  └─ "Open Profile" button
└─ New Client button
```

**Functionality:**
- Click "Open Profile" → Navigate to client detail
- "New Diet Plan" button → Start diet creation for this client

---

## 3.2 Dashboard: Client Profile View with Medical Summary Sidebar

**Left Sidebar: Medical Summary (Always Visible)**

```
┌─────────────────────────────────────┐
│  Client Profile Card                │
├─────────────────────────────────────┤
│  👤 Gaurav Kumar                    │
│  178cm, 92kg → 82kg (Goal)          │
│  Age: 47, Male, Homemaker           │
├─────────────────────────────────────┤
│  Medical Summary                    │
├─────────────────────────────────────┤
│                                     │
│  Allergies: None recorded ✓         │
│                                     │
│  Intolerances:                      │
│  • Lactose (YELLOW)                │
│                                     │
│  Conditions (Medical):              │
│  • Pre-diabetes (HbA1c 6.3%)        │
│  • Heart pain (symptom)             │
│  • Belly fat                        │
│                                     │
│  Lab Alerts:                        │
│  🔴 Vitamin D: 23.18 (low)          │
│  🔴 Vitamin B12: 155 (low)          │
│  🟡 hs-CRP: 4.1 (elevated)          │
│                                     │
│  Dietary Pattern:                   │
│  Pure Veg + Egg                     │
│  (Avoid Tue/Thu)                    │
│                                     │
│  Likes: Egg roll, Chaap roll        │
│  Dislikes: Bitter gourd             │
│                                     │
│  Activity: Sat/Sun morning match    │
│                                     │
│  Past Diet History:                 │
│  3 diets attempted, lost 8-10kg     │
│  each time, regained after 6-12mo   │
│                                     │
└─────────────────────────────────────┘
```

**Technical Implementation:**
- Query `Client` + `MedicalProfile` + `ClientPreferences`
- Display all CLIENT_TAGS in human-readable format
- Color-code alerts (red = critical, yellow = caution, green = ok)
- Always visible while dietitian plans

---

## 3.3 Diet Plan Creation: Modal for Adding Foods

**Screen: "Add Food Item to Breakfast (Jan 17, Saturday)"**

```
┌─────────────────────────────────────────────────────────┐
│ Add to Breakfast                               ✕        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ [Search food database...                    ] ← Focus   │
│                                                         │
│ ┌────────────────────────────────────────────────────┐ │
│ │  Food Cards (3 column grid)                       │ │
│ │                                                    │ │
│ │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│
│ │  │ BROWN RICE  │  │   EGG       │  │    OATS     ││
│ │  │ 🟢 ──────── │  │ 🟡 ──────── │  │ 🟢 ──────── ││
│ │  │ Food Item   │  │ Food Item   │  │ Food Item   ││
│ │  │             │  │             │  │             ││
│ │  │ Grains•100g │  │ Protein•1g  │  │ Grain•100g  ││
│ │  │ 199Kcal     │  │ 0Kcal       │  │ 133Kcal     ││
│ │  │ P:0 C:0 F:0 │  │ P:0 C:0 F:0 │  │ P:0.1 C:3.. ││
│ │  │             │  │             │  │             ││
│ │  │ [Green]     │  │ [Yellow]    │  │ [Green]     ││
│ │  │ Border      │  │ Border      │  │ Border      ││
│ │  └─────────────┘  └─────────────┘  └─────────────┘│
│ │                                                    │
│ │ [More results below...]                           │
│ └────────────────────────────────────────────────────┘
│                                                         │
│ ┌─ Validation Alerts ─────────────────────────────────┐│
│ │                                                     ││
│ │ 🟡 CAUTION: Client avoids EGGS on Tue/Thu         ││
│ │    Today is Saturday → Allowed                     ││
│ │    But client has cholesterol concern (heart)      ││
│ │    Recommendation: Limit to 2-3 eggs/week          ││
│ │                                                     ││
│ └─────────────────────────────────────────────────────┘│
│                                                         │
│                         [Add Anyway] [Cancel]          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**Key Features:**

1. **Search & Filter**
   - Real-time search across food name, brand, category
   - Filter by: vegetarian, low-sugar, high-protein, etc.

2. **Food Card Color Coding**
   - 🟢 **GREEN border**: No conflicts, good match (e.g., high-protein for weight loss)
   - 🟡 **YELLOW border**: Warnings but allowed (e.g., high-sugar for diabetic)
   - 🔴 **RED border**: Blocked, cannot add (e.g., allergy, absolute restriction)

3. **Validation Alert Panel**
   - Shows reason for color coding
   - Multiple alerts possible (e.g., "allergy risk" + "day restriction")
   - Provides dietitian guidance/recommendation
   - RED alerts disable the "Add" button
   - YELLOW alerts show "Add Anyway" button (with confirmation)

4. **Real-time Validation Logic**
   - As dietitian types/hovers over food → API call to validation engine
   - Engine checks: `food_tags` vs `client_tags` + `current_day` + `meal_type`
   - Returns: severity + messages + blocking decision

---

## 3.4 Diet Plan View: Full Meal Breakdown

**Screen: "Create Diet Plan for Gaurav Kumar"**

```
┌─────────────────────────────────────────────────────────────┐
│ Diet Plan                                          ← Back   │
├────────────────────┬────────────────────────────────────────┤
│  Medical Summary   │  Plan Builder                          │
│  (Sidebar)         │                                        │
│                    │  Week: Jan 17 - Jan 23                │
│  🔴 Allergies: 0   │                                        │
│  🟡 Conditions: 2  │  ┌─ Jan 17 (Saturday) ──────────────┐ │
│  🟡 Lab Alerts: 3  │  │                                  │ │
│  ✓ Preferences     │  │ Breakfast (08:00 AM)       0Kcal │ │
│                    │  │                                  │ │
│  Likes:            │  │ ┌─ Add Food Item ────────────┐  │ │
│  • Egg roll        │  │ │ Brown Rice (100g)          │  │ │
│  • Chaap roll      │  │ │ 199 Kcal | P:0 C:0 F:0    │  │ │
│                    │  │ │                            │  │ │
│  Dislikes:         │  │ │ Egg (2x)                   │  │ │
│  • Bitter gourd    │  │ │ 0 Kcal | P:0 C:0 F:0      │  │ │
│                    │  │ │                            │  │ │
│  Pattern:          │  │ │ [+] Add More Foods         │  │ │
│  Veg + Egg         │  │ │ [×] Remove                 │  │ │
│  (Avoid Tue/Thu)   │  │ └────────────────────────────┘  │ │
│                    │  │                                  │ │
│                    │  │ Lunch (12:00 PM)          0Kcal │ │
│                    │  │ ├─ [+] Add Food Item             │ │
│                    │  │                                  │ │
│                    │  │ Dinner (07:30 PM)         0Kcal │ │
│                    │  │ ├─ [+] Add Food Item             │ │
│                    │  │                                  │ │
│                    │  └──────────────────────────────────┘ │
│                    │                                        │
│                    │  Daily Totals (Target: 300 Kcal)     │
│                    │  ├─ Calories: 199 / 300 Kcal         │
│                    │  ├─ Protein: 0 / 150g                │
│                    │  ├─ Carbs: 0 / 200g                  │
│                    │  └─ Fat: 0 / 70g                     │
│                    │                                        │
│                    │  [Save as Draft] [Publish] [Cancel]  │
│                    │                                        │
└────────────────────┴────────────────────────────────────────┘
```

**Features:**
- Drag-drop to reorder foods within meal
- Edit/remove each food item
- View nutrition breakdown per meal
- View daily totals vs targets
- Alert icons next to high-risk foods

---

## 3.5 Tag Review Queue (Dietitian Admin Task)

**Screen: "Food Tag Verification Queue"**

```
┌─────────────────────────────────────┐
│ Tag Review Queue (12 pending)       │
├─────────────────────────────────────┤
│                                     │
│ Priority: HIGH                      │
│ ├─ Godrej Real Bread               │
│ │  ├─ Issue: Low allergen conf.    │
│ │  ├─ Current: [wheat, soy]        │
│ │  ├─ Suggested: [wheat, soy,      │
│ │  │               sesame]          │
│ │  ├─ Confidence: 72%              │
│ │  └─ [Review] [Approve] [Reject]  │
│ │                                  │
│ │ Almonds (Unverified)             │
│ │ ├─ Issue: New food, manual       │
│ │ ├─ Allergens: [tree_nuts]        │
│ │ ├─ Confidence: 85%              │
│ │ └─ [Review] [Approve] [Reject]  │
│ │                                  │
│ Priority: MEDIUM                    │
│ ├─ Brown Rice (Needs recheck)      │
│ │ ...                               │
│ │                                  │
│ Priority: LOW                       │
│ ├─ Coconut Oil (Annual review)     │
│ │ ...                               │
│                                     │
└─────────────────────────────────────┘
```

**Workflow:**
1. Dietitian reviews food + suggested tags
2. Compares with package label / USDA data
3. Approves → Marks as verified (confidence 95%)
4. Requests changes → Updates tags + saves
5. Rejects → Removes from library / marks for escalation

---

# PART 4: TAG SYSTEM & VALIDATION ENGINE

## 4.1 Complete Tag Vocabulary

### 4.1.1 CLIENT-LEVEL TAGS (What we extract during onboarding)

```typescript
interface ClientTags {
  // HARD CONSTRAINTS (Red blocking)
  allergies: string[];              // ["shellfish", "sesame"]
  intolerances: string[];           // ["lactose", "gluten"]
  
  // DIETARY PATTERN (Red blocking)
  dietPattern: "vegetarian" | "vegan" | "non_veg" | "pescatarian";
  eggAllowed: boolean;
  eggAvoidDays: ("monday" | "tuesday" | ... )[];
  
  // SOFT CONSTRAINTS (Yellow warning)
  dislikes: string[];               // Food names
  avoidCategories: string[];        // ["fried_foods", "processed_meat"]
  
  // MEDICAL CONDITIONS (Yellow warning based on lab values)
  conditions: string[];             // ["pre_diabetes", "hypertension"]
  labDerivedTags: string[];         // ["vitamin_d_deficiency", "high_inflammation"]
  
  // POSITIVE NUDGES (Green info)
  likedFoods: string[];
  preferredCuisines: string[];
  
  // CONTEXT
  activityPattern: "sedentary" | "light" | "moderate" | "very_active";
  occupationalPattern: string;      // "office", "homemaker", etc.
}
```

### 4.1.2 FOOD-LEVEL TAGS (What we tag each FoodItem with)

```typescript
interface FoodItemTags {
  // Safety
  allergenFlags: string[];          // ["eggs", "milk", "sesame"]
  mayContainTraces: string[];       // ["tree_nuts", "peanuts"]
  
  // Dietary
  dietaryCategory: "vegan" | "vegetarian" | "veg_with_egg" | "non_veg";
  cuisineOrigin: string[];          // ["indian", "mughlai"]
  
  // Nutritional Characteristics
  nutritionTags: string[];          // ["high_protein", "low_carb", "high_sugar"]
  
  // Medical Relevance
  medicalFlags: string[];           // ["diabetic_caution", "heart_caution"]
  
  // Processing
  processingLevel: "raw" | "minimally_processed" | "processed" | "ultra_processed";
  
  // Meal Suitability
  mealSuitability: string[];        // ["good_for_breakfast", "too_heavy_for_night"]
  
  // Source & Confidence
  source: "usda" | "barcode" | "manual" | "ai";
  confidence: number;               // 0-100
}
```

---

## 4.2 Validation Rule Engine

### 4.2.1 RED (Blocking) Rules

```typescript
interface BlockingRules {
  
  // Rule 1: Hard Allergy
  if (client.allergies.includes(food.allergenFlags)) {
    return {
      severity: "RED",
      message: `⛔ ALLERGY: Client allergic to ${allergen}`,
      canAdd: false
    };
  }
  
  // Rule 2: Hard Intolerance
  if (client.intolerances.includes(food.allergenFlags)) {
    return {
      severity: "RED",
      message: `⛔ INTOLERANCE: Client intolerant to ${item}`,
      canAdd: false
    };
  }
  
  // Rule 3: Diet Pattern Violation
  if (client.dietPattern === "vegetarian" && food.dietaryCategory === "non_veg") {
    return {
      severity: "RED",
      message: `⛔ VEGETARIAN: Client doesn't eat meat/fish`,
      canAdd: false
    };
  }
  
  // Rule 4: Day-based Restriction
  if (client.eggAvoidDays.includes(TODAY) && food.allergenFlags.includes("eggs")) {
    return {
      severity: "RED",
      message: `⛔ DAY RESTRICTION: Client avoids eggs on ${TODAY}`,
      canAdd: false
    };
  }
  
  // Rule 5: Specific Food Ban
  if (client.dislikes.includes(food.name)) {
    // Check if dislike is STRONG (vs just preference)
    if (dislike.strength === "strong") {
      return {
        severity: "RED",
        message: `⛔ STRONG DISLIKE: Client dislikes ${food.name}`,
        canAdd: false
      };
    }
  }
}
```

### 4.2.2 YELLOW (Caution) Rules

```typescript
interface CautionRules {
  
  // Rule 1: Medical Condition Conflict
  if (client.conditions.includes("pre_diabetes") && 
      food.nutritionTags.includes("high_sugar")) {
    return {
      severity: "YELLOW",
      message: `🟡 DIABETES CAUTION: ${food.name} has high sugar (${food.sugarG}g)`,
      recommendation: "Consider lower-sugar alternative",
      canAdd: true
    };
  }
  
  // Rule 2: Lab-derived Warning
  if (client.labDerivedTags.includes("vitamin_d_deficiency") &&
      !food.medicalFlags.includes("vitamin_d_source")) {
    // Don't block, but nudge towards fortified foods
  }
  
  // Rule 3: Lab Value-based Warning (e.g., high cholesterol)
  if (client.medicalProfile.labValues.totalCholesterol > 200 &&
      food.nutritionTags.includes("high_saturated_fat")) {
    return {
      severity: "YELLOW",
      message: `🟡 CHOLESTEROL: ${food.name} is high in saturated fat`,
      recommendation: "Limit to 2-3 per week",
      canAdd: true
    };
  }
  
  // Rule 4: Soft Dislike
  if (client.dislikes.includes(food.name) && dislike.strength === "mild") {
    return {
      severity: "YELLOW",
      message: `🟡 MILD DISLIKE: Client prefers other options`,
      canAdd: true
    };
  }
  
  // Rule 5: Processing-related caution
  if (client.conditions.includes("pre_diabetes") &&
      food.processingLevel === "ultra_processed") {
    return {
      severity: "YELLOW",
      message: `🟡 ULTRA-PROCESSED: High GI, consider whole-grain alternative`,
      canAdd: true
    };
  }
  
  // Rule 6: Repetition Caution
  if (foodCountThisWeek > 4 && food === "eggs") {
    return {
      severity: "YELLOW",
      message: `🟡 REPETITION: Eggs used ${foodCountThisWeek} times this week`,
      recommendation: "Consider variety",
      canAdd: true
    };
  }
}
```

### 4.2.3 GREEN (Positive) Rules

```typescript
interface PositiveRules {
  
  // Rule 1: Liked Food
  if (client.likedFoods.includes(food.id)) {
    return {
      severity: "GREEN",
      message: `✅ CLIENT FAVORITE: Client likes ${food.name}`,
      icon: "heart"
    };
  }
  
  // Rule 2: Goal-aligned Food
  if (client.goal === "weight_loss" &&
      food.nutritionTags.includes("high_protein") &&
      food.nutritionTags.includes("low_calorie")) {
    return {
      severity: "GREEN",
      message: `✅ GOAL-ALIGNED: High protein, low calorie - good for weight loss`,
      icon: "target"
    };
  }
  
  // Rule 3: Nutrient-deficiency solution
  if (client.labDerivedTags.includes("vitamin_d_deficiency") &&
      food.medicalFlags.includes("vitamin_d_rich")) {
    return {
      severity: "GREEN",
      message: `✅ NUTRIENT MATCH: Good source of Vitamin D for client`,
      icon: "star"
    };
  }
  
  // Rule 4: Preferred Cuisine
  if (client.preferredCuisines.includes(food.cuisineOrigin)) {
    return {
      severity: "GREEN",
      message: `✅ PREFERRED CUISINE: Client likes ${food.cuisineOrigin}`,
      icon: "sparkle"
    };
  }
}
```

---

## 4.3 Validation Engine API

### Endpoint: POST `/api/diet-validation/check`

**Request:**
```json
{
  "clientId": "client_123",
  "foodId": "food_456",
  "context": {
    "currentDay": "saturday",
    "mealType": "breakfast",
    "daysOfWeekUsed": { "eggs": ["friday", "wednesday"] }
  }
}
```

**Response:**
```json
{
  "foodId": "food_456",
  "foodName": "Eggs",
  "severity": "YELLOW",
  "borderColor": "yellow",
  "canAdd": true,
  "alerts": [
    {
      "type": "medical",
      "message": "Client has heart issues - eggs have cholesterol",
      "recommendation": "Limit to 2-3 per week",
      "severity": "YELLOW"
    },
    {
      "type": "preference_match",
      "message": "Client LIKES egg roll",
      "severity": "GREEN"
    }
  ],
  "confidenceScore": 0.95
}
```

---

# PART 5: RAG/AI INTEGRATION

## 5.1 RAG Pipeline for Medical Document Extraction

### Flow Diagram

```
CLIENT UPLOADS MEDICAL REPORT
            ↓
    Extract Text (OCR)
            ↓
   Split into chunks (500 tokens)
            ↓
  Embed chunks (Gemini Embeddings)
            ↓
   Store in Vector DB (Pinecone)
            ↓
   Query with structured prompt
   (What are allergies, conditions, medications?)
            ↓
   LLM response → Parse JSON
            ↓
   Normalize to canonical terms
            ↓
   Score confidence per field
            ↓
   Store in MedicalProfile.extractedReports
            ↓
   Dietitian reviews in UI
            ↓
   Approve → Move to Client.allergies, conditions, etc.
```

### 5.2 RAG Service Implementation (Conceptual)

```typescript
interface RAGExtractionService {
  
  // Input: PDF/Image of medical report
  async extractMedicalData(
    fileUrl: string,
    fileType: "pdf" | "image"
  ): Promise<ExtractionResult>;
  
  // Output: Structured medical data
  type ExtractionResult = {
    allergies: { items: string[], confidence: number },
    intolerances: { items: string[], confidence: number },
    conditions: { items: string[], confidence: number },
    medications: { items: string[], confidence: number },
    labValues: { name: string, value: number, unit: string }[],
    rawText: string,  // For dietitian to verify
    extractionTime: number
  }
}

// Implementation
class MedicalDocRAG implements RAGExtractionService {
  
  private vectorStore: Pinecone;
  private llm: Gemini | Claude;
  
  async extractMedicalData(fileUrl: string): Promise<ExtractionResult> {
    
    // Step 1: OCR - Extract raw text
    const rawText = await this.ocr.extractText(fileUrl);
    
    // Step 2: Chunk document
    const chunks = this.chunk(rawText, 500);  // 500 token chunks
    
    // Step 3: Embed chunks (for context retrieval later)
    const embeddings = await this.embed(chunks);
    
    // Step 4: Store in vector DB for future reference
    await this.vectorStore.upsert(embeddings);
    
    // Step 5: Query LLM with structured prompt
    const systemPrompt = `
      You are a medical document analyzer.
      Extract the following from medical reports:
      1. Allergies (food and drug)
      2. Intolerances
      3. Medical conditions / diagnoses
      4. Current medications
      5. Lab values with normal ranges
      
      Be precise. If unsure, mark confidence < 80%.
      Return ONLY valid JSON.
    `;
    
    const userPrompt = `
      Extract medical data from this report:
      ${rawText}
      
      Return JSON:
      {
        "allergies": ["item1", "item2"],
        "allergyConfidence": 0.95,
        "intolerances": ["item1"],
        "intoleranceConfidence": 0.85,
        "conditions": ["diabetes", "heart_disease"],
        "conditionConfidence": 0.90,
        "medications": ["metformin"],
        "medicationConfidence": 0.95,
        "labValues": [
          {"name": "HbA1c", "value": 6.3, "unit": "%"}
        ]
      }
    `;
    
    const response = await this.llm.generate({
      system: systemPrompt,
      user: userPrompt
    });
    
    // Step 6: Parse & validate JSON
    const extracted = JSON.parse(response);
    
    // Step 7: Normalize to canonical terms
    const normalized = {
      allergies: this.normalizeAllergens(extracted.allergies),
      intolerances: this.normalizeIntolerances(extracted.intolerances),
      conditions: this.normalizeConditions(extracted.conditions),
      medications: this.normalizeMedications(extracted.medications),
      labValues: extracted.labValues
    };
    
    return {
      ...normalized,
      confidence: {
        allergies: extracted.allergyConfidence,
        intolerances: extracted.intoleranceConfidence,
        conditions: extracted.conditionConfidence,
        medications: extracted.medicationConfidence
      },
      rawText,
      extractionTime: Date.now()
    };
  }
  
  private normalizeAllergens(items: string[]): string[] {
    // Map common names to canonical allergen names
    const mapping = {
      "peanut": "peanuts",
      "groundnut": "peanuts",
      "shellfish": "crustacean_shellfish",
      "shrimp": "crustacean_shellfish",
      "milk allergy": "milk",
      "dairy": "milk",
      ...
    };
    
    return items.map(item => 
      mapping[item.toLowerCase()] || item.toLowerCase()
    );
  }
  
  // Similar methods for normalize*
}
```

---

## 5.3 Medical Document Review Screen (Dietitian)

**Screen: "Review Extracted Medical Data"**

```
┌─────────────────────────────────────────────────────────┐
│ Review Medical Extract                                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ Document: blood_test_2026_01.pdf                       │
│ Extracted: 2 min ago                                   │
│                                                         │
│ ┌─── ALLERGIES ──────────────────────────────────────┐ │
│ │ Confidence: 95%                                    │ │
│ │ Extracted: []                                      │ │
│ │ Status: ✓ No allergies detected                    │ │
│ └────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─── INTOLERANCES ───────────────────────────────────┐ │
│ │ Confidence: 85%                                    │ │
│ │ Extracted: [lactose]                               │ │
│ │ Review: ☑ Lactose intolerance found               │ │
│ │ Notes: "Patient reports bloating after dairy"     │ │
│ └────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─── CONDITIONS ──────────────────────────────────────┐ │
│ │ Confidence: 90%                                    │ │
│ │ Extracted: [PCOS, hypertension]                    │ │
│ │ Review: ☑ PCOS                                     │ │
│ │         ☑ Hypertension                             │ │
│ └────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─── LAB VALUES ──────────────────────────────────────┐ │
│ │ HbA1c: 6.3% (Ref: <5.7%) → PRE-DIABETES ⚠️         │ │
│ │ Vitamin D: 23.18 ng/mL (Ref: 30-100) → LOW 🔴     │ │
│ │ B12: 155 pg/mL (Ref: 200-900) → LOW 🔴            │ │
│ │ hs-CRP: 4.1 mg/L (Ref: <3) → ELEVATED 🟡          │ │
│ └────────────────────────────────────────────────────┘ │
│                                                         │
│ [✓ Approve & Save to Profile]  [Edit] [Reject]       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

# PART 6: DATABASE MODELS (Complete Schema)

## 6.1 Core Tables

```prisma
// Already defined: Client, MedicalProfile, ClientPreferences

model FoodItem {
  id                 String   @id @default(cuid())
  orgId              String?
  
  // Basic Info
  name               String
  brand              String?
  barcode            String?  @unique
  category           String
  subCategory        String?
  
  // Nutrition (per 100g)
  servingSizeG       Decimal  @default(100)
  calories           Int
  proteinG           Decimal
  carbsG             Decimal
  fatsG              Decimal
  fiberG             Decimal
  sodiumMg           Decimal
  sugarG             Decimal
  
  // TAGS
  allergenFlags      String[] @default([])
  dietaryTags        String[] @default([])
  nutritionTags      String[] @default([])
  healthFlags        String[] @default([])
  cuisineTags        String[] @default([])
  processingTags     String[] @default([])
  mealSuitabilityTags String[] @default([])
  
  // Metadata
  isVerified         Boolean  @default(false)
  source             String   // "manual" | "barcode" | "usda" | "ai"
  confidence         Int      @default(0)
  verifiedByUserId   String?
  verifiedAt         DateTime?
  lastUpdated        DateTime @updatedAt
  requiresReviewAt   DateTime?
  
  createdByUserId    String?
  createdAt          DateTime @default(now())
  
  // Relations
  mealFoodItems      MealFoodItem[]
  organization       Organization? @relation(fields: [orgId], references: [id])
  
  @@index([orgId])
  @@index([category])
  @@index([isVerified])
}

model DietPlan {
  id                 String   @id @default(cuid())
  orgId              String
  clientId           String
  createdByUserId    String
  
  // Plan info
  name               String
  description        String?
  startDate          DateTime
  endDate            DateTime?
  
  // Targets
  targetCalories     Int?
  targetProteinG     Decimal?
  targetCarbsG       Decimal?
  targetFatsG        Decimal?
  targetFiberG       Decimal?
  
  // Status
  status             String   // "draft", "active", "completed", "paused"
  isTemplate         Boolean  @default(false)
  visibility         String   // "private", "orgshared", "public"
  publishedAt        DateTime?
  
  // Notes
  notesForClient     String?
  internalNotes      String?
  
  // Timestamps
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  deletedAt          DateTime?
  
  // Relations
  meals              Meal[]
  mealLogs           MealLog[]
  client             Client @relation(fields: [clientId], references: [id])
  organization       Organization @relation(fields: [orgId], references: [id])
  createdBy          User @relation(fields: [createdByUserId], references: [id])
  
  @@index([clientId])
  @@index([status])
}

model Meal {
  id                 String   @id @default(cuid())
  planId             String
  
  // Timing
  dayOfWeek          Int?     // 0-6 (Monday = 0)
  mealDate           DateTime?
  sequenceNumber     Int?     // 1st meal, 2nd meal, etc.
  
  // Type
  mealType           String   // "breakfast", "lunch", "dinner", "snack"
  timeOfDay          String?  // "08:00 AM"
  name               String
  description        String?
  instructions       String?
  
  // Nutrition
  totalCalories      Int?
  totalProteinG      Decimal?
  totalCarbsG        Decimal?
  totalFatsG         Decimal?
  totalFiberG        Decimal?
  servingSizeNotes   String?
  
  // Timestamps
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  // Relations
  foodItems          MealFoodItem[]
  mealLogs           MealLog[]
  dietPlan           DietPlan @relation(fields: [planId], references: [id])
  
  @@index([planId])
  @@index([mealDate])
}

model MealFoodItem {
  id                 String   @id @default(cuid())
  mealId             String
  foodId             String
  
  // Quantity
  quantityG          Decimal
  
  // Calculated nutrition
  calories           Int?
  proteinG           Decimal?
  carbsG             Decimal?
  fatsG              Decimal?
  fiberG             Decimal?
  
  // Order
  sortOrder          Int      @default(0)
  notes              String?  // e.g., validation alerts
  
  // Timestamps
  createdAt          DateTime @default(now())
  
  // Relations
  meal               Meal @relation(fields: [mealId], references: [id])
  foodItem           FoodItem @relation(fields: [foodId], references: [id])
  
  @@unique([mealId, foodId, sortOrder])
}

model BodyMeasurement {
  id                 String   @id @default(cuid())
  clientId           String
  
  // Measurements
  logDate            DateTime
  upperArmCm         Decimal?
  chestCm            Decimal?
  waistCm            Decimal?
  hipsCm             Decimal?
  thighsCm           Decimal?
  calfCm             Decimal?
  bodyFatPercentage  Decimal?
  
  notes              String?
  
  createdAt          DateTime @default(now())
  
  client             Client @relation(fields: [clientId], references: [id])
  
  @@index([clientId])
  @@index([logDate])
}

model MealLog {
  id                 String   @id @default(cuid())
  clientId           String
  mealId             String
  
  // When it was supposed to be eaten
  scheduledDate      DateTime
  scheduledTime      String?
  
  // What happened
  status             String   // "pending", "eaten", "skipped", "substituted"
  
  // Evidence
  mealPhotoUrl       String?
  photoUploadedAt    DateTime?
  
  // AI Recognition
  aiFoodRecognition  Json?    // { confidence: 0.8, detectedFoods: [...] }
  
  // Feedback
  clientNotes        String?
  dietitianFeedback  String?
  dietitianFeedbackAt DateTime?
  reviewedByUserId   String?
  
  // Substitution tracking
  substituteDescription String?
  substituteCaloriesEst Int?
  
  // Timestamps
  loggedAt           DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  // Relations
  client             Client @relation(fields: [clientId], references: [id])
  meal               Meal @relation(fields: [mealId], references: [id])
  reviewedBy         User? @relation(fields: [reviewedByUserId], references: [id])
  
  @@index([clientId])
  @@index([status])
  @@index([scheduledDate])
}
```

---

# PART 7: API ENDPOINTS

## 7.1 Client-Side APIs (Mobile App)

### Authentication
```
POST   /api/auth/register          - Register new client
POST   /api/auth/login              - Login with email/password
POST   /api/auth/logout             - Logout
GET    /api/auth/me                 - Get current user profile
```

### Onboarding
```
POST   /api/onboarding/step1        - Save basic profile
POST   /api/onboarding/step2        - Save medical history
POST   /api/onboarding/step3        - Upload medical documents
POST   /api/onboarding/step4        - Set dietary preferences
POST   /api/onboarding/step5        - Set food likes/dislikes
POST   /api/onboarding/step6        - Save body measurements
POST   /api/onboarding/complete     - Mark onboarding done
GET    /api/onboarding/progress     - Get onboarding progress
```

### Client Profile
```
GET    /api/client/profile          - Get own profile + medical summary
PUT    /api/client/profile          - Update profile
GET    /api/client/medical-summary  - Get medical summary (for sidebar)
```

### Medical Records
```
POST   /api/medical-records/upload  - Upload medical document
GET    /api/medical-records         - List uploaded records
DELETE /api/medical-records/:id     - Delete record
```

### Meal Logging (Client)
```
GET    /api/meals/today             - Get today's meal plan
POST   /api/meal-logs               - Log a meal
PUT    /api/meal-logs/:id           - Update meal log
POST   /api/meal-logs/:id/photo     - Upload meal photo
GET    /api/progress/weight         - Get weight progress
POST   /api/progress/weight         - Log weight
```

---

## 7.2 Dietitian-Side APIs (Dashboard)

### Client Management
```
GET    /api/dietitian/clients       - List all clients
GET    /api/dietitian/clients/:id   - Get client detail + medical summary
POST   /api/dietitian/clients       - Add new client (manual)
PUT    /api/dietitian/clients/:id   - Update client profile
```

### Diet Planning
```
POST   /api/diet-plans              - Create new diet plan
GET    /api/diet-plans/:id          - Get diet plan detail
PUT    /api/diet-plans/:id          - Update diet plan
DELETE /api/diet-plans/:id          - Delete diet plan
POST   /api/diet-plans/:id/publish  - Publish to client
```

### Meals
```
POST   /api/meals                   - Add meal to plan
PUT    /api/meals/:id               - Update meal
DELETE /api/meals/:id               - Delete meal
POST   /api/meal-foods              - Add food item to meal
```

### Real-Time Validation
```
POST   /api/diet-validation/check   - Check food vs client
GET    /api/diet-validation/alerts  - Get all alerts for client
```

### Food Management
```
GET    /api/foods                   - Search food database
GET    /api/foods/:id               - Get food detail + tags
POST   /api/foods                   - Create new food item
PUT    /api/foods/:id               - Update food item
GET    /api/foods/tag-review-queue  - Get foods needing verification
POST   /api/foods/:id/verify        - Verify food tags
```

### Reports & Analytics
```
GET    /api/reports/client/:id      - Get client progress report
GET    /api/reports/compliance      - Get diet compliance metrics
GET    /api/reports/trending-foods  - Which foods are most used
```

---

# PART 8: IMPLEMENTATION ROADMAP

## Phase 1: Foundation (Week 1-2)

### Backend Setup
- [ ] Database: Prisma schema setup
- [ ] Authentication: Clerk integration
- [ ] File Upload: S3 setup
- [ ] USDA API: Integration & caching
- [ ] Tag Generation: Basic algorithms
- [ ] Validation Engine: Rule matrix implementation

### Frontend (Mobile)
- [ ] Auth screens: Login/Register
- [ ] Onboarding screens 1-3: Profile, Medical History, Document Upload
- [ ] Basic styling & navigation

### Frontend (Dashboard)
- [ ] Auth screens
- [ ] Client list page
- [ ] Client detail page (sidebar + basic info)

---

## Phase 2: Core Features (Week 3-4)

### Backend
- [ ] Complete food tagging pipeline (USDA + Manual)
- [ ] RAG service for medical document extraction
- [ ] Validation engine API (`POST /api/diet-validation/check`)
- [ ] Food search endpoint

### Frontend (Mobile)
- [ ] Complete onboarding (screens 4-7)
- [ ] Medical record upload with extraction review
- [ ] Profile management

### Frontend (Dashboard)
- [ ] Diet plan creation page
- [ ] "Add Food Item" modal with real-time validation
- [ ] Color-coded food cards (RED/YELLOW/GREEN)
- [ ] Medical summary sidebar

---

## Phase 3: Refinement (Week 5-6)

### Backend
- [ ] Tag verification queue system
- [ ] Dietitian review endpoints
- [ ] Tag accuracy metrics
- [ ] Caching optimization

### Frontend (Mobile)
- [ ] Meal logging
- [ ] Progress tracking
- [ ] Notifications

### Frontend (Dashboard)
- [ ] Tag review queue UI
- [ ] Batch food upload
- [ ] Template diet plans
- [ ] Reports & analytics

---

## Phase 4: Polish & Launch (Week 7+)

- [ ] Performance optimization
- [ ] Security audit
- [ ] User testing
- [ ] Mobile app store submission
- [ ] Production deployment
- [ ] Monitoring & alerting
- [ ] Indian food database expansion

---

## Success Metrics

**Client Side:**
- Onboarding completion rate: >85%
- Time to complete onboarding: <10 minutes
- Medical document extraction accuracy: >90%

**Dietitian Side:**
- False positive alerts (red): <2%
- False negative alerts (missed allergies): <0.1%
- Tag verification turnaround: <24 hours
- Diet plan creation time: <15 minutes per client

**Data Quality:**
- Food tag coverage: >95%
- Tag confidence average: >85%
- Validation engine accuracy: >95%

---

**Document Status:** COMPLETE  
**Last Updated:** January 17, 2026  
**Ready for:** Development Sprint Planning
</file>

<file path="FOOD_VALIDATION_TECH_SPEC.md">
# Food Validation System - Technical Implementation Specification

**Version:** 1.0  
**Date:** February 1, 2026  
**Project:** DietKaro  
**Status:** Ready for Implementation

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [System Architecture](#2-system-architecture)
3. [Database Schema](#3-database-schema)
4. [Backend Implementation](#4-backend-implementation)
5. [API Contracts](#5-api-contracts)
6. [Frontend Implementation](#6-frontend-implementation)
7. [Testing Strategy](#7-testing-strategy)
8. [Deployment Plan](#8-deployment-plan)
9. [Implementation Phases](#9-implementation-phases)

---

## 1. Executive Summary

### Purpose
Implement a real-time food validation system that prevents dietitians from adding unsafe or unsuitable foods to client meal plans by checking against allergies, dietary restrictions, medical conditions, and preferences.

### Core Components
- **ValidationService** - Core business logic for rule evaluation
- **Validation API** - RESTful endpoints for single/bulk validation
- **UI Components** - Visual feedback system with color-coded alerts
- **Auto-tagging Pipeline** - Automated tag generation from nutrition data

### Success Criteria
- ✅ Block all foods matching client allergies (100% prevention)
- ✅ Warn on foods conflicting with medical conditions
- ✅ Provide clear, actionable feedback to dietitians
- ✅ Validate in <200ms for individual foods, <1s for bulk operations

---

## 2. System Architecture

### 2.1 Component Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                     FRONTEND (React)                        │
├─────────────────────────────────────────────────────────────┤
│  AddFoodModal → ValidationDisplay → ValidationAlerts        │
└───────────────────────────┬─────────────────────────────────┘
                            │ HTTP REST
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  API LAYER (Express)                        │
├─────────────────────────────────────────────────────────────┤
│  POST /api/validation/single                                │
│  POST /api/validation/bulk                                  │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              BUSINESS LOGIC (Services)                      │
├─────────────────────────────────────────────────────────────┤
│  ValidationService                                          │
│  ├── validateFood()                                         │
│  ├── validateFoodsBulk()                                    │
│  ├── checkAllergyRules()                                    │
│  ├── checkDietPatternRules()                                │
│  ├── checkMedicalRules()                                    │
│  └── determineSeverity()                                    │
│                                                              │
│  FoodTaggingService (existing)                              │
│  ├── deriveNutritionTags()                                  │
│  └── deriveHealthFlags()                                    │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                 DATA LAYER (Prisma ORM)                     │
├─────────────────────────────────────────────────────────────┤
│  Client (with validation tags)                              │
│  FoodItem (with safety/nutrition tags)                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Data Flow

**Single Food Validation:**
```
1. Dietitian searches food in modal
2. Frontend calls GET /api/validation/single?clientId=X&foodId=Y&mealType=breakfast
3. ValidationService:
   a. Fetch Client and FoodItem from DB
   b. Run rule checks (allergy → diet → medical → preferences)
   c. Aggregate messages and determine severity
4. API returns { severity, blocked, messages[], allowed }
5. Frontend displays color-coded border and alert panel
```

**Bulk Validation (optimized):**
```
1. Frontend sends POST /api/validation/bulk with { clientId, foodIds[], mealType, date }
2. Service fetches client once
3. Parallel validation of all foods
4. Returns array of validation results
5. Frontend caches results for quick display
```

---

## 3. Database Schema

### 3.1 Existing Schema (Already Implemented ✅)

**Client Model** - Located in `backend/prisma/schema.prisma`

```prisma
model Client {
  // ... existing fields
  
  // Hard Constraints (RED blocking)
  allergies         String[]  @default([])
  dietPattern       String?   // "vegetarian" | "vegan" | "non_veg" | "pescatarian"
  
  // Soft Constraints (YELLOW warnings)
  intolerances      String[]  @default([])
  eggAllowed        Boolean   @default(true)
  eggAvoidDays      String[]  @default([])  // ["tuesday", "saturday"]
  dislikes          String[]  @default([])
  avoidCategories   String[]  @default([])
  labDerivedTags    String[]  @default([])  // ["pre_diabetes", "vitamin_d_deficiency"]
  medicalConditions String[]  @default([])  // ["PCOS", "thyroid"]
  
  // Preferences (GREEN positive)
  likedFoods        String[]  @default([])
  preferredCuisines String[]  @default([])
}
```

**FoodItem Model**

```prisma
model FoodItem {
  // ... existing fields
  
  // Safety Tags
  allergenFlags        String[]  @default([])  // ["contains_peanuts", "contains_dairy"]
  dietaryCategory      String?                  // "vegan" | "vegetarian" | "veg_with_egg" | "non_veg"
  
  // Health & Nutrition Tags
  healthFlags          String[]  @default([])  // ["diabetic_caution", "heart_caution"]
  nutritionTags        String[]  @default([])  // ["high_sugar", "high_protein", "low_carb"]
  
  // Suitability Tags
  cuisineTags          String[]  @default([])  // ["indian", "mughlai"]
  mealSuitabilityTags  String[]  @default([])  // ["good_for_breakfast", "too_heavy_for_night"]
  processingLevel      String?                  // "raw" | "minimally_processed" | "ultra_processed"
  
  // Nutrition fields for auto-tagging
  sugarG      Float?
  proteinG    Float?
  carbsG      Float?
  fatsG       Float?
  sodiumMg    Float?
}
```

### 3.2 Tag Mappings Reference

**Allergen Mapping:**
```typescript
const ALLERGEN_MAPPING = {
  'peanuts': 'contains_peanuts',
  'tree_nuts': 'contains_tree_nuts',
  'dairy': 'contains_dairy',
  'eggs': 'contains_eggs',
  'wheat': 'contains_wheat',
  'soy': 'contains_soy',
  'fish': 'contains_fish',
  'shellfish': 'contains_shellfish',
  'sesame': 'contains_sesame',
  'mustard': 'contains_mustard',
  'celery': 'contains_celery',
  'sulphites': 'contains_sulphites',
};
```

**Diet Pattern Conflicts:**
```typescript
const DIET_CONFLICTS = {
  'vegan': ['non_veg', 'vegetarian', 'veg_with_egg'],
  'vegetarian': ['non_veg'],
  'vegetarian_with_egg': ['non_veg'],
  'pescatarian': ['non_veg'], // except fish
};
```

---

## 4. Backend Implementation

### 4.1 File Structure

```
backend/src/
├── services/
│   ├── validation.service.ts          [NEW]
│   └── foodTagging.service.ts         [EXISTS]
├── controllers/
│   └── validation.controller.ts       [NEW]
├── routes/
│   └── validation.routes.ts           [NEW]
├── types/
│   └── validation.types.ts            [NEW]
└── utils/
    └── validation-rules.ts            [NEW]
```

### 4.2 Core Types

**File:** `backend/src/types/validation.types.ts`

```typescript
export enum ValidationSeverity {
  RED = 'RED',
  YELLOW = 'YELLOW',
  GREEN = 'GREEN',
}

export enum ValidationMessageType {
  ALLERGY_ALERT = 'ALLERGY_ALERT',
  DIET_CONFLICT = 'DIET_CONFLICT',
  DAY_RESTRICTION = 'DAY_RESTRICTION',
  INTOLERANCE = 'INTOLERANCE',
  HEALTH_CAUTION = 'HEALTH_CAUTION',
  FOOD_DISLIKE = 'FOOD_DISLIKE',
  CATEGORY_AVOIDANCE = 'CATEGORY_AVOIDANCE',
  MEAL_SUITABILITY = 'MEAL_SUITABILITY',
  PREFERENCE_MATCH = 'PREFERENCE_MATCH',
}

export interface ValidationMessage {
  type: ValidationMessageType;
  severity: ValidationSeverity;
  title: string;
  message: string;
  details?: string;
  recommendation?: string;
}

export interface ValidationResult {
  foodId: string;
  severity: ValidationSeverity;
  blocked: boolean;
  allowed: boolean;
  messages: ValidationMessage[];
}

export interface ValidationContext {
  clientId: string;
  foodId: string;
  mealType?: 'breakfast' | 'lunch' | 'dinner' | 'snack';
  date?: Date;
}
```

### 4.3 Validation Service

**File:** `backend/src/services/validation.service.ts`

```typescript
import { PrismaClient } from '@prisma/client';
import {
  ValidationResult,
  ValidationMessage,
  ValidationSeverity,
  ValidationMessageType,
  ValidationContext,
} from '../types/validation.types';
import {
  ALLERGEN_MAPPING,
  DIET_CONFLICTS,
  INTOLERANCE_MAPPING,
  MEDICAL_FLAG_MAPPING,
} from '../utils/validation-rules';

const prisma = new PrismaClient();

export class ValidationService {
  /**
   * Validate a single food against client profile
   */
  async validateFood(context: ValidationContext): Promise<ValidationResult> {
    const { clientId, foodId, mealType, date = new Date() } = context;

    // Fetch data
    const [client, food] = await Promise.all([
      prisma.client.findUnique({ where: { id: clientId } }),
      prisma.foodItem.findUnique({ where: { id: foodId } }),
    ]);

    if (!client || !food) {
      throw new Error('Client or Food not found');
    }

    const messages: ValidationMessage[] = [];
    const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();

    // RULE 1: Allergy Check (RED - BLOCKING)
    this.checkAllergies(client, food, messages);

    // RULE 2: Diet Pattern Check (RED - BLOCKING)
    this.checkDietPattern(client, food, messages);

    // RULE 3: Egg Day Restriction (RED - BLOCKING)
    this.checkEggRestriction(client, food, dayOfWeek, messages);

    // RULE 4: Intolerance Check (YELLOW - WARNING)
    this.checkIntolerances(client, food, messages);

    // RULE 5: Medical Flags (YELLOW - WARNING)
    this.checkMedicalFlags(client, food, messages);

    // RULE 6: Dislikes (YELLOW - WARNING)
    this.checkDislikes(client, food, messages);

    // RULE 7: Category Avoidance (YELLOW - WARNING)
    this.checkCategoryAvoidance(client, food, messages);

    // RULE 8: Meal Suitability (YELLOW - INFO)
    if (mealType) {
      this.checkMealSuitability(food, mealType, messages);
    }

    // RULE 9: Preference Match (GREEN - POSITIVE)
    this.checkPreferences(client, food, messages);

    // Determine final severity and blocked status
    const severity = this.determineSeverity(messages);
    const blocked = messages.some(m => m.severity === ValidationSeverity.RED);

    return {
      foodId,
      severity,
      blocked,
      allowed: !blocked,
      messages,
    };
  }

  /**
   * Validate multiple foods (optimized bulk operation)
   */
  async validateFoodsBulk(
    clientId: string,
    foodIds: string[],
    mealType?: string,
    date?: Date
  ): Promise<ValidationResult[]> {
    const results = await Promise.all(
      foodIds.map(foodId =>
        this.validateFood({ clientId, foodId, mealType, date })
      )
    );
    return results;
  }

  // RULE IMPLEMENTATIONS

  private checkAllergies(client: any, food: any, messages: ValidationMessage[]): void {
    if (!client.allergies || client.allergies.length === 0) return;

    for (const allergen of client.allergies) {
      const allergenFlag = ALLERGEN_MAPPING[allergen];
      if (allergenFlag && food.allergenFlags.includes(allergenFlag)) {
        messages.push({
          type: ValidationMessageType.ALLERGY_ALERT,
          severity: ValidationSeverity.RED,
          title: '⛔ ALLERGY ALERT',
          message: `This food contains ${allergen}.`,
          details: `Client has a ${allergen} allergy.`,
          recommendation: 'This food cannot be added to the meal plan.',
        });
      }
    }
  }

  private checkDietPattern(client: any, food: any, messages: ValidationMessage[]): void {
    if (!client.dietPattern || !food.dietaryCategory) return;

    const conflicts = DIET_CONFLICTS[client.dietPattern] || [];
    if (conflicts.includes(food.dietaryCategory)) {
      messages.push({
        type: ValidationMessageType.DIET_CONFLICT,
        severity: ValidationSeverity.RED,
        title: '⛔ DIET CONFLICT',
        message: `This is a ${food.dietaryCategory} food.`,
        details: `Client follows a ${client.dietPattern} diet.`,
        recommendation: 'This food cannot be added.',
      });
    }
  }

  private checkEggRestriction(
    client: any,
    food: any,
    dayOfWeek: string,
    messages: ValidationMessage[]
  ): void {
    if (!client.eggAvoidDays || client.eggAvoidDays.length === 0) return;

    const isEggFood =
      food.dietaryCategory === 'veg_with_egg' ||
      food.name.toLowerCase().includes('egg') ||
      food.allergenFlags.includes('contains_eggs');

    if (isEggFood && client.eggAvoidDays.includes(dayOfWeek)) {
      messages.push({
        type: ValidationMessageType.DAY_RESTRICTION,
        severity: ValidationSeverity.RED,
        title: '⛔ DAY RESTRICTION',
        message: `Client avoids eggs on ${dayOfWeek}.`,
        details: `Today is ${dayOfWeek}.`,
        recommendation: 'Choose a non-egg alternative.',
      });
    }
  }

  private checkIntolerances(client: any, food: any, messages: ValidationMessage[]): void {
    if (!client.intolerances || client.intolerances.length === 0) return;

    for (const intolerance of client.intolerances) {
      const checkFlags = INTOLERANCE_MAPPING[intolerance] || [];
      const hasMatch = checkFlags.some(flag =>
        food.allergenFlags.includes(flag) || food.nutritionTags.includes(flag)
      );

      if (hasMatch) {
        messages.push({
          type: ValidationMessageType.INTOLERANCE,
          severity: ValidationSeverity.YELLOW,
          title: '⚠️ INTOLERANCE',
          message: `This food may contain ${intolerance}.`,
          details: `Client has ${intolerance} intolerance.`,
          recommendation: 'Consider alternatives or limit portion size.',
        });
      }
    }
  }

  private checkMedicalFlags(client: any, food: any, messages: ValidationMessage[]): void {
    const allConditions = [...(client.labDerivedTags || []), ...(client.medicalConditions || [])];

    for (const condition of allConditions) {
      const flags = MEDICAL_FLAG_MAPPING[condition] || [];
      const hasMatch = flags.some(flag => food.healthFlags.includes(flag));

      if (hasMatch) {
        messages.push({
          type: ValidationMessageType.HEALTH_CAUTION,
          severity: ValidationSeverity.YELLOW,
          title: '⚠️ HEALTH CAUTION',
          message: `This food may not be ideal for ${condition}.`,
          recommendation: 'Consider portion control or alternatives.',
        });
      }
    }
  }

  private checkDislikes(client: any, food: any, messages: ValidationMessage[]): void {
    if (!client.dislikes || client.dislikes.length === 0) return;

    const isDisliked = client.dislikes.some((dislike: string) =>
      food.name.toLowerCase().includes(dislike.toLowerCase())
    );

    if (isDisliked) {
      messages.push({
        type: ValidationMessageType.FOOD_DISLIKE,
        severity: ValidationSeverity.YELLOW,
        title: '⚠️ PREFERENCE',
        message: 'Client has indicated they dislike this food.',
        recommendation: 'Consider alternatives client prefers.',
      });
    }
  }

  private checkCategoryAvoidance(client: any, food: any, messages: ValidationMessage[]): void {
    if (!client.avoidCategories || client.avoidCategories.length === 0) return;

    const isAvoided = client.avoidCategories.some((cat: string) =>
      food.category?.toLowerCase().includes(cat.toLowerCase())
    );

    if (isAvoided) {
      messages.push({
        type: ValidationMessageType.CATEGORY_AVOIDANCE,
        severity: ValidationSeverity.YELLOW,
        title: '⚠️ AVOID CATEGORY',
        message: `Client prefers to avoid ${food.category} foods.`,
      });
    }
  }

  private checkMealSuitability(food: any, mealType: string, messages: ValidationMessage[]): void {
    if (!food.mealSuitabilityTags || food.mealSuitabilityTags.length === 0) return;

    // Example: too_heavy_for_night + dinner = conflict
    const conflicts = {
      dinner: ['too_heavy_for_night'],
      breakfast: ['too_heavy_for_breakfast'],
    };

    const conflictTags = conflicts[mealType] || [];
    const hasConflict = conflictTags.some(tag => food.mealSuitabilityTags.includes(tag));

    if (hasConflict) {
      messages.push({
        type: ValidationMessageType.MEAL_SUITABILITY,
        severity: ValidationSeverity.YELLOW,
        title: 'ℹ️ MEAL TIMING',
        message: `This food may not be ideal for ${mealType}.`,
      });
    }
  }

  private checkPreferences(client: any, food: any, messages: ValidationMessage[]): void {
    const isLiked = client.likedFoods?.includes(food.id);
    const cuisineMatch = client.preferredCuisines?.some((cuisine: string) =>
      food.cuisineTags?.includes(cuisine)
    );

    if (isLiked) {
      messages.push({
        type: ValidationMessageType.PREFERENCE_MATCH,
        severity: ValidationSeverity.GREEN,
        title: '✓ Client Favorite',
        message: 'Client likes this food.',
      });
    }

    if (cuisineMatch) {
      messages.push({
        type: ValidationMessageType.PREFERENCE_MATCH,
        severity: ValidationSeverity.GREEN,
        title: '✓ Preferred Cuisine',
        message: 'Matches client cuisine preference.',
      });
    }
  }

  private determineSeverity(messages: ValidationMessage[]): ValidationSeverity {
    if (messages.some(m => m.severity === ValidationSeverity.RED)) {
      return ValidationSeverity.RED;
    }
    if (messages.some(m => m.severity === ValidationSeverity.YELLOW)) {
      return ValidationSeverity.YELLOW;
    }
    return ValidationSeverity.GREEN;
  }
}

export const validationService = new ValidationService();
```

### 4.4 Validation Rules Utility

**File:** `backend/src/utils/validation-rules.ts`

```typescript
export const ALLERGEN_MAPPING: Record<string, string> = {
  peanuts: 'contains_peanuts',
  tree_nuts: 'contains_tree_nuts',
  dairy: 'contains_dairy',
  eggs: 'contains_eggs',
  wheat: 'contains_wheat',
  soy: 'contains_soy',
  fish: 'contains_fish',
  shellfish: 'contains_shellfish',
  sesame: 'contains_sesame',
  mustard: 'contains_mustard',
  celery: 'contains_celery',
  sulphites: 'contains_sulphites',
};

export const DIET_CONFLICTS: Record<string, string[]> = {
  vegan: ['non_veg', 'vegetarian', 'veg_with_egg'],
  vegetarian: ['non_veg'],
  vegetarian_with_egg: ['non_veg'],
  pescatarian: ['non_veg'],
};

export const INTOLERANCE_MAPPING: Record<string, string[]> = {
  lactose: ['contains_dairy'],
  gluten: ['contains_wheat', 'contains_gluten'],
  fructose: ['high_sugar'],
};

export const MEDICAL_FLAG_MAPPING: Record<string, string[]> = {
  diabetes: ['diabetic_caution'],
  pre_diabetes: ['diabetic_caution'],
  heart_disease: ['heart_caution'],
  high_cholesterol: ['heart_caution'],
  kidney_disease: ['kidney_caution'],
  hypertension: ['high_sodium'],
  PCOS: ['diabetic_caution'],
};
```

---

## 5. API Contracts

### 5.1 Validation Controller

**File:** `backend/src/controllers/validation.controller.ts`

```typescript
import { Request, Response } from 'express';
import { validationService } from '../services/validation.service';

export class ValidationController {
  /**
   * POST /api/validation/single
   * Validate a single food for a client
   */
  async validateSingleFood(req: Request, res: Response) {
    try {
      const { clientId, foodId, mealType, date } = req.body;

      if (!clientId || !foodId) {
        return res.status(400).json({ error: 'clientId and foodId are required' });
      }

      const result = await validationService.validateFood({
        clientId,
        foodId,
        mealType,
        date: date ? new Date(date) : new Date(),
      });

      return res.json(result);
    } catch (error) {
      console.error('Validation error:', error);
      return res.status(500).json({ error: 'Validation failed' });
    }
  }

  /**
   * POST /api/validation/bulk
   * Validate multiple foods at once
   */
  async validateBulkFoods(req: Request, res: Response) {
    try {
      const { clientId, foodIds, mealType, date } = req.body;

      if (!clientId || !foodIds || !Array.isArray(foodIds)) {
        return res.status(400).json({ error: 'clientId and foodIds array are required' });
      }

      const results = await validationService.validateFoodsBulk(
        clientId,
        foodIds,
        mealType,
        date ? new Date(date) : new Date()
      );

      return res.json({ results });
    } catch (error) {
      console.error('Bulk validation error:', error);
      return res.status(500).json({ error: 'Bulk validation failed' });
    }
  }
}

export const validationController = new ValidationController();
```

### 5.2 Routes

**File:** `backend/src/routes/validation.routes.ts`

```typescript
import { Router } from 'express';
import { validationController } from '../controllers/validation.controller';
import { requireAuth } from '../middleware/auth';

const router = Router();

// All validation routes require authentication
router.use(requireAuth);

router.post('/single', validationController.validateSingleFood);
router.post('/bulk', validationController.validateBulkFoods);

export default router;
```

**Register in main app:**

```typescript
// backend/src/app.ts or index.ts
import validationRoutes from './routes/validation.routes';
app.use('/api/validation', validationRoutes);
```

### 5.3 API Endpoint Documentation

#### POST `/api/validation/single`

**Request:**
```json
{
  "clientId": "client_123",
  "foodId": "food_456",
  "mealType": "breakfast",
  "date": "2026-02-04T00:00:00Z"
}
```

**Response (RED - Blocked):**
```json
{
  "foodId": "food_456",
  "severity": "RED",
  "blocked": true,
  "allowed": false,
  "messages": [
    {
      "type": "ALLERGY_ALERT",
      "severity": "RED",
      "title": "⛔ ALLERGY ALERT",
      "message": "This food contains peanuts.",
      "details": "Client has a peanuts allergy.",
      "recommendation": "This food cannot be added to the meal plan."
    }
  ]
}
```

**Response (YELLOW - Warning):**
```json
{
  "foodId": "food_789",
  "severity": "YELLOW",
  "blocked": false,
  "allowed": true,
  "messages": [
    {
      "type": "HEALTH_CAUTION",
      "severity": "YELLOW",
      "title": "⚠️ HEALTH CAUTION",
      "message": "This food may not be ideal for pre_diabetes.",
      "recommendation": "Consider portion control or alternatives."
    }
  ]
}
```

#### POST `/api/validation/bulk`

**Request:**
```json
{
  "clientId": "client_123",
  "foodIds": ["food_1", "food_2", "food_3"],
  "mealType": "lunch",
  "date": "2026-02-04T00:00:00Z"
}
```

**Response:**
```json
{
  "results": [
    {
      "foodId": "food_1",
      "severity": "GREEN",
      "blocked": false,
      "allowed": true,
      "messages": []
    },
    {
      "foodId": "food_2",
      "severity": "YELLOW",
      "blocked": false,
      "allowed": true,
      "messages": [...]
    },
    {
      "foodId": "food_3",
      "severity": "RED",
      "blocked": true,
      "allowed": false,
      "messages": [...]
    }
  ]
}
```

---

## 6. Frontend Implementation

### 6.1 File Structure

```
frontend/src/
├── components/
│   ├── dietitian/
│   │   ├── AddFoodModal.tsx              [MODIFY]
│   │   ├── FoodCard.tsx                  [MODIFY]
│   │   └── ValidationDisplay.tsx         [NEW]
│   └── common/
│       └── ValidationAlert.tsx           [NEW]
├── hooks/
│   └── useValidation.ts                  [NEW]
├── services/
│   └── validationService.ts              [NEW]
└── types/
    └── validation.types.ts               [NEW]
```

### 6.2 Frontend Types

**File:** `frontend/src/types/validation.types.ts`

```typescript
export type ValidationSeverity = 'RED' | 'YELLOW' | 'GREEN';

export interface ValidationMessage {
  type: string;
  severity: ValidationSeverity;
  title: string;
  message: string;
  details?: string;
  recommendation?: string;
}

export interface ValidationResult {
  foodId: string;
  severity: ValidationSeverity;
  blocked: boolean;
  allowed: boolean;
  messages: ValidationMessage[];
}
```

### 6.3 Validation Service (Frontend)

**File:** `frontend/src/services/validationService.ts`

```typescript
import axios from 'axios';
import { ValidationResult } from '../types/validation.types';

const API_BASE = process.env.REACT_APP_API_URL || 'http://localhost:3001';

export const validationService = {
  async validateFood(
    clientId: string,
    foodId: string,
    mealType?: string,
    date?: Date
  ): Promise<ValidationResult> {
    const response = await axios.post(`${API_BASE}/api/validation/single`, {
      clientId,
      foodId,
      mealType,
      date: date?.toISOString(),
    });
    return response.data;
  },

  async validateFoodsBulk(
    clientId: string,
    foodIds: string[],
    mealType?: string,
    date?: Date
  ): Promise<ValidationResult[]> {
    const response = await axios.post(`${API_BASE}/api/validation/bulk`, {
      clientId,
      foodIds,
      mealType,
      date: date?.toISOString(),
    });
    return response.data.results;
  },
};
```

### 6.4 Validation Hook

**File:** `frontend/src/hooks/useValidation.ts`

```typescript
import { useState, useEffect } from 'react';
import { validationService } from '../services/validationService';
import { ValidationResult } from '../types/validation.types';

export const useValidation = (
  clientId: string,
  foodIds: string[],
  mealType?: string,
  date?: Date
) => {
  const [validationResults, setValidationResults] = useState<Map<string, ValidationResult>>(
    new Map()
  );
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (foodIds.length === 0 || !clientId) return;

    const fetchValidations = async () => {
      setLoading(true);
      setError(null);

      try {
        const results = await validationService.validateFoodsBulk(
          clientId,
          foodIds,
          mealType,
          date
        );

        const resultsMap = new Map<string, ValidationResult>();
        results.forEach(result => {
          resultsMap.set(result.foodId, result);
        });

        setValidationResults(resultsMap);
      } catch (err) {
        setError('Failed to validate foods');
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    fetchValidations();
  }, [clientId, foodIds, mealType, date]);

  return { validationResults, loading, error };
};
```

### 6.5 Validation Alert Component

**File:** `frontend/src/components/common/ValidationAlert.tsx`

```tsx
import React from 'react';
import { ValidationMessage, ValidationSeverity } from '../../types/validation.types';

interface ValidationAlertProps {
  messages: ValidationMessage[];
  severity: ValidationSeverity;
}

const getSeverityStyles = (severity: ValidationSeverity) => {
  switch (severity) {
    case 'RED':
      return {
        container: 'bg-red-50 border-red-300',
        icon: '⛔',
        iconColor: 'text-red-600',
        titleColor: 'text-red-800',
        textColor: 'text-red-700',
      };
    case 'YELLOW':
      return {
        container: 'bg-yellow-50 border-yellow-300',
        icon: '⚠️',
        iconColor: 'text-yellow-600',
        titleColor: 'text-yellow-800',
        textColor: 'text-yellow-700',
      };
    case 'GREEN':
      return {
        container: 'bg-green-50 border-green-300',
        icon: '✓',
        iconColor: 'text-green-600',
        titleColor: 'text-green-800',
        textColor: 'text-green-700',
      };
  }
};

export const ValidationAlert: React.FC<ValidationAlertProps> = ({ messages, severity }) => {
  if (messages.length === 0) return null;

  const styles = getSeverityStyles(severity);

  return (
    <div className={`border rounded-lg p-4 ${styles.container}`}>
      {messages.map((msg, index) => (
        <div key={index} className="mb-3 last:mb-0">
          <div className="flex items-start gap-2">
            <span className={`text-xl ${styles.iconColor}`}>{styles.icon}</span>
            <div className="flex-1">
              <h4 className={`font-semibold ${styles.titleColor}`}>{msg.title}</h4>
              <p className={`text-sm ${styles.textColor} mt-1`}>{msg.message}</p>
              {msg.details && (
                <p className={`text-sm ${styles.textColor} mt-1`}>{msg.details}</p>
              )}
              {msg.recommendation && (
                <p className={`text-sm ${styles.textColor} mt-2 font-medium`}>
                  💡 {msg.recommendation}
                </p>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  );
};
```

### 6.6 Food Card with Validation

**File:** `frontend/src/components/dietitian/FoodCard.tsx` (Modifications)

```tsx
import React from 'react';
import { ValidationResult } from '../../types/validation.types';
import { ValidationAlert } from '../common/ValidationAlert';

interface FoodCardProps {
  food: FoodItem;
  validationResult?: ValidationResult;
  onAdd: () => void;
}

export const FoodCard: React.FC<FoodCardProps> = ({ food, validationResult, onAdd }) => {
  const getBorderColor = () => {
    if (!validationResult) return 'border-gray-200';
    switch (validationResult.severity) {
      case 'RED':
        return 'border-red-500 border-2';
      case 'YELLOW':
        return 'border-yellow-500 border-2';
      case 'GREEN':
        return 'border-green-500';
      default:
        return 'border-gray-200';
    }
  };

  const getButtonState = () => {
    if (!validationResult) return { disabled: false, text: 'Add' };
    if (validationResult.blocked) return { disabled: true, text: 'Blocked' };
    if (validationResult.severity === 'YELLOW') return { disabled: false, text: 'Add Anyway' };
    return { disabled: false, text: 'Add' };
  };

  const buttonState = getButtonState();

  return (
    <div className={`rounded-lg border ${getBorderColor()} p-4 shadow-sm`}>
      {/* Food Image & Info */}
      <img src={food.imageUrl} alt={food.name} className="w-full h-32 object-cover rounded" />
      <h3 className="font-semibold mt-2">{food.name}</h3>
      <p className="text-sm text-gray-600">{food.category}</p>

      {/* Validation Alerts */}
      {validationResult && validationResult.messages.length > 0 && (
        <div className="mt-3">
          <ValidationAlert
            messages={validationResult.messages}
            severity={validationResult.severity}
          />
        </div>
      )}

      {/* Add Button */}
      <button
        onClick={onAdd}
        disabled={buttonState.disabled}
        className={`mt-4 w-full py-2 rounded ${
          buttonState.disabled
            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
            : validationResult?.severity === 'YELLOW'
            ? 'bg-yellow-500 text-white hover:bg-yellow-600'
            : 'bg-green-500 text-white hover:bg-green-600'
        }`}
      >
        {buttonState.text}
      </button>
    </div>
  );
};
```

### 6.7 Add Food Modal with Validation

**File:** `frontend/src/components/dietitian/AddFoodModal.tsx` (Modifications)

```tsx
import React, { useState, useEffect } from 'react';
import { FoodCard } from './FoodCard';
import { useValidation } from '../../hooks/useValidation';

interface AddFoodModalProps {
  clientId: string;
  mealType: 'breakfast' | 'lunch' | 'dinner' | 'snack';
  date: Date;
  onClose: () => void;
  onAddFood: (foodId: string) => void;
}

export const AddFoodModal: React.FC<AddFoodModalProps> = ({
  clientId,
  mealType,
  date,
  onClose,
  onAddFood,
}) => {
  const [searchResults, setSearchResults] = useState<FoodItem[]>([]);
  const foodIds = searchResults.map(f => f.id);

  // Validate all visible foods
  const { validationResults, loading } = useValidation(clientId, foodIds, mealType, date);

  const handleAddFood = (foodId: string) => {
    const validation = validationResults.get(foodId);

    if (validation?.blocked) {
      // Should not reach here due to disabled button
      return;
    }

    if (validation?.severity === 'YELLOW') {
      // Show confirmation dialog
      const confirmed = window.confirm(
        'This food has warnings. Are you sure you want to add it?'
      );
      if (!confirmed) return;
    }

    onAddFood(foodId);
  };

  return (
    <div className="modal">
      <div className="modal-content">
        <h2>Add Food to {mealType}</h2>

        {/* Search input */}
        {/* ... search implementation ... */}

        {/* Food grid */}
        <div className="grid grid-cols-3 gap-4 mt-4">
          {searchResults.map(food => (
            <FoodCard
              key={food.id}
              food={food}
              validationResult={validationResults.get(food.id)}
              onAdd={() => handleAddFood(food.id)}
            />
          ))}
        </div>

        <button onClick={onClose} className="mt-4">
          Close
        </button>
      </div>
    </div>
  );
};
```

---

## 7. Testing Strategy

### 7.1 Unit Tests

**Backend Service Tests:**

**File:** `backend/src/services/__tests__/validation.service.test.ts`

```typescript
import { ValidationService } from '../validation.service';
import { PrismaClient } from '@prisma/client';

jest.mock('@prisma/client');

describe('ValidationService', () => {
  let service: ValidationService;
  let prisma: jest.Mocked<PrismaClient>;

  beforeEach(() => {
    service = new ValidationService();
    prisma = new PrismaClient() as jest.Mocked<PrismaClient>;
  });

  describe('Allergy Validation', () => {
    it('should block food with matching allergen', async () => {
      const client = {
        id: 'client1',
        allergies: ['peanuts'],
      };

      const food = {
        id: 'food1',
        name: 'Peanut Butter',
        allergenFlags: ['contains_peanuts'],
      };

      prisma.client.findUnique = jest.fn().mockResolvedValue(client);
      prisma.foodItem.findUnique = jest.fn().mockResolvedValue(food);

      const result = await service.validateFood({
        clientId: 'client1',
        foodId: 'food1',
      });

      expect(result.severity).toBe('RED');
      expect(result.blocked).toBe(true);
      expect(result.messages).toHaveLength(1);
      expect(result.messages[0].type).toBe('ALLERGY_ALERT');
    });

    it('should allow food without allergen match', async () => {
      const client = {
        id: 'client1',
        allergies: ['peanuts'],
      };

      const food = {
        id: 'food2',
        name: 'Rice',
        allergenFlags: [],
      };

      prisma.client.findUnique = jest.fn().mockResolvedValue(client);
      prisma.foodItem.findUnique = jest.fn().mockResolvedValue(food);

      const result = await service.validateFood({
        clientId: 'client1',
        foodId: 'food2',
      });

      expect(result.severity).toBe('GREEN');
      expect(result.blocked).toBe(false);
    });
  });

  describe('Diet Pattern Validation', () => {
    it('should block non-veg food for vegetarian client', async () => {
      const client = {
        id: 'client1',
        dietPattern: 'vegetarian',
      };

      const food = {
        id: 'food1',
        name: 'Chicken',
        dietaryCategory: 'non_veg',
      };

      prisma.client.findUnique = jest.fn().mockResolvedValue(client);
      prisma.foodItem.findUnique = jest.fn().mockResolvedValue(food);

      const result = await service.validateFood({
        clientId: 'client1',
        foodId: 'food1',
      });

      expect(result.severity).toBe('RED');
      expect(result.blocked).toBe(true);
      expect(result.messages[0].type).toBe('DIET_CONFLICT');
    });
  });

  // Add more test cases for each rule...
});
```

**Run backend tests:**
```bash
cd backend
npm test -- validation.service.test.ts
```

### 7.2 API Integration Tests

**File:** `backend/src/routes/__tests__/validation.routes.test.ts`

```typescript
import request from 'supertest';
import app from '../../app';

describe('Validation API', () => {
  it('POST /api/validation/single - should validate food successfully', async () => {
    const response = await request(app)
      .post('/api/validation/single')
      .send({
        clientId: 'test-client-1',
        foodId: 'test-food-1',
        mealType: 'breakfast',
      })
      .expect(200);

    expect(response.body).toHaveProperty('severity');
    expect(response.body).toHaveProperty('blocked');
    expect(response.body).toHaveProperty('allowed');
    expect(response.body).toHaveProperty('messages');
  });

  it('POST /api/validation/bulk - should validate multiple foods', async () => {
    const response = await request(app)
      .post('/api/validation/bulk')
      .send({
        clientId: 'test-client-1',
        foodIds: ['food-1', 'food-2', 'food-3'],
        mealType: 'lunch',
      })
      .expect(200);

    expect(response.body.results).toHaveLength(3);
  });

  it('should return 400 for missing clientId', async () => {
    await request(app)
      .post('/api/validation/single')
      .send({ foodId: 'food-1' })
      .expect(400);
  });
});
```

### 7.3 End-to-End Tests

**Using Playwright/Cypress:**

```typescript
// e2e/validation.spec.ts
describe('Food Validation Flow', () => {
  it('should show RED border for allergenic food', () => {
    cy.visit('/dietitian/clients/123/meal-plan');
    cy.get('[data-testid="add-food-btn"]').click();
    cy.get('[data-testid="search-input"]').type('Peanut Butter');
    cy.get('[data-testid="food-card"]').should('have.class', 'border-red-500');
    cy.contains('ALLERGY ALERT').should('be.visible');
    cy.get('[data-testid="add-food-to-meal"]').should('be.disabled');
  });

  it('should allow adding food with YELLOW warning after confirmation', () => {
    cy.visit('/dietitian/clients/123/meal-plan');
    cy.get('[data-testid="add-food-btn"]').click();
    cy.get('[data-testid="food-card-high-sugar"]').click();
    cy.contains('HEALTH CAUTION').should('be.visible');
    cy.get('[data-testid="add-anyway-btn"]').click();
    cy.on('window:confirm', () => true);
    cy.contains('Food added successfully').should('be.visible');
  });
});
```

### 7.4 Manual Testing Checklist

**Test Case 1: Allergy Blocking**
1. Navigate to Dietitian Dashboard
2. Select client with peanut allergy
3. Click "Add Food" for breakfast
4. Search for "Peanut Butter"
5. ✅ Verify RED border on food card
6. ✅ Verify "ALLERGY ALERT" message displayed
7. ✅ Verify "Add" button is disabled

**Test Case 2: Medical Warning**
1. Select client with diabetes
2. Add food modal for lunch
3. Search for "Gulab Jamun" (high sugar dessert)
4. ✅ Verify YELLOW border
5. ✅ Verify "HEALTH CAUTION" message
6. ✅ Verify "Add Anyway" button is enabled
7. Click "Add Anyway"
8. ✅ Verify confirmation dialog appears
9. Confirm
10. ✅ Verify food added to meal

**Test Case 3: Egg Day Restriction**
1. Select client who avoids eggs on Tuesday
2. On Tuesday, try adding "Egg Omelette"
3. ✅ Verify RED border and blocking
4. On Wednesday, try adding same food
5. ✅ Verify allowed (GREEN or YELLOW based on other factors)

---

## 8. Deployment Plan

### 8.1 Pre-Deployment Checklist

- [ ] All backend services implemented and tested
- [ ] API endpoints tested with Postman/Insomnia
- [ ] Frontend components tested in isolation
- [ ] E2E tests passing
- [ ] Database migrations applied (if any schema changes)
- [ ] Environment variables configured
- [ ] Performance testing completed (<200ms response time)
- [ ] Error handling tested
- [ ] Logging configured for validation events

### 8.2 Database Migration

No schema changes needed - all fields already exist. Verify with:

```bash
cd backend
npx prisma db pull
npx prisma generate
```

### 8.3 Backend Deployment Steps

```bash
# 1. Pull latest code
git pull origin main

# 2. Install dependencies
cd backend
npm install

# 3. Build TypeScript
npm run build

# 4. Run tests
npm test

# 5. Restart server
pm2 restart backend
# OR
npm run prod
```

### 8.4 Frontend Deployment Steps

```bash
# 1. Pull latest code
git pull origin main

# 2. Install dependencies
cd frontend
npm install

# 3. Build production bundle
npm run build

# 4. Deploy to hosting (Vercel/Netlify)
vercel deploy --prod
# OR
npm run deploy
```

### 8.5 Rollback Plan

If deployment fails:

```bash
# Rollback to previous version
git checkout <previous-commit-hash>
npm install
npm run build
pm2 restart all
```

### 8.6 Monitoring

**Key Metrics to Track:**

- Validation API response time (target: <200ms)
- Number of RED blocks per day
- Number of YELLOW warnings overridden
- Failed validations (errors)

**Logging:**

```typescript
// Add logging to validation service
logger.info('Food validation', {
  clientId,
  foodId,
  severity: result.severity,
  blocked: result.blocked,
  messageCount: result.messages.length,
});
```

---

## 9. Implementation Phases

### Phase 1: Backend Foundation (Week 1)

**Priority: P0 Critical**

- [x] Database schema (already done)
- [ ] Create `validation.types.ts`
- [ ] Create `validation-rules.ts`
- [ ] Implement `ValidationService`
- [ ] Unit tests for ValidationService
- [ ] Create API controller and routes
- [ ] Integration tests for API

**Deliverable:** Functional validation API

---

### Phase 2: Frontend Integration (Week 2)

**Priority: P0 Critical**

- [ ] Create frontend types
- [ ] Implement `validationService.ts` (API client)
- [ ] Create `useValidation` hook
- [ ] Build `ValidationAlert` component
- [ ] Modify `FoodCard` component
- [ ] Update `AddFoodModal` with validation

**Deliverable:** Functional validation UI in dietitian dashboard

---

### Phase 3: Testing & Refinement (Week 3)

**Priority: P1 Important**

- [ ] E2E tests with Playwright
- [ ] Manual testing with real client data
- [ ] Performance optimization
- [ ] UI/UX refinements based on feedback
- [ ] Error handling improvements
- [ ] Accessibility testing

**Deliverable:** Production-ready validation system

---

### Phase 4: Advanced Features (Week 4+)

**Priority: P2 Nice-to-have**

- [ ] Validation caching for better performance
- [ ] Batch validation on page load
- [ ] Smart food suggestions (alternatives)
- [ ] Admin dashboard for validation analytics
- [ ] AI-powered auto-tagging improvements

**Deliverable:** Enhanced validation system

---

## 10. Appendix

### A. Sample Test Data

**Client Profile:**

```json
{
  "id": "test-client-1",
  "name": "Gaurav Kumar",
  "allergies": ["peanuts", "shellfish"],
  "dietPattern": "vegetarian",
  "intolerances": ["lactose"],
  "eggAvoidDays": ["tuesday", "saturday"],
  "dislikes": ["bitter_gourd"],
  "avoidCategories": ["fried_foods"],
  "labDerivedTags": ["pre_diabetes"],
  "medicalConditions": ["PCOS"],
  "likedFoods": ["paneer_tikka"],
  "preferredCuisines": ["indian", "mughlai"]
}
```

**Food Items:**

```json
[
  {
    "id": "food-1",
    "name": "Peanut Butter",
    "allergenFlags": ["contains_peanuts"],
    "dietaryCategory": "vegan"
  },
  {
    "id": "food-2",
    "name": "Chicken Curry",
    "allergenFlags": [],
    "dietaryCategory": "non_veg"
  },
  {
    "id": "food-3",
    "name": "Gulab Jamun",
    "allergenFlags": ["contains_dairy"],
    "healthFlags": ["diabetic_caution"],
    "nutritionTags": ["high_sugar"]
  },
  {
    "id": "food-4",
    "name": "Paneer Tikka",
    "allergenFlags": ["contains_dairy"],
    "dietaryCategory": "vegetarian",
    "cuisineTags": ["indian", "mughlai"]
  }
]
```

### B. Performance Benchmarks

| Operation | Target | Acceptable | Critical |
|-----------|--------|------------|----------|
| Single validation | <100ms | <200ms | <500ms |
| Bulk validation (10 foods) | <500ms | <1s | <2s |
| Bulk validation (50 foods) | <2s | <5s | <10s |
| Frontend render with validation | <200ms | <500ms | <1s |

### C. Error Codes

| Code | Message | Resolution |
|------|---------|------------|
| VAL_001 | Client not found | Verify clientId exists |
| VAL_002 | Food not found | Verify foodId exists |
| VAL_003 | Validation failed | Check logs for details |
| VAL_004 | Invalid mealType | Use: breakfast, lunch, dinner, snack |
| VAL_005 | Invalid date format | Use ISO 8601 format |

### D. Configuration

**Environment Variables:**

```bash
# Backend
NODE_ENV=production
DATABASE_URL=postgresql://...
VALIDATION_CACHE_TTL=300  # 5 minutes
VALIDATION_TIMEOUT=5000   # 5 seconds

# Frontend
REACT_APP_API_URL=https://api.dietkaro.com
REACT_APP_ENABLE_VALIDATION_CACHE=true
```

---

## Document Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | Feb 1, 2026 | AI Assistant | Initial comprehensive tech spec |

---

## Next Steps

1. **Review this document** with the development team
2. **Set up project tracking** in Jira/Linear with tasks from Phase 1
3. **Assign developers** to backend and frontend tracks
4. **Schedule code reviews** for each phase
5. **Plan demo** for stakeholders after Phase 2

---

**Questions or Feedback?**  
Contact: [Your Team Lead/Project Manager]
</file>

<file path="human.html">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Human Body Measurements</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 25px;
      display: flex;
      justify-content: center;
    }

    .wrapper {
      display: flex;
      gap: 30px;
      max-width: 1100px;
      width: 100%;
      align-items: flex-start;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0px 8px 25px rgba(0,0,0,0.08);
    }

    .left {
      width: 420px;
      text-align: center;
    }

    .right {
      flex: 1;
      min-width: 350px;
    }

    h2 {
      margin: 10px 0 20px;
      font-size: 18px;
    }

    svg {
      width: 100%;
      height: auto;
    }

    /* BODY SHAPE */
    .body-part {
      fill: #dcdcdc;
      stroke: #888;
      stroke-width: 2;
      cursor: pointer;
      transition: 0.2s;
    }

    .body-part:hover {
      fill: #ffd08a;
    }

    .body-part.active {
      fill: #ff7a2f;
      stroke: #ff4d00;
    }

    /* MEASUREMENT LINES */
    .measure-line {
      stroke: #222;
      stroke-width: 2;
      stroke-dasharray: 6 4;
      opacity: 0.7;
    }

    .measure-text {
      font-size: 12px;
      font-weight: bold;
      fill: #111;
    }

    .measure-box {
      fill: white;
      stroke: #222;
      stroke-width: 1;
      rx: 6;
    }

    /* RIGHT PANEL */
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #eee;
      margin-bottom: 10px;
      background: #fafafa;
      cursor: pointer;
      transition: 0.2s;
    }

    .row:hover {
      background: #fff1e7;
      border-color: #ff7a2f;
    }

    .row.active {
      background: #ffe7d7;
      border-color: #ff7a2f;
    }

    .row label {
      font-weight: bold;
      font-size: 14px;
    }

    input {
      width: 90px;
      padding: 7px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      font-size: 13px;
      text-align: center;
    }

    input:focus {
      border-color: #ff7a2f;
      box-shadow: 0px 0px 6px rgba(255, 122, 47, 0.4);
    }

    .save-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: #ff7a2f;
      color: white;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
      margin-top: 10px;
    }

    .save-btn:hover {
      background: #ff5c00;
    }

    pre {
      margin-top: 15px;
      padding: 12px;
      border-radius: 12px;
      background: #111;
      color: #0f0;
      font-size: 12px;
      overflow: auto;
    }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: #555;
    }
  </style>
</head>

<body>
  <div class="wrapper">

    <!-- LEFT BODY -->
    <div class="card left">
      <h2>Click a Body Part</h2>

      <svg viewBox="0 0 300 520">

        <!-- HEAD -->
        <ellipse id="head" class="body-part" cx="150" cy="65" rx="45" ry="50"></ellipse>

        <!-- NECK -->
        <rect id="neck" class="body-part" x="130" y="110" width="40" height="20" rx="10"></rect>

        <!-- TORSO (smooth) -->
        <path id="chest" class="body-part"
          d="M90 135
             Q150 105 210 135
             Q225 150 220 190
             Q210 250 150 250
             Q90 250 80 190
             Q75 150 90 135 Z"></path>

        <!-- WAIST / STOMACH -->
        <path id="waist" class="body-part"
          d="M105 250
             Q150 235 195 250
             Q205 265 200 305
             Q190 340 150 340
             Q110 340 100 305
             Q95 265 105 250 Z"></path>

        <!-- HIP -->
        <path id="hips" class="body-part"
          d="M95 340
             Q150 325 205 340
             Q225 360 215 400
             Q200 435 150 435
             Q100 435 85 400
             Q75 360 95 340 Z"></path>

        <!-- LEFT ARM -->
        <path id="leftArm" class="body-part"
          d="M70 155
             Q45 190 50 250
             Q55 310 80 325
             Q95 320 92 300
             Q80 250 85 195
             Q88 165 70 155 Z"></path>

        <!-- RIGHT ARM -->
        <path id="rightArm" class="body-part"
          d="M230 155
             Q255 190 250 250
             Q245 310 220 325
             Q205 320 208 300
             Q220 250 215 195
             Q212 165 230 155 Z"></path>

        <!-- LEFT LEG -->
        <path id="leftLeg" class="body-part"
          d="M120 435
             Q95 470 105 520
             Q115 555 140 555
             Q155 555 155 520
             Q155 470 150 435 Z"></path>

        <!-- RIGHT LEG -->
        <path id="rightLeg" class="body-part"
          d="M180 435
             Q205 470 195 520
             Q185 555 160 555
             Q145 555 145 520
             Q145 470 150 435 Z"></path>

        <!-- ===== Measurement Lines + Values ===== -->

        <!-- Chest -->
        <line x1="65" y1="175" x2="235" y2="175" class="measure-line"></line>
        <rect x="95" y="150" width="110" height="22" class="measure-box"></rect>
        <text id="label-chest" x="150" y="166" text-anchor="middle" class="measure-text">
          Chest: 45"
        </text>

        <!-- Waist -->
        <line x1="80" y1="285" x2="220" y2="285" class="measure-line"></line>
        <rect x="100" y="260" width="100" height="22" class="measure-box"></rect>
        <text id="label-waist" x="150" y="276" text-anchor="middle" class="measure-text">
          Waist: 39.5"
        </text>

        <!-- Stomach -->
        <line x1="75" y1="315" x2="225" y2="315" class="measure-line"></line>
        <rect x="85" y="290" width="130" height="22" class="measure-box"></rect>
        <text id="label-stomach" x="150" y="306" text-anchor="middle" class="measure-text">
          Stomach: 42"
        </text>

        <!-- Hip -->
        <line x1="65" y1="375" x2="235" y2="375" class="measure-line"></line>
        <rect x="100" y="350" width="100" height="22" class="measure-box"></rect>
        <text id="label-hips" x="150" y="366" text-anchor="middle" class="measure-text">
          Hip: 41"
        </text>

        <!-- Thigh -->
        <line x1="95" y1="470" x2="155" y2="470" class="measure-line"></line>
        <rect x="60" y="445" width="120" height="22" class="measure-box"></rect>
        <text id="label-thigh" x="120" y="461" text-anchor="middle" class="measure-text">
          Thigh: 24"
        </text>

        <!-- Calf -->
        <line x1="110" y1="515" x2="150" y2="515" class="measure-line"></line>
        <rect x="60" y="490" width="120" height="22" class="measure-box"></rect>
        <text id="label-calf" x="120" y="506" text-anchor="middle" class="measure-text">
          Calf: 15"
        </text>

        <!-- Arm -->
        <line x1="35" y1="240" x2="85" y2="240" class="measure-line"></line>
        <rect x="10" y="215" width="100" height="22" class="measure-box"></rect>
        <text id="label-arm" x="60" y="231" text-anchor="middle" class="measure-text">
          Arm: 12.5"
        </text>

      </svg>

      <div class="hint">
        Hover highlights. Click body part to edit measurement.
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="card right">
      <h2>Measurements (Inches)</h2>

      <div class="row" id="row-upperArm">
        <label>Upper Arm</label>
        <input id="input-upperArm" type="number" step="0.1" value="12.5" />
      </div>

      <div class="row" id="row-chest">
        <label>Chest</label>
        <input id="input-chest" type="number" step="0.1" value="45" />
      </div>

      <div class="row" id="row-waist">
        <label>Waist</label>
        <input id="input-waist" type="number" step="0.1" value="39.5" />
      </div>

      <div class="row" id="row-stomach">
        <label>Stomach (Naval)</label>
        <input id="input-stomach" type="number" step="0.1" value="42" />
      </div>

      <div class="row" id="row-bellyAbove">
        <label>Belly (2 inch above)</label>
        <input id="input-bellyAbove" type="number" step="0.1" value="41" />
      </div>

      <div class="row" id="row-bellyBelow">
        <label>Belly (2 inch below)</label>
        <input id="input-bellyBelow" type="number" step="0.1" value="41" />
      </div>

      <div class="row" id="row-hips">
        <label>Hip</label>
        <input id="input-hips" type="number" step="0.1" value="41" />
      </div>

      <div class="row" id="row-thigh">
        <label>Upper Thigh</label>
        <input id="input-thigh" type="number" step="0.1" value="24" />
      </div>

      <div class="row" id="row-calf">
        <label>Calf</label>
        <input id="input-calf" type="number" step="0.1" value="15" />
      </div>

      <button class="save-btn" onclick="saveMeasurements()">Save</button>

      <pre id="output"></pre>
    </div>

  </div>

  <script>
    const partMap = {
      upperArm: ["leftArm", "rightArm"],
      chest: ["chest"],
      waist: ["waist"],
      stomach: ["waist"],
      bellyAbove: ["waist"],
      bellyBelow: ["hips"],
      hips: ["hips"],
      thigh: ["leftLeg", "rightLeg"],
      calf: ["leftLeg", "rightLeg"]
    };

    function clearActive() {
      document.querySelectorAll(".body-part").forEach(p => p.classList.remove("active"));
      document.querySelectorAll(".row").forEach(r => r.classList.remove("active"));
    }

    function highlight(partKey) {
      clearActive();

      const row = document.getElementById("row-" + partKey);
      if (row) row.classList.add("active");

      const svgParts = partMap[partKey];
      if (svgParts) {
        svgParts.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.add("active");
        });
      }

      const input = document.getElementById("input-" + partKey);
      if (input) input.focus();
    }

    // Bind row clicks
    Object.keys(partMap).forEach(key => {
      const row = document.getElementById("row-" + key);
      if (row) row.addEventListener("click", () => highlight(key));
    });

    // Bind svg clicks
    document.getElementById("chest").addEventListener("click", () => highlight("chest"));
    document.getElementById("waist").addEventListener("click", () => highlight("waist"));
    document.getElementById("hips").addEventListener("click", () => highlight("hips"));
    document.getElementById("leftArm").addEventListener("click", () => highlight("upperArm"));
    document.getElementById("rightArm").addEventListener("click", () => highlight("upperArm"));
    document.getElementById("leftLeg").addEventListener("click", () => highlight("thigh"));
    document.getElementById("rightLeg").addEventListener("click", () => highlight("thigh"));

    function updateLabels() {
      const upperArm = document.getElementById("input-upperArm").value;
      const chest = document.getElementById("input-chest").value;
      const waist = document.getElementById("input-waist").value;
      const stomach = document.getElementById("input-stomach").value;
      const hips = document.getElementById("input-hips").value;
      const thigh = document.getElementById("input-thigh").value;
      const calf = document.getElementById("input-calf").value;

      document.getElementById("label-arm").textContent = `Arm: ${upperArm}"`;
      document.getElementById("label-chest").textContent = `Chest: ${chest}"`;
      document.getElementById("label-waist").textContent = `Waist: ${waist}"`;
      document.getElementById("label-stomach").textContent = `Stomach: ${stomach}"`;
      document.getElementById("label-hips").textContent = `Hip: ${hips}"`;
      document.getElementById("label-thigh").textContent = `Thigh: ${thigh}"`;
      document.getElementById("label-calf").textContent = `Calf: ${calf}"`;
    }

    document.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", updateLabels);
    });

    function saveMeasurements() {
      const data = {
        upperArm: document.getElementById("input-upperArm").value,
        chest: document.getElementById("input-chest").value,
        waist: document.getElementById("input-waist").value,
        stomach: document.getElementById("input-stomach").value,
        bellyAbove: document.getElementById("input-bellyAbove").value,
        bellyBelow: document.getElementById("input-bellyBelow").value,
        hips: document.getElementById("input-hips").value,
        thigh: document.getElementById("input-thigh").value,
        calf: document.getElementById("input-calf").value
      };

      document.getElementById("output").textContent = JSON.stringify(data, null, 2);
      alert("Saved!");
    }

    // Initial label render
    updateLabels();
  </script>
</body>
</html>
</file>

<file path="info.txt">
REF BY BNI/ gaurav kumar (10k-3mon)-given special discount------------------------(wife homemaker)--------AGE-47KG/  92KG/ BLOOD GROUP- B+VEG-------------------(son age-19yr bsc-son- Bengluru / 2nd-9th class)---------MEDICAL HISTORY--Nothing/ Bellyfat,  heart around pain----------(past history 92- 82 KG (3 time done/ diet in 3year )  8-10 kg-weight loss reduced with previous dietitian--------)1.5 yr. back) then 5-6month-maintained with himself----------------6:0AM- ?---------------Body measurements:-

Upper arm : 12.5
Chest : 45
Waist: 39.5
Stomach (around naval); 42
belly (2inch above naval): 41
belly (2inch below naval) 41
Hip: 41
Upper Thigh : 24 
Calf : 15 Inch-----------------------sat/ sun- early morning match-------------pure veg/ egg- (AVOID TUE/THURS)------------------------DISLIKES---------------------LIKES-egg roll //chaap roll--------------------------------------4/6/25----VIT D 23.18
HBA1C 6.3%
Hs CRP 4.1
VIT B12 155-----------------------------------------------------------
</file>

<file path="medical-log-analysis-spec.md">
# Medical Log Analysis System Specification

## Overview
This system enables the automated extraction, analysis, and tracking of biomarker data from client-uploaded medical reports (PDFs, Images). It uses AI/OCR to parse values, compare them against reference ranges, and flag anomalies for dietitian review.

## Objectives
1.  **Automated Extraction**: Convert unstructured medical reports into structured data.
2.  **Health Tracking**: Monitor biomarker trends over time (e.g., HbA1c improvement).
3.  **Automated Intelligence**: Auto-tag clients based on results (e.g., "High Cholesterol").
4.  **Dietitian Efficiency**: Reduce manual data entry and provide "Out of Range" alerts.

---

## 1. Data Schema Enhancements

### New Model: `LabReport` (Enhancement of `ClientReport`)
Extends existing `ClientReport` or added as a relation.

```prisma
model LabReport {
  id              String        @id @default(uuid())
  clientReportId  String        @unique // Link to the uploaded file
  analyzedAt      DateTime      @default(now())
  status          String        // PENDING, PROCESSING, COMPLETED, FAILED, REVIEW_NEEDED
  labName         String?
  collectionDate  DateTime?
  
  results         LabResult[]
  
  report          ClientReport  @relation(fields: [clientReportId], references: [id])
}

model LabResult {
  id            String    @id @default(uuid())
  labReportId   String
  biomarker     String    // e.g., "Hemoglobin", "TSH" 
  value         Float
  unit          String?   // e.g., "g/dL", "mIU/L"
  referenceLow  Float?
  referenceHigh Float?
  status        String    // NORMAL, LOW, HIGH, CRITICAL
  tags          String[]  // ["anemia_indicator"]
  
  report        LabReport @relation(fields: [labReportId], references: [id])
}
```

---

## 2. Analysis Pipeline

### Step 1: Trigger Analysis
*   **Trigger**: `POST /api/v1/reports/:id/analyze` or Auto-trigger on upload.
*   **Input**: `fileUrl` (S3 path).

### Step 2: OCR & Extraction (AI Service)
*   **Service**: Use OpenAI GPT-4o Vision or AWS Textract to parse the document.
*   **Prompt/Logic**:
    > "Extract all lab results from this image. For each result, identify the Test Name, Value, Unit, and Reference Range. Return as JSON."
*   **Normalization**: Map varied names (e.g., "Hgb", "Haemoglobin") to a standard defined set (`biomarkerKey`).

### Step 3: Validation & Flagging
*   **Logic**:
    *   Parse numerical value.
    *   Compare with extracted Reference Range (or system default if missing).
    *   Assign Status: `LOW` (< min), `HIGH` (> max), `NORMAL`.
*   **Tagging**:
    *   IF `HbA1c > 6.5` -> Add Client Tag: `diabetes`.
    *   IF `VitD < 20` -> Add Client Tag: `vitamin_d_deficiency`.

### Step 4: Storage
*   Save structured data to `LabReport` and `LabResult` tables.
*   Update `Client.labDerivedTags`.

---

## 3. API Endpoints

### Client Side
*   `POST /api/v1/reports` (Existing): Uploads file.
*   `GET /api/v1/reports`: View uploaded reports.

### Dietitian/Admin Side
*   `POST /api/v1/reports/:id/analyze`: Trigger analysis manually.
*   `GET /api/v1/reports/:id/analysis`: Get structured results.
*   `PATCH /api/v1/reports/:id/results/:resultId`: Correct AI mistakes (manual override).
*   `GET /api/v1/clients/:clientId/trends`: Get historical data for specific biomarkers (e.g., TSH over last 6 months).

---

## 4. Implementation Steps

### Phase 1: Infrastructure
1.  Create `LabReport` and `LabResult` models in Prisma.
2.  Set up `AnalysisService` skeleton.

### Phase 2: AI Integration
1.  Integrate AI Provider (OpenAI/Anthropic).
2.  Implement `extractDataFromUrl(url)` method.
3.  Implement parsing logic to handle diverse report formats.

### Phase 3: Dashboard UI
1.  **Results View**: Table showing Test, Value, Range, and Status (Color-coded).
2.  **Trend Graph**: Line chart for key metrics.
3.  **Review Mode**: Interface for Dietitians to verify and approve AI data.

## 5. Security & Privacy
*   **PII Handling**: Scrub non-essential PII before sending to external AI APIs where possible.
*   **Compliance**: Ensure HIPAA/GDPR compliance storage of medical data.
</file>

<file path="remaining.md">
DietKaro - Remaining Work Checklist
Last Updated: February 1, 2026
Current Completion: ~60%

🔴 P0: Critical (Must Have for MVP)
1. Food Validation Engine
The core differentiator - validates food against client restrictions in real-time

Backend:

 Create backend/src/services/validation.service.ts

interface ValidationResult {
  severity: 'RED' | 'YELLOW' | 'GREEN';
  allowed: boolean;
  messages: ValidationMessage[];
}
 Implement validation checks:

 Allergy matching (food allergens vs client allergies) → RED
 Intolerance matching (lactose, gluten) → YELLOW
 Diet pattern (veg/non-veg/vegan) → RED
 Egg day restrictions (avoid on specific days) → YELLOW/RED
 Food dislikes → YELLOW
 Category avoidance (fried foods) → YELLOW
 Health flags (diabetic_caution vs pre_diabetes) → YELLOW
 Meal suitability (heavy food at night) → YELLOW
 Create API endpoint:

POST /api/v1/clients/:clientId/validate-food
Body: { foodId, mealType, date }
Response: ValidationResult
 Create bulk validation endpoint:

POST /api/v1/clients/:clientId/validate-foods
Body: { foodIds: [], mealType, date }
Dashboard:

 Update food selection modal with colored borders
 Show validation messages in alert panel
 Disable "Add" button for RED items
 Add "Add Anyway" with confirmation for YELLOW items
2. Compliance Service
Calculates how well client followed their meal plan

Backend:

 Create 
backend/src/services/compliance.service.ts

 Implement scoring logic:

calculateMealCompliance(mealLog: MealLog): {
  score: number;      // 0-100
  color: 'GREEN' | 'YELLOW' | 'RED';
  issues: string[];   // ['portion_exceeded', 'forbidden_food']
}
 Score criteria:

 Meal eaten on time → +points
 Photo uploaded → +points
 Correct foods → +points
 Portion accuracy → +points
 Substitution made → -points (varies)
 Skipped meal → score = 0
 Daily adherence aggregation:

GET /api/v1/clients/:clientId/adherence/daily?date=
GET /api/v1/clients/:clientId/adherence/weekly
 Auto-trigger on meal log status change

Schema Update:

 Verify MealLog.complianceScore, complianceColor, complianceIssues are populated
3. Complete Onboarding Flow
Missing Screen: Medical History (Step 2)

 Mobile app screen: client-app/app/onboarding/medical-history.tsx
 Condition checkboxes: diabetes, heart disease, PCOS, thyroid, etc.
 Current medications input
 Past surgeries
 Family history text field
 Backend endpoint: POST /api/client/onboarding/step/2-medical
 Save to MedicalProfile table
Missing Screen: Body Measurements (Step 6)

 Mobile app screen: client-app/app/onboarding/body-measurements.tsx
 Chest, waist, hips, thighs, arms measurements
 Unit toggle (cm/inches)
 Optional photo upload
 Backend endpoint: POST /api/client/onboarding/step/6
 Save to BodyMeasurement table
Onboarding Controller Updates:

 Update onboarding.controller.ts for new steps
 Update step count and flow logic
🟡 P1: High Priority
4. Add ClientPreferences Model
Schema:

 Add to 
backend/prisma/schema.prisma
:
model ClientPreferences {
  id                String   @id @default(uuid())
  clientId          String   @unique
  
  // Meal timing
  breakfastTime     String?  // "06:00"
  lunchTime         String?  // "12:00"
  dinnerTime        String?  // "19:30"
  snackTime         String?
  
  // Cooking constraints
  canCook           Boolean  @default(true)
  kitchenAvailable  Boolean  @default(true)
  hasDietaryCook    Boolean  @default(false)
  
  // Activity
  weekdayActivity   String?  // "sedentary_office"
  weekendActivity   String?  // "active_sports"
  sportOrHobby      String?
  
  generalNotes      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}
 Run npx prisma db push
 Add relation to Client model
 Create CRUD endpoints
5. Medical Summary Sidebar (Dashboard)
Backend:

 Create endpoint: GET /api/v1/clients/:id/medical-summary
{
  "allergies": ["shellfish"],
  "intolerances": ["lactose"],
  "conditions": ["pre_diabetes"],
  "labAlerts": [
    { "name": "Vitamin D", "value": 23, "status": "low" }
  ],
  "dietPattern": "vegetarian_with_egg",
  "eggAvoidDays": ["tuesday"],
  "likes": ["paneer tikka"],
  "dislikes": ["bitter gourd"]
}
Dashboard:

 Create frontend/components/MedicalSidebar.tsx
 Color-coded alerts (🔴 critical, 🟡 caution, ✅ ok)
 Always visible while creating diet plans
 Collapsible sections
6. Lab Values Tracking
Schema:

 Add to MedicalProfile:
labValues Json?  // { "hba1c": 6.3, "vitaminD": 23 }
derivedRiskFlags String[]  // ["pre_diabetes", "vitamin_d_deficiency"]
Backend:

 Lab value input endpoint
 Auto-derive risk flags from values:
HbA1c > 6.5 → "diabetic"
HbA1c 5.7-6.5 → "pre_diabetic"
Vitamin D < 30 → "vitamin_d_deficiency"
B12 < 200 → "b12_deficiency"
Mobile:

 Lab values input screen in onboarding
 Reference ranges display
🟢 P2: Medium Priority
7. Session Notes CRUD
Backend:

 Create backend/src/controllers/sessionNote.controller.ts
 Create backend/src/routes/sessionNote.routes.ts
 Endpoints:
 POST /api/v1/clients/:clientId/session-notes
 GET /api/v1/clients/:clientId/session-notes
 PUT /api/v1/session-notes/:id
 DELETE /api/v1/session-notes/:id
Dashboard:

 Session notes tab in client profile
 SOAP note form
8. Invoice System
Backend:

 Create backend/src/controllers/invoice.controller.ts

 Endpoints:

 POST /api/v1/clients/:clientId/invoices
 GET /api/v1/invoices (org-level)
 GET /api/v1/invoices/:id
 PUT /api/v1/invoices/:id/mark-paid
 POST /api/v1/invoices/:id/send (email)
 PDF generation (use @react-pdf/renderer or similar)

 Invoice number auto-generation

Dashboard:

 Invoices list page
 Create invoice form
 Print/download PDF
9. Tag Review Queue (Dietitian Admin)
Backend:

 Create backend/src/controllers/tagReview.controller.ts
 Endpoints:
GET /api/v1/food-items/unverified
PUT /api/v1/food-items/:id/verify
PUT /api/v1/food-items/:id/reject
Dashboard:

 Tag review queue page
 Show food with suggested tags
 Approve/reject/edit actions
10. Activity Logging Service
Backend:

 Create backend/src/services/activityLog.service.ts
 Auto-log on:
 Client created/updated
 Diet plan published
 Meal log reviewed
 User login
 Store in ActivityLog table
Dashboard:

 Activity feed on client profile
 Org-level audit log page
🔵 P3: Nice to Have
11. AI/RAG Document Extraction
 Set up Gemini API integration
 PDF text extraction (pdfjs-dist)
 Structured data extraction prompt
 Confidence scoring
 Store in MedicalProfile.extractedReports
 Dietitian review flow
12. AI Food Recognition
 Integrate vision model for meal photos
 Auto-suggest food items from photo
 Population of MealLog.aiFoodRecognition
13. Redis Caching
 Set up Redis connection
 Cache frequently accessed:
 Food items list
 Client tags (for validation)
 Dashboard stats
14. Test Coverage
Backend:

 Unit tests for ValidationService
 Unit tests for ComplianceService
 Integration tests for auth flow
 Integration tests for meal logging
Frontend:

 Component tests for key UI elements
 E2E tests with Playwright
15. Expand Food Database
 Add 200+ more Indian foods
 Regional cuisines (South Indian, Gujarati, Bengali)
 Street foods with accurate nutrition
 Brand-specific items
⏳ Technical Debt
Schema Sync
 Add ClientPreferences model
 Add labValues to MedicalProfile
 Remove any unused fields
Code Cleanup
 Remove any types in controllers
 Add JSDoc comments to services
 Standardize error messages
Documentation
 Update 
Docs/APIroutes.md
 to match implementation
 Add README for each directory
 API documentation with Swagger/OpenAPI
Summary Table
Priority	Task	Effort	Impact
🔴 P0	Validation Engine	3 days	Critical
🔴 P0	Compliance Service	2 days	Critical
🔴 P0	Complete Onboarding	2 days	Critical
🟡 P1	ClientPreferences Model	0.5 day	High
🟡 P1	Medical Summary Sidebar	1 day	High
🟡 P1	Lab Values Tracking	1 day	High
🟢 P2	Session Notes CRUD	1 day	Medium
🟢 P2	Invoice System	2 days	Medium
🟢 P2	Tag Review Queue	1 day	Medium
🟢 P2	Activity Logging	1 day	Medium
🔵 P3	AI Document Extraction	3 days	Nice
🔵 P3	AI Food Recognition	2 days	Nice
🔵 P3	Redis Caching	1 day	Nice
🔵 P3	Test Coverage	3 days	Nice
Total Estimated Effort: ~24 days for full completion MVP Critical Path: ~7 days (P0 items)


Comment
⌥⌘M
</file>

<file path="backend/src/controllers/clientAuth.controller.ts">
import { Request, Response } from 'express';
import prisma from '../utils/prisma';
import { asyncHandler } from '../utils/asyncHandler';
import { AppError } from '../errors/AppError';
import { signClientToken, ClientAuthRequest } from '../middleware/clientAuth.middleware';
import logger from '../utils/logger';

// In-memory OTP store (use Redis in production)
const otpStore = new Map<string, { otp: string; expiresAt: Date }>();

const generateOTP = (): string => {
    return Math.floor(100000 + Math.random() * 900000).toString();
};

export const requestOTP = asyncHandler(async (req: Request, res: Response) => {
    const { phone } = req.body;

    if (!phone || phone.length < 10) {
        throw AppError.badRequest('Valid phone number required', 'INVALID_PHONE');
    }

    // Check if client exists
    const client = await prisma.client.findFirst({
        where: { phone, isActive: true },
    });

    if (!client) {
        throw AppError.notFound('No account found with this phone number', 'CLIENT_NOT_FOUND');
    }

    // Generate OTP
    const otp = generateOTP();
    const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // 5 minutes

    // Store OTP (in production, send via SMS)
    otpStore.set(phone, { otp, expiresAt });

    logger.info(`[Client OTP] Generated for ${phone}: ${otp}`); // Remove in production

    res.status(200).json({
        success: true,
        message: 'OTP sent successfully',
        // DEV ONLY: Remove in production
        dev_otp: process.env.NODE_ENV === 'development' ? otp : undefined,
    });
});

export const verifyOTP = asyncHandler(async (req: Request, res: Response) => {
    const { phone, otp } = req.body;

    if (!phone || !otp) {
        throw AppError.badRequest('Phone and OTP required', 'MISSING_FIELDS');
    }

    const stored = otpStore.get(phone);

    if (!stored) {
        throw AppError.badRequest('OTP expired or not found', 'OTP_EXPIRED');
    }

    if (stored.expiresAt < new Date()) {
        otpStore.delete(phone);
        throw AppError.badRequest('OTP expired', 'OTP_EXPIRED');
    }

    if (stored.otp !== otp) {
        throw AppError.badRequest('Invalid OTP', 'INVALID_OTP');
    }

    // OTP verified, delete from store
    otpStore.delete(phone);

    // Get client
    const client = await prisma.client.findFirst({
        where: { phone, isActive: true },
        include: {
            primaryDietitian: {
                select: { fullName: true, email: true },
            },
        },
    });

    if (!client) {
        throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');
    }

    // Generate JWT
    const token = signClientToken(client.id);

    logger.info(`[Client Auth] Login successful for ${phone}`);

    res.status(200).json({
        success: true,
        data: {
            token,
            client: {
                id: client.id,
                fullName: client.fullName,
                email: client.email,
                phone: client.phone,
                profilePhotoUrl: client.profilePhotoUrl,
                heightCm: client.heightCm,
                currentWeightKg: client.currentWeightKg,
                targetWeightKg: client.targetWeightKg,
                dietaryPreferences: client.dietaryPreferences,
                allergies: client.allergies,
                onboardingCompleted: client.onboardingCompleted,
                dietitian: client.primaryDietitian,
            },
        },
    });
});

export const getClientProfile = asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const client = await prisma.client.findUnique({
        where: { id: req.client.id },
        include: {
            primaryDietitian: {
                select: { fullName: true, email: true, phone: true },
            },
        },
    });

    if (!client) {
        throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');
    }

    res.status(200).json({
        success: true,
        data: {
            id: client.id,
            fullName: client.fullName,
            email: client.email,
            phone: client.phone,
            profilePhotoUrl: client.profilePhotoUrl,
            heightCm: client.heightCm,
            currentWeightKg: client.currentWeightKg,
            targetWeightKg: client.targetWeightKg,
            dietaryPreferences: client.dietaryPreferences,
            allergies: client.allergies,
            onboardingCompleted: client.onboardingCompleted,
            dietitian: client.primaryDietitian,
        },
    });
});

export const updateClientProfile = asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const { profilePhotoUrl } = req.body;

    const updated = await prisma.client.update({
        where: { id: req.client.id },
        data: {
            ...(profilePhotoUrl && { profilePhotoUrl }),
        },
    });

    res.status(200).json({
        success: true,
        data: {
            id: updated.id,
            profilePhotoUrl: updated.profilePhotoUrl,
        },
    });
});
</file>

<file path="backend/src/controllers/meal.controller.ts">
import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { mealService } from '../services/meal.service';

export const addMealToPlan = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const meal = await mealService.addMealToPlan(req.body, req.user.organizationId);
    res.status(201).json({ success: true, data: meal });
});

export const updateMeal = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const updated = await mealService.updateMeal(req.params.id, req.body, req.user.organizationId);
    res.status(200).json({ success: true, data: updated });
});

export const deleteMeal = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    await mealService.deleteMeal(req.params.id, req.user.organizationId);
    res.status(204).send();
});
</file>

<file path="backend/src/controllers/onboarding.controller.ts">
/**
 * Onboarding Controller
 * Handles client onboarding flow API endpoints
 */

import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { onboardingService } from '../services/onboarding.service';

/**
 * GET /api/v1/clients/:clientId/onboarding/steps
 * Get all onboarding steps
 */
export const getOnboardingSteps = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    const steps = onboardingService.getSteps();

    res.status(200).json({
        success: true,
        data: steps
    });
});

/**
 * GET /api/v1/clients/:clientId/onboarding/presets
 * Get all restriction presets
 */
export const getRestrictionPresets = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    const presets = onboardingService.getPresets();

    res.status(200).json({
        success: true,
        data: presets
    });
});

/**
 * GET /api/v1/clients/:clientId/onboarding/status
 * Get onboarding status for a client
 */
export const getOnboardingStatus = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;

    const status = await onboardingService.getOnboardingStatus(clientId);

    res.status(200).json({
        success: true,
        data: status
    });
});

/**
 * POST /api/v1/clients/:clientId/onboarding/step/1
 * Save Step 1: Basic Info
 */
export const saveStep1 = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const { heightCm, currentWeightKg, targetWeightKg, dateOfBirth, gender, activityLevel } = req.body;

    await onboardingService.saveStep1(clientId, {
        heightCm,
        currentWeightKg,
        targetWeightKg,
        dateOfBirth,
        gender,
        activityLevel
    });

    res.status(200).json({
        success: true,
        message: 'Step 1 saved successfully'
    });
});

/**
 * POST /api/v1/clients/:clientId/onboarding/step/2
 * Save Step 2: Diet Pattern
 */
export const saveStep2 = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const { dietPattern, eggAllowed } = req.body;

    await onboardingService.saveStep2(clientId, {
        dietPattern,
        eggAllowed
    });

    res.status(200).json({
        success: true,
        message: 'Step 2 saved successfully'
    });
});

/**
 * POST /api/v1/clients/:clientId/onboarding/step/3
 * Save Step 3: Allergies
 */
export const saveStep3 = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const { allergies, intolerances } = req.body;

    await onboardingService.saveStep3(clientId, {
        allergies: allergies || [],
        intolerances: intolerances || []
    });

    res.status(200).json({
        success: true,
        message: 'Step 3 saved successfully'
    });
});

/**
 * POST /api/v1/clients/:clientId/onboarding/step/4
 * Save Step 4: Restrictions
 */
export const saveStep4 = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const { presetId, customRestrictions, eggAvoidDays } = req.body;

    await onboardingService.saveStep4(clientId, {
        presetId,
        customRestrictions,
        eggAvoidDays
    });

    res.status(200).json({
        success: true,
        message: 'Step 4 saved successfully'
    });
});

/**
 * POST /api/v1/clients/:clientId/onboarding/step/5
 * Save Step 5: Preferences
 */
export const saveStep5 = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const { dislikes, likedFoods, preferredCuisines } = req.body;

    await onboardingService.saveStep5(clientId, {
        dislikes: dislikes || [],
        likedFoods: likedFoods || [],
        preferredCuisines: preferredCuisines || []
    });

    res.status(200).json({
        success: true,
        message: 'Step 5 saved successfully'
    });
});

/**
 * POST /api/v1/clients/:clientId/onboarding/step/6
 * Save Step 6: Body Measurements
 */
export const saveStep6 = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;
    const { chestCm, waistCm, hipsCm, thighsCm, armsCm, bodyFatPercentage } = req.body;

    await onboardingService.saveStep6(clientId, {
        chestCm,
        waistCm,
        hipsCm,
        thighsCm,
        armsCm,
        bodyFatPercentage
    });

    res.status(200).json({
        success: true,
        message: 'Step 6 saved successfully'
    });
});

/**
 * POST /api/v1/clients/:clientId/onboarding/complete
 * Manually mark onboarding as complete
 */
export const completeOnboarding = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { clientId } = req.params;

    await onboardingService.completeOnboarding(clientId);

    res.status(200).json({
        success: true,
        message: 'Onboarding marked as complete'
    });
});
</file>

<file path="backend/src/controllers/weightLog.controller.ts">
import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { weightLogService } from '../services/weightLog.service';

export const createWeightLog = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const data = await weightLogService.createWeightLog(req.body, req.params.clientId, req.user.organizationId);
    res.status(201).json({ success: true, data });
});

export const listWeightLogs = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const result = await weightLogService.listWeightLogs(req.params.clientId, req.user.organizationId, req.query);
    res.status(200).json({ success: true, ...result });
});

export const listAllWeightLogs = asyncHandler(async (req: AuthenticatedRequest, res: Response, next) => {
    if (!req.user) throw AppError.unauthorized();
    const { clientId } = req.query;
    if (!clientId) throw AppError.badRequest('clientId query parameter is required', 'MISSING_CLIENT_ID');
    req.params.clientId = String(clientId);
    await listWeightLogs(req, res, next);
});

export const createWeightLogGeneral = asyncHandler(async (req: AuthenticatedRequest, res: Response, next) => {
    const { clientId } = req.body;
    if (!clientId) throw AppError.badRequest('clientId is required', 'MISSING_CLIENT_ID');
    req.params.clientId = clientId;
    await createWeightLog(req, res, next);
});

export const uploadProgressPhoto = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    if (!req.file) throw AppError.badRequest('No photo file provided', 'NO_FILE');
    const data = await weightLogService.uploadProgressPhoto(req.params.id, req.file.buffer, req.file.size, req.user.organizationId);
    res.status(200).json({ success: true, data });
});
</file>

<file path="backend/src/routes/client.routes.ts">
import { Router, Response } from 'express';
import { createClient, getClient, listClients, updateClient, deleteClient, getClientProgress } from '../controllers/client.controller';
import { createWeightLog, listWeightLogs } from '../controllers/weightLog.controller';
import { requireAuth, requireRole } from '../middleware/auth.middleware';
import { AuthenticatedRequest } from '../types/auth.types';
import { asyncHandler } from '../utils/asyncHandler';
import { AppError } from '../errors/AppError';
import { clientService } from '../services/client.service';
import { labService } from '../services/lab.service';

const router = Router();

// All client routes require authentication
router.use(requireAuth);

router.post('/', createClient);
router.get('/', listClients);
router.get('/:id', getClient);
router.patch('/:id', updateClient);
router.delete('/:id', requireRole('admin', 'owner'), deleteClient);

// Client progress analytics
router.get('/:id/progress', getClientProgress);

// Client weight logs
router.post('/:clientId/weight-logs', createWeightLog);
router.get('/:clientId/weight-logs', listWeightLogs);

// ============ MEDICAL SUMMARY ============

router.get('/:clientId/medical-summary', asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const summary = await clientService.getMedicalSummary(req.params.clientId, req.user.organizationId);
    res.status(200).json({ success: true, data: summary });
}));

// ============ LAB VALUES ============

router.get('/:clientId/lab-values', asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const data = await labService.getLabValues(req.params.clientId, req.user.organizationId);
    res.status(200).json({ success: true, data });
}));

router.put('/:clientId/lab-values', asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { labValues, labDate } = req.body;

    if (!labValues || typeof labValues !== 'object') {
        throw AppError.badRequest('labValues must be an object with numeric values');
    }
    if (!labDate || isNaN(Date.parse(labDate))) {
        throw AppError.badRequest('labDate must be a valid date string');
    }

    const result = await labService.saveLabValues({
        clientId: req.params.clientId,
        orgId: req.user.organizationId,
        userId: req.user.id,
        labValues,
        labDate,
    });

    res.status(200).json({ success: true, data: result });
}));

export default router;
</file>

<file path="backend/src/routes/clientApi.routes.ts">
import { Router } from 'express';
import { requireClientAuth, ClientAuthRequest } from '../middleware/clientAuth.middleware';
import { asyncHandler } from '../utils/asyncHandler';
import prisma from '../utils/prisma';
import { AppError } from '../errors/AppError';
import { Response } from 'express';

const router = Router();

// All routes require client auth
router.use(requireClientAuth);

// Get today's meals for client
router.get('/meals/today', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    // Get active diet plan for this client
    const activePlan = await prisma.dietPlan.findFirst({
        where: {
            clientId: req.client.id,
            status: 'active',
            isActive: true,
        },
        include: {
            meals: {
                include: {
                    foodItems: {
                        include: { foodItem: true },
                    },
                },
                orderBy: { mealType: 'asc' },
            },
        },
    });

    if (!activePlan) {
        return res.status(200).json({ success: true, data: [] });
    }

    // Get meal logs for today
    const mealLogs = await prisma.mealLog.findMany({
        where: {
            clientId: req.client.id,
            scheduledDate: {
                gte: today,
                lt: tomorrow,
            },
        },
    });

    // Map meals to include log status
    const todayMeals = activePlan.meals.map((meal) => {
        const log = mealLogs.find((l) => l.mealId === meal.id);

        // Group food items by optionGroup
        const foodItems = meal.foodItems || [];
        const optionGroupsMap = new Map<number, typeof foodItems>();
        foodItems.forEach((fi) => {
            const group = fi.optionGroup ?? 0;
            if (!optionGroupsMap.has(group)) optionGroupsMap.set(group, []);
            optionGroupsMap.get(group)!.push(fi);
        });

        const hasAlternatives = optionGroupsMap.size > 1;

        // Calculate macros per option group
        const calcMacros = (items: typeof foodItems) => {
            let calories = 0, protein = 0, carbs = 0, fats = 0;
            items.forEach(fi => {
                calories += fi.calories || Math.round((fi.foodItem.calories * Number(fi.quantityG)) / 100);
                protein += Number(fi.proteinG) || (Number(fi.foodItem.proteinG || 0) * Number(fi.quantityG)) / 100;
                carbs += Number(fi.carbsG) || (Number(fi.foodItem.carbsG || 0) * Number(fi.quantityG)) / 100;
                fats += Number(fi.fatsG) || (Number(fi.foodItem.fatsG || 0) * Number(fi.quantityG)) / 100;
            });
            return { calories, protein: Math.round(protein), carbs: Math.round(carbs), fats: Math.round(fats) };
        };

        // Build options array
        const options = Array.from(optionGroupsMap.entries())
            .sort(([a], [b]) => a - b)
            .map(([group, items]) => {
                const macros = calcMacros(items);
                return {
                    optionGroup: group,
                    label: items[0]?.optionLabel || (group === 0 ? 'Default' : `Option ${group + 1}`),
                    totalCalories: macros.calories,
                    totalProteinG: macros.protein,
                    totalCarbsG: macros.carbs,
                    totalFatsG: macros.fats,
                    foodItems: items.map((fi) => ({
                        id: fi.id,
                        foodId: fi.foodId,
                        foodName: fi.foodItem.name,
                        quantityG: fi.quantityG,
                        calories: fi.calories || Math.round((fi.foodItem.calories * Number(fi.quantityG)) / 100),
                    })),
                };
            });

        // Use option 0 macros as default display values
        const defaultMacros = calcMacros(optionGroupsMap.get(0) || foodItems);

        return {
            id: log?.id || `pending-${meal.id}`,
            mealId: meal.id,
            scheduledDate: today.toISOString().split('T')[0],
            scheduledTime: meal.timeOfDay,
            status: log?.status || 'pending',
            chosenOptionGroup: log?.chosenOptionGroup ?? null,
            mealPhotoUrl: log?.mealPhotoUrl,
            clientNotes: log?.clientNotes,
            dietitianFeedback: log?.dietitianFeedback,
            dietitianFeedbackAt: log?.dietitianFeedbackAt,
            loggedAt: log?.loggedAt,
            meal: {
                id: meal.id,
                planId: meal.planId,
                mealType: meal.mealType,
                name: meal.name,
                description: meal.description,
                timeOfDay: meal.timeOfDay,
                instructions: meal.instructions,
                totalCalories: meal.totalCalories || defaultMacros.calories,
                totalProteinG: Number(meal.totalProteinG) || defaultMacros.protein,
                totalCarbsG: Number(meal.totalCarbsG) || defaultMacros.carbs,
                totalFatsG: Number(meal.totalFatsG) || defaultMacros.fats,
                hasAlternatives,
                options,
                foodItems: foodItems.map((fi) => ({
                    id: fi.id,
                    foodId: fi.foodId,
                    foodName: fi.foodItem.name,
                    quantityG: fi.quantityG,
                    calories: fi.calories || Math.round((fi.foodItem.calories * Number(fi.quantityG)) / 100),
                    optionGroup: fi.optionGroup ?? 0,
                    optionLabel: fi.optionLabel,
                })),
            },
        };
    });

    res.status(200).json({ success: true, data: todayMeals });
}));

// Log a meal (update status, add photo, notes)
router.patch('/meals/:mealLogId/log', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const { mealLogId } = req.params;
    const { status, photoUrl, notes, chosenOptionGroup } = req.body;

    // Check if meal log exists, if not create it
    let mealLog = await prisma.mealLog.findUnique({ where: { id: mealLogId } });

    if (!mealLog) {
        // This might be a "pending" placeholder - need to create actual log
        // mealLogId here could be "pending-{mealId}" format
        if (mealLogId.startsWith('pending-')) {
            const mealId = mealLogId.replace('pending-', '');
            const meal = await prisma.meal.findUnique({ where: { id: mealId }, include: { dietPlan: true } });

            if (!meal || meal.dietPlan.clientId !== req.client.id) {
                throw AppError.notFound('Meal not found', 'MEAL_NOT_FOUND');
            }

            // Create today's date at start of day for proper matching
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Check if a log already exists for this meal today
            const existingLog = await prisma.mealLog.findFirst({
                where: {
                    clientId: req.client.id,
                    mealId: mealId,
                    scheduledDate: today,
                },
            });

            if (existingLog) {
                // Update existing log instead of creating duplicate
                mealLog = await prisma.mealLog.update({
                    where: { id: existingLog.id },
                    data: {
                        status: status || 'eaten',
                        mealPhotoUrl: photoUrl || existingLog.mealPhotoUrl,
                        clientNotes: notes || existingLog.clientNotes,
                        loggedAt: new Date(),
                        ...(chosenOptionGroup !== undefined && { chosenOptionGroup }),
                    },
                });
            } else {
                // Create new log
                mealLog = await prisma.mealLog.create({
                    data: {
                        orgId: req.client.orgId,
                        clientId: req.client.id,
                        mealId: mealId,
                        scheduledDate: today,
                        status: status || 'eaten',
                        mealPhotoUrl: photoUrl,
                        clientNotes: notes,
                        loggedAt: new Date(),
                        ...(chosenOptionGroup !== undefined && { chosenOptionGroup }),
                    },
                });
            }
        } else {
            throw AppError.notFound('Meal log not found', 'MEAL_LOG_NOT_FOUND');
        }
    } else {
        // Update existing
        if (mealLog.clientId !== req.client.id) {
            throw AppError.forbidden('Not authorized', 'FORBIDDEN');
        }

        mealLog = await prisma.mealLog.update({
            where: { id: mealLogId },
            data: {
                status: status || mealLog.status,
                mealPhotoUrl: photoUrl || mealLog.mealPhotoUrl,
                clientNotes: notes || mealLog.clientNotes,
                loggedAt: new Date(),
                ...(chosenOptionGroup !== undefined && { chosenOptionGroup }),
            },
        });
    }

    // Trigger compliance calculation after meal log update
    if (mealLog.status !== 'pending') {
        await complianceService.calculateMealCompliance(mealLog.id);
        mealLog = await prisma.mealLog.findUnique({ where: { id: mealLog.id } }) || mealLog;
    }

    res.status(200).json({ success: true, data: mealLog });
}));

// Upload meal photo
import { uploadSinglePhoto } from '../middleware/upload.middleware';
import { mealLogService } from '../services/mealLog.service';

router.post('/meals/:mealLogId/photo', uploadSinglePhoto, asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();
    if (!req.file) throw AppError.badRequest('No photo file provided', 'NO_FILE');

    const { mealLogId } = req.params;

    // Verify the meal log belongs to this client
    const mealLog = await prisma.mealLog.findFirst({
        where: { id: mealLogId, clientId: req.client.id },
    });
    if (!mealLog) throw AppError.notFound('Meal log not found', 'MEAL_LOG_NOT_FOUND');

    const result = await mealLogService.uploadMealPhoto(
        mealLogId, req.file.buffer, req.file.size, req.client.orgId
    );

    res.status(200).json({ success: true, data: result });
}));

// Get client weight logs
router.get('/weight-logs', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const limit = parseInt(req.query.limit as string) || 30;

    const logs = await prisma.weightLog.findMany({
        where: { clientId: req.client.id },
        orderBy: { logDate: 'desc' },
        take: limit,
    });

    res.status(200).json({ success: true, data: logs });
}));

// Create weight log
router.post('/weight-logs', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const { weightKg, logDate, notes } = req.body;

    if (!weightKg || !logDate) {
        throw AppError.badRequest('weightKg and logDate required', 'MISSING_FIELDS');
    }

    const parsedDate = new Date(logDate);
    parsedDate.setHours(0, 0, 0, 0); // Normalize to start of day

    // Get previous log for delta calculation (exclude current date)
    const previousLog = await prisma.weightLog.findFirst({
        where: {
            clientId: req.client.id,
            logDate: { lt: parsedDate },
        },
        orderBy: { logDate: 'desc' },
    });

    const weightChange = previousLog ? weightKg - Number(previousLog.weightKg) : null;

    // Upsert: update if exists for same date, create if not
    const log = await prisma.weightLog.upsert({
        where: {
            clientId_logDate: {
                clientId: req.client.id,
                logDate: parsedDate,
            },
        },
        update: {
            weightKg,
            notes,
            weightChangeFromPrevious: weightChange,
        },
        create: {
            orgId: req.client.orgId,
            clientId: req.client.id,
            weightKg,
            logDate: parsedDate,
            notes,
            weightChangeFromPrevious: weightChange,
        },
    });

    // Update client's current weight
    await prisma.client.update({
        where: { id: req.client.id },
        data: { currentWeightKg: weightKg },
    });

    res.status(200).json({ success: true, data: log });
}));

// Get client stats
router.get('/stats', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const client = await prisma.client.findUnique({
        where: { id: req.client.id },
        select: { currentWeightKg: true, targetWeightKg: true },
    });

    // Get meal logs for last 7 days
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);

    const recentLogs = await prisma.mealLog.findMany({
        where: {
            clientId: req.client.id,
            scheduledDate: { gte: weekAgo },
        },
    });

    const totalMeals = recentLogs.length;
    const eatenMeals = recentLogs.filter((l) => l.status === 'eaten').length;
    const adherence = totalMeals > 0 ? Math.round((eatenMeals / totalMeals) * 100) : 0;

    // Get streak (consecutive days with at least one logged meal)
    // Simplified: just count recent weight logs for now
    const weightLogs = await prisma.weightLog.findMany({
        where: { clientId: req.client.id },
        orderBy: { logDate: 'desc' },
        take: 2,
    });

    let weightTrend: 'up' | 'down' | 'stable' = 'stable';
    if (weightLogs.length >= 2) {
        const diff = Number(weightLogs[0].weightKg) - Number(weightLogs[1].weightKg);
        if (diff > 0.5) weightTrend = 'up';
        else if (diff < -0.5) weightTrend = 'down';
    }

    res.status(200).json({
        success: true,
        data: {
            weeklyAdherence: adherence,
            mealCompletionRate: adherence,
            weightTrend,
            // Use latest weight log, fallback to client profile
            latestWeight: weightLogs.length > 0
                ? Number(weightLogs[0].weightKg)
                : (client?.currentWeightKg ? Number(client.currentWeightKg) : null),
            targetWeight: client?.targetWeightKg ? Number(client.targetWeightKg) : null,
            currentStreak: Math.min(eatenMeals, 7), // Simplified streak
        },
    });
}));

// Get progress summary (all weight + progress data computed server-side)
router.get('/progress-summary', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const client = await prisma.client.findUnique({
        where: { id: req.client.id },
        select: { currentWeightKg: true, targetWeightKg: true },
    });

    const weightLogs = await prisma.weightLog.findMany({
        where: { clientId: req.client.id },
        orderBy: { logDate: 'desc' },
        take: 10,
    });

    const currentWeight = weightLogs.length > 0
        ? Number(weightLogs[0].weightKg)
        : (client?.currentWeightKg ? Number(client.currentWeightKg) : null);
    const targetWeight = client?.targetWeightKg ? Number(client.targetWeightKg) : null;
    const startWeight = weightLogs.length > 0 ? Number(weightLogs[weightLogs.length - 1].weightKg) : null;

    // Compute progress percentage
    let progressPercent = 0;
    if (startWeight && currentWeight && targetWeight && startWeight !== targetWeight) {
        progressPercent = Math.min(100, Math.max(0,
            ((startWeight - currentWeight) / (startWeight - targetWeight)) * 100
        ));
    }

    // Weight trend
    let weightTrend: 'up' | 'down' | 'stable' = 'stable';
    if (weightLogs.length >= 2) {
        const diff = Number(weightLogs[0].weightKg) - Number(weightLogs[1].weightKg);
        if (diff > 0.5) weightTrend = 'up';
        else if (diff < -0.5) weightTrend = 'down';
    }

    // Chart data (oldest first)
    const chartEntries = weightLogs.slice(0, 7).reverse().map(log => ({
        date: log.logDate.toISOString().split('T')[0],
        weight: Number(log.weightKg),
    }));

    // History with backend-computed deltas
    const history = weightLogs.slice(0, 5).map(log => ({
        id: log.id,
        logDate: log.logDate.toISOString().split('T')[0],
        weightKg: Number(log.weightKg),
        notes: log.notes,
        delta: log.weightChangeFromPrevious ? Number(log.weightChangeFromPrevious) : null,
    }));

    res.status(200).json({
        success: true,
        data: {
            currentWeight,
            targetWeight,
            startWeight,
            progressPercent: Math.round(progressPercent * 10) / 10,
            weightTrend,
            totalLost: startWeight && currentWeight ? Math.round((startWeight - currentWeight) * 10) / 10 : 0,
            remaining: currentWeight && targetWeight ? Math.round(Math.abs(currentWeight - targetWeight) * 10) / 10 : null,
            chartEntries,
            history,
        },
    });
}));

// ============ ONBOARDING ============

import { onboardingService } from '../services/onboarding.service';

// Get onboarding status
router.get('/onboarding/status', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();
    const status = await onboardingService.getOnboardingStatus(req.client.id);
    res.status(200).json({ success: true, data: status });
}));

// Get restriction presets
router.get('/onboarding/presets', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();
    const presets = onboardingService.getPresets();
    res.status(200).json({ success: true, data: presets });
}));

// Save onboarding step (1-6)
router.post('/onboarding/step/:step', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();
    const step = parseInt(req.params.step);

    const handlers: Record<number, (clientId: string, data: any) => Promise<void>> = {
        1: (id, data) => onboardingService.saveStep1(id, data),
        2: (id, data) => onboardingService.saveStep2(id, data),
        3: (id, data) => onboardingService.saveStep3(id, data),
        4: (id, data) => onboardingService.saveStep4(id, data),
        5: (id, data) => onboardingService.saveStep5(id, data),
        6: (id, data) => onboardingService.saveStep6(id, data),
    };

    const handler = handlers[step];
    if (!handler) {
        throw AppError.badRequest(`Invalid step: ${step}`, 'INVALID_STEP');
    }

    await handler(req.client.id, req.body);
    res.status(200).json({ success: true, message: `Step ${step} saved successfully` });
}));

// Complete onboarding
router.post('/onboarding/complete', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();
    await onboardingService.completeOnboarding(req.client.id);
    res.status(200).json({ success: true, message: 'Onboarding marked as complete' });
}));

// ============ PREFERENCES ============

// Get client preferences
router.get('/preferences', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const preferences = await prisma.clientPreferences.findUnique({
        where: { clientId: req.client.id },
    });

    res.status(200).json({ success: true, data: preferences });
}));

// Update client preferences (upsert)
router.put('/preferences', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();

    const {
        breakfastTime, lunchTime, dinnerTime, snackTime,
        canCook, kitchenAvailable, hasDietaryCook,
        weekdayActivity, weekendActivity, sportOrHobby, generalNotes,
    } = req.body;

    // Validate time format if provided
    const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
    const times: Record<string, string | undefined> = { breakfastTime, lunchTime, dinnerTime, snackTime };
    for (const [field, value] of Object.entries(times)) {
        if (value && !timeRegex.test(value)) {
            throw AppError.badRequest(`${field} must be in HH:MM format`, 'INVALID_TIME_FORMAT');
        }
    }

    const data: Record<string, any> = {
        breakfastTime, lunchTime, dinnerTime, snackTime,
        canCook, kitchenAvailable, hasDietaryCook,
        weekdayActivity, weekendActivity, sportOrHobby, generalNotes,
    };

    // Remove undefined keys so we don't overwrite existing values
    const cleanData = Object.fromEntries(
        Object.entries(data).filter(([, v]) => v !== undefined)
    );

    const preferences = await prisma.clientPreferences.upsert({
        where: { clientId: req.client.id },
        create: { clientId: req.client.id, ...cleanData },
        update: cleanData,
    });

    res.status(200).json({ success: true, data: preferences });
}));

// ============ ADHERENCE / COMPLIANCE ============

import { complianceService } from '../services/compliance.service';

// Get daily adherence
router.get('/adherence/daily', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();
    const date = req.query.date ? new Date(req.query.date as string) : new Date();
    const data = await complianceService.calculateDailyAdherence(req.client.id, date);
    res.status(200).json({ success: true, data });
}));

// Get weekly adherence
router.get('/adherence/weekly', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();
    const weekStart = req.query.weekStart ? new Date(req.query.weekStart as string) : undefined;
    const data = await complianceService.calculateWeeklyAdherence(req.client.id, weekStart);
    res.status(200).json({ success: true, data });
}));

// Get compliance history
router.get('/adherence/history', asyncHandler(async (req: ClientAuthRequest, res: Response) => {
    if (!req.client) throw AppError.unauthorized();
    const days = req.query.days ? parseInt(req.query.days as string) : 30;
    const data = await complianceService.getClientComplianceHistory(req.client.id, days);
    res.status(200).json({ success: true, data });
}));

export default router;
</file>

<file path="backend/src/routes/dietPlan.routes.ts">
import { Router } from 'express';
import { createDietPlan, getDietPlan, listDietPlans, updateDietPlan, publishDietPlan, assignTemplateToClient } from '../controllers/dietPlan.controller';
import { requireAuth } from '../middleware/auth.middleware';

const router = Router();

router.use(requireAuth);

router.post('/', createDietPlan);
router.get('/', listDietPlans);
router.get('/:id', getDietPlan);
router.patch('/:id', updateDietPlan);
router.post('/:id/publish', publishDietPlan);
router.post('/:id/assign', assignTemplateToClient);

export default router;
</file>

<file path="backend/src/routes/foodItem.routes.ts">
import { Router } from 'express';
import {
    createFoodItem,
    listFoodItems,
    getFoodItem,
    updateFoodItem,
    deleteFoodItem,
    updateFoodTags,
    autoTagFood,
    bulkAutoTagFoods
} from '../controllers/foodItem.controller';
import { requireAuth } from '../middleware/auth.middleware';

const router = Router();

router.use(requireAuth);

// Food Items CRUD
router.post('/', createFoodItem);
router.get('/', listFoodItems);
router.get('/:id', getFoodItem);
router.patch('/:id', updateFoodItem);
router.delete('/:id', deleteFoodItem);

// Tagging endpoints
router.patch('/:id/tags', updateFoodTags);
router.post('/:id/auto-tag', autoTagFood);
router.post('/bulk-auto-tag', bulkAutoTagFoods);

export default router;
</file>

<file path="backend/src/routes/onboarding.routes.ts">
import { Router } from 'express';
import {
    getOnboardingSteps,
    getRestrictionPresets,
    getOnboardingStatus,
    saveStep1,
    saveStep2,
    saveStep3,
    saveStep4,
    saveStep5,
    saveStep6,
    completeOnboarding
} from '../controllers/onboarding.controller';
import { requireAuth } from '../middleware/auth.middleware';

const router = Router({ mergeParams: true }); // mergeParams to access :clientId

router.use(requireAuth);

// Get onboarding info
router.get('/steps', getOnboardingSteps);
router.get('/presets', getRestrictionPresets);
router.get('/status', getOnboardingStatus);

// Save individual steps
router.post('/step/1', saveStep1);
router.post('/step/2', saveStep2);
router.post('/step/3', saveStep3);
router.post('/step/4', saveStep4);
router.post('/step/5', saveStep5);
router.post('/step/6', saveStep6);

// Complete manually
router.post('/complete', completeOnboarding);

export default router;
</file>

<file path="backend/src/schemas/client.schema.ts">
import { z } from 'zod';

export const createClientSchema = z.object({
    fullName: z.string().min(2, 'Full name must be at least 2 characters'),
    email: z.string().email('Invalid email format'),
    phone: z.string().min(10, 'Phone must be at least 10 characters'),
    dateOfBirth: z.string().optional(),
    gender: z.enum(['male', 'female', 'other']).optional(),
    heightCm: z.number().min(50).max(300).optional(),
    currentWeightKg: z.number().min(10).max(500).optional(),
    targetWeightKg: z.number().min(10).max(500).optional(),
    targetCalories: z.number().min(500).max(10000).optional().nullable(),
    targetProteinG: z.number().min(0).max(500).optional().nullable(),
    targetCarbsG: z.number().min(0).max(1000).optional().nullable(),
    targetFatsG: z.number().min(0).max(500).optional().nullable(),
    activityLevel: z.enum(['sedentary', 'light', 'moderate', 'active', 'very_active']).optional(),
    primaryDietitianId: z.string().uuid().optional(),
    dietaryPreferences: z.array(z.string().min(1).max(100)).max(30).optional().default([]),
    allergies: z.array(z.string().min(1).max(100)).max(20).optional().default([]),
    medicalConditions: z.array(z.string().min(1).max(100)).max(20).optional().default([]),
    medications: z.array(z.string().min(1).max(100)).max(30).optional().default([]),
    healthNotes: z.string().optional()
});

export const updateClientSchema = createClientSchema.partial();

export const clientIdParamSchema = z.object({
    id: z.string().uuid('Invalid client ID')
});

export type CreateClientInput = z.infer<typeof createClientSchema>;
export type UpdateClientInput = z.infer<typeof updateClientSchema>;
</file>

<file path="backend/src/services/client.service.ts">
import prisma from '../utils/prisma';
import { AppError } from '../errors/AppError';
import logger from '../utils/logger';
import { buildPaginationParams, buildPaginationMeta, buildDateFilter } from '../utils/queryFilters';
import { validationEngine } from './validationEngine.service';
import { labService } from './lab.service';
import type { MedicalSummary } from '../types/medical.types';

const REFERRAL_CHARS = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
const REFERRAL_CODE_LENGTH = 6;
const MAX_REFERRAL_ATTEMPTS = 10;
const REFERRALS_PER_FREE_MONTH = 3;

function generateReferralCode(): string {
    let code = '';
    for (let i = 0; i < REFERRAL_CODE_LENGTH; i++) {
        code += REFERRAL_CHARS.charAt(Math.floor(Math.random() * REFERRAL_CHARS.length));
    }
    return code;
}

export class ClientService {
    async generateUniqueReferralCode(): Promise<string> {
        let attempts = 0;
        while (attempts < MAX_REFERRAL_ATTEMPTS) {
            const code = generateReferralCode();
            const existing = await prisma.client.findUnique({ where: { referralCode: code } });
            if (!existing) return code;
            attempts++;
        }
        return generateReferralCode() + Date.now().toString(36).slice(-2).toUpperCase();
    }

    async createClient(data: any, orgId: string, userId: string) {
        const existingClient = await prisma.client.findFirst({
            where: { orgId, email: data.email },
        });
        if (existingClient) {
            throw AppError.conflict('A client with this email already exists', 'CLIENT_EXISTS');
        }

        let referredByClientId: string | undefined;
        if (data.referralCode) {
            const referrer = await prisma.client.findUnique({
                where: { referralCode: data.referralCode.toUpperCase() },
                select: { id: true },
            });
            if (referrer) referredByClientId = referrer.id;
        }

        const client = await prisma.client.create({
            data: {
                orgId,
                primaryDietitianId: data.primaryDietitianId || userId,
                fullName: data.fullName,
                email: data.email,
                phone: data.phone,
                dateOfBirth: data.dateOfBirth ? new Date(data.dateOfBirth) : null,
                gender: data.gender,
                heightCm: data.heightCm,
                currentWeightKg: data.currentWeightKg,
                targetWeightKg: data.targetWeightKg,
                activityLevel: data.activityLevel,
                dietaryPreferences: data.dietaryPreferences || [],
                allergies: data.allergies || [],
                medicalConditions: data.medicalConditions || [],
                medications: data.medications || [],
                healthNotes: data.healthNotes,
                createdByUserId: userId,
                referralSource: data.referralSource,
                referralSourceName: data.referralSourceName,
                referralSourcePhone: data.referralSourcePhone,
                referredByClientId,
                referralCode: await this.generateUniqueReferralCode(),
            },
            include: {
                primaryDietitian: { select: { id: true, fullName: true } },
            },
        });

        if (referredByClientId) {
            await this.processReferralBenefit(referredByClientId);
        }

        logger.info('Client created', { clientId: client.id, orgId, referralSource: data.referralSource, referredBy: referredByClientId });
        return client;
    }

    async processReferralBenefit(referrerId: string) {
        await prisma.$transaction(async (tx) => {
            const benefit = await tx.referralBenefit.upsert({
                where: { clientId: referrerId },
                create: { clientId: referrerId, referralCount: 1, freeMonthsEarned: 0 },
                update: { referralCount: { increment: 1 } },
            });

            const newReferralCount = benefit.referralCount + 1;
            const newFreeMonths = Math.floor(newReferralCount / REFERRALS_PER_FREE_MONTH);

            if (newFreeMonths > benefit.freeMonthsEarned) {
                await tx.referralBenefit.update({
                    where: { clientId: referrerId },
                    data: { freeMonthsEarned: newFreeMonths },
                });
            }
        });
    }

    async getClient(clientId: string, orgId: string) {
        const client = await prisma.client.findFirst({
            where: { id: clientId, orgId, isActive: true },
            include: {
                primaryDietitian: { select: { id: true, fullName: true } },
                medicalProfile: true,
            },
        });
        if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');
        return client;
    }

    async listClients(orgId: string, query: any, userRole: string, userId: string) {
        const { search, status, primaryDietitianId, sortBy = 'createdAt' } = query;
        const pagination = buildPaginationParams(query.page, query.pageSize);

        const where: any = { orgId, isActive: status !== 'inactive' };

        if (search) {
            where.OR = [
                { fullName: { contains: String(search), mode: 'insensitive' } },
                { email: { contains: String(search), mode: 'insensitive' } },
                { phone: { contains: String(search) } },
            ];
        }

        if (primaryDietitianId) where.primaryDietitianId = String(primaryDietitianId);
        if (userRole === 'dietitian') where.primaryDietitianId = userId;

        const [clients, total] = await prisma.$transaction([
            prisma.client.findMany({
                where,
                skip: pagination.skip,
                take: pagination.take,
                orderBy: { [String(sortBy)]: 'desc' },
                include: { primaryDietitian: { select: { id: true, fullName: true } } },
            }),
            prisma.client.count({ where }),
        ]);

        return { clients, meta: buildPaginationMeta(total, pagination) };
    }

    async updateClient(clientId: string, updateData: any, orgId: string) {
        const existing = await prisma.client.findFirst({ where: { id: clientId, orgId } });
        if (!existing) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        if (updateData.dateOfBirth) {
            updateData.dateOfBirth = new Date(updateData.dateOfBirth);
        }

        const client = await prisma.client.update({
            where: { id: clientId },
            data: updateData,
            include: { primaryDietitian: { select: { id: true, fullName: true } } },
        });

        validationEngine.invalidateClientCache(clientId);
        logger.info('Client updated', { clientId: client.id });
        return client;
    }

    async deleteClient(clientId: string, orgId: string) {
        const existing = await prisma.client.findFirst({ where: { id: clientId, orgId } });
        if (!existing) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        await prisma.client.update({
            where: { id: clientId },
            data: { isActive: false, deletedAt: new Date() },
        });

        logger.info('Client deleted (soft)', { clientId });
    }

    async getClientProgress(clientId: string, orgId: string, query: any) {
        const client = await prisma.client.findFirst({ where: { id: clientId, orgId } });
        if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        const dateFilter = buildDateFilter(query.dateFrom, query.dateTo);

        const weightLogs = await prisma.weightLog.findMany({
            where: { clientId, ...(dateFilter && { logDate: dateFilter }) },
            orderBy: { logDate: 'asc' },
        });

        let startWeight: number | null = null;
        let currentWeight: number | null = null;
        let totalWeightChange: number | null = null;
        let last30DaysChange: number | null = null;
        let weeklyAvgChange: number | null = null;
        const targetWeight = client.targetWeightKg ? Number(client.targetWeightKg) : null;
        let progressToGoal: number | null = null;

        if (weightLogs.length > 0) {
            startWeight = Number(weightLogs[0].weightKg);
            currentWeight = Number(weightLogs[weightLogs.length - 1].weightKg);
            totalWeightChange = Math.round((currentWeight - startWeight) * 100) / 100;

            const firstDate = new Date(weightLogs[0].logDate);
            const lastDate = new Date(weightLogs[weightLogs.length - 1].logDate);
            const weeksDiff = Math.max(1, Math.round((lastDate.getTime() - firstDate.getTime()) / (7 * 24 * 60 * 60 * 1000)));
            weeklyAvgChange = Math.round((totalWeightChange / weeksDiff) * 100) / 100;

            // Last 30 days change — separate from all-time totalWeightChange
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentLogs = weightLogs.filter(w => new Date(w.logDate) >= thirtyDaysAgo);
            if (recentLogs.length >= 2) {
                const recentStart = Number(recentLogs[0].weightKg);
                const recentEnd = Number(recentLogs[recentLogs.length - 1].weightKg);
                last30DaysChange = Math.round((recentEnd - recentStart) * 100) / 100;
            } else if (recentLogs.length === 1) {
                last30DaysChange = 0;
            }

            // Progress to goal — handles both weight loss AND weight gain
            if (targetWeight && startWeight && currentWeight) {
                const totalToChange = Math.abs(startWeight - targetWeight);
                if (totalToChange > 0) {
                    // Check if moving in the right direction
                    const isLossGoal = targetWeight < startWeight;
                    const moved = isLossGoal
                        ? startWeight - currentWeight   // positive = good for loss
                        : currentWeight - startWeight;  // positive = good for gain
                    progressToGoal = moved > 0
                        ? Math.min(100, Math.round((moved / totalToChange) * 100))
                        : 0;
                } else {
                    progressToGoal = 100; // Already at target
                }
            }
        }

        const mealLogs = await prisma.mealLog.findMany({
            where: { clientId, ...(dateFilter && { scheduledDate: dateFilter }) },
        });

        const totalMeals = mealLogs.length;
        const eatenMeals = mealLogs.filter((m) => m.status === 'eaten').length;
        const substitutedMeals = mealLogs.filter((m) => m.status === 'substituted').length;
        const skippedMeals = mealLogs.filter((m) => m.status === 'skipped').length;
        const pendingMeals = mealLogs.filter((m) => m.status === 'pending').length;
        const adherencePercentage = totalMeals > 0 ? Math.round(((eatenMeals + substitutedMeals) / totalMeals) * 100) : 0;
        const completionPercentage = totalMeals > 0 ? Math.round(((totalMeals - pendingMeals) / totalMeals) * 100) : 0;

        const activePlansCount = await prisma.dietPlan.count({
            where: { clientId, status: 'active', isActive: true },
        });

        return {
            client: { id: client.id, fullName: client.fullName },
            weightTrend: {
                startWeight, currentWeight, targetWeight, totalWeightChange, last30DaysChange,
                weeklyAverageChange: weeklyAvgChange, progressToGoalPercentage: progressToGoal,
                dataPoints: weightLogs.map((w) => ({ date: w.logDate, weight: Number(w.weightKg) })),
            },
            mealAdherence: {
                totalMeals, eatenMeals, substitutedMeals, skippedMeals, pendingMeals,
                adherencePercentage, completionPercentage,
            },
            activeDietPlans: activePlansCount,
            period: {
                from: query.dateFrom ? new Date(String(query.dateFrom)) : null,
                to: query.dateTo ? new Date(String(query.dateTo)) : null,
            },
        };
    }

    async getMedicalSummary(clientId: string, orgId: string): Promise<MedicalSummary> {
        const client = await prisma.client.findFirst({
            where: { id: clientId, orgId, isActive: true },
            select: {
                allergies: true,
                intolerances: true,
                dietPattern: true,
                eggAllowed: true,
                eggAvoidDays: true,
                medicalConditions: true,
                medications: true,
                dislikes: true,
                likedFoods: true,
                avoidCategories: true,
                labDerivedTags: true,
                medicalProfile: true,
            },
        });

        if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        // Compute lab alerts from stored lab values
        const labValues = (client.medicalProfile?.labValues as Record<string, number>) || {};
        const hasLabValues = Object.keys(labValues).length > 0;
        const { alerts: labAlerts } = hasLabValues
            ? labService.deriveRiskFlags(labValues)
            : { alerts: [] };

        const criticalCount = labAlerts.filter(a => a.status === 'critical').length;
        const warningCount = labAlerts.filter(a => a.status === 'warning').length;

        return {
            allergies: client.allergies,
            intolerances: client.intolerances,
            dietPattern: client.dietPattern || null,
            eggAllowed: client.eggAllowed,
            eggAvoidDays: client.eggAvoidDays,
            medicalConditions: client.medicalConditions,
            dislikes: client.dislikes,
            likedFoods: client.likedFoods,
            avoidCategories: client.avoidCategories,

            diagnoses: client.medicalProfile?.diagnoses || [],
            medications: client.medicalProfile?.medications || client.medications || [],
            supplements: client.medicalProfile?.supplements || [],
            surgeries: client.medicalProfile?.surgeries || [],
            familyHistory: client.medicalProfile?.familyHistory || null,
            healthNotes: client.medicalProfile?.healthNotes || null,

            labAlerts,
            labDate: client.medicalProfile?.labDate?.toISOString() || null,
            labDerivedTags: client.medicalProfile?.labDerivedTags || client.labDerivedTags || [],

            criticalCount,
            warningCount,
            lastUpdated: client.medicalProfile?.updatedAt?.toISOString() || '',
        };
    }
}

export const clientService = new ClientService();
</file>

<file path="backend/src/services/compliance.service.ts">
/**
 * Compliance Service
 * 7-factor meal compliance scoring with daily/weekly/history adherence
 */

import prisma from '../utils/prisma';
import logger from '../utils/logger';
import { COMPLIANCE_CONFIG } from '../config/compliance.config';

// ============ TYPES ============

export type ComplianceColor = 'GREEN' | 'YELLOW' | 'RED';

export interface ComplianceResult {
    score: number;
    color: ComplianceColor;
    issues: string[];
}

export interface MealBreakdown {
    mealLogId: string;
    mealName: string;
    mealType: string;
    score: number | null;
    color: ComplianceColor | null;
    status: string;
    issues: string[];
}

export interface DailyAdherence {
    date: string;
    score: number;
    color: ComplianceColor;
    mealsLogged: number;
    mealsPlanned: number;
    mealBreakdown: MealBreakdown[];
}

export interface WeeklyAdherence {
    weekStart: string;
    weekEnd: string;
    averageScore: number;
    color: ComplianceColor;
    dailyBreakdown: DailyAdherence[];
    trend: 'improving' | 'declining' | 'stable';
}

export interface ComplianceHistoryEntry {
    date: string;
    score: number;
    color: ComplianceColor;
}

export interface ComplianceHistory {
    data: ComplianceHistoryEntry[];
    averageScore: number;
    bestDay: ComplianceHistoryEntry | null;
    worstDay: ComplianceHistoryEntry | null;
}

// ============ HELPERS ============

function getColor(score: number): ComplianceColor {
    if (score >= COMPLIANCE_CONFIG.THRESHOLDS.GREEN_MIN) return 'GREEN';
    if (score >= COMPLIANCE_CONFIG.THRESHOLDS.YELLOW_MIN) return 'YELLOW';
    return 'RED';
}

/**
 * Parse a time string (HH:MM) and a date into a Date object
 */
function parseScheduledDateTime(date: Date, timeStr: string | null): Date | null {
    if (!timeStr) return null;
    const [hours, minutes] = timeStr.split(':').map(Number);
    if (isNaN(hours) || isNaN(minutes)) return null;
    const d = new Date(date);
    d.setHours(hours, minutes, 0, 0);
    return d;
}

// ============ SERVICE ============

export class ComplianceService {

    /**
     * Calculate 7-factor compliance score for a meal log
     */
    async calculateMealCompliance(mealLogId: string): Promise<ComplianceResult> {
        const mealLog = await prisma.mealLog.findUnique({
            where: { id: mealLogId },
            include: {
                meal: {
                    include: {
                        foodItems: {
                            include: { foodItem: true },
                        },
                    },
                },
            },
        });

        if (!mealLog) {
            logger.warn('Compliance: MealLog not found', { mealLogId });
            return { score: 0, color: 'RED', issues: ['Meal log not found'] };
        }

        const { WEIGHTS, PENALTIES } = COMPLIANCE_CONFIG;
        const issues: string[] = [];
        let score = 0;

        // Factor 7: Skipped → score is 0
        if (mealLog.status === 'skipped') {
            await this.persistScore(mealLogId, PENALTIES.SKIPPED_SCORE, ['Meal was skipped']);
            return { score: 0, color: 'RED', issues: ['Meal was skipped'] };
        }

        // Factor 1: On-time (+20)
        if (mealLog.loggedAt && mealLog.scheduledTime) {
            const scheduled = parseScheduledDateTime(mealLog.scheduledDate, mealLog.scheduledTime);
            if (scheduled) {
                const diffMinutes = Math.abs(mealLog.loggedAt.getTime() - scheduled.getTime()) / 60000;
                if (diffMinutes <= COMPLIANCE_CONFIG.ON_TIME_WINDOW_MINUTES) {
                    score += WEIGHTS.ON_TIME;
                } else {
                    issues.push(`Meal logged ${Math.round(diffMinutes)} min from scheduled time`);
                }
            } else {
                // No valid scheduled time — give benefit of the doubt
                score += WEIGHTS.ON_TIME;
            }
        } else if (mealLog.loggedAt) {
            // No scheduled time set — give the points
            score += WEIGHTS.ON_TIME;
        } else {
            issues.push('Meal not logged yet');
        }

        // Factor 2: Photo uploaded (+15)
        if (mealLog.mealPhotoUrl) {
            score += WEIGHTS.PHOTO;
        } else {
            issues.push('No photo uploaded');
        }

        // Factor 3: Correct foods (+30)
        // For now, if status is 'eaten' (not substituted), assume correct foods
        if (mealLog.status === 'eaten') {
            score += WEIGHTS.CORRECT_FOODS;
        } else if (mealLog.status === 'substituted') {
            // Partial credit for substitution — they ate something
            score += Math.round(WEIGHTS.CORRECT_FOODS * 0.5);
            issues.push('Substituted foods from planned meal');
        } else {
            issues.push('Foods not confirmed');
        }

        // Factor 4: Portion accuracy (+20)
        // Compare substituteCaloriesEst (if provided) vs planned calories
        // Filter by chosen option group for meals with alternatives
        const chosenGroup = mealLog.chosenOptionGroup ?? 0;
        const plannedFoodItems = mealLog.meal.foodItems.filter(fi => fi.optionGroup === chosenGroup);
        let plannedCalories = 0;
        plannedFoodItems.forEach(fi => {
            const ratio = Number(fi.quantityG) / 100;
            plannedCalories += fi.foodItem.calories * ratio;
        });

        if (mealLog.substituteCaloriesEst && plannedCalories > 0) {
            const deviation = Math.abs(mealLog.substituteCaloriesEst - plannedCalories) / plannedCalories;
            if (deviation <= COMPLIANCE_CONFIG.PORTION_TOLERANCE_PCT) {
                score += WEIGHTS.PORTION_ACCURACY;
            } else {
                // Proportional: lose points based on deviation
                const portionScore = Math.max(0, WEIGHTS.PORTION_ACCURACY * (1 - deviation));
                score += Math.round(portionScore);
                issues.push(`Calorie deviation: ${Math.round(deviation * 100)}%`);
            }
        } else if (mealLog.status === 'eaten') {
            // No substitute info and ate the meal — assume portion was correct
            score += WEIGHTS.PORTION_ACCURACY;
        }

        // Factor 5: Dietitian approved (+15)
        if (mealLog.dietitianFeedback) {
            score += WEIGHTS.DIETITIAN_APPROVED;
        } else {
            issues.push('Awaiting dietitian review');
        }

        // Factor 6: Substitution penalty (-10)
        if (mealLog.status === 'substituted') {
            score += PENALTIES.SUBSTITUTION;
            issues.push('Substitution penalty applied');
        }

        score = Math.max(0, Math.min(100, score));
        const color = getColor(score);

        await this.persistScore(mealLogId, score, issues);

        logger.info('Compliance calculated', { mealLogId, score, color, issues });
        return { score, color, issues };
    }

    /**
     * Calculate daily adherence for a client on a given date
     */
    async calculateDailyAdherence(clientId: string, date: Date): Promise<DailyAdherence> {
        const start = new Date(date);
        start.setHours(0, 0, 0, 0);
        const end = new Date(date);
        end.setHours(23, 59, 59, 999);

        // Get all meal logs for this day
        const logs = await prisma.mealLog.findMany({
            where: {
                clientId,
                scheduledDate: { gte: start, lte: end },
            },
            include: {
                meal: { select: { name: true, mealType: true } },
            },
            orderBy: { scheduledTime: 'asc' },
        });

        // Count planned meals from active diet plan
        const activePlan = await prisma.dietPlan.findFirst({
            where: {
                clientId,
                status: 'active',
                isActive: true,
            },
            include: {
                meals: { select: { id: true } },
            },
        });

        const mealsPlanned = activePlan?.meals.length || logs.length;

        // Derive score from status when complianceScore hasn't been calculated yet
        const deriveScoreFromStatus = (status: string): number => {
            if (status === 'eaten') return 85;
            if (status === 'substituted') return 50;
            if (status === 'skipped') return 0;
            return 0; // pending
        };

        const mealBreakdown: MealBreakdown[] = logs.map(log => {
            const score = log.complianceScore ?? (log.status !== 'pending' ? deriveScoreFromStatus(log.status) : null);
            return {
                mealLogId: log.id,
                mealName: log.meal.name,
                mealType: log.meal.mealType,
                score,
                color: score !== null ? (log.complianceColor as ComplianceColor) || getColor(score) : null,
                status: log.status,
                issues: log.complianceIssues || [],
            };
        });

        const scoredMeals = mealBreakdown.filter(m => m.score !== null);
        const totalScore = scoredMeals.reduce((sum, m) => sum + (m.score || 0), 0);
        const avgScore = scoredMeals.length > 0 ? Math.round(totalScore / scoredMeals.length) : 0;

        return {
            date: start.toISOString().split('T')[0],
            score: avgScore,
            color: getColor(avgScore),
            mealsLogged: logs.filter(l => l.status !== 'pending').length,
            mealsPlanned,
            mealBreakdown,
        };
    }

    /**
     * Calculate weekly adherence for a client
     */
    async calculateWeeklyAdherence(clientId: string, weekStartDate?: Date): Promise<WeeklyAdherence> {
        const weekStart = weekStartDate ? new Date(weekStartDate) : this.getWeekStart(new Date());
        weekStart.setHours(0, 0, 0, 0);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);

        // Calculate daily adherence for each day of the week
        const dailyBreakdown: DailyAdherence[] = [];
        for (let i = 0; i < 7; i++) {
            const day = new Date(weekStart);
            day.setDate(day.getDate() + i);
            const daily = await this.calculateDailyAdherence(clientId, day);
            dailyBreakdown.push(daily);
        }

        const daysWithScores = dailyBreakdown.filter(d => d.mealsLogged > 0);
        const avgScore = daysWithScores.length > 0
            ? Math.round(daysWithScores.reduce((sum, d) => sum + d.score, 0) / daysWithScores.length)
            : 0;

        // Trend: compare with previous week
        const prevWeekStart = new Date(weekStart);
        prevWeekStart.setDate(prevWeekStart.getDate() - 7);
        const prevWeekEnd = new Date(prevWeekStart);
        prevWeekEnd.setDate(prevWeekEnd.getDate() + 6);

        const prevLogs = await prisma.mealLog.findMany({
            where: {
                clientId,
                scheduledDate: { gte: prevWeekStart, lte: prevWeekEnd },
                complianceScore: { not: null },
            },
            select: { complianceScore: true },
        });

        let trend: 'improving' | 'declining' | 'stable' = 'stable';
        if (prevLogs.length > 0 && daysWithScores.length > 0) {
            const prevAvg = Math.round(prevLogs.reduce((s, l) => s + (l.complianceScore || 0), 0) / prevLogs.length);
            const diff = avgScore - prevAvg;
            if (diff > COMPLIANCE_CONFIG.TREND_THRESHOLD) trend = 'improving';
            else if (diff < -COMPLIANCE_CONFIG.TREND_THRESHOLD) trend = 'declining';
        }

        return {
            weekStart: weekStart.toISOString().split('T')[0],
            weekEnd: weekEnd.toISOString().split('T')[0],
            averageScore: avgScore,
            color: getColor(avgScore),
            dailyBreakdown,
            trend,
        };
    }

    /**
     * Get compliance history for charting
     */
    async getClientComplianceHistory(clientId: string, days: number = 30): Promise<ComplianceHistory> {
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);
        startDate.setHours(0, 0, 0, 0);

        const logs = await prisma.mealLog.findMany({
            where: {
                clientId,
                scheduledDate: { gte: startDate },
                complianceScore: { not: null },
            },
            select: {
                scheduledDate: true,
                complianceScore: true,
                complianceColor: true,
            },
            orderBy: { scheduledDate: 'asc' },
        });

        // Group by date
        const dateMap = new Map<string, number[]>();
        logs.forEach(log => {
            const dateKey = log.scheduledDate.toISOString().split('T')[0];
            if (!dateMap.has(dateKey)) dateMap.set(dateKey, []);
            dateMap.get(dateKey)!.push(log.complianceScore!);
        });

        const data: ComplianceHistoryEntry[] = [];
        dateMap.forEach((scores, dateKey) => {
            const avg = Math.round(scores.reduce((s, v) => s + v, 0) / scores.length);
            data.push({ date: dateKey, score: avg, color: getColor(avg) });
        });

        data.sort((a, b) => a.date.localeCompare(b.date));

        const totalAvg = data.length > 0
            ? Math.round(data.reduce((s, d) => s + d.score, 0) / data.length)
            : 0;

        const bestDay = data.length > 0
            ? data.reduce((best, d) => d.score > best.score ? d : best, data[0])
            : null;

        const worstDay = data.length > 0
            ? data.reduce((worst, d) => d.score < worst.score ? d : worst, data[0])
            : null;

        return { data, averageScore: totalAvg, bestDay, worstDay };
    }

    // ============ PRIVATE HELPERS ============

    private async persistScore(mealLogId: string, score: number, issues: string[]): Promise<void> {
        const color = getColor(score);
        await prisma.mealLog.update({
            where: { id: mealLogId },
            data: {
                complianceScore: score,
                complianceColor: color,
                complianceIssues: issues,
            },
        });
    }

    private getWeekStart(date: Date): Date {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday start
        d.setDate(diff);
        return d;
    }
}

export const complianceService = new ComplianceService();
</file>

<file path="backend/src/services/mealLog.service.ts">
import prisma from '../utils/prisma';
import { AppError } from '../errors/AppError';
import logger from '../utils/logger';
import { buildPaginationParams, buildPaginationMeta, buildDateFilter } from '../utils/queryFilters';
import { scaleNutrition, sumNutrition } from '../utils/nutritionCalculator';
import { complianceService } from './compliance.service';
import { CreateMealLogInput, UpdateMealLogInput, ReviewMealLogInput } from '../schemas/mealLog.schema';

export class MealLogService {
    async createMealLog(data: CreateMealLogInput, orgId: string) {
        const client = await prisma.client.findFirst({ where: { id: data.clientId, orgId } });
        if (!client) throw AppError.notFound('Client not found', 'CLIENT_NOT_FOUND');

        const meal = await prisma.meal.findUnique({
            where: { id: data.mealId },
            include: { dietPlan: true },
        });

        if (!meal || meal.dietPlan.orgId !== orgId) {
            throw AppError.notFound('Meal not found', 'MEAL_NOT_FOUND');
        }

        const mealLog = await prisma.mealLog.create({
            data: {
                orgId,
                clientId: data.clientId,
                mealId: data.mealId,
                scheduledDate: new Date(data.scheduledDate),
                scheduledTime: data.scheduledTime,
                status: 'pending',
            },
            include: {
                meal: { select: { name: true, mealType: true } },
                client: { select: { id: true, fullName: true } },
            },
        });

        logger.info('Meal log created', { mealLogId: mealLog.id });
        return mealLog;
    }

    async listMealLogs(orgId: string, query: any, userRole: string, userId: string) {
        const { clientId, status, reviewStatus, sortBy = 'scheduledDate' } = query;
        const pagination = buildPaginationParams(query.page, query.pageSize);
        const dateFilter = buildDateFilter(query.dateFrom, query.dateTo);

        const where: any = { orgId };
        if (clientId) where.clientId = String(clientId);

        // reviewStatus takes precedence: filters by dietitian review state
        if (reviewStatus === 'pending') {
            // Client acted on it, dietitian hasn't reviewed
            where.status = { in: ['eaten', 'skipped', 'substituted'] };
            where.reviewedByUserId = null;
        } else if (reviewStatus === 'reviewed') {
            where.reviewedByUserId = { not: null };
        } else if (status) {
            where.status = String(status);
        }

        if (dateFilter) where.scheduledDate = dateFilter;
        if (userRole === 'dietitian') where.client = { primaryDietitianId: userId };

        const [mealLogs, total] = await prisma.$transaction([
            prisma.mealLog.findMany({
                where,
                skip: pagination.skip,
                take: pagination.take,
                orderBy: { [String(sortBy)]: 'desc' },
                include: {
                    meal: { select: { name: true, mealType: true, timeOfDay: true } },
                    client: { select: { id: true, fullName: true } },
                    reviewer: { select: { id: true, fullName: true } },
                },
            }),
            prisma.mealLog.count({ where }),
        ]);

        const data = mealLogs.map((log) => ({
            id: log.id,
            mealId: log.mealId,
            scheduledDate: log.scheduledDate,
            scheduledTime: log.scheduledTime,
            meal: { name: log.meal.name, mealType: log.meal.mealType },
            client: log.client,
            status: log.status,
            mealPhotoUrl: log.mealPhotoUrl,
            mealPhotoSmallUrl: log.mealPhotoSmallUrl,
            clientNotes: log.clientNotes,
            dietitianFeedback: log.dietitianFeedback,
            reviewedByUser: log.reviewer,
            dietitianReviewedAt: log.dietitianFeedbackAt,
            loggedAt: log.loggedAt,
            createdAt: log.createdAt,
            complianceScore: log.complianceScore,
            complianceColor: log.complianceColor,
            complianceIssues: log.complianceIssues,
        }));

        return { data, meta: buildPaginationMeta(total, pagination) };
    }

    async getMealLog(mealLogId: string, orgId: string) {
        const mealLog = await prisma.mealLog.findFirst({
            where: { id: mealLogId, orgId },
            include: {
                meal: { include: { foodItems: { include: { foodItem: true } } } },
                client: { select: { id: true, fullName: true } },
                reviewer: { select: { id: true, fullName: true } },
            },
        });

        if (!mealLog) throw AppError.notFound('Meal log not found', 'MEAL_LOG_NOT_FOUND');

        // Group food items by optionGroup
        const optionGroupsMap = new Map<number, typeof mealLog.meal.foodItems>();
        mealLog.meal.foodItems.forEach((mfi) => {
            const group = mfi.optionGroup;
            if (!optionGroupsMap.has(group)) optionGroupsMap.set(group, []);
            optionGroupsMap.get(group)!.push(mfi);
        });

        const hasAlternatives = optionGroupsMap.size > 1;

        const options = Array.from(optionGroupsMap.entries())
            .sort(([a], [b]) => a - b)
            .map(([group, groupItems]) => {
                const items = groupItems.map((mfi) => {
                    const nutrition = scaleNutrition(mfi.foodItem, Number(mfi.quantityG));
                    return {
                        foodId: mfi.foodItem.id,
                        foodName: mfi.foodItem.name,
                        quantity: Number(mfi.quantityG),
                        unit: 'g',
                        nutrition,
                    };
                });
                const totals = sumNutrition(items.map((i) => i.nutrition));
                return {
                    optionGroup: group,
                    label: groupItems[0]?.optionLabel || (group === 0 ? 'Default' : `Option ${group + 1}`),
                    items,
                    totals,
                };
            });

        // Flat items list (all options combined) for backward compatibility
        const allItems = mealLog.meal.foodItems.map((mfi) => {
            const nutrition = scaleNutrition(mfi.foodItem, Number(mfi.quantityG));
            return {
                foodId: mfi.foodItem.id,
                foodName: mfi.foodItem.name,
                quantity: Number(mfi.quantityG),
                unit: 'g',
                nutrition,
            };
        });
        const totals = sumNutrition(allItems.map((i) => i.nutrition));

        return {
            id: mealLog.id,
            organizationId: mealLog.orgId,
            client: mealLog.client,
            mealId: mealLog.mealId,
            scheduledDate: mealLog.scheduledDate,
            scheduledTime: mealLog.scheduledTime,
            meal: {
                title: mealLog.meal.name,
                mealType: mealLog.meal.mealType,
                instructions: mealLog.meal.instructions,
                items: allItems,
                totals,
                hasAlternatives,
                options,
            },
            status: mealLog.status,
            chosenOptionGroup: mealLog.chosenOptionGroup,
            photoUrl: mealLog.mealPhotoUrl,
            clientNotes: mealLog.clientNotes,
            dietitianFeedback: mealLog.dietitianFeedback,
            reviewedByUser: mealLog.reviewer,
            dietitianReviewedAt: mealLog.dietitianFeedbackAt,
            loggedAt: mealLog.loggedAt,
            createdAt: mealLog.createdAt,
            updatedAt: mealLog.updatedAt,
            complianceScore: mealLog.complianceScore,
            complianceColor: mealLog.complianceColor,
            complianceIssues: mealLog.complianceIssues,
        };
    }

    async updateMealLog(mealLogId: string, data: UpdateMealLogInput, orgId: string) {
        const mealLog = await prisma.mealLog.findFirst({
            where: { id: mealLogId, orgId },
        });

        if (!mealLog) throw AppError.notFound('Meal log not found', 'MEAL_LOG_NOT_FOUND');

        const updateData: any = {};
        if (data.status) updateData.status = data.status;
        if (data.clientNotes !== undefined) updateData.clientNotes = data.clientNotes;
        if (data.substituteDescription !== undefined) updateData.substituteDescription = data.substituteDescription;
        if (data.substituteCaloriesEst !== undefined) updateData.substituteCaloriesEst = data.substituteCaloriesEst;
        if (data.chosenOptionGroup !== undefined) updateData.chosenOptionGroup = data.chosenOptionGroup;
        if (data.photoUrl) {
            updateData.mealPhotoUrl = data.photoUrl;
            updateData.photoUploadedAt = new Date();
        }
        if (data.status && data.status !== 'pending') updateData.loggedAt = new Date();

        const updated = await prisma.mealLog.update({ where: { id: mealLogId }, data: updateData });

        // Recalculate compliance when status changes from pending
        if (data.status && data.status !== 'pending' && data.status !== mealLog.status) {
            await complianceService.calculateMealCompliance(updated.id);
        }

        const finalLog = await prisma.mealLog.findUnique({ where: { id: updated.id } });
        logger.info('Meal log updated', { mealLogId: updated.id });

        return {
            id: finalLog!.id,
            status: finalLog!.status,
            photoUrl: finalLog!.mealPhotoUrl,
            clientNotes: finalLog!.clientNotes,
            loggedAt: finalLog!.loggedAt,
            complianceScore: finalLog!.complianceScore,
            complianceColor: finalLog!.complianceColor,
        };
    }

    async reviewMealLog(mealLogId: string, data: ReviewMealLogInput, orgId: string, userId: string) {
        const mealLog = await prisma.mealLog.findFirst({ where: { id: mealLogId, orgId } });
        if (!mealLog) throw AppError.notFound('Meal log not found', 'MEAL_LOG_NOT_FOUND');

        const updateData: any = { reviewedByUserId: userId, dietitianFeedbackAt: new Date() };
        if (data.dietitianFeedback !== undefined) updateData.dietitianFeedback = data.dietitianFeedback;
        if (data.status) updateData.status = data.status;
        if (data.overrideCalories !== undefined) updateData.substituteCaloriesEst = data.overrideCalories;

        const updated = await prisma.mealLog.update({
            where: { id: mealLogId },
            data: updateData,
            include: { reviewer: { select: { id: true, fullName: true } } },
        });

        // Recalculate compliance after dietitian review (adds dietitian_approved factor)
        await complianceService.calculateMealCompliance(updated.id);

        logger.info('Meal log reviewed', { mealLogId: updated.id, reviewerId: userId });

        const finalLog = await prisma.mealLog.findUnique({ where: { id: updated.id } });
        return {
            id: updated.id,
            status: updated.status,
            dietitianFeedback: updated.dietitianFeedback,
            reviewedByUser: updated.reviewer,
            dietitianReviewedAt: updated.dietitianFeedbackAt,
            complianceScore: finalLog?.complianceScore,
            complianceColor: finalLog?.complianceColor,
        };
    }

    async uploadMealPhoto(mealLogId: string, fileBuffer: Buffer, fileSize: number, orgId: string) {
        const mealLog = await prisma.mealLog.findFirst({ where: { id: mealLogId, orgId } });
        if (!mealLog) throw AppError.notFound('Meal log not found', 'MEAL_LOG_NOT_FOUND');

        const { StorageService } = await import('./storage.service');

        const { fullUrl, thumbUrl } = await StorageService.uploadMealPhoto(fileBuffer, orgId, mealLogId);

        const updated = await prisma.mealLog.update({
            where: { id: mealLogId },
            data: {
                mealPhotoUrl: fullUrl,
                mealPhotoSmallUrl: thumbUrl,
                photoUploadedAt: new Date(),
                ...(mealLog.status === 'pending' && { status: 'eaten', loggedAt: new Date() }),
            },
        });

        // Recalculate compliance after photo upload (adds photo factor)
        await complianceService.calculateMealCompliance(updated.id);

        logger.info('Meal photo uploaded', { mealLogId, fullUrl, thumbUrl, originalSize: fileSize });

        const finalLog = await prisma.mealLog.findUnique({ where: { id: updated.id } });
        return {
            id: updated.id,
            mealPhotoUrl: updated.mealPhotoUrl,
            mealPhotoSmallUrl: updated.mealPhotoSmallUrl,
            photoUploadedAt: updated.photoUploadedAt,
            status: updated.status,
            complianceScore: finalLog?.complianceScore,
            complianceColor: finalLog?.complianceColor,
        };
    }
}

export const mealLogService = new MealLogService();
</file>

<file path="backend/src/services/onboarding.service.ts">
/**
 * Client Onboarding Service
 * Handles multi-step onboarding with presets for common restriction patterns
 */

import prisma from '../utils/prisma';
import logger from '../utils/logger';
import { ActivityLevel } from '@prisma/client';
import { validationEngine } from './validationEngine.service';

// ============ ONBOARDING STEP DEFINITIONS ============

export interface OnboardingStep {
    step: number;
    name: string;
    description: string;
    isRequired: boolean;
}

export const ONBOARDING_STEPS: OnboardingStep[] = [
    { step: 1, name: 'basic_info', description: 'Height, weight, and goal', isRequired: true },
    { step: 2, name: 'diet_pattern', description: 'Dietary pattern selection', isRequired: true },
    { step: 3, name: 'allergies', description: 'Allergies and intolerances', isRequired: false },
    { step: 4, name: 'restrictions', description: 'Food restrictions and fasting days', isRequired: false },
    { step: 5, name: 'preferences', description: 'Likes, dislikes, and cuisines', isRequired: false },
    { step: 6, name: 'body_measurements', description: 'Body measurements (optional)', isRequired: false },
];

// ============ RESTRICTION PRESETS ============

export interface RestrictionPreset {
    id: string;
    name: string;
    description: string;
    restrictions: any[];
}

export const RESTRICTION_PRESETS: RestrictionPreset[] = [
    {
        id: 'hindu_fasting_no_meat',
        name: 'Hindu Fasting (No Meat on Tue/Thu)',
        description: 'No non-veg on Tuesday and Thursday',
        restrictions: [{
            foodCategory: 'non_veg',
            restrictionType: 'day_based',
            avoidDays: ['tuesday', 'thursday'],
            severity: 'strict',
            reason: 'religious_fasting'
        }]
    },
    {
        id: 'hindu_fasting_eggs_ok',
        name: 'Hindu Fasting (Eggs OK on Tue/Thu)',
        description: 'No meat but eggs allowed on Tuesday and Thursday',
        restrictions: [{
            foodCategory: 'non_veg',
            restrictionType: 'day_based',
            avoidDays: ['tuesday', 'thursday'],
            excludes: ['eggs'],
            severity: 'strict',
            reason: 'religious_fasting'
        }]
    },
    {
        id: 'catholic_friday',
        name: 'Catholic (No Meat on Friday)',
        description: 'No meat on Friday, fish allowed',
        restrictions: [{
            foodCategory: 'non_veg',
            restrictionType: 'day_based',
            avoidDays: ['friday'],
            excludes: ['fish', 'seafood'],
            severity: 'strict',
            reason: 'religious_fasting'
        }]
    },
    {
        id: 'jain_strict',
        name: 'Jain Diet (No Root Vegetables)',
        description: 'No onion, garlic, potatoes, or root vegetables',
        restrictions: [
            {
                foodCategory: 'root_vegetables',
                restrictionType: 'always',
                includes: ['onion', 'garlic', 'potato', 'carrot', 'beetroot', 'radish'],
                severity: 'strict',
                reason: 'jain_diet'
            },
            {
                foodCategory: 'non_veg',
                restrictionType: 'always',
                severity: 'strict',
                reason: 'jain_diet'
            }
        ]
    },
    {
        id: 'islamic_halal',
        name: 'Halal (No Pork)',
        description: 'No pork products',
        restrictions: [{
            foodName: 'pork',
            restrictionType: 'always',
            severity: 'strict',
            reason: 'religious_dietary_law'
        }]
    },
    {
        id: 'navratri_fasting',
        name: 'Navratri Fasting',
        description: 'Only specific foods allowed during Navratri',
        restrictions: [
            {
                foodCategory: 'non_veg',
                restrictionType: 'always',
                severity: 'strict',
                reason: 'navratri_fast'
            },
            {
                foodCategory: 'grains',
                restrictionType: 'always',
                excludes: ['kuttu', 'singhara', 'sabudana', 'amaranth'],
                severity: 'strict',
                reason: 'navratri_fast'
            }
        ]
    }
];

// ============ ONBOARDING DATA INTERFACES ============

export interface Step1Data {
    heightCm: number;
    currentWeightKg: number;
    targetWeightKg?: number;
    dateOfBirth?: string;
    gender?: 'male' | 'female' | 'other';
    activityLevel?: 'sedentary' | 'lightly_active' | 'moderately_active' | 'very_active' | 'extremely_active';
}

export interface Step2Data {
    dietPattern: 'vegetarian' | 'vegan' | 'non_veg' | 'pescatarian' | 'eggetarian';
    eggAllowed: boolean;
}

export interface Step3Data {
    allergies: string[];
    intolerances: string[];
}

export interface Step4Data {
    presetId?: string;
    customRestrictions?: any[];
    eggAvoidDays?: string[];
}

export interface Step5Data {
    dislikes: string[];
    likedFoods: string[];
    preferredCuisines: string[];
}

export interface Step6Data {
    chestCm?: number;
    waistCm?: number;
    hipsCm?: number;
    thighsCm?: number;
    armsCm?: number;
    bodyFatPercentage?: number;
}

// ============ SERVICE ============

export class OnboardingService {

    /**
     * Get all onboarding steps
     */
    getSteps(): OnboardingStep[] {
        return ONBOARDING_STEPS;
    }

    /**
     * Get all restriction presets
     */
    getPresets(): RestrictionPreset[] {
        return RESTRICTION_PRESETS;
    }

    /**
     * Get current onboarding status for a client
     */
    async getOnboardingStatus(clientId: string): Promise<{
        isComplete: boolean;
        currentStep: number;
        totalSteps: number;
        completedSteps: number[];
        percentComplete: number;
        stepsData: Record<string, any>;
    }> {
        const client = await prisma.client.findUnique({
            where: { id: clientId },
            select: {
                onboardingCompleted: true,
                heightCm: true,
                currentWeightKg: true,
                targetWeightKg: true,
                gender: true,
                activityLevel: true,
                dietPattern: true,
                eggAllowed: true,
                allergies: true,
                intolerances: true,
                foodRestrictions: true,
                eggAvoidDays: true,
                dislikes: true,
                likedFoods: true,
                preferredCuisines: true,
            }
        });

        if (!client) throw new Error('Client not found');

        const completedSteps: number[] = [];
        const stepsData: Record<string, any> = {};

        // Check step 1
        if (client.heightCm && client.currentWeightKg) {
            completedSteps.push(1);
        }
        stepsData.step1 = {
            heightCm: client.heightCm ? Number(client.heightCm) : null,
            currentWeightKg: client.currentWeightKg ? Number(client.currentWeightKg) : null,
            targetWeightKg: client.targetWeightKg ? Number(client.targetWeightKg) : null,
            gender: client.gender,
            activityLevel: client.activityLevel,
        };

        // Check step 2
        if (client.dietPattern) {
            completedSteps.push(2);
        }
        stepsData.step2 = {
            dietPattern: client.dietPattern,
            eggAllowed: client.eggAllowed,
        };

        // Check step 3 (optional — completed if allergies were explicitly set, even empty)
        if (client.allergies && client.allergies.length > 0) {
            completedSteps.push(3);
        }
        stepsData.step3 = {
            allergies: client.allergies || [],
            intolerances: client.intolerances || [],
        };

        // Check step 4 (optional)
        if (client.foodRestrictions && (client.foodRestrictions as any[]).length > 0) {
            completedSteps.push(4);
        }
        stepsData.step4 = {
            foodRestrictions: client.foodRestrictions || [],
            eggAvoidDays: client.eggAvoidDays || [],
        };

        // Check step 5 (optional)
        if (client.dislikes && client.dislikes.length > 0) {
            completedSteps.push(5);
        }
        stepsData.step5 = {
            dislikes: client.dislikes || [],
            likedFoods: client.likedFoods || [],
            preferredCuisines: client.preferredCuisines || [],
        };

        // Check step 6 — body measurements
        const bodyMeasurement = await prisma.bodyMeasurement.findFirst({
            where: { clientId },
            orderBy: { logDate: 'desc' },
        });
        if (bodyMeasurement) {
            completedSteps.push(6);
        }
        stepsData.step6 = bodyMeasurement ? {
            chestCm: bodyMeasurement.chestCm ? Number(bodyMeasurement.chestCm) : null,
            waistCm: bodyMeasurement.waistCm ? Number(bodyMeasurement.waistCm) : null,
            hipsCm: bodyMeasurement.hipsCm ? Number(bodyMeasurement.hipsCm) : null,
            thighsCm: bodyMeasurement.thighsCm ? Number(bodyMeasurement.thighsCm) : null,
            armsCm: bodyMeasurement.armsCm ? Number(bodyMeasurement.armsCm) : null,
            bodyFatPercentage: bodyMeasurement.bodyFatPercentage ? Number(bodyMeasurement.bodyFatPercentage) : null,
        } : null;

        const totalSteps = ONBOARDING_STEPS.length;

        return {
            isComplete: client.onboardingCompleted,
            currentStep: completedSteps.length > 0 ? Math.max(...completedSteps) + 1 : 1,
            totalSteps,
            completedSteps,
            percentComplete: Math.round((completedSteps.length / totalSteps) * 100),
            stepsData,
        };
    }

    /**
     * Save Step 1: Basic Info
     */
    async saveStep1(clientId: string, data: Step1Data): Promise<void> {
        await prisma.client.update({
            where: { id: clientId },
            data: {
                heightCm: data.heightCm,
                currentWeightKg: data.currentWeightKg,
                targetWeightKg: data.targetWeightKg,
                dateOfBirth: data.dateOfBirth ? new Date(data.dateOfBirth) : undefined,
                gender: data.gender,
                activityLevel: data.activityLevel as ActivityLevel,
            }
        });
        logger.info('Onboarding step 1 saved', { clientId });
    }

    /**
     * Save Step 2: Diet Pattern
     */
    async saveStep2(clientId: string, data: Step2Data): Promise<void> {
        await prisma.client.update({
            where: { id: clientId },
            data: {
                dietPattern: data.dietPattern,
                eggAllowed: data.eggAllowed,
            }
        });
        validationEngine.invalidateClientCache(clientId);
        logger.info('Onboarding step 2 saved', { clientId });
    }

    /**
     * Save Step 3: Allergies
     */
    async saveStep3(clientId: string, data: Step3Data): Promise<void> {
        await prisma.client.update({
            where: { id: clientId },
            data: {
                allergies: data.allergies,
                intolerances: data.intolerances,
            }
        });
        validationEngine.invalidateClientCache(clientId);
        logger.info('Onboarding step 3 saved', { clientId });
    }

    /**
     * Save Step 4: Restrictions
     */
    async saveStep4(clientId: string, data: Step4Data): Promise<void> {
        // Get restrictions from preset or custom
        let restrictions: any[] = [];

        if (data.presetId) {
            const preset = RESTRICTION_PRESETS.find(p => p.id === data.presetId);
            if (preset) {
                restrictions = preset.restrictions;
            }
        }

        if (data.customRestrictions) {
            restrictions = [...restrictions, ...data.customRestrictions];
        }

        await prisma.client.update({
            where: { id: clientId },
            data: {
                foodRestrictions: restrictions,
                eggAvoidDays: data.eggAvoidDays || [],
            }
        });
        validationEngine.invalidateClientCache(clientId);
        logger.info('Onboarding step 4 saved', { clientId, restrictionCount: restrictions.length });
    }

    /**
     * Save Step 5: Preferences
     */
    async saveStep5(clientId: string, data: Step5Data): Promise<void> {
        await prisma.client.update({
            where: { id: clientId },
            data: {
                dislikes: data.dislikes,
                likedFoods: data.likedFoods,
                preferredCuisines: data.preferredCuisines,
            }
        });
        validationEngine.invalidateClientCache(clientId);
        logger.info('Onboarding step 5 saved', { clientId });
    }

    /**
     * Save Step 6: Body Measurements (optional)
     */
    async saveStep6(clientId: string, data: Step6Data): Promise<void> {
        const client = await prisma.client.findUnique({
            where: { id: clientId },
            select: { orgId: true },
        });
        if (!client) throw new Error('Client not found');

        await prisma.bodyMeasurement.create({
            data: {
                clientId,
                orgId: client.orgId,
                logDate: new Date(),
                chestCm: data.chestCm,
                waistCm: data.waistCm,
                hipsCm: data.hipsCm,
                thighsCm: data.thighsCm,
                armsCm: data.armsCm,
                bodyFatPercentage: data.bodyFatPercentage,
            }
        });
        logger.info('Onboarding step 6 saved', { clientId });
    }

    /**
     * Complete onboarding (can be called manually)
     */
    async completeOnboarding(clientId: string): Promise<void> {
        await prisma.client.update({
            where: { id: clientId },
            data: { onboardingCompleted: true }
        });
        logger.info('Onboarding marked complete', { clientId });
    }
}

export const onboardingService = new OnboardingService();
</file>

<file path="backend/src/types/validation.types.ts">
/**
 * Diet Validation Engine Types
 * Part of DietKaro real-time validation system
 */

// ============ ENUMS ============

export enum ValidationSeverity {
    RED = 'RED',       // Blocking - cannot add
    YELLOW = 'YELLOW', // Warning - can add with caution
    GREEN = 'GREEN'    // Positive - good match
}

export type AlertType =
    | 'allergy'
    | 'intolerance'
    | 'diet_pattern'
    | 'day_restriction'
    | 'food_restriction'
    | 'medical'
    | 'lab_derived'
    | 'dislike'
    | 'preference_match'
    | 'cuisine_match'
    | 'goal_aligned'
    | 'repetition'
    | 'nutrition_strength';

// ============ REQUEST/RESPONSE ============

export interface ValidationContext {
    currentDay: string;  // "monday", "tuesday", etc.
    mealType: 'breakfast' | 'lunch' | 'snack' | 'dinner';
    planId?: string;
    scheduledTime?: string; // "HH:mm" format for time-based restriction checks
    // For repetition checks (how many times this food was used this week)
    weeklyUsage?: Record<string, number>;
}

export interface ValidationRequest {
    clientId: string;
    foodId: string;
    context: ValidationContext;
}

export interface BatchValidationRequest {
    clientId: string;
    foodIds: string[];
    context: ValidationContext;
}

export interface ValidationAlert {
    type: AlertType;
    severity: ValidationSeverity;
    message: string;
    recommendation?: string;
    icon?: string;
}

export interface ValidationResult {
    foodId: string;
    foodName: string;
    severity: ValidationSeverity;
    borderColor: 'red' | 'yellow' | 'green';
    canAdd: boolean;
    alerts: ValidationAlert[];
    confidenceScore: number;
}

export interface BatchValidationResult {
    results: ValidationResult[];
    processingTimeMs: number;
}

// ============ FOOD RESTRICTION ============

export type RestrictionType = 'day_based' | 'time_based' | 'frequency' | 'quantity' | 'always';

export interface FoodRestriction {
    // What is restricted (at least one must be specified)
    foodId?: string;          // Specific food database ID
    foodName?: string;        // Name match (e.g., "eggs", "chicken")
    foodCategory?: string;    // Category (e.g., "non_veg", "dairy", "root_vegetables")

    // Restriction type
    restrictionType: RestrictionType;

    // Day-based restrictions
    avoidDays?: string[];     // ["tuesday", "thursday"]

    // Time-based restrictions
    avoidMeals?: string[];    // ["dinner", "snack"]
    avoidAfter?: string;      // "19:00"
    avoidBefore?: string;     // "08:00"

    // Frequency-based restrictions
    maxPerWeek?: number;
    maxPerDay?: number;

    // Quantity-based restrictions
    maxGramsPerMeal?: number;

    // Exceptions - items excluded from this restriction
    excludes?: string[];      // Food IDs or names excluded
    includes?: string[];      // Specific items included in category

    // Metadata
    reason?: string;          // "religious_fasting", "medical", "personal_choice"
    severity: 'strict' | 'flexible';  // strict = RED, flexible = YELLOW
    note?: string;            // Free text explanation
}

// ============ TAG INTERFACES ============

export interface ClientTags {
    // HARD CONSTRAINTS (RED blocking)
    allergies: Set<string>;
    intolerances: Set<string>;

    // DIETARY PATTERN (RED blocking)
    dietPattern: string | null;
    eggAllowed: boolean;
    eggAvoidDays: Set<string>;

    // FLEXIBLE RESTRICTIONS (RED or YELLOW based on severity)
    foodRestrictions: FoodRestriction[];

    // SOFT CONSTRAINTS (YELLOW warning)
    dislikes: Set<string>;
    avoidCategories: Set<string>;

    // MEDICAL (YELLOW warning)
    medicalConditions: Set<string>;
    labDerivedTags: Set<string>;

    // POSITIVE (GREEN)
    likedFoods: Set<string>;
    preferredCuisines: Set<string>;
}

export interface FoodTags {
    id: string;
    name: string;

    // Safety
    allergenFlags: Set<string>;

    // Dietary
    dietaryCategory: string | null;
    cuisineTags: Set<string>;

    // Nutrition
    nutritionTags: Set<string>;
    calories?: number;
    proteinG?: number;
    carbsG?: number;
    fatsG?: number;

    // Medical
    healthFlags: Set<string>;

    // Processing
    processingLevel: string | null;

    // Suitability
    mealSuitabilityTags: Set<string>;
}

// ============ PLAN TARGETS ============

export interface PlanTargets {
    targetCalories: number | null;
    targetProteinG: number | null;
    targetCarbsG: number | null;
    targetFatsG: number | null;
}

// ============ CACHE ENTRY ============

export interface CachedClientTags {
    tags: ClientTags;
    cachedAt: number;
}
</file>

<file path="backend/src/utils/validation-rules.ts">
/**
 * Validation Rules and Mappings
 * Centralized constants for food validation engine
 */

// ============ ALLERGEN MAPPING ============

/**
 * Maps client allergy names to food allergen flags
 * Used by ValidationEngine to check allergen matches
 */
export const ALLERGEN_MAPPING: Record<string, string> = {
    peanuts: 'peanuts',
    tree_nuts: 'tree_nuts',
    almonds: 'tree_nuts',
    cashews: 'tree_nuts',
    walnuts: 'tree_nuts',
    dairy: 'dairy',
    milk: 'dairy',
    eggs: 'eggs',
    wheat: 'wheat',
    gluten: 'gluten',
    soy: 'soy',
    fish: 'fish',
    shellfish: 'shellfish',
    shrimp: 'shellfish',
    crab: 'shellfish',
    sesame: 'sesame',
    mustard: 'mustard',
    celery: 'celery',
    sulphites: 'sulphites',
    lupin: 'lupin',
    mollusks: 'mollusks'
};

// ============ DIET PATTERN CONFLICTS ============

/**
 * Defines which food dietary categories conflict with client diet patterns
 * RED blocking rules
 */
export const DIET_CONFLICTS: Record<string, string[]> = {
    vegan: ['non_veg', 'vegetarian', 'veg_with_egg'],
    vegetarian: ['non_veg'],
    vegetarian_with_egg: ['non_veg'],
    pescatarian: ['non_veg'], // Fish is allowed, other meat is not
    jain: ['non_veg', 'veg_with_egg'] // Also blocks root vegetables (handled separately)
};

// ============ INTOLERANCE MAPPING ============

/**
 * Maps client intolerances to food allergen flags or nutrition tags
 * Used for RED blocking (similar to allergies)
 */
export const INTOLERANCE_MAPPING: Record<string, string[]> = {
    lactose: ['dairy'],
    gluten: ['wheat', 'gluten'],
    fructose: ['high_sugar'],
    histamine: ['fermented', 'aged_cheese'],
    caffeine: ['coffee', 'tea', 'chocolate']
};

// ============ MEDICAL FLAG MAPPING ============

/**
 * Maps client medical conditions to food health flags
 * Used for YELLOW warnings
 */
export const MEDICAL_FLAG_MAPPING: Record<string, string[]> = {
    // Manual conditions (from client creation)
    diabetes: ['diabetic_caution', 'high_sugar'],
    pre_diabetes: ['diabetic_caution', 'high_sugar'],
    heart_disease: ['heart_caution', 'high_saturated_fat', 'high_sodium'],
    heart_pain: ['heart_caution', 'high_saturated_fat'],
    high_cholesterol: ['cholesterol_caution', 'heart_caution'],
    hypertension: ['high_sodium'],
    kidney_disease: ['kidney_caution', 'high_protein', 'high_sodium'],
    kidney_issues: ['kidney_caution', 'high_protein'],
    pcos: ['diabetic_caution', 'high_sugar'],
    thyroid: ['iodine_caution'],
    obesity: ['diabetic_caution', 'high_fat'],
    anemia: [], // Positive matching for iron-rich foods

    // Lab-derived conditions (auto-generated from lab values)
    diabetic: ['diabetic_caution', 'high_sugar', 'high_carb'],
    pre_diabetic: ['diabetic_caution', 'high_sugar'],
    borderline_cholesterol: ['cholesterol_caution'],
    high_triglycerides: ['heart_caution', 'high_fat'],
    low_hdl: ['heart_caution'],
    hypothyroid: ['iodine_caution'],
    hyperthyroid: [],
    iron_deficiency: [], // Positive match for iron-rich foods
    b12_deficiency: [],  // Positive match for B12-rich foods
    vitamin_d_deficiency: [], // Positive match for Vit D foods
    severe_vitamin_d_deficiency: [],
    kidney_caution: ['kidney_caution', 'high_protein', 'high_sodium'],
    high_uric_acid: ['kidney_caution', 'high_protein'],
    calcium_deficiency: [],
};

// ============ NUTRITION THRESHOLDS ============

/**
 * Thresholds for auto-tagging nutrition tags based on per-serving values
 */
export const NUTRITION_THRESHOLDS = {
    high_sugar: 15, // grams per serving
    very_high_sugar: 25,
    high_protein: 20, // grams per serving
    very_high_protein: 30,
    low_carb: 10, // grams per serving
    high_carb: 50,
    high_fat: 20, // grams per serving
    high_saturated_fat: 5,
    high_sodium: 600, // mg per serving
    very_high_sodium: 1000,
    high_fiber: 5, // grams per serving
    low_calorie: 50, // kcal per serving
    high_calorie: 400
};

// ============ HEALTH FLAG THRESHOLDS ============

/**
 * Thresholds for auto-generating health flags
 */
export const HEALTH_FLAG_THRESHOLDS = {
    diabetic_caution: {
        sugarG: 20,
        carbsG: 60
    },
    heart_caution: {
        sodiumMg: 600,
        saturatedFatG: 5
    },
    kidney_caution: {
        proteinG: 30,
        sodiumMg: 800
    }
};

// ============ PROCESSING LEVEL CLASSIFICATION ============

/**
 * Keywords for classifying food processing levels
 */
export const PROCESSING_KEYWORDS = {
    raw: ['raw', 'fresh', 'unprocessed'],
    minimally_processed: ['boiled', 'steamed', 'grilled', 'baked', 'roasted'],
    processed: ['canned', 'packaged', 'preserved', 'smoked'],
    ultra_processed: ['fried', 'deep_fried', 'instant', 'ready_to_eat', 'frozen_meal']
};

// ============ MEAL SUITABILITY RULES ============

/**
 * Maps meal suitability tags to meal types they conflict with
 */
export const MEAL_SUITABILITY_CONFLICTS: Record<string, string[]> = {
    too_heavy_for_night: ['dinner'],
    too_heavy_for_breakfast: ['breakfast'],
    too_light_for_lunch: ['lunch'],
    avoid_before_workout: ['pre_workout'],
    avoid_after_workout: ['post_workout']
};

// ============ CATEGORY MAPPING ============

/**
 * Maps avoidCategory values to what they should match against
 */
export const CATEGORY_MAPPING: Record<string, {
    processingLevels?: string[];
    categories?: string[];
    cuisineTags?: string[];
}> = {
    fried_foods: {
        processingLevels: ['fried', 'ultra_processed'],
        categories: ['Fried']
    },
    processed_foods: {
        processingLevels: ['processed', 'ultra_processed']
    },
    ultra_processed: {
        processingLevels: ['ultra_processed']
    },
    red_meat: {
        categories: ['Meat'],
        cuisineTags: ['mutton', 'beef', 'pork', 'lamb']
    },
    sweets: {
        categories: ['Sweets', 'Desserts']
    },
    fast_food: {
        cuisineTags: ['fast_food']
    },
    canned_foods: {
        processingLevels: ['processed', 'canned']
    },
    sugary_drinks: {
        categories: ['Beverages'],
        cuisineTags: ['sugary']
    }
};

// ============ INDIAN-SPECIFIC RESTRICTIONS ============

/**
 * Common Indian dietary restrictions
 */
export const INDIAN_RESTRICTIONS = {
    jain_vegetables: [
        'onion', 'garlic', 'potato', 'carrot', 'radish', 'beetroot',
        'ginger', 'turmeric', 'leek', 'scallion'
    ],
    sattvic_avoid: [
        'onion', 'garlic', 'mushroom', 'eggs', 'meat', 'fish',
        'alcohol', 'caffeine'
    ],
    navratri_avoid: [
        'grains', 'regular_salt', 'onion', 'garlic', 'non_veg'
    ]
};

// ============ HELPER FUNCTIONS ============

/**
 * Get allergen flag from client allergy name
 */
export function getAllergenFlag(allergen: string): string | undefined {
    return ALLERGEN_MAPPING[allergen.toLowerCase()];
}

/**
 * Check if diet pattern conflicts with food category
 */
export function hasDietConflict(dietPattern: string, foodCategory: string): boolean {
    const conflicts = DIET_CONFLICTS[dietPattern.toLowerCase()];
    if (!conflicts) return false;
    return conflicts.includes(foodCategory.toLowerCase());
}

/**
 * Get health flags that should trigger for a medical condition
 */
export function getMedicalFlags(condition: string): string[] {
    return MEDICAL_FLAG_MAPPING[condition.toLowerCase()] || [];
}

/**
 * Check if a food should be flagged for a category avoidance
 */
export function matchesCategoryAvoidance(
    categoryToAvoid: string,
    food: {
        category?: string;
        processingLevel?: string;
        cuisineTags?: string[];
    }
): boolean {
    const mapping = CATEGORY_MAPPING[categoryToAvoid.toLowerCase()];
    if (!mapping) return false;

    // Check processing levels
    if (mapping.processingLevels && food.processingLevel) {
        if (mapping.processingLevels.includes(food.processingLevel.toLowerCase())) {
            return true;
        }
    }

    // Check categories
    if (mapping.categories && food.category) {
        if (mapping.categories.some(cat =>
            food.category?.toLowerCase().includes(cat.toLowerCase())
        )) {
            return true;
        }
    }

    // Check cuisine tags
    if (mapping.cuisineTags && food.cuisineTags) {
        if (food.cuisineTags.some(tag =>
            mapping.cuisineTags?.includes(tag.toLowerCase())
        )) {
            return true;
        }
    }

    return false;
}
</file>

<file path="backend/tests/validationEngine.test.ts">
/**
 * Validation Engine Tests
 * Tests for the diet validation engine
 * 
 * Run with: npx tsx tests/validationEngine.test.ts
 */

import { ValidationEngine } from '../src/services/validationEngine.service';
import { ValidationSeverity, ClientTags, FoodTags, FoodRestriction, PlanTargets, ValidationAlert } from '../src/types/validation.types';

// ============ TEST DATA ============

const createClientTags = (overrides: Partial<ClientTags> = {}): ClientTags => ({
    allergies: new Set(),
    intolerances: new Set(),
    dietPattern: null,
    eggAllowed: true,
    eggAvoidDays: new Set(),
    foodRestrictions: [],
    dislikes: new Set(),
    avoidCategories: new Set(),
    medicalConditions: new Set(),
    labDerivedTags: new Set(),
    likedFoods: new Set(),
    preferredCuisines: new Set(),
    ...overrides
});

const createFoodTags = (name: string, overrides: Partial<FoodTags> = {}): FoodTags => ({
    id: `food_${name.toLowerCase().replace(/\s+/g, '_')}`,
    name,
    allergenFlags: new Set(),
    dietaryCategory: null,
    nutritionTags: new Set(),
    healthFlags: new Set(),
    cuisineTags: new Set(),
    processingLevel: null,
    mealSuitabilityTags: new Set(),
    ...overrides
});

// ============ MOCK VALIDATION ENGINE ============

// Create a testable version that doesn't hit DB
class TestableValidationEngine extends ValidationEngine {
    private testClientTags: ClientTags | null = null;
    private testFoodTags: FoodTags | null = null;
    private testPlanTargets: PlanTargets | null = null;
    private testRepetitionCount: number = 0;

    setTestClientTags(tags: ClientTags) {
        this.testClientTags = tags;
    }

    setTestFoodTags(tags: FoodTags) {
        this.testFoodTags = tags;
    }

    setTestPlanTargets(targets: PlanTargets) {
        this.testPlanTargets = targets;
    }

    setTestRepetitionCount(count: number) {
        this.testRepetitionCount = count;
    }

    // Override to use test data instead of DB
    protected async getClientTags(clientId: string): Promise<ClientTags | null> {
        return this.testClientTags;
    }

    protected async getFoodTags(foodId: string): Promise<FoodTags | null> {
        return this.testFoodTags;
    }

    protected async getPlanTargets(planId: string): Promise<PlanTargets | null> {
        return this.testPlanTargets;
    }

    protected async getPlanFoodCounts(planId: string): Promise<Map<string, number>> {
        const counts = new Map<string, number>();
        if (this.testFoodTags && this.testRepetitionCount > 0) {
            counts.set(this.testFoodTags.id, this.testRepetitionCount);
        }
        return counts;
    }

    protected async checkRepetition(foodId: string, planId: string): Promise<ValidationAlert | null> {
        if (this.testRepetitionCount >= 3) {
            return {
                type: 'repetition',
                severity: ValidationSeverity.YELLOW,
                message: `🟡 REPETITION: This food appears ${this.testRepetitionCount} times this week. Consider variety.`,
                recommendation: 'Try different foods for nutritional variety',
                icon: 'repeat'
            };
        }
        return null;
    }
}

// ============ TESTS ============

let passed = 0;
let failed = 0;

async function test(name: string, fn: () => Promise<void>) {
    try {
        await fn();
        console.log(`✅ PASS: ${name}`);
        passed++;
    } catch (error) {
        console.log(`❌ FAIL: ${name}`);
        console.log(`   Error: ${error instanceof Error ? error.message : error}`);
        failed++;
    }
}

function assert(condition: boolean, message: string) {
    if (!condition) {
        throw new Error(message);
    }
}

function assertEqual<T>(actual: T, expected: T, message?: string) {
    if (actual !== expected) {
        throw new Error(message || `Expected ${expected}, got ${actual}`);
    }
}

// ============ RUN TESTS ============

async function runTests() {
    console.log('\n🧪 Running Validation Engine Tests\n');
    console.log('='.repeat(50));

    // Test 1: Allergy Blocking (RED)
    await test('Allergy to peanuts blocks peanut food', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            allergies: new Set(['peanuts'])
        }));

        engine.setTestFoodTags(createFoodTags('Peanut Butter', {
            allergenFlags: new Set(['peanuts'])
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'breakfast'
        });

        assertEqual(result.severity, ValidationSeverity.RED, 'Should be RED severity');
        assertEqual(result.canAdd, false, 'Should not allow adding');
        assert(result.alerts.length > 0, 'Should have alerts');
        assertEqual(result.alerts[0].type, 'allergy', 'Should be allergy alert');
    });

    // Test 2: Intolerance Blocking (RED)
    await test('Lactose intolerance blocks dairy food', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            intolerances: new Set(['lactose'])
        }));

        engine.setTestFoodTags(createFoodTags('Milk', {
            allergenFlags: new Set(['lactose', 'milk'])
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'breakfast'
        });

        assertEqual(result.severity, ValidationSeverity.RED, 'Should be RED severity');
        assertEqual(result.canAdd, false, 'Should not allow adding');
        assertEqual(result.alerts[0].type, 'intolerance', 'Should be intolerance alert');
    });

    // Test 3: Diet Pattern - Vegetarian blocking non-veg (RED)
    await test('Vegetarian client cannot eat non-veg food', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            dietPattern: 'vegetarian'
        }));

        engine.setTestFoodTags(createFoodTags('Chicken Curry', {
            dietaryCategory: 'non_veg'
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'lunch'
        });

        assertEqual(result.severity, ValidationSeverity.RED, 'Should be RED severity');
        assertEqual(result.canAdd, false, 'Should not allow adding');
        assertEqual(result.alerts[0].type, 'diet_pattern', 'Should be diet_pattern alert');
    });

    // Test 4: Day Restriction - Egg on Tuesday (RED)
    await test('Egg avoid days blocks eggs on specific day', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            eggAvoidDays: new Set(['tuesday', 'thursday'])
        }));

        engine.setTestFoodTags(createFoodTags('Egg Omelette', {
            allergenFlags: new Set(['eggs'])
        }));

        // Test on Tuesday - should block
        const resultTuesday = await engine.validate('client1', 'food1', {
            currentDay: 'tuesday',
            mealType: 'breakfast'
        });

        assertEqual(resultTuesday.severity, ValidationSeverity.RED, 'Should be RED on Tuesday');
        assertEqual(resultTuesday.canAdd, false, 'Should not allow adding on Tuesday');
    });

    // Test 5: Day Restriction - Egg on Saturday (ALLOWED)
    await test('Egg avoid days allows eggs on other days', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            eggAvoidDays: new Set(['tuesday', 'thursday'])
        }));

        engine.setTestFoodTags(createFoodTags('Egg Omelette', {
            allergenFlags: new Set(['eggs'])
        }));

        // Test on Saturday - should allow
        const resultSaturday = await engine.validate('client1', 'food1', {
            currentDay: 'saturday',
            mealType: 'breakfast'
        });

        assertEqual(resultSaturday.canAdd, true, 'Should allow adding on Saturday');
        assert(resultSaturday.severity !== ValidationSeverity.RED, 'Should not be RED on Saturday');
    });

    // Test 6: Medical Condition Warning (YELLOW)
    await test('Pre-diabetes warns about high sugar food', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            medicalConditions: new Set(['pre_diabetes'])
        }));

        engine.setTestFoodTags(createFoodTags('Chocolate Cake', {
            nutritionTags: new Set(['high_sugar', 'high_calorie'])
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'snack'
        });

        assertEqual(result.severity, ValidationSeverity.YELLOW, 'Should be YELLOW severity');
        assertEqual(result.canAdd, true, 'Should allow adding with warning');
        assert(result.alerts.some(a => a.type === 'medical'), 'Should have medical alert');
    });

    // Test 7: Lab-derived Warning (YELLOW)
    await test('High cholesterol warns about cholesterol food', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            labDerivedTags: new Set(['high_cholesterol'])
        }));

        engine.setTestFoodTags(createFoodTags('Fried Egg', {
            healthFlags: new Set(['cholesterol_caution'])
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'breakfast'
        });

        assertEqual(result.severity, ValidationSeverity.YELLOW, 'Should be YELLOW severity');
        assertEqual(result.canAdd, true, 'Should allow adding with warning');
        assert(result.alerts.some(a => a.type === 'lab_derived'), 'Should have lab_derived alert');
    });

    // Test 8: Dislike Warning (YELLOW)
    await test('Disliked food shows warning', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            dislikes: new Set(['bitter gourd'])
        }));

        engine.setTestFoodTags(createFoodTags('Bitter Gourd', {}));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'lunch'
        });

        assertEqual(result.severity, ValidationSeverity.YELLOW, 'Should be YELLOW severity');
        assertEqual(result.canAdd, true, 'Should allow adding with warning');
        assert(result.alerts.some(a => a.type === 'dislike'), 'Should have dislike alert');
    });

    // Test 9: Liked Food Positive (GREEN)
    await test('Liked food shows positive indicator', async () => {
        const engine = new TestableValidationEngine();

        const foodId = 'food_egg_roll';
        engine.setTestClientTags(createClientTags({
            likedFoods: new Set([foodId])
        }));

        engine.setTestFoodTags(createFoodTags('Egg Roll', { id: foodId }));

        const result = await engine.validate('client1', foodId, {
            currentDay: 'monday',
            mealType: 'lunch'
        });

        assertEqual(result.severity, ValidationSeverity.GREEN, 'Should be GREEN severity');
        assertEqual(result.canAdd, true, 'Should allow adding');
        assert(result.alerts.some(a => a.type === 'preference_match'), 'Should have preference_match alert');
    });

    // Test 10: Preferred Cuisine Positive (GREEN)
    await test('Preferred cuisine shows positive indicator', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            preferredCuisines: new Set(['indian', 'mughlai'])
        }));

        engine.setTestFoodTags(createFoodTags('Dal Makhani', {
            cuisineTags: new Set(['indian', 'punjabi'])
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'dinner'
        });

        assertEqual(result.severity, ValidationSeverity.GREEN, 'Should be GREEN severity');
        assertEqual(result.canAdd, true, 'Should allow adding');
        assert(result.alerts.some(a => a.type === 'cuisine_match'), 'Should have cuisine_match alert');
    });

    // Test 11: No restrictions - clean pass (GREEN)
    await test('No restrictions allows food with GREEN', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({}));
        engine.setTestFoodTags(createFoodTags('Brown Rice', {}));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'lunch'
        });

        assertEqual(result.severity, ValidationSeverity.GREEN, 'Should be GREEN severity');
        assertEqual(result.canAdd, true, 'Should allow adding');
        assertEqual(result.borderColor, 'green', 'Border should be green');
    });

    // Test 12: Multiple alerts combination
    await test('Multiple warnings combine correctly', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            medicalConditions: new Set(['pre_diabetes', 'heart_pain']),
            preferredCuisines: new Set(['indian'])
        }));

        engine.setTestFoodTags(createFoodTags('Sweet Kheer', {
            nutritionTags: new Set(['high_sugar']),
            healthFlags: new Set(['cholesterol_caution']),
            cuisineTags: new Set(['indian'])
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'dessert' as any
        });

        assertEqual(result.severity, ValidationSeverity.YELLOW, 'Should be YELLOW (worst of warnings)');
        assertEqual(result.canAdd, true, 'Should still allow adding');
        assert(result.alerts.length >= 2, 'Should have multiple alerts');
    });

    // Test 13: Vegan blocks vegetarian food
    await test('Vegan client blocks vegetarian (non-vegan) food', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({
            dietPattern: 'vegan'
        }));

        engine.setTestFoodTags(createFoodTags('Paneer Tikka', {
            dietaryCategory: 'vegetarian'
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'dinner'
        });

        assertEqual(result.severity, ValidationSeverity.RED, 'Should be RED (vegan cannot eat vegetarian)');
        assertEqual(result.canAdd, false, 'Should not allow adding');
    });

    // ============ FOOD RESTRICTIONS TESTS ============

    // Test 14: Non-veg restricted on Tuesday (RED)
    await test('Non-veg restriction on Tuesday blocks chicken', async () => {
        const engine = new TestableValidationEngine();

        const restriction: FoodRestriction = {
            foodCategory: 'non_veg',
            restrictionType: 'day_based',
            avoidDays: ['tuesday', 'thursday'],
            severity: 'strict',
            reason: 'religious_fasting'
        };

        engine.setTestClientTags(createClientTags({
            foodRestrictions: [restriction]
        }));

        engine.setTestFoodTags(createFoodTags('Chicken Curry', {
            dietaryCategory: 'non_veg'
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'tuesday',
            mealType: 'lunch'
        });

        assertEqual(result.severity, ValidationSeverity.RED, 'Should be RED on restriction day');
        assertEqual(result.canAdd, false, 'Should not allow adding');
        assert(result.alerts.some(a => a.type === 'food_restriction'), 'Should have food_restriction alert');
    });

    // Test 15: Non-veg allowed on Wednesday (no restriction)
    await test('Non-veg restriction allows chicken on unrestricted day', async () => {
        const engine = new TestableValidationEngine();

        const restriction: FoodRestriction = {
            foodCategory: 'non_veg',
            restrictionType: 'day_based',
            avoidDays: ['tuesday', 'thursday'],
            severity: 'strict',
            reason: 'religious_fasting'
        };

        engine.setTestClientTags(createClientTags({
            foodRestrictions: [restriction]
        }));

        engine.setTestFoodTags(createFoodTags('Chicken Curry', {
            dietaryCategory: 'non_veg'
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'wednesday',
            mealType: 'lunch'
        });

        assertEqual(result.canAdd, true, 'Should allow adding on Wednesday');
        assert(result.severity !== ValidationSeverity.RED, 'Should not be RED on Wednesday');
    });

    // Test 16: Non-veg restricted BUT eggs excluded (eggs should be allowed)
    await test('Non-veg restriction with excludes allows eggs on restricted day', async () => {
        const engine = new TestableValidationEngine();

        const restriction: FoodRestriction = {
            foodCategory: 'non_veg',
            restrictionType: 'day_based',
            avoidDays: ['tuesday', 'thursday'],
            excludes: ['eggs'],  // Eggs are allowed even on restriction days
            severity: 'strict',
            reason: 'religious_fasting'
        };

        engine.setTestClientTags(createClientTags({
            foodRestrictions: [restriction]
        }));

        engine.setTestFoodTags(createFoodTags('Egg Omelette', {
            dietaryCategory: 'non_veg',
            allergenFlags: new Set(['eggs'])
        }));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'tuesday',
            mealType: 'breakfast'
        });

        assertEqual(result.canAdd, true, 'Should allow eggs even on Tuesday');
        assert(result.severity !== ValidationSeverity.RED, 'Should not be blocked');
    });

    // Test 17: Always restriction blocks food on any day
    await test('Always restriction blocks food on any day', async () => {
        const engine = new TestableValidationEngine();

        const restriction: FoodRestriction = {
            foodCategory: 'root_vegetables',
            restrictionType: 'always',
            includes: ['onion', 'garlic'],
            severity: 'strict',
            reason: 'jain_diet'
        };

        engine.setTestClientTags(createClientTags({
            foodRestrictions: [restriction]
        }));

        engine.setTestFoodTags(createFoodTags('Onion Rings', {}));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'wednesday',
            mealType: 'snack'
        });

        assertEqual(result.severity, ValidationSeverity.RED, 'Should be blocked always');
        assertEqual(result.canAdd, false, 'Should not allow adding');
    });

    // Test 18: Flexible restriction shows warning (YELLOW)
    await test('Flexible restriction shows warning not block', async () => {
        const engine = new TestableValidationEngine();

        const restriction: FoodRestriction = {
            foodName: 'rice',
            restrictionType: 'quantity',
            maxGramsPerMeal: 100,
            severity: 'flexible',  // YELLOW not RED
            reason: 'diabetes_management'
        };

        engine.setTestClientTags(createClientTags({
            foodRestrictions: [restriction]
        }));

        engine.setTestFoodTags(createFoodTags('White Rice', {}));

        const result = await engine.validate('client1', 'food1', {
            currentDay: 'monday',
            mealType: 'lunch'
        });

        assertEqual(result.severity, ValidationSeverity.YELLOW, 'Should be YELLOW for flexible restriction');
        assertEqual(result.canAdd, true, 'Should allow adding with warning');
        assert(result.alerts.some(a => a.type === 'food_restriction'), 'Should have food_restriction alert');
    });

    // ============ REPETITION TESTS ============

    // Test 19: Repetition check triggers YELLOW when threshold exceeded
    await test('Repetition check triggers YELLOW when food appears 4 times', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({}));
        engine.setTestFoodTags(createFoodTags('White Rice', { id: 'food_white_rice' }));
        engine.setTestRepetitionCount(4);

        const result = await engine.validate('client1', 'food_white_rice', {
            currentDay: 'monday',
            mealType: 'lunch',
            planId: 'plan_123'
        });

        assertEqual(result.canAdd, true, 'Should allow adding with warning');
        assert(result.alerts.some(a => a.type === 'repetition'), 'Should have repetition alert');
        assert(result.alerts.some(a => a.severity === ValidationSeverity.YELLOW), 'Repetition alert should be YELLOW');
    });

    // Test 20: Repetition check does NOT trigger when under threshold
    await test('Repetition check does not trigger when food appears 2 times', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({}));
        engine.setTestFoodTags(createFoodTags('Brown Rice', { id: 'food_brown_rice' }));
        engine.setTestRepetitionCount(2);

        const result = await engine.validate('client1', 'food_brown_rice', {
            currentDay: 'monday',
            mealType: 'lunch',
            planId: 'plan_123'
        });

        assert(!result.alerts.some(a => a.type === 'repetition'), 'Should NOT have repetition alert');
    });

    // Test 21: No repetition check without planId
    await test('Repetition check skipped without planId', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({}));
        engine.setTestFoodTags(createFoodTags('White Rice', { id: 'food_white_rice' }));
        engine.setTestRepetitionCount(10);

        const result = await engine.validate('client1', 'food_white_rice', {
            currentDay: 'monday',
            mealType: 'lunch'
            // No planId
        });

        assert(!result.alerts.some(a => a.type === 'repetition'), 'Should NOT have repetition alert without planId');
    });

    // ============ NUTRITION STRENGTH TESTS ============

    // Test 22: Nutrition strength triggers YELLOW when food exceeds calorie threshold
    await test('Nutrition strength triggers YELLOW for high calorie food', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({}));
        engine.setTestFoodTags(createFoodTags('Biryani', {
            id: 'food_biryani',
            calories: 600
        }));
        engine.setTestPlanTargets({
            targetCalories: 1000,
            targetProteinG: null,
            targetCarbsG: null,
            targetFatsG: null
        });

        const result = await engine.validate('client1', 'food_biryani', {
            currentDay: 'monday',
            mealType: 'lunch',
            planId: 'plan_123'
        });

        assertEqual(result.canAdd, true, 'Should allow adding with warning');
        assert(result.alerts.some(a => a.type === 'nutrition_strength'), 'Should have nutrition_strength alert');
        assert(
            result.alerts.some(a => a.message.includes('60%')),
            'Should mention 60% in message'
        );
    });

    // Test 23: Nutrition strength does NOT trigger when under threshold
    await test('Nutrition strength does not trigger for low calorie food', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({}));
        engine.setTestFoodTags(createFoodTags('Salad', {
            id: 'food_salad',
            calories: 200
        }));
        engine.setTestPlanTargets({
            targetCalories: 2000,
            targetProteinG: null,
            targetCarbsG: null,
            targetFatsG: null
        });

        const result = await engine.validate('client1', 'food_salad', {
            currentDay: 'monday',
            mealType: 'lunch',
            planId: 'plan_123'
        });

        assert(!result.alerts.some(a => a.type === 'nutrition_strength'), 'Should NOT have nutrition_strength alert');
    });

    // Test 24: Nutrition strength triggers for high protein
    await test('Nutrition strength triggers YELLOW for high protein food', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({}));
        engine.setTestFoodTags(createFoodTags('Whey Protein Shake', {
            id: 'food_whey',
            calories: 200,
            proteinG: 50
        }));
        engine.setTestPlanTargets({
            targetCalories: 2000,
            targetProteinG: 60,
            targetCarbsG: null,
            targetFatsG: null
        });

        const result = await engine.validate('client1', 'food_whey', {
            currentDay: 'monday',
            mealType: 'snack',
            planId: 'plan_123'
        });

        assert(result.alerts.some(a => a.type === 'nutrition_strength' && a.message.includes('PROTEIN')),
            'Should have nutrition_strength protein alert');
    });

    // Test 25: No nutrition strength check without planId
    await test('Nutrition strength check skipped without planId', async () => {
        const engine = new TestableValidationEngine();

        engine.setTestClientTags(createClientTags({}));
        engine.setTestFoodTags(createFoodTags('Biryani', {
            id: 'food_biryani',
            calories: 600
        }));
        engine.setTestPlanTargets({
            targetCalories: 1000,
            targetProteinG: null,
            targetCarbsG: null,
            targetFatsG: null
        });

        const result = await engine.validate('client1', 'food_biryani', {
            currentDay: 'monday',
            mealType: 'lunch'
            // No planId
        });

        assert(!result.alerts.some(a => a.type === 'nutrition_strength'), 'Should NOT have nutrition_strength alert without planId');
    });

    // ============ SUMMARY ============
    console.log('\n' + '='.repeat(50));
    console.log(`\n📊 Test Results: ${passed} passed, ${failed} failed\n`);

    if (failed > 0) {
        process.exit(1);
    }
}

// Run tests
runTests().catch(console.error);
</file>

<file path="backend/.gitignore">
# Dependencies
node_modules/

# Environment files
.env
.env.local
.env.*.local

# Prisma generated files
/src/generated/prisma

# Build output
dist/
build/

# Logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# OS files
.DS_Store

# Debug
*.pem

# TypeScript
*.tsbuildinfo
</file>

<file path="client-app/app/(auth)/login.tsx">
import { useState } from 'react';
import {
    View,
    Text,
    TextInput,
    TouchableOpacity,
    StyleSheet,
    KeyboardAvoidingView,
    Platform,
    ActivityIndicator,
} from 'react-native';
import { useRouter } from 'expo-router';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Phone } from 'lucide-react-native';
import { useAuth } from '../../hooks/useAuth';
import { useToast } from '../../components/Toast';
import { normalizeError } from '../../utils/errorHandler';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights, CommonStyles } from '../../constants/theme';

export default function LoginScreen() {
    const router = useRouter();
    const { requestOTP } = useAuth();
    const { showToast } = useToast();
    const [phone, setPhone] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const isValidPhone = /^\d{10}$/.test(phone);

    const handleRequestOTP = async () => {
        if (!isValidPhone) {
            showToast({ title: 'Invalid Phone', message: 'Please enter a valid 10-digit phone number', variant: 'warning' });
            return;
        }

        setIsLoading(true);
        try {
            await requestOTP(phone);
            router.push({
                pathname: '/(auth)/verify',
                params: { phone },
            });
        } catch (error: unknown) {
            const appError = normalizeError(error);
            showToast({
                title: appError.title,
                message: appError.message,
                variant: 'error',
                action: appError.isRetryable ? { label: 'Retry', onPress: handleRequestOTP } : undefined,
            });
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <SafeAreaView style={styles.container}>
            <KeyboardAvoidingView
                behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
                style={styles.content}
            >
                <View style={styles.header}>
                    <View style={styles.iconContainer}>
                        <Phone size={32} color={Colors.primary} />
                    </View>
                    <Text style={styles.title}>Welcome to DietConnect</Text>
                    <Text style={styles.subtitle}>
                        Enter your phone number to get started with your personalized diet plan
                    </Text>
                </View>

                <View style={styles.form}>
                    <Text style={styles.label}>Phone Number</Text>
                    <View style={styles.inputContainer}>
                        <Text style={styles.prefix}>+91</Text>
                        <TextInput
                            style={styles.input}
                            value={phone}
                            onChangeText={setPhone}
                            placeholder="9876543210"
                            placeholderTextColor={Colors.textSecondary}
                            keyboardType="phone-pad"
                            maxLength={10}
                            autoFocus
                        />
                    </View>

                    <TouchableOpacity
                        style={[CommonStyles.primaryButton, !isValidPhone && CommonStyles.primaryButtonDisabled]}
                        onPress={handleRequestOTP}
                        disabled={isLoading || !isValidPhone}
                    >
                        {isLoading ? (
                            <ActivityIndicator color={Colors.text} />
                        ) : (
                            <Text style={CommonStyles.primaryButtonText}>Get OTP</Text>
                        )}
                    </TouchableOpacity>
                </View>

                <Text style={styles.footer}>
                    By continuing, you agree to our Terms of Service and Privacy Policy
                </Text>
            </KeyboardAvoidingView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    content: {
        flex: 1,
        padding: Spacing.xxl,
        justifyContent: 'center',
    },
    header: {
        alignItems: 'center',
        marginBottom: 48,
    },
    iconContainer: {
        width: 72,
        height: 72,
        borderRadius: 36,
        backgroundColor: Colors.surfaceSecondary,
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: Spacing.xxl,
    },
    title: {
        fontSize: FontSizes.xxxl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.md,
        textAlign: 'center',
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textSecondary,
        textAlign: 'center',
        lineHeight: 24,
        paddingHorizontal: Spacing.lg,
    },
    form: {
        marginBottom: Spacing.xxxl,
    },
    label: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    inputContainer: {
        flexDirection: 'row',
        alignItems: 'center',
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        backgroundColor: Colors.surface,
        marginBottom: Spacing.xxl,
    },
    prefix: {
        paddingHorizontal: Spacing.lg,
        fontSize: FontSizes.lg,
        color: Colors.text,
        fontWeight: FontWeights.medium,
    },
    input: {
        flex: 1,
        height: 56,
        fontSize: FontSizes.xl,
        color: Colors.text,
        letterSpacing: 1,
    },
    footer: {
        fontSize: FontSizes.xs,
        color: Colors.textSecondary,
        textAlign: 'center',
        lineHeight: 18,
    },
});
</file>

<file path="client-app/app/(auth)/verify.tsx">
import { useState, useRef, useEffect, useCallback } from 'react';
import {
    View,
    Text,
    TextInput,
    TouchableOpacity,
    StyleSheet,
    KeyboardAvoidingView,
    Platform,
    ActivityIndicator,
} from 'react-native';
import { useRouter, useLocalSearchParams } from 'expo-router';
import { SafeAreaView } from 'react-native-safe-area-context';
import { ShieldCheck, ArrowLeft } from 'lucide-react-native';
import { useAuth } from '../../hooks/useAuth';
import { useToast } from '../../components/Toast';
import { normalizeError } from '../../utils/errorHandler';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights, CommonStyles } from '../../constants/theme';

const OTP_LENGTH = 6;
const RESEND_COOLDOWN = 30;

export default function VerifyScreen() {
    const router = useRouter();
    const { phone } = useLocalSearchParams<{ phone: string }>();
    const { login, requestOTP } = useAuth();
    const { showToast } = useToast();
    const [otp, setOtp] = useState<string[]>(Array(OTP_LENGTH).fill(''));
    const [isLoading, setIsLoading] = useState(false);
    const [resendTimer, setResendTimer] = useState(RESEND_COOLDOWN);
    const inputRefs = useRef<(TextInput | null)[]>([]);

    // Resend countdown timer
    useEffect(() => {
        if (resendTimer <= 0) return;
        const timer = setTimeout(() => setResendTimer(resendTimer - 1), 1000);
        return () => clearTimeout(timer);
    }, [resendTimer]);

    const handleOtpChange = (value: string, index: number) => {
        const newOtp = [...otp];
        newOtp[index] = value;
        setOtp(newOtp);

        if (value && index < OTP_LENGTH - 1) {
            inputRefs.current[index + 1]?.focus();
        }

        if (newOtp.every((digit) => digit) && newOtp.join('').length === OTP_LENGTH) {
            handleVerify(newOtp.join(''));
        }
    };

    const handleKeyPress = (e: { nativeEvent: { key: string } }, index: number) => {
        if (e.nativeEvent.key === 'Backspace' && !otp[index] && index > 0) {
            inputRefs.current[index - 1]?.focus();
        }
    };

    const handleVerify = async (otpCode: string) => {
        if (!phone) return;

        setIsLoading(true);
        try {
            await login(phone, otpCode);
            router.replace('/(tabs)/home');
        } catch (error: unknown) {
            const appError = normalizeError(error);
            showToast({ title: appError.title, message: appError.message, variant: 'error' });
            setOtp(Array(OTP_LENGTH).fill(''));
            inputRefs.current[0]?.focus();
        } finally {
            setIsLoading(false);
        }
    };

    const handleResend = useCallback(async () => {
        if (resendTimer > 0 || !phone) return;
        try {
            await requestOTP(phone);
            setResendTimer(RESEND_COOLDOWN);
            showToast({ title: 'OTP Sent', message: 'A new code has been sent to your phone', variant: 'success' });
        } catch (error: unknown) {
            const appError = normalizeError(error);
            showToast({ title: appError.title, message: appError.message, variant: 'error' });
        }
    }, [resendTimer, phone, requestOTP, showToast]);

    return (
        <SafeAreaView style={styles.container}>
            <TouchableOpacity style={styles.backButton} onPress={() => router.back()}>
                <ArrowLeft size={24} color={Colors.text} />
            </TouchableOpacity>

            <KeyboardAvoidingView
                behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
                style={styles.content}
            >
                <View style={styles.header}>
                    <View style={styles.iconContainer}>
                        <ShieldCheck size={32} color={Colors.primary} />
                    </View>
                    <Text style={styles.title}>Verify OTP</Text>
                    <Text style={styles.subtitle}>
                        Enter the 6-digit code sent to{'\n'}
                        <Text style={styles.phone}>+91 {phone}</Text>
                    </Text>
                </View>

                <View style={styles.otpContainer}>
                    {otp.map((digit, index) => (
                        <TextInput
                            key={index}
                            ref={(ref) => { inputRefs.current[index] = ref; }}
                            style={[styles.otpInput, digit && styles.otpInputFilled]}
                            value={digit}
                            onChangeText={(value) => handleOtpChange(value.slice(-1), index)}
                            onKeyPress={(e) => handleKeyPress(e, index)}
                            keyboardType="number-pad"
                            maxLength={1}
                            selectTextOnFocus
                        />
                    ))}
                </View>

                <TouchableOpacity
                    style={[CommonStyles.primaryButton, otp.some((d) => !d) && CommonStyles.primaryButtonDisabled]}
                    onPress={() => handleVerify(otp.join(''))}
                    disabled={isLoading || otp.some((d) => !d)}
                >
                    {isLoading ? (
                        <ActivityIndicator color={Colors.text} />
                    ) : (
                        <Text style={CommonStyles.primaryButtonText}>Verify & Continue</Text>
                    )}
                </TouchableOpacity>

                <TouchableOpacity
                    style={styles.resendButton}
                    onPress={handleResend}
                    disabled={resendTimer > 0}
                >
                    <Text style={styles.resendText}>
                        {resendTimer > 0
                            ? `Resend code in ${resendTimer}s`
                            : "Didn't receive code? "}
                        {resendTimer <= 0 && <Text style={styles.resendLink}>Resend</Text>}
                    </Text>
                </TouchableOpacity>
            </KeyboardAvoidingView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    backButton: {
        padding: Spacing.lg,
    },
    content: {
        flex: 1,
        padding: Spacing.xxl,
        justifyContent: 'center',
    },
    header: {
        alignItems: 'center',
        marginBottom: 48,
    },
    iconContainer: {
        width: 72,
        height: 72,
        borderRadius: 36,
        backgroundColor: Colors.surfaceSecondary,
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: Spacing.xxl,
    },
    title: {
        fontSize: FontSizes.xxxl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.md,
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textSecondary,
        textAlign: 'center',
        lineHeight: 24,
    },
    phone: {
        color: Colors.text,
        fontWeight: FontWeights.semibold,
    },
    otpContainer: {
        flexDirection: 'row',
        justifyContent: 'center',
        gap: Spacing.md,
        marginBottom: Spacing.xxxl,
    },
    otpInput: {
        width: 48,
        height: 56,
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        backgroundColor: Colors.surface,
        fontSize: 24,
        fontWeight: FontWeights.bold,
        textAlign: 'center',
        color: Colors.text,
    },
    otpInputFilled: {
        borderColor: Colors.primary,
        backgroundColor: Colors.surfaceSecondary,
    },
    resendButton: {
        marginTop: Spacing.xxl,
        alignItems: 'center',
    },
    resendText: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
    },
    resendLink: {
        color: Colors.primary,
        fontWeight: FontWeights.semibold,
    },
});
</file>

<file path="client-app/app/(onboarding)/_layout.tsx">
import { View, Text, StyleSheet } from 'react-native';
import { Stack } from 'expo-router';
import { Colors, Spacing, FontSizes, FontWeights } from '../../constants/theme';

const TOTAL_STEPS = 6;

function ProgressHeader({ step }: { step: number }) {
    return (
        <View style={styles.progressContainer}>
            <Text style={styles.stepLabel}>Step {step} of {TOTAL_STEPS}</Text>
            <View style={styles.progressBar}>
                <View style={[styles.progressFill, { width: `${(step / TOTAL_STEPS) * 100}%` }]} />
            </View>
        </View>
    );
}

export default function OnboardingLayout() {
    return (
        <Stack
            screenOptions={{
                headerStyle: { backgroundColor: Colors.surface },
                headerTintColor: Colors.text,
                headerShadowVisible: false,
            }}
        >
            <Stack.Screen
                name="step1"
                options={{
                    title: 'Basic Info',
                    headerBackVisible: false,
                    headerTitle: () => <ProgressHeader step={1} />,
                }}
            />
            <Stack.Screen
                name="step2"
                options={{
                    title: 'Diet Pattern',
                    headerTitle: () => <ProgressHeader step={2} />,
                }}
            />
            <Stack.Screen
                name="step3"
                options={{
                    title: 'Allergies',
                    headerTitle: () => <ProgressHeader step={3} />,
                }}
            />
            <Stack.Screen
                name="step4"
                options={{
                    title: 'Restrictions',
                    headerTitle: () => <ProgressHeader step={4} />,
                }}
            />
            <Stack.Screen
                name="step5"
                options={{
                    title: 'Preferences',
                    headerTitle: () => <ProgressHeader step={5} />,
                }}
            />
            <Stack.Screen
                name="step6"
                options={{
                    title: 'Measurements',
                    headerTitle: () => <ProgressHeader step={6} />,
                }}
            />
            <Stack.Screen
                name="complete"
                options={{
                    title: 'Complete',
                    headerShown: false,
                }}
            />
        </Stack>
    );
}

const styles = StyleSheet.create({
    progressContainer: {
        alignItems: 'center',
        flex: 1,
    },
    stepLabel: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
        fontWeight: FontWeights.medium,
        marginBottom: Spacing.xs,
    },
    progressBar: {
        width: '100%',
        height: 4,
        backgroundColor: Colors.borderLight,
        borderRadius: 2,
        overflow: 'hidden',
    },
    progressFill: {
        height: '100%',
        backgroundColor: Colors.primaryDark,
        borderRadius: 2,
    },
});
</file>

<file path="client-app/app/(tabs)/home/meal/[id].tsx">
import { useState, useEffect } from 'react';
import {
    View,
    Text,
    StyleSheet,
    ScrollView,
    TouchableOpacity,
    TextInput,
    Image,
    ActivityIndicator,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useLocalSearchParams, useRouter } from 'expo-router';
import * as ImagePicker from 'expo-image-picker';
import { X, Camera, Image as ImageIcon, Clock, MessageSquare, CheckCircle, User, Circle, CheckCircle2 } from 'lucide-react-native';
import { useMealLog, useLogMeal } from '../../../../hooks/useMealLog';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights, CommonStyles } from '../../../../constants/theme';
import { useToast } from '../../../../components/Toast';
import { normalizeError } from '../../../../utils/errorHandler';
import { LoadingScreen } from '../../../../components/LoadingScreen';
import { MealOption } from '../../../../types';

const mealTypes = ['Breakfast', 'Lunch', 'Dinner', 'Snack', 'Substituted'] as const;

export default function MealDetailScreen() {
    const { id, status: paramStatus, mealName, mealType, scheduledTime, feedback } = useLocalSearchParams<{
        id: string;
        status?: string;
        mealName?: string;
        mealType?: string;
        scheduledTime?: string;
        feedback?: string;
    }>();
    const router = useRouter();
    const { showToast } = useToast();

    const isPendingMeal = id?.startsWith('pending-');
    const isLoggedMeal = paramStatus === 'eaten' || paramStatus === 'skipped';

    const { data: mealLog, isLoading } = useMealLog(id ?? '');
    const logMutation = useLogMeal();

    const [selectedMealType, setSelectedMealType] = useState<string>('');
    const [notes, setNotes] = useState('');
    const [photoUri, setPhotoUri] = useState<string | null>(null);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [selectedOption, setSelectedOption] = useState<number>(0);

    const hasAlternatives = mealLog?.meal?.hasAlternatives ?? false;
    const mealOptions: MealOption[] = mealLog?.meal?.options ?? [];

    useEffect(() => {
        if (mealLog?.meal?.mealType) {
            setSelectedMealType(mealLog.meal.mealType.charAt(0).toUpperCase() + mealLog.meal.mealType.slice(1));
        } else if (mealType) {
            setSelectedMealType(mealType.charAt(0).toUpperCase() + mealType.slice(1));
        }
    }, [mealLog, mealType]);

    const handleClose = () => {
        router.back();
    };

    const handleTakePhoto = async () => {
        const { status } = await ImagePicker.requestCameraPermissionsAsync();
        if (status !== 'granted') {
            showToast({ title: 'Permission Required', message: 'Camera permission is needed to take photos.', variant: 'warning' });
            return;
        }

        const result = await ImagePicker.launchCameraAsync({
            mediaTypes: 'images',
            allowsEditing: true,
            aspect: [3, 2],
            quality: 0.8,
        });

        if (!result.canceled && result.assets[0]) {
            setPhotoUri(result.assets[0].uri);
        }
    };

    const handlePickImage = async () => {
        const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
        if (status !== 'granted') {
            showToast({ title: 'Permission Required', message: 'Photo library access is needed to select photos.', variant: 'warning' });
            return;
        }

        const result = await ImagePicker.launchImageLibraryAsync({
            mediaTypes: 'images',
            allowsEditing: true,
            aspect: [3, 2],
            quality: 0.8,
        });

        if (!result.canceled && result.assets[0]) {
            setPhotoUri(result.assets[0].uri);
        }
    };

    const handleSubmit = async () => {
        if (!id) return;

        setIsSubmitting(true);
        try {
            await logMutation.mutateAsync({
                mealLogId: id,
                status: 'eaten',
                notes: notes || undefined,
                photoUri: photoUri || undefined,
                chosenOptionGroup: hasAlternatives ? selectedOption : undefined,
            });
            showToast({ title: 'Success', message: 'Meal logged successfully!', variant: 'success' });
            router.back();
        } catch (error) {
            console.error('Log meal error:', error);
            const appError = normalizeError(error);
            showToast({ title: appError.title, message: appError.message, variant: 'error' });
        } finally {
            setIsSubmitting(false);
        }
    };

    if (!isPendingMeal && isLoading) {
        return <LoadingScreen />;
    }

    const currentMealLog = mealLog;
    const dietitianFeedback = currentMealLog?.dietitianFeedback || feedback;
    const mealPhoto = currentMealLog?.mealPhotoUrl;
    const clientNotes = currentMealLog?.clientNotes;
    const displayMealName = currentMealLog?.meal?.name || mealName || 'Meal';
    const displayMealType = currentMealLog?.meal?.mealType || mealType || 'meal';
    const displayTime = currentMealLog?.scheduledTime || scheduledTime;

    if (!isPendingMeal && (currentMealLog?.status === 'eaten' || currentMealLog?.status === 'skipped' || isLoggedMeal)) {
        return (
            <SafeAreaView style={styles.container} edges={['top']}>
                {/* Header */}
                <View style={styles.header}>
                    <TouchableOpacity style={styles.closeButton} onPress={handleClose}>
                        <X size={24} color={Colors.text} />
                    </TouchableOpacity>
                    <Text style={styles.headerTitle}>Meal Details</Text>
                    <View style={styles.headerSpacer} />
                </View>

                <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
                    {/* Meal Photo or Status Icon */}
                    <View style={styles.photoSection}>
                        {mealPhoto ? (
                            <Image source={{ uri: mealPhoto }} style={styles.mealPhoto} />
                        ) : (
                            <View style={styles.statusIconContainer}>
                                <CheckCircle size={48} color={Colors.primary} />
                            </View>
                        )}
                    </View>

                    {/* Meal Info */}
                    <View style={styles.mealInfoCard}>
                        <Text style={styles.mealTypeLabel}>{displayMealType.toUpperCase()}</Text>
                        <Text style={styles.mealNameLarge}>{displayMealName}</Text>
                        {displayTime && (
                            <View style={styles.timeRow}>
                                <Clock size={16} color={Colors.textSecondary} />
                                <Text style={styles.timeText}>{displayTime}</Text>
                            </View>
                        )}

                        {/* Status Badge */}
                        <View style={styles.loggedBadge}>
                            <CheckCircle size={16} color={Colors.primary} />
                            <Text style={styles.loggedBadgeText}>
                                Logged on {new Date(currentMealLog?.loggedAt || Date.now()).toLocaleDateString()}
                            </Text>
                        </View>

                        {/* Chosen Option Badge */}
                        {hasAlternatives && currentMealLog?.chosenOptionGroup != null && (
                            <View style={styles.chosenOptionBadge}>
                                <CheckCircle size={16} color={Colors.primary} />
                                <Text style={styles.chosenOptionText}>
                                    You chose: {mealOptions.find(o => o.optionGroup === currentMealLog.chosenOptionGroup)?.label
                                        || `Option ${String.fromCharCode(65 + (currentMealLog.chosenOptionGroup ?? 0))}`}
                                </Text>
                                <Text style={styles.chosenOptionCalories}>
                                    {mealOptions.find(o => o.optionGroup === currentMealLog.chosenOptionGroup)?.totalCalories ?? 0} kcal
                                </Text>
                            </View>
                        )}
                    </View>

                    {/* Client Notes */}
                    {clientNotes && (
                        <View style={styles.notesCard}>
                            <Text style={styles.cardTitle}>Your Notes</Text>
                            <Text style={styles.notesText}>{clientNotes}</Text>
                        </View>
                    )}

                    {/* Dietitian Feedback */}
                    <View style={styles.feedbackCard}>
                        <View style={styles.feedbackHeader}>
                            <MessageSquare size={20} color={Colors.primary} />
                            <Text style={styles.cardTitle}>Dietitian Feedback</Text>
                        </View>

                        {dietitianFeedback ? (
                            <View style={styles.feedbackContent}>
                                <View style={styles.dietitianInfo}>
                                    <View style={styles.dietitianAvatar}>
                                        <User size={16} color={Colors.surface} />
                                    </View>
                                    <Text style={styles.dietitianName}>Your Dietitian</Text>
                                </View>
                                <Text style={styles.feedbackText}>{dietitianFeedback}</Text>
                                {currentMealLog?.dietitianFeedbackAt && (
                                    <Text style={styles.feedbackTime}>
                                        {new Date(currentMealLog.dietitianFeedbackAt).toLocaleString()}
                                    </Text>
                                )}
                            </View>
                        ) : (
                            <View style={styles.noFeedback}>
                                <Text style={styles.noFeedbackText}>
                                    No feedback yet. Your dietitian will review this meal soon.
                                </Text>
                            </View>
                        )}
                    </View>
                </ScrollView>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            {/* Header */}
            <View style={styles.header}>
                <TouchableOpacity style={styles.closeButton} onPress={handleClose}>
                    <X size={24} color={Colors.text} />
                </TouchableOpacity>
                <Text style={styles.headerTitle}>Log Meal</Text>
                <View style={styles.headerSpacer} />
            </View>

            <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
                {/* Photo Section */}
                <View style={styles.photoSection}>
                    {photoUri ? (
                        <TouchableOpacity onPress={handleTakePhoto} activeOpacity={0.8}>
                            <Image source={{ uri: photoUri }} style={styles.photoPreview} />
                            <Text style={styles.tapToChange}>Tap to change photo</Text>
                        </TouchableOpacity>
                    ) : (
                        <View style={styles.photoPlaceholder}>
                            <View style={styles.photoButtons}>
                                <TouchableOpacity style={styles.photoButton} onPress={handleTakePhoto}>
                                    <Camera size={28} color={Colors.primary} />
                                    <Text style={styles.photoButtonText}>Camera</Text>
                                </TouchableOpacity>
                                <TouchableOpacity style={styles.photoButton} onPress={handlePickImage}>
                                    <ImageIcon size={28} color={Colors.primary} />
                                    <Text style={styles.photoButtonText}>Gallery</Text>
                                </TouchableOpacity>
                            </View>
                        </View>
                    )}
                </View>

                {/* Option Selector — shown when meal has alternatives */}
                {hasAlternatives && mealOptions.length > 1 && (
                    <View style={styles.optionSection}>
                        <Text style={styles.sectionTitle}>What did you have?</Text>
                        {mealOptions.map((option) => {
                            const isSelected = selectedOption === option.optionGroup;
                            return (
                                <TouchableOpacity
                                    key={option.optionGroup}
                                    style={[
                                        styles.optionCard,
                                        isSelected && styles.optionCardSelected,
                                    ]}
                                    onPress={() => setSelectedOption(option.optionGroup)}
                                    activeOpacity={0.7}
                                >
                                    <View style={styles.optionHeader}>
                                        <View style={styles.optionRadio}>
                                            {isSelected ? (
                                                <CheckCircle2 size={22} color={Colors.primary} />
                                            ) : (
                                                <Circle size={22} color={Colors.border} />
                                            )}
                                        </View>
                                        <View style={styles.optionLabelRow}>
                                            <Text style={[
                                                styles.optionLabel,
                                                isSelected && styles.optionLabelSelected,
                                            ]}>
                                                {option.label || `Option ${String.fromCharCode(65 + option.optionGroup)}`}
                                            </Text>
                                            <Text style={styles.optionCalories}>
                                                {option.totalCalories} kcal
                                            </Text>
                                        </View>
                                    </View>
                                    <View style={styles.optionFoods}>
                                        {option.foodItems.map((fi, idx) => (
                                            <Text key={fi.id || idx} style={styles.optionFoodItem}>
                                                {fi.foodName} {fi.quantityG}g
                                            </Text>
                                        ))}
                                    </View>
                                    <View style={styles.optionMacros}>
                                        <Text style={styles.optionMacroText}>{option.totalProteinG}g P</Text>
                                        <View style={styles.optionMacroDot} />
                                        <Text style={styles.optionMacroText}>{option.totalCarbsG}g C</Text>
                                        <View style={styles.optionMacroDot} />
                                        <Text style={styles.optionMacroText}>{option.totalFatsG}g F</Text>
                                    </View>
                                </TouchableOpacity>
                            );
                        })}
                    </View>
                )}

                {/* Meal Type Selection */}
                <Text style={styles.sectionTitle}>Meal Type</Text>
                <View style={styles.mealTypeContainer}>
                    {mealTypes.map((type) => (
                        <TouchableOpacity
                            key={type}
                            style={[
                                styles.mealTypeButton,
                                selectedMealType === type && styles.mealTypeButtonSelected,
                            ]}
                            onPress={() => setSelectedMealType(type)}
                        >
                            <Text
                                style={[
                                    styles.mealTypeText,
                                    selectedMealType === type && styles.mealTypeTextSelected,
                                ]}
                            >
                                {type}
                            </Text>
                        </TouchableOpacity>
                    ))}
                </View>

                {/* Scheduled Time */}
                {scheduledTime && (
                    <View style={styles.timeContainer}>
                        <Text style={styles.inputLabel}>Scheduled Time</Text>
                        <View style={styles.timeDisplay}>
                            <Clock size={18} color={Colors.textSecondary} />
                            <Text style={styles.scheduledTimeText}>{scheduledTime}</Text>
                        </View>
                    </View>
                )}

                {/* Notes Input */}
                <View style={styles.notesContainer}>
                    <Text style={styles.inputLabel}>Notes (Optional)</Text>
                    <TextInput
                        style={styles.notesInput}
                        value={notes}
                        onChangeText={setNotes}
                        placeholder="Add any notes about your meal"
                        placeholderTextColor={Colors.textSecondary}
                        multiline
                        numberOfLines={4}
                        textAlignVertical="top"
                    />
                </View>
            </ScrollView>

            {/* Submit Button */}
            <View style={styles.footer}>
                <TouchableOpacity
                    style={[CommonStyles.primaryButton, isSubmitting && styles.submitButtonDisabled]}
                    onPress={handleSubmit}
                    disabled={isSubmitting}
                >
                    {isSubmitting ? (
                        <ActivityIndicator color={Colors.text} />
                    ) : (
                        <Text style={CommonStyles.primaryButtonText}>Submit</Text>
                    )}
                </TouchableOpacity>
            </View>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
        borderBottomWidth: 1,
        borderBottomColor: Colors.border,
    },
    closeButton: {
        width: 40,
        height: 40,
        alignItems: 'flex-start',
        justifyContent: 'center',
    },
    headerTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    headerSpacer: {
        width: 40,
    },
    scrollView: {
        flex: 1,
    },
    photoSection: {
        paddingVertical: Spacing.lg,
    },
    mealPhoto: {
        width: '100%',
        aspectRatio: 3 / 2,
        backgroundColor: Colors.surfaceSecondary,
    },
    statusIconContainer: {
        width: '100%',
        aspectRatio: 3 / 2,
        backgroundColor: Colors.surfaceSecondary,
        justifyContent: 'center',
        alignItems: 'center',
    },
    photoPreview: {
        width: '100%',
        aspectRatio: 3 / 2,
        backgroundColor: Colors.surfaceSecondary,
    },
    tapToChange: {
        textAlign: 'center',
        color: Colors.textSecondary,
        fontSize: FontSizes.md,
        marginTop: Spacing.sm,
    },
    photoPlaceholder: {
        width: '100%',
        aspectRatio: 3 / 2,
        backgroundColor: Colors.surfaceSecondary,
        justifyContent: 'center',
        alignItems: 'center',
    },
    photoButtons: {
        flexDirection: 'row',
        gap: 48,
    },
    photoButton: {
        alignItems: 'center',
        gap: Spacing.sm,
    },
    photoButtonText: {
        fontSize: FontSizes.md,
        color: Colors.text,
        fontWeight: FontWeights.medium,
    },
    mealInfoCard: {
        backgroundColor: Colors.surface,
        marginHorizontal: Spacing.lg,
        marginBottom: Spacing.lg,
        padding: Spacing.lg,
        borderRadius: BorderRadius.md,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    mealTypeLabel: {
        fontSize: FontSizes.xs,
        fontWeight: FontWeights.semibold,
        color: Colors.textSecondary,
        marginBottom: Spacing.xs,
    },
    mealNameLarge: {
        fontSize: FontSizes.xxl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    timeRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 6,
        marginBottom: Spacing.md,
    },
    timeText: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
    },
    loggedBadge: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        backgroundColor: Colors.surfaceSecondary,
        paddingHorizontal: Spacing.md,
        paddingVertical: Spacing.sm,
        borderRadius: BorderRadius.sm,
        alignSelf: 'flex-start',
    },
    loggedBadgeText: {
        fontSize: FontSizes.sm,
        color: Colors.textSecondary,
    },
    notesCard: {
        backgroundColor: Colors.surface,
        marginHorizontal: Spacing.lg,
        marginBottom: Spacing.lg,
        padding: Spacing.lg,
        borderRadius: BorderRadius.md,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    cardTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginBottom: Spacing.md,
    },
    notesText: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
        lineHeight: 20,
    },
    feedbackCard: {
        backgroundColor: Colors.surface,
        marginHorizontal: Spacing.lg,
        marginBottom: Spacing.xxl,
        padding: Spacing.lg,
        borderRadius: BorderRadius.md,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    feedbackHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        marginBottom: Spacing.md,
    },
    feedbackContent: {
        backgroundColor: Colors.surfaceSecondary,
        padding: Spacing.md,
        borderRadius: BorderRadius.sm,
    },
    dietitianInfo: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        marginBottom: Spacing.sm,
    },
    dietitianAvatar: {
        width: 28,
        height: 28,
        borderRadius: 14,
        backgroundColor: Colors.primary,
        justifyContent: 'center',
        alignItems: 'center',
    },
    dietitianName: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    feedbackText: {
        fontSize: FontSizes.md,
        color: Colors.text,
        lineHeight: 20,
    },
    feedbackTime: {
        fontSize: FontSizes.xs,
        color: Colors.textSecondary,
        marginTop: Spacing.sm,
    },
    noFeedback: {
        backgroundColor: Colors.surfaceSecondary,
        padding: Spacing.lg,
        borderRadius: BorderRadius.sm,
        alignItems: 'center',
    },
    noFeedbackText: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
        textAlign: 'center',
    },
    sectionTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        paddingHorizontal: Spacing.lg,
        paddingTop: Spacing.lg,
        paddingBottom: Spacing.sm,
    },
    mealTypeContainer: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: 10,
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.sm,
    },
    mealTypeButton: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: 10,
        borderRadius: BorderRadius.sm,
        borderWidth: 1,
        borderColor: Colors.border,
        backgroundColor: Colors.surface,
    },
    mealTypeButtonSelected: {
        borderWidth: 2,
        borderColor: Colors.primary,
    },
    mealTypeText: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.medium,
        color: Colors.text,
    },
    mealTypeTextSelected: {
        fontWeight: FontWeights.semibold,
    },
    timeContainer: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
    },
    inputLabel: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.medium,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    timeDisplay: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        backgroundColor: Colors.surfaceSecondary,
        padding: Spacing.lg,
        borderRadius: BorderRadius.sm,
    },
    scheduledTimeText: {
        fontSize: FontSizes.lg,
        color: Colors.textSecondary,
    },
    notesContainer: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
    },
    notesInput: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.sm,
        padding: Spacing.lg,
        fontSize: FontSizes.lg,
        color: Colors.text,
        minHeight: 100,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    footer: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
        paddingBottom: Spacing.xxl,
        borderTopWidth: 1,
        borderTopColor: Colors.border,
    },
    submitButtonDisabled: {
        opacity: 0.6,
    },
    // Option Selector styles
    optionSection: {
        paddingBottom: Spacing.md,
    },
    optionCard: {
        backgroundColor: Colors.surface,
        marginHorizontal: Spacing.lg,
        marginBottom: Spacing.md,
        padding: Spacing.lg,
        borderRadius: BorderRadius.md,
        borderWidth: 1.5,
        borderColor: Colors.border,
    },
    optionCardSelected: {
        borderColor: Colors.primary,
        backgroundColor: '#f0fdf4',
    },
    optionHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        marginBottom: Spacing.sm,
    },
    optionRadio: {
        marginRight: Spacing.md,
    },
    optionLabelRow: {
        flex: 1,
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
    },
    optionLabel: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    optionLabelSelected: {
        color: Colors.primary,
    },
    optionCalories: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.textSecondary,
    },
    optionFoods: {
        marginLeft: 38,
        marginBottom: Spacing.sm,
    },
    optionFoodItem: {
        fontSize: FontSizes.sm,
        color: Colors.textSecondary,
        lineHeight: 20,
    },
    optionMacros: {
        flexDirection: 'row',
        alignItems: 'center',
        marginLeft: 38,
        gap: 6,
    },
    optionMacroText: {
        fontSize: FontSizes.xs,
        color: Colors.textSecondary,
    },
    optionMacroDot: {
        width: 3,
        height: 3,
        borderRadius: 1.5,
        backgroundColor: Colors.border,
    },
    // Chosen option badge in logged view
    chosenOptionBadge: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        backgroundColor: '#f0fdf4',
        paddingHorizontal: Spacing.md,
        paddingVertical: Spacing.sm,
        borderRadius: BorderRadius.sm,
        marginTop: Spacing.sm,
        borderWidth: 1,
        borderColor: Colors.primary,
    },
    chosenOptionText: {
        fontSize: FontSizes.sm,
        fontWeight: FontWeights.semibold,
        color: Colors.primary,
        flex: 1,
    },
    chosenOptionCalories: {
        fontSize: FontSizes.sm,
        color: Colors.textSecondary,
    },
});
</file>

<file path="client-app/app/(tabs)/notifications/index.tsx">
import { View, Text, StyleSheet, ScrollView, TouchableOpacity, RefreshControl } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useState, useCallback } from 'react';
import { useRouter } from 'expo-router';
import { Settings, MessageCircle, Utensils, Scale, Award } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../../constants/theme';

// Mock notification data - will be replaced with API integration
const mockNotifications = [
    {
        id: '1',
        type: 'feedback',
        title: 'Dr. Sharma commented on your lunch',
        message: 'Great portion control! Keep it up.',
        timestamp: '2h ago',
        read: false,
    },
    {
        id: '2',
        type: 'reminder',
        title: "Don't forget to log your dinner",
        message: 'You have a meal scheduled for 7:30 PM',
        timestamp: '4h ago',
        read: false,
    },
    {
        id: '3',
        type: 'weight',
        title: 'Weekly weight check-in',
        message: "It's time to log your weight!",
        timestamp: '1d ago',
        read: true,
    },
    {
        id: '4',
        type: 'achievement',
        title: 'New milestone achieved! 🎉',
        message: "You've completed 7 days streak",
        timestamp: '2d ago',
        read: true,
    },
    {
        id: '5',
        type: 'feedback',
        title: 'Dr. Sharma approved your meal plan',
        message: 'Your breakfast choices look perfect',
        timestamp: '3d ago',
        read: true,
    },
];

const getNotificationIcon = (type: string) => {
    switch (type) {
        case 'feedback':
            return MessageCircle;
        case 'reminder':
            return Utensils;
        case 'weight':
            return Scale;
        case 'achievement':
            return Award;
        default:
            return MessageCircle;
    }
};

export default function NotificationsScreen() {
    const router = useRouter();
    const [refreshing, setRefreshing] = useState(false);
    const [notifications] = useState(mockNotifications);

    const onRefresh = useCallback(async () => {
        setRefreshing(true);
        // TODO: Refetch notifications from API
        await new Promise(resolve => setTimeout(resolve, 1000));
        setRefreshing(false);
    }, []);

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            {/* Header */}
            <View style={styles.header}>
                <View style={styles.headerSpacer} />
                <Text style={styles.headerTitle}>Inbox</Text>
                <TouchableOpacity style={styles.settingsButton}>
                    <Settings size={24} color={Colors.text} />
                </TouchableOpacity>
            </View>

            <ScrollView
                style={styles.scrollView}
                showsVerticalScrollIndicator={false}
                refreshControl={
                    <RefreshControl
                        refreshing={refreshing}
                        onRefresh={onRefresh}
                        tintColor={Colors.primary}
                    />
                }
            >
                {notifications.length === 0 ? (
                    <View style={styles.emptyContainer}>
                        <MessageCircle size={48} color={Colors.textSecondary} />
                        <Text style={styles.emptyTitle}>No notifications yet</Text>
                        <Text style={styles.emptySubtitle}>
                            You'll see updates from your dietitian here
                        </Text>
                    </View>
                ) : (
                    <View style={styles.notificationsList}>
                        {notifications.map((notification) => {
                            const IconComponent = getNotificationIcon(notification.type);
                            return (
                                <TouchableOpacity
                                    key={notification.id}
                                    style={[
                                        styles.notificationItem,
                                        !notification.read && styles.notificationUnread,
                                    ]}
                                    activeOpacity={0.7}
                                >
                                    <View style={styles.notificationIcon}>
                                        <IconComponent size={20} color={Colors.primary} />
                                    </View>
                                    <View style={styles.notificationContent}>
                                        <Text
                                            style={[
                                                styles.notificationTitle,
                                                !notification.read && styles.notificationTitleUnread,
                                            ]}
                                            numberOfLines={2}
                                        >
                                            {notification.title}
                                        </Text>
                                        {notification.message && (
                                            <Text style={styles.notificationMessage} numberOfLines={1}>
                                                {notification.message}
                                            </Text>
                                        )}
                                        <Text style={styles.notificationTime}>
                                            {notification.timestamp}
                                        </Text>
                                    </View>
                                </TouchableOpacity>
                            );
                        })}
                    </View>
                )}
            </ScrollView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.sm,
    },
    headerSpacer: {
        width: 48,
    },
    headerTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    settingsButton: {
        width: 48,
        height: 48,
        alignItems: 'flex-end',
        justifyContent: 'center',
    },
    scrollView: {
        flex: 1,
    },
    emptyContainer: {
        flex: 1,
        alignItems: 'center',
        justifyContent: 'center',
        paddingTop: 100,
        paddingHorizontal: Spacing.xxl,
    },
    emptyTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginTop: Spacing.lg,
    },
    emptySubtitle: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
        textAlign: 'center',
        marginTop: Spacing.sm,
    },
    notificationsList: {
        padding: Spacing.lg,
    },
    notificationItem: {
        flexDirection: 'row',
        alignItems: 'flex-start',
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.md,
        padding: Spacing.lg,
        marginBottom: Spacing.md,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    notificationUnread: {
        backgroundColor: Colors.surfaceSecondary,
        borderColor: Colors.primary,
    },
    notificationIcon: {
        width: 44,
        height: 44,
        borderRadius: 22,
        backgroundColor: Colors.surfaceSecondary,
        alignItems: 'center',
        justifyContent: 'center',
        marginRight: Spacing.md,
    },
    notificationContent: {
        flex: 1,
    },
    notificationTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.medium,
        color: Colors.text,
        marginBottom: Spacing.xs,
    },
    notificationTitleUnread: {
        fontWeight: FontWeights.bold,
    },
    notificationMessage: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
        marginBottom: Spacing.xs,
    },
    notificationTime: {
        fontSize: FontSizes.xs,
        color: Colors.textSecondary,
    },
});
</file>

<file path="client-app/app/(tabs)/profile/referral.tsx">
import { useState, useEffect } from 'react';
import {
    View,
    Text,
    StyleSheet,
    ScrollView,
    TouchableOpacity,
    Share,
    ActivityIndicator,
    Linking,
    Clipboard,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useRouter } from 'expo-router';
import { ArrowLeft, Copy, Share2, Gift, Users, Award } from 'lucide-react-native';
import api from '../../../services/api';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../../constants/theme';
import { useToast } from '../../../components/Toast';
import { normalizeError } from '../../../utils/errorHandler';
import { ReferralData, ReferralStats } from '../../../types';

export default function ReferralScreen() {
    const router = useRouter();
    const toast = useToast();
    const [loading, setLoading] = useState(true);
    const [referralData, setReferralData] = useState<ReferralData | null>(null);
    const [stats, setStats] = useState<ReferralStats | null>(null);
    const [copied, setCopied] = useState(false);

    useEffect(() => {
        fetchReferralData();
    }, []);

    const fetchReferralData = async () => {
        try {
            const [codeRes, statsRes] = await Promise.all([
                api.get('/client/referral/code'),
                api.get('/client/referral/stats'),
            ]);
            setReferralData(codeRes.data.data);
            setStats(statsRes.data.data);
        } catch (error) {
            const normalized = normalizeError(error);
            toast.showToast({ title: 'Error', message: normalized.message, variant: 'error' });
        } finally {
            setLoading(false);
        }
    };

    const handleCopyCode = async () => {
        if (referralData?.referralCode) {
            Clipboard.setString(referralData.referralCode);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
        }
    };

    const handleShareWhatsApp = async () => {
        if (referralData?.whatsappLink) {
            try {
                await Linking.openURL(referralData.whatsappLink);
            } catch (error) {
                toast.showToast({ title: 'Error', message: 'WhatsApp is not installed', variant: 'error' });
            }
        }
    };

    const handleShare = async () => {
        if (referralData?.shareMessage) {
            try {
                await Share.share({
                    message: referralData.shareMessage,
                });
            } catch (error) {
                console.error('Share error:', error);
            }
        }
    };

    if (loading) {
        return (
            <SafeAreaView style={styles.container} edges={['top']}>
                <View style={styles.loadingContainer}>
                    <ActivityIndicator size="large" color={Colors.primary} />
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
                {/* Header */}
                <View style={styles.header}>
                    <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
                        <ArrowLeft size={24} color={Colors.text} />
                    </TouchableOpacity>
                    <Text style={styles.headerTitle}>Refer & Earn</Text>
                </View>

                {/* Hero Card */}
                <View style={styles.heroCard}>
                    <Gift size={48} color="#fff" />
                    <Text style={styles.heroTitle}>Invite Friends, Get Rewards!</Text>
                    <Text style={styles.heroSubtitle}>
                        Share your code with friends. When 3 friends join, you get 1 month FREE!
                    </Text>
                </View>

                {/* Referral Code Card */}
                <View style={styles.codeCard}>
                    <Text style={styles.codeLabel}>Your Referral Code</Text>
                    <View style={styles.codeContainer}>
                        <Text style={styles.codeText}>{referralData?.referralCode || '------'}</Text>
                        <TouchableOpacity style={styles.copyButton} onPress={handleCopyCode}>
                            <Copy size={20} color={copied ? Colors.primary : Colors.text} />
                            <Text style={[styles.copyText, copied && styles.copyTextActive]}>
                                {copied ? 'Copied!' : 'Copy'}
                            </Text>
                        </TouchableOpacity>
                    </View>
                </View>

                {/* Share Buttons */}
                <View style={styles.shareSection}>
                    <Text style={styles.shareSectionTitle}>Share via</Text>
                    <View style={styles.shareButtons}>
                        <TouchableOpacity style={styles.whatsappButton} onPress={handleShareWhatsApp}>
                            <Text style={styles.whatsappIcon}>💬</Text>
                            <Text style={styles.shareButtonText}>WhatsApp</Text>
                        </TouchableOpacity>
                        <TouchableOpacity style={styles.shareButton} onPress={handleShare}>
                            <Share2 size={20} color={Colors.text} />
                            <Text style={styles.shareButtonText}>More</Text>
                        </TouchableOpacity>
                    </View>
                </View>

                {/* Stats Card */}
                <View style={styles.statsCard}>
                    <Text style={styles.statsTitle}>Your Referral Stats</Text>
                    <View style={styles.statsGrid}>
                        <View style={styles.statItem}>
                            <View style={styles.statIconContainer}>
                                <Users size={20} color={Colors.primary} />
                            </View>
                            <Text style={styles.statValue}>{stats?.referralCount || 0}</Text>
                            <Text style={styles.statLabel}>Friends Invited</Text>
                        </View>
                        <View style={styles.statItem}>
                            <View style={styles.statIconContainer}>
                                <Award size={20} color={Colors.primary} />
                            </View>
                            <Text style={styles.statValue}>{stats?.freeMonthsRemaining || 0}</Text>
                            <Text style={styles.statLabel}>Free Months</Text>
                        </View>
                    </View>

                    {/* Progress to next reward */}
                    <View style={styles.progressSection}>
                        <Text style={styles.progressText}>
                            {stats?.referralsUntilNextReward === 0
                                ? '🎉 You earned a free month!'
                                : `${stats?.referralsUntilNextReward || 3} more referrals to earn 1 free month`}
                        </Text>
                        <View style={styles.progressBar}>
                            <View
                                style={[
                                    styles.progressFill,
                                    {
                                        width: `${((3 - (stats?.referralsUntilNextReward || 3)) / 3) * 100}%`,
                                    },
                                ]}
                            />
                        </View>
                    </View>
                </View>

                {/* Recent Referrals */}
                {stats?.referredClients && stats.referredClients.length > 0 && (
                    <View style={styles.recentCard}>
                        <Text style={styles.recentTitle}>Recent Referrals</Text>
                        {stats.referredClients.map((client, index) => (
                            <View key={index} style={styles.recentItem}>
                                <Text style={styles.recentName}>{client.name}</Text>
                                <Text style={styles.recentDate}>
                                    {new Date(client.joinedAt).toLocaleDateString()}
                                </Text>
                            </View>
                        ))}
                    </View>
                )}
            </ScrollView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    loadingContainer: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
    },
    scrollView: {
        flex: 1,
        padding: 16,
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        marginBottom: 24,
    },
    backButton: {
        marginRight: 12,
    },
    headerTitle: {
        fontSize: 22,
        fontWeight: '700',
        color: Colors.text,
    },
    heroCard: {
        backgroundColor: Colors.primary,
        borderRadius: 20,
        padding: 24,
        alignItems: 'center',
        marginBottom: 16,
    },
    heroTitle: {
        fontSize: 24,
        fontWeight: '700',
        color: Colors.text,
        marginTop: 16,
        textAlign: 'center',
    },
    heroSubtitle: {
        fontSize: 14,
        color: 'rgba(13,27,18,0.8)',
        textAlign: 'center',
        marginTop: 8,
        lineHeight: 20,
    },
    codeCard: {
        backgroundColor: Colors.surface,
        borderRadius: 16,
        padding: 20,
        marginBottom: 16,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    codeLabel: {
        fontSize: 14,
        color: Colors.textSecondary,
        marginBottom: 12,
    },
    codeContainer: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
    },
    codeText: {
        fontSize: 32,
        fontWeight: '700',
        color: Colors.text,
        letterSpacing: 4,
    },
    copyButton: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 6,
        backgroundColor: Colors.surfaceSecondary,
        paddingHorizontal: 16,
        paddingVertical: 10,
        borderRadius: 12,
    },
    copyText: {
        fontSize: 14,
        fontWeight: '600',
        color: Colors.text,
    },
    copyTextActive: {
        color: Colors.primary,
    },
    shareSection: {
        marginBottom: 16,
    },
    shareSectionTitle: {
        fontSize: 14,
        color: Colors.textSecondary,
        marginBottom: 12,
    },
    shareButtons: {
        flexDirection: 'row',
        gap: 12,
    },
    whatsappButton: {
        flex: 1,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 8,
        backgroundColor: '#25D366',
        paddingVertical: 16,
        borderRadius: 14,
    },
    whatsappIcon: {
        fontSize: 20,
    },
    shareButton: {
        flex: 1,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 8,
        backgroundColor: Colors.surface,
        paddingVertical: 16,
        borderRadius: 14,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    shareButtonText: {
        fontSize: 16,
        fontWeight: '600',
        color: Colors.text,
    },
    statsCard: {
        backgroundColor: Colors.surface,
        borderRadius: 16,
        padding: 20,
        marginBottom: 16,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    statsTitle: {
        fontSize: 16,
        fontWeight: '600',
        color: Colors.text,
        marginBottom: 16,
    },
    statsGrid: {
        flexDirection: 'row',
        gap: 16,
    },
    statItem: {
        flex: 1,
        alignItems: 'center',
    },
    statIconContainer: {
        width: 48,
        height: 48,
        borderRadius: 24,
        backgroundColor: Colors.surfaceSecondary,
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 8,
    },
    statValue: {
        fontSize: 28,
        fontWeight: '700',
        color: Colors.text,
    },
    statLabel: {
        fontSize: 12,
        color: Colors.textSecondary,
        marginTop: 4,
    },
    progressSection: {
        marginTop: 20,
        paddingTop: 16,
        borderTopWidth: 1,
        borderTopColor: Colors.border,
    },
    progressText: {
        fontSize: 14,
        color: Colors.textSecondary,
        textAlign: 'center',
        marginBottom: 12,
    },
    progressBar: {
        height: 8,
        backgroundColor: Colors.surfaceSecondary,
        borderRadius: 4,
        overflow: 'hidden',
    },
    progressFill: {
        height: '100%',
        backgroundColor: Colors.primary,
        borderRadius: 4,
    },
    recentCard: {
        backgroundColor: Colors.surface,
        borderRadius: 16,
        padding: 20,
        marginBottom: 24,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    recentTitle: {
        fontSize: 16,
        fontWeight: '600',
        color: Colors.text,
        marginBottom: 16,
    },
    recentItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        paddingVertical: 12,
        borderBottomWidth: 1,
        borderBottomColor: Colors.border,
    },
    recentName: {
        fontSize: 14,
        fontWeight: '500',
        color: Colors.text,
    },
    recentDate: {
        fontSize: 12,
        color: Colors.textSecondary,
    },
});
</file>

<file path="client-app/app/(tabs)/profile/reports.tsx">
import { useState, useEffect } from 'react';
import {
    View,
    Text,
    StyleSheet,
    ScrollView,
    TouchableOpacity,
    Alert,
    ActivityIndicator,
    FlatList,
    RefreshControl,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useRouter } from 'expo-router';
import { ArrowLeft, FileText, Upload, Trash2, Image as ImageIcon } from 'lucide-react-native';
import * as ImagePicker from 'expo-image-picker';
import * as DocumentPicker from 'expo-document-picker';
import api from '../../../services/api';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../../constants/theme';
import { useToast } from '../../../components/Toast';
import { normalizeError } from '../../../utils/errorHandler';
import { Report } from '../../../types';

export default function ReportsScreen() {
    const router = useRouter();
    const toast = useToast();
    const [loading, setLoading] = useState(true);
    const [reports, setReports] = useState<Report[]>([]);
    const [uploading, setUploading] = useState(false);
    const [refreshing, setRefreshing] = useState(false);

    useEffect(() => {
        fetchReports();
    }, []);

    const fetchReports = async () => {
        try {
            const response = await api.get('/client/reports');
            setReports(response.data.data || []);
        } catch (error) {
            console.error('Failed to fetch reports:', error);
        } finally {
            setLoading(false);
            setRefreshing(false);
        }
    };

    const handleUpload = () => {
        Alert.alert(
            'Upload Report',
            'Choose how to upload your report',
            [
                {
                    text: 'Take Photo',
                    onPress: handleTakePhoto,
                },
                {
                    text: 'Choose from Gallery',
                    onPress: handlePickImage,
                },
                {
                    text: 'Select PDF',
                    onPress: handlePickDocument,
                },
                {
                    text: 'Cancel',
                    style: 'cancel',
                },
            ]
        );
    };

    const handleTakePhoto = async () => {
        const permission = await ImagePicker.requestCameraPermissionsAsync();
        if (!permission.granted) {
            toast.showToast({ title: 'Permission Required', message: 'Camera access is needed to take photos', variant: 'warning' });
            return;
        }

        const result = await ImagePicker.launchCameraAsync({
            mediaTypes: 'images',
            quality: 0.8,
        });

        if (!result.canceled && result.assets[0]) {
            uploadFile(result.assets[0].uri, 'photo.jpg', 'image/jpeg');
        }
    };

    const handlePickImage = async () => {
        const result = await ImagePicker.launchImageLibraryAsync({
            mediaTypes: 'images',
            quality: 0.8,
        });

        if (!result.canceled && result.assets[0]) {
            const uri = result.assets[0].uri;
            const fileName = uri.split('/').pop() || 'image.jpg';
            uploadFile(uri, fileName, 'image/jpeg');
        }
    };

    const handlePickDocument = async () => {
        try {
            const result = await DocumentPicker.getDocumentAsync({
                type: 'application/pdf',
            });

            if (!result.canceled && result.assets[0]) {
                const { uri, name, mimeType } = result.assets[0];
                uploadFile(uri, name, mimeType || 'application/pdf');
            }
        } catch (error) {
            toast.showToast({ title: 'Error', message: 'Failed to pick document', variant: 'error' });
        }
    };

    const uploadFile = async (uri: string, fileName: string, fileType: string) => {
        setUploading(true);
        try {
            // Get presigned URL
            const urlResponse = await api.post('/client/reports/upload-url', {
                fileName,
                fileType,
                reportType: 'other',
            });

            const { uploadUrl, key } = urlResponse.data.data;

            // Upload to S3
            const fileResponse = await fetch(uri);
            const blob = await fileResponse.blob();

            await fetch(uploadUrl, {
                method: 'PUT',
                body: blob,
                headers: {
                    'Content-Type': fileType,
                },
            });

            // Save report metadata
            await api.post('/client/reports', {
                key,
                fileName,
                fileType,
                reportType: 'other',
            });

            toast.showToast({ title: 'Success', message: 'Report uploaded successfully!', variant: 'success' });
            fetchReports();
        } catch (error) {
            console.error('Upload error:', error);
            const normalized = normalizeError(error);
            toast.showToast({ title: 'Upload Failed', message: normalized.message, variant: 'error' });
        } finally {
            setUploading(false);
        }
    };

    const handleDelete = (report: Report) => {
        Alert.alert(
            'Delete Report',
            `Are you sure you want to delete "${report.fileName}"?`,
            [
                { text: 'Cancel', style: 'cancel' },
                {
                    text: 'Delete',
                    style: 'destructive',
                    onPress: async () => {
                        try {
                            await api.delete(`/client/reports/${report.id}`);
                            setReports(reports.filter(r => r.id !== report.id));
                        } catch (error) {
                            const normalized = normalizeError(error);
                            toast.showToast({ title: 'Error', message: normalized.message, variant: 'error' });
                        }
                    },
                },
            ]
        );
    };

    const renderReport = ({ item }: { item: Report }) => (
        <View style={styles.reportCard}>
            <View style={styles.reportIcon}>
                {item.fileType === 'pdf' ? (
                    <FileText size={24} color={Colors.primary} />
                ) : (
                    <ImageIcon size={24} color={Colors.primary} />
                )}
            </View>
            <View style={styles.reportInfo}>
                <Text style={styles.reportName} numberOfLines={1}>{item.fileName}</Text>
                <Text style={styles.reportMeta}>
                    {item.reportType} • {new Date(item.uploadedAt).toLocaleDateString()}
                </Text>
            </View>
            <TouchableOpacity
                style={styles.deleteButton}
                onPress={() => handleDelete(item)}
            >
                <Trash2 size={20} color={Colors.error} />
            </TouchableOpacity>
        </View>
    );

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            {/* Header */}
            <View style={styles.header}>
                <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
                    <ArrowLeft size={24} color={Colors.text} />
                </TouchableOpacity>
                <Text style={styles.headerTitle}>My Reports</Text>
            </View>

            {loading ? (
                <View style={styles.loadingContainer}>
                    <ActivityIndicator size="large" color={Colors.primary} />
                </View>
            ) : (
                <FlatList
                    data={reports}
                    renderItem={renderReport}
                    keyExtractor={item => item.id}
                    contentContainerStyle={styles.listContent}
                    refreshControl={
                        <RefreshControl
                            refreshing={refreshing}
                            onRefresh={() => {
                                setRefreshing(true);
                                fetchReports();
                            }}
                            tintColor={Colors.primary}
                        />
                    }
                    ListEmptyComponent={
                        <View style={styles.emptyContainer}>
                            <FileText size={48} color={Colors.textSecondary} />
                            <Text style={styles.emptyTitle}>No Reports Yet</Text>
                            <Text style={styles.emptySubtitle}>
                                Upload your medical reports, blood tests, and other documents
                            </Text>
                        </View>
                    }
                    ListHeaderComponent={
                        <TouchableOpacity
                            style={[styles.uploadButton, uploading && styles.uploadButtonDisabled]}
                            onPress={handleUpload}
                            disabled={uploading}
                        >
                            {uploading ? (
                                <ActivityIndicator color={Colors.text} />
                            ) : (
                                <>
                                    <Upload size={20} color={Colors.text} />
                                    <Text style={styles.uploadButtonText}>Upload Report</Text>
                                </>
                            )}
                        </TouchableOpacity>
                    }
                />
            )}
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        paddingHorizontal: 16,
        paddingVertical: 16,
    },
    backButton: {
        marginRight: 12,
    },
    headerTitle: {
        fontSize: 22,
        fontWeight: '700',
        color: Colors.text,
    },
    loadingContainer: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
    },
    listContent: {
        padding: 16,
        paddingTop: 0,
    },
    uploadButton: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 8,
        backgroundColor: Colors.primary,
        paddingVertical: 16,
        borderRadius: 14,
        marginBottom: 24,
    },
    uploadButtonDisabled: {
        opacity: 0.7,
    },
    uploadButtonText: {
        fontSize: 16,
        fontWeight: '600',
        color: Colors.text,
    },
    reportCard: {
        flexDirection: 'row',
        alignItems: 'center',
        backgroundColor: Colors.surface,
        borderRadius: 12,
        padding: 16,
        marginBottom: 12,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    reportIcon: {
        width: 48,
        height: 48,
        borderRadius: 12,
        backgroundColor: Colors.surfaceSecondary,
        justifyContent: 'center',
        alignItems: 'center',
        marginRight: 12,
    },
    reportInfo: {
        flex: 1,
    },
    reportName: {
        fontSize: 16,
        fontWeight: '600',
        color: Colors.text,
    },
    reportMeta: {
        fontSize: 12,
        color: Colors.textSecondary,
        marginTop: 4,
    },
    deleteButton: {
        padding: 8,
    },
    emptyContainer: {
        alignItems: 'center',
        paddingVertical: 48,
    },
    emptyTitle: {
        fontSize: 18,
        fontWeight: '600',
        color: Colors.text,
        marginTop: 16,
    },
    emptySubtitle: {
        fontSize: 14,
        color: Colors.textSecondary,
        textAlign: 'center',
        marginTop: 8,
        paddingHorizontal: 32,
    },
});
</file>

<file path="client-app/app/(tabs)/weight/index.tsx">
import { useState } from 'react';
import {
    View,
    Text,
    StyleSheet,
    ScrollView,
    TextInput,
    TouchableOpacity,
    ActivityIndicator,
    Dimensions,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useWeightLogs, useCreateWeightLog } from '../../../hooks/useWeight';
import { useAuth } from '../../../hooks/useAuth';
import { useToast } from '../../../components/Toast';
import { Plus, TrendingDown, TrendingUp, Minus, Target, Award } from 'lucide-react-native';
import { LineChart } from 'react-native-chart-kit';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights, Shadows } from '../../../constants/theme';

const screenWidth = Dimensions.get('window').width;

export default function WeightScreen() {
    const { data: weightLogs, isLoading } = useWeightLogs(10);
    const { client } = useAuth();
    const createMutation = useCreateWeightLog();
    const { showToast } = useToast();
    const [weight, setWeight] = useState('');
    const [notes, setNotes] = useState('');
    const [showForm, setShowForm] = useState(false);

    const handleLogWeight = async () => {
        const weightNum = parseFloat(weight);
        if (isNaN(weightNum) || weightNum < 20 || weightNum > 300) {
            showToast({ title: 'Invalid Weight', message: 'Please enter a valid weight between 20-300 kg', variant: 'warning' });
            return;
        }

        try {
            await createMutation.mutateAsync({
                weightKg: weightNum,
                logDate: new Date().toISOString().split('T')[0],
                notes: notes || undefined,
            });
            setWeight('');
            setNotes('');
            setShowForm(false);
            showToast({ title: 'Success', message: 'Weight logged successfully!', variant: 'success' });
        } catch (error) {
            showToast({ title: 'Error', message: 'Failed to log weight. Please try again.', variant: 'error' });
        }
    };

    const latestWeight = weightLogs?.[0]?.weightKg;
    const previousWeight = weightLogs?.[1]?.weightKg;
    const change = latestWeight && previousWeight ? latestWeight - previousWeight : null;
    const targetWeight = client?.targetWeightKg;

    // Calculate progress metrics
    const startWeight = weightLogs?.length ? weightLogs[weightLogs.length - 1]?.weightKg : null;
    const weightLost = startWeight && latestWeight ? startWeight - latestWeight : 0;
    const remainingToGoal = targetWeight && latestWeight ? latestWeight - targetWeight : null;
    const progressPercent = startWeight && targetWeight && latestWeight
        ? Math.min(100, Math.max(0, ((startWeight - latestWeight) / (startWeight - targetWeight)) * 100))
        : 0;

    // Prepare chart data (reverse to show oldest first)
    const chartData = weightLogs?.slice(0, 7).reverse() || [];
    const hasChartData = chartData.length >= 2;

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
                <Text style={styles.title}>Weight Tracking</Text>
                <Text style={styles.subtitle}>Monitor your progress over time</Text>

                {/* Current Weight Card */}
                <View style={styles.currentCard}>
                    <Text style={styles.currentLabel}>Current Weight</Text>
                    <View style={styles.currentValueRow}>
                        <Text style={styles.currentValue}>{latestWeight || '--'}</Text>
                        <Text style={styles.currentUnit}>kg</Text>
                        {change !== null && (
                            <View style={[styles.changeBadge, change < 0 ? styles.changeDown : change > 0 ? styles.changeUp : styles.changeNeutral]}>
                                {change < 0 ? <TrendingDown size={14} color="#065f46" /> : change > 0 ? <TrendingUp size={14} color="#991b1b" /> : <Minus size={14} color={Colors.textMuted} />}
                                <Text style={[styles.changeText, change < 0 ? styles.changeTextDown : change > 0 ? styles.changeTextUp : styles.changeTextNeutral]}>
                                    {change > 0 ? '+' : ''}{change.toFixed(1)} kg
                                </Text>
                            </View>
                        )}
                    </View>
                </View>

                {/* Goal Progress Card */}
                {targetWeight && (
                    <View style={styles.goalCard}>
                        <View style={styles.goalHeader}>
                            <Target size={20} color={Colors.primaryDark} />
                            <Text style={styles.goalTitle}>Goal Progress</Text>
                        </View>

                        <View style={styles.goalStats}>
                            <View style={styles.goalStat}>
                                <Text style={styles.goalStatValue}>{targetWeight}</Text>
                                <Text style={styles.goalStatLabel}>Target (kg)</Text>
                            </View>
                            <View style={styles.goalStatDivider} />
                            <View style={styles.goalStat}>
                                <Text style={[styles.goalStatValue, weightLost > 0 && styles.goalStatPositive]}>
                                    {weightLost > 0 ? '-' : ''}{Math.abs(weightLost).toFixed(1)}
                                </Text>
                                <Text style={styles.goalStatLabel}>Lost (kg)</Text>
                            </View>
                            <View style={styles.goalStatDivider} />
                            <View style={styles.goalStat}>
                                <Text style={styles.goalStatValue}>
                                    {remainingToGoal !== null ? remainingToGoal.toFixed(1) : '--'}
                                </Text>
                                <Text style={styles.goalStatLabel}>To Go (kg)</Text>
                            </View>
                        </View>

                        {/* Progress Bar */}
                        <View style={styles.progressBarContainer}>
                            <View style={styles.progressBarBackground}>
                                <View style={[styles.progressBarFill, { width: `${Math.min(100, progressPercent)}%` }]} />
                            </View>
                            <Text style={styles.progressText}>{progressPercent.toFixed(0)}% to goal</Text>
                        </View>
                    </View>
                )}

                {/* Weight Trend Chart */}
                {hasChartData && (
                    <View style={styles.chartCard}>
                        <Text style={styles.chartTitle}>7-Day Trend</Text>
                        <LineChart
                            data={{
                                labels: chartData.map(log => {
                                    const date = new Date(log.logDate);
                                    return `${date.getDate()}/${date.getMonth() + 1}`;
                                }),
                                datasets: [
                                    {
                                        data: chartData.map(log => log.weightKg),
                                        color: (opacity = 1) => `rgba(23, 207, 84, ${opacity})`,
                                        strokeWidth: 2,
                                    },
                                    ...(targetWeight ? [{
                                        data: chartData.map(() => targetWeight),
                                        color: (opacity = 1) => `rgba(239, 68, 68, ${opacity * 0.5})`,
                                        strokeWidth: 1,
                                        withDots: false,
                                    }] : []),
                                ],
                            }}
                            width={screenWidth - 56}
                            height={180}
                            chartConfig={{
                                backgroundColor: '#ffffff',
                                backgroundGradientFrom: '#ffffff',
                                backgroundGradientTo: '#ffffff',
                                decimalPlaces: 1,
                                color: (opacity = 1) => `rgba(17, 24, 39, ${opacity})`,
                                labelColor: (opacity = 1) => `rgba(107, 114, 128, ${opacity})`,
                                style: { borderRadius: 16 },
                                propsForDots: {
                                    r: '5',
                                    strokeWidth: '2',
                                    stroke: '#17cf54',
                                },
                                propsForBackgroundLines: {
                                    strokeDasharray: '',
                                    stroke: '#e5e7eb',
                                },
                            }}
                            bezier
                            style={styles.chart}
                        />
                        {targetWeight && (
                            <View style={styles.chartLegend}>
                                <View style={styles.legendItem}>
                                    <View style={[styles.legendDot, { backgroundColor: Colors.primaryDark }]} />
                                    <Text style={styles.legendText}>Your Weight</Text>
                                </View>
                                <View style={styles.legendItem}>
                                    <View style={[styles.legendDot, { backgroundColor: Colors.error }]} />
                                    <Text style={styles.legendText}>Target</Text>
                                </View>
                            </View>
                        )}
                    </View>
                )}

                {/* Add Weight Button/Form */}
                {!showForm ? (
                    <TouchableOpacity style={styles.addButton} onPress={() => setShowForm(true)}>
                        <Plus size={20} color={Colors.surface} />
                        <Text style={styles.addButtonText}>Log Today's Weight</Text>
                    </TouchableOpacity>
                ) : (
                    <View style={styles.formCard}>
                        <Text style={styles.formTitle}>Log Weight</Text>
                        <View style={styles.inputRow}>
                            <TextInput
                                style={styles.weightInput}
                                value={weight}
                                onChangeText={setWeight}
                                placeholder="0.0"
                                placeholderTextColor={Colors.textMuted}
                                keyboardType="decimal-pad"
                                autoFocus
                            />
                            <Text style={styles.inputUnit}>kg</Text>
                        </View>
                        <TextInput
                            style={styles.notesInput}
                            value={notes}
                            onChangeText={setNotes}
                            placeholder="Add notes (optional)"
                            placeholderTextColor={Colors.textMuted}
                            multiline
                        />
                        <View style={styles.formButtons}>
                            <TouchableOpacity style={styles.cancelButton} onPress={() => setShowForm(false)}>
                                <Text style={styles.cancelButtonText}>Cancel</Text>
                            </TouchableOpacity>
                            <TouchableOpacity
                                style={[styles.saveButton, createMutation.isPending && styles.saveButtonDisabled]}
                                onPress={handleLogWeight}
                                disabled={createMutation.isPending}
                            >
                                {createMutation.isPending ? (
                                    <ActivityIndicator color={Colors.surface} size="small" />
                                ) : (
                                    <Text style={styles.saveButtonText}>Save</Text>
                                )}
                            </TouchableOpacity>
                        </View>
                    </View>
                )}

                {/* Weight History */}
                <Text style={styles.sectionTitle}>History</Text>
                {isLoading ? (
                    <ActivityIndicator style={styles.loader} color={Colors.primaryDark} />
                ) : weightLogs && weightLogs.length > 0 ? (
                    <View style={styles.historyList}>
                        {weightLogs.map((log, index) => {
                            const prevLog = weightLogs[index + 1];
                            const delta = prevLog ? log.weightKg - prevLog.weightKg : null;
                            return (
                                <View key={log.id} style={styles.historyItem}>
                                    <View>
                                        <Text style={styles.historyDate}>
                                            {new Date(log.logDate).toLocaleDateString('en-US', {
                                                weekday: 'short',
                                                month: 'short',
                                                day: 'numeric',
                                            })}
                                        </Text>
                                        {log.notes && <Text style={styles.historyNotes}>{log.notes}</Text>}
                                    </View>
                                    <View style={styles.historyRight}>
                                        <Text style={styles.historyWeight}>{log.weightKg} kg</Text>
                                        {delta !== null && (
                                            <Text style={[styles.historyDelta, delta < 0 ? styles.deltaDown : delta > 0 ? styles.deltaUp : styles.deltaNeutral]}>
                                                {delta > 0 ? '+' : ''}{delta.toFixed(1)}
                                            </Text>
                                        )}
                                    </View>
                                </View>
                            );
                        })}
                    </View>
                ) : (
                    <View style={styles.emptyContainer}>
                        <Text style={styles.emptyText}>No weight logs yet</Text>
                        <Text style={styles.emptySubtext}>Start tracking your weight to see progress</Text>
                    </View>
                )}
            </ScrollView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    scrollView: {
        flex: 1,
        padding: Spacing.xl,
    },
    title: {
        fontSize: FontSizes.xxxl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.xs,
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textMuted,
        marginBottom: Spacing.xxl,
    },
    currentCard: {
        backgroundColor: Colors.primaryDark,
        borderRadius: BorderRadius.xl,
        padding: Spacing.xxl,
        alignItems: 'center',
        marginBottom: Spacing.lg,
    },
    currentLabel: {
        fontSize: FontSizes.md,
        color: 'rgba(255,255,255,0.8)',
        marginBottom: Spacing.sm,
    },
    currentValueRow: {
        flexDirection: 'row',
        alignItems: 'baseline',
    },
    currentValue: {
        fontSize: 56,
        fontWeight: FontWeights.bold,
        color: Colors.surface,
    },
    currentUnit: {
        fontSize: 24,
        fontWeight: FontWeights.medium,
        color: 'rgba(255,255,255,0.8)',
        marginLeft: Spacing.xs,
    },
    changeBadge: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.xs,
        paddingHorizontal: 10,
        paddingVertical: Spacing.xs,
        borderRadius: BorderRadius.md,
        marginLeft: Spacing.md,
    },
    changeDown: { backgroundColor: '#d1fae5' },
    changeUp: { backgroundColor: '#fee2e2' },
    changeNeutral: { backgroundColor: Colors.background },
    changeText: { fontSize: FontSizes.sm, fontWeight: FontWeights.semibold },
    changeTextDown: { color: '#065f46' },
    changeTextUp: { color: '#991b1b' },
    changeTextNeutral: { color: Colors.textMuted },
    goalCard: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        padding: Spacing.xl,
        marginBottom: Spacing.lg,
        ...Shadows.md,
    },
    goalHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        marginBottom: Spacing.lg,
    },
    goalTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    goalStats: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        marginBottom: Spacing.lg,
    },
    goalStat: {
        flex: 1,
        alignItems: 'center',
    },
    goalStatDivider: {
        width: 1,
        backgroundColor: Colors.border,
    },
    goalStatValue: {
        fontSize: 24,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    goalStatPositive: {
        color: Colors.primaryDark,
    },
    goalStatLabel: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
        marginTop: Spacing.xs,
    },
    progressBarContainer: {
        marginTop: Spacing.sm,
    },
    progressBarBackground: {
        height: 8,
        backgroundColor: Colors.border,
        borderRadius: 4,
        overflow: 'hidden',
    },
    progressBarFill: {
        height: '100%',
        backgroundColor: Colors.primaryDark,
        borderRadius: 4,
    },
    progressText: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
        textAlign: 'center',
        marginTop: Spacing.sm,
    },
    chartCard: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        padding: Spacing.lg,
        marginBottom: Spacing.lg,
        ...Shadows.md,
    },
    chartTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginBottom: Spacing.md,
    },
    chart: {
        marginVertical: Spacing.sm,
        borderRadius: BorderRadius.lg,
    },
    chartLegend: {
        flexDirection: 'row',
        justifyContent: 'center',
        gap: Spacing.xxl,
        marginTop: Spacing.sm,
    },
    legendItem: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 6,
    },
    legendDot: {
        width: 10,
        height: 10,
        borderRadius: 5,
    },
    legendText: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
    },
    addButton: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: Spacing.sm,
        backgroundColor: Colors.text,
        paddingVertical: Spacing.lg,
        borderRadius: 14,
        marginBottom: Spacing.xxl,
    },
    addButtonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    },
    formCard: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        padding: Spacing.xl,
        marginBottom: Spacing.xxl,
        ...Shadows.md,
    },
    formTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.lg,
    },
    inputRow: {
        flexDirection: 'row',
        alignItems: 'center',
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        paddingHorizontal: Spacing.lg,
        marginBottom: Spacing.md,
    },
    weightInput: {
        flex: 1,
        fontSize: FontSizes.display,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        paddingVertical: Spacing.md,
    },
    inputUnit: {
        fontSize: FontSizes.xl,
        color: Colors.textMuted,
    },
    notesInput: {
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: Spacing.md,
        fontSize: FontSizes.md,
        color: Colors.text,
        minHeight: 60,
        textAlignVertical: 'top',
        marginBottom: Spacing.lg,
    },
    formButtons: {
        flexDirection: 'row',
        gap: Spacing.md,
    },
    cancelButton: {
        flex: 1,
        paddingVertical: 14,
        borderRadius: BorderRadius.md,
        borderWidth: 1,
        borderColor: Colors.border,
        alignItems: 'center',
    },
    cancelButtonText: {
        color: Colors.text,
        fontWeight: FontWeights.semibold,
    },
    saveButton: {
        flex: 1,
        paddingVertical: 14,
        borderRadius: BorderRadius.md,
        backgroundColor: Colors.primaryDark,
        alignItems: 'center',
    },
    saveButtonDisabled: {
        opacity: 0.6,
    },
    saveButtonText: {
        color: Colors.surface,
        fontWeight: FontWeights.bold,
    },
    sectionTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.lg,
    },
    loader: {
        marginTop: Spacing.xl,
    },
    historyList: {
        gap: Spacing.md,
        paddingBottom: Spacing.xxl,
    },
    historyItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        backgroundColor: Colors.surface,
        padding: Spacing.lg,
        borderRadius: BorderRadius.md,
    },
    historyDate: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    historyNotes: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
        marginTop: 2,
    },
    historyRight: {
        alignItems: 'flex-end',
    },
    historyWeight: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    historyDelta: {
        fontSize: FontSizes.xs,
        fontWeight: FontWeights.semibold,
        marginTop: 2,
    },
    deltaDown: { color: Colors.primaryDark },
    deltaUp: { color: Colors.error },
    deltaNeutral: { color: Colors.textMuted },
    emptyContainer: {
        alignItems: 'center',
        paddingVertical: 40,
    },
    emptyText: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginBottom: Spacing.xs,
    },
    emptySubtext: {
        fontSize: FontSizes.md,
        color: Colors.textMuted,
    },
});
</file>

<file path="client-app/app/(tabs)/_layout.tsx">
import { View, StyleSheet } from 'react-native';
import { Slot } from 'expo-router';
import { BottomTabBar } from '../../components/BottomTabBar';
import { OfflineBanner } from '../../components/OfflineBanner';

export default function TabsLayout() {
    return (
        <View style={styles.container}>
            <OfflineBanner />
            <View style={styles.content}>
                <Slot />
            </View>
            <BottomTabBar />
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
    },
    content: {
        flex: 1,
    },
});
</file>

<file path="client-app/app/_layout.tsx">
import { Slot } from 'expo-router';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ToastProvider } from '../components/Toast';
import { AuthProvider } from '../contexts/AuthContext';
import { normalizeError } from '../utils/errorHandler';

const queryClient = new QueryClient({
    defaultOptions: {
        queries: {
            staleTime: 30 * 1000,
            retry: (failureCount, error) => {
                const normalized = normalizeError(error);
                if (!normalized.isRetryable) return false;
                return failureCount < 3;
            },
            retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
        },
        mutations: {
            retry: 0,
        },
    },
});

export default function RootLayout() {
    return (
        <QueryClientProvider client={queryClient}>
            <ToastProvider>
                <AuthProvider>
                    <Slot />
                </AuthProvider>
            </ToastProvider>
        </QueryClientProvider>
    );
}
</file>

<file path="client-app/components/BottomTabBar.tsx">
import { View, TouchableOpacity, Text, StyleSheet } from 'react-native';
import { useRouter, usePathname } from 'expo-router';
import { Home, TrendingUp, Bell, User } from 'lucide-react-native';
import { Colors, Spacing, FontSizes, FontWeights } from '../constants/theme';

interface TabItemProps {
    title: string;
    icon: React.ComponentType<{ size: number; color: string }>;
    isActive: boolean;
    onPress: () => void;
}

function TabItem({ title, icon: Icon, isActive, onPress }: TabItemProps) {
    const color = isActive ? Colors.tabActive : Colors.tabInactive;

    return (
        <TouchableOpacity style={styles.tabItem} onPress={onPress} activeOpacity={0.7}>
            <Icon size={24} color={color} />
            <Text style={[styles.tabLabel, { color }]}>{title}</Text>
            {isActive && <View style={styles.activeIndicator} />}
        </TouchableOpacity>
    );
}

const tabs = [
    { name: 'home', title: 'Home', icon: Home, path: '/(tabs)/home' },
    { name: 'progress', title: 'Progress', icon: TrendingUp, path: '/(tabs)/progress' },
    { name: 'notifications', title: 'Inbox', icon: Bell, path: '/(tabs)/notifications' },
    { name: 'profile', title: 'Profile', icon: User, path: '/(tabs)/profile' },
];

export function BottomTabBar() {
    const router = useRouter();
    const pathname = usePathname();

    const getActiveTab = () => {
        for (const tab of tabs) {
            if (pathname.includes(tab.name)) {
                return tab.name;
            }
        }
        return 'home';
    };

    const activeTab = getActiveTab();

    return (
        <View style={styles.container}>
            {tabs.map((tab) => (
                <TabItem
                    key={tab.name}
                    title={tab.title}
                    icon={tab.icon}
                    isActive={activeTab === tab.name}
                    onPress={() => router.push(tab.path as any)}
                />
            ))}
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flexDirection: 'row',
        backgroundColor: Colors.tabBackground,
        borderTopWidth: 1,
        borderTopColor: Colors.border,
        paddingTop: Spacing.sm,
        paddingBottom: 28,
        paddingHorizontal: Spacing.sm,
    },
    tabItem: {
        flex: 1,
        alignItems: 'center',
        justifyContent: 'center',
        paddingVertical: Spacing.sm,
        position: 'relative',
    },
    tabLabel: {
        fontSize: FontSizes.xs,
        fontWeight: FontWeights.medium,
        marginTop: Spacing.xs,
    },
    activeIndicator: {
        position: 'absolute',
        bottom: -4,
        width: 20,
        height: 3,
        backgroundColor: Colors.primary,
        borderRadius: 2,
    },
});
</file>

<file path="client-app/components/MealCard.tsx">
import { View, Text, TouchableOpacity, StyleSheet, Image } from 'react-native';
import { useRouter } from 'expo-router';
import { MealLog } from '../types';
import { Clock, Check, X, MessageCircle, Camera } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights, Shadows, StatusColors } from '../constants/theme';

interface MealCardProps {
    mealLog: MealLog;
}

const mealTypeEmoji: Record<string, string> = {
    breakfast: '🌅',
    lunch: '☀️',
    snack: '🍎',
    dinner: '🌙',
};

export function MealCard({ mealLog }: MealCardProps) {
    const router = useRouter();
    const { meal, status, dietitianFeedback, scheduledTime } = mealLog;
    const config = StatusColors[status];

    const handlePress = () => {
        router.push({
            pathname: '/(tabs)/home/meal/[id]',
            params: { id: mealLog.id },
        });
    };

    return (
        <TouchableOpacity style={styles.container} onPress={handlePress} activeOpacity={0.7}>
            <View style={styles.header}>
                <View style={styles.mealTypeRow}>
                    <Text style={styles.emoji}>{mealTypeEmoji[meal.mealType] || '🍽️'}</Text>
                    <View>
                        <Text style={styles.mealType}>{meal.mealType.charAt(0).toUpperCase() + meal.mealType.slice(1)}</Text>
                        <Text style={styles.time}>{scheduledTime || meal.timeOfDay || '--:--'}</Text>
                    </View>
                </View>
                <View style={[styles.statusBadge, { backgroundColor: config.bg }]}>
                    <Text style={[styles.statusText, { color: config.text }]}>{config.label}</Text>
                </View>
            </View>

            <Text style={styles.mealName}>{meal.name}</Text>

            {meal.description && (
                <Text style={styles.description} numberOfLines={2}>{meal.description}</Text>
            )}

            {/* Macros */}
            <View style={styles.macrosRow}>
                <View style={styles.macroItem}>
                    <Text style={styles.macroValue}>{meal.totalCalories || 0}</Text>
                    <Text style={styles.macroLabel}>kcal</Text>
                </View>
                <View style={styles.macroDot} />
                <View style={styles.macroItem}>
                    <Text style={styles.macroValue}>{meal.totalProteinG || 0}g</Text>
                    <Text style={styles.macroLabel}>protein</Text>
                </View>
                <View style={styles.macroDot} />
                <View style={styles.macroItem}>
                    <Text style={styles.macroValue}>{meal.totalCarbsG || 0}g</Text>
                    <Text style={styles.macroLabel}>carbs</Text>
                </View>
                <View style={styles.macroDot} />
                <View style={styles.macroItem}>
                    <Text style={styles.macroValue}>{meal.totalFatsG || 0}g</Text>
                    <Text style={styles.macroLabel}>fats</Text>
                </View>
            </View>

            {/* Photo preview if logged */}
            {mealLog.mealPhotoUrl && (
                <Image source={{ uri: mealLog.mealPhotoUrl }} style={styles.photoPreview} />
            )}

            {/* Dietitian Feedback */}
            {dietitianFeedback && (
                <View style={styles.feedbackContainer}>
                    <MessageCircle size={14} color={Colors.info} />
                    <Text style={styles.feedbackText} numberOfLines={2}>{dietitianFeedback}</Text>
                </View>
            )}

            {/* Action Button for pending */}
            {status === 'pending' && (
                <TouchableOpacity style={styles.logButton} onPress={handlePress}>
                    <Camera size={18} color={Colors.surface} />
                    <Text style={styles.logButtonText}>Log This Meal</Text>
                </TouchableOpacity>
            )}
        </TouchableOpacity>
    );
}

const styles = StyleSheet.create({
    container: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        padding: Spacing.lg,
        ...Shadows.md,
    },
    header: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'flex-start',
        marginBottom: Spacing.md,
    },
    mealTypeRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 10,
    },
    emoji: {
        fontSize: 28,
    },
    mealType: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    time: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
    },
    statusBadge: {
        paddingHorizontal: 10,
        paddingVertical: Spacing.xs,
        borderRadius: BorderRadius.md,
    },
    statusText: {
        fontSize: FontSizes.xs,
        fontWeight: FontWeights.semibold,
    },
    mealName: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.xs,
    },
    description: {
        fontSize: FontSizes.md,
        color: Colors.textMuted,
        marginBottom: Spacing.md,
        lineHeight: 20,
    },
    macrosRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        marginBottom: Spacing.md,
    },
    macroItem: {
        flexDirection: 'row',
        alignItems: 'baseline',
        gap: 2,
    },
    macroValue: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    macroLabel: {
        fontSize: 11,
        color: Colors.textMuted,
    },
    macroDot: {
        width: 3,
        height: 3,
        borderRadius: 1.5,
        backgroundColor: Colors.border,
    },
    photoPreview: {
        width: '100%',
        height: 120,
        borderRadius: BorderRadius.md,
        marginBottom: Spacing.md,
    },
    feedbackContainer: {
        flexDirection: 'row',
        alignItems: 'flex-start',
        gap: Spacing.sm,
        backgroundColor: '#eef2ff',
        padding: Spacing.md,
        borderRadius: BorderRadius.md,
        marginTop: Spacing.sm,
    },
    feedbackText: {
        flex: 1,
        fontSize: FontSizes.sm,
        color: Colors.info,
        lineHeight: 18,
    },
    logButton: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: Spacing.sm,
        backgroundColor: Colors.primaryDark,
        paddingVertical: Spacing.md,
        borderRadius: BorderRadius.md,
        marginTop: Spacing.md,
    },
    logButtonText: {
        color: Colors.surface,
        fontSize: FontSizes.md,
        fontWeight: FontWeights.bold,
    },
});
</file>

<file path="client-app/constants/theme.ts">
// DietConnect Design Theme Constants
// Based on Figma design reference

import { StyleSheet } from 'react-native';

export const Colors = {
    // Primary colors
    primary: '#13ec5b',      // Bright green - main accent
    primaryDark: '#17cf54',  // Slightly darker green

    // Background colors
    background: '#f8fcf9',   // Light mint background
    surface: '#ffffff',      // White cards/surfaces
    surfaceSecondary: '#e7f3eb', // Light green surface

    // Text colors
    text: '#0d1b12',         // Dark green-black text
    textSecondary: '#4c9a66', // Muted green text
    textMuted: '#6b7280',    // Gray text

    // Border colors
    border: '#cfe7d7',       // Light green border
    borderLight: '#e7f3eb',  // Very light border

    // Status colors
    success: '#17cf54',
    warning: '#f59e0b',
    error: '#ef4444',
    info: '#6366f1',

    // Tab bar
    tabActive: '#0d1b12',
    tabInactive: '#4c9a66',
    tabBackground: '#f8fcf9',
};

export const Spacing = {
    xs: 4,
    sm: 8,
    md: 12,
    lg: 16,
    xl: 20,
    xxl: 24,
    xxxl: 32,
};

export const BorderRadius = {
    sm: 8,
    md: 12,
    lg: 16,
    xl: 20,
    full: 9999,
};

export const FontSizes = {
    xs: 12,
    sm: 13,
    md: 14,
    lg: 16,
    xl: 18,
    xxl: 22,
    xxxl: 28,
    display: 32,
};

export const FontWeights = {
    regular: '400' as const,
    medium: '500' as const,
    semibold: '600' as const,
    bold: '700' as const,
    extrabold: '800' as const,
};

// Shadow presets
export const Shadows = {
    sm: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 1 },
        shadowOpacity: 0.05,
        shadowRadius: 4,
        elevation: 1,
    },
    md: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.05,
        shadowRadius: 8,
        elevation: 2,
    },
    lg: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.1,
        shadowRadius: 12,
        elevation: 4,
    },
};

/** Meal status color presets */
export const StatusColors = {
    pending: { bg: '#fef3c7', text: '#92400e', label: 'Pending' },
    eaten: { bg: '#d1fae5', text: '#065f46', label: 'Logged' },
    skipped: { bg: '#fee2e2', text: '#991b1b', label: 'Skipped' },
    substituted: { bg: '#dbeafe', text: '#1e40af', label: 'Substituted' },
    underReview: { bg: '#fef3c7', text: '#92400e', label: 'Under Review' },
    reviewed: { bg: '#ede9fe', text: '#5b21b6', label: 'Reviewed' },
} as const;

/** Common style presets used across screens */
export const CommonStyles = StyleSheet.create({
    screenContainer: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    card: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        borderWidth: 1,
        borderColor: Colors.border,
        padding: Spacing.lg,
        ...Shadows.md,
    },
    primaryButton: {
        backgroundColor: Colors.primary,
        height: 56,
        borderRadius: BorderRadius.md,
        justifyContent: 'center',
        alignItems: 'center',
    },
    primaryButtonDisabled: {
        backgroundColor: Colors.border,
    },
    primaryButtonText: {
        color: Colors.text,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.bold,
    },
    sectionTitle: {
        fontSize: FontSizes.xxl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
});
</file>

<file path="client-app/contexts/AuthContext.tsx">
import React, { createContext, useCallback, useEffect, useMemo, useState } from 'react';
import { authStore } from '../store/authStore';
import { clientAuthApi } from '../services/api';
import { Client } from '../types';

interface AuthContextValue {
    isAuthenticated: boolean;
    isLoading: boolean;
    client: Client | null;
    login: (phone: string, otp: string) => Promise<void>;
    logout: () => Promise<void>;
    requestOTP: (phone: string) => Promise<void>;
    refreshClient: () => Promise<void>;
}

const AuthContext = createContext<AuthContextValue | null>(null);

export function AuthProvider({ children }: { children: React.ReactNode }) {
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [isLoading, setIsLoading] = useState(true);
    const [client, setClient] = useState<Client | null>(null);

    useEffect(() => {
        checkAuth();
    }, []);

    const checkAuth = async () => {
        try {
            const token = await authStore.getToken();
            const isExpired = await authStore.checkSessionExpiry();

            if (token && !isExpired) {
                const clientData = await authStore.getClientData();
                setClient(clientData);
                setIsAuthenticated(true);
                await authStore.updateLastActivity();
            } else if (token && isExpired) {
                await authStore.removeToken();
                setIsAuthenticated(false);
            }
        } catch (error) {
            console.error('Auth check failed:', error);
        } finally {
            setIsLoading(false);
        }
    };

    const requestOTP = useCallback(async (phone: string) => {
        await clientAuthApi.requestOTP(phone);
    }, []);

    const login = useCallback(async (phone: string, otp: string) => {
        const response = await clientAuthApi.verifyOTP(phone, otp);
        const { token, client: clientData } = response.data.data;

        await authStore.setToken(token);
        await authStore.setClientData(clientData);

        setClient(clientData);
        setIsAuthenticated(true);
    }, []);

    const logout = useCallback(async () => {
        await authStore.removeToken();
        setClient(null);
        setIsAuthenticated(false);
    }, []);

    const refreshClient = useCallback(async () => {
        try {
            const response = await clientAuthApi.getProfile();
            const clientData = response.data.data;
            await authStore.setClientData(clientData);
            setClient(clientData);
        } catch (error) {
            console.error('Failed to refresh client data:', error);
        }
    }, []);

    const value = useMemo(() => ({
        isAuthenticated,
        isLoading,
        client,
        login,
        logout,
        requestOTP,
        refreshClient,
    }), [isAuthenticated, isLoading, client, login, logout, requestOTP, refreshClient]);

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
}

export { AuthContext };
</file>

<file path="client-app/hooks/useAuth.ts">
import { useContext } from 'react';
import { AuthContext } from '../contexts/AuthContext';

export function useAuth() {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error('useAuth must be used within an AuthProvider');
    }
    return context;
}
</file>

<file path="client-app/hooks/useMeals.ts">
import { useQuery } from '@tanstack/react-query';
import { mealLogsApi, clientStatsApi } from '../services/api';

export function useTodayMeals() {
    return useQuery({
        queryKey: ['meals', 'today'],
        queryFn: async () => {
            const { data } = await mealLogsApi.getTodayMeals();
            return data.data;
        },
        staleTime: 15 * 1000,
        refetchOnWindowFocus: true,
    });
}

export function useClientStats() {
    return useQuery({
        queryKey: ['client', 'stats'],
        queryFn: async () => {
            const { data } = await clientStatsApi.getStats();
            return data.data;
        },
        staleTime: 30 * 1000,
        refetchOnWindowFocus: true,
    });
}
</file>

<file path="client-app/store/authStore.ts">
import * as SecureStore from 'expo-secure-store';
import { Client } from '../types';

const TOKEN_KEY = 'auth_token';
const CLIENT_KEY = 'client_data';
const LAST_ACTIVITY_KEY = 'last_activity';

export const authStore = {
    async getToken(): Promise<string | null> {
        try {
            return await SecureStore.getItemAsync(TOKEN_KEY);
        } catch {
            return null;
        }
    },

    async setToken(token: string): Promise<void> {
        await SecureStore.setItemAsync(TOKEN_KEY, token);
        await this.updateLastActivity();
    },

    async removeToken(): Promise<void> {
        await SecureStore.deleteItemAsync(TOKEN_KEY);
        await SecureStore.deleteItemAsync(CLIENT_KEY);
        await SecureStore.deleteItemAsync(LAST_ACTIVITY_KEY);
    },

    async getClientData(): Promise<Client | null> {
        try {
            const data = await SecureStore.getItemAsync(CLIENT_KEY);
            return data ? JSON.parse(data) : null;
        } catch {
            return null;
        }
    },

    async setClientData(client: Client): Promise<void> {
        await SecureStore.setItemAsync(CLIENT_KEY, JSON.stringify(client));
    },

    async updateLastActivity(): Promise<void> {
        await SecureStore.setItemAsync(LAST_ACTIVITY_KEY, Date.now().toString());
    },

    async checkSessionExpiry(): Promise<boolean> {
        try {
            const lastActivity = await SecureStore.getItemAsync(LAST_ACTIVITY_KEY);
            if (!lastActivity) return true;

            const thirtyDaysMs = 30 * 24 * 60 * 60 * 1000;
            const elapsed = Date.now() - parseInt(lastActivity, 10);
            return elapsed > thirtyDaysMs;
        } catch {
            return true;
        }
    },
};
</file>

<file path="client-app/.gitignore">
# Learn more https://docs.github.com/en/get-started/getting-started-with-git/ignoring-files

# Dependencies
node_modules/

# Expo
.expo/
dist/
web-build/
expo-env.d.ts

# Native
.kotlin/
*.orig.*
*.jks
*.p8
*.p12
*.key
*.mobileprovision

# Metro
.metro-health-check*

# Debug
npm-debug.*
yarn-debug.*
yarn-error.*

# OS files
.DS_Store

# Debug
*.pem

# Environment files
.env
.env.local
.env.*.local

# TypeScript
*.tsbuildinfo

# Generated native folders
/ios
/android
</file>

<file path="frontend/src/app/dashboard/analytics/page.tsx">
'use client';

import {
    TrendingUp,
    TrendingDown,
    Users,
    UtensilsCrossed,
    Target,
    Calendar,
    Loader2,
} from 'lucide-react';
import { useDashboardStats } from '@/lib/hooks/use-dashboard';
import { useClients } from '@/lib/hooks/use-clients';

export default function AnalyticsPage() {
    const { data: dashboardData, isLoading: dashboardLoading } = useDashboardStats();
    const { data: clientsData, isLoading: clientsLoading } = useClients({ pageSize: 100 });

    const isLoading = dashboardLoading || clientsLoading;

    const clients = clientsData?.data || [];
    const totalClients = clientsData?.meta?.total || 0;

    // Calculate top performers from client data
    // For now, just show the first 5 clients sorted by name alphabetically
    const topClients = clients.slice(0, 5).map((c) => ({
        name: c.fullName,
        adherence: 80 + Math.floor(Math.random() * 15), // Simulated - would need real progress data
        weightLoss: c.targetWeightKg && c.currentWeightKg
            ? Math.max(0, Number(c.currentWeightKg) - Number(c.targetWeightKg)).toFixed(1)
            : '0'
    }));

    const stats = [
        {
            label: 'Total Clients',
            value: totalClients.toString(),
            change: '+0%',
            trend: 'up' as const,
            icon: Users
        },
        {
            label: 'Active Diet Plans',
            value: (dashboardData?.stats.activeDietPlans || 0).toString(),
            change: '+0%',
            trend: 'up' as const,
            icon: UtensilsCrossed
        },
        {
            label: 'Avg. Adherence Rate',
            value: `${dashboardData?.stats.adherencePercent || 0}%`,
            change: '+0%',
            trend: 'up' as const,
            icon: Target
        },
        {
            label: 'Pending Reviews',
            value: (dashboardData?.stats.pendingReviews || 0).toString(),
            change: '+0%',
            trend: 'down' as const,
            icon: Calendar
        },
    ];

    const weeklyData = dashboardData?.weeklyAdherence || [
        { day: 'Mon', value: 0 },
        { day: 'Tue', value: 0 },
        { day: 'Wed', value: 0 },
        { day: 'Thu', value: 0 },
        { day: 'Fri', value: 0 },
        { day: 'Sat', value: 0 },
        { day: 'Sun', value: 0 },
    ];

    if (isLoading) {
        return (
            <div className="flex items-center justify-center h-64">
                <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
            </div>
        );
    }

    return (
        <div className="space-y-6">
            {/* Header */}
            <div>
                <h1 className="text-3xl font-bold tracking-tight text-gray-900">Progress & Analytics</h1>
                <p className="text-[#4e9767] mt-1">Track your practice performance and client outcomes.</p>
            </div>

            {/* Stats Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                {stats.map((stat, i) => (
                    <div
                        key={i}
                        className="flex flex-col gap-2 rounded-xl border border-gray-200 bg-white p-6"
                    >
                        <div className="flex items-center justify-between">
                            <div className="p-2 rounded-lg bg-[#17cf54]/10">
                                <stat.icon className="w-5 h-5 text-[#17cf54]" />
                            </div>
                            <span
                                className={`text-sm font-medium flex items-center gap-1 ${stat.trend === 'up' ? 'text-green-600' : 'text-red-500'
                                    }`}
                            >
                                {stat.change}
                                {stat.trend === 'up' ? (
                                    <TrendingUp className="w-4 h-4" />
                                ) : (
                                    <TrendingDown className="w-4 h-4" />
                                )}
                            </span>
                        </div>
                        <p className="text-3xl font-bold text-gray-900">{stat.value}</p>
                        <p className="text-sm text-gray-600">{stat.label}</p>
                    </div>
                ))}
            </div>

            {/* Charts Row */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Weekly Adherence Chart */}
                <div className="rounded-xl border border-gray-200 bg-white p-6">
                    <h3 className="mb-6 text-lg font-semibold text-gray-900">Weekly Adherence Trend</h3>
                    <div className="flex h-48 items-end justify-between gap-4">
                        {weeklyData.map((day, i) => (
                            <div key={i} className="flex-1 flex flex-col items-center gap-2">
                                <div
                                    className="w-full bg-[#17cf54] rounded-t transition-all hover:bg-[#17cf54]/80"
                                    style={{ height: `${Math.max(day.value, 5)}%` }}
                                />
                                <div className="text-center">
                                    <p className="text-sm font-bold text-gray-900">{day.value}%</p>
                                    <p className="text-xs text-gray-500">{day.day}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Meal Reviews Summary */}
                <div className="rounded-xl border border-gray-200 bg-white p-6">
                    <h3 className="mb-6 text-lg font-semibold text-gray-900">Review Summary</h3>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-green-50 rounded-lg p-4 text-center">
                            <p className="text-3xl font-bold text-green-600">
                                {dashboardData?.stats.adherencePercent || 0}%
                            </p>
                            <p className="text-sm text-green-700 mt-1">Overall Adherence</p>
                        </div>
                        <div className="bg-orange-50 rounded-lg p-4 text-center">
                            <p className="text-3xl font-bold text-orange-600">
                                {dashboardData?.stats.pendingReviews || 0}
                            </p>
                            <p className="text-sm text-orange-700 mt-1">Pending Reviews</p>
                        </div>
                        <div className="bg-blue-50 rounded-lg p-4 text-center">
                            <p className="text-3xl font-bold text-blue-600">
                                {totalClients}
                            </p>
                            <p className="text-sm text-blue-700 mt-1">Total Clients</p>
                        </div>
                        <div className="bg-purple-50 rounded-lg p-4 text-center">
                            <p className="text-3xl font-bold text-purple-600">
                                {dashboardData?.stats.activeDietPlans || 0}
                            </p>
                            <p className="text-sm text-purple-700 mt-1">Active Plans</p>
                        </div>
                    </div>
                </div>
            </div>

            {/* Top Performers Table */}
            <div className="rounded-xl border border-gray-200 bg-white">
                <div className="p-6 border-b border-gray-100">
                    <h3 className="text-lg font-semibold text-gray-900">Recent Clients</h3>
                </div>
                <div className="overflow-x-auto">
                    {topClients.length === 0 ? (
                        <div className="p-6 text-center text-gray-500">
                            No clients yet. Add your first client!
                        </div>
                    ) : (
                        <table className="w-full">
                            <thead>
                                <tr className="bg-gray-50">
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        #
                                    </th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Client
                                    </th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Adherence
                                    </th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Weight to Goal
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {topClients.map((client, i) => (
                                    <tr key={i} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span className={`inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold ${i === 0 ? 'bg-yellow-100 text-yellow-800' :
                                                i === 1 ? 'bg-gray-100 text-gray-800' :
                                                    i === 2 ? 'bg-orange-100 text-orange-800' :
                                                        'bg-gray-50 text-gray-600'
                                                }`}>
                                                {i + 1}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span className="font-medium text-gray-900">{client.name}</span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="flex items-center gap-2">
                                                <div className="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                    <div
                                                        className="h-full bg-[#17cf54] rounded-full"
                                                        style={{ width: `${client.adherence}%` }}
                                                    />
                                                </div>
                                                <span className="text-sm font-medium text-gray-900">{client.adherence}%</span>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span className="text-[#17cf54] font-medium">{client.weightLoss} kg</span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/clients/page.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import {
    Search,
    Plus,
    ChevronLeft,
    ChevronRight,
    MoreVertical,
    MessageSquare,
    Eye,
    Loader2,
} from 'lucide-react';
import { AddClientModal } from '@/components/modals/add-client-modal';
import { useClients, useCreateClient, Client } from '@/lib/hooks/use-clients';
import { getInitials, formatTimeAgo } from '@/lib/utils/formatters';

type FilterType = 'all' | 'active' | 'at-risk' | 'completed';

export default function ClientsPage() {
    const [filter, setFilter] = useState<FilterType>('all');
    const [search, setSearch] = useState('');
    const [page, setPage] = useState(1);
    const [showAddClientModal, setShowAddClientModal] = useState(false);

    // API hook
    const { data, isLoading, error } = useClients({
        page,
        pageSize: 20,
        search: search || undefined,
        status: filter !== 'all' ? filter : undefined,
    });
    const createClient = useCreateClient();

    const clients = data?.data || [];
    const meta = data?.meta;

    const handleAddClient = async (clientData: { name: string; email: string; phone?: string; dateOfBirth?: string; gender?: string; height?: string; weight?: string; targetWeight?: string }) => {
        try {
            await createClient.mutateAsync({
                fullName: clientData.name,
                email: clientData.email,
                phone: clientData.phone,
                dateOfBirth: clientData.dateOfBirth,
                gender: clientData.gender as Client['gender'],
                heightCm: clientData.height ? Number(clientData.height) : undefined,
                currentWeightKg: clientData.weight ? Number(clientData.weight) : undefined,
                targetWeightKg: clientData.targetWeight ? Number(clientData.targetWeight) : undefined,
            });
            setShowAddClientModal(false);
        } catch (err) {
            console.error('Failed to create client:', err);
        }
    };


    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex flex-wrap items-center justify-between gap-4">
                <h1 className="text-3xl font-bold tracking-tight text-gray-900">Clients</h1>
                <button
                    onClick={() => setShowAddClientModal(true)}
                    className="flex items-center gap-2 h-10 px-4 bg-[#17cf54] hover:bg-[#17cf54]/90 text-white rounded-lg text-sm font-bold transition-colors shadow-sm"
                >
                    <Plus className="w-4 h-4" />
                    Add New Client
                </button>
            </div>

            {/* Search and Filters */}
            <div className="flex flex-col md:flex-row gap-4">
                {/* Search Bar */}
                <div className="flex-grow">
                    <label className="flex h-12 w-full">
                        <div className="flex w-full flex-1 items-stretch rounded-lg h-full bg-gray-100">
                            <div className="flex items-center justify-center pl-4 text-[#17cf54]">
                                <Search className="w-5 h-5" />
                            </div>
                            <input
                                className="flex w-full min-w-0 flex-1 bg-transparent h-full placeholder:text-gray-500 pl-3 pr-4 text-base outline-none text-gray-900"
                                placeholder="Search by name, phone, or email..."
                                value={search}
                                onChange={(e) => {
                                    setSearch(e.target.value);
                                    setPage(1);
                                }}
                            />
                        </div>
                    </label>
                </div>

                {/* Filter Chips */}
                <div className="flex gap-2 items-center flex-wrap">
                    {(['all', 'active', 'at-risk', 'completed'] as FilterType[]).map((f) => (
                        <button
                            key={f}
                            onClick={() => {
                                setFilter(f);
                                setPage(1);
                            }}
                            className={`flex h-8 shrink-0 items-center justify-center px-4 rounded-lg text-sm font-medium capitalize transition-colors ${filter === f
                                ? 'bg-[#17cf54] text-white'
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }`}
                        >
                            {f === 'at-risk' ? 'At Risk' : f}
                        </button>
                    ))}
                </div>
            </div>

            {/* Loading State */}
            {isLoading && (
                <div className="flex items-center justify-center py-12">
                    <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
                </div>
            )}

            {/* Error State */}
            {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
                    Failed to load clients. Please try again.
                </div>
            )}

            {/* Empty State */}
            {!isLoading && !error && clients.length === 0 && (
                <div className="text-center py-12 bg-white rounded-lg border border-gray-200">
                    <p className="text-gray-500">No clients found.</p>
                    <button
                        onClick={() => setShowAddClientModal(true)}
                        className="mt-4 text-[#17cf54] font-medium hover:underline"
                    >
                        Add your first client
                    </button>
                </div>
            )}

            {/* Table */}
            {!isLoading && clients.length > 0 && (
                <div className="overflow-hidden rounded-lg border border-gray-200 bg-white">
                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead>
                                <tr className="bg-gray-50">
                                    <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Client
                                    </th>
                                    <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Phone
                                    </th>
                                    <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Weight (current/goal)
                                    </th>
                                    <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Dietitian
                                    </th>
                                    <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Last Activity
                                    </th>
                                    <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {clients.map((client: Client) => (
                                    <tr key={client.id} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-full bg-[#17cf54]/20 flex items-center justify-center text-[#17cf54] font-bold">
                                                    {getInitials(client.fullName)}
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-medium text-gray-900">{client.fullName}</span>
                                                    {client.status === 'at-risk' && (
                                                        <span className="w-2.5 h-2.5 rounded-full bg-orange-400" title="At risk" />
                                                    )}
                                                </div>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-gray-600">
                                            {client.phone || '-'}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-gray-600">
                                            {client.currentWeightKg || '-'} kg / {client.targetWeightKg || '-'} kg
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-gray-600">
                                            {client.primaryDietitian?.fullName || '-'}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-gray-600">
                                            {client.lastActivityAt ? formatTimeAgo(client.lastActivityAt) : 'N/A'}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="flex items-center gap-2">
                                                <Link
                                                    href={`/dashboard/clients/${client.id}`}
                                                    className="text-[#17cf54] hover:underline text-sm font-medium flex items-center gap-1"
                                                >
                                                    <Eye className="w-4 h-4" />
                                                    View
                                                </Link>
                                                <button className="text-[#17cf54] hover:underline text-sm font-medium flex items-center gap-1">
                                                    <MessageSquare className="w-4 h-4" />
                                                    Message
                                                </button>
                                                <button className="text-gray-500 hover:text-gray-700 p-1">
                                                    <MoreVertical className="w-4 h-4" />
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* Pagination */}
            {meta && (
                <div className="flex items-center justify-between px-1">
                    <p className="text-sm text-gray-600">
                        Showing <span className="font-medium">{(page - 1) * (meta.pageSize || 20) + 1}</span>-
                        <span className="font-medium">{Math.min(page * (meta.pageSize || 20), meta.total)}</span> of{' '}
                        <span className="font-medium">{meta.total}</span> clients
                    </p>
                    <div className="flex items-center gap-2">
                        <button
                            onClick={() => setPage(p => Math.max(1, p - 1))}
                            disabled={page === 1}
                            className="flex items-center justify-center w-9 h-9 rounded-lg border border-gray-300 bg-white hover:bg-gray-100 disabled:opacity-50"
                        >
                            <ChevronLeft className="w-4 h-4" />
                        </button>
                        <button
                            onClick={() => setPage(p => p + 1)}
                            disabled={!meta.hasNextPage && page >= meta.totalPages}
                            className="flex items-center justify-center w-9 h-9 rounded-lg border border-gray-300 bg-white hover:bg-gray-100 disabled:opacity-50"
                        >
                            <ChevronRight className="w-4 h-4" />
                        </button>
                    </div>
                </div>
            )}

            {/* Add Client Modal */}
            <AddClientModal
                isOpen={showAddClientModal}
                onClose={() => setShowAddClientModal(false)}
                onSubmit={handleAddClient}
            />
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/diet-plans/page.tsx">
'use client';

import Link from 'next/link';
import { Plus, Search, FileText, Calendar, MoreVertical, Loader2, Trash2, Edit, Send, LayoutTemplate, Users, X, ChevronRight } from 'lucide-react';
import { useDietPlans, usePublishDietPlan, useAssignTemplate } from '@/lib/hooks/use-diet-plans';
import { useClients } from '@/lib/hooks/use-clients';
import { useState, useRef, useEffect } from 'react';
import { toast } from 'sonner';
import { useRouter } from 'next/navigation';

type TabType = 'plans' | 'templates';

export default function DietPlansPage() {
    const [activeTab, setActiveTab] = useState<TabType>('plans');
    const [search, setSearch] = useState('');
    const [openMenuId, setOpenMenuId] = useState<string | null>(null);

    // Assign Modal State
    const [showAssignModal, setShowAssignModal] = useState(false);
    const [assigningTemplateId, setAssigningTemplateId] = useState<string | null>(null);
    const [clientSearch, setClientSearch] = useState('');
    const [selectedClientId, setSelectedClientId] = useState<string | null>(null);
    const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);

    const menuRef = useRef<HTMLDivElement>(null);
    const router = useRouter();

    // Fetch based on active tab
    const isTemplateView = activeTab === 'templates';
    const { data: plansData, isLoading, refetch } = useDietPlans({
        page: 1,
        pageSize: 20,
        isTemplate: isTemplateView
    });
    const publishMutation = usePublishDietPlan();
    const assignMutation = useAssignTemplate();

    // Fetch clients for assignment modal
    const { data: clientsData } = useClients({
        search: clientSearch,
        pageSize: 10
    });

    const plans = plansData?.data || [];

    const filteredPlans = plans.filter(p => {
        const planName = (p.name || p.title || '').toLowerCase();
        const clientName = (p.client?.fullName || '').toLowerCase();
        const searchLower = search.toLowerCase();
        return planName.includes(searchLower) || clientName.includes(searchLower);
    });

    // Close menu when clicking outside
    useEffect(() => {
        const handleClickOutside = (event: MouseEvent) => {
            if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
                setOpenMenuId(null);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const handlePublish = async (planId: string) => {
        try {
            await publishMutation.mutateAsync(planId);
            await refetch();
            setOpenMenuId(null);
            toast.success('Diet plan published successfully');
        } catch (err) {
            console.error('Failed to publish:', err);
            toast.error('Failed to publish diet plan');
        }
    };

    const handleAssign = async () => {
        if (!assigningTemplateId || !selectedClientId || !startDate) return;

        try {
            const newPlan = await assignMutation.mutateAsync({
                templateId: assigningTemplateId,
                clientId: selectedClientId,
                startDate,
            });

            toast.success('Template assigned successfully!');
            setShowAssignModal(false);
            setAssigningTemplateId(null);
            setSelectedClientId(null);

            // Navigate to the newly created plan
            router.push(`/dashboard/diet-plans/${newPlan.id}`);
        } catch (error) {
            console.error(error);
            toast.error('Failed to assign template');
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <h1 className="text-2xl font-bold text-gray-900">Diet Plans</h1>
                <div className="flex gap-2">
                    {isTemplateView ? (
                        <Link
                            href="/dashboard/diet-plans/new?template=true"
                            className="flex items-center justify-center gap-2 px-4 py-2 bg-[#17cf54] text-white font-medium rounded-lg hover:bg-[#17cf54]/90 transition-colors"
                        >
                            <LayoutTemplate className="w-5 h-5" />
                            Create Template
                        </Link>
                    ) : (
                        <Link
                            href="/dashboard/diet-plans/new"
                            className="flex items-center justify-center gap-2 px-4 py-2 bg-[#17cf54] text-white font-medium rounded-lg hover:bg-[#17cf54]/90 transition-colors"
                        >
                            <Plus className="w-5 h-5" />
                            Create New Plan
                        </Link>
                    )}
                </div>
            </div>

            {/* Tabs */}
            <div className="border-b border-gray-200">
                <nav className="flex gap-4">
                    <button
                        onClick={() => setActiveTab('plans')}
                        className={`py-3 px-1 border-b-2 font-medium text-sm transition-colors ${activeTab === 'plans'
                            ? 'border-[#17cf54] text-[#17cf54]'
                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                            }`}
                    >
                        Client Plans
                    </button>
                    <button
                        onClick={() => setActiveTab('templates')}
                        className={`py-3 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2 ${activeTab === 'templates'
                            ? 'border-[#17cf54] text-[#17cf54]'
                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                            }`}
                    >
                        <LayoutTemplate className="w-4 h-4" />
                        Templates
                    </button>
                </nav>
            </div>

            {/* Search and Filters */}
            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex gap-4">
                <div className="relative flex-grow max-w-md">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                    <input
                        type="text"
                        placeholder={isTemplateView ? "Search templates..." : "Search plans or clients..."}
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#17cf54]/20 focus:border-[#17cf54]"
                    />
                </div>
            </div>

            {/* Plans List */}
            {isLoading ? (
                <div className="flex justify-center py-12">
                    <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
                </div>
            ) : filteredPlans.length === 0 ? (
                <div className="text-center py-12 bg-white rounded-xl border border-gray-200 border-dashed">
                    <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <FileText className="w-8 h-8 text-gray-400" />
                    </div>
                    <h3 className="text-lg font-medium text-gray-900 mb-1">No diet plans found</h3>
                    <p className="text-gray-500 mb-4">Get started by creating a new diet plan for a client.</p>
                </div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {filteredPlans.map((plan) => {
                        const isActive = plan.status === 'active';
                        return (
                            <div key={plan.id} className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow group">
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center text-[#17cf54]">
                                            {isTemplateView ? <LayoutTemplate className="w-5 h-5" /> : <FileText className="w-5 h-5" />}
                                        </div>
                                        <div>
                                            <h3 className="font-semibold text-gray-900 group-hover:text-[#17cf54] transition-colors line-clamp-1">
                                                {plan.name || plan.title || 'Untitled Plan'}
                                            </h3>
                                            <p className="text-sm text-gray-500">
                                                {plan.isTemplate ? (
                                                    <span className="inline-flex items-center gap-1 text-purple-600">
                                                        <LayoutTemplate className="w-3 h-3" />
                                                        Template
                                                    </span>
                                                ) : (
                                                    plan.client?.fullName || 'No Client'
                                                )}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="relative" ref={openMenuId === plan.id ? menuRef : null}>
                                        <button
                                            onClick={() => setOpenMenuId(openMenuId === plan.id ? null : plan.id)}
                                            className="text-gray-400 hover:text-gray-600 p-1 rounded hover:bg-gray-100"
                                        >
                                            <MoreVertical className="w-5 h-5" />
                                        </button>
                                        {openMenuId === plan.id && (
                                            <div className="absolute right-0 top-8 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                                                <Link
                                                    href={`/dashboard/diet-plans/${plan.id}`}
                                                    className="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                                                >
                                                    <Edit className="w-4 h-4" />
                                                    Edit Plan
                                                </Link>
                                                {!isActive && (
                                                    <button
                                                        onClick={() => handlePublish(plan.id)}
                                                        disabled={publishMutation.isPending}
                                                        className="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 w-full text-left disabled:opacity-50"
                                                    >
                                                        <Send className="w-4 h-4" />
                                                        {publishMutation.isPending ? 'Publishing...' : 'Publish'}
                                                    </button>
                                                )}
                                                <button
                                                    className="flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50 w-full text-left"
                                                    onClick={() => {
                                                        // TODO: Add delete functionality
                                                        setOpenMenuId(null);
                                                    }}
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                    Delete
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="space-y-3 mb-6">
                                    <div className="flex items-center text-sm text-gray-600 gap-2">
                                        <Calendar className="w-4 h-4 text-gray-400" />
                                        <span>
                                            {new Date(plan.startDate).toLocaleDateString()}
                                            {plan.endDate ? ` - ${new Date(plan.endDate).toLocaleDateString()}` : ''}
                                        </span>
                                    </div>
                                    <div className="flex gap-2">
                                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${isActive ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                            }`}>
                                            {isActive ? 'Active' : 'Draft'}
                                        </span>
                                    </div>
                                </div>

                                <div className="pt-4 border-t border-gray-100 flex gap-2">
                                    {isTemplateView ? (
                                        <button
                                            onClick={() => {
                                                setAssigningTemplateId(plan.id);
                                                setShowAssignModal(true);
                                            }}
                                            className="flex-1 px-3 py-2 text-sm font-medium text-white bg-[#17cf54] rounded-lg hover:bg-[#17cf54]/90 text-center transition-colors flex items-center justify-center gap-2"
                                        >
                                            <Users className="w-4 h-4" />
                                            Assign to Client
                                        </button>
                                    ) : (
                                        <Link
                                            href={`/dashboard/diet-plans/${plan.id}`}
                                            className="flex-1 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-50 rounded-lg hover:bg-gray-100 text-center transition-colors"
                                        >
                                            View Details
                                        </Link>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}

            {/* Assign Modal */}
            {showAssignModal && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl w-full max-w-lg overflow-hidden shadow-xl">
                        <div className="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <h3 className="font-semibold text-lg text-gray-900">Assign Template to Client</h3>
                            <button
                                onClick={() => {
                                    setShowAssignModal(false);
                                    setAssigningTemplateId(null);
                                    setSelectedClientId(null);
                                }}
                                className="text-gray-400 hover:text-gray-600"
                            >
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        <div className="p-6 space-y-6">
                            {/* Start Date Selection */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Start Date
                                </label>
                                <input
                                    type="date"
                                    value={startDate}
                                    onChange={(e) => setStartDate(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17cf54]/20 focus:border-[#17cf54] outline-none"
                                />
                            </div>

                            {/* Client Selection */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Select Client
                                </label>
                                <div className="relative mb-2">
                                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                                    <input
                                        type="text"
                                        placeholder="Search clients..."
                                        value={clientSearch}
                                        onChange={(e) => setClientSearch(e.target.value)}
                                        className="w-full pl-9 pr-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17cf54]/20 focus:border-[#17cf54] outline-none"
                                    />
                                </div>
                                <div className="border border-gray-200 rounded-lg max-h-60 overflow-y-auto">
                                    {clientsData?.data?.length === 0 ? (
                                        <div className="p-4 text-center text-gray-500 text-sm">
                                            No clients found
                                        </div>
                                    ) : (
                                        <div className="divide-y divide-gray-100">
                                            {clientsData?.data?.map(client => (
                                                <button
                                                    key={client.id}
                                                    onClick={() => setSelectedClientId(client.id)}
                                                    className={`w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors ${selectedClientId === client.id ? 'bg-[#17cf54]/5 ring-1 ring-inset ring-[#17cf54]' : ''
                                                        }`}
                                                >
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-sm font-medium text-gray-600">
                                                            {client.fullName.charAt(0)}
                                                        </div>
                                                        <div className="text-left">
                                                            <div className="font-medium text-gray-900 text-sm">{client.fullName}</div>
                                                            <div className="text-xs text-gray-500">{client.email}</div>
                                                        </div>
                                                    </div>
                                                    {selectedClientId === client.id && (
                                                        <div className="w-2 h-2 rounded-full bg-[#17cf54]" />
                                                    )}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                            <button
                                onClick={() => {
                                    setShowAssignModal(false);
                                    setAssigningTemplateId(null);
                                    setSelectedClientId(null);
                                }}
                                className="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleAssign}
                                disabled={!selectedClientId || !startDate || assignMutation.isPending}
                                className="px-4 py-2 bg-[#17cf54] text-white text-sm font-medium rounded-lg hover:bg-[#17cf54]/90 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {assignMutation.isPending ? (
                                    <>
                                        <Loader2 className="w-4 h-4 animate-spin" />
                                        Assigning...
                                    </>
                                ) : (
                                    <>
                                        Confirm Assignment
                                        <ChevronRight className="w-4 h-4" />
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/referrals/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useApiClient } from '@/lib/api/use-api-client';
import { useAuth } from '@clerk/nextjs';
import {
    Users,
    Gift,
    Award,
    UserPlus,
    Search,
    RefreshCw,
    CheckCircle,
} from 'lucide-react';

interface ReferralStats {
    overview: {
        clientsWithCodes: number;
        referredClients: number;
        totalReferrals: number;
        freeMonthsEarned: number;
        freeMonthsUsed: number;
        freeMonthsPending: number;
    };
    referralSourceBreakdown: Array<{ source: string; count: number }>;
    topReferrers: Array<{
        id: string;
        name: string;
        code: string;
        referralCount: number;
    }>;
}

interface ClientWithReferrals {
    id: string;
    fullName: string;
    email: string;
    phone: string;
    referralSource: string | null;
    referralSourceName: string | null;
    referralCode: string | null;
    referredBy: { id: string; fullName: string } | null;
    referralCount: number;
    benefit: {
        referralCount: number;
        freeMonthsEarned: number;
        freeMonthsUsed: number;
    } | null;
    createdAt: string;
}

const REFERRAL_SOURCE_LABELS: Record<string, string> = {
    doctor: '👨‍⚕️ Doctor',
    dietitian: '🥗 Dietitian',
    client_referral: '👥 Client Referral',
    social_media: '📱 Social Media',
    website: '🌐 Website',
    other: '📋 Other',
};

export default function ReferralsPage() {
    const api = useApiClient();
    const { isLoaded } = useAuth();
    const [stats, setStats] = useState<ReferralStats | null>(null);
    const [clients, setClients] = useState<ClientWithReferrals[]>([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [sourceFilter, setSourceFilter] = useState('');
    const [redeeming, setRedeeming] = useState<string | null>(null);

    useEffect(() => {
        if (isLoaded) {
            fetchData();
        }
    }, [isLoaded, sourceFilter]);

    const fetchData = async () => {
        try {
            const [statsRes, clientsRes] = await Promise.all([
                api.get('/referrals/stats'),
                api.get('/referrals/clients', {
                    params: { source: sourceFilter || undefined, pageSize: 50 },
                }),
            ]);
            setStats(statsRes.data.data);
            setClients(clientsRes.data.data);
        } catch (error) {
            console.error('Failed to fetch referral data:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleRedeem = async (clientId: string) => {
        setRedeeming(clientId);
        try {
            await api.post(`/referrals/clients/${clientId}/redeem`);
            fetchData();
        } catch (error) {
            console.error('Failed to redeem:', error);
        } finally {
            setRedeeming(null);
        }
    };

    const filteredClients = clients.filter(
        (client) =>
            client.fullName.toLowerCase().includes(searchTerm.toLowerCase()) ||
            client.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            client.referralCode?.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (!isLoaded || loading) {
        return (
            <div className="flex items-center justify-center h-64">
                <RefreshCw className="w-8 h-8 animate-spin text-green-500" />
            </div>
        );
    }

    return (
        <div className="p-6 max-w-7xl mx-auto">
            <div className="flex justify-between items-center mb-8">
                <div>
                    <h1 className="text-2xl font-bold text-gray-900">Referral Management</h1>
                    <p className="text-gray-500 mt-1">Track referral sources and client rewards</p>
                </div>
                <button
                    onClick={fetchData}
                    className="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition"
                >
                    <RefreshCw className="w-4 h-4" />
                    Refresh
                </button>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div className="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                    <div className="flex items-center gap-3 mb-2">
                        <div className="p-2 bg-green-100 rounded-lg">
                            <UserPlus className="w-5 h-5 text-green-600" />
                        </div>
                        <span className="text-gray-500 text-sm">Referred Clients</span>
                    </div>
                    <p className="text-3xl font-bold text-gray-900">{stats?.overview.referredClients || 0}</p>
                </div>

                <div className="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                    <div className="flex items-center gap-3 mb-2">
                        <div className="p-2 bg-blue-100 rounded-lg">
                            <Users className="w-5 h-5 text-blue-600" />
                        </div>
                        <span className="text-gray-500 text-sm">Active Referrers</span>
                    </div>
                    <p className="text-3xl font-bold text-gray-900">{stats?.overview.clientsWithCodes || 0}</p>
                </div>

                <div className="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                    <div className="flex items-center gap-3 mb-2">
                        <div className="p-2 bg-purple-100 rounded-lg">
                            <Gift className="w-5 h-5 text-purple-600" />
                        </div>
                        <span className="text-gray-500 text-sm">Free Months Pending</span>
                    </div>
                    <p className="text-3xl font-bold text-gray-900">{stats?.overview.freeMonthsPending || 0}</p>
                </div>

                <div className="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                    <div className="flex items-center gap-3 mb-2">
                        <div className="p-2 bg-yellow-100 rounded-lg">
                            <Award className="w-5 h-5 text-yellow-600" />
                        </div>
                        <span className="text-gray-500 text-sm">Months Redeemed</span>
                    </div>
                    <p className="text-3xl font-bold text-gray-900">{stats?.overview.freeMonthsUsed || 0}</p>
                </div>
            </div>

            {/* Source Breakdown & Top Referrers */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                {/* Source Breakdown */}
                <div className="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                    <h2 className="text-lg font-semibold text-gray-900 mb-4">Referral Sources</h2>
                    <div className="space-y-3">
                        {stats?.referralSourceBreakdown.map((item) => (
                            <div key={item.source} className="flex justify-between items-center">
                                <span className="text-gray-700">
                                    {REFERRAL_SOURCE_LABELS[item.source] || item.source}
                                </span>
                                <span className="font-medium text-gray-900">{item.count}</span>
                            </div>
                        ))}
                        {(!stats?.referralSourceBreakdown || stats.referralSourceBreakdown.length === 0) && (
                            <p className="text-gray-500 text-sm">No referral source data yet</p>
                        )}
                    </div>
                </div>

                {/* Top Referrers */}
                <div className="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                    <h2 className="text-lg font-semibold text-gray-900 mb-4">Top Referrers</h2>
                    <div className="space-y-3">
                        {stats?.topReferrers.slice(0, 5).map((referrer, index) => (
                            <div key={referrer.id} className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <span className={`w-6 h-6 rounded-full flex items-center justify-center text-sm font-medium ${index === 0 ? 'bg-yellow-100 text-yellow-700' :
                                            index === 1 ? 'bg-gray-100 text-gray-700' :
                                                index === 2 ? 'bg-orange-100 text-orange-700' :
                                                    'bg-gray-50 text-gray-500'
                                        }`}>
                                        {index + 1}
                                    </span>
                                    <div>
                                        <p className="font-medium text-gray-900">{referrer.name}</p>
                                        <p className="text-xs text-gray-500">{referrer.code}</p>
                                    </div>
                                </div>
                                <span className="font-semibold text-green-600">{referrer.referralCount}</span>
                            </div>
                        ))}
                        {(!stats?.topReferrers || stats.topReferrers.length === 0) && (
                            <p className="text-gray-500 text-sm">No referrers yet</p>
                        )}
                    </div>
                </div>
            </div>

            {/* Client List */}
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                <div className="p-4 border-b border-gray-200 flex flex-col sm:flex-row gap-4">
                    <div className="relative flex-1">
                        <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                        <input
                            type="text"
                            placeholder="Search clients..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        />
                    </div>
                    <select
                        value={sourceFilter}
                        onChange={(e) => setSourceFilter(e.target.value)}
                        className="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    >
                        <option value="">All Sources</option>
                        {Object.entries(REFERRAL_SOURCE_LABELS).map(([value, label]) => (
                            <option key={value} value={value}>{label}</option>
                        ))}
                    </select>
                </div>

                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase">Client</th>
                                <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase">Source</th>
                                <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase">Code</th>
                                <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase">Referrals</th>
                                <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase">Free Months</th>
                                <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {filteredClients.map((client) => (
                                <tr key={client.id} className="hover:bg-gray-50">
                                    <td className="px-4 py-3">
                                        <p className="font-medium text-gray-900">{client.fullName}</p>
                                        <p className="text-xs text-gray-500">{client.email}</p>
                                    </td>
                                    <td className="px-4 py-3">
                                        {client.referralSource ? (
                                            <span className="text-sm">{REFERRAL_SOURCE_LABELS[client.referralSource] || client.referralSource}</span>
                                        ) : (
                                            <span className="text-gray-400">—</span>
                                        )}
                                        {client.referredBy && (
                                            <p className="text-xs text-green-600">via {client.referredBy.fullName}</p>
                                        )}
                                    </td>
                                    <td className="px-4 py-3">
                                        {client.referralCode ? (
                                            <code className="px-2 py-1 bg-gray-100 rounded text-sm font-mono">{client.referralCode}</code>
                                        ) : (
                                            <span className="text-gray-400">—</span>
                                        )}
                                    </td>
                                    <td className="px-4 py-3">
                                        <span className="font-medium text-gray-900">{client.referralCount}</span>
                                    </td>
                                    <td className="px-4 py-3">
                                        {client.benefit ? (
                                            <div className="text-sm">
                                                <span className="text-green-600">{client.benefit.freeMonthsEarned - client.benefit.freeMonthsUsed}</span>
                                                <span className="text-gray-400"> / {client.benefit.freeMonthsEarned}</span>
                                            </div>
                                        ) : (
                                            <span className="text-gray-400">0</span>
                                        )}
                                    </td>
                                    <td className="px-4 py-3">
                                        {client.benefit && client.benefit.freeMonthsEarned > client.benefit.freeMonthsUsed && (
                                            <button
                                                onClick={() => handleRedeem(client.id)}
                                                disabled={redeeming === client.id}
                                                className="flex items-center gap-1 px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg transition disabled:opacity-50"
                                            >
                                                {redeeming === client.id ? (
                                                    <RefreshCw className="w-3 h-3 animate-spin" />
                                                ) : (
                                                    <CheckCircle className="w-3 h-3" />
                                                )}
                                                Redeem
                                            </button>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>

                {filteredClients.length === 0 && (
                    <div className="text-center py-12">
                        <Users className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                        <p className="text-gray-500">No clients found</p>
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/settings/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import {
    User,
    Bell,
    Shield,
    Palette,
    Globe,
    CreditCard,
    HelpCircle,
    LogOut,
    Check,
    Loader2
} from 'lucide-react';
import { useClerk } from '@clerk/nextjs';
import { useProfile, useUpdateProfile } from '@/lib/hooks/use-profile';
import { toast } from 'sonner';

const settingsSections = [
    { id: 'profile', name: 'Profile', icon: User },
    { id: 'notifications', name: 'Notifications', icon: Bell },
    { id: 'security', name: 'Security', icon: Shield },
    { id: 'appearance', name: 'Appearance', icon: Palette },
    { id: 'language', name: 'Language', icon: Globe },
    { id: 'billing', name: 'Billing', icon: CreditCard },
    { id: 'help', name: 'Help & Support', icon: HelpCircle },
];

export default function SettingsPage() {
    const { signOut } = useClerk();
    const { data: profile, isLoading } = useProfile();
    const updateProfile = useUpdateProfile();

    const [activeSection, setActiveSection] = useState('profile');
    const [notifications, setNotifications] = useState({
        email: true,
        push: true,
        mealReminders: true,
        weeklyReports: false,
    });

    // Form state
    const [formData, setFormData] = useState({
        fullName: '',
        phone: '',
        specialization: '',
        bio: ''
    });

    // Sync form data when profile loads
    useEffect(() => {
        if (profile) {
            setFormData({
                fullName: profile.fullName || '',
                phone: profile.phone || '',
                specialization: profile.specialization || '',
                bio: profile.bio || ''
            });
        }
    }, [profile]);

    const handleProfileUpdate = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            await updateProfile.mutateAsync(formData);
            toast.success('Profile updated successfully');
        } catch {
            toast.error('Failed to update profile');
        }
    };

    if (isLoading) {
        return (
            <div className="flex items-center justify-center min-h-[400px]">
                <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
            </div>
        );
    }

    return (
        <div className="max-w-5xl mx-auto space-y-6">
            {/* Header */}
            <div>
                <h1 className="text-3xl font-bold tracking-tight text-gray-900">Settings</h1>
                <p className="text-[#4e9767] mt-1">Manage your account preferences and settings.</p>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                {/* Settings Navigation */}
                <div className="lg:col-span-1">
                    <nav className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        {settingsSections.map((section) => (
                            <button
                                key={section.id}
                                onClick={() => setActiveSection(section.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3 text-left transition-colors ${activeSection === section.id
                                    ? 'bg-[#17cf54]/10 text-[#17cf54] border-r-2 border-[#17cf54]'
                                    : 'text-gray-600 hover:bg-gray-50'
                                    }`}
                            >
                                <section.icon className="w-5 h-5" />
                                <span className="text-sm font-medium">{section.name}</span>
                            </button>
                        ))}
                        <button
                            onClick={() => signOut()}
                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-red-600 hover:bg-red-50 transition-colors border-t border-gray-100"
                        >
                            <LogOut className="w-5 h-5" />
                            <span className="text-sm font-medium">Sign Out</span>
                        </button>
                    </nav>
                </div>

                {/* Settings Content */}
                <div className="lg:col-span-3">
                    <div className="bg-white rounded-xl border border-gray-200 p-6">
                        {/* Profile Section */}
                        {activeSection === 'profile' && profile && (
                            <div className="space-y-6">
                                <h2 className="text-xl font-semibold text-gray-900">Profile Settings</h2>

                                {/* Avatar */}
                                <div className="flex items-center gap-4">
                                    <div className="w-20 h-20 rounded-full bg-[#17cf54]/20 flex items-center justify-center text-[#17cf54] text-2xl font-bold overflow-hidden">
                                        {profile.profilePhotoUrl ? (
                                            <img src={profile.profilePhotoUrl} alt="Profile" className="w-full h-full object-cover" />
                                        ) : (
                                            profile.fullName?.charAt(0) || 'U'
                                        )}
                                    </div>
                                    <div>
                                        <button disabled className="px-4 py-2 text-sm font-medium bg-gray-100 text-gray-400 rounded-lg cursor-not-allowed">
                                            Change Photo
                                        </button>
                                        <p className="text-sm text-gray-500 mt-1">Managed via Clerk</p>
                                    </div>
                                </div>

                                {/* Form */}
                                <form onSubmit={handleProfileUpdate} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                        <input
                                            type="text"
                                            value={formData.fullName}
                                            onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}
                                            className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                        <input
                                            type="email"
                                            value={profile.email}
                                            disabled
                                            className="w-full px-4 py-2.5 border border-gray-200 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                                        <input
                                            type="tel"
                                            value={formData.phone}
                                            onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                                            className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                            placeholder="+1 234 567 8900"
                                        />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Specialization</label>
                                        <input
                                            type="text"
                                            value={formData.specialization}
                                            onChange={(e) => setFormData({ ...formData, specialization: e.target.value })}
                                            className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                            placeholder="e.g. Sports Nutrition, Weight Loss"
                                        />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                                        <textarea
                                            rows={3}
                                            value={formData.bio}
                                            onChange={(e) => setFormData({ ...formData, bio: e.target.value })}
                                            placeholder="Tell use about yourself..."
                                            className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                                        />
                                    </div>

                                    <div className="md:col-span-2 pt-2">
                                        <button
                                            type="submit"
                                            disabled={updateProfile.isPending}
                                            className="px-4 py-2.5 text-sm font-bold text-white bg-[#17cf54] rounded-lg hover:bg-[#17cf54]/90 transition-colors disabled:opacity-50 flex items-center gap-2"
                                        >
                                            {updateProfile.isPending && <Loader2 className="w-4 h-4 animate-spin" />}
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        )}

                        {/* Notifications Section */}
                        {activeSection === 'notifications' && (
                            <div className="space-y-6">
                                <h2 className="text-xl font-semibold text-gray-900">Notification Preferences</h2>

                                <div className="space-y-4">
                                    {[
                                        { key: 'email', label: 'Email Notifications', desc: 'Receive updates via email' },
                                        { key: 'push', label: 'Push Notifications', desc: 'Browser push notifications' },
                                        { key: 'mealReminders', label: 'Meal Review Reminders', desc: 'Get notified when clients submit meals' },
                                        { key: 'weeklyReports', label: 'Weekly Reports', desc: 'Receive weekly summary reports' },
                                    ].map((item) => (
                                        <div key={item.key} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                            <div>
                                                <p className="font-medium text-gray-900">{item.label}</p>
                                                <p className="text-sm text-gray-500">{item.desc}</p>
                                            </div>
                                            <button
                                                onClick={() => setNotifications({ ...notifications, [item.key]: !notifications[item.key as keyof typeof notifications] })}
                                                className={`w-12 h-6 rounded-full transition-colors ${notifications[item.key as keyof typeof notifications] ? 'bg-[#17cf54]' : 'bg-gray-300'
                                                    }`}
                                            >
                                                <div
                                                    className={`w-5 h-5 bg-white rounded-full shadow transform transition-transform ${notifications[item.key as keyof typeof notifications] ? 'translate-x-6' : 'translate-x-0.5'
                                                        }`}
                                                />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Appearance Section */}
                        {activeSection === 'appearance' && (
                            <div className="space-y-6">
                                <h2 className="text-xl font-semibold text-gray-900">Appearance</h2>

                                <div>
                                    <p className="font-medium text-gray-900 mb-3">Theme</p>
                                    <div className="grid grid-cols-3 gap-4">
                                        {['Light', 'Dark', 'System'].map((theme) => (
                                            <button
                                                key={theme}
                                                className={`p-4 rounded-lg border-2 transition-colors ${theme === 'Light' ? 'border-[#17cf54] bg-[#17cf54]/5' : 'border-gray-200 hover:border-gray-300'
                                                    }`}
                                            >
                                                <div className={`w-8 h-8 rounded-full mx-auto mb-2 ${theme === 'Light' ? 'bg-white border border-gray-200' :
                                                    theme === 'Dark' ? 'bg-gray-800' : 'bg-gradient-to-r from-white to-gray-800'
                                                    }`} />
                                                <p className="text-sm font-medium text-gray-900">{theme}</p>
                                                {theme === 'Light' && <Check className="w-4 h-4 text-[#17cf54] mx-auto mt-1" />}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Other Sections - Placeholder */}
                        {['security', 'language', 'billing', 'help'].includes(activeSection) && (
                            <div className="text-center py-12">
                                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    {(() => {
                                        const section = settingsSections.find(s => s.id === activeSection);
                                        if (section) {
                                            const Icon = section.icon;
                                            return <Icon className="w-8 h-8 text-gray-400" />;
                                        }
                                        return null;
                                    })()}
                                </div>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">
                                    {settingsSections.find(s => s.id === activeSection)?.name}
                                </h3>
                                <p className="text-gray-500">This section is coming soon.</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/team/page.tsx">
'use client';

import {
    Plus,
    MoreVertical,
    Mail,
    Phone,
    Users,
    Loader2,
} from 'lucide-react';
import { useTeam, TeamMember } from '@/lib/hooks/use-team';
import { InviteMemberModal } from '@/components/modals/invite-member-modal';
import { useState } from 'react';

// ...

export default function TeamPage() {
    const { data: team, isLoading, error } = useTeam();
    const [showInviteModal, setShowInviteModal] = useState(false);

    const getRoleBadgeColor = (role: string) => {
        switch (role.toLowerCase()) {
            case 'owner':
                return 'bg-purple-100 text-purple-700';
            case 'admin':
                return 'bg-blue-100 text-blue-700';
            case 'dietitian':
                return 'bg-green-100 text-green-700';
            default:
                return 'bg-gray-100 text-gray-700';
        }
    };

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-bold tracking-tight text-gray-900">Team</h1>
                    <p className="text-[#4e9767] mt-1">Manage your team members and their roles.</p>
                </div>
                <button
                    onClick={() => setShowInviteModal(true)}
                    className="flex items-center gap-2 h-10 px-4 bg-[#17cf54] hover:bg-[#17cf54]/90 text-white rounded-lg text-sm font-bold transition-colors shadow-sm"
                >
                    <Plus className="w-4 h-4" />
                    Invite Team Member
                </button>
            </div>

            {/* Loading */}
            {isLoading && (
                <div className="flex items-center justify-center py-12">
                    <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
                </div>
            )}

            {/* Error */}
            {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
                    Failed to load team members.
                </div>
            )}

            {/* Empty State */}
            {!isLoading && !error && (!team || team.length === 0) && (
                <div className="text-center py-12 bg-white rounded-lg border border-gray-200">
                    <Users className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                    <p className="text-gray-500">No team members yet.</p>
                    <button className="mt-4 text-[#17cf54] font-medium hover:underline">
                        Invite your first team member
                    </button>
                </div>
            )}

            {/* Team Grid */}
            {!isLoading && team && team.length > 0 && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {team.map((member: TeamMember) => (
                        <div
                            key={member.id}
                            className="bg-white rounded-xl border border-gray-200 p-6 hover:shadow-lg transition-shadow"
                        >
                            <div className="flex items-start justify-between mb-4">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 rounded-full bg-[#17cf54]/20 flex items-center justify-center text-[#17cf54] font-bold text-lg">
                                        {member.avatar}
                                    </div>
                                    <div>
                                        <h3 className="font-semibold text-gray-900">{member.name}</h3>
                                        <span className={`inline-block px-2 py-0.5 text-xs font-medium rounded-full ${getRoleBadgeColor(member.role)}`}>
                                            {member.role}
                                        </span>
                                    </div>
                                </div>
                                <button className="text-gray-400 hover:text-gray-600">
                                    <MoreVertical className="w-5 h-5" />
                                </button>
                            </div>

                            {member.specialization && (
                                <p className="text-sm text-gray-600 mb-3">{member.specialization}</p>
                            )}

                            <div className="space-y-2 text-sm">
                                <div className="flex items-center gap-2 text-gray-600">
                                    <Mail className="w-4 h-4" />
                                    <span className="truncate">{member.email}</span>
                                </div>
                                {member.phone && (
                                    <div className="flex items-center gap-2 text-gray-600">
                                        <Phone className="w-4 h-4" />
                                        <span>{member.phone}</span>
                                    </div>
                                )}
                                <div className="flex items-center gap-2 text-gray-600">
                                    <Users className="w-4 h-4" />
                                    <span>{member.clientCount} clients</span>
                                </div>
                            </div>

                            <div className="mt-4 pt-4 border-t border-gray-100 flex gap-2">
                                <button className="flex-1 py-2 text-sm font-medium text-[#17cf54] hover:bg-[#17cf54]/10 rounded-lg transition-colors">
                                    View Profile
                                </button>
                                <button className="flex-1 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                    Message
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
            {/* Invite Modal */}
            <InviteMemberModal isOpen={showInviteModal} onClose={() => setShowInviteModal(false)} />
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/layout.tsx">
'use client';

import { UserButton, useUser } from '@clerk/nextjs';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import {
    LayoutDashboard,
    Users,
    UtensilsCrossed,
    Apple,
    Camera,
    BarChart3,
    UsersRound,
    Settings,
    Menu,
    X,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { useState } from 'react';
import { ErrorBoundary } from '@/components/error-boundary';

const navigation = [
    { name: 'Dashboard', href: '/dashboard', icon: LayoutDashboard },
    { name: 'Clients', href: '/dashboard/clients', icon: Users },
    { name: 'Diet Plans', href: '/dashboard/diet-plans', icon: UtensilsCrossed },
    { name: 'Food Library', href: '/dashboard/food-library', icon: Apple },
    { name: 'Meal Reviews', href: '/dashboard/reviews', icon: Camera },
    { name: 'Analytics', href: '/dashboard/analytics', icon: BarChart3 },
    { name: 'Team', href: '/dashboard/team', icon: UsersRound },
];

export default function DashboardLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    const pathname = usePathname();
    const { user } = useUser();
    const [sidebarOpen, setSidebarOpen] = useState(false);

    return (
        <div className="min-h-screen bg-gray-50">
            {/* Mobile sidebar backdrop */}
            {sidebarOpen && (
                <div
                    className="fixed inset-0 bg-black/50 z-40 lg:hidden"
                    onClick={() => setSidebarOpen(false)}
                />
            )}

            {/* Sidebar */}
            <aside
                className={cn(
                    'fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform transition-transform duration-200 ease-in-out lg:translate-x-0',
                    sidebarOpen ? 'translate-x-0' : '-translate-x-full'
                )}
            >
                <div className="flex flex-col h-full">
                    {/* Logo */}
                    <div className="flex items-center justify-between h-16 px-4 border-b border-gray-200">
                        <Link href="/dashboard" className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-emerald-600 rounded-lg flex items-center justify-center">
                                <UtensilsCrossed className="w-5 h-5 text-white" />
                            </div>
                            <span className="text-xl font-bold text-gray-900">DietConnect</span>
                        </Link>
                        <button
                            className="lg:hidden p-2 text-gray-500 hover:text-gray-700"
                            onClick={() => setSidebarOpen(false)}
                        >
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    {/* Navigation */}
                    <nav className="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
                        {navigation.map((item) => {
                            // Dashboard should only be active on exact match
                            const isActive = item.href === '/dashboard'
                                ? pathname === '/dashboard'
                                : pathname === item.href || pathname.startsWith(item.href + '/');
                            return (
                                <Link
                                    key={item.name}
                                    href={item.href}
                                    className={cn(
                                        'flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors',
                                        isActive
                                            ? 'bg-emerald-50 text-emerald-700'
                                            : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                                    )}
                                >
                                    <item.icon className={cn('w-5 h-5', isActive && 'text-emerald-600')} />
                                    {item.name}
                                </Link>
                            );
                        })}
                    </nav>

                    {/* User section */}
                    <div className="border-t border-gray-200 p-4">
                        <div className="flex items-center gap-3">
                            <UserButton afterSignOutUrl="/" />
                            <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium text-gray-900 truncate">
                                    {user?.fullName || 'Dietitian'}
                                </p>
                                <p className="text-xs text-gray-500 truncate">
                                    {user?.primaryEmailAddress?.emailAddress}
                                </p>
                            </div>
                            <Link href="/dashboard/settings" className="p-2 text-gray-400 hover:text-gray-600">
                                <Settings className="w-5 h-5" />
                            </Link>
                        </div>
                    </div>
                </div>
            </aside>

            {/* Main content */}
            <div className="lg:pl-64">
                {/* Top bar */}
                <header className="sticky top-0 z-30 bg-white border-b border-gray-200 lg:hidden">
                    <div className="flex items-center justify-between h-16 px-4">
                        <button
                            className="p-2 text-gray-500 hover:text-gray-700"
                            onClick={() => setSidebarOpen(true)}
                        >
                            <Menu className="w-6 h-6" />
                        </button>
                        <Link href="/dashboard" className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-emerald-600 rounded-lg flex items-center justify-center">
                                <UtensilsCrossed className="w-5 h-5 text-white" />
                            </div>
                            <span className="text-lg font-bold text-gray-900">DietConnect</span>
                        </Link>
                        <UserButton afterSignOutUrl="/" />
                    </div>
                </header>

                {/* Page content */}
                <main className="p-6"><ErrorBoundary>{children}</ErrorBoundary></main>
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/page.tsx">
'use client';

import { useUser } from '@clerk/nextjs';
import Link from 'next/link';
import {
    Users,
    Camera,
    TrendingUp,
    Calendar,
    Plus,
    ChevronRight,
    Loader2,
} from 'lucide-react';
import { useDashboardStats } from '@/lib/hooks/use-dashboard';
import { formatTimeAgo } from '@/lib/utils/formatters';

export default function DashboardPage() {
    const { user } = useUser();
    const firstName = user?.firstName || 'Doctor';

    const { data, isLoading, error } = useDashboardStats();

    const stats = [
        { label: 'Total Active Clients', value: data?.stats.totalClients ?? '-', icon: Users },
        { label: 'Meals Awaiting Review', value: data?.stats.pendingReviews ?? '-', icon: Camera },
        { label: 'Average Client Adherence', value: data ? `${data.stats.adherencePercent}%` : '-', icon: TrendingUp, highlight: true },
        { label: 'Active Diet Plans', value: data?.stats.activeDietPlans ?? '-', icon: Calendar },
    ];

    const weeklyAdherence = data?.weeklyAdherence || [
        { day: 'Mon', value: 0 },
        { day: 'Tue', value: 0 },
        { day: 'Wed', value: 0 },
        { day: 'Thu', value: 0 },
        { day: 'Fri', value: 0 },
        { day: 'Sat', value: 0 },
        { day: 'Sun', value: 0 },
    ];

    const recentClients = data?.recentClients || [];
    const pendingReviews = data?.pendingReviews || [];

    return (
        <div className="space-y-6">
            {/* Header with Search */}
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-bold tracking-tight text-gray-900">
                        Welcome back, {firstName}!
                    </h1>
                    <p className="text-gray-500 mt-1">Here&apos;s what&apos;s happening with your clients today.</p>
                </div>
                <div className="flex items-center gap-3">
                    <Link
                        href="/dashboard/clients"
                        className="flex items-center gap-2 h-10 px-4 bg-[#17cf54] hover:bg-[#17cf54]/90 text-[#0e1b12] rounded-lg text-sm font-bold transition-colors"
                    >
                        <Plus className="w-4 h-4" />
                        Add New Client
                    </Link>
                    <Link
                        href="/dashboard/diet-plans/new"
                        className="flex items-center gap-2 h-10 px-4 bg-white border border-gray-200 hover:bg-gray-50 text-gray-900 rounded-lg text-sm font-bold transition-colors"
                    >
                        <Plus className="w-4 h-4" />
                        Create Diet Plan
                    </Link>
                </div>
            </div>

            {/* Loading State */}
            {isLoading && (
                <div className="flex items-center justify-center py-12">
                    <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
                </div>
            )}

            {/* Error State */}
            {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
                    Failed to load dashboard data. Please refresh.
                </div>
            )}

            {/* Stats Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                {stats.map((stat, i) => (
                    <div
                        key={i}
                        className="flex flex-col gap-2 rounded-xl border border-gray-200 bg-white p-6"
                    >
                        <div className="flex items-center gap-3">
                            <div className="p-2 rounded-lg bg-[#17cf54]/10">
                                <stat.icon className="w-5 h-5 text-[#17cf54]" />
                            </div>
                            <p className="text-sm font-medium text-gray-600">{stat.label}</p>
                        </div>
                        <p className={`text-3xl font-bold ${stat.highlight ? 'text-[#17cf54]' : 'text-gray-900'}`}>
                            {stat.value}
                        </p>
                    </div>
                ))}
            </div>

            {/* Chart and Activity */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Weekly Adherence Chart */}
                <div className="lg:col-span-2 rounded-xl border border-gray-200 bg-white p-6">
                    <h3 className="mb-6 text-lg font-semibold text-gray-900">Weekly Adherence Overview</h3>
                    <div className="flex h-64 items-end justify-between gap-4">
                        {weeklyAdherence.map((day, i) => (
                            <div key={i} className="flex h-full flex-1 flex-col-reverse items-center gap-2">
                                <p className="text-xs text-gray-500">{day.day}</p>
                                <div className="w-full rounded bg-[#17cf54]/20" style={{ height: `${Math.max(day.value, 5)}%` }}>
                                    <div
                                        className="h-full w-full rounded bg-[#17cf54] transition-all duration-300 hover:opacity-80"
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Pending Reviews */}
                <div className="rounded-xl border border-gray-200 bg-white">
                    <div className="flex items-center justify-between p-4 border-b border-gray-100">
                        <h3 className="font-semibold text-gray-900">Pending Reviews</h3>
                        <Link href="/dashboard/reviews" className="text-sm text-[#17cf54] hover:underline font-medium">
                            View all
                        </Link>
                    </div>
                    <div className="divide-y divide-gray-100">
                        {pendingReviews.length === 0 ? (
                            <div className="p-4 text-center text-gray-500 text-sm">
                                No pending reviews
                            </div>
                        ) : (
                            pendingReviews.map((review) => (
                                <Link
                                    key={review.id}
                                    href={`/dashboard/reviews`}
                                    className="flex items-center justify-between p-4 hover:bg-gray-50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
                                            <Camera className="w-5 h-5 text-orange-600" />
                                        </div>
                                        <div>
                                            <p className="font-medium text-gray-900">{review.client}</p>
                                            <p className="text-sm text-gray-500">{review.meal} • {review.time}</p>
                                        </div>
                                    </div>
                                    <ChevronRight className="w-4 h-4 text-gray-400" />
                                </Link>
                            ))
                        )}
                    </div>
                </div>
            </div>

            {/* Recent Clients */}
            <div className="rounded-xl border border-gray-200 bg-white">
                <div className="flex items-center justify-between p-4 border-b border-gray-100">
                    <h3 className="font-semibold text-gray-900">Recent Clients</h3>
                    <Link href="/dashboard/clients" className="text-sm text-[#17cf54] hover:underline font-medium">
                        View all
                    </Link>
                </div>
                <div className="divide-y divide-gray-100">
                    {recentClients.length === 0 ? (
                        <div className="p-4 text-center text-gray-500 text-sm">
                            No clients yet. Add your first client!
                        </div>
                    ) : (
                        recentClients.map((client) => (
                            <Link
                                key={client.id}
                                href={`/dashboard/clients/${client.id}`}
                                className="flex items-center justify-between p-4 hover:bg-gray-50 transition-colors"
                            >
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-[#17cf54]/20 flex items-center justify-center text-[#17cf54] font-bold">
                                        {client.avatar}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="font-medium text-gray-900">{client.name}</span>
                                        {client.status === 'at-risk' && (
                                            <span className="w-2 h-2 rounded-full bg-orange-500" />
                                        )}
                                        {client.status === 'new' && (
                                            <span className="px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">New</span>
                                        )}
                                    </div>
                                </div>
                                <div className="flex items-center gap-3 text-gray-500">
                                    <span className="text-sm">{formatTimeAgo(client.lastActivity)}</span>
                                    <ChevronRight className="w-4 h-4" />
                                </div>
                            </Link>
                        ))
                    )}
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/app/join/page.tsx">
'use client';

import { Suspense } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { useValidateInvite, useAcceptInvite } from '@/lib/hooks/use-team';
import { useUser, SignInButton } from '@clerk/nextjs';
import { Loader2, AlertCircle, Building2 } from 'lucide-react';
import { toast } from 'sonner';

function JoinContent() {
    const searchParams = useSearchParams();
    const router = useRouter();
    const token = searchParams.get('token');
    const { user, isLoaded } = useUser();

    // Data Fetching
    const { data: invite, isLoading, error } = useValidateInvite(token || '');
    const acceptMutation = useAcceptInvite();

    const handleJoin = async () => {
        if (!token) return;
        try {
            await acceptMutation.mutateAsync(token);
            toast.success('Successfully joined the team!');
            router.push('/dashboard');
        } catch (err: unknown) {
            const message = err instanceof Error ? err.message : 'Failed to join team';
            toast.error(message);
        }
    };

    if (!token) {
        return (
            <div className="flex flex-col items-center justify-center min-h-[50vh] text-center p-6">
                <AlertCircle className="w-12 h-12 text-red-500 mb-4" />
                <h2 className="text-xl font-bold text-gray-900">Invalid Link</h2>
                <p className="text-gray-500 mt-2">This invitation link is missing a token.</p>
            </div>
        );
    }

    if (isLoading || !isLoaded) {
        return (
            <div className="flex flex-col items-center justify-center min-h-[50vh]">
                <Loader2 className="w-8 h-8 animate-spin text-[#17cf54] mb-4" />
                <p className="text-gray-500">Verifying invitation...</p>
            </div>
        );
    }

    if (error) {
        return (
            <div className="flex flex-col items-center justify-center min-h-[50vh] text-center p-6">
                <AlertCircle className="w-12 h-12 text-red-500 mb-4" />
                <h2 className="text-xl font-bold text-gray-900">Invitation Expired or Invalid</h2>
                <p className="text-gray-500 mt-2">This link may have already been used or has expired.</p>
            </div>
        );
    }

    return (
        <div className="max-w-md mx-auto mt-20 p-6 bg-white rounded-2xl shadow-xl border border-gray-100">
            <div className="text-center mb-8">
                <div className="w-16 h-16 bg-[#17cf54]/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Building2 className="w-8 h-8 text-[#17cf54]" />
                </div>
                <h1 className="text-2xl font-bold text-gray-900">Join Team</h1>
                <p className="text-gray-500 mt-2">
                    You have been invited to join <strong>{invite?.orgName}</strong> as a <strong>{invite?.role}</strong>.
                </p>
            </div>

            <div className="space-y-6">
                {!user ? (
                    <div className="space-y-4">
                        <div className="p-4 bg-amber-50 rounded-lg text-amber-800 text-sm border border-amber-200">
                            You need to be logged in to accept this invitation.
                        </div>
                        <SignInButton mode="modal" forceRedirectUrl={`/join?token=${token}`}>
                            <button className="w-full py-3 px-4 bg-[#17cf54] hover:bg-[#17cf54]/90 text-white font-bold rounded-xl transition-all shadow-lg shadow-green-500/20">
                                Sign In / Sign Up to Join
                            </button>
                        </SignInButton>
                    </div>
                ) : (
                    <div className="space-y-4">
                        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                            <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold">
                                {user.firstName?.charAt(0)}
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium text-gray-900 truncate">
                                    Logged in as {user.fullName || user.username}
                                </p>
                                <p className="text-xs text-gray-500 truncate">
                                    {user.primaryEmailAddress?.emailAddress}
                                </p>
                            </div>
                        </div>

                        <button
                            onClick={handleJoin}
                            disabled={acceptMutation.isPending}
                            className="w-full flex items-center justify-center gap-2 py-3 px-4 bg-[#17cf54] hover:bg-[#17cf54]/90 text-white font-bold rounded-xl transition-all shadow-lg shadow-green-500/20 disabled:opacity-50"
                        >
                            {acceptMutation.isPending && <Loader2 className="w-4 h-4 animate-spin" />}
                            Join Organization
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}

export default function JoinPage() {
    return (
        <Suspense fallback={<div>Loading...</div>}>
            <JoinContent />
        </Suspense>
    );
}
</file>

<file path="frontend/src/components/diet-plan/meal-editor.tsx">
'use client';

import { useMemo } from 'react';
import { Trash2, Plus, AlertTriangle, AlertCircle, CheckCircle, GitBranch } from 'lucide-react';
import type { LocalMeal, LocalFoodItem } from '@/lib/types/diet-plan.types';

function getFoodSeverityStyles(food: LocalFoodItem) {
    switch (food.validationSeverity) {
        case 'RED':
            return {
                bgClass: 'bg-red-50 border border-red-300',
                iconEl: <AlertCircle className="w-4 h-4 text-red-500 flex-shrink-0" />,
            };
        case 'YELLOW':
            return {
                bgClass: 'bg-yellow-50 border border-yellow-300',
                iconEl: <AlertTriangle className="w-4 h-4 text-yellow-500 flex-shrink-0" />,
            };
        case 'GREEN':
            return {
                bgClass: 'bg-green-50 border border-green-300',
                iconEl: <CheckCircle className="w-4 h-4 text-green-500 flex-shrink-0" />,
            };
        default:
            return {
                bgClass: food.hasWarning ? 'bg-red-50 border border-red-300' : 'bg-gray-50',
                iconEl: food.hasWarning ? <AlertTriangle className="w-4 h-4 text-red-500 flex-shrink-0" /> : null,
            };
    }
}

function FoodItemRow({
    food,
    mealId,
    onRemoveFood,
    onUpdateFoodQuantity,
}: {
    food: LocalFoodItem;
    mealId: string;
    onRemoveFood: (mealId: string, tempId: string) => void;
    onUpdateFoodQuantity: (mealId: string, tempId: string, val: string) => void;
}) {
    const { bgClass, iconEl } = getFoodSeverityStyles(food);

    return (
        <div>
            <div className={`flex items-center gap-2 p-2 rounded-md ${bgClass}`}>
                {iconEl}
                <span className="text-gray-800 text-sm font-medium flex-grow truncate">{food.name}</span>
                <input
                    type="text"
                    value={food.quantity}
                    onChange={(e) => onUpdateFoodQuantity(mealId, food.tempId, e.target.value)}
                    className="w-24 text-sm text-right p-1 border border-gray-200 rounded-md text-gray-700 bg-white"
                />
                <button
                    onClick={() => onRemoveFood(mealId, food.tempId)}
                    className="p-1 text-gray-400 hover:text-red-500 transition-colors"
                >
                    <Trash2 className="w-4 h-4" />
                </button>
            </div>
            {food.validationAlerts && food.validationAlerts.length > 0 && (
                <p className={`text-xs mt-1 ml-7 ${
                    food.validationSeverity === 'RED' ? 'text-red-600' :
                    food.validationSeverity === 'YELLOW' ? 'text-yellow-600' :
                    'text-green-600'
                }`}>
                    {food.validationAlerts[0].message}
                </p>
            )}
        </div>
    );
}

interface MealEditorProps {
    meals: LocalMeal[];
    onAddMeal: () => void;
    onRemoveMeal: (id: string) => void;
    onOpenAddFood: (mealId: string, optionGroup?: number) => void;
    onRemoveFood: (mealId: string, tempId: string) => void;
    onUpdateFoodQuantity: (mealId: string, tempId: string, val: string) => void;
    onUpdateMealField: (mealId: string, field: 'name' | 'time', value: string) => void;
    onAddAlternative?: (mealId: string) => void;
    onRemoveOption?: (mealId: string, optionGroup: number) => void;
    onUpdateOptionLabel?: (mealId: string, optionGroup: number, label: string) => void;
}

function MealCard({
    meal,
    onRemoveMeal,
    onOpenAddFood,
    onRemoveFood,
    onUpdateFoodQuantity,
    onUpdateMealField,
    onAddAlternative,
    onRemoveOption,
    onUpdateOptionLabel,
}: {
    meal: LocalMeal;
} & Omit<MealEditorProps, 'meals' | 'onAddMeal'>) {
    // Group foods by optionGroup
    const groupedFoods = useMemo(() => {
        const groups = new Map<number, LocalFoodItem[]>();
        meal.foods.forEach(food => {
            const g = food.optionGroup ?? 0;
            if (!groups.has(g)) groups.set(g, []);
            groups.get(g)!.push(food);
        });
        return Array.from(groups.entries()).sort(([a], [b]) => a - b);
    }, [meal.foods]);

    const hasAlternatives = groupedFoods.length > 1;

    // Calculate calories for display (option 0 only when alternatives exist)
    const displayCalories = useMemo(() => {
        if (!hasAlternatives) {
            return meal.foods.reduce((acc, f) => acc + f.calories, 0);
        }
        const option0Foods = meal.foods.filter(f => (f.optionGroup ?? 0) === 0);
        return option0Foods.reduce((acc, f) => acc + f.calories, 0);
    }, [meal.foods, hasAlternatives]);

    return (
        <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
            {/* Meal Header */}
            <div className="flex justify-between items-center mb-3">
                <div className="flex items-center gap-2">
                    <input
                        value={meal.name}
                        onChange={(e) => onUpdateMealField(meal.id, 'name', e.target.value)}
                        className="font-semibold text-gray-900 border-none p-0 focus:ring-0 w-32"
                    />
                    <input
                        type="time"
                        value={meal.time}
                        onChange={(e) => onUpdateMealField(meal.id, 'time', e.target.value)}
                        className="text-sm p-1 border border-gray-200 rounded-md text-gray-700 w-24"
                    />
                </div>
                <div className="flex items-center gap-2">
                    <p className="text-xs font-medium text-gray-500">
                        {displayCalories} Kcal
                    </p>
                    <button onClick={() => onRemoveMeal(meal.id)} className="text-gray-400 hover:text-red-500">
                        <Trash2 className="w-4 h-4" />
                    </button>
                </div>
            </div>

            {/* Food Items — flat list when no alternatives, grouped when alternatives exist */}
            {!hasAlternatives ? (
                <>
                    <div className="space-y-2 mb-3">
                        {meal.foods.map((food) => (
                            <FoodItemRow
                                key={food.tempId}
                                food={food}
                                mealId={meal.id}
                                onRemoveFood={onRemoveFood}
                                onUpdateFoodQuantity={onUpdateFoodQuantity}
                            />
                        ))}
                    </div>
                    <div className="flex gap-2">
                        <button
                            onClick={() => onOpenAddFood(meal.id, 0)}
                            className="flex-grow flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 bg-gray-50 border border-gray-200 rounded-md hover:bg-gray-100 hover:border-gray-300 transition-colors"
                        >
                            <Plus className="w-4 h-4" />
                            Add Food Item
                        </button>
                    </div>
                </>
            ) : (
                <div className="space-y-0">
                    {groupedFoods.map(([optionGroup, foods], idx) => {
                        const optionCalories = foods.reduce((acc, f) => acc + f.calories, 0);
                        const label = foods[0]?.optionLabel || `Option ${String.fromCharCode(65 + idx)}`;
                        const borderColor = idx === 0 ? 'border-l-[#17cf54]' : 'border-l-blue-400';
                        const labelColor = idx === 0 ? 'text-[#17cf54] bg-green-50' : 'text-blue-500 bg-blue-50';

                        return (
                            <div key={optionGroup}>
                                {/* OR divider between options */}
                                {idx > 0 && (
                                    <div className="flex items-center gap-3 my-4">
                                        <div className="flex-grow border-t-2 border-dashed border-gray-300" />
                                        <span className="text-sm font-bold text-gray-400 uppercase tracking-widest px-2">OR</span>
                                        <div className="flex-grow border-t-2 border-dashed border-gray-300" />
                                    </div>
                                )}

                                {/* Option group card */}
                                <div className={`border border-gray-200 border-l-4 ${borderColor} rounded-lg p-3 bg-gray-50/50`}>
                                    {/* Option header */}
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-xs font-bold uppercase px-1.5 py-0.5 rounded ${labelColor}`}>
                                                {String.fromCharCode(65 + idx)}
                                            </span>
                                            <input
                                                value={label}
                                                onChange={(e) => onUpdateOptionLabel?.(meal.id, optionGroup, e.target.value)}
                                                className="text-sm font-semibold text-gray-800 border-none bg-transparent p-0 focus:ring-0 w-36"
                                                placeholder="Option name..."
                                            />
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs font-semibold text-gray-500">{optionCalories} kcal</span>
                                            <button
                                                onClick={() => onRemoveOption?.(meal.id, optionGroup)}
                                                className="p-0.5 text-gray-300 hover:text-red-500 transition-colors"
                                                title="Remove this option"
                                            >
                                                <Trash2 className="w-3.5 h-3.5" />
                                            </button>
                                        </div>
                                    </div>

                                    {/* Food items in this option */}
                                    <div className="space-y-2 mb-2">
                                        {foods.map((food) => (
                                            <FoodItemRow
                                                key={food.tempId}
                                                food={food}
                                                mealId={meal.id}
                                                onRemoveFood={onRemoveFood}
                                                onUpdateFoodQuantity={onUpdateFoodQuantity}
                                            />
                                        ))}
                                    </div>

                                    {/* Add food to this option */}
                                    <button
                                        onClick={() => onOpenAddFood(meal.id, optionGroup)}
                                        className="w-full flex items-center justify-center gap-2 px-3 py-1.5 text-xs font-medium text-gray-500 bg-white border border-gray-200 rounded-md hover:bg-gray-50 hover:border-gray-300 transition-colors"
                                    >
                                        <Plus className="w-3.5 h-3.5" />
                                        Add Food Item
                                    </button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}

            {/* Add Alternative Option button */}
            {onAddAlternative && (
                <button
                    onClick={() => onAddAlternative(meal.id)}
                    className="w-full mt-3 flex items-center justify-center gap-2 px-3 py-2 text-xs font-medium text-gray-400 border border-dashed border-gray-200 rounded-md hover:bg-gray-50 hover:border-[#17cf54] hover:text-[#17cf54] transition-colors"
                >
                    <GitBranch className="w-3.5 h-3.5" />
                    Add Alternative Option
                </button>
            )}
        </div>
    );
}

export function MealEditor({
    meals,
    onAddMeal,
    onRemoveMeal,
    onOpenAddFood,
    onRemoveFood,
    onUpdateFoodQuantity,
    onUpdateMealField,
    onAddAlternative,
    onRemoveOption,
    onUpdateOptionLabel,
}: MealEditorProps) {
    return (
        <div className="space-y-4">
            {meals.length === 0 && (
                <div className="text-center py-8 bg-white rounded-lg border border-gray-200 border-dashed">
                    <p className="text-gray-400 mb-2">No meals for this day</p>
                    <button onClick={onAddMeal} className="text-[#17cf54] font-medium hover:underline">Start adding meals</button>
                </div>
            )}

            {meals.map((meal) => (
                <MealCard
                    key={meal.id}
                    meal={meal}
                    onRemoveMeal={onRemoveMeal}
                    onOpenAddFood={onOpenAddFood}
                    onRemoveFood={onRemoveFood}
                    onUpdateFoodQuantity={onUpdateFoodQuantity}
                    onUpdateMealField={onUpdateMealField}
                    onAddAlternative={onAddAlternative}
                    onRemoveOption={onRemoveOption}
                    onUpdateOptionLabel={onUpdateOptionLabel}
                />
            ))}

            {/* Add Meal Button */}
            <button
                onClick={onAddMeal}
                className="w-full flex items-center justify-center gap-2 py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:bg-gray-50 hover:border-[#17cf54] hover:text-[#17cf54] transition-colors"
            >
                <Plus className="w-5 h-5" />
                <span className="text-sm font-medium">Add another meal</span>
            </button>
        </div>
    );
}
</file>

<file path="frontend/src/components/diet-plan/nutrition-summary.tsx">
'use client';

import { useState, useEffect, useRef } from 'react';
import { AlertTriangle, Pencil, Check } from 'lucide-react';
import { toast } from 'sonner';
import type { DayNutrition } from '@/lib/types/diet-plan.types';

interface NutritionTargets {
    calories: number;
    protein: number;
    carbs: number;
    fat: number;
}

interface NutritionSummaryProps {
    dayNutrition: DayNutrition;
    targets: NutritionTargets;
    hasAllergyWarning: boolean;
    onTargetsChange?: (targets: NutritionTargets) => void;
}

const FIELD_CONFIG: { key: keyof NutritionTargets; label: string; unit: string; min: number; max: number }[] = [
    { key: 'calories', label: 'Calories', unit: 'kcal', min: 500, max: 10000 },
    { key: 'protein', label: 'Protein', unit: 'g', min: 0, max: 500 },
    { key: 'carbs', label: 'Carbs', unit: 'g', min: 0, max: 1000 },
    { key: 'fat', label: 'Fat', unit: 'g', min: 0, max: 500 },
];

export function NutritionSummary({ dayNutrition, targets, hasAllergyWarning, onTargetsChange }: NutritionSummaryProps) {
    const [editing, setEditing] = useState(false);
    const [draft, setDraft] = useState<NutritionTargets>(targets);

    // Toast when any nutrient exceeds target (non-blocking, once per field)
    const toastedRef = useRef<Set<string>>(new Set());
    useEffect(() => {
        FIELD_CONFIG.forEach(({ key, label, unit }) => {
            const value = dayNutrition[key];
            const target = targets[key];
            if (target > 0 && value > target && !toastedRef.current.has(key)) {
                toastedRef.current.add(key);
                toast.warning(`${label} is over target: ${Math.round(value)} / ${target} ${unit}`);
            }
            // Reset if it goes back under so it can fire again
            if (target > 0 && value <= target) {
                toastedRef.current.delete(key);
            }
        });
    }, [dayNutrition, targets]);

    const startEdit = () => {
        setDraft(targets);
        setEditing(true);
    };

    const saveEdit = () => {
        onTargetsChange?.(draft);
        setEditing(false);
    };

    return (
        <aside className="col-span-3 flex flex-col gap-4 overflow-y-auto pl-2">
            {/* Allergy Warning */}
            {hasAllergyWarning && (
                <div className="bg-red-50 border border-red-300 p-4 rounded-lg">
                    <div className="flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 text-red-500 mt-0.5" />
                        <div>
                            <h4 className="font-bold text-red-700">Allergy Warning</h4>
                            <p className="text-sm text-red-600">
                                One or more food items conflict with the client&apos;s allergies.
                            </p>
                        </div>
                    </div>
                </div>
            )}

            {/* Nutrition Summary */}
            <div className="bg-white p-4 rounded-lg border border-gray-200 sticky top-0">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-gray-900 font-medium">Daily Summary</h3>
                    <div className="flex items-center gap-2">
                        <span className="text-xs text-gray-500">Target: {targets.calories} Kcal</span>
                        {onTargetsChange && (
                            editing ? (
                                <button
                                    onClick={saveEdit}
                                    className="p-1 rounded hover:bg-green-50 text-green-600"
                                    title="Save targets"
                                >
                                    <Check className="w-3.5 h-3.5" />
                                </button>
                            ) : (
                                <button
                                    onClick={startEdit}
                                    className="p-1 rounded hover:bg-gray-100 text-gray-400"
                                    title="Edit targets"
                                >
                                    <Pencil className="w-3.5 h-3.5" />
                                </button>
                            )
                        )}
                    </div>
                </div>

                {editing ? (
                    <div className="space-y-3">
                        {FIELD_CONFIG.map(({ key, label, unit, min, max }) => (
                            <div key={key}>
                                <label className="text-xs font-medium text-gray-600 mb-1 block">{label} ({unit})</label>
                                <input
                                    type="number"
                                    min={min}
                                    max={max}
                                    value={draft[key]}
                                    onChange={e => setDraft(prev => ({ ...prev, [key]: Number(e.target.value) || 0 }))}
                                    className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-1 focus:ring-[#17cf54] focus:border-[#17cf54] outline-none"
                                />
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="space-y-4">
                        {FIELD_CONFIG.map(({ key, label, unit }) => {
                            const value = dayNutrition[key];
                            const target = targets[key] || 100;
                            const rawPercent = target > 0 ? (value / target) * 100 : 0;
                            const isOver = rawPercent > 100;
                            const barWidth = Math.min(rawPercent, 100);
                            return (
                                <div key={key}>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="font-medium text-gray-800">{label}</span>
                                        <span className={`font-medium ${isOver ? 'text-red-600' : 'text-gray-600'}`}>
                                            {Math.round(value)} / {target} {unit}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                        <div
                                            className={`h-2 rounded-full transition-all ${isOver ? 'bg-red-500' : 'bg-[#17cf54]'}`}
                                            style={{ width: `${barWidth}%` }}
                                        />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        </aside>
    );
}
</file>

<file path="frontend/src/components/modals/invite-member-modal.tsx">
'use client';

import { useState } from 'react';
import { Modal } from '@/components/ui/modal';
import { useInviteMember } from '@/lib/hooks/use-team';
import { Loader2, Mail, Check, Copy } from 'lucide-react';
import { toast } from 'sonner';

interface InviteMemberModalProps {
    isOpen: boolean;
    onClose: () => void;
}

export function InviteMemberModal({ isOpen, onClose }: InviteMemberModalProps) {
    const inviteMutation = useInviteMember();

    const [email, setEmail] = useState('');
    const [role, setRole] = useState('dietitian');
    const [inviteLink, setInviteLink] = useState<string | null>(null);
    const [copied, setCopied] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            const data = await inviteMutation.mutateAsync({ email, role });
            // content.data.inviteLink contains the real link from backend, but let's use window.location.origin to be safe about ports
            const token = data.invitation.token;
            const link = `${window.location.origin}/join?token=${token}`;
            setInviteLink(link);
            toast.success('Invitation generated! Share the link.');
        } catch {
            toast.error('Failed to generate invitation');
        }
    };

    const copyToClipboard = () => {
        if (inviteLink) {
            navigator.clipboard.writeText(inviteLink);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
            toast.success('Link copied to clipboard');
        }
    };

    const handleClose = () => {
        setInviteLink(null);
        setEmail('');
        setRole('dietitian');
        onClose();
    };

    return (
        <Modal isOpen={isOpen} onClose={handleClose} title="Invite Team Member" size="md">
            {!inviteLink ? (
                <form onSubmit={handleSubmit} className="space-y-4 p-4">
                    <p className="text-sm text-gray-500">
                        Send an invitation to a new team member. They will receive an email (simulated) or you can copy the link.
                    </p>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <div className="relative">
                            <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                            <input
                                required
                                type="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                className="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                                placeholder="colleague@example.com"
                            />
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select
                            value={role}
                            onChange={(e) => setRole(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        >
                            <option value="admin">Admin</option>
                            <option value="dietitian">Dietitian</option>
                        </select>
                    </div>

                    <div className="flex justify-end pt-2 gap-2">
                        <button
                            type="button"
                            onClick={handleClose}
                            className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={inviteMutation.isPending}
                            className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 disabled:opacity-50"
                        >
                            {inviteMutation.isPending && <Loader2 className="w-4 h-4 animate-spin" />}
                            Generate Invite
                        </button>
                    </div>
                </form>
            ) : (
                <div className="p-6 space-y-4">
                    <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto text-green-600">
                        <Check className="w-6 h-6" />
                    </div>
                    <div className="text-center">
                        <h3 className="text-lg font-medium text-gray-900">Invitation Ready!</h3>
                        <p className="text-sm text-gray-500 mt-1">
                            Share this link with <strong>{email}</strong> to join the team.
                        </p>
                    </div>

                    <div className="flex gap-2">
                        <input
                            readOnly
                            value={inviteLink}
                            className="flex-grow bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm text-gray-600 font-mono"
                        />
                        <button
                            onClick={copyToClipboard}
                            className="flex items-center gap-2 px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors"
                        >
                            {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                        </button>
                    </div>

                    <button
                        onClick={handleClose}
                        className="w-full py-2 text-sm font-medium text-gray-600 hover:text-gray-900"
                    >
                        Close
                    </button>
                </div>
            )}
        </Modal>
    );
}
</file>

<file path="frontend/src/lib/hooks/use-food-items.ts">
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useApiClient } from '../api/use-api-client';

// Types
export interface FoodItem {
    id: string;
    name: string;
    brand?: string;
    category: string;
    subCategory?: string;
    servingSize: string;
    isGlobal: boolean;
    isVerified: boolean;
    nutrition: {
        calories: number;
        proteinG: number | null;
        carbsG: number | null;
        fatsG: number | null;
        fiberG: number | null;
    };
    allergenFlags: string[];
    dietaryTags: string[];
    barcode?: string;
}

interface FoodItemsParams {
    page?: number;
    pageSize?: number;
    q?: string;
    category?: string;
}

// Hooks
export function useFoodItems(params: FoodItemsParams = {}) {
    const api = useApiClient();
    const { page = 1, pageSize = 50, q, category } = params;

    return useQuery({
        queryKey: ['food-items', page, pageSize, q, category],
        queryFn: async () => {
            const { data } = await api.get('/food-items', {
                params: { page, pageSize, q, category },
            });
            return data;
        },
    });
}

export function useFoodItem(id: string) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['food-items', id],
        queryFn: async () => {
            const { data } = await api.get(`/food-items/${id}`);
            return data.data as FoodItem;
        },
        enabled: !!id,
    });
}

export interface CreateFoodItemInput {
    name: string;
    brand?: string;
    category: string;
    subCategory?: string;
    servingSizeG: number;
    calories: number;
    proteinG: number;
    carbsG: number;
    fatsG: number;
    fiberG?: number;
    sugarG?: number;
    sodiumMg?: number;
    dietaryTags?: string[];
    allergenFlags?: string[];
    nutrition?: never; // Ensure we don't accidentally use this
}

export function useCreateFoodItem() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (foodData: CreateFoodItemInput) => {
            const { data } = await api.post('/food-items', foodData);
            return data.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['food-items'] });
        }
    });
}

export type UpdateFoodItemInput = Partial<CreateFoodItemInput> & { id: string };

export function useUpdateFoodItem() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (data: UpdateFoodItemInput) => {
            const { id, ...updateData } = data;
            const { data: response } = await api.patch(`/food-items/${id}`, updateData);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['food-items'] });
        }
    });
}
</file>

<file path="frontend/src/lib/hooks/use-meal-builder.ts">
'use client';

import { useState, useCallback, useMemo } from 'react';
import { useApiClient } from '../api/use-api-client';
import { useCreateDietPlan, usePublishDietPlan, CreateDietPlanInput } from './use-diet-plans';
import { toast } from 'sonner';
import type { LocalMeal, LocalFoodItem, DayNutrition, ClientData, FoodItemData } from '../types/diet-plan.types';

// Re-export types used by components
export type { LocalMeal, LocalFoodItem, DayNutrition };

interface UseMealBuilderOptions {
    clientId: string | null;
    isTemplateMode: boolean;
    client: ClientData | null | undefined;
    onSaved: (isTemplate: boolean, published: boolean) => void;
}

// Helper to generate dates for keys
export const getDates = (startDate: Date, days: number) => {
    return Array.from({ length: days }, (_, i) => {
        const d = new Date(startDate);
        d.setDate(d.getDate() + i);
        return {
            date: d,
            label: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
            day: d.toLocaleDateString('en-US', { weekday: 'short' })
        };
    });
};

export function useMealBuilder({ clientId, isTemplateMode, client, onSaved }: UseMealBuilderOptions) {
    const api = useApiClient();
    const createMutation = useCreateDietPlan();
    const publishMutation = usePublishDietPlan();

    // State
    const [startDate, setStartDate] = useState(new Date());
    const [selectedDayIndex, setSelectedDayIndex] = useState(0);
    const [planName, setPlanName] = useState(isTemplateMode ? 'New Template' : 'New Diet Plan');
    const [planDescription, setPlanDescription] = useState('');
    const [weeklyMeals, setWeeklyMeals] = useState<Record<number, LocalMeal[]>>({
        0: [
            { id: '1', name: 'Breakfast', type: 'breakfast', time: '08:00', foods: [] },
            { id: '2', name: 'Lunch', type: 'lunch', time: '13:00', foods: [] },
            { id: '3', name: 'Dinner', type: 'dinner', time: '19:30', foods: [] },
        ]
    });
    const [showAddFoodModal, setShowAddFoodModal] = useState(false);
    const [activeMealId, setActiveMealId] = useState<string | null>(null);
    const [activeOptionGroup, setActiveOptionGroup] = useState<number>(0);
    const [applyingTemplateId, setApplyingTemplateId] = useState<string | null>(null);

    const planDates = getDates(startDate, 7);
    const currentMeals = useMemo(() => weeklyMeals[selectedDayIndex] || [], [weeklyMeals, selectedDayIndex]);

    // Handlers
    const addMeal = useCallback(() => {
        const newMeal: LocalMeal = {
            id: Math.random().toString(36).substr(2, 9),
            name: 'Snack',
            type: 'snack',
            time: '16:00',
            foods: []
        };
        setWeeklyMeals(prev => ({
            ...prev,
            [selectedDayIndex]: [...(prev[selectedDayIndex] || []), newMeal]
        }));
    }, [selectedDayIndex]);

    const removeMeal = useCallback((id: string) => {
        setWeeklyMeals(prev => ({
            ...prev,
            [selectedDayIndex]: (prev[selectedDayIndex] || []).filter(m => m.id !== id)
        }));
    }, [selectedDayIndex]);

    const openAddFood = useCallback((mealId: string, optionGroup: number = 0) => {
        setActiveMealId(mealId);
        setActiveOptionGroup(optionGroup);
        setShowAddFoodModal(true);
    }, []);

    const addFood = useCallback((food: FoodItemData) => {
        if (!activeMealId) return;

        const newFood: LocalFoodItem = {
            id: food.id,
            tempId: Math.random().toString(36).substr(2, 9),
            name: food.name,
            quantity: '1 serving',
            quantityValue: 100,
            calories: food.calories,
            protein: food.protein,
            carbs: food.carbs,
            fat: food.fat,
            hasWarning: food.validationSeverity === 'RED' || food.validationSeverity === 'YELLOW' ||
                client?.medicalProfile?.allergies?.some((a: string) => food.name.toLowerCase().includes(a.toLowerCase())) || false,
            validationSeverity: food.validationSeverity,
            validationAlerts: food.validationAlerts,
            optionGroup: activeOptionGroup,
        };

        setWeeklyMeals(prev => ({
            ...prev,
            [selectedDayIndex]: (prev[selectedDayIndex] || []).map(m => {
                if (m.id === activeMealId) {
                    return { ...m, foods: [...m.foods, newFood] };
                }
                return m;
            })
        }));
        setShowAddFoodModal(false);
    }, [activeMealId, selectedDayIndex, client]);

    const removeFood = useCallback((mealId: string, tempId: string) => {
        setWeeklyMeals(prev => ({
            ...prev,
            [selectedDayIndex]: (prev[selectedDayIndex] || []).map(m => {
                if (m.id === mealId) {
                    return { ...m, foods: m.foods.filter(f => f.tempId !== tempId) };
                }
                return m;
            })
        }));
    }, [selectedDayIndex]);

    const updateFoodQuantity = useCallback((mealId: string, tempId: string, val: string) => {
        setWeeklyMeals(prev => ({
            ...prev,
            [selectedDayIndex]: (prev[selectedDayIndex] || []).map(m => {
                if (m.id === mealId) {
                    return { ...m, foods: m.foods.map(f => f.tempId === tempId ? { ...f, quantity: val } : f) };
                }
                return m;
            })
        }));
    }, [selectedDayIndex]);

    const updateMealField = useCallback((mealId: string, field: 'name' | 'time', value: string) => {
        setWeeklyMeals(prev => ({
            ...prev,
            [selectedDayIndex]: prev[selectedDayIndex].map(m => m.id === mealId ? { ...m, [field]: value } : m)
        }));
    }, [selectedDayIndex]);

    // Option group actions
    const addMealOption = useCallback((mealId: string) => {
        const meals = weeklyMeals[selectedDayIndex] || [];
        const meal = meals.find(m => m.id === mealId);
        if (!meal) return;

        // Find the next optionGroup number
        const maxGroup = meal.foods.length > 0
            ? Math.max(...meal.foods.map(f => f.optionGroup))
            : -1;
        const newGroup = maxGroup + 1;

        // Auto-label existing option 0 foods as "Option A" if not already labeled
        if (newGroup === 1) {
            setWeeklyMeals(prev => ({
                ...prev,
                [selectedDayIndex]: (prev[selectedDayIndex] || []).map(m => {
                    if (m.id !== mealId) return m;
                    return {
                        ...m,
                        foods: m.foods.map(f =>
                            f.optionGroup === 0 && !f.optionLabel
                                ? { ...f, optionLabel: 'Option A' }
                                : f
                        )
                    };
                })
            }));
        }

        // Open add food modal targeting the new group
        setActiveMealId(mealId);
        setActiveOptionGroup(newGroup);
        setShowAddFoodModal(true);
    }, [weeklyMeals, selectedDayIndex]);

    const removeOption = useCallback((mealId: string, optionGroup: number) => {
        setWeeklyMeals(prev => ({
            ...prev,
            [selectedDayIndex]: (prev[selectedDayIndex] || []).map(m => {
                if (m.id !== mealId) return m;
                const remaining = m.foods.filter(f => f.optionGroup !== optionGroup);
                // If only one option group left, clear all labels
                const groups = new Set(remaining.map(f => f.optionGroup));
                if (groups.size <= 1) {
                    return { ...m, foods: remaining.map(f => ({ ...f, optionLabel: undefined })) };
                }
                return { ...m, foods: remaining };
            })
        }));
    }, [selectedDayIndex]);

    const updateOptionLabel = useCallback((mealId: string, optionGroup: number, label: string) => {
        setWeeklyMeals(prev => ({
            ...prev,
            [selectedDayIndex]: (prev[selectedDayIndex] || []).map(m => {
                if (m.id !== mealId) return m;
                return {
                    ...m,
                    foods: m.foods.map(f =>
                        f.optionGroup === optionGroup ? { ...f, optionLabel: label } : f
                    )
                };
            })
        }));
    }, [selectedDayIndex]);

    // Nutrition calculation — only count option 0 for day totals (client eats one option)
    const dayNutrition = useMemo<DayNutrition>(() => {
        let calories = 0, protein = 0, carbs = 0, fat = 0;
        currentMeals.forEach(m => {
            const hasAlternatives = m.foods.some(f => f.optionGroup > 0);
            const foodsToCount = hasAlternatives
                ? m.foods.filter(f => f.optionGroup === 0)
                : m.foods;
            foodsToCount.forEach(f => {
                calories += f.calories;
                protein += f.protein;
                carbs += f.carbs;
                fat += f.fat;
            });
        });
        return { calories, protein, carbs, fat };
    }, [currentMeals]);

    const [targets, setTargets] = useState(() => ({
        calories: Number(client?.targetCalories) || (client?.targetWeightKg ? Math.round(Number(client.targetWeightKg) * 30) : 2000),
        protein: Number(client?.targetProteinG) || 150,
        carbs: Number(client?.targetCarbsG) || 200,
        fat: Number(client?.targetFatsG) || 70,
    }));

    // Apply template
    const applyTemplate = useCallback(async (templateId: string) => {
        if (!confirm('This will replace all current meal entries with the selected template. Continue?')) return;

        setApplyingTemplateId(templateId);
        try {
            const { data } = await api.get(`/diet-plans/${templateId}`);
            const template = data.data;

            if (!template.meals || template.meals.length === 0) {
                toast.error('Template has no meals');
                return;
            }

            const mealsByDay: Record<number, Record<string, unknown>[]> = {};
            let minDay = Infinity;

            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            template.meals.forEach((tm: any) => {
                const d = typeof tm.dayOfWeek === 'string' ? parseInt(tm.dayOfWeek) : tm.dayOfWeek;
                if (!isNaN(d)) {
                    if (d < minDay) minDay = d;
                    if (!mealsByDay[d]) mealsByDay[d] = [];
                    mealsByDay[d].push(tm);
                }
            });

            if (minDay === Infinity) minDay = 0;

            const newWeeklyMeals: Record<number, LocalMeal[]> = {};

            Object.entries(mealsByDay).forEach(([dayStr, dayMeals]) => {
                const originalDay = parseInt(dayStr);
                const normalizedDay = originalDay - minDay;

                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                newWeeklyMeals[normalizedDay] = dayMeals.map((tm: any) => {
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    const localFoods: LocalFoodItem[] = tm.foodItems?.map((f: any) => {
                        const ratio = (f.quantityG || 100) / 100;
                        return {
                            id: f.foodItem.id,
                            tempId: Math.random().toString(36).substr(2, 9),
                            name: f.foodItem.name,
                            quantity: f.notes || `${f.quantityG}g`,
                            quantityValue: f.quantityG || 100,
                            calories: f.foodItem.calories * ratio,
                            protein: f.foodItem.protein * ratio,
                            carbs: f.foodItem.carbs * ratio,
                            fat: f.foodItem.fat * ratio,
                            hasWarning: client?.medicalProfile?.allergies?.some((a: string) => f.foodItem.name.toLowerCase().includes(a.toLowerCase())) || false,
                            optionGroup: f.optionGroup ?? 0,
                            optionLabel: f.optionLabel ?? undefined,
                        };
                    }) || [];

                    return {
                        id: Math.random().toString(36).substr(2, 9),
                        name: tm.name || tm.mealType,
                        type: tm.mealType,
                        time: tm.timeOfDay,
                        foods: localFoods
                    };
                });
            });

            setWeeklyMeals(newWeeklyMeals);

            if (!newWeeklyMeals[selectedDayIndex]) {
                const firstDay = Object.keys(newWeeklyMeals).map(Number).sort((a, b) => a - b)[0];
                if (firstDay !== undefined && firstDay !== selectedDayIndex) {
                    setSelectedDayIndex(firstDay);
                }
            }

            toast.success('Template applied successfully');
        } catch (error) {
            console.error(error);
            toast.error('Failed to apply template');
        } finally {
            setApplyingTemplateId(null);
        }
    }, [api, client, selectedDayIndex]);

    // Save / Publish
    const save = useCallback(async (publish: boolean) => {
        const apiMeals: CreateDietPlanInput['meals'] = [];

        Object.entries(weeklyMeals).forEach(([dayIdx, dayMeals]) => {
            dayMeals.forEach(m => {
                apiMeals.push({
                    dayIndex: parseInt(dayIdx),
                    mealType: m.type,
                    timeOfDay: m.time,
                    title: m.name,
                    foodItems: m.foods.map(f => ({
                        foodId: f.id,
                        quantity: f.quantityValue,
                        notes: f.quantity,
                        optionGroup: f.optionGroup,
                        optionLabel: f.optionLabel,
                    }))
                });
            });
        });

        if (apiMeals.length === 0) {
            toast.error('Add at least one meal to the plan');
            return;
        }

        // Block publish if any food has RED validation alerts
        if (publish) {
            const hasRedAlert = Object.values(weeklyMeals).some(dayMeals =>
                dayMeals.some(m => m.foods.some(f => f.validationSeverity === 'RED'))
            );
            if (hasRedAlert) {
                toast.error('Cannot publish: some foods have blocking validation alerts. Remove or replace them first.');
                return;
            }
        }

        try {
            const createdPlan = await createMutation.mutateAsync({
                clientId: clientId || undefined,
                title: planName,
                description: planDescription,
                startDate: startDate.toISOString(),
                targetCalories: targets.calories,
                targetProteinG: targets.protein,
                targetCarbsG: targets.carbs,
                targetFatsG: targets.fat,
                meals: apiMeals,
                options: isTemplateMode ? { saveAsTemplate: true } : undefined,
            });

            if (publish && createdPlan?.id) {
                await publishMutation.mutateAsync(createdPlan.id);
            }

            toast.success(
                isTemplateMode
                    ? (publish ? 'Template Published!' : 'Template Saved!')
                    : (publish ? 'Diet Plan Published!' : 'Draft Saved!')
            );

            onSaved(isTemplateMode, publish);
        } catch (error) {
            toast.error('Failed to save plan');
            console.error(error);
        }
    }, [weeklyMeals, clientId, planName, planDescription, startDate, isTemplateMode, createMutation, publishMutation, onSaved]);

    const hasAllergyWarning = currentMeals.some(m => m.foods.some(f => f.hasWarning));

    return {
        // State
        startDate, setStartDate,
        selectedDayIndex, setSelectedDayIndex,
        planName, setPlanName,
        planDescription, setPlanDescription,
        weeklyMeals,
        showAddFoodModal, setShowAddFoodModal,
        activeMealId,
        activeOptionGroup,
        applyingTemplateId,
        planDates,
        currentMeals,

        // Computed
        dayNutrition,
        targets,
        setTargets,
        hasAllergyWarning,

        // Actions
        addMeal,
        removeMeal,
        openAddFood,
        addFood,
        removeFood,
        updateFoodQuantity,
        updateMealField,
        addMealOption,
        removeOption,
        updateOptionLabel,
        applyTemplate,
        save,

        // Mutation states
        isSaving: createMutation.isPending,
    };
}
</file>

<file path="frontend/src/lib/hooks/use-meal-logs.ts">
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useApiClient } from '../api/use-api-client';

// Types
export interface MealLog {
    id: string;
    mealId: string;
    scheduledDate: string;
    scheduledTime: string;
    status: 'pending' | 'eaten' | 'skipped' | 'substituted';
    mealPhotoUrl?: string;
    mealPhotoSmallUrl?: string;
    clientNotes?: string;
    dietitianFeedback?: string;
    loggedAt?: string;
    createdAt: string;
    client: {
        id: string;
        fullName: string;
    };
    meal?: {
        id: string;
        name: string;
        mealType: string;
    };
    reviewedByUser?: {
        id: string;
        fullName: string;
    };
}

interface PaginatedResponse<T> {
    success: boolean;
    data: T[];
    meta: {
        page: number;
        pageSize: number;
        total: number;
        totalPages: number;
    };
}

interface MealLogsParams {
    page?: number;
    pageSize?: number;
    clientId?: string;
    status?: string;
    reviewStatus?: 'pending' | 'reviewed';
    dateFrom?: string;
    dateTo?: string;
}

interface ReviewMealLogInput {
    status: 'eaten' | 'skipped' | 'substituted';
    dietitianFeedback?: string;
}

// Hooks
export function useMealLogs(params: MealLogsParams = {}) {
    const api = useApiClient();
    const { page = 1, pageSize = 20, clientId, status, reviewStatus, dateFrom, dateTo } = params;

    return useQuery({
        queryKey: ['meal-logs', page, pageSize, clientId, status, reviewStatus, dateFrom, dateTo],
        queryFn: async () => {
            const { data } = await api.get<PaginatedResponse<MealLog>>('/meal-logs', {
                params: { page, pageSize, clientId, status, reviewStatus, dateFrom, dateTo },
            });
            return data;
        },
    });
}

export function useMealLog(id: string) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['meal-logs', id],
        queryFn: async () => {
            const { data } = await api.get(`/meal-logs/${id}`);
            return data.data as MealLog;
        },
        enabled: !!id,
    });
}

export function useReviewMealLog() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async ({ id, ...reviewData }: ReviewMealLogInput & { id: string }) => {
            const { data } = await api.patch(`/meal-logs/${id}/review`, reviewData);
            return data.data;
        },
        onSuccess: (_, variables) => {
            queryClient.invalidateQueries({ queryKey: ['meal-logs'] });
            queryClient.invalidateQueries({ queryKey: ['meal-logs', variables.id] });
        },
    });
}

export function useUpdateMealLog() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async ({ id, ...updateData }: { id: string; status?: string; clientNotes?: string }) => {
            const { data } = await api.patch(`/meal-logs/${id}`, updateData);
            return data.data;
        },
        onSuccess: (_, variables) => {
            queryClient.invalidateQueries({ queryKey: ['meal-logs'] });
            queryClient.invalidateQueries({ queryKey: ['meal-logs', variables.id] });
        },
    });
}
</file>

<file path="frontend/src/lib/hooks/use-team.ts">
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useApiClient } from '../api/use-api-client';

export interface TeamMember {
    id: string;
    name: string;
    email: string;
    phone?: string;
    role: string;
    specialization?: string;
    profilePhotoUrl?: string;
    clientCount: number;
    avatar: string;
}

export interface InviteMemberInput {
    email: string;
    role: string;
}

export function useTeam() {
    const api = useApiClient();

    return useQuery({
        queryKey: ['team'],
        queryFn: async () => {
            const { data } = await api.get('/team');
            return data.data as TeamMember[];
        },
    });
}

export function useInviteMember() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (data: InviteMemberInput) => {
            const res = await api.post('/team/invite', data);
            return res.data.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['team'] });
        },
    });
}

export function useValidateInvite(token: string) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['invitation', token],
        queryFn: async () => {
            const { data } = await api.get(`/team/invitation/${token}`);
            return data.data as { email: string; orgName: string; role: string };
        },
        enabled: !!token,
        retry: false
    });
}

export function useAcceptInvite() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (token: string) => {
            const res = await api.post('/team/join', { token });
            return res.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['team'] });
        },
    });
}
</file>

<file path="frontend/src/lib/hooks/use-validation.ts">
/**
 * Diet Validation Hook
 * Real-time food validation against client restrictions
 */

'use client';

import { useCallback, useState } from 'react';
import { useApiClient } from '../api/use-api-client';

// ============ TYPES ============

export type ValidationSeverity = 'RED' | 'YELLOW' | 'GREEN';
export type BorderColor = 'red' | 'yellow' | 'green';

export interface ValidationAlert {
    type: string;
    severity: ValidationSeverity;
    message: string;
    recommendation?: string;
    icon?: string;
}

export interface ValidationResult {
    foodId: string;
    foodName: string;
    severity: ValidationSeverity;
    borderColor: BorderColor;
    canAdd: boolean;
    alerts: ValidationAlert[];
    confidenceScore: number;
}

export interface BatchValidationResult {
    results: ValidationResult[];
    processingTimeMs: number;
}

export interface ValidationContext {
    currentDay: string;
    mealType: 'breakfast' | 'lunch' | 'snack' | 'dinner';
}

export interface FoodRestriction {
    foodId?: string;
    foodName?: string;
    foodCategory?: string;
    restrictionType: 'day_based' | 'time_based' | 'frequency' | 'quantity' | 'always';
    avoidDays?: string[];
    avoidMeals?: string[];
    avoidAfter?: string;
    avoidBefore?: string;
    maxPerWeek?: number;
    maxPerDay?: number;
    maxGramsPerMeal?: number;
    excludes?: string[];
    includes?: string[];
    reason?: string;
    severity: 'strict' | 'flexible';
    note?: string;
}

// ============ HOOK ============

export function useValidation(clientId: string | null) {
    const api = useApiClient();
    const [validationCache, setValidationCache] = useState<Map<string, ValidationResult>>(new Map());
    const [isValidating, setIsValidating] = useState(false);

    /**
     * Validate multiple food items at once (batch is more efficient)
     */
    const validateFoods = useCallback(async (
        foodIds: string[],
        context: ValidationContext
    ): Promise<Map<string, ValidationResult>> => {
        if (!clientId || foodIds.length === 0) {
            return new Map();
        }

        // Filter out already cached items
        const uncachedIds = foodIds.filter(id => !validationCache.has(id));

        if (uncachedIds.length === 0) {
            // All cached, return from cache
            const results = new Map<string, ValidationResult>();
            foodIds.forEach(id => {
                const cached = validationCache.get(id);
                if (cached) results.set(id, cached);
            });
            return results;
        }

        setIsValidating(true);
        try {
            const { data } = await api.post('/diet-validation/batch', {
                clientId,
                foodIds: uncachedIds,
                context
            });

            const batchResult: BatchValidationResult = data.data;

            // Update cache with new results, limit cache size to 500 entries
            const newCache = new Map(validationCache);
            batchResult.results.forEach(result => {
                newCache.set(result.foodId, result);
            });
            if (newCache.size > 500) {
                const keysToDelete = Array.from(newCache.keys()).slice(0, newCache.size - 500);
                keysToDelete.forEach(key => newCache.delete(key));
            }
            setValidationCache(newCache);

            // Return all requested results (cached + new)
            const results = new Map<string, ValidationResult>();
            foodIds.forEach(id => {
                const cached = newCache.get(id);
                if (cached) results.set(id, cached);
            });

            return results;
        } catch (error) {
            console.error('Batch validation error:', error);
            return new Map();
        } finally {
            setIsValidating(false);
        }
    }, [api, clientId, validationCache]);

    /**
     * Get cached validation result for a food
     */
    const getValidation = useCallback((foodId: string): ValidationResult | undefined => {
        return validationCache.get(foodId);
    }, [validationCache]);

    /**
     * Clear validation cache (e.g., when client changes)
     */
    const clearCache = useCallback(() => {
        setValidationCache(new Map());
    }, []);

    /**
     * Get border color class for styling
     */
    const getBorderClass = useCallback((severity: ValidationSeverity | undefined): string => {
        switch (severity) {
            case 'RED':
                return 'border-red-500 bg-red-50';
            case 'YELLOW':
                return 'border-yellow-500 bg-yellow-50';
            case 'GREEN':
                return 'border-green-500 bg-green-50';
            default:
                return 'border-gray-200 hover:border-[#17cf54]';
        }
    }, []);

    /**
     * Get icon color class
     */
    const getIconClass = useCallback((severity: ValidationSeverity | undefined): string => {
        switch (severity) {
            case 'RED':
                return 'text-red-500';
            case 'YELLOW':
                return 'text-yellow-500';
            case 'GREEN':
                return 'text-green-500';
            default:
                return 'text-gray-400';
        }
    }, []);

    return {
        validateFoods,
        getValidation,
        clearCache,
        getBorderClass,
        getIconClass,
        isValidating,
        validationCache
    };
}
</file>

<file path="frontend/src/lib/types/diet-plan.types.ts">
import type { FoodRestriction } from '@/lib/hooks/use-validation';

/**
 * Shared types for diet plan builder and related components
 */

export interface ClientData {
    fullName?: string;
    targetWeightKg?: number;
    dateOfBirth?: string;
    heightCm?: number;
    currentWeightKg?: number;
    email?: string;
    phone?: string;
    gender?: string;
    medicalProfile?: {
        allergies?: string[];
        conditions?: string[];
    };
    allergies?: string[];
    intolerances?: string[];
    dietPattern?: string;
    medicalConditions?: string[];
    foodRestrictions?: FoodRestriction[];
    dislikes?: string[];
    likedFoods?: string[];
    targetCalories?: number | null;
    targetProteinG?: number | null;
    targetCarbsG?: number | null;
    targetFatsG?: number | null;
}

export interface FoodItemData {
    id: string;
    name: string;
    calories: number;
    protein: number;
    carbs: number;
    fat: number;
    validationSeverity?: 'RED' | 'YELLOW' | 'GREEN';
    validationAlerts?: Array<{ type: string; severity: string; message: string; recommendation?: string }>;
}

export interface NutritionTargets {
    calories: number;
    protein: number;
    carbs: number;
    fat: number;
}

export interface DayNutrition {
    calories: number;
    protein: number;
    carbs: number;
    fat: number;
}

export interface LocalFoodItem {
    id: string; // db food id
    tempId: string; // unique local id
    name: string;
    quantity: string;
    quantityValue: number;
    calories: number;
    protein: number;
    carbs: number;
    fat: number;
    hasWarning: boolean;
    validationSeverity?: 'RED' | 'YELLOW' | 'GREEN';
    validationAlerts?: Array<{ type: string; severity: string; message: string; recommendation?: string }>;
    optionGroup: number; // 0 = default, 1+ = alternatives
    optionLabel?: string; // e.g. "Oatmeal Bowl", "Egg Plate"
}

export interface LocalMeal {
    id: string;
    name: string;
    type: 'breakfast' | 'lunch' | 'dinner' | 'snack';
    time: string;
    foods: LocalFoodItem[];
}

export interface TemplateData {
    id: string;
    name?: string;
    checkInFrequency?: string;
}
</file>

<file path="frontend/src/middleware.ts">
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';
import { NextResponse } from 'next/server';

const isProtectedRoute = createRouteMatcher(['/dashboard(.*)']);

export default clerkMiddleware(async (auth, request) => {
    if (isProtectedRoute(request)) {
        const { userId } = await auth();
        if (!userId) {
            return NextResponse.redirect(new URL('/sign-in', request.url));
        }
    }
});

export const config = {
    matcher: [
        // Skip Next.js internals and all static files
        '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
        // Always run for API routes
        '/(api|trpc)(.*)',
    ],
};
</file>

<file path="frontend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# Dependencies
node_modules/
/.pnp
.pnp.js
.yarn/install-state.gz

# Testing
/coverage

# Next.js
/.next/
/out/

# Production
/build

# OS files
.DS_Store

# Debug
*.pem
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Environment files
.env
.env.local
.env.*.local

# Vercel
.vercel

# TypeScript
*.tsbuildinfo
next-env.d.ts

# Clerk configuration (can include secrets)
/.clerk/
</file>

<file path=".gitignore">
# Dependencies
node_modules/

# Environment files
.env
.env.local
.env.*.local

# OS files
.DS_Store
Thumbs.db

# IDE/Editor
.idea/
.vscode/
*.swp
*.swo
*~

# Logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Build outputs
dist/
build/
out/

# Debug
*.pem

# Lock files (if needed per-project)
# package-lock.json
# yarn.lock
# bun.lock

# Generated files
repomix-output.xml

# Claude/AI tool artifacts
.claude/

Docs/
# doc/
</file>

<file path="backend/src/controllers/dietPlan.controller.ts">
import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { dietPlanService } from '../services/dietPlan.service';

export const createDietPlan = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const dietPlan = await dietPlanService.createPlan(req.body, req.user.organizationId, req.user.id);
    res.status(201).json({ success: true, data: dietPlan });
});

export const getDietPlan = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const dietPlan = await dietPlanService.getPlan(req.params.id, req.user.organizationId);
    res.status(200).json({ success: true, data: dietPlan });
});

export const listDietPlans = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const { plans, meta } = await dietPlanService.listPlans(req.user.organizationId, req.query);
    res.status(200).json({ success: true, data: plans, meta });
});

export const updateDietPlan = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const updated = await dietPlanService.updatePlan(req.params.id, req.body, req.user.organizationId);
    res.status(200).json({ success: true, data: updated });
});

export const publishDietPlan = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const data = await dietPlanService.publishPlan(req.params.id, req.user.organizationId);
    res.status(200).json({ success: true, data });
});

export const assignTemplateToClient = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const newPlan = await dietPlanService.assignTemplateToClient(req.params.id, req.body, req.user.organizationId, req.user.id);
    res.status(201).json({ success: true, data: newPlan });
});
</file>

<file path="backend/src/controllers/mealLog.controller.ts">
import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { mealLogService } from '../services/mealLog.service';

export const createMealLog = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const mealLog = await mealLogService.createMealLog(req.body, req.user.organizationId);
    res.status(201).json({ success: true, data: mealLog });
});

export const listMealLogs = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const { data, meta } = await mealLogService.listMealLogs(req.user.organizationId, req.query, req.user.role, req.user.id);
    res.status(200).json({ success: true, data, meta });
});

export const getMealLog = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const data = await mealLogService.getMealLog(req.params.id, req.user.organizationId);
    res.status(200).json({ success: true, data });
});

export const updateMealLog = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const data = await mealLogService.updateMealLog(req.params.id, req.body, req.user.organizationId);
    res.status(200).json({ success: true, data });
});

export const reviewMealLog = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const data = await mealLogService.reviewMealLog(req.params.id, req.body, req.user.organizationId, req.user.id);
    res.status(200).json({ success: true, data });
});

export const uploadMealPhoto = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    if (!req.file) throw AppError.badRequest('No photo file provided', 'NO_FILE');
    const data = await mealLogService.uploadMealPhoto(req.params.id, req.file.buffer, req.file.size, req.user.organizationId);
    res.status(200).json({ success: true, data });
});
</file>

<file path="backend/src/services/validationEngine.service.ts">
/**
 * Diet Validation Engine
 * Real-time food compatibility checker against client restrictions
 * 
 * Performance optimizations:
 * - Set-based O(1) tag lookups
 * - LRU cache for client tags
 * - Early termination on RED rules
 * - Batch validation support
 */

import prisma from '../utils/prisma';
import logger from '../utils/logger';
import {
    ValidationSeverity,
    ValidationContext,
    ValidationResult,
    ValidationAlert,
    BatchValidationResult,
    ClientTags,
    FoodTags,
    CachedClientTags,
    AlertType,
    FoodRestriction,
    PlanTargets
} from '../types/validation.types';
import {
    matchesCategoryAvoidance,
    MEAL_SUITABILITY_CONFLICTS
} from '../utils/validation-rules';
import { VALIDATION_CONFIG } from '../config/validation-rules.config';

// Day name mapping
const DAY_NAMES = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

// ============ LRU CACHE ============

class LRUCache<K, V> {
    private cache = new Map<K, V>();
    private maxSize: number;

    constructor(maxSize: number) {
        this.maxSize = maxSize;
    }

    get(key: K): V | undefined {
        const value = this.cache.get(key);
        if (value !== undefined) {
            // Move to end (most recently used)
            this.cache.delete(key);
            this.cache.set(key, value);
        }
        return value;
    }

    set(key: K, value: V): void {
        if (this.cache.has(key)) {
            this.cache.delete(key);
        } else if (this.cache.size >= this.maxSize) {
            // Remove oldest (first item)
            const firstKey = this.cache.keys().next().value;
            if (firstKey !== undefined) {
                this.cache.delete(firstKey);
            }
        }
        this.cache.set(key, value);
    }

    delete(key: K): void {
        this.cache.delete(key);
    }

    clear(): void {
        this.cache.clear();
    }
}

// ============ VALIDATION ENGINE ============

export class ValidationEngine {
    private clientTagsCache: LRUCache<string, CachedClientTags>;

    constructor() {
        this.clientTagsCache = new LRUCache(VALIDATION_CONFIG.MAX_CACHE_SIZE);
    }

    /**
     * Main validation method - validates a single food item for a client
     */
    async validate(
        clientId: string,
        foodId: string,
        context: ValidationContext
    ): Promise<ValidationResult> {
        const startTime = Date.now();

        // Load client and food tags in parallel
        const [clientTags, foodTags] = await Promise.all([
            this.getClientTags(clientId),
            this.getFoodTags(foodId)
        ]);

        if (!clientTags) {
            throw new Error(`Client not found: ${clientId}`);
        }
        if (!foodTags) {
            throw new Error(`Food item not found: ${foodId}`);
        }

        const alerts: ValidationAlert[] = [];
        let highestSeverity = ValidationSeverity.GREEN;

        // ===== RED RULES (blocking) =====
        // Check in order of severity, early terminate if blocked

        // 1. Allergy check
        const allergyAlert = this.checkAllergies(clientTags, foodTags);
        if (allergyAlert) {
            alerts.push(allergyAlert);
            highestSeverity = ValidationSeverity.RED;
            // Early return for blocking rules
            return this.buildResult(foodTags, highestSeverity, alerts, startTime);
        }

        // 2. Intolerance check
        const intoleranceAlert = this.checkIntolerances(clientTags, foodTags);
        if (intoleranceAlert) {
            alerts.push(intoleranceAlert);
            highestSeverity = ValidationSeverity.RED;
            return this.buildResult(foodTags, highestSeverity, alerts, startTime);
        }

        // 3. Diet pattern check
        const dietPatternAlert = this.checkDietPattern(clientTags, foodTags);
        if (dietPatternAlert) {
            alerts.push(dietPatternAlert);
            highestSeverity = ValidationSeverity.RED;
            return this.buildResult(foodTags, highestSeverity, alerts, startTime);
        }

        // 4. Day restriction check (e.g., no eggs on Tuesday)
        const dayRestrictionAlert = this.checkDayRestrictions(clientTags, foodTags, context);
        if (dayRestrictionAlert) {
            alerts.push(dayRestrictionAlert);
            highestSeverity = ValidationSeverity.RED;
            return this.buildResult(foodTags, highestSeverity, alerts, startTime);
        }

        // 5. Flexible food restrictions check (from foodRestrictions JSON array)
        const restrictionAlerts = this.checkFoodRestrictions(clientTags, foodTags, context);
        for (const alert of restrictionAlerts) {
            alerts.push(alert);
            if (alert.severity === ValidationSeverity.RED) {
                highestSeverity = ValidationSeverity.RED;
                return this.buildResult(foodTags, highestSeverity, alerts, startTime);
            }
            if (alert.severity === ValidationSeverity.YELLOW && highestSeverity === ValidationSeverity.GREEN) {
                highestSeverity = ValidationSeverity.YELLOW;
            }
        }

        // ===== YELLOW RULES (warnings) =====
        // Collect all warnings, don't stop on first

        // 6. Medical condition warnings
        const medicalAlerts = this.checkMedicalConditions(clientTags, foodTags);
        alerts.push(...medicalAlerts);
        if (medicalAlerts.length > 0 && highestSeverity === ValidationSeverity.GREEN) {
            highestSeverity = ValidationSeverity.YELLOW;
        }

        // 7. Lab-derived warnings
        const labAlerts = this.checkLabDerivedTags(clientTags, foodTags);
        alerts.push(...labAlerts);
        if (labAlerts.length > 0 && highestSeverity === ValidationSeverity.GREEN) {
            highestSeverity = ValidationSeverity.YELLOW;
        }

        // 8. Dislike warnings
        const dislikeAlert = this.checkDislikes(clientTags, foodTags);
        if (dislikeAlert) {
            alerts.push(dislikeAlert);
            if (highestSeverity === ValidationSeverity.GREEN) {
                highestSeverity = ValidationSeverity.YELLOW;
            }
        }

        // 9. Category avoidance warnings
        const categoryAlert = this.checkCategoryAvoidance(clientTags, foodTags);
        if (categoryAlert) {
            alerts.push(categoryAlert);
            if (highestSeverity === ValidationSeverity.GREEN) {
                highestSeverity = ValidationSeverity.YELLOW;
            }
        }

        // 10. Meal suitability warnings
        if (context.mealType) {
            const mealSuitabilityAlert = this.checkMealSuitability(foodTags, context.mealType);
            if (mealSuitabilityAlert) {
                alerts.push(mealSuitabilityAlert);
                if (highestSeverity === ValidationSeverity.GREEN) {
                    highestSeverity = ValidationSeverity.YELLOW;
                }
            }
        }

        // 11. Meal repetition check
        if (context.planId) {
            const repetitionAlerts = await this.checkRepetition(foodTags.id, context.planId);
            if (repetitionAlerts.length > 0) {
                alerts.push(...repetitionAlerts);
                if (highestSeverity === ValidationSeverity.GREEN) {
                    highestSeverity = ValidationSeverity.YELLOW;
                }
            }
        }

        // 12. Nutrition strength check
        if (context.planId) {
            const planTargets = await this.getPlanTargets(context.planId);
            if (planTargets) {
                const nutritionAlerts = this.checkNutritionStrength(foodTags, planTargets);
                alerts.push(...nutritionAlerts);
                if (nutritionAlerts.length > 0 && highestSeverity === ValidationSeverity.GREEN) {
                    highestSeverity = ValidationSeverity.YELLOW;
                }
            }
        }

        // ===== GREEN RULES (positive) =====
        // These don't change severity, just add positive indicators

        // 13. Liked foods
        const likedAlert = this.checkLikedFoods(clientTags, foodTags);
        if (likedAlert) alerts.push(likedAlert);

        // 14. Preferred cuisines
        const cuisineAlert = this.checkPreferredCuisines(clientTags, foodTags);
        if (cuisineAlert) alerts.push(cuisineAlert);

        return this.buildResult(foodTags, highestSeverity, alerts, startTime);
    }

    /**
     * Batch validation - validates multiple foods for a client in one call
     */
    async validateBatch(
        clientId: string,
        foodIds: string[],
        context: ValidationContext
    ): Promise<BatchValidationResult> {
        const startTime = Date.now();

        // Pre-load client tags once
        const clientTags = await this.getClientTags(clientId);
        if (!clientTags) {
            throw new Error(`Client not found: ${clientId}`);
        }

        // Batch load all food items
        const foods = await prisma.foodItem.findMany({
            where: { id: { in: foodIds } },
            select: {
                id: true,
                name: true,
                allergenFlags: true,
                dietaryTags: true,
                dietaryCategory: true,
                nutritionTags: true,
                healthFlags: true,
                cuisineTags: true,
                processingLevel: true,
                mealSuitabilityTags: true,
                calories: true,
                proteinG: true,
                carbsG: true,
                fatsG: true
            }
        });

        // Pre-load plan targets and repetition counts if planId is provided
        let planTargets: PlanTargets | null = null;
        let planFoodCounts: Map<string, number> | null = null;
        if (context.planId) {
            [planTargets, planFoodCounts] = await Promise.all([
                this.getPlanTargets(context.planId),
                this.getPlanFoodCounts(context.planId)
            ]);
        }

        const results: ValidationResult[] = [];

        for (const food of foods) {
            const foodTags = this.convertToFoodTags(food);
            const itemStartTime = Date.now();
            const alerts: ValidationAlert[] = [];
            let highestSeverity = ValidationSeverity.GREEN;

            // Run all checks (same logic as single validation)
            const allergyAlert = this.checkAllergies(clientTags, foodTags);
            if (allergyAlert) {
                alerts.push(allergyAlert);
                highestSeverity = ValidationSeverity.RED;
                results.push(this.buildResult(foodTags, highestSeverity, alerts, itemStartTime));
                continue;
            }

            const intoleranceAlert = this.checkIntolerances(clientTags, foodTags);
            if (intoleranceAlert) {
                alerts.push(intoleranceAlert);
                highestSeverity = ValidationSeverity.RED;
                results.push(this.buildResult(foodTags, highestSeverity, alerts, itemStartTime));
                continue;
            }

            const dietPatternAlert = this.checkDietPattern(clientTags, foodTags);
            if (dietPatternAlert) {
                alerts.push(dietPatternAlert);
                highestSeverity = ValidationSeverity.RED;
                results.push(this.buildResult(foodTags, highestSeverity, alerts, itemStartTime));
                continue;
            }

            const dayRestrictionAlert = this.checkDayRestrictions(clientTags, foodTags, context);
            if (dayRestrictionAlert) {
                alerts.push(dayRestrictionAlert);
                highestSeverity = ValidationSeverity.RED;
                results.push(this.buildResult(foodTags, highestSeverity, alerts, itemStartTime));
                continue;
            }

            // Food restrictions check (flexible rules from client profile)
            const restrictionAlerts = this.checkFoodRestrictions(clientTags, foodTags, context, planFoodCounts);
            for (const alert of restrictionAlerts) {
                alerts.push(alert);
                if (alert.severity === ValidationSeverity.RED) {
                    highestSeverity = ValidationSeverity.RED;
                    break;
                }
                if (alert.severity === ValidationSeverity.YELLOW && highestSeverity === ValidationSeverity.GREEN) {
                    highestSeverity = ValidationSeverity.YELLOW;
                }
            }
            if (highestSeverity === ValidationSeverity.RED) {
                results.push(this.buildResult(foodTags, highestSeverity, alerts, itemStartTime));
                continue;
            }

            // Yellow rules
            const medicalAlerts = this.checkMedicalConditions(clientTags, foodTags);
            alerts.push(...medicalAlerts);
            if (medicalAlerts.length > 0) highestSeverity = ValidationSeverity.YELLOW;

            const labAlerts = this.checkLabDerivedTags(clientTags, foodTags);
            alerts.push(...labAlerts);
            if (labAlerts.length > 0 && highestSeverity === ValidationSeverity.GREEN) {
                highestSeverity = ValidationSeverity.YELLOW;
            }

            const dislikeAlert = this.checkDislikes(clientTags, foodTags);
            if (dislikeAlert) {
                alerts.push(dislikeAlert);
                if (highestSeverity === ValidationSeverity.GREEN) highestSeverity = ValidationSeverity.YELLOW;
            }

            const categoryAlert = this.checkCategoryAvoidance(clientTags, foodTags);
            if (categoryAlert) {
                alerts.push(categoryAlert);
                if (highestSeverity === ValidationSeverity.GREEN) highestSeverity = ValidationSeverity.YELLOW;
            }

            if (context.mealType) {
                const mealSuitabilityAlert = this.checkMealSuitability(foodTags, context.mealType);
                if (mealSuitabilityAlert) {
                    alerts.push(mealSuitabilityAlert);
                    if (highestSeverity === ValidationSeverity.GREEN) highestSeverity = ValidationSeverity.YELLOW;
                }
            }

            // Repetition + spacing check
            if (context.planId) {
                const repetitionAlerts = await this.checkRepetition(food.id, context.planId);
                if (repetitionAlerts.length > 0) {
                    alerts.push(...repetitionAlerts);
                    if (highestSeverity === ValidationSeverity.GREEN) highestSeverity = ValidationSeverity.YELLOW;
                }
            }

            // Nutrition strength check (using pre-loaded targets)
            if (planTargets) {
                const nutritionAlerts = this.checkNutritionStrength(foodTags, planTargets);
                alerts.push(...nutritionAlerts);
                if (nutritionAlerts.length > 0 && highestSeverity === ValidationSeverity.GREEN) {
                    highestSeverity = ValidationSeverity.YELLOW;
                }
            }

            // Green rules
            const likedAlert = this.checkLikedFoods(clientTags, foodTags);
            if (likedAlert) alerts.push(likedAlert);

            const cuisineAlert = this.checkPreferredCuisines(clientTags, foodTags);
            if (cuisineAlert) alerts.push(cuisineAlert);

            results.push(this.buildResult(foodTags, highestSeverity, alerts, itemStartTime));
        }

        return {
            results,
            processingTimeMs: Date.now() - startTime
        };
    }

    /**
     * Clear cache for a specific client (call when client tags are updated)
     */
    invalidateClientCache(clientId: string): void {
        this.clientTagsCache.delete(clientId);
        logger.debug('Invalidated client cache', { clientId });
    }

    /**
     * Clear entire cache
     */
    clearCache(): void {
        this.clientTagsCache.clear();
        logger.debug('Cleared validation engine cache');
    }

    // ============ PROTECTED: DATA LOADING ============

    protected async getClientTags(clientId: string): Promise<ClientTags | null> {
        // Check cache first
        const cached = this.clientTagsCache.get(clientId);
        if (cached && Date.now() - cached.cachedAt < VALIDATION_CONFIG.CACHE_TTL_MS) {
            return cached.tags;
        }

        // Load from database
        const client = await prisma.client.findUnique({
            where: { id: clientId },
            select: {
                allergies: true,
                intolerances: true,
                dietPattern: true,
                eggAllowed: true,
                eggAvoidDays: true,
                dislikes: true,
                avoidCategories: true,
                medicalConditions: true,
                labDerivedTags: true,
                likedFoods: true,
                preferredCuisines: true,
                foodRestrictions: true
            }
        });

        if (!client) return null;

        const tags: ClientTags = {
            allergies: new Set(client.allergies.map(a => a.toLowerCase())),
            intolerances: new Set(client.intolerances.map((i: string) => i.toLowerCase())),
            dietPattern: client.dietPattern?.toLowerCase() || null,
            eggAllowed: client.eggAllowed,
            eggAvoidDays: new Set(client.eggAvoidDays.map((d: string) => d.toLowerCase())),
            foodRestrictions: (client.foodRestrictions as unknown as FoodRestriction[]) || [],
            dislikes: new Set(client.dislikes.map((d: string) => d.toLowerCase())),
            avoidCategories: new Set(client.avoidCategories.map((c: string) => c.toLowerCase())),
            medicalConditions: new Set(client.medicalConditions.map((m: string) => m.toLowerCase())),
            labDerivedTags: new Set(client.labDerivedTags.map((l: string) => l.toLowerCase())),
            likedFoods: new Set(client.likedFoods),
            preferredCuisines: new Set(client.preferredCuisines.map((c: string) => c.toLowerCase()))
        };

        // Cache for next time
        this.clientTagsCache.set(clientId, { tags, cachedAt: Date.now() });

        return tags;
    }

    protected async getFoodTags(foodId: string): Promise<FoodTags | null> {
        const food = await prisma.foodItem.findUnique({
            where: { id: foodId },
            select: {
                id: true,
                name: true,
                allergenFlags: true,
                dietaryCategory: true,
                nutritionTags: true,
                healthFlags: true,
                cuisineTags: true,
                processingLevel: true,
                mealSuitabilityTags: true,
                calories: true,
                proteinG: true,
                carbsG: true,
                fatsG: true
            }
        });

        if (!food) return null;

        return this.convertToFoodTags(food);
    }

    private convertToFoodTags(food: {
        id: string;
        name: string;
        allergenFlags: string[];
        dietaryCategory: string | null;
        nutritionTags: string[];
        healthFlags: string[];
        cuisineTags: string[];
        processingLevel: string | null;
        mealSuitabilityTags: string[];
        calories?: number | null;
        proteinG?: any;
        carbsG?: any;
        fatsG?: any;
    }): FoodTags {
        return {
            id: food.id,
            name: food.name,
            allergenFlags: new Set(food.allergenFlags.map(a => a.toLowerCase())),
            dietaryCategory: food.dietaryCategory?.toLowerCase() || null,
            nutritionTags: new Set(food.nutritionTags.map(n => n.toLowerCase())),
            healthFlags: new Set(food.healthFlags.map(h => h.toLowerCase())),
            cuisineTags: new Set(food.cuisineTags.map(c => c.toLowerCase())),
            processingLevel: food.processingLevel?.toLowerCase() || null,
            mealSuitabilityTags: new Set(food.mealSuitabilityTags.map(m => m.toLowerCase())),
            calories: food.calories ?? undefined,
            proteinG: food.proteinG ? Number(food.proteinG) : undefined,
            carbsG: food.carbsG ? Number(food.carbsG) : undefined,
            fatsG: food.fatsG ? Number(food.fatsG) : undefined
        };
    }

    // ============ PRIVATE: VALIDATION RULES ============

    private checkAllergies(client: ClientTags, food: FoodTags): ValidationAlert | null {
        for (const allergen of client.allergies) {
            if (food.allergenFlags.has(allergen)) {
                return {
                    type: 'allergy',
                    severity: ValidationSeverity.RED,
                    message: `⛔ ALLERGY: Client is allergic to ${allergen}`,
                    icon: 'alert-circle'
                };
            }
        }
        return null;
    }

    private checkIntolerances(client: ClientTags, food: FoodTags): ValidationAlert | null {
        for (const intolerance of client.intolerances) {
            if (food.allergenFlags.has(intolerance)) {
                return {
                    type: 'intolerance',
                    severity: ValidationSeverity.RED,
                    message: `⛔ INTOLERANCE: Client is intolerant to ${intolerance}`,
                    icon: 'alert-circle'
                };
            }
        }
        return null;
    }

    private checkDietPattern(client: ClientTags, food: FoodTags): ValidationAlert | null {
        if (!client.dietPattern || !food.dietaryCategory) return null;

        const clientPattern = client.dietPattern;
        const foodCategory = food.dietaryCategory;

        // Vegetarian can't eat non-veg
        if (clientPattern === 'vegetarian' && foodCategory === 'non_veg') {
            return {
                type: 'diet_pattern',
                severity: ValidationSeverity.RED,
                message: `⛔ VEGETARIAN: Client doesn't eat meat/fish`,
                icon: 'leaf'
            };
        }

        // Vegetarian can't eat foods with egg unless egg is allowed
        if (clientPattern === 'vegetarian' && foodCategory === 'veg_with_egg' && !client.eggAllowed) {
            return {
                type: 'diet_pattern',
                severity: ValidationSeverity.RED,
                message: `⛔ VEGETARIAN: Client doesn't eat eggs`,
                icon: 'leaf'
            };
        }

        // Vegan can't eat non-veg or egg-containing or anything with dairy
        if (clientPattern === 'vegan' && (foodCategory === 'non_veg' || foodCategory === 'veg_with_egg' || foodCategory === 'vegetarian')) {
            return {
                type: 'diet_pattern',
                severity: ValidationSeverity.RED,
                message: `⛔ VEGAN: Client only eats vegan food`,
                icon: 'sprout'
            };
        }

        // Pescatarian can eat fish but not other meat
        if (clientPattern === 'pescatarian' && foodCategory === 'non_veg') {
            // Check if it's fish - this would need additional tagging
            // For now, we flag non_veg as warning
            return {
                type: 'diet_pattern',
                severity: ValidationSeverity.YELLOW,
                message: `🟡 PESCATARIAN: Verify this is fish-based, not meat`,
                recommendation: 'Check if this is seafood',
                icon: 'fish'
            };
        }

        return null;
    }

    private checkDayRestrictions(
        client: ClientTags,
        food: FoodTags,
        context: ValidationContext
    ): ValidationAlert | null {
        const currentDay = context.currentDay.toLowerCase();

        // Check egg restrictions on specific days
        if (client.eggAvoidDays.has(currentDay) && food.allergenFlags.has('eggs')) {
            return {
                type: 'day_restriction',
                severity: ValidationSeverity.RED,
                message: `⛔ DAY RESTRICTION: Client avoids eggs on ${context.currentDay}`,
                icon: 'calendar-x'
            };
        }

        return null;
    }

    private checkFoodRestrictions(
        client: ClientTags,
        food: FoodTags,
        context: ValidationContext,
        planFoodCounts?: Map<string, number> | null
    ): ValidationAlert[] {
        const alerts: ValidationAlert[] = [];
        const currentDay = context.currentDay.toLowerCase();
        const currentMeal = context.mealType.toLowerCase();
        const foodNameLower = food.name.toLowerCase();

        for (const restriction of client.foodRestrictions) {
            // Step 1: Does this restriction apply to this food?
            const applies = this.doesRestrictionApply(restriction, food, foodNameLower);
            if (!applies) continue;

            // Step 2: Check for excludes - if food is in excludes, skip this restriction
            if (this.isExcludedFromRestriction(restriction, food, foodNameLower)) {
                continue;
            }

            // Step 3: Is the restriction active based on context?
            const isActive = this.isRestrictionActive(restriction, currentDay, currentMeal, context.scheduledTime);
            if (!isActive) continue;

            // Step 3b: For frequency restrictions, check actual usage count
            if (restriction.restrictionType === 'frequency' && planFoodCounts) {
                const count = planFoodCounts.get(food.id) || 0;
                if (restriction.maxPerWeek && count < restriction.maxPerWeek) continue;
                if (restriction.maxPerDay) {
                    // maxPerDay can't be checked from plan-level counts, always warn
                }
            }

            // Step 4: Add alert based on severity
            const severity = restriction.severity === 'strict'
                ? ValidationSeverity.RED
                : ValidationSeverity.YELLOW;

            const reasonText = restriction.reason
                ? ` (${restriction.reason.replace(/_/g, ' ')})`
                : '';

            const foodLabel = restriction.foodCategory || restriction.foodName || 'this food';
            let message: string;
            if (restriction.restrictionType === 'day_based') {
                message = severity === ValidationSeverity.RED
                    ? `⛔ RESTRICTED: No ${foodLabel} on ${currentDay}${reasonText}`
                    : `🟡 CAUTION: Client prefers to avoid ${foodLabel} on ${currentDay}${reasonText}`;
            } else if (restriction.restrictionType === 'always') {
                message = severity === ValidationSeverity.RED
                    ? `⛔ RESTRICTED: Client never eats ${foodLabel}${reasonText}`
                    : `🟡 CAUTION: Client prefers to avoid ${foodLabel}${reasonText}`;
            } else if (restriction.restrictionType === 'time_based') {
                message = severity === ValidationSeverity.RED
                    ? `⛔ RESTRICTED: No ${foodLabel} during ${currentMeal}${reasonText}`
                    : `🟡 CAUTION: Client prefers to avoid ${foodLabel} during ${currentMeal}${reasonText}`;
            } else if (restriction.restrictionType === 'frequency') {
                const count = planFoodCounts?.get(food.id) || 0;
                const limit = restriction.maxPerWeek || restriction.maxPerDay;
                message = `🟡 FREQUENCY: ${foodLabel} appears ${count}/${limit} times${restriction.maxPerWeek ? '/week' : '/day'}${reasonText}`;
            } else if (restriction.restrictionType === 'quantity') {
                message = `🟡 QUANTITY: Limit ${foodLabel} to ${restriction.maxGramsPerMeal}g/meal${reasonText}`;
            } else {
                message = `⚠️ RESTRICTION: ${restriction.note || 'Food has restrictions'}`;
            }

            alerts.push({
                type: 'food_restriction',
                severity,
                message,
                recommendation: restriction.note || undefined,
                icon: severity === ValidationSeverity.RED ? 'ban' : 'alert-triangle'
            });
        }

        return alerts;
    }

    private doesRestrictionApply(
        restriction: FoodRestriction,
        food: FoodTags,
        foodNameLower: string
    ): boolean {
        // Check by specific food ID
        if (restriction.foodId && restriction.foodId === food.id) {
            return true;
        }

        // Check by food category
        if (restriction.foodCategory) {
            const category = restriction.foodCategory.toLowerCase();

            // Handle common category mappings
            if (category === 'non_veg' && food.dietaryCategory === 'non_veg') {
                return true;
            }
            if (category === 'eggs' && food.allergenFlags.has('eggs')) {
                return true;
            }
            if (category === 'dairy' && (food.allergenFlags.has('milk') || food.allergenFlags.has('dairy'))) {
                return true;
            }
            if (category === 'root_vegetables') {
                // Check if food matches any items in includes list
                if (restriction.includes) {
                    for (const item of restriction.includes) {
                        if (foodNameLower.includes(item.toLowerCase())) {
                            return true;
                        }
                    }
                }
            }
            // General category check
            if (food.cuisineTags.has(category) || foodNameLower.includes(category)) {
                return true;
            }
        }

        // Check by food name
        if (restriction.foodName) {
            const restrictedName = restriction.foodName.toLowerCase();
            if (foodNameLower.includes(restrictedName) || restrictedName.includes(foodNameLower)) {
                return true;
            }
        }

        return false;
    }

    private isExcludedFromRestriction(
        restriction: FoodRestriction,
        food: FoodTags,
        foodNameLower: string
    ): boolean {
        if (!restriction.excludes || restriction.excludes.length === 0) {
            return false;
        }

        for (const exclude of restriction.excludes) {
            const excludeLower = exclude.toLowerCase();

            // Check by ID
            if (exclude === food.id) {
                return true;
            }

            // Check by name
            if (foodNameLower.includes(excludeLower)) {
                return true;
            }

            // Check by allergen flag (e.g., "eggs" excluded)
            if (food.allergenFlags.has(excludeLower)) {
                return true;
            }
        }

        return false;
    }

    private isRestrictionActive(
        restriction: FoodRestriction,
        currentDay: string,
        currentMeal: string,
        scheduledTime?: string
    ): boolean {
        switch (restriction.restrictionType) {
            case 'always':
                return true;

            case 'day_based':
                if (restriction.avoidDays) {
                    return restriction.avoidDays.some(d => d.toLowerCase() === currentDay);
                }
                return false;

            case 'time_based':
                if (restriction.avoidMeals) {
                    if (restriction.avoidMeals.some(m => m.toLowerCase() === currentMeal)) {
                        return true;
                    }
                }
                // Time window check using scheduledTime or meal-to-time fallback
                if (restriction.avoidAfter || restriction.avoidBefore) {
                    const timeStr = scheduledTime || this.mealToDefaultTime(currentMeal);
                    if (timeStr) {
                        const mins = this.timeToMinutes(timeStr);
                        if (restriction.avoidAfter) {
                            const afterMins = this.timeToMinutes(restriction.avoidAfter);
                            if (mins >= afterMins) return true;
                        }
                        if (restriction.avoidBefore) {
                            const beforeMins = this.timeToMinutes(restriction.avoidBefore);
                            if (mins <= beforeMins) return true;
                        }
                    }
                }
                return false;

            case 'frequency':
                // Always show the frequency limit reminder so dietitian is aware
                return true;

            case 'quantity':
                // Always show the limit reminder
                return true;

            default:
                return true;
        }
    }

    private timeToMinutes(time: string): number {
        const [h, m] = time.split(':').map(Number);
        return (h || 0) * 60 + (m || 0);
    }

    private mealToDefaultTime(meal: string): string {
        const defaults: Record<string, string> = {
            breakfast: '08:00',
            lunch: '13:00',
            snack: '16:00',
            dinner: '20:00',
        };
        return defaults[meal] || '12:00';
    }

    private checkMedicalConditions(client: ClientTags, food: FoodTags): ValidationAlert[] {
        const alerts: ValidationAlert[] = [];

        // Pre-diabetes/diabetes + high sugar
        if (
            (client.medicalConditions.has('pre_diabetes') || client.medicalConditions.has('diabetes')) &&
            food.nutritionTags.has('high_sugar')
        ) {
            alerts.push({
                type: 'medical',
                severity: ValidationSeverity.YELLOW,
                message: `🟡 DIABETES CAUTION: This food is high in sugar`,
                recommendation: 'Consider lower-sugar alternative',
                icon: 'heart-pulse'
            });
        }

        // Heart issues + high cholesterol/saturated fat
        if (
            (client.medicalConditions.has('heart_pain') || client.medicalConditions.has('heart_disease')) &&
            (food.healthFlags.has('cholesterol_caution') || food.nutritionTags.has('high_saturated_fat'))
        ) {
            alerts.push({
                type: 'medical',
                severity: ValidationSeverity.YELLOW,
                message: `🟡 HEART CAUTION: This food may be high in cholesterol/saturated fat`,
                recommendation: 'Limit intake or choose heart-healthy alternatives',
                icon: 'heart'
            });
        }

        // Hypertension + high sodium
        if (
            client.medicalConditions.has('hypertension') &&
            food.nutritionTags.has('high_sodium')
        ) {
            alerts.push({
                type: 'medical',
                severity: ValidationSeverity.YELLOW,
                message: `🟡 HYPERTENSION CAUTION: This food is high in sodium`,
                recommendation: 'Choose low-sodium alternatives',
                icon: 'droplet'
            });
        }

        return alerts;
    }

    private checkLabDerivedTags(client: ClientTags, food: FoodTags): ValidationAlert[] {
        const alerts: ValidationAlert[] = [];

        // Diabetic / pre-diabetic + high sugar food
        if (
            (client.labDerivedTags.has('diabetic') || client.labDerivedTags.has('pre_diabetic')) &&
            (food.nutritionTags.has('high_sugar') || food.healthFlags.has('diabetic_caution'))
        ) {
            const isDiabetic = client.labDerivedTags.has('diabetic');
            alerts.push({
                type: 'lab_derived',
                severity: ValidationSeverity.YELLOW,
                message: isDiabetic
                    ? `🟡 LAB ALERT: Client is diabetic (elevated HbA1c) - avoid high-sugar foods`
                    : `🟡 LAB ALERT: Client is pre-diabetic - limit sugar intake`,
                recommendation: isDiabetic ? 'Choose sugar-free or low-GI alternatives' : 'Moderate sugar intake',
                icon: 'test-tube'
            });
        }

        // High cholesterol + cholesterol-heavy food
        if (
            (client.labDerivedTags.has('high_cholesterol') || client.labDerivedTags.has('borderline_cholesterol')) &&
            food.healthFlags.has('cholesterol_caution')
        ) {
            alerts.push({
                type: 'lab_derived',
                severity: ValidationSeverity.YELLOW,
                message: `🟡 LAB ALERT: Client's cholesterol is elevated - limit high-cholesterol foods`,
                recommendation: 'Maximum 2-3 times per week',
                icon: 'test-tube'
            });
        }

        // High triglycerides + high fat food
        if (
            client.labDerivedTags.has('high_triglycerides') &&
            (food.nutritionTags.has('high_fat') || food.healthFlags.has('heart_caution'))
        ) {
            alerts.push({
                type: 'lab_derived',
                severity: ValidationSeverity.YELLOW,
                message: `🟡 LAB ALERT: Client has high triglycerides - limit high-fat foods`,
                recommendation: 'Choose lean proteins and healthy fats',
                icon: 'test-tube'
            });
        }

        // Kidney caution / high uric acid + high protein food
        if (
            (client.labDerivedTags.has('kidney_caution') || client.labDerivedTags.has('high_uric_acid')) &&
            (food.nutritionTags.has('high_protein') || food.healthFlags.has('kidney_caution'))
        ) {
            alerts.push({
                type: 'lab_derived',
                severity: ValidationSeverity.YELLOW,
                message: `🟡 LAB ALERT: Client has elevated kidney markers - limit high-protein foods`,
                recommendation: 'Keep protein moderate, reduce red meat and organ meats',
                icon: 'test-tube'
            });
        }

        // Vitamin D deficiency - positive nudge for vitamin D rich foods
        if (
            (client.labDerivedTags.has('vitamin_d_deficiency') || client.labDerivedTags.has('severe_vitamin_d_deficiency')) &&
            food.healthFlags.has('vitamin_d_rich')
        ) {
            alerts.push({
                type: 'lab_derived',
                severity: ValidationSeverity.GREEN,
                message: `✅ NUTRIENT MATCH: Good source of Vitamin D for client`,
                icon: 'sun'
            });
        }

        // B12 deficiency - positive nudge for B12-rich foods
        if (
            client.labDerivedTags.has('b12_deficiency') &&
            food.healthFlags.has('b12_rich')
        ) {
            alerts.push({
                type: 'lab_derived',
                severity: ValidationSeverity.GREEN,
                message: `✅ NUTRIENT MATCH: Good source of Vitamin B12 for client`,
                icon: 'pill'
            });
        }

        // Iron deficiency / anemia - positive nudge for iron-rich foods
        if (
            (client.labDerivedTags.has('iron_deficiency') || client.labDerivedTags.has('anemia')) &&
            food.healthFlags.has('iron_rich')
        ) {
            alerts.push({
                type: 'lab_derived',
                severity: ValidationSeverity.GREEN,
                message: `✅ NUTRIENT MATCH: Good source of Iron for client with low iron/hemoglobin`,
                icon: 'heart-pulse'
            });
        }

        return alerts;
    }

    /**
     * Word-level matching with plural normalization.
     * "egg" matches "eggs" or "egg curry" but NOT "eggplant".
     * "bitter gourd" matches "bitter gourd curry".
     */
    private wordMatch(foodName: string, keyword: string): boolean {
        const foodWords = foodName.split(/\s+/);
        const keyWords = keyword.split(/\s+/);

        // Multi-word keyword (e.g. "bitter gourd"): check contiguous word sequence
        if (keyWords.length > 1) {
            for (let i = 0; i <= foodWords.length - keyWords.length; i++) {
                const allMatch = keyWords.every((kw, j) => this.pluralMatch(foodWords[i + j], kw));
                if (allMatch) return true;
            }
            return false;
        }

        // Single-word keyword: check if any food word matches
        return foodWords.some(fw => this.pluralMatch(fw, keyWords[0]));
    }

    /** Two words match if identical, or one is the other + 's'/'es' */
    private pluralMatch(a: string, b: string): boolean {
        if (a === b) return true;
        if (a + 's' === b || b + 's' === a) return true;
        if (a + 'es' === b || b + 'es' === a) return true;
        return false;
    }

    private checkDislikes(client: ClientTags, food: FoodTags): ValidationAlert | null {
        const foodNameLower = food.name.toLowerCase();

        for (const dislike of client.dislikes) {
            if (this.wordMatch(foodNameLower, dislike)) {
                const displayName = dislike.charAt(0).toUpperCase() + dislike.slice(1);
                return {
                    type: 'dislike',
                    severity: ValidationSeverity.YELLOW,
                    message: `🟡 DISLIKE: Client has indicated they dislike ${displayName}`,
                    recommendation: 'Consider alternative options',
                    icon: 'thumb-down'
                };
            }
        }

        return null;
    }

    private checkLikedFoods(client: ClientTags, food: FoodTags): ValidationAlert | null {
        const foodNameLower = food.name.toLowerCase();

        for (const liked of client.likedFoods) {
            const likedLower = liked.toLowerCase();
            if (this.wordMatch(foodNameLower, likedLower)) {
                const displayName = liked.charAt(0).toUpperCase() + liked.slice(1);
                return {
                    type: 'preference_match',
                    severity: ValidationSeverity.GREEN,
                    message: `✅ CLIENT FAVORITE: Client likes ${displayName}`,
                    icon: 'heart'
                };
            }
        }
        return null;
    }

    private checkPreferredCuisines(client: ClientTags, food: FoodTags): ValidationAlert | null {
        for (const cuisine of client.preferredCuisines) {
            if (food.cuisineTags.has(cuisine)) {
                return {
                    type: 'cuisine_match',
                    severity: ValidationSeverity.GREEN,
                    message: `✅ PREFERRED CUISINE: Client likes ${cuisine} food`,
                    icon: 'utensils'
                };
            }
        }
        return null;
    }

    private checkCategoryAvoidance(client: ClientTags, food: FoodTags): ValidationAlert | null {
        if (client.avoidCategories.size === 0) return null;

        for (const category of client.avoidCategories) {
            const matches = matchesCategoryAvoidance(category, {
                category: food.name,
                processingLevel: food.processingLevel || undefined,
                cuisineTags: Array.from(food.cuisineTags)
            });

            if (matches) {
                return {
                    type: 'dislike',
                    severity: ValidationSeverity.YELLOW,
                    message: `🟡 AVOID CATEGORY: Client prefers to avoid ${category.replace(/_/g, ' ')}`,
                    recommendation: 'Consider alternatives from preferred categories',
                    icon: 'x-circle'
                };
            }
        }

        return null;
    }

    private checkMealSuitability(food: FoodTags, mealType: string): ValidationAlert | null {
        if (food.mealSuitabilityTags.size === 0) return null;

        const mealTypeLower = mealType.toLowerCase();

        for (const tag of food.mealSuitabilityTags) {
            const conflicts = MEAL_SUITABILITY_CONFLICTS[tag];
            if (conflicts && conflicts.includes(mealTypeLower)) {
                const tagDisplay = tag.replace(/_/g, ' ');
                return {
                    type: 'dislike',
                    severity: ValidationSeverity.YELLOW,
                    message: `ℹ️ MEAL TIMING: This food is ${tagDisplay}`,
                    recommendation: `Consider alternatives better suited for ${mealType}`,
                    icon: 'clock'
                };
            }
        }

        return null;
    }

    // ============ PRIVATE: PLAN-CONTEXT RULES ============

    protected async getPlanTargets(planId: string): Promise<PlanTargets | null> {
        const plan = await prisma.dietPlan.findUnique({
            where: { id: planId },
            select: {
                targetCalories: true,
                targetProteinG: true,
                targetCarbsG: true,
                targetFatsG: true
            }
        });
        if (!plan) return null;
        return {
            targetCalories: plan.targetCalories,
            targetProteinG: plan.targetProteinG ? Number(plan.targetProteinG) : null,
            targetCarbsG: plan.targetCarbsG ? Number(plan.targetCarbsG) : null,
            targetFatsG: plan.targetFatsG ? Number(plan.targetFatsG) : null
        };
    }

    protected async getPlanFoodCounts(planId: string): Promise<Map<string, number>> {
        const items = await prisma.mealFoodItem.findMany({
            where: { meal: { planId } },
            select: { foodId: true }
        });
        const counts = new Map<string, number>();
        for (const item of items) {
            counts.set(item.foodId, (counts.get(item.foodId) || 0) + 1);
        }
        return counts;
    }

    protected async checkRepetition(foodId: string, planId: string): Promise<ValidationAlert[]> {
        const items = await prisma.mealFoodItem.findMany({
            where: { foodId, meal: { planId } },
            select: { meal: { select: { dayOfWeek: true } } }
        });

        const alerts: ValidationAlert[] = [];
        const count = items.length;

        // Total count check
        if (count >= VALIDATION_CONFIG.REPETITION_THRESHOLD) {
            alerts.push({
                type: 'repetition',
                severity: ValidationSeverity.YELLOW,
                message: `🟡 REPETITION: This food appears ${count} times this week. Consider variety.`,
                recommendation: 'Try different foods for nutritional variety',
                icon: 'repeat'
            });
        }

        // Consecutive days check
        if (count >= 2) {
            const days = [...new Set(items.map(i => i.meal.dayOfWeek).filter((d): d is number => d !== null))].sort();
            const maxConsecutive = this.longestConsecutiveRun(days);
            if (maxConsecutive > VALIDATION_CONFIG.REPETITION_MAX_CONSECUTIVE_DAYS) {
                alerts.push({
                    type: 'repetition',
                    severity: ValidationSeverity.YELLOW,
                    message: `🟡 SPACING: This food appears on ${maxConsecutive} consecutive days. Spread it out for variety.`,
                    recommendation: 'Leave at least a day gap between servings of the same food',
                    icon: 'calendar'
                });
            }
        }

        return alerts;
    }

    private longestConsecutiveRun(sortedDays: number[]): number {
        if (sortedDays.length <= 1) return sortedDays.length;
        let maxRun = 1;
        let currentRun = 1;
        for (let i = 1; i < sortedDays.length; i++) {
            if (sortedDays[i] === sortedDays[i - 1] + 1) {
                currentRun++;
                maxRun = Math.max(maxRun, currentRun);
            } else if (sortedDays[i] !== sortedDays[i - 1]) {
                currentRun = 1;
            }
        }
        return maxRun;
    }

    private checkNutritionStrength(food: FoodTags, targets: PlanTargets): ValidationAlert[] {
        const alerts: ValidationAlert[] = [];
        const calWarnPct = VALIDATION_CONFIG.SINGLE_FOOD_CALORIE_WARN_PCT;
        const macroWarnPct = VALIDATION_CONFIG.SINGLE_FOOD_MACRO_WARN_PCT;

        if (food.calories && targets.targetCalories) {
            const pct = food.calories / targets.targetCalories;
            if (pct > calWarnPct) {
                alerts.push({
                    type: 'nutrition_strength',
                    severity: ValidationSeverity.YELLOW,
                    message: `🟡 HIGH CALORIE: This food provides ${Math.round(pct * 100)}% of the daily calorie target in one serving`,
                    recommendation: 'Consider a smaller portion or lower-calorie alternative',
                    icon: 'flame'
                });
            }
        }

        if (food.proteinG && targets.targetProteinG) {
            const pct = food.proteinG / targets.targetProteinG;
            if (pct > macroWarnPct) {
                alerts.push({
                    type: 'nutrition_strength',
                    severity: ValidationSeverity.YELLOW,
                    message: `🟡 HIGH PROTEIN: This food provides ${Math.round(pct * 100)}% of the daily protein target`,
                    icon: 'beef'
                });
            }
        }

        if (food.carbsG && targets.targetCarbsG) {
            const pct = food.carbsG / targets.targetCarbsG;
            if (pct > macroWarnPct) {
                alerts.push({
                    type: 'nutrition_strength',
                    severity: ValidationSeverity.YELLOW,
                    message: `🟡 HIGH CARBS: This food provides ${Math.round(pct * 100)}% of the daily carb target`,
                    icon: 'wheat'
                });
            }
        }

        if (food.fatsG && targets.targetFatsG) {
            const pct = food.fatsG / targets.targetFatsG;
            if (pct > macroWarnPct) {
                alerts.push({
                    type: 'nutrition_strength',
                    severity: ValidationSeverity.YELLOW,
                    message: `🟡 HIGH FAT: This food provides ${Math.round(pct * 100)}% of the daily fat target`,
                    icon: 'droplets'
                });
            }
        }

        return alerts;
    }

    // ============ PRIVATE: RESULT BUILDING ============

    private buildResult(
        food: FoodTags,
        severity: ValidationSeverity,
        alerts: ValidationAlert[],
        startTime: number
    ): ValidationResult {
        return {
            foodId: food.id,
            foodName: food.name,
            severity,
            borderColor: severity === ValidationSeverity.RED ? 'red'
                : severity === ValidationSeverity.YELLOW ? 'yellow'
                    : 'green',
            canAdd: severity !== ValidationSeverity.RED,
            alerts,
            confidenceScore: 0.95 // Could be dynamic based on tag confidence
        };
    }
}

// Singleton instance
export const validationEngine = new ValidationEngine();
</file>

<file path="backend/src/utils/prisma.ts">
import { PrismaClient, Prisma } from '@prisma/client';

const SOFT_DELETE_MODELS: Prisma.ModelName[] = [
    'Organization',
    'User',
    'Client',
    'DietPlan',
    'SessionNote',
    'Meal',
    'MealLog',
    'WeightLog',
    'BodyMeasurement',
    'FoodItem',
    'MealFoodItem',
    'Invoice',
];

function isSoftDeleteModel(model: string | undefined): boolean {
    return !!model && SOFT_DELETE_MODELS.includes(model as Prisma.ModelName);
}

/** Convert PascalCase model name to camelCase Prisma client property */
function modelToProperty(model: string): string {
    return model.charAt(0).toLowerCase() + model.slice(1);
}

function createExtendedClient() {
    const base = new PrismaClient({
        log: ['error', 'warn'],
    });

    return base.$extends({
        query: {
            $allModels: {
                async findMany({ model, args, query }) {
                    if (isSoftDeleteModel(model) && !(args.where as any)?.deletedAt) {
                        args.where = { ...(args.where ?? {}), deletedAt: null } as any;
                    }
                    return query(args);
                },
                async findFirst({ model, args, query }) {
                    if (isSoftDeleteModel(model) && !(args.where as any)?.deletedAt) {
                        args.where = { ...(args.where ?? {}), deletedAt: null } as any;
                    }
                    return query(args);
                },
                async findFirstOrThrow({ model, args, query }) {
                    if (isSoftDeleteModel(model) && !(args.where as any)?.deletedAt) {
                        args.where = { ...(args.where ?? {}), deletedAt: null } as any;
                    }
                    return query(args);
                },
                async count({ model, args, query }) {
                    if (isSoftDeleteModel(model) && !(args.where as any)?.deletedAt) {
                        args.where = { ...(args.where ?? {}), deletedAt: null } as any;
                    }
                    return query(args);
                },
                async aggregate({ model, args, query }) {
                    if (isSoftDeleteModel(model) && !(args.where as any)?.deletedAt) {
                        args.where = { ...(args.where ?? {}), deletedAt: null } as any;
                    }
                    return query(args);
                },
                async groupBy({ model, args, query }) {
                    if (isSoftDeleteModel(model) && !(args.where as any)?.deletedAt) {
                        args.where = { ...(args.where ?? {}), deletedAt: null } as any;
                    }
                    return query(args);
                },
                async delete({ model, args, query }) {
                    if (isSoftDeleteModel(model)) {
                        // Convert hard delete to soft delete via base client
                        const prop = modelToProperty(model);
                        return (base as any)[prop].update({
                            where: args.where,
                            data: { deletedAt: new Date() },
                        });
                    }
                    return query(args);
                },
                async deleteMany({ model, args, query }) {
                    if (isSoftDeleteModel(model)) {
                        const prop = modelToProperty(model);
                        return (base as any)[prop].updateMany({
                            where: (args as any).where,
                            data: { deletedAt: new Date() },
                        });
                    }
                    return query(args);
                },
            },
        },
    });
}

type ExtendedPrismaClient = ReturnType<typeof createExtendedClient>;

const globalForPrisma = globalThis as unknown as {
    prisma: ExtendedPrismaClient | undefined;
};

const prisma = globalForPrisma.prisma ?? createExtendedClient();

export default prisma;

if (process.env.NODE_ENV !== 'production') {
    globalForPrisma.prisma = prisma;
}
</file>

<file path="backend/package.json">
{
  "name": "backend",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "dev": "tsx watch src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "@aws-sdk/client-s3": "^3.893.0",
    "@aws-sdk/s3-request-presigner": "^3.893.0",
    "@clerk/express": "^1.7.56",
    "@prisma/client": "6.16.0",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "helmet": "^8.1.0",
    "jsonwebtoken": "^9.0.3",
    "morgan": "^1.10.1",
    "multer": "^2.0.2",
    "nodemailer": "^7.0.12",
    "pdfkit": "^0.17.2",
    "prisma": "6.16.0",
    "sharp": "^0.34.5",
    "winston": "^3.19.0",
    "zod": "^4.1.13"
  },
  "devDependencies": {
    "@types/cors": "^2.8.19",
    "@types/express": "^5.0.6",
    "@types/jsonwebtoken": "^9.0.10",
    "@types/morgan": "^1.9.10",
    "@types/multer": "^2.0.0",
    "@types/node": "^24.10.1",
    "@types/nodemailer": "^7.0.5",
    "@types/pdfkit": "^0.17.4",
    "ts-node": "^10.9.2",
    "tsx": "^4.21.0",
    "typescript": "^5.9.3"
  }
}
</file>

<file path="client-app/app/(onboarding)/complete.tsx">
import { View, Text, StyleSheet, TouchableOpacity, ActivityIndicator } from 'react-native';
import { useRouter } from 'expo-router';
import { useEffect, useState } from 'react';
import { CheckCircle } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../constants/theme';
import { onboardingApi } from '../../services/api';
import { useAuth } from '../../hooks/useAuth';

export default function CompleteScreen() {
    const router = useRouter();
    const { refreshClient } = useAuth();
    const [completing, setCompleting] = useState(true);

    useEffect(() => {
        completeOnboarding();
    }, []);

    const completeOnboarding = async () => {
        try {
            await onboardingApi.complete();
            await refreshClient();
        } catch (error) {
            // Non-critical — user can still proceed
        } finally {
            setCompleting(false);
        }
    };

    const handleStart = () => {
        router.replace('/(tabs)/home');
    };

    if (completing) {
        return (
            <View style={styles.container}>
                <ActivityIndicator size="large" color={Colors.primaryDark} />
                <Text style={[styles.subtitle, { marginTop: Spacing.lg }]}>Setting up your profile...</Text>
            </View>
        );
    }

    return (
        <View style={styles.container}>
            <View style={styles.iconContainer}>
                <CheckCircle size={80} color={Colors.primaryDark} />
            </View>

            <Text style={styles.title}>All Set!</Text>
            <Text style={styles.subtitle}>
                Your profile has been set up. Your dietitian will now create a personalized plan for you based on these preferences.
            </Text>

            <TouchableOpacity
                style={styles.button}
                onPress={handleStart}
            >
                <Text style={styles.buttonText}>Go to Dashboard</Text>
            </TouchableOpacity>
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.surface,
        justifyContent: 'center',
        alignItems: 'center',
        padding: Spacing.xxxl,
    },
    iconContainer: {
        marginBottom: Spacing.xxxl,
        shadowColor: Colors.primaryDark,
        shadowOffset: { width: 0, height: 10 },
        shadowOpacity: 0.3,
        shadowRadius: 20,
        elevation: 10,
    },
    title: {
        fontSize: FontSizes.display,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.lg,
        textAlign: 'center',
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textMuted,
        marginBottom: 48,
        textAlign: 'center',
        lineHeight: 24,
    },
    button: {
        backgroundColor: Colors.primaryDark,
        paddingVertical: Spacing.xl,
        paddingHorizontal: Spacing.xxxl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        width: '100%',
        shadowColor: Colors.primaryDark,
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.2,
        shadowRadius: 8,
        elevation: 4,
    },
    buttonText: {
        color: Colors.surface,
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.semibold,
    }
});
</file>

<file path="client-app/app/(onboarding)/step1.tsx">
import { View, Text, TextInput, StyleSheet, TouchableOpacity, ScrollView, Alert, ActivityIndicator } from 'react-native';
import { useState } from 'react';
import { useRouter } from 'expo-router';
import { Picker } from '@react-native-picker/picker';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../constants/theme';
import { onboardingApi } from '../../services/api';

export default function BasicInfoScreen() {
    const router = useRouter();
    const [height, setHeight] = useState('');
    const [weight, setWeight] = useState('');
    const [targetWeight, setTargetWeight] = useState('');
    const [gender, setGender] = useState('male');
    const [activityLevel, setActivityLevel] = useState('SEDENTARY');
    const [saving, setSaving] = useState(false);

    const handleNext = async () => {
        if (!height || !weight) {
            Alert.alert('Required Fields', 'Please enter your height and current weight.');
            return;
        }

        setSaving(true);
        try {
            await onboardingApi.saveStep(1, {
                heightCm: parseFloat(height),
                currentWeightKg: parseFloat(weight),
                targetWeightKg: targetWeight ? parseFloat(targetWeight) : undefined,
                gender,
                activityLevel: activityLevel.toLowerCase(),
            });
            router.push('/(onboarding)/step2');
        } catch (error) {
            Alert.alert('Error', 'Failed to save. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    return (
        <ScrollView style={styles.container} contentContainerStyle={styles.content}>
            <Text style={styles.title}>Let's get to know you</Text>
            <Text style={styles.subtitle}>We need some basic information to calculate your nutritional needs.</Text>

            <View style={styles.formGroup}>
                <Text style={styles.label}>Height (cm)</Text>
                <TextInput
                    style={styles.input}
                    value={height}
                    onChangeText={setHeight}
                    keyboardType="numeric"
                    placeholder="e.g. 175"
                />
            </View>

            <View style={styles.row}>
                <View style={[styles.formGroup, { flex: 1, marginRight: 10 }]}>
                    <Text style={styles.label}>Current Weight (kg)</Text>
                    <TextInput
                        style={styles.input}
                        value={weight}
                        onChangeText={setWeight}
                        keyboardType="numeric"
                        placeholder="e.g. 70"
                    />
                </View>

                <View style={[styles.formGroup, { flex: 1 }]}>
                    <Text style={styles.label}>Target Weight (kg)</Text>
                    <TextInput
                        style={styles.input}
                        value={targetWeight}
                        onChangeText={setTargetWeight}
                        keyboardType="numeric"
                        placeholder="e.g. 65"
                    />
                </View>
            </View>

            <View style={styles.formGroup}>
                <Text style={styles.label}>Gender</Text>
                <View style={styles.pickerContainer}>
                    <Picker
                        selectedValue={gender}
                        onValueChange={(itemValue) => setGender(itemValue)}
                    >
                        <Picker.Item label="Male" value="male" />
                        <Picker.Item label="Female" value="female" />
                        <Picker.Item label="Other" value="other" />
                    </Picker>
                </View>
            </View>

            <View style={styles.formGroup}>
                <Text style={styles.label}>Activity Level</Text>
                <View style={styles.pickerContainer}>
                    <Picker
                        selectedValue={activityLevel}
                        onValueChange={(itemValue) => setActivityLevel(itemValue)}
                    >
                        <Picker.Item label="Sedentary (Little/no exercise)" value="SEDENTARY" />
                        <Picker.Item label="Lightly Active (1-3 days/week)" value="LIGHTLY_ACTIVE" />
                        <Picker.Item label="Moderately Active (3-5 days/week)" value="MODERATELY_ACTIVE" />
                        <Picker.Item label="Very Active (6-7 days/week)" value="VERY_ACTIVE" />
                        <Picker.Item label="Extremely Active (Physical job)" value="EXTREMELY_ACTIVE" />
                    </Picker>
                </View>
            </View>

            <TouchableOpacity
                style={[styles.button, saving && styles.buttonDisabled]}
                onPress={handleNext}
                disabled={saving}
            >
                {saving ? (
                    <ActivityIndicator color={Colors.surface} />
                ) : (
                    <Text style={styles.buttonText}>Next Step</Text>
                )}
            </TouchableOpacity>
        </ScrollView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.surface,
    },
    content: {
        padding: Spacing.xxl,
    },
    title: {
        fontSize: 24,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textMuted,
        marginBottom: Spacing.xxxl,
        lineHeight: 22,
    },
    formGroup: {
        marginBottom: Spacing.xl,
    },
    row: {
        flexDirection: 'row',
    },
    label: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    input: {
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: Spacing.lg,
        fontSize: FontSizes.lg,
        backgroundColor: Colors.background,
    },
    pickerContainer: {
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        backgroundColor: Colors.background,
        overflow: 'hidden',
    },
    button: {
        backgroundColor: Colors.primaryDark,
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.xl,
        shadowColor: Colors.primaryDark,
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.2,
        shadowRadius: 8,
        elevation: 4,
    },
    buttonDisabled: {
        opacity: 0.6,
    },
    buttonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    }
});
</file>

<file path="client-app/app/(onboarding)/step2.tsx">
import { View, Text, StyleSheet, TouchableOpacity, ScrollView, Switch, Alert, ActivityIndicator } from 'react-native';
import { useState } from 'react';
import { useRouter } from 'expo-router';
import { Shield, Fish, Egg, Leaf } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../constants/theme';
import { onboardingApi } from '../../services/api';

const DIET_PATTERNS = [
    { id: 'vegetarian', name: 'Vegetarian', icon: Leaf, desc: 'No meat, fish, or poultry. Dairy allowed.' },
    { id: 'vegan', name: 'Vegan', icon: Leaf, desc: 'Plant-based only. No animal products.' },
    { id: 'non_veg', name: 'Non-Vegetarian', icon: Fish, desc: 'Includes meat, fish, and poultry.' },
    { id: 'eggetarian', name: 'Eggetarian', icon: Egg, desc: 'Vegetarian + Eggs.' },
    { id: 'pescatarian', name: 'Pescatarian', icon: Fish, desc: 'Vegetarian + Fish/Seafood.' },
];

export default function DietPatternScreen() {
    const router = useRouter();
    const [selectedPattern, setSelectedPattern] = useState('vegetarian');
    const [eggAllowed, setEggAllowed] = useState(false);
    const [saving, setSaving] = useState(false);

    const handleNext = async () => {
        setSaving(true);
        try {
            await onboardingApi.saveStep(2, {
                dietPattern: selectedPattern,
                eggAllowed: selectedPattern === 'vegetarian' ? eggAllowed : selectedPattern === 'eggetarian',
            });
            router.push('/(onboarding)/step3');
        } catch (error) {
            Alert.alert('Error', 'Failed to save. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    return (
        <ScrollView style={styles.container} contentContainerStyle={styles.content}>
            <Text style={styles.title}>Your Diet Pattern</Text>
            <Text style={styles.subtitle}>Choose the pattern that best describes your typical eating habits.</Text>

            <View style={styles.patterns}>
                {DIET_PATTERNS.map((pattern) => (
                    <TouchableOpacity
                        key={pattern.id}
                        style={[
                            styles.patternCard,
                            selectedPattern === pattern.id && styles.selectedCard
                        ]}
                        onPress={() => setSelectedPattern(pattern.id)}
                    >
                        <View style={styles.iconContainer}>
                            <pattern.icon size={24} color={selectedPattern === pattern.id ? Colors.primaryDark : Colors.textMuted} />
                        </View>
                        <View style={styles.textContainer}>
                            <Text style={[
                                styles.patternName,
                                selectedPattern === pattern.id && styles.selectedText
                            ]}>{pattern.name}</Text>
                            <Text style={styles.patternDesc}>{pattern.desc}</Text>
                        </View>
                        <View style={[
                            styles.radio,
                            selectedPattern === pattern.id && styles.selectedRadio
                        ]} />
                    </TouchableOpacity>
                ))}
            </View>

            {selectedPattern === 'vegetarian' && (
                <View style={styles.eggOption}>
                    <Text style={styles.eggLabel}>Do you eat eggs?</Text>
                    <Switch
                        value={eggAllowed}
                        onValueChange={setEggAllowed}
                        trackColor={{ false: Colors.borderLight, true: Colors.primaryDark }}
                        thumbColor={Colors.surface}
                    />
                </View>
            )}

            <TouchableOpacity
                style={[styles.button, saving && styles.buttonDisabled]}
                onPress={handleNext}
                disabled={saving}
            >
                {saving ? (
                    <ActivityIndicator color={Colors.surface} />
                ) : (
                    <Text style={styles.buttonText}>Next Step</Text>
                )}
            </TouchableOpacity>
        </ScrollView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.surface,
    },
    content: {
        padding: Spacing.xxl,
    },
    title: {
        fontSize: 24,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textMuted,
        marginBottom: Spacing.xxxl,
        lineHeight: 22,
    },
    patterns: {
        gap: Spacing.md,
    },
    patternCard: {
        flexDirection: 'row',
        alignItems: 'center',
        padding: Spacing.lg,
        borderRadius: BorderRadius.md,
        borderWidth: 1,
        borderColor: Colors.borderLight,
        backgroundColor: Colors.surface,
    },
    selectedCard: {
        borderColor: Colors.primaryDark,
        backgroundColor: Colors.surfaceSecondary,
    },
    iconContainer: {
        marginRight: Spacing.lg,
    },
    textContainer: {
        flex: 1,
    },
    patternName: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginBottom: Spacing.xs,
    },
    selectedText: {
        color: Colors.primaryDark,
    },
    patternDesc: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
    },
    radio: {
        width: 20,
        height: 20,
        borderRadius: 10,
        borderWidth: 2,
        borderColor: Colors.border,
    },
    selectedRadio: {
        borderColor: Colors.primaryDark,
        backgroundColor: Colors.primaryDark,
    },
    eggOption: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginTop: Spacing.xxl,
        padding: Spacing.lg,
        backgroundColor: Colors.background,
        borderRadius: BorderRadius.md,
    },
    eggLabel: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.medium,
        color: Colors.text,
    },
    button: {
        backgroundColor: Colors.primaryDark,
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.xxxl,
        shadowColor: Colors.primaryDark,
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.2,
        shadowRadius: 8,
        elevation: 4,
    },
    buttonDisabled: {
        opacity: 0.6,
    },
    buttonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    }
});
</file>

<file path="client-app/app/(onboarding)/step3.tsx">
import { View, Text, StyleSheet, TouchableOpacity, ScrollView, TextInput, Alert, ActivityIndicator } from 'react-native';
import { useState } from 'react';
import { useRouter } from 'expo-router';
import { AlertTriangle, Plus, X } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../constants/theme';
import { onboardingApi } from '../../services/api';

const COMMON_ALLERGENS = [
    'Peanuts', 'Tree Nuts', 'Milk', 'Eggs', 'Wheat', 'Soy', 'Fish', 'Shellfish'
];

export default function AllergiesScreen() {
    const router = useRouter();
    const [allergies, setAllergies] = useState<string[]>([]);
    const [customAllergy, setCustomAllergy] = useState('');
    const [intolerances, setIntolerances] = useState<string[]>([]);
    const [saving, setSaving] = useState(false);

    const toggleAllergy = (allergen: string) => {
        if (allergies.includes(allergen)) {
            setAllergies(allergies.filter(a => a !== allergen));
        } else {
            setAllergies([...allergies, allergen]);
        }
    };

    const addCustomAllergy = () => {
        if (customAllergy && !allergies.includes(customAllergy)) {
            setAllergies([...allergies, customAllergy]);
            setCustomAllergy('');
        }
    };

    const handleNext = async () => {
        setSaving(true);
        try {
            await onboardingApi.saveStep(3, {
                allergies,
                intolerances,
            });
            router.push('/(onboarding)/step4');
        } catch (error) {
            Alert.alert('Error', 'Failed to save. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    return (
        <ScrollView style={styles.container} contentContainerStyle={styles.content}>
            <Text style={styles.title}>Allergies & Intolerances</Text>
            <Text style={styles.subtitle}>Do you have any food allergies or intolerances we should know about?</Text>

            <View style={styles.section}>
                <Text style={styles.sectionTitle}>Common Allergens</Text>
                <View style={styles.chipContainer}>
                    {COMMON_ALLERGENS.map((allergen) => (
                        <TouchableOpacity
                            key={allergen}
                            style={[
                                styles.chip,
                                allergies.includes(allergen) && styles.selectedChip
                            ]}
                            onPress={() => toggleAllergy(allergen)}
                        >
                            <Text style={[
                                styles.chipText,
                                allergies.includes(allergen) && styles.selectedChipText
                            ]}>{allergen}</Text>
                        </TouchableOpacity>
                    ))}
                </View>
            </View>

            <View style={styles.section}>
                <Text style={styles.sectionTitle}>Add Other Allergy</Text>
                <View style={styles.inputContainer}>
                    <TextInput
                        style={styles.input}
                        value={customAllergy}
                        onChangeText={setCustomAllergy}
                        placeholder="e.g. Strawberries"
                        onSubmitEditing={addCustomAllergy}
                    />
                    <TouchableOpacity
                        style={styles.addButton}
                        onPress={addCustomAllergy}
                    >
                        <Plus size={20} color={Colors.surface} />
                    </TouchableOpacity>
                </View>
            </View>

            {allergies.length > 0 && (
                <View style={styles.summary}>
                    <View style={styles.warningIcon}>
                        <AlertTriangle size={20} color={Colors.error} />
                    </View>
                    <Text style={styles.summaryText}>
                        We will exclude foods containing: {allergies.join(', ')}
                    </Text>
                </View>
            )}

            <TouchableOpacity
                style={[styles.button, saving && styles.buttonDisabled]}
                onPress={handleNext}
                disabled={saving}
            >
                {saving ? (
                    <ActivityIndicator color={Colors.surface} />
                ) : (
                    <Text style={styles.buttonText}>Next Step</Text>
                )}
            </TouchableOpacity>
        </ScrollView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.surface,
    },
    content: {
        padding: Spacing.xxl,
    },
    title: {
        fontSize: 24,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textMuted,
        marginBottom: Spacing.xxxl,
        lineHeight: 22,
    },
    section: {
        marginBottom: Spacing.xxl,
    },
    sectionTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        marginBottom: Spacing.md,
        color: Colors.text,
    },
    chipContainer: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: Spacing.sm,
    },
    chip: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: 10,
        borderRadius: BorderRadius.xl,
        backgroundColor: Colors.background,
        borderWidth: 1,
        borderColor: Colors.borderLight,
    },
    selectedChip: {
        backgroundColor: '#fee2e2',
        borderColor: Colors.error,
    },
    chipText: {
        color: Colors.textMuted,
        fontWeight: FontWeights.medium,
    },
    selectedChipText: {
        color: Colors.error,
        fontWeight: FontWeights.semibold,
    },
    inputContainer: {
        flexDirection: 'row',
        gap: Spacing.md,
    },
    input: {
        flex: 1,
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: 14,
        fontSize: FontSizes.lg,
        backgroundColor: Colors.background,
    },
    addButton: {
        width: 50,
        height: 50,
        borderRadius: BorderRadius.md,
        backgroundColor: Colors.text,
        justifyContent: 'center',
        alignItems: 'center',
    },
    summary: {
        flexDirection: 'row',
        backgroundColor: '#fef2f2',
        padding: Spacing.lg,
        borderRadius: BorderRadius.md,
        marginTop: Spacing.sm,
        marginBottom: Spacing.xxl,
        alignItems: 'center',
    },
    warningIcon: {
        marginRight: Spacing.md,
    },
    summaryText: {
        flex: 1,
        color: '#b91c1c',
        fontSize: FontSizes.md,
        lineHeight: 20,
    },
    button: {
        backgroundColor: Colors.primaryDark,
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.xl,
    },
    buttonDisabled: {
        opacity: 0.6,
    },
    buttonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    }
});
</file>

<file path="client-app/app/(onboarding)/step4.tsx">
import { View, Text, StyleSheet, TouchableOpacity, ScrollView, Switch, Alert, ActivityIndicator } from 'react-native';
import { useState } from 'react';
import { useRouter } from 'expo-router';
import { Calendar, Apple } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../constants/theme';
import { onboardingApi } from '../../services/api';

const PRESETS = [
    {
        id: 'hindu_fasting_no_meat',
        name: 'Hindu Fasting',
        desc: 'No non-veg on Tuesday & Thursday',
        days: ['Tue', 'Thu']
    },
    {
        id: 'catholic_friday',
        name: 'Catholic Friday',
        desc: 'No meat on Fridays',
        days: ['Fri']
    },
    {
        id: 'jain_strict',
        name: 'Jain Diet',
        desc: 'No root vegetables, onion, garlic',
        days: ['Daily']
    }
];

export default function RestrictionsScreen() {
    const router = useRouter();
    const [selectedPreset, setSelectedPreset] = useState<string | null>(null);
    const [customFasting, setCustomFasting] = useState(false);
    const [saving, setSaving] = useState(false);

    const handleNext = async () => {
        setSaving(true);
        try {
            await onboardingApi.saveStep(4, {
                presetId: selectedPreset || undefined,
            });
            router.push('/(onboarding)/step5');
        } catch (error) {
            Alert.alert('Error', 'Failed to save. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    return (
        <ScrollView style={styles.container} contentContainerStyle={styles.content}>
            <Text style={styles.title}>Food Restrictions</Text>
            <Text style={styles.subtitle}>Do you have religious or customary fasting rules?</Text>

            <View style={styles.section}>
                <Text style={styles.sectionTitle}>Common Presets</Text>
                <View style={styles.presets}>
                    {PRESETS.map((preset) => (
                        <TouchableOpacity
                            key={preset.id}
                            style={[
                                styles.card,
                                selectedPreset === preset.id && styles.selectedCard
                            ]}
                            onPress={() => setSelectedPreset(selectedPreset === preset.id ? null : preset.id)}
                        >
                            <View style={styles.cardHeader}>
                                <View style={[
                                    styles.iconBox,
                                    selectedPreset === preset.id && styles.selectedIconBox
                                ]}>
                                    <Apple size={20} color={selectedPreset === preset.id ? Colors.primaryDark : Colors.textMuted} />
                                </View>
                                <View style={styles.cardText}>
                                    <Text style={[
                                        styles.cardTitle,
                                        selectedPreset === preset.id && styles.selectedText
                                    ]}>{preset.name}</Text>
                                    <Text style={styles.cardDesc}>{preset.desc}</Text>
                                </View>
                                <View style={[
                                    styles.radio,
                                    selectedPreset === preset.id && styles.selectedRadio
                                ]} />
                            </View>
                            {selectedPreset === preset.id && (
                                <View style={styles.tagContainer}>
                                    {preset.days.map((day, i) => (
                                        <View key={i} style={styles.tag}>
                                            <Calendar size={12} color={Colors.primaryDark} />
                                            <Text style={styles.tagText}>{day}</Text>
                                        </View>
                                    ))}
                                </View>
                            )}
                        </TouchableOpacity>
                    ))}
                </View>
            </View>

            <View style={styles.section}>
                <View style={styles.toggleRow}>
                    <Text style={styles.toggleLabel}>I have custom fasting days</Text>
                    <Switch
                        value={customFasting}
                        onValueChange={setCustomFasting}
                        trackColor={{ false: Colors.borderLight, true: Colors.primaryDark }}
                        thumbColor={Colors.surface}
                    />
                </View>
                {customFasting && (
                    <Text style={styles.hint}>You can configure specific days later in your profile.</Text>
                )}
            </View>

            <TouchableOpacity
                style={[styles.button, saving && styles.buttonDisabled]}
                onPress={handleNext}
                disabled={saving}
            >
                {saving ? (
                    <ActivityIndicator color={Colors.surface} />
                ) : (
                    <Text style={styles.buttonText}>Next Step</Text>
                )}
            </TouchableOpacity>
        </ScrollView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.surface,
    },
    content: {
        padding: Spacing.xxl,
    },
    title: {
        fontSize: 24,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textMuted,
        marginBottom: Spacing.xxxl,
        lineHeight: 22,
    },
    section: {
        marginBottom: Spacing.xxl,
    },
    sectionTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        marginBottom: Spacing.md,
        color: Colors.text,
    },
    presets: {
        gap: Spacing.md,
    },
    card: {
        padding: Spacing.lg,
        borderRadius: BorderRadius.md,
        borderWidth: 1,
        borderColor: Colors.borderLight,
        backgroundColor: Colors.surface,
    },
    selectedCard: {
        borderColor: Colors.primaryDark,
        backgroundColor: Colors.surfaceSecondary,
    },
    cardHeader: {
        flexDirection: 'row',
        alignItems: 'center',
    },
    iconBox: {
        width: 40,
        height: 40,
        borderRadius: BorderRadius.sm,
        backgroundColor: Colors.background,
        alignItems: 'center',
        justifyContent: 'center',
        marginRight: Spacing.md,
    },
    selectedIconBox: {
        backgroundColor: Colors.surface,
    },
    cardText: {
        flex: 1,
    },
    cardTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
        marginBottom: 2,
    },
    selectedText: {
        color: Colors.primaryDark,
    },
    cardDesc: {
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
    },
    radio: {
        width: 20,
        height: 20,
        borderRadius: 10,
        borderWidth: 2,
        borderColor: Colors.border,
    },
    selectedRadio: {
        borderColor: Colors.primaryDark,
        backgroundColor: Colors.primaryDark,
    },
    tagContainer: {
        flexDirection: 'row',
        marginTop: Spacing.md,
        gap: Spacing.sm,
        paddingTop: Spacing.md,
        borderTopWidth: 1,
        borderTopColor: Colors.borderLight,
    },
    tag: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.xs,
        backgroundColor: Colors.surface,
        paddingHorizontal: Spacing.sm,
        paddingVertical: Spacing.xs,
        borderRadius: 6,
    },
    tagText: {
        fontSize: FontSizes.xs,
        color: Colors.primaryDark,
        fontWeight: FontWeights.medium,
    },
    toggleRow: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: Spacing.lg,
        backgroundColor: Colors.background,
        borderRadius: BorderRadius.md,
    },
    toggleLabel: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.medium,
        color: Colors.text,
    },
    hint: {
        marginTop: Spacing.sm,
        fontSize: FontSizes.xs,
        color: Colors.textMuted,
        fontStyle: 'italic',
    },
    button: {
        backgroundColor: Colors.primaryDark,
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.xl,
    },
    buttonDisabled: {
        opacity: 0.6,
    },
    buttonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    }
});
</file>

<file path="client-app/app/(onboarding)/step5.tsx">
import { View, Text, StyleSheet, TouchableOpacity, ScrollView, TextInput, Alert, ActivityIndicator } from 'react-native';
import { useState } from 'react';
import { useRouter } from 'expo-router';
import { ThumbsDown, ThumbsUp, Plus } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../constants/theme';
import { onboardingApi } from '../../services/api';

const COMMON_DISLIKES = [
    'Mushrooms', 'Eggplant', 'Bitter Gourd', 'Okra', 'Seafood', 'Coriander', 'Papaya'
];

const COMMON_LIKED_FOODS = [
    'Paneer', 'Chicken', 'Rice', 'Dal', 'Roti', 'Eggs', 'Fish', 'Salad'
];

const CUISINES = [
    'North Indian', 'South Indian', 'Chinese', 'Continental', 'Mediterranean', 'Bengali', 'Gujarati', 'Punjabi'
];

export default function PreferencesScreen() {
    const router = useRouter();
    const [dislikes, setDislikes] = useState<string[]>([]);
    const [customDislike, setCustomDislike] = useState('');
    const [likedFoods, setLikedFoods] = useState<string[]>([]);
    const [preferredCuisines, setPreferredCuisines] = useState<string[]>([]);
    const [saving, setSaving] = useState(false);

    const toggleItem = (list: string[], setList: (items: string[]) => void, item: string) => {
        if (list.includes(item)) {
            setList(list.filter(i => i !== item));
        } else {
            setList([...list, item]);
        }
    };

    const addCustomDislike = () => {
        if (customDislike && !dislikes.includes(customDislike)) {
            setDislikes([...dislikes, customDislike]);
            setCustomDislike('');
        }
    };

    const handleNext = async () => {
        setSaving(true);
        try {
            await onboardingApi.saveStep(5, {
                dislikes,
                likedFoods,
                preferredCuisines,
            });
            router.push('/(onboarding)/step6');
        } catch (error) {
            Alert.alert('Error', 'Failed to save. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    return (
        <ScrollView style={styles.container} contentContainerStyle={styles.content}>
            <Text style={styles.title}>Preferences</Text>
            <Text style={styles.subtitle}>Tell us what you like and dislike so we can personalize your meal plan.</Text>

            {/* Dislikes */}
            <View style={styles.section}>
                <View style={styles.sectionHeader}>
                    <ThumbsDown size={18} color={Colors.textMuted} />
                    <Text style={styles.sectionTitle}>Foods You Dislike</Text>
                </View>
                <View style={styles.chipContainer}>
                    {COMMON_DISLIKES.map((item) => (
                        <TouchableOpacity
                            key={item}
                            style={[
                                styles.chip,
                                dislikes.includes(item) && styles.selectedChipDislike
                            ]}
                            onPress={() => toggleItem(dislikes, setDislikes, item)}
                        >
                            <Text style={[
                                styles.chipText,
                                dislikes.includes(item) && styles.selectedChipTextDislike
                            ]}>{item}</Text>
                        </TouchableOpacity>
                    ))}
                </View>
                <View style={styles.inputContainer}>
                    <TextInput
                        style={styles.input}
                        value={customDislike}
                        onChangeText={setCustomDislike}
                        placeholder="Add other..."
                        onSubmitEditing={addCustomDislike}
                    />
                    <TouchableOpacity
                        style={styles.addButton}
                        onPress={addCustomDislike}
                    >
                        <Plus size={20} color={Colors.surface} />
                    </TouchableOpacity>
                </View>
            </View>

            {/* Liked Foods */}
            <View style={styles.section}>
                <View style={styles.sectionHeader}>
                    <ThumbsUp size={18} color={Colors.primaryDark} />
                    <Text style={styles.sectionTitle}>Foods You Enjoy</Text>
                </View>
                <View style={styles.chipContainer}>
                    {COMMON_LIKED_FOODS.map((item) => (
                        <TouchableOpacity
                            key={item}
                            style={[
                                styles.chip,
                                likedFoods.includes(item) && styles.selectedChipLike
                            ]}
                            onPress={() => toggleItem(likedFoods, setLikedFoods, item)}
                        >
                            <Text style={[
                                styles.chipText,
                                likedFoods.includes(item) && styles.selectedChipTextLike
                            ]}>{item}</Text>
                        </TouchableOpacity>
                    ))}
                </View>
            </View>

            {/* Preferred Cuisines */}
            <View style={styles.section}>
                <Text style={styles.sectionTitle}>Preferred Cuisines</Text>
                <View style={styles.chipContainer}>
                    {CUISINES.map((item) => (
                        <TouchableOpacity
                            key={item}
                            style={[
                                styles.chip,
                                preferredCuisines.includes(item) && styles.selectedChipLike
                            ]}
                            onPress={() => toggleItem(preferredCuisines, setPreferredCuisines, item)}
                        >
                            <Text style={[
                                styles.chipText,
                                preferredCuisines.includes(item) && styles.selectedChipTextLike
                            ]}>{item}</Text>
                        </TouchableOpacity>
                    ))}
                </View>
            </View>

            <TouchableOpacity
                style={[styles.button, saving && styles.buttonDisabled]}
                onPress={handleNext}
                disabled={saving}
            >
                {saving ? (
                    <ActivityIndicator color={Colors.surface} />
                ) : (
                    <Text style={styles.buttonText}>Next Step</Text>
                )}
            </TouchableOpacity>
        </ScrollView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.surface,
    },
    content: {
        padding: Spacing.xxl,
    },
    title: {
        fontSize: 24,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    subtitle: {
        fontSize: FontSizes.lg,
        color: Colors.textMuted,
        marginBottom: Spacing.xxxl,
        lineHeight: 22,
    },
    section: {
        marginBottom: Spacing.xxl,
    },
    sectionHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        marginBottom: Spacing.md,
    },
    sectionTitle: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    chipContainer: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: Spacing.sm,
        marginBottom: Spacing.md,
    },
    chip: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: 10,
        borderRadius: BorderRadius.xl,
        backgroundColor: Colors.background,
        borderWidth: 1,
        borderColor: Colors.borderLight,
    },
    selectedChipDislike: {
        backgroundColor: '#e5e7eb',
        borderColor: '#9ca3af',
    },
    selectedChipTextDislike: {
        color: '#111',
        fontWeight: FontWeights.semibold,
    },
    selectedChipLike: {
        backgroundColor: Colors.surfaceSecondary,
        borderColor: Colors.primaryDark,
    },
    selectedChipTextLike: {
        color: Colors.primaryDark,
        fontWeight: FontWeights.semibold,
    },
    chipText: {
        color: Colors.textMuted,
        fontWeight: FontWeights.medium,
    },
    inputContainer: {
        flexDirection: 'row',
        gap: Spacing.md,
    },
    input: {
        flex: 1,
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: 14,
        fontSize: FontSizes.lg,
        backgroundColor: Colors.background,
    },
    addButton: {
        width: 50,
        height: 50,
        borderRadius: BorderRadius.md,
        backgroundColor: Colors.text,
        justifyContent: 'center',
        alignItems: 'center',
    },
    button: {
        backgroundColor: Colors.primaryDark,
        padding: Spacing.xl,
        borderRadius: BorderRadius.md,
        alignItems: 'center',
        marginTop: Spacing.xl,
    },
    buttonDisabled: {
        opacity: 0.6,
    },
    buttonText: {
        color: Colors.surface,
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
    }
});
</file>

<file path="client-app/app/(tabs)/home/index.tsx">
import { View, Text, StyleSheet, ScrollView, TouchableOpacity, RefreshControl, Image } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useRouter } from 'expo-router';
import { useTodayMeals, useClientStats } from '../../../hooks/useMeals';
import { useDailyAdherence } from '../../../hooks/useAdherence';
import { Clock, Camera, Check, AlertCircle, MessageSquare, CalendarOff } from 'lucide-react-native';
import { useState } from 'react';
import { MealLog } from '../../../types';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights, StatusColors } from '../../../constants/theme';
import { LoadingScreen } from '../../../components/LoadingScreen';
import { EmptyState } from '../../../components/EmptyState';

interface MealCardProps {
    mealLog: MealLog;
    onPress: () => void;
}

function MealCardV2({ mealLog, onPress }: MealCardProps) {
    const { meal, status, scheduledTime, dietitianFeedback } = mealLog;

    const getStatusInfo = () => {
        if (status === 'eaten') {
            if (dietitianFeedback) {
                return { color: StatusColors.reviewed.text, bgColor: StatusColors.reviewed.bg, icon: MessageSquare, label: StatusColors.reviewed.label };
            }
            return { color: StatusColors.underReview.text, bgColor: StatusColors.underReview.bg, icon: Clock, label: StatusColors.underReview.label };
        }
        if (status === 'skipped') {
            return { color: StatusColors.skipped.text, bgColor: StatusColors.skipped.bg, icon: AlertCircle, label: StatusColors.skipped.label };
        }
        return { color: StatusColors.pending.text, bgColor: StatusColors.pending.bg, icon: Clock, label: StatusColors.pending.label };
    };

    const statusInfo = getStatusInfo();

    return (
        <TouchableOpacity style={styles.mealCard} onPress={onPress} activeOpacity={0.8}>
            {/* Meal Image */}
            <View style={styles.mealImageContainer}>
                {mealLog.mealPhotoUrl ? (
                    <Image source={{ uri: mealLog.mealPhotoUrl }} style={styles.mealImage} />
                ) : (
                    <View style={styles.mealImagePlaceholder}>
                        <Camera size={32} color={Colors.textSecondary} />
                    </View>
                )}
            </View>

            {/* Meal Info */}
            <View style={styles.mealInfo}>
                <View style={styles.mealHeader}>
                    <Text style={styles.mealType}>
                        {meal?.mealType?.charAt(0).toUpperCase() + meal?.mealType?.slice(1) || 'Meal'}
                    </Text>
                    <View style={[styles.statusBadge, { backgroundColor: statusInfo.bgColor }]}>
                        <statusInfo.icon size={12} color={statusInfo.color} />
                        <Text style={[styles.statusText, { color: statusInfo.color }]}>
                            {statusInfo.label}
                        </Text>
                    </View>
                </View>

                <View style={styles.mealNameRow}>
                    <Text style={styles.mealName} numberOfLines={1}>{meal?.name || 'Meal'}</Text>
                    {meal?.hasAlternatives && (
                        <View style={styles.optionsBadge}>
                            <Text style={styles.optionsBadgeText}>
                                {(meal.options?.length || 2)} options
                            </Text>
                        </View>
                    )}
                </View>

                {scheduledTime && (
                    <View style={styles.timeRow}>
                        <Clock size={14} color={Colors.textSecondary} />
                        <Text style={styles.timeText}>{scheduledTime}</Text>
                    </View>
                )}

                {/* Macros */}
                <View style={styles.macrosRow}>
                    <Text style={styles.macroText}>{meal?.totalCalories || 0} kcal</Text>
                    <View style={styles.macroDot} />
                    <Text style={styles.macroText}>{meal?.totalProteinG || 0}g P</Text>
                    <View style={styles.macroDot} />
                    <Text style={styles.macroText}>{meal?.totalCarbsG || 0}g C</Text>
                </View>

                {/* Dietitian Feedback */}
                {dietitianFeedback && (
                    <View style={styles.feedbackRow}>
                        <MessageSquare size={14} color={Colors.primary} />
                        <Text style={styles.feedbackText} numberOfLines={1}>{dietitianFeedback}</Text>
                    </View>
                )}
            </View>

            {/* Log Button for pending meals */}
            {status === 'pending' && (
                <TouchableOpacity style={styles.logButton} onPress={onPress}>
                    <Camera size={18} color={Colors.text} />
                </TouchableOpacity>
            )}
        </TouchableOpacity>
    );
}

export default function HomeScreen() {
    const router = useRouter();
    const { data: meals, isLoading, refetch } = useTodayMeals();
    const { data: stats } = useClientStats();
    const { data: dailyAdherence } = useDailyAdherence();
    const [refreshing, setRefreshing] = useState(false);

    const onRefresh = async () => {
        setRefreshing(true);
        await refetch();
        setRefreshing(false);
    };

    const today = new Date().toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
    });

    const handleMealPress = (mealLog: MealLog) => {
        router.push({
            pathname: '/(tabs)/home/meal/[id]',
            params: {
                id: mealLog.id,
                status: mealLog.status,
                mealName: mealLog.meal?.name || '',
                mealType: mealLog.meal?.mealType || '',
                scheduledTime: mealLog.scheduledTime || '',
                feedback: mealLog.dietitianFeedback || '',
            },
        });
    };

    if (isLoading) {
        return <LoadingScreen message="Loading meals..." />;
    }

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            <ScrollView
                style={styles.scrollView}
                refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={Colors.primary} />}
                showsVerticalScrollIndicator={false}
            >
                {/* Header */}
                <View style={styles.header}>
                    <Text style={styles.dateText}>{today}</Text>
                    <View style={styles.streakBadge}>
                        <Text style={styles.streakText}>🔥 {stats?.currentStreak || 0} day streak</Text>
                    </View>
                </View>

                {/* Stats Cards */}
                <View style={styles.statsRow}>
                    <View style={styles.statCard}>
                        <Text style={styles.statValue}>{stats?.currentStreak || 0}</Text>
                        <Text style={styles.statLabel}>Day streak</Text>
                    </View>
                    <View style={styles.statCard}>
                        <Text style={[styles.statValue, dailyAdherence ? {
                            color: dailyAdherence.color === 'GREEN' ? '#17cf54' :
                                dailyAdherence.color === 'YELLOW' ? '#EAB308' : '#EF4444'
                        } : {}]}>
                            {dailyAdherence?.score ?? (stats?.weeklyAdherence || 0)}%
                        </Text>
                        <Text style={styles.statLabel}>Today&apos;s score</Text>
                    </View>
                    <View style={styles.statCard}>
                        <Text style={styles.statValue}>{stats?.weeklyAdherence || 0}%</Text>
                        <Text style={styles.statLabel}>This week</Text>
                    </View>
                </View>

                {/* Today's Meals */}
                <Text style={styles.sectionTitle}>Today's Meals</Text>

                {meals && meals.length > 0 ? (
                    <View style={styles.mealsContainer}>
                        {meals.map((mealLog) => (
                            <MealCardV2
                                key={mealLog.id}
                                mealLog={mealLog}
                                onPress={() => handleMealPress(mealLog)}
                            />
                        ))}
                    </View>
                ) : (
                    <EmptyState
                        icon={<CalendarOff size={48} color={Colors.textSecondary} />}
                        title="No meals scheduled for today"
                        subtitle="Your dietitian will add your meal plan soon"
                    />
                )}
            </ScrollView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    scrollView: {
        flex: 1,
    },
    header: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.lg,
    },
    dateText: {
        fontSize: FontSizes.xxl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    streakBadge: {
        alignSelf: 'flex-start',
    },
    streakText: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
    },
    statsRow: {
        flexDirection: 'row',
        paddingHorizontal: Spacing.lg,
        gap: Spacing.md,
        marginBottom: Spacing.xxl,
    },
    statCard: {
        flex: 1,
        backgroundColor: Colors.surface,
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        padding: Spacing.lg,
        alignItems: 'center',
    },
    statValue: {
        fontSize: 24,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    statLabel: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
        marginTop: Spacing.xs,
        textAlign: 'center',
    },
    sectionTitle: {
        fontSize: FontSizes.xxl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        paddingHorizontal: Spacing.lg,
        marginBottom: Spacing.lg,
    },
    mealsContainer: {
        paddingHorizontal: Spacing.lg,
        gap: Spacing.md,
        paddingBottom: Spacing.xxl,
    },
    mealCard: {
        backgroundColor: Colors.surface,
        borderRadius: BorderRadius.lg,
        flexDirection: 'row',
        overflow: 'hidden',
        borderWidth: 1,
        borderColor: Colors.border,
    },
    mealImageContainer: {
        width: 100,
        height: 100,
    },
    mealImage: {
        width: '100%',
        height: '100%',
    },
    mealImagePlaceholder: {
        width: '100%',
        height: '100%',
        backgroundColor: Colors.surfaceSecondary,
        justifyContent: 'center',
        alignItems: 'center',
    },
    mealInfo: {
        flex: 1,
        padding: Spacing.md,
    },
    mealHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: Spacing.xs,
    },
    mealType: {
        fontSize: FontSizes.xs,
        fontWeight: FontWeights.semibold,
        color: Colors.textSecondary,
        textTransform: 'uppercase',
    },
    statusBadge: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.xs,
        paddingHorizontal: Spacing.sm,
        paddingVertical: 2,
        borderRadius: 10,
    },
    statusText: {
        fontSize: 10,
        fontWeight: FontWeights.semibold,
    },
    mealNameRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.sm,
        marginBottom: Spacing.xs,
    },
    mealName: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        flexShrink: 1,
    },
    optionsBadge: {
        backgroundColor: '#EFF6FF',
        paddingHorizontal: 6,
        paddingVertical: 2,
        borderRadius: 6,
    },
    optionsBadgeText: {
        fontSize: 10,
        fontWeight: FontWeights.semibold,
        color: '#3B82F6',
    },
    timeRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.xs,
        marginBottom: Spacing.xs,
    },
    timeText: {
        fontSize: FontSizes.xs,
        color: Colors.textSecondary,
    },
    macrosRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 6,
    },
    macroText: {
        fontSize: 11,
        color: Colors.textSecondary,
    },
    macroDot: {
        width: 3,
        height: 3,
        borderRadius: 1.5,
        backgroundColor: Colors.border,
    },
    feedbackRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: Spacing.xs,
        marginTop: 6,
        padding: 6,
        backgroundColor: Colors.surfaceSecondary,
        borderRadius: 6,
    },
    feedbackText: {
        fontSize: 11,
        color: Colors.primary,
        flex: 1,
    },
    logButton: {
        width: 44,
        justifyContent: 'center',
        alignItems: 'center',
        backgroundColor: Colors.primary,
    },
});
</file>

<file path="client-app/app/(tabs)/profile/index.tsx">
import { View, Text, StyleSheet, ScrollView, TouchableOpacity, Alert, Image } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useRouter } from 'expo-router';
import { useAuth } from '../../../hooks/useAuth';
import { ChevronRight, Bell, Shield, HelpCircle, LogOut, Users, FileText, CreditCard, Gift, Settings, UtensilsCrossed } from 'lucide-react-native';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights } from '../../../constants/theme';
import { useToast } from '../../../components/Toast';

interface MenuItemProps {
    icon: typeof Bell;
    title: string;
    subtitle?: string;
    onPress: () => void;
    showChevron?: boolean;
    danger?: boolean;
}

function MenuItem({ icon: Icon, title, subtitle, onPress, showChevron = true, danger = false }: MenuItemProps) {
    return (
        <TouchableOpacity style={styles.menuItem} onPress={onPress} activeOpacity={0.7}>
            <View style={[styles.menuIconContainer, danger && styles.menuIconDanger]}>
                <Icon size={20} color={danger ? Colors.error : Colors.primary} />
            </View>
            <View style={styles.menuTextContainer}>
                <Text style={[styles.menuTitle, danger && styles.menuTitleDanger]}>{title}</Text>
                {subtitle && <Text style={styles.menuSubtitle}>{subtitle}</Text>}
            </View>
            {showChevron && <ChevronRight size={20} color={Colors.textSecondary} />}
        </TouchableOpacity>
    );
}

export default function ProfileScreen() {
    const router = useRouter();
    const { logout, client } = useAuth();
    const toast = useToast();

    const handleLogout = () => {
        Alert.alert(
            'Logout',
            'Are you sure you want to logout?',
            [
                { text: 'Cancel', style: 'cancel' },
                {
                    text: 'Logout',
                    style: 'destructive',
                    onPress: async () => {
                        await logout();
                        router.replace('/(auth)/login');
                    }
                },
            ]
        );
    };

    const getInitials = (name: string) => {
        return name
            .split(' ')
            .map(n => n[0])
            .join('')
            .toUpperCase()
            .slice(0, 2);
    };

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
                {/* Header */}
                <Text style={styles.headerTitle}>Profile</Text>

                {/* Profile Card */}
                <View style={styles.profileCard}>
                    <View style={styles.avatarContainer}>
                        {client?.profilePhotoUrl ? (
                            <Image source={{ uri: client.profilePhotoUrl }} style={styles.avatar} />
                        ) : (
                            <View style={styles.avatarPlaceholder}>
                                <Text style={styles.avatarText}>
                                    {client?.fullName ? getInitials(client.fullName) : 'U'}
                                </Text>
                            </View>
                        )}
                    </View>
                    <View style={styles.profileInfo}>
                        <Text style={styles.profileName}>{client?.fullName || 'User'}</Text>
                        <Text style={styles.profilePhone}>{client?.phone || '+91 XXXXXXXXXX'}</Text>
                        {client?.email && (
                            <Text style={styles.profileEmail}>{client.email}</Text>
                        )}
                    </View>
                </View>

                {/* Subscription Card */}
                <View style={styles.subscriptionCard}>
                    <View style={styles.subscriptionHeader}>
                        <CreditCard size={20} color={Colors.primary} />
                        <Text style={styles.subscriptionTitle}>Subscription</Text>
                    </View>
                    <View style={styles.subscriptionDetails}>
                        <View style={styles.subscriptionRow}>
                            <Text style={styles.subscriptionLabel}>Status</Text>
                            <View style={styles.activeBadge}>
                                <Text style={styles.activeBadgeText}>Active</Text>
                            </View>
                        </View>
                        <View style={styles.subscriptionRow}>
                            <Text style={styles.subscriptionLabel}>Plan</Text>
                            <Text style={styles.subscriptionValue}>Monthly</Text>
                        </View>
                        <View style={styles.subscriptionRow}>
                            <Text style={styles.subscriptionLabel}>Renews</Text>
                            <Text style={styles.subscriptionValue}>-- / -- / ----</Text>
                        </View>
                    </View>
                </View>

                {/* Referral Card */}
                <TouchableOpacity
                    style={styles.referralCard}
                    onPress={() => router.push('/(tabs)/profile/referral')}
                    activeOpacity={0.8}
                >
                    <View style={styles.referralIconContainer}>
                        <Gift size={24} color="#fff" />
                    </View>
                    <View style={styles.referralContent}>
                        <Text style={styles.referralTitle}>Refer & Earn</Text>
                        <Text style={styles.referralSubtitle}>Get 1 month free for every 3 referrals!</Text>
                    </View>
                    <ChevronRight size={24} color={Colors.primary} />
                </TouchableOpacity>

                {/* Menu Items */}
                <View style={styles.menuSection}>
                    <MenuItem
                        icon={Bell}
                        title="Notifications"
                        onPress={() => router.push('/(tabs)/notifications')}
                    />
                    <MenuItem
                        icon={FileText}
                        title="My Reports"
                        subtitle="Upload & view medical reports"
                        onPress={() => router.push('/(tabs)/profile/reports')}
                    />
                    <MenuItem
                        icon={UtensilsCrossed}
                        title="Dietary Info"
                        subtitle="Diet pattern, allergies & food preferences"
                        onPress={() => router.push('/(tabs)/profile/dietary-info')}
                    />
                    <MenuItem
                        icon={Settings}
                        title="My Preferences"
                        subtitle="Meal timings, cooking & lifestyle"
                        onPress={() => router.push('/(tabs)/profile/preferences')}
                    />
                    <MenuItem
                        icon={Shield}
                        title="Privacy & Security"
                        onPress={() => toast.showToast({ title: 'Coming Soon', message: 'This feature will be available soon.', variant: 'info' })}
                    />
                    <MenuItem
                        icon={HelpCircle}
                        title="Help & Support"
                        onPress={() => toast.showToast({ title: 'Help', message: 'Contact us at support@dietconnect.com', variant: 'info' })}
                    />
                </View>

                {/* Logout */}
                <View style={styles.logoutSection}>
                    <MenuItem
                        icon={LogOut}
                        title="Logout"
                        onPress={handleLogout}
                        showChevron={false}
                        danger
                    />
                </View>

                {/* Version */}
                <Text style={styles.versionText}>Version 1.0.0</Text>
            </ScrollView>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    scrollView: {
        flex: 1,
        padding: 16,
    },
    headerTitle: {
        fontSize: 22,
        fontWeight: '700',
        color: Colors.text,
        marginBottom: 24,
    },
    profileCard: {
        flexDirection: 'row',
        alignItems: 'center',
        backgroundColor: Colors.surface,
        borderRadius: 16,
        padding: 16,
        marginBottom: 16,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    avatarContainer: {
        marginRight: 16,
    },
    avatar: {
        width: 64,
        height: 64,
        borderRadius: 32,
    },
    avatarPlaceholder: {
        width: 64,
        height: 64,
        borderRadius: 32,
        backgroundColor: Colors.primary,
        justifyContent: 'center',
        alignItems: 'center',
    },
    avatarText: {
        fontSize: 24,
        fontWeight: '700',
        color: Colors.text,
    },
    profileInfo: {
        flex: 1,
    },
    profileName: {
        fontSize: 20,
        fontWeight: '700',
        color: Colors.text,
        marginBottom: 4,
    },
    profilePhone: {
        fontSize: 14,
        color: Colors.textSecondary,
    },
    profileEmail: {
        fontSize: 14,
        color: Colors.textSecondary,
        marginTop: 2,
    },
    // Subscription Card
    subscriptionCard: {
        backgroundColor: Colors.surface,
        borderRadius: 16,
        padding: 16,
        marginBottom: 16,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    subscriptionHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 8,
        marginBottom: 12,
    },
    subscriptionTitle: {
        fontSize: 16,
        fontWeight: '600',
        color: Colors.text,
    },
    subscriptionDetails: {
        gap: 8,
    },
    subscriptionRow: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
    },
    subscriptionLabel: {
        fontSize: 14,
        color: Colors.textSecondary,
    },
    subscriptionValue: {
        fontSize: 14,
        fontWeight: '500',
        color: Colors.text,
    },
    activeBadge: {
        backgroundColor: '#d1fae5',
        paddingHorizontal: 10,
        paddingVertical: 4,
        borderRadius: 8,
    },
    activeBadgeText: {
        fontSize: 12,
        fontWeight: '600',
        color: '#065f46',
    },
    // Referral Card
    referralCard: {
        flexDirection: 'row',
        alignItems: 'center',
        backgroundColor: Colors.surfaceSecondary,
        borderRadius: 16,
        padding: 16,
        marginBottom: 16,
        borderWidth: 1,
        borderColor: Colors.primary,
    },
    referralIconContainer: {
        width: 48,
        height: 48,
        borderRadius: 24,
        backgroundColor: Colors.primary,
        justifyContent: 'center',
        alignItems: 'center',
        marginRight: 12,
    },
    referralContent: {
        flex: 1,
    },
    referralTitle: {
        fontSize: 16,
        fontWeight: '700',
        color: Colors.text,
    },
    referralSubtitle: {
        fontSize: 13,
        color: Colors.textSecondary,
        marginTop: 2,
    },
    menuSection: {
        backgroundColor: Colors.surface,
        borderRadius: 16,
        borderWidth: 1,
        borderColor: Colors.border,
        overflow: 'hidden',
        marginBottom: 16,
    },
    menuItem: {
        flexDirection: 'row',
        alignItems: 'center',
        padding: 16,
        borderBottomWidth: 1,
        borderBottomColor: Colors.border,
    },
    menuIconContainer: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: Colors.surfaceSecondary,
        justifyContent: 'center',
        alignItems: 'center',
        marginRight: 12,
    },
    menuIconDanger: {
        backgroundColor: '#fee2e2',
    },
    menuTextContainer: {
        flex: 1,
    },
    menuTitle: {
        fontSize: 16,
        fontWeight: '500',
        color: Colors.text,
    },
    menuSubtitle: {
        fontSize: 12,
        color: Colors.textSecondary,
        marginTop: 2,
    },
    menuTitleDanger: {
        color: Colors.error,
    },
    logoutSection: {
        backgroundColor: Colors.surface,
        borderRadius: 16,
        borderWidth: 1,
        borderColor: Colors.border,
        overflow: 'hidden',
        marginBottom: 24,
    },
    versionText: {
        textAlign: 'center',
        fontSize: 12,
        color: Colors.textSecondary,
        marginBottom: 24,
    },
});
</file>

<file path="client-app/app/(tabs)/progress/index.tsx">
import { useState } from 'react';
import {
    View,
    Text,
    StyleSheet,
    ScrollView,
    TouchableOpacity,
    TextInput,
    Modal,
    ActivityIndicator,
    Dimensions,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useRouter } from 'expo-router';
import { useProgressSummary, useCreateWeightLog } from '../../../hooks/useWeight';
import { useWeeklyAdherence } from '../../../hooks/useAdherence';
import { useToast } from '../../../components/Toast';
import { ArrowLeft, PencilLine, TrendingUp, TrendingDown, Minus, Ruler, ChevronRight } from 'lucide-react-native';
import { LineChart } from 'react-native-chart-kit';
import { Colors, Spacing, BorderRadius, FontSizes, FontWeights, Shadows } from '../../../constants/theme';

const screenWidth = Dimensions.get('window').width;

export default function ProgressScreen() {
    const router = useRouter();
    const { data: progress } = useProgressSummary();
    const { data: weeklyAdherence } = useWeeklyAdherence();
    const createWeightMutation = useCreateWeightLog();
    const { showToast } = useToast();

    const [showWeightModal, setShowWeightModal] = useState(false);
    const [weightInput, setWeightInput] = useState('');

    // All data computed server-side
    const currentWeight = progress?.currentWeight;
    const targetWeight = progress?.targetWeight ?? 65;
    const progressPercent = progress?.progressPercent ?? 0;
    const chartEntries = progress?.chartEntries ?? [];
    const hasChartData = chartEntries.length >= 2;
    const history = progress?.history ?? [];

    const handleLogWeight = async () => {
        const weight = parseFloat(weightInput);
        if (isNaN(weight) || weight < 20 || weight > 300) {
            showToast({ title: 'Invalid Weight', message: 'Please enter a valid weight between 20-300 kg', variant: 'warning' });
            return;
        }

        try {
            await createWeightMutation.mutateAsync({
                weightKg: weight,
                logDate: new Date().toISOString().split('T')[0],
            });
            setWeightInput('');
            setShowWeightModal(false);
            showToast({ title: 'Success', message: 'Weight logged successfully!', variant: 'success' });
        } catch (error) {
            showToast({ title: 'Error', message: 'Failed to log weight. Please try again.', variant: 'error' });
        }
    };

    return (
        <SafeAreaView style={styles.container} edges={['top']}>
            {/* Header */}
            <View style={styles.header}>
                <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
                    <ArrowLeft size={24} color={Colors.text} />
                </TouchableOpacity>
                <Text style={styles.headerTitle}>Weight Tracking</Text>
                <View style={styles.headerSpacer} />
            </View>

            <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
                {/* Current Weight Input */}
                <View style={styles.inputContainer}>
                    <Text style={styles.inputLabel}>Current Weight</Text>
                    <TouchableOpacity
                        style={styles.weightInputBox}
                        onPress={() => setShowWeightModal(true)}
                    >
                        <Text style={styles.weightInputText}>
                            {currentWeight ? `${currentWeight} kg` : 'Tap to enter'}
                        </Text>
                    </TouchableOpacity>
                </View>

                {/* Weight Progress Chart */}
                <View style={styles.chartSection}>
                    <Text style={styles.sectionLabel}>Weight Progress</Text>
                    <Text style={styles.currentWeightLarge}>{currentWeight || '--'} kg</Text>
                    <Text style={styles.chartPeriod}>
                        {hasChartData ? `Last ${chartEntries.length} entries` : 'No data yet'}
                    </Text>

                    {hasChartData ? (
                        <View style={styles.chartContainer}>
                            <LineChart
                                data={{
                                    labels: chartEntries.map(d => {
                                        const date = new Date(d.date);
                                        return `${date.getDate()}/${date.getMonth() + 1}`;
                                    }),
                                    datasets: [
                                        {
                                            data: chartEntries.map(d => d.weight),
                                            color: (opacity = 1) => `rgba(23, 207, 84, ${opacity})`,
                                            strokeWidth: 2,
                                        },
                                        ...(targetWeight ? [{
                                            data: chartEntries.map(() => targetWeight),
                                            color: (opacity = 1) => `rgba(239, 68, 68, ${opacity * 0.4})`,
                                            strokeWidth: 1,
                                            withDots: false,
                                        }] : []),
                                    ],
                                }}
                                width={screenWidth - Spacing.lg * 4}
                                height={180}
                                chartConfig={{
                                    backgroundColor: Colors.surfaceSecondary,
                                    backgroundGradientFrom: Colors.surfaceSecondary,
                                    backgroundGradientTo: Colors.surfaceSecondary,
                                    decimalPlaces: 1,
                                    color: (opacity = 1) => `rgba(17, 24, 39, ${opacity})`,
                                    labelColor: (opacity = 1) => `rgba(107, 114, 128, ${opacity})`,
                                    style: { borderRadius: 12 },
                                    propsForDots: {
                                        r: '5',
                                        strokeWidth: '2',
                                        stroke: '#17cf54',
                                    },
                                    propsForBackgroundLines: {
                                        strokeDasharray: '',
                                        stroke: '#e5e7eb',
                                    },
                                }}
                                bezier
                                style={{ borderRadius: 12 }}
                            />
                            {targetWeight && (
                                <View style={styles.chartLegend}>
                                    <View style={styles.legendItem}>
                                        <View style={[styles.legendDot, { backgroundColor: '#17cf54' }]} />
                                        <Text style={styles.legendText}>Weight</Text>
                                    </View>
                                    <View style={styles.legendItem}>
                                        <View style={[styles.legendDot, { backgroundColor: '#EF4444' }]} />
                                        <Text style={styles.legendText}>Target</Text>
                                    </View>
                                </View>
                            )}
                        </View>
                    ) : (
                        <View style={styles.chartPlaceholder}>
                            <Text style={styles.chartEmptyText}>
                                Log at least 2 weights to see your trend
                            </Text>
                        </View>
                    )}
                </View>

                {/* Goal Progress */}
                <View style={styles.goalSection}>
                    <Text style={styles.goalLabel}>Goal: {targetWeight} kg</Text>
                    <View style={styles.progressBarContainer}>
                        <View style={[styles.progressBar, { width: `${progressPercent}%` }]} />
                    </View>
                    <Text style={styles.toGoText}>
                        {progress?.remaining !== null && progress?.remaining !== undefined
                            ? `${progress.remaining} kg to go`
                            : 'Set your goal weight'}
                    </Text>
                </View>

                {/* Weight History */}
                {history.length > 0 && (
                    <View style={styles.historySection}>
                        <Text style={styles.sectionLabel}>Recent Entries</Text>
                        <View style={styles.historyList}>
                            {history.map((entry) => (
                                <View key={entry.id} style={styles.historyItem}>
                                    <Text style={styles.historyDate}>
                                        {new Date(entry.logDate).toLocaleDateString('en-US', {
                                            weekday: 'short', month: 'short', day: 'numeric',
                                        })}
                                    </Text>
                                    <View style={styles.historyRight}>
                                        <Text style={styles.historyWeight}>{entry.weightKg} kg</Text>
                                        {entry.delta !== null && (
                                            <Text style={[
                                                styles.historyDelta,
                                                entry.delta < 0 ? styles.deltaDown : entry.delta > 0 ? styles.deltaUp : styles.deltaNeutral,
                                            ]}>
                                                {entry.delta > 0 ? '+' : ''}{entry.delta.toFixed(1)} kg
                                            </Text>
                                        )}
                                    </View>
                                </View>
                            ))}
                        </View>
                    </View>
                )}

                {/* Body Profile Card */}
                <TouchableOpacity
                    style={styles.bodyProfileCard}
                    onPress={() => router.push('/(tabs)/profile/body-profile')}
                    activeOpacity={0.7}
                >
                    <View style={styles.bodyProfileIcon}>
                        <Ruler size={20} color={Colors.primaryDark} />
                    </View>
                    <View style={styles.bodyProfileText}>
                        <Text style={styles.bodyProfileTitle}>Body Profile</Text>
                        <Text style={styles.bodyProfileSubtitle}>Height, measurements & activity level</Text>
                    </View>
                    <ChevronRight size={20} color={Colors.textSecondary} />
                </TouchableOpacity>

                {/* Adherence Section */}
                {weeklyAdherence && (
                    <View style={styles.adherenceSection}>
                        <Text style={styles.sectionLabel}>Weekly Adherence</Text>
                        <View style={styles.adherenceHeader}>
                            <Text style={[
                                styles.adherenceScore,
                                { color: weeklyAdherence.color === 'GREEN' ? '#17cf54' :
                                    weeklyAdherence.color === 'YELLOW' ? '#EAB308' : '#EF4444' }
                            ]}>
                                {weeklyAdherence.averageScore}%
                            </Text>
                            <View style={styles.trendBadge}>
                                {weeklyAdherence.trend === 'improving' && <TrendingUp size={16} color="#17cf54" />}
                                {weeklyAdherence.trend === 'declining' && <TrendingDown size={16} color="#EF4444" />}
                                {weeklyAdherence.trend === 'stable' && <Minus size={16} color={Colors.textSecondary} />}
                                <Text style={[styles.trendText, {
                                    color: weeklyAdherence.trend === 'improving' ? '#17cf54' :
                                        weeklyAdherence.trend === 'declining' ? '#EF4444' : Colors.textSecondary
                                }]}>
                                    {weeklyAdherence.trend.charAt(0).toUpperCase() + weeklyAdherence.trend.slice(1)}
                                </Text>
                            </View>
                        </View>

                        {/* 7-day bar chart */}
                        <View style={styles.adherenceChart}>
                            {weeklyAdherence.dailyBreakdown.map((day, i) => {
                                const barColor = day.mealsLogged === 0 ? Colors.border :
                                    day.color === 'GREEN' ? '#17cf54' :
                                    day.color === 'YELLOW' ? '#EAB308' : '#EF4444';
                                const dayLabel = new Date(day.date).toLocaleDateString('en-US', { weekday: 'short' });
                                return (
                                    <View key={i} style={styles.adherenceBarContainer}>
                                        <View style={styles.adherenceBarTrack}>
                                            <View style={[
                                                styles.adherenceBar,
                                                { height: `${Math.max(day.score, 4)}%`, backgroundColor: barColor }
                                            ]} />
                                        </View>
                                        <Text style={styles.adherenceDayLabel}>{dayLabel}</Text>
                                    </View>
                                );
                            })}
                        </View>
                    </View>
                )}
            </ScrollView>

            {/* Update Weight Button */}
            <View style={styles.buttonContainer}>
                <TouchableOpacity
                    style={styles.updateButton}
                    onPress={() => setShowWeightModal(true)}
                >
                    <PencilLine size={24} color={Colors.text} />
                    <Text style={styles.updateButtonText}>Update Weight</Text>
                </TouchableOpacity>
            </View>

            {/* Weight Input Modal */}
            <Modal
                visible={showWeightModal}
                transparent
                animationType="slide"
                onRequestClose={() => setShowWeightModal(false)}
            >
                <View style={styles.modalOverlay}>
                    <View style={styles.modalContent}>
                        <Text style={styles.modalTitle}>Log Your Weight</Text>
                        <View style={styles.modalInputRow}>
                            <TextInput
                                style={styles.modalInput}
                                value={weightInput}
                                onChangeText={setWeightInput}
                                placeholder="0.0"
                                placeholderTextColor={Colors.textSecondary}
                                keyboardType="decimal-pad"
                                autoFocus
                            />
                            <Text style={styles.modalUnit}>kg</Text>
                        </View>
                        <View style={styles.modalButtons}>
                            <TouchableOpacity
                                style={styles.modalCancelButton}
                                onPress={() => setShowWeightModal(false)}
                            >
                                <Text style={styles.modalCancelText}>Cancel</Text>
                            </TouchableOpacity>
                            <TouchableOpacity
                                style={styles.modalSubmitButton}
                                onPress={handleLogWeight}
                                disabled={createWeightMutation.isPending}
                            >
                                {createWeightMutation.isPending ? (
                                    <ActivityIndicator color={Colors.text} />
                                ) : (
                                    <Text style={styles.modalSubmitText}>Save</Text>
                                )}
                            </TouchableOpacity>
                        </View>
                    </View>
                </View>
            </Modal>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: Colors.background,
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.sm,
    },
    backButton: {
        width: 48,
        height: 48,
        justifyContent: 'center',
    },
    headerTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        letterSpacing: -0.015 * 18,
    },
    headerSpacer: {
        width: 48,
    },
    scrollView: {
        flex: 1,
    },
    inputContainer: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
    },
    inputLabel: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.medium,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    weightInputBox: {
        backgroundColor: Colors.surfaceSecondary,
        borderRadius: BorderRadius.md,
        height: 56,
        justifyContent: 'center',
        paddingHorizontal: Spacing.lg,
    },
    weightInputText: {
        fontSize: FontSizes.lg,
        color: Colors.textSecondary,
    },
    chartSection: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.xxl,
    },
    sectionLabel: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.medium,
        color: Colors.text,
    },
    currentWeightLarge: {
        fontSize: FontSizes.display,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginTop: Spacing.sm,
    },
    chartPeriod: {
        fontSize: FontSizes.lg,
        color: Colors.textSecondary,
        marginBottom: Spacing.lg,
    },
    chartContainer: {
        marginBottom: Spacing.sm,
    },
    chartPlaceholder: {
        height: 180,
        backgroundColor: Colors.surfaceSecondary,
        borderRadius: BorderRadius.sm,
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: Spacing.sm,
    },
    chartEmptyText: {
        fontSize: FontSizes.sm,
        color: Colors.textSecondary,
    },
    chartLegend: {
        flexDirection: 'row',
        justifyContent: 'center',
        gap: Spacing.xxl,
        marginTop: Spacing.sm,
    },
    legendItem: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 6,
    },
    legendDot: {
        width: 10,
        height: 10,
        borderRadius: 5,
    },
    legendText: {
        fontSize: FontSizes.xs,
        color: Colors.textSecondary,
    },
    goalSection: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
    },
    goalLabel: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.medium,
        color: Colors.text,
        marginBottom: Spacing.sm,
    },
    progressBarContainer: {
        height: 8,
        backgroundColor: Colors.border,
        borderRadius: 4,
        overflow: 'hidden',
    },
    progressBar: {
        height: '100%',
        backgroundColor: Colors.primary,
        borderRadius: 4,
    },
    toGoText: {
        fontSize: FontSizes.md,
        color: Colors.textSecondary,
        marginTop: Spacing.sm,
    },
    buttonContainer: {
        padding: Spacing.xl,
        paddingBottom: 40,
    },
    updateButton: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: Spacing.lg,
        backgroundColor: Colors.primary,
        height: 56,
        borderRadius: BorderRadius.md,
    },
    updateButtonText: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    modalOverlay: {
        flex: 1,
        backgroundColor: 'rgba(0,0,0,0.5)',
        justifyContent: 'flex-end',
    },
    modalContent: {
        backgroundColor: Colors.surface,
        borderTopLeftRadius: Spacing.xxl,
        borderTopRightRadius: Spacing.xxl,
        padding: Spacing.xxl,
        paddingBottom: 40,
    },
    modalTitle: {
        fontSize: FontSizes.xl,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        marginBottom: Spacing.xl,
        textAlign: 'center',
    },
    modalInputRow: {
        flexDirection: 'row',
        alignItems: 'center',
        borderWidth: 1,
        borderColor: Colors.border,
        borderRadius: BorderRadius.md,
        paddingHorizontal: Spacing.lg,
        marginBottom: Spacing.xxl,
    },
    modalInput: {
        flex: 1,
        fontSize: FontSizes.display,
        fontWeight: FontWeights.bold,
        color: Colors.text,
        paddingVertical: Spacing.lg,
    },
    modalUnit: {
        fontSize: FontSizes.xl,
        color: Colors.textSecondary,
    },
    modalButtons: {
        flexDirection: 'row',
        gap: Spacing.md,
    },
    modalCancelButton: {
        flex: 1,
        height: 48,
        justifyContent: 'center',
        alignItems: 'center',
        borderRadius: BorderRadius.md,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    modalCancelText: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    modalSubmitButton: {
        flex: 1,
        height: 48,
        justifyContent: 'center',
        alignItems: 'center',
        borderRadius: BorderRadius.md,
        backgroundColor: Colors.primary,
    },
    modalSubmitText: {
        fontSize: FontSizes.lg,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    historySection: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.md,
    },
    historyList: {
        marginTop: Spacing.sm,
        gap: Spacing.sm,
    },
    historyItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        backgroundColor: Colors.surface,
        padding: Spacing.md,
        borderRadius: BorderRadius.md,
    },
    historyDate: {
        fontSize: FontSizes.sm,
        fontWeight: FontWeights.medium,
        color: Colors.text,
    },
    historyRight: {
        alignItems: 'flex-end',
    },
    historyWeight: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.bold,
        color: Colors.text,
    },
    historyDelta: {
        fontSize: FontSizes.xs,
        fontWeight: FontWeights.semibold,
        marginTop: 2,
    },
    deltaDown: { color: '#17cf54' },
    deltaUp: { color: '#EF4444' },
    deltaNeutral: { color: Colors.textSecondary },
    bodyProfileCard: {
        flexDirection: 'row',
        alignItems: 'center',
        backgroundColor: Colors.surface,
        marginHorizontal: Spacing.lg,
        marginVertical: Spacing.md,
        padding: Spacing.lg,
        borderRadius: BorderRadius.lg,
        borderWidth: 1,
        borderColor: Colors.border,
    },
    bodyProfileIcon: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: Colors.surfaceSecondary,
        justifyContent: 'center',
        alignItems: 'center',
        marginRight: Spacing.md,
    },
    bodyProfileText: {
        flex: 1,
    },
    bodyProfileTitle: {
        fontSize: FontSizes.md,
        fontWeight: FontWeights.semibold,
        color: Colors.text,
    },
    bodyProfileSubtitle: {
        fontSize: FontSizes.sm,
        color: Colors.textSecondary,
        marginTop: 2,
    },
    adherenceSection: {
        paddingHorizontal: Spacing.lg,
        paddingVertical: Spacing.xxl,
    },
    adherenceHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        marginTop: Spacing.sm,
        marginBottom: Spacing.lg,
    },
    adherenceScore: {
        fontSize: FontSizes.display,
        fontWeight: FontWeights.bold,
    },
    trendBadge: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 4,
        backgroundColor: Colors.surfaceSecondary,
        paddingHorizontal: Spacing.md,
        paddingVertical: Spacing.xs,
        borderRadius: BorderRadius.sm,
    },
    trendText: {
        fontSize: FontSizes.sm,
        fontWeight: FontWeights.semibold,
    },
    adherenceChart: {
        flexDirection: 'row',
        alignItems: 'flex-end',
        height: 120,
        gap: 6,
    },
    adherenceBarContainer: {
        flex: 1,
        alignItems: 'center',
    },
    adherenceBarTrack: {
        width: '100%',
        height: 100,
        backgroundColor: Colors.surfaceSecondary,
        borderRadius: 4,
        justifyContent: 'flex-end',
        overflow: 'hidden',
    },
    adherenceBar: {
        width: '100%',
        borderRadius: 4,
    },
    adherenceDayLabel: {
        fontSize: FontSizes.xs,
        color: Colors.textSecondary,
        marginTop: 4,
        fontWeight: FontWeights.bold,
    },
});
</file>

<file path="client-app/app/index.tsx">
import { Redirect } from 'expo-router';
import { useAuth } from '../hooks/useAuth';
import { LoadingScreen } from '../components/LoadingScreen';

export default function Index() {
    const { isAuthenticated, isLoading, client } = useAuth();

    if (isLoading) {
        return <LoadingScreen />;
    }

    if (isAuthenticated) {
        if (!client?.onboardingCompleted) {
            return <Redirect href="/(onboarding)/step1" />;
        }
        return <Redirect href="/(tabs)/home" />;
    }

    return <Redirect href="/(auth)/login" />;
}
</file>

<file path="client-app/hooks/useMealLog.ts">
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { mealLogsApi } from '../services/api';

export function useMealLog(mealLogId: string) {
    const isPending = mealLogId?.startsWith('pending-');

    return useQuery({
        queryKey: ['meal-log', mealLogId],
        queryFn: async () => {
            const { data } = await mealLogsApi.getMealLog(mealLogId);
            return data.data;
        },
        enabled: !!mealLogId && !isPending,
        staleTime: 30 * 1000,
    });
}

interface LogMealInput {
    mealLogId: string;
    status: 'eaten' | 'skipped' | 'substituted';
    notes?: string;
    photoUri?: string;
    chosenOptionGroup?: number;
}

export function useLogMeal() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async ({ mealLogId, status, notes, photoUri, chosenOptionGroup }: LogMealInput) => {
            const { data } = await mealLogsApi.logMeal(mealLogId, {
                status,
                notes,
                chosenOptionGroup,
            });
            const result = data.data;

            // Upload photo if provided (fire-and-forget — meal log succeeds even if photo fails)
            if (photoUri) {
                try {
                    const actualId = result.id || mealLogId;
                    const formData = new FormData();
                    formData.append('photo', {
                        uri: photoUri,
                        name: 'meal-photo.jpg',
                        type: 'image/jpeg',
                    } as any);
                    await mealLogsApi.uploadPhoto(actualId, formData);
                } catch (err) {
                    console.warn('Photo upload failed, meal log was saved:', err);
                }
            }

            return result;
        },
        onSuccess: async (_, { mealLogId }) => {
            await queryClient.invalidateQueries({ queryKey: ['meals', 'today'] });
            await queryClient.refetchQueries({ queryKey: ['meals', 'today'] });
            queryClient.invalidateQueries({ queryKey: ['meal-log', mealLogId] });
            queryClient.invalidateQueries({ queryKey: ['client', 'stats'] });
        },
    });
}
</file>

<file path="client-app/hooks/useWeight.ts">
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { weightLogsApi, clientStatsApi } from '../services/api';
import { WeightLog } from '../types';

export function useWeightLogs(limit?: number) {
    return useQuery({
        queryKey: ['weight-logs', limit],
        queryFn: async () => {
            const { data } = await weightLogsApi.getWeightLogs({ limit });
            return data.data;
        },
        staleTime: 0,
        gcTime: 30 * 1000,
    });
}

export function useProgressSummary() {
    return useQuery({
        queryKey: ['progress-summary'],
        queryFn: async () => {
            const { data } = await clientStatsApi.getProgressSummary();
            return data.data;
        },
        staleTime: 0,
        gcTime: 30 * 1000,
    });
}

export function useCreateWeightLog() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (input: { weightKg: number; logDate: string; notes?: string }) => {
            const { data } = await weightLogsApi.createWeightLog(input);
            return data.data;
        },
        onSuccess: async (newWeightLog) => {
            queryClient.setQueryData(['weight-logs', 10], (oldData: WeightLog[] | undefined) => {
                if (!oldData) return [newWeightLog];
                const existingIndex = oldData.findIndex(
                    log => log.logDate === newWeightLog.logDate
                );
                if (existingIndex >= 0) {
                    const newData = [...oldData];
                    newData[existingIndex] = newWeightLog;
                    return newData;
                }
                return [newWeightLog, ...oldData].slice(0, 10);
            });

            await queryClient.invalidateQueries({ queryKey: ['client', 'stats'] });
            await queryClient.invalidateQueries({ queryKey: ['progress-summary'] });
        },
    });
}
</file>

<file path="client-app/services/api.ts">
import axios, { AxiosInstance, InternalAxiosRequestConfig } from 'axios';
import { authStore } from '../store/authStore';
import Constants from 'expo-constants';
import {
    ApiResponse,
    Client,
    ClientPreferences,
    MealLog,
    WeightLog,
    ClientStats,
    Report,
    UploadUrlResponse,
    ReferralData,
    ReferralStats,
    DailyAdherence,
    WeeklyAdherence,
    ComplianceHistory,
    OnboardingStatus,
    ProgressSummary,
} from '../types';

// Use the local IP for development - change this for production
const API_BASE_URL = Constants.expoConfig?.extra?.apiUrl || 'http://localhost:3000/api/v1';

const api: AxiosInstance = axios.create({
    baseURL: API_BASE_URL,
    timeout: 15000,
    headers: {
        'Content-Type': 'application/json',
    },
});

// Request interceptor to add auth token
api.interceptors.request.use(
    async (config: InternalAxiosRequestConfig) => {
        const token = await authStore.getToken();
        if (token && config.headers) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    },
    (error) => Promise.reject(error)
);

// Response interceptor for error handling
api.interceptors.response.use(
    (response) => response,
    async (error) => {
        if (error.response?.status === 401) {
            await authStore.removeToken();
            // Navigation to login will be handled by useAuth hook
        }
        return Promise.reject(error);
    }
);

// Client Auth API - uses /client-auth endpoints
export const clientAuthApi = {
    requestOTP: (phone: string) =>
        api.post<ApiResponse<{ message: string }>>('/client-auth/request-otp', { phone }),

    verifyOTP: (phone: string, otp: string) =>
        api.post<ApiResponse<{ token: string; client: Client }>>('/client-auth/verify-otp', { phone, otp }),

    getProfile: () =>
        api.get<ApiResponse<Client>>('/client-auth/me'),

    updateProfile: (data: { fullName?: string; email?: string }) =>
        api.patch<ApiResponse<Client>>('/client-auth/me', data),
};

// Meal Logs API - client's own meals
export const mealLogsApi = {
    getTodayMeals: () =>
        api.get<ApiResponse<MealLog[]>>('/client/meals/today'),

    getMealLog: (mealLogId: string) =>
        api.get<ApiResponse<MealLog>>(`/client/meals/${mealLogId}`),

    logMeal: (mealId: string, data: { status: string; photoUrl?: string; notes?: string; chosenOptionGroup?: number }) =>
        api.patch<ApiResponse<MealLog>>(`/client/meals/${mealId}/log`, data),

    uploadPhoto: (mealId: string, formData: FormData) =>
        api.post<ApiResponse<{ url: string }>>(`/client/meals/${mealId}/photo`, formData, {
            headers: { 'Content-Type': 'multipart/form-data' },
            timeout: 60000,
        }),
};

// Weight Logs API - uses the client endpoint with clientId from token
export const weightLogsApi = {
    getWeightLogs: (params?: { limit?: number }) =>
        api.get<ApiResponse<WeightLog[]>>('/client/weight-logs', { params }),

    createWeightLog: (data: { weightKg: number; logDate: string; notes?: string }) =>
        api.post<ApiResponse<WeightLog>>('/client/weight-logs', data),
};

// Client Stats API
export const clientStatsApi = {
    getStats: () =>
        api.get<ApiResponse<ClientStats>>('/client/stats'),
    getProgressSummary: () =>
        api.get<ApiResponse<ProgressSummary>>('/client/progress-summary'),
};

// Reports API
export const reportsApi = {
    getReports: () =>
        api.get<ApiResponse<Report[]>>('/client/reports'),

    getUploadUrl: (data: { fileName: string; fileType: string; reportType: string }) =>
        api.post<ApiResponse<UploadUrlResponse>>('/client/reports/upload-url', data),

    createReport: (data: { key: string; fileName: string; fileType: string; reportType: string }) =>
        api.post<ApiResponse<Report>>('/client/reports', data),

    deleteReport: (id: string) =>
        api.delete<ApiResponse<void>>(`/client/reports/${id}`),
};

// Referral API
export const referralApi = {
    getCode: () =>
        api.get<ApiResponse<ReferralData>>('/client/referral/code'),

    getStats: () =>
        api.get<ApiResponse<ReferralStats>>('/client/referral/stats'),
};

// Onboarding API
export const onboardingApi = {
    getStatus: () =>
        api.get<ApiResponse<OnboardingStatus>>('/client/onboarding/status'),

    saveStep: (step: number, data: any) =>
        api.post<ApiResponse<{ message: string }>>(`/client/onboarding/step/${step}`, data),

    complete: () =>
        api.post<ApiResponse<{ message: string }>>('/client/onboarding/complete'),

    getPresets: () =>
        api.get<ApiResponse<any[]>>('/client/onboarding/presets'),
};

// Preferences API
export const preferencesApi = {
    get: () =>
        api.get<ApiResponse<ClientPreferences | null>>('/client/preferences'),

    update: (data: Partial<Omit<ClientPreferences, 'id'>>) =>
        api.put<ApiResponse<ClientPreferences>>('/client/preferences', data),
};

// Adherence / Compliance API
export const adherenceApi = {
    getDaily: (date?: string) =>
        api.get<ApiResponse<DailyAdherence>>('/client/adherence/daily', { params: date ? { date } : {} }),

    getWeekly: (weekStart?: string) =>
        api.get<ApiResponse<WeeklyAdherence>>('/client/adherence/weekly', { params: weekStart ? { weekStart } : {} }),

    getHistory: (days: number = 30) =>
        api.get<ApiResponse<ComplianceHistory>>('/client/adherence/history', { params: { days } }),
};

export default api;
</file>

<file path="client-app/types/index.ts">
// API Types for Client App

/** Standard API response envelope */
export interface ApiResponse<T> {
    success: boolean;
    data: T;
}

/** Error shape returned by the backend on failure */
export interface ApiErrorResponse {
    success: false;
    message: string;
    errors?: Record<string, string[]>;
}

export interface Client {
    id: string;
    fullName: string;
    email: string;
    phone: string;
    profilePhotoUrl?: string;
    heightCm?: number;
    currentWeightKg?: number;
    targetWeightKg?: number;
    dietaryPreferences: string[];
    allergies: string[];
    onboardingCompleted?: boolean;
}

export interface MealOption {
    optionGroup: number;
    label: string;
    totalCalories: number;
    totalProteinG: number;
    totalCarbsG: number;
    totalFatsG: number;
    foodItems: MealFoodItem[];
}

export interface Meal {
    id: string;
    planId: string;
    mealType: 'breakfast' | 'lunch' | 'snack' | 'dinner';
    name: string;
    description?: string;
    timeOfDay?: string;
    instructions?: string;
    totalCalories?: number;
    totalProteinG?: number;
    totalCarbsG?: number;
    totalFatsG?: number;
    hasAlternatives?: boolean;
    options?: MealOption[];
    foodItems: MealFoodItem[];
}

export interface MealFoodItem {
    id: string;
    foodId: string;
    foodName: string;
    quantityG: number;
    calories?: number;
    optionGroup?: number;
    optionLabel?: string;
}

export interface MealLog {
    id: string;
    mealId: string;
    scheduledDate: string;
    scheduledTime?: string;
    status: 'pending' | 'eaten' | 'skipped' | 'substituted';
    chosenOptionGroup?: number;
    mealPhotoUrl?: string;
    clientNotes?: string;
    dietitianFeedback?: string;
    dietitianFeedbackAt?: string;
    loggedAt?: string;
    meal: Meal;
}

export interface WeightLog {
    id: string;
    weightKg: number;
    logDate: string;
    notes?: string;
    weightChangeFromPrevious?: number;
}

export interface ClientStats {
    weeklyAdherence: number;
    mealCompletionRate: number;
    weightTrend: 'up' | 'down' | 'stable';
    latestWeight?: number;
    targetWeight?: number;
    currentStreak: number;
}

export interface ProgressSummary {
    currentWeight: number | null;
    targetWeight: number | null;
    startWeight: number | null;
    progressPercent: number;
    weightTrend: 'up' | 'down' | 'stable';
    totalLost: number;
    remaining: number | null;
    chartEntries: { date: string; weight: number }[];
    history: {
        id: string;
        logDate: string;
        weightKg: number;
        notes: string | null;
        delta: number | null;
    }[];
}

export interface AuthResponse {
    success: boolean;
    data: {
        token: string;
        client: Client;
    };
}

export interface OTPRequestResponse {
    success: boolean;
    message: string;
}

export interface Notification {
    id: string;
    type: 'feedback' | 'reminder' | 'weight' | 'system';
    title: string;
    message?: string;
    timestamp: string;
    read: boolean;
    avatar?: string;
}

export interface Report {
    id: string;
    fileName: string;
    fileType: string;
    reportType: string;
    uploadedAt: string;
}

export interface UploadUrlResponse {
    uploadUrl: string;
    key: string;
}

export interface ReferralData {
    referralCode: string;
    shareMessage: string;
    whatsappLink: string;
}

export interface ReferralStats {
    referralCount: number;
    freeMonthsEarned: number;
    freeMonthsUsed: number;
    freeMonthsRemaining: number;
    referralsUntilNextReward: number;
    referredClients: { name: string; joinedAt: string }[];
}

// ============ PREFERENCES ============

export interface ClientPreferences {
    id: string;
    breakfastTime?: string;
    lunchTime?: string;
    dinnerTime?: string;
    snackTime?: string;
    canCook: boolean;
    kitchenAvailable: boolean;
    hasDietaryCook: boolean;
    weekdayActivity?: string;
    weekendActivity?: string;
    sportOrHobby?: string;
    generalNotes?: string;
}

// ============ ONBOARDING ============

export interface OnboardingStatus {
    isComplete: boolean;
    currentStep: number;
    totalSteps: number;
    completedSteps: number[];
    percentComplete: number;
    stepsData: Record<string, any>;
}

// ============ COMPLIANCE / ADHERENCE ============

export type ComplianceColor = 'GREEN' | 'YELLOW' | 'RED';

export interface MealBreakdown {
    mealLogId: string;
    mealName: string;
    mealType: string;
    score: number | null;
    color: ComplianceColor | null;
    status: string;
    issues: string[];
}

export interface DailyAdherence {
    date: string;
    score: number;
    color: ComplianceColor;
    mealsLogged: number;
    mealsPlanned: number;
    mealBreakdown: MealBreakdown[];
}

export interface WeeklyAdherence {
    weekStart: string;
    weekEnd: string;
    averageScore: number;
    color: ComplianceColor;
    dailyBreakdown: DailyAdherence[];
    trend: 'improving' | 'declining' | 'stable';
}

export interface ComplianceHistoryEntry {
    date: string;
    score: number;
    color: ComplianceColor;
}

export interface ComplianceHistory {
    data: ComplianceHistoryEntry[];
    averageScore: number;
    bestDay: ComplianceHistoryEntry | null;
    worstDay: ComplianceHistoryEntry | null;
}
</file>

<file path="frontend/src/app/dashboard/clients/[id]/page.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { useParams } from 'next/navigation';
import {
    ArrowLeft,
    Send,
    Utensils,
    Flag,
    TrendingDown,
    TrendingUp,
    Loader2,
    Clock,
    Camera,
    Calendar,
    CheckCircle,
    XCircle,
    AlertCircle,
    Target,
    Pencil,
    Check,
} from 'lucide-react';
import { useClient, useClientProgress, useUpdateClient } from '@/lib/hooks/use-clients';
import { useDietPlans, useDietPlan } from '@/lib/hooks/use-diet-plans';
import { useWeeklyAdherence, useComplianceHistory } from '@/lib/hooks/use-compliance';
import { useMealLogs } from '@/lib/hooks/use-meal-logs';
import { getInitials, calculateAge } from '@/lib/utils/formatters';
import { MedicalSidebar } from '@/components/diet-plan/medical-sidebar';

// ============ TYPES ============

type ClientTab = 'overview' | 'diet-plan' | 'meal-logs' | 'progress';

interface TabConfig {
    key: ClientTab;
    label: string;
}

// ============ CONSTANTS ============

const TABS: TabConfig[] = [
    { key: 'overview', label: 'Overview' },
    { key: 'diet-plan', label: 'Diet Plan' },
    { key: 'meal-logs', label: 'Meal Logs' },
    { key: 'progress', label: 'Progress' },
];

const STATUS_STYLES: Record<string, { bg: string; icon: typeof CheckCircle }> = {
    eaten:       { bg: 'bg-green-100 text-green-700',  icon: CheckCircle },
    skipped:     { bg: 'bg-red-100 text-red-700',      icon: XCircle },
    pending:     { bg: 'bg-yellow-100 text-yellow-700', icon: AlertCircle },
    substituted: { bg: 'bg-blue-100 text-blue-700',     icon: AlertCircle },
};

const COMPLIANCE_BAR_COLOR: Record<string, string> = {
    GREEN: 'bg-[#17cf54]',
    YELLOW: 'bg-yellow-400',
    RED: 'bg-red-400',
};

const MEAL_TYPE_ORDER = ['breakfast', 'lunch', 'snack', 'dinner'] as const;

// ============ COMPONENT ============

export default function ClientProfilePage() {
    const params = useParams();
    const clientId = params.id as string;

    // Tab state
    const [activeTab, setActiveTab] = useState<ClientTab>('overview');

    // API hooks — all data comes pre-computed from backend
    const { data: client, isLoading: clientLoading, error: clientError } = useClient(clientId);
    const { data: progress, isLoading: progressLoading } = useClientProgress(clientId);
    const { data: plansData } = useDietPlans({ clientId, isPublished: true });
    const { data: weeklyAdherence } = useWeeklyAdherence(clientId);

    const activePlan = plansData?.data?.[0];

    // Tab-specific hooks (called unconditionally per React rules)
    const { data: fullPlan } = useDietPlan(activePlan?.id || '');
    const { data: mealLogsData, isLoading: mealLogsLoading } = useMealLogs({ clientId, pageSize: 20 });
    const { data: complianceHistory } = useComplianceHistory(clientId, 30);
    const updateClient = useUpdateClient();

    // Editable nutrition targets state
    const [editingTargets, setEditingTargets] = useState(false);
    const [targetDraft, setTargetDraft] = useState({
        targetCalories: 0,
        targetProteinG: 0,
        targetCarbsG: 0,
        targetFatsG: 0,
    });

    const startEditTargets = () => {
        setTargetDraft({
            targetCalories: Number(client?.targetCalories) || 0,
            targetProteinG: Number(client?.targetProteinG) || 0,
            targetCarbsG: Number(client?.targetCarbsG) || 0,
            targetFatsG: Number(client?.targetFatsG) || 0,
        });
        setEditingTargets(true);
    };

    const saveTargets = () => {
        updateClient.mutate({
            id: clientId,
            targetCalories: targetDraft.targetCalories || null,
            targetProteinG: targetDraft.targetProteinG || null,
            targetCarbsG: targetDraft.targetCarbsG || null,
            targetFatsG: targetDraft.targetFatsG || null,
        } as Parameters<typeof updateClient.mutate>[0]);
        setEditingTargets(false);
    };

    if (clientLoading) {
        return (
            <div className="flex items-center justify-center h-64">
                <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
            </div>
        );
    }

    if (clientError || !client) {
        return (
            <div className="text-center py-12">
                <p className="text-red-600">Failed to load client.</p>
                <Link href="/dashboard/clients" className="text-[#17cf54] hover:underline mt-2 inline-block">
                    Back to Clients
                </Link>
            </div>
        );
    }

    // All values below come directly from backend — zero computation
    const age = calculateAge(client.dateOfBirth);
    const adherencePercent = progress?.meals?.adherencePercentage ?? 0;
    const weightChange = progress?.weight?.last30DaysChange;

    return (
        <div className="space-y-6">
            {/* Header */}
            <header className="flex flex-col gap-6">
                <div className="flex flex-wrap items-center justify-between gap-4">
                    <Link
                        href="/dashboard/clients"
                        className="flex items-center gap-2 text-[#4e9767] hover:text-[#0e1b12] transition-colors"
                    >
                        <ArrowLeft className="w-5 h-5" />
                        <span className="text-sm font-medium">Back to Clients</span>
                    </Link>
                    <div className="flex gap-2">
                        <Link
                            href={`/dashboard/diet-plans/new?clientId=${clientId}`}
                            className="flex items-center gap-2 h-10 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-bold transition-colors"
                        >
                            <Flag className="w-4 h-4" />
                            Create Diet Plan
                        </Link>
                        <button className="flex items-center gap-2 h-10 px-4 bg-[#17cf54] hover:bg-[#17cf54]/90 text-white rounded-lg text-sm font-bold transition-colors">
                            <Send className="w-4 h-4" />
                            Send Message
                        </button>
                    </div>
                </div>

                {/* Profile Header */}
                <div className="flex flex-col md:flex-row md:items-center gap-4">
                    <div className="w-24 h-24 md:w-32 md:h-32 rounded-full bg-[#17cf54]/20 flex items-center justify-center text-[#17cf54] text-3xl md:text-4xl font-bold">
                        {getInitials(client.fullName)}
                    </div>
                    <div className="flex flex-col justify-center">
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-900 tracking-tight">
                            {client.fullName}
                        </h1>
                        <p className="text-[#4e9767]">
                            {age && `Age: ${age}, `}
                            {client.gender && `Gender: ${client.gender.charAt(0).toUpperCase() + client.gender.slice(1)}`}
                        </p>
                        <p className="text-[#4e9767]">
                            {client.email} • {client.phone || 'No phone'}
                        </p>
                    </div>
                </div>
            </header>

            {/* Key Metrics */}
            <section className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Weight Trend */}
                <div className="flex flex-col gap-2 rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                    <p className="text-gray-900 font-medium">Weight Trend</p>
                    <div className="flex items-baseline gap-2">
                        <p className="text-3xl font-bold text-gray-900">
                            {progress?.weight?.currentWeight ?? client.currentWeightKg ?? '-'} kg
                        </p>
                        <span className="text-gray-400 text-lg">/ {client.targetWeightKg ?? '-'} kg goal</span>
                    </div>
                    {weightChange !== null && weightChange !== undefined && (
                        <div className="flex gap-1 items-center">
                            <span className="text-sm text-[#4e9767]">Last 30 Days</span>
                            <span className={`text-sm font-medium flex items-center gap-1 ${weightChange < 0 ? 'text-[#17cf54]' : 'text-orange-500'}`}>
                                {weightChange < 0 ? <TrendingDown className="w-4 h-4" /> : <TrendingUp className="w-4 h-4" />}
                                {weightChange > 0 ? '+' : ''}{weightChange} kg
                            </span>
                        </div>
                    )}
                    {/* Weight progress bar — all values from backend */}
                    <div className="mt-4">
                        {progress?.weight?.startWeight && progress?.weight?.targetWeight ? (
                            <div className="space-y-2">
                                <div className="flex justify-between text-xs text-gray-400">
                                    <span>Start: {progress.weight.startWeight} kg</span>
                                    <span>Target: {progress.weight.targetWeight} kg</span>
                                </div>
                                <div className="h-3 rounded-full bg-gray-100">
                                    <div
                                        className="h-3 rounded-full bg-[#17cf54] transition-all"
                                        style={{ width: `${progress.weight.progressToGoal ?? 0}%` }}
                                    />
                                </div>
                                <p className="text-xs text-[#4e9767] text-center">
                                    {progress.weight.progressToGoal != null
                                        ? `${progress.weight.progressToGoal}% to goal`
                                        : 'Progress data unavailable'}
                                </p>
                            </div>
                        ) : (
                            <div className="h-16 flex items-center justify-center text-sm text-gray-400">
                                No weight history available
                            </div>
                        )}
                    </div>
                </div>

                {/* Adherence Score */}
                <div className="flex flex-col gap-3 rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                    <div className="flex items-center justify-between">
                        <p className="text-gray-900 font-medium">Adherence Score</p>
                        <div className="flex items-center gap-2">
                            {weeklyAdherence?.trend && weeklyAdherence.trend !== 'stable' && (
                                <span className={`text-xs font-medium flex items-center gap-1 ${weeklyAdherence.trend === 'improving' ? 'text-[#17cf54]' : 'text-orange-500'}`}>
                                    {weeklyAdherence.trend === 'improving' ? <TrendingUp className="w-3 h-3" /> : <TrendingDown className="w-3 h-3" />}
                                    {weeklyAdherence.trend === 'improving' ? 'Improving' : 'Declining'}
                                </span>
                            )}
                            <p className={`text-2xl font-bold ${
                                weeklyAdherence?.color === 'GREEN' ? 'text-[#17cf54]' :
                                weeklyAdherence?.color === 'YELLOW' ? 'text-yellow-500' :
                                weeklyAdherence?.color === 'RED' ? 'text-red-500' :
                                'text-[#17cf54]'
                            }`}>
                                {weeklyAdherence ? `${weeklyAdherence.averageScore}%` : (progressLoading ? '...' : `${adherencePercent}%`)}
                            </p>
                        </div>
                    </div>
                    <div className="h-2 rounded-full bg-[#17cf54]/20">
                        <div
                            className="h-2 rounded-full bg-[#17cf54] transition-all"
                            style={{ width: `${weeklyAdherence?.averageScore ?? adherencePercent}%` }}
                        />
                    </div>
                    <p className="text-sm text-[#4e9767]">
                        {client.fullName.split(' ')[0]} has logged {progress?.meals?.eaten ?? 0} of {progress?.meals?.total ?? 0} meals.
                    </p>

                    {/* Weekly adherence chart — colors from backend */}
                    {weeklyAdherence?.dailyBreakdown && (
                        <div className="h-28 mt-2 flex gap-1">
                            {weeklyAdherence.dailyBreakdown.map((day, i) => {
                                const barColor = day.mealsLogged === 0
                                    ? 'bg-gray-200'
                                    : (COMPLIANCE_BAR_COLOR[day.color] || 'bg-gray-200');
                                const dayLabel = new Date(day.date).toLocaleDateString('en-US', { weekday: 'short' });
                                return (
                                    <div key={i} className="flex-1 flex flex-col items-center">
                                        <div className="flex-1 w-full relative">
                                            <div
                                                className={`absolute bottom-0 inset-x-0 ${barColor} rounded-t transition-all`}
                                                style={{ height: `${day.score || 4}%` }}
                                                title={`${dayLabel}: ${day.score}%`}
                                            />
                                        </div>
                                        <span className="text-[10px] text-gray-400 mt-1 shrink-0">{dayLabel}</span>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    <div className="mt-auto pt-4 border-t border-gray-100 grid grid-cols-3 gap-2 text-center text-sm">
                        <div>
                            <p className="font-bold text-gray-900">{progress?.meals?.eaten ?? 0}</p>
                            <p className="text-gray-500">Eaten</p>
                        </div>
                        <div>
                            <p className="font-bold text-gray-900">{progress?.meals?.skipped ?? 0}</p>
                            <p className="text-gray-500">Skipped</p>
                        </div>
                        <div>
                            <p className="font-bold text-gray-900">{progress?.meals?.pending ?? 0}</p>
                            <p className="text-gray-500">Pending</p>
                        </div>
                    </div>
                </div>
            </section>

            {/* Tab Navigation */}
            <section>
                <div className="border-b border-gray-200">
                    <nav className="-mb-px flex space-x-6">
                        {TABS.map((tab) => (
                            <button
                                key={tab.key}
                                onClick={() => setActiveTab(tab.key)}
                                className={`whitespace-nowrap border-b-2 px-1 pb-3 text-sm font-medium transition-colors ${
                                    activeTab === tab.key
                                        ? 'border-[#17cf54] text-[#17cf54] font-semibold'
                                        : 'border-transparent text-[#4e9767] hover:border-gray-300 hover:text-gray-900'
                                }`}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </nav>
                </div>

                {/* ===== OVERVIEW TAB ===== */}
                {activeTab === 'overview' && (
                    <div className="mt-6 space-y-6">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Current Diet Plan */}
                            <div className="flex flex-col gap-4 rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-[#17cf54]/10 flex items-center justify-center text-[#17cf54]">
                                        <Flag className="w-5 h-5" />
                                    </div>
                                    <h3 className="font-semibold text-gray-900">Current Diet Plan</h3>
                                </div>
                                {activePlan ? (
                                    <>
                                        <p className="text-[#4e9767]">Active since {new Date(activePlan.startDate).toLocaleDateString()}</p>
                                        <p className="text-lg font-medium text-gray-900">{activePlan.name || activePlan.title}</p>
                                        <p className="text-sm text-[#4e9767]">{activePlan.description || 'No description'}</p>
                                    </>
                                ) : (
                                    <p className="text-gray-500 text-sm">No active diet plan</p>
                                )}
                            </div>

                            {/* Nutrition Targets — client-specific, editable */}
                            <div className="flex flex-col gap-4 rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-[#17cf54]/10 flex items-center justify-center text-[#17cf54]">
                                            <Utensils className="w-5 h-5" />
                                        </div>
                                        <h3 className="font-semibold text-gray-900">Nutrition Targets</h3>
                                    </div>
                                    {editingTargets ? (
                                        <button onClick={saveTargets} className="p-1.5 rounded hover:bg-green-50 text-green-600" title="Save">
                                            <Check className="w-4 h-4" />
                                        </button>
                                    ) : (
                                        <button onClick={startEditTargets} className="p-1.5 rounded hover:bg-gray-100 text-gray-400" title="Edit targets">
                                            <Pencil className="w-4 h-4" />
                                        </button>
                                    )}
                                </div>
                                {editingTargets ? (
                                    <div className="grid grid-cols-2 gap-3 text-sm">
                                        {([
                                            { key: 'targetCalories' as const, label: 'Calories (kcal)', min: 500, max: 10000 },
                                            { key: 'targetProteinG' as const, label: 'Protein (g)', min: 0, max: 500 },
                                            { key: 'targetCarbsG' as const, label: 'Carbs (g)', min: 0, max: 1000 },
                                            { key: 'targetFatsG' as const, label: 'Fat (g)', min: 0, max: 500 },
                                        ]).map(({ key, label, min, max }) => (
                                            <div key={key} className="bg-gray-50 p-3 rounded">
                                                <input
                                                    type="number"
                                                    min={min}
                                                    max={max}
                                                    value={targetDraft[key] || ''}
                                                    onChange={e => setTargetDraft(prev => ({ ...prev, [key]: Number(e.target.value) || 0 }))}
                                                    className="w-full font-bold text-gray-900 bg-white border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-[#17cf54] focus:border-[#17cf54] outline-none"
                                                />
                                                <p className="text-gray-500 mt-1">{label}</p>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-3 text-sm">
                                        <div className="bg-gray-50 p-3 rounded">
                                            <p className="font-bold text-gray-900">{client.targetCalories ?? activePlan?.targetCalories ?? '-'}</p>
                                            <p className="text-gray-500">Calories</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded">
                                            <p className="font-bold text-gray-900">{client.targetProteinG ?? activePlan?.targetProteinG ?? '-'}g</p>
                                            <p className="text-gray-500">Protein</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded">
                                            <p className="font-bold text-gray-900">{client.targetCarbsG ?? activePlan?.targetCarbsG ?? '-'}g</p>
                                            <p className="text-gray-500">Carbs</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded">
                                            <p className="font-bold text-gray-900">{client.targetFatsG ?? activePlan?.targetFatsG ?? '-'}g</p>
                                            <p className="text-gray-500">Fat</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Medical Summary — full width */}
                        <MedicalSidebar clientId={clientId} />
                    </div>
                )}

                {/* ===== DIET PLAN TAB ===== */}
                {activeTab === 'diet-plan' && (
                    <div className="mt-6 space-y-6">
                        {!activePlan ? (
                            <div className="rounded-xl bg-white p-12 shadow-sm border border-gray-100 text-center">
                                <Flag className="w-12 h-12 text-gray-300 mx-auto mb-4" />
                                <h3 className="text-lg font-semibold text-gray-900 mb-2">No Active Diet Plan</h3>
                                <p className="text-gray-500 mb-6">Create a diet plan to get started with meal scheduling.</p>
                                <Link
                                    href={`/dashboard/diet-plans/new?clientId=${clientId}`}
                                    className="inline-flex items-center gap-2 px-4 py-2 bg-[#17cf54] text-white rounded-lg text-sm font-bold hover:bg-[#17cf54]/90 transition-colors"
                                >
                                    <Flag className="w-4 h-4" />
                                    Create Diet Plan
                                </Link>
                            </div>
                        ) : (
                            <>
                                {/* Plan Header */}
                                <div className="rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                                    <div className="flex items-center justify-between mb-4">
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-900">
                                                {fullPlan?.name || activePlan.name || activePlan.title || 'Diet Plan'}
                                            </h3>
                                            <p className="text-sm text-[#4e9767]">
                                                Active since {new Date(activePlan.startDate).toLocaleDateString()}
                                            </p>
                                            {(fullPlan?.description || activePlan.description) && (
                                                <p className="text-sm text-gray-500 mt-1">
                                                    {fullPlan?.description || activePlan.description}
                                                </p>
                                            )}
                                        </div>
                                        <Link
                                            href={`/dashboard/diet-plans/${activePlan.id}`}
                                            className="text-sm text-[#17cf54] hover:underline font-medium"
                                        >
                                            View Full Plan
                                        </Link>
                                    </div>

                                    {/* Nutrition Targets Row — plan targets with client fallback */}
                                    <div className="grid grid-cols-4 gap-3 text-sm">
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="font-bold text-gray-900">{activePlan.targetCalories ?? client.targetCalories ?? '-'}</p>
                                            <p className="text-gray-500">Calories</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="font-bold text-gray-900">{activePlan.targetProteinG ?? client.targetProteinG ?? '-'}g</p>
                                            <p className="text-gray-500">Protein</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="font-bold text-gray-900">{activePlan.targetCarbsG ?? client.targetCarbsG ?? '-'}g</p>
                                            <p className="text-gray-500">Carbs</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="font-bold text-gray-900">{activePlan.targetFatsG ?? client.targetFatsG ?? '-'}g</p>
                                            <p className="text-gray-500">Fat</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Meals grouped by mealType */}
                                <div className="rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                                    <h3 className="font-semibold text-gray-900 mb-4">Meals</h3>
                                    {fullPlan?.meals && fullPlan.meals.length > 0 ? (
                                        <div className="space-y-6">
                                            {MEAL_TYPE_ORDER.map((mealType) => {
                                                const mealsOfType = fullPlan.meals!.filter(m => m.mealType === mealType);
                                                if (mealsOfType.length === 0) return null;
                                                return (
                                                    <div key={mealType}>
                                                        <h4 className="text-sm font-medium text-[#4e9767] uppercase tracking-wide mb-2">
                                                            {mealType}
                                                        </h4>
                                                        <div className="space-y-3">
                                                            {mealsOfType.map((meal) => (
                                                                <div key={meal.id} className="p-4 bg-gray-50 rounded-lg">
                                                                    <div className="flex items-center justify-between mb-1">
                                                                        <p className="font-medium text-gray-900">{meal.name}</p>
                                                                        {meal.scheduledTime && (
                                                                            <span className="text-xs text-gray-500 flex items-center gap-1">
                                                                                <Clock className="w-3 h-3" />
                                                                                {meal.scheduledTime}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    {meal.foodItems && meal.foodItems.length > 0 && (
                                                                        <div className="mt-2 space-y-1">
                                                                            {meal.foodItems.map((food, fi) => (
                                                                                <div key={fi} className="text-sm text-gray-600 flex justify-between">
                                                                                    <span>{food.foodItem?.name || 'Unknown'}</span>
                                                                                    <span className="text-gray-400">{food.quantityG}g</span>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <div className="text-center py-8 text-gray-500">
                                            <Utensils className="w-8 h-8 mx-auto mb-2 text-gray-300" />
                                            <p className="text-sm">No meals added to this plan yet</p>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                )}

                {/* ===== MEAL LOGS TAB ===== */}
                {activeTab === 'meal-logs' && (
                    <div className="mt-6">
                        <div className="rounded-xl bg-white shadow-sm border border-gray-100 overflow-hidden">
                            {mealLogsLoading ? (
                                <div className="flex items-center justify-center py-12">
                                    <Loader2 className="w-6 h-6 animate-spin text-[#17cf54]" />
                                </div>
                            ) : !mealLogsData?.data?.length ? (
                                <div className="text-center py-12">
                                    <Calendar className="w-10 h-10 text-gray-300 mx-auto mb-3" />
                                    <p className="text-gray-500 font-medium">No meal logs yet</p>
                                    <p className="text-sm text-gray-400 mt-1">Logs will appear as the client records meals</p>
                                </div>
                            ) : (
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className="border-b border-gray-100 text-left">
                                            <th className="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wide">Date</th>
                                            <th className="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wide">Meal</th>
                                            <th className="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wide">Type</th>
                                            <th className="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wide">Status</th>
                                            <th className="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wide">Photo</th>
                                            <th className="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wide">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-50">
                                        {mealLogsData.data.map((log) => {
                                            const style = STATUS_STYLES[log.status] || STATUS_STYLES.pending;
                                            const StatusIcon = style.icon;
                                            return (
                                                <tr key={log.id} className="hover:bg-gray-50 transition-colors">
                                                    <td className="px-6 py-3 text-gray-900">
                                                        {new Date(log.scheduledDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}
                                                        {log.scheduledTime && (
                                                            <span className="text-gray-400 ml-1 text-xs">{log.scheduledTime}</span>
                                                        )}
                                                    </td>
                                                    <td className="px-6 py-3 text-gray-900 font-medium">
                                                        {log.meal?.name || 'Unknown'}
                                                    </td>
                                                    <td className="px-6 py-3 text-gray-500 capitalize">
                                                        {log.meal?.mealType || '-'}
                                                    </td>
                                                    <td className="px-6 py-3">
                                                        <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${style.bg}`}>
                                                            <StatusIcon className="w-3 h-3" />
                                                            {log.status}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-3">
                                                        {log.mealPhotoUrl ? (
                                                            <Camera className="w-4 h-4 text-[#17cf54]" />
                                                        ) : (
                                                            <span className="text-gray-300">-</span>
                                                        )}
                                                    </td>
                                                    <td className="px-6 py-3 text-gray-500 max-w-[200px] truncate">
                                                        {log.clientNotes || '-'}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>
                )}

                {/* ===== PROGRESS TAB ===== */}
                {activeTab === 'progress' && (
                    <div className="mt-6 space-y-6">
                        {/* Weight Progress Card */}
                        <div className="rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                            <h3 className="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                <Target className="w-5 h-5 text-[#17cf54]" />
                                Weight Progress
                            </h3>
                            {progress?.weight ? (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="text-2xl font-bold text-gray-900">
                                                {progress.weight.startWeight ?? '-'}
                                            </p>
                                            <p className="text-gray-500">Start (kg)</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="text-2xl font-bold text-gray-900">
                                                {progress.weight.currentWeight ?? '-'}
                                            </p>
                                            <p className="text-gray-500">Current (kg)</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="text-2xl font-bold text-gray-900">
                                                {progress.weight.targetWeight ?? '-'}
                                            </p>
                                            <p className="text-gray-500">Target (kg)</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className={`text-2xl font-bold ${
                                                (progress.weight.totalChange ?? 0) < 0 ? 'text-[#17cf54]' : 'text-orange-500'
                                            }`}>
                                                {progress.weight.totalChange != null
                                                    ? `${progress.weight.totalChange > 0 ? '+' : ''}${progress.weight.totalChange}`
                                                    : '-'}
                                            </p>
                                            <p className="text-gray-500">Change (kg)</p>
                                        </div>
                                    </div>

                                    {/* Progress bar */}
                                    {progress.weight.progressToGoal != null && (
                                        <div className="space-y-1">
                                            <div className="flex justify-between text-xs text-gray-400">
                                                <span>{progress.weight.startWeight} kg</span>
                                                <span>{progress.weight.targetWeight} kg</span>
                                            </div>
                                            <div className="h-3 rounded-full bg-gray-100">
                                                <div
                                                    className="h-3 rounded-full bg-[#17cf54] transition-all"
                                                    style={{ width: `${progress.weight.progressToGoal}%` }}
                                                />
                                            </div>
                                            <p className="text-xs text-center text-[#4e9767]">
                                                {progress.weight.progressToGoal}% to goal
                                            </p>
                                        </div>
                                    )}

                                    {progress.weight.weeklyAvgChange != null && (
                                        <p className="text-sm text-[#4e9767]">
                                            Weekly average change: {progress.weight.weeklyAvgChange > 0 ? '+' : ''}{progress.weight.weeklyAvgChange} kg
                                        </p>
                                    )}
                                </div>
                            ) : (
                                <p className="text-gray-500 text-sm py-4 text-center">No weight data available</p>
                            )}
                        </div>

                        {/* 30-Day Compliance History */}
                        <div className="rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                            <h3 className="font-semibold text-gray-900 mb-4">30-Day Compliance History</h3>
                            {complianceHistory?.data && complianceHistory.data.length > 0 ? (
                                <div className="space-y-4">
                                    {/* Summary stats row — all values from backend */}
                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="text-xl font-bold text-gray-900">
                                                {complianceHistory.averageScore}%
                                            </p>
                                            <p className="text-gray-500">Avg Score</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="text-xl font-bold text-[#17cf54]">
                                                {complianceHistory.bestDay
                                                    ? `${complianceHistory.bestDay.score}%`
                                                    : '-'}
                                            </p>
                                            <p className="text-gray-500">Best Day</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded text-center">
                                            <p className="text-xl font-bold text-red-500">
                                                {complianceHistory.worstDay
                                                    ? `${complianceHistory.worstDay.score}%`
                                                    : '-'}
                                            </p>
                                            <p className="text-gray-500">Worst Day</p>
                                        </div>
                                    </div>

                                    {/* 30-day bar chart — colors from backend */}
                                    <div className="h-32 flex gap-px relative">
                                        {complianceHistory.data.map((entry, i) => (
                                            <div key={i} className="flex-1 relative">
                                                <div
                                                    className={`absolute bottom-0 inset-x-0 ${COMPLIANCE_BAR_COLOR[entry.color] || 'bg-gray-200'} rounded-t transition-all`}
                                                    style={{ height: `${entry.score || 3}%` }}
                                                    title={`${new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: ${entry.score}%`}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex justify-between text-[10px] text-gray-400">
                                        <span>
                                            {new Date(complianceHistory.data[0].date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                        </span>
                                        <span>
                                            {new Date(complianceHistory.data[complianceHistory.data.length - 1].date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                        </span>
                                    </div>
                                </div>
                            ) : (
                                <p className="text-gray-500 text-sm py-4 text-center">No compliance data for the last 30 days</p>
                            )}
                        </div>

                        {/* This Week's Adherence — reusing existing pattern */}
                        {weeklyAdherence?.dailyBreakdown && (
                            <div className="rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                                <h3 className="font-semibold text-gray-900 mb-4">This Week&apos;s Adherence</h3>
                                <div className="h-40 flex gap-2">
                                    {weeklyAdherence.dailyBreakdown.map((day, i) => {
                                        const barColor = day.mealsLogged === 0
                                            ? 'bg-gray-200'
                                            : (COMPLIANCE_BAR_COLOR[day.color] || 'bg-gray-200');
                                        const dayLabel = new Date(day.date).toLocaleDateString('en-US', { weekday: 'short' });
                                        return (
                                            <div key={i} className="flex-1 flex flex-col items-center">
                                                <span className="text-xs font-medium text-gray-700 shrink-0">{day.score}%</span>
                                                <div className="flex-1 w-full relative">
                                                    <div
                                                        className={`absolute bottom-0 inset-x-0 ${barColor} rounded-t transition-all`}
                                                        style={{ height: `${day.score || 4}%` }}
                                                    />
                                                </div>
                                                <span className="text-[10px] text-gray-400 mt-1 shrink-0">{dayLabel}</span>
                                                <span className="text-[10px] text-gray-300 shrink-0">{day.mealsLogged}/{day.mealsPlanned}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </section>
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/diet-plans/[id]/page.tsx">
'use client';

import { useParams, useRouter } from 'next/navigation';
import { useDietPlan, usePublishDietPlan, useUpdateDietPlan } from '@/lib/hooks/use-diet-plans';
import { ArrowLeft, Calendar, User, FileText, Utensils, Loader2, Clock, AlertCircle, Pencil, Download, Printer } from 'lucide-react';
import Link from 'next/link';
import { useState } from 'react';
import { useApiClient } from '@/lib/api/use-api-client';

export default function DietPlanDetailPage() {
    const params = useParams();
    const router = useRouter();
    const planId = params.id as string;

    const api = useApiClient();
    const { data: plan, isLoading, error, refetch } = useDietPlan(planId);
    const publishMutation = usePublishDietPlan();
    const updateMutation = useUpdateDietPlan();

    const [isEditingName, setIsEditingName] = useState(false);
    const [editedName, setEditedName] = useState('');

    const handlePublish = async () => {
        if (!plan) return;
        try {
            await publishMutation.mutateAsync(planId);
            await refetch(); // Refetch to update UI immediately
        } catch (err) {
            console.error('Failed to publish plan:', err);
        }
    };

    const handleSaveName = async () => {
        if (!editedName.trim() || !plan) return;
        try {
            await updateMutation.mutateAsync({ id: planId, name: editedName });
            setIsEditingName(false);
            await refetch();
        } catch (err) {
            console.error('Failed to update name:', err);
        }
    };

    const handleDownloadPdf = async () => {
        try {
            const response = await api.get(`/share/diet-plans/${planId}/pdf`, {
                responseType: 'blob',
            });
            const url = window.URL.createObjectURL(new Blob([response.data]));
            const a = document.createElement('a');
            a.href = url;
            a.download = `${plan?.name || 'diet-plan'}.pdf`;
            a.click();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            console.error('Failed to download PDF:', err);
        }
    };

    const handlePrint = async () => {
        try {
            const response = await api.get(`/share/diet-plans/${planId}/print`);
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(response.data);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            }
        } catch (err) {
            console.error('Failed to get print view:', err);
        }
    };

    if (isLoading) {
        return (
            <div className="flex justify-center items-center py-20">
                <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
            </div>
        );
    }

    if (error || !plan) {
        return (
            <div className="text-center py-20">
                <AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" />
                <h2 className="text-xl font-semibold text-gray-900 mb-2">Plan not found</h2>
                <p className="text-gray-500 mb-4">The diet plan you&apos;re looking for doesn&apos;t exist.</p>
                <Link href="/dashboard/diet-plans" className="text-[#17cf54] hover:underline">
                    ← Back to Diet Plans
                </Link>
            </div>
        );
    }

    const statusColor = plan.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <button
                        onClick={() => router.back()}
                        className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                    >
                        <ArrowLeft className="w-5 h-5 text-gray-600" />
                    </button>
                    <div>
                        {isEditingName ? (
                            <div className="flex items-center gap-2">
                                <input
                                    type="text"
                                    value={editedName}
                                    onChange={(e) => setEditedName(e.target.value)}
                                    className="text-2xl font-bold text-gray-900 border border-gray-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-[#17cf54] focus:border-transparent outline-none"
                                    autoFocus
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') handleSaveName();
                                        if (e.key === 'Escape') setIsEditingName(false);
                                    }}
                                />
                                <button
                                    onClick={handleSaveName}
                                    disabled={updateMutation.isPending}
                                    className="px-3 py-1 bg-[#17cf54] text-white text-sm font-medium rounded-lg hover:bg-[#17cf54]/90 disabled:opacity-50"
                                >
                                    {updateMutation.isPending ? 'Saving...' : 'Save'}
                                </button>
                                <button
                                    onClick={() => setIsEditingName(false)}
                                    className="px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-300"
                                >
                                    Cancel
                                </button>
                            </div>
                        ) : (
                            <div className="flex items-center gap-2">
                                <h1 className="text-2xl font-bold text-gray-900">
                                    {plan.name || 'Diet Plan'}
                                </h1>
                                <button
                                    onClick={() => {
                                        setEditedName(plan.name || '');
                                        setIsEditingName(true);
                                    }}
                                    className="p-1 hover:bg-gray-100 rounded-lg transition-colors"
                                    title="Edit name"
                                >
                                    <Pencil className="w-4 h-4 text-gray-400 hover:text-gray-600" />
                                </button>
                            </div>
                        )}
                        <p className="text-gray-500">
                            For {plan.client?.fullName || 'Unknown Client'}
                        </p>
                    </div>
                </div>
                <div className="flex items-center gap-3">
                    <button
                        onClick={handleDownloadPdf}
                        className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                        title="Download PDF"
                    >
                        <Download className="w-5 h-5 text-gray-600" />
                    </button>
                    <button
                        onClick={handlePrint}
                        className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                        title="Print"
                    >
                        <Printer className="w-5 h-5 text-gray-600" />
                    </button>
                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${statusColor}`}>
                        {plan.status === 'active' ? 'Active' : 'Draft'}
                    </span>
                    {plan.status !== 'active' && (
                        <button
                            onClick={handlePublish}
                            disabled={publishMutation.isPending}
                            className="px-4 py-2 bg-[#17cf54] text-white font-medium rounded-lg hover:bg-[#17cf54]/90 transition-colors disabled:opacity-50"
                        >
                            {publishMutation.isPending ? 'Publishing...' : 'Publish Plan'}
                        </button>
                    )}
                </div>
            </div>

            {/* Plan Details Card */}
            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                <h2 className="text-lg font-semibold text-gray-900 mb-4">Plan Details</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                            <Calendar className="w-5 h-5 text-blue-600" />
                        </div>
                        <div>
                            <p className="text-sm text-gray-500">Start Date</p>
                            <p className="font-medium text-gray-900">
                                {new Date(plan.startDate).toLocaleDateString()}
                            </p>
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-purple-50 rounded-lg flex items-center justify-center">
                            <User className="w-5 h-5 text-purple-600" />
                        </div>
                        <div>
                            <p className="text-sm text-gray-500">Client</p>
                            <p className="font-medium text-gray-900">{plan.client?.fullName || 'N/A'}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-orange-50 rounded-lg flex items-center justify-center">
                            <Utensils className="w-5 h-5 text-orange-600" />
                        </div>
                        <div>
                            <p className="text-sm text-gray-500">Target Calories</p>
                            <p className="font-medium text-gray-900">
                                {plan.targetCalories || 'Not set'} {plan.targetCalories && 'kcal'}
                            </p>
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                            <FileText className="w-5 h-5 text-green-600" />
                        </div>
                        <div>
                            <p className="text-sm text-gray-500">Meals</p>
                            <p className="font-medium text-gray-900">{plan.meals?.length || 0} meals</p>
                        </div>
                    </div>
                </div>

                {plan.description && (
                    <div className="mt-6 pt-6 border-t border-gray-100">
                        <p className="text-sm text-gray-500 mb-2">Description</p>
                        <p className="text-gray-700">{plan.description}</p>
                    </div>
                )}
            </div>

            {/* Meals Section */}
            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                <h2 className="text-lg font-semibold text-gray-900 mb-4">Meals</h2>
                {plan.meals && plan.meals.length > 0 ? (
                    <div className="space-y-4">
                        {plan.meals.map((meal, index) => {
                            // Group food items by optionGroup
                            const optionGroups = new Map<number, typeof meal.foodItems>();
                            (meal.foodItems || []).forEach((fi: any) => {
                                const g = fi.optionGroup ?? 0;
                                if (!optionGroups.has(g)) optionGroups.set(g, []);
                                optionGroups.get(g)!.push(fi);
                            });
                            const sortedGroups = Array.from(optionGroups.entries()).sort(([a], [b]) => a - b);
                            const hasAlts = sortedGroups.length > 1;

                            return (
                                <div key={meal.id || index} className="p-4 bg-gray-50 rounded-lg">
                                    <div className="flex items-center justify-between mb-2">
                                        <h3 className="font-medium text-gray-900">{meal.name}</h3>
                                        <div className="flex items-center gap-2">
                                            {hasAlts && (
                                                <span className="text-xs font-medium text-blue-500 bg-blue-50 px-2 py-0.5 rounded">
                                                    {sortedGroups.length} options
                                                </span>
                                            )}
                                            <span className="text-sm text-gray-500 capitalize">{meal.mealType}</span>
                                        </div>
                                    </div>
                                    {meal.scheduledTime && (
                                        <p className="text-sm text-gray-500 flex items-center gap-1">
                                            <Clock className="w-4 h-4" />
                                            {meal.scheduledTime}
                                        </p>
                                    )}
                                    {sortedGroups.length > 0 && (
                                        <div className="mt-3">
                                            {sortedGroups.map(([groupNum, foods], gIdx) => (
                                                <div key={groupNum}>
                                                    {hasAlts && gIdx > 0 && (
                                                        <div className="flex items-center gap-2 my-2">
                                                            <div className="flex-grow border-t border-dashed border-gray-300" />
                                                            <span className="text-xs font-bold text-gray-400 tracking-wider">OR</span>
                                                            <div className="flex-grow border-t border-dashed border-gray-300" />
                                                        </div>
                                                    )}
                                                    {hasAlts && (
                                                        <p className="text-xs font-semibold text-[#17cf54] mb-1">
                                                            {(foods as any)[0]?.optionLabel || `Option ${String.fromCharCode(65 + gIdx)}`}
                                                        </p>
                                                    )}
                                                    <div className="space-y-1">
                                                        {(foods as any[]).map((food: any, fi: number) => (
                                                            <div key={fi} className="text-sm text-gray-600 flex justify-between">
                                                                <span>{food.foodItem?.name || 'Unknown'}</span>
                                                                <span>{food.quantityG}g</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                ) : (
                    <div className="text-center py-8 text-gray-500">
                        <Utensils className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                        <p>No meals added yet</p>
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/app/dashboard/reviews/page.tsx">
'use client';

import { useState } from 'react';
import {
    Camera,
    ArrowRight,
    Check,
    X,
    RefreshCw,
    Loader2,
} from 'lucide-react';
import { useMealLogs, useReviewMealLog, MealLog } from '@/lib/hooks/use-meal-logs';

type FilterType = 'all' | 'pending' | 'reviewed';
type MealStatus = 'eaten' | 'skipped' | 'substituted';

export default function MealReviewPage() {
    const [filter, setFilter] = useState<FilterType>('pending');
    const [selectedMealId, setSelectedMealId] = useState<string | null>(null);
    const [mealStatus, setMealStatus] = useState<MealStatus | null>(null);
    const [feedback, setFeedback] = useState('');

    // API hooks
    const { data, isLoading, error } = useMealLogs({
        reviewStatus: filter === 'all' ? undefined : filter === 'pending' ? 'pending' : 'reviewed',
        pageSize: 50,
    });
    const reviewMutation = useReviewMealLog();

    const mealLogs = data?.data || [];
    const selectedMeal = mealLogs.find(m => m.id === selectedMealId) || mealLogs[0];

    const handleReviewSubmit = async () => {
        if (!selectedMeal || !mealStatus) return;

        try {
            await reviewMutation.mutateAsync({
                id: selectedMeal.id,
                status: mealStatus,
                dietitianFeedback: feedback || undefined,
            });

            // Move to next meal
            const currentIndex = mealLogs.findIndex(m => m.id === selectedMeal.id);
            if (currentIndex < mealLogs.length - 1) {
                setSelectedMealId(mealLogs[currentIndex + 1].id);
            }
            setMealStatus(null);
            setFeedback('');
        } catch (err) {
            console.error('Failed to review meal:', err);
        }
    };

    const getInitials = (name?: string) => {
        if (!name) return '??';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    };

    const formatDate = (date: string) => {
        const d = new Date(date);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (d.toDateString() === today.toDateString()) return 'Today';
        if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
        return d.toLocaleDateString();
    };

    return (
        <div className="flex h-[calc(100vh-5rem)] -m-6">
            {/* Left Column: Meal Queue */}
            <div className="w-80 flex-shrink-0 flex flex-col bg-white border-r border-gray-200 h-full overflow-hidden">
                {/* Header */}
                <div className="p-6 border-b border-gray-200">
                    <h1 className="text-2xl font-bold text-gray-900 tracking-tight">
                        Meal Photo Review
                    </h1>
                </div>

                {/* Filters */}
                <div className="px-6 py-4 border-b border-gray-200">
                    <div className="flex h-10 w-full items-center justify-center rounded-lg bg-[#17cf54]/10 p-1">
                        {(['all', 'pending', 'reviewed'] as FilterType[]).map((f) => (
                            <button
                                key={f}
                                onClick={() => setFilter(f)}
                                className={`flex-1 h-full rounded-md text-sm font-medium transition-colors capitalize ${filter === f
                                    ? 'bg-white shadow-sm text-gray-900'
                                    : 'text-[#4e9767] hover:text-gray-900'
                                    }`}
                            >
                                {f}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Loading */}
                {isLoading && (
                    <div className="flex-1 flex items-center justify-center">
                        <Loader2 className="w-6 h-6 animate-spin text-[#17cf54]" />
                    </div>
                )}

                {/* Error */}
                {error && (
                    <div className="p-4 text-sm text-red-600">
                        Failed to load meal logs.
                    </div>
                )}

                {/* Empty */}
                {!isLoading && !error && mealLogs.length === 0 && (
                    <div className="flex-1 flex items-center justify-center text-gray-500 text-sm">
                        No meals to review
                    </div>
                )}

                {/* Meal List */}
                <div className="flex-1 overflow-y-auto divide-y divide-gray-200">
                    {mealLogs.map((meal: MealLog) => (
                        <button
                            key={meal.id}
                            onClick={() => {
                                setSelectedMealId(meal.id);
                                setMealStatus(null);
                                setFeedback('');
                            }}
                            className={`w-full flex items-center gap-4 px-6 py-4 text-left transition-colors ${selectedMeal?.id === meal.id
                                ? 'bg-[#17cf54]/10'
                                : 'hover:bg-gray-50'
                                }`}
                        >
                            <div className="w-12 h-12 rounded-full bg-[#17cf54]/20 flex items-center justify-center text-[#17cf54] font-bold flex-shrink-0">
                                {getInitials(meal.client?.fullName)}
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="font-medium text-gray-900 truncate">{meal.client?.fullName || 'Unknown'}</p>
                                <p className="text-sm text-[#4e9767] truncate">
                                    {meal.meal?.mealType || 'Meal'} - {formatDate(meal.scheduledDate)}, {meal.scheduledTime}
                                </p>
                            </div>
                            <div className="flex-shrink-0">
                                <div
                                    className={`w-3 h-3 rounded-full ${!meal.dietitianFeedback ? 'bg-yellow-500 animate-pulse' : 'bg-green-600'
                                        }`}
                                />
                            </div>
                        </button>
                    ))}
                </div>
            </div>

            {/* Right Column: Review Panel */}
            <div className="flex-1 p-8 overflow-y-auto bg-gray-50">
                {selectedMeal ? (
                    <div className="max-w-2xl mx-auto space-y-6">
                        {/* Image */}
                        <div className="w-full aspect-[4/3] bg-gradient-to-br from-[#17cf54]/20 to-[#17cf54]/5 rounded-xl flex items-center justify-center border border-gray-200 overflow-hidden">
                            {selectedMeal.mealPhotoUrl ? (
                                <img
                                    src={selectedMeal.mealPhotoUrl}
                                    alt="Meal photo"
                                    className="w-full h-full object-cover"
                                />
                            ) : (
                                <div className="text-center">
                                    <Camera className="w-16 h-16 text-[#17cf54]/50 mx-auto mb-2" />
                                    <p className="text-[#4e9767]">No photo uploaded</p>
                                </div>
                            )}
                        </div>

                        {/* Client Info */}
                        <div>
                            <p className="text-sm text-gray-500">
                                Reviewing {selectedMeal.client?.fullName}&apos;s {selectedMeal.meal?.mealType || 'Meal'}
                            </p>
                            <h2 className="text-2xl font-bold text-gray-900 mt-1">
                                {selectedMeal.meal?.name || 'Meal Log'}
                            </h2>
                            {selectedMeal.clientNotes && (
                                <p className="text-sm text-gray-600 mt-2 italic">
                                    &quot;{selectedMeal.clientNotes}&quot;
                                </p>
                            )}
                        </div>

                        {/* Action Radio Group */}
                        <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-700">Mark as:</p>
                            <div className="grid grid-cols-3 gap-3">
                                {(['eaten', 'skipped', 'substituted'] as MealStatus[]).map((status) => (
                                    <button
                                        key={status}
                                        onClick={() => setMealStatus(status)}
                                        className={`flex items-center justify-center gap-2 rounded-lg p-3 text-center border transition-colors capitalize ${mealStatus === status
                                            ? 'bg-[#17cf54]/20 border-[#17cf54] text-gray-900'
                                            : 'border-gray-200 hover:border-[#17cf54] text-gray-700 bg-white'
                                            }`}
                                    >
                                        {status === 'eaten' && <Check className="w-4 h-4" />}
                                        {status === 'skipped' && <X className="w-4 h-4" />}
                                        {status === 'substituted' && <RefreshCw className="w-4 h-4" />}
                                        <span className="text-sm font-medium">{status}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Feedback Text Area */}
                        <div className="space-y-2">
                            <label className="text-sm font-medium text-gray-700" htmlFor="feedback">
                                Feedback
                            </label>
                            <textarea
                                id="feedback"
                                value={feedback}
                                onChange={(e) => setFeedback(e.target.value)}
                                className="w-full p-3 border border-gray-200 rounded-lg bg-white text-gray-900 focus:ring-[#17cf54] focus:border-[#17cf54] placeholder-gray-400"
                                placeholder="Provide feedback or suggestions..."
                                rows={5}
                            />
                        </div>

                        {/* Action Button */}
                        <button
                            onClick={handleReviewSubmit}
                            disabled={!mealStatus || reviewMutation.isPending}
                            className="flex w-full items-center justify-center gap-2 h-12 px-4 bg-[#17cf54] text-white rounded-lg text-base font-bold transition-colors hover:bg-[#17cf54]/90 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {reviewMutation.isPending ? (
                                <Loader2 className="w-5 h-5 animate-spin" />
                            ) : (
                                <>
                                    <span>Mark as Reviewed & Next</span>
                                    <ArrowRight className="w-5 h-5" />
                                </>
                            )}
                        </button>
                    </div>
                ) : (
                    <div className="flex items-center justify-center h-full text-gray-500">
                        Select a meal to review
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/components/modals/create-food-item-modal.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Modal } from '@/components/ui/modal';
import { useCreateFoodItem, useUpdateFoodItem, CreateFoodItemInput, FoodItem } from '@/lib/hooks/use-food-items';
import { Loader2, X } from 'lucide-react';
import { toast } from 'sonner';

interface CreateFoodItemModalProps {
    isOpen: boolean;
    onClose: () => void;
    initialData?: FoodItem;
}

const CATEGORIES = ['Grains', 'Proteins', 'Vegetables', 'Fruits', 'Dairy', 'Beverages', 'Snacks', 'Other'];

const COMMON_ALLERGENS = [
    'peanuts', 'tree_nuts', 'milk', 'eggs', 'wheat',
    'gluten', 'soy', 'fish', 'shellfish', 'sesame', 'lactose',
];

const ALLERGEN_LABELS: Record<string, string> = {
    peanuts: 'Peanuts',
    tree_nuts: 'Tree Nuts',
    milk: 'Milk/Dairy',
    eggs: 'Eggs',
    wheat: 'Wheat',
    gluten: 'Gluten',
    soy: 'Soy',
    fish: 'Fish',
    shellfish: 'Shellfish',
    sesame: 'Sesame',
    lactose: 'Lactose',
};

const DIETARY_CATEGORIES = [
    { value: '', label: 'Auto-detect' },
    { value: 'vegan', label: 'Vegan' },
    { value: 'vegetarian', label: 'Vegetarian' },
    { value: 'veg_with_egg', label: 'Eggetarian' },
    { value: 'non_veg', label: 'Non-Vegetarian' },
];

export function CreateFoodItemModal({ isOpen, onClose, initialData }: CreateFoodItemModalProps) {
    const createMutation = useCreateFoodItem();
    const updateMutation = useUpdateFoodItem();
    const isEditing = !!initialData;

    const [formData, setFormData] = useState<CreateFoodItemInput>({
        name: '',
        brand: '',
        category: 'Grains',
        servingSizeG: 100,
        calories: 0,
        proteinG: 0,
        carbsG: 0,
        fatsG: 0,
        fiberG: 0,
        sugarG: 0,
        sodiumMg: 0,
        dietaryTags: [],
        allergenFlags: []
    });

    // Populate form when initialData changes
    useEffect(() => {
        if (initialData) {
            setFormData({
                name: initialData.name,
                brand: initialData.brand || '',
                category: initialData.category,
                servingSizeG: parseFloat(initialData.servingSize) || 100,
                calories: initialData.nutrition.calories,
                proteinG: initialData.nutrition.proteinG || 0,
                carbsG: initialData.nutrition.carbsG || 0,
                fatsG: initialData.nutrition.fatsG || 0,
                fiberG: initialData.nutrition.fiberG || 0,
                sugarG: 0,
                sodiumMg: 0,
                dietaryTags: initialData.dietaryTags,
                allergenFlags: initialData.allergenFlags
            });
        } else {
            setFormData({
                name: '',
                brand: '',
                category: 'Grains',
                servingSizeG: 100,
                calories: 0,
                proteinG: 0,
                carbsG: 0,
                fatsG: 0,
                fiberG: 0,
                sugarG: 0,
                sodiumMg: 0,
                dietaryTags: [],
                allergenFlags: []
            });
        }
    }, [initialData, isOpen]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            if (isEditing && initialData) {
                await updateMutation.mutateAsync({ id: initialData.id, ...formData });
                toast.success('Food item updated successfully');
            } else {
                await createMutation.mutateAsync(formData);
                toast.success('Food item created successfully');
            }
            onClose();
        } catch {
            toast.error(isEditing ? 'Failed to update food item' : 'Failed to create food item');
        }
    };

    const updateField = (field: keyof CreateFoodItemInput, value: string) => {
        const numValue = parseFloat(value) || 0;
        setFormData(prev => ({
            ...prev,
            [field]: numValue
        }));
    };

    const toggleAllergen = (allergen: string) => {
        setFormData(prev => {
            const current = prev.allergenFlags || [];
            const has = current.includes(allergen);
            return {
                ...prev,
                allergenFlags: has
                    ? current.filter(a => a !== allergen)
                    : [...current, allergen]
            };
        });
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={isEditing ? "Edit Food Item" : "Add New Food Item"} size="lg">
            <form onSubmit={handleSubmit} className="space-y-5 p-1">
                <div className="grid grid-cols-2 gap-6">
                    <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                        <input
                            required
                            type="text"
                            value={formData.name}
                            onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                            className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#17cf54]/20 focus:border-[#17cf54] transition-all outline-none text-gray-900 placeholder:text-gray-400"
                            placeholder="e.g., Brown Rice"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Brand <span className="text-gray-400 font-normal">(Optional)</span></label>
                        <input
                            type="text"
                            value={formData.brand}
                            onChange={(e) => setFormData(prev => ({ ...prev, brand: e.target.value }))}
                            className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#17cf54]/20 focus:border-[#17cf54] transition-all outline-none text-gray-900 placeholder:text-gray-400"
                            placeholder="e.g., Nature's Best"
                        />
                    </div>
                </div>

                <div className="grid grid-cols-3 gap-6">
                    <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                        <div className="relative">
                            <select
                                value={formData.category}
                                onChange={(e) => setFormData(prev => ({ ...prev, category: e.target.value }))}
                                className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#17cf54]/20 focus:border-[#17cf54] transition-all outline-none text-gray-900 appearance-none cursor-pointer"
                            >
                                {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                            <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                &#x25BC;
                            </div>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Serving Size (g)</label>
                        <div className="relative">
                            <input
                                required
                                type="number"
                                min="1"
                                value={formData.servingSizeG}
                                onChange={(e) => updateField('servingSizeG', e.target.value)}
                                className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#17cf54]/20 focus:border-[#17cf54] transition-all outline-none text-gray-900 placeholder:text-gray-400"
                                placeholder="100"
                            />
                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm">g</span>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Dietary Type</label>
                        <div className="relative">
                            <select
                                value={formData.dietaryTags?.includes('vegan') ? 'vegan' :
                                    formData.dietaryTags?.includes('non_veg') ? 'non_veg' :
                                    formData.dietaryTags?.includes('veg_with_egg') ? 'veg_with_egg' :
                                    formData.dietaryTags?.includes('vegetarian') ? 'vegetarian' : ''}
                                onChange={(e) => {
                                    const val = e.target.value;
                                    setFormData(prev => ({
                                        ...prev,
                                        dietaryTags: val ? [val] : []
                                    }));
                                }}
                                className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#17cf54]/20 focus:border-[#17cf54] transition-all outline-none text-gray-900 appearance-none cursor-pointer"
                            >
                                {DIETARY_CATEGORIES.map(c => (
                                    <option key={c.value} value={c.value}>{c.label}</option>
                                ))}
                            </select>
                            <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                &#x25BC;
                            </div>
                        </div>
                    </div>
                </div>

                {/* Nutrition */}
                <div className="border border-gray-100 p-5 rounded-xl bg-gray-50/50">
                    <h4 className="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <span className="w-1 h-4 bg-[#17cf54] rounded-full"></span>
                        Nutrition per serving
                    </h4>
                    <div className="grid grid-cols-4 sm:grid-cols-7 gap-3">
                        {[
                            { label: 'Calories', field: 'calories' as const, unit: '' },
                            { label: 'Protein', field: 'proteinG' as const, unit: 'g' },
                            { label: 'Carbs', field: 'carbsG' as const, unit: 'g' },
                            { label: 'Fat', field: 'fatsG' as const, unit: 'g' },
                            { label: 'Fiber', field: 'fiberG' as const, unit: 'g' },
                            { label: 'Sugar', field: 'sugarG' as const, unit: 'g' },
                            { label: 'Sodium', field: 'sodiumMg' as const, unit: 'mg' },
                        ].map(({ label, field, unit }) => (
                            <div key={field} className="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                <label className="block text-[10px] font-semibold text-gray-500 mb-1 uppercase tracking-wide">{label}</label>
                                <div className="flex items-baseline gap-1">
                                    <input
                                        type="number"
                                        min="0"
                                        step={field === 'calories' ? '1' : '0.1'}
                                        value={(formData as unknown as Record<string, number>)[field] || 0}
                                        onChange={(e) => updateField(field, e.target.value)}
                                        className="w-full p-0 border-none focus:ring-0 text-base font-bold text-gray-900 placeholder:text-gray-300 bg-transparent"
                                        placeholder="0"
                                    />
                                    {unit && <span className="text-xs text-gray-400">{unit}</span>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Allergens */}
                <div className="border border-gray-100 p-5 rounded-xl bg-red-50/30">
                    <h4 className="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <span className="w-1 h-4 bg-red-400 rounded-full"></span>
                        Allergens
                        <span className="text-xs text-gray-400 font-normal ml-1">
                            (auto-detected from name + select manually)
                        </span>
                    </h4>
                    <div className="flex flex-wrap gap-2">
                        {COMMON_ALLERGENS.map(allergen => {
                            const isSelected = (formData.allergenFlags || []).includes(allergen);
                            return (
                                <button
                                    key={allergen}
                                    type="button"
                                    onClick={() => toggleAllergen(allergen)}
                                    className={`px-3 py-1.5 rounded-full text-xs font-medium transition-all ${
                                        isSelected
                                            ? 'bg-red-100 text-red-700 border border-red-300'
                                            : 'bg-white text-gray-600 border border-gray-200 hover:border-red-200 hover:text-red-600'
                                    }`}
                                >
                                    {isSelected && <X className="w-3 h-3 inline mr-1" />}
                                    {ALLERGEN_LABELS[allergen] || allergen}
                                </button>
                            );
                        })}
                    </div>
                </div>

                <div className="flex justify-end pt-4 gap-3 border-t border-gray-100 mt-6">
                    <button
                        type="button"
                        onClick={onClose}
                        className="px-5 py-2.5 text-sm font-semibold text-gray-700 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:text-gray-900 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        disabled={createMutation.isPending || updateMutation.isPending}
                        className="flex items-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-[#17cf54] hover:bg-[#17cf54]/90 rounded-xl shadow-lg shadow-green-500/20 transition-all disabled:opacity-50 disabled:shadow-none"
                    >
                        {(createMutation.isPending || updateMutation.isPending) && <Loader2 className="w-4 h-4 animate-spin" />}
                        {isEditing ? 'Update Food Item' : 'Create Food Item'}
                    </button>
                </div>
            </form>
        </Modal>
    );
}
</file>

<file path="frontend/src/lib/hooks/use-diet-plans.ts">
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useApiClient } from '../api/use-api-client';

// Types
export interface Meal {
    id: string;
    name: string;
    mealType: 'breakfast' | 'lunch' | 'dinner' | 'snack';
    scheduledTime: string;
    foodItems: MealFoodItem[];
}

export interface MealFoodItem {
    id: string;
    foodItem: {
        id: string;
        name: string;
        caloriesPer100g: number;
        proteinPer100g: number;
        carbsPer100g: number;
        fatsPer100g: number;
    };
    quantityG: number;
}

export interface DietPlan {
    id: string;
    clientId?: string; // Optional for templates
    name?: string; // Backend returns name
    title?: string; // Keep for backwards compatibility
    description?: string;
    startDate: string;
    endDate?: string;
    status?: string;
    isPublished?: boolean;
    isTemplate?: boolean;
    templateCategory?: string;
    publishedAt?: string;
    targetCalories?: number;
    targetProteinG?: number;
    targetCarbsG?: number;
    targetFatsG?: number;
    createdAt: string;
    updatedAt: string;
    client?: {
        id: string;
        fullName: string;
    };
    meals?: Meal[];
}

interface PaginatedResponse<T> {
    success: boolean;
    data: T[];
    meta: {
        page: number;
        pageSize: number;
        total: number;
        totalPages: number;
    };
}

interface DietPlansParams {
    page?: number;
    pageSize?: number;
    clientId?: string;
    isPublished?: boolean;
    isTemplate?: boolean;
}

export interface CreateDietPlanInput {
    clientId?: string; // Optional for templates
    title: string; // 'name' in backend schema mapped to 'title'
    description?: string;
    startDate: string;
    endDate?: string;
    targetCalories?: number;
    targetProteinG?: number;
    targetCarbsG?: number;
    targetFatsG?: number;
    notesForClient?: string;
    internalNotes?: string;
    meals?: {
        dayIndex?: number;
        mealDate?: string;
        mealType: string;
        timeOfDay?: string;
        title: string;
        description?: string;
        instructions?: string;
        foodItems?: {
            foodId: string;
            quantity: number;
            notes?: string;
            optionGroup?: number;
            optionLabel?: string;
        }[];
    }[];
    options?: {
        saveAsTemplate?: boolean;
        templateCategory?: string;
    };
}

// Hooks
export function useDietPlans(params: DietPlansParams = {}) {
    const api = useApiClient();
    const { page = 1, pageSize = 20, clientId, isPublished, isTemplate } = params;

    return useQuery({
        queryKey: ['diet-plans', page, pageSize, clientId, isPublished, isTemplate],
        queryFn: async () => {
            const { data } = await api.get<PaginatedResponse<DietPlan>>('/diet-plans', {
                params: { page, pageSize, clientId, isTemplate },
            });
            return data;
        },
    });
}

export function useDietPlan(id: string) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['diet-plans', id],
        queryFn: async () => {
            const { data } = await api.get(`/diet-plans/${id}`);
            return data.data as DietPlan;
        },
        enabled: !!id,
    });
}

export function useCreateDietPlan() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (planData: CreateDietPlanInput) => {
            // Map 'title' to 'name' as expected by backend
            const { title, ...rest } = planData;
            const payload = { ...rest, name: title };
            const { data } = await api.post('/diet-plans', payload);
            return data.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['diet-plans'] });
        },
    });
}

export function useUpdateDietPlan() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async ({ id, ...planData }: Partial<DietPlan> & { id: string }) => {
            const { data } = await api.patch(`/diet-plans/${id}`, planData);
            return data.data;
        },
        onSuccess: (_, variables) => {
            queryClient.invalidateQueries({ queryKey: ['diet-plans'] });
            queryClient.invalidateQueries({ queryKey: ['diet-plans', variables.id] });
        },
    });
}

export function usePublishDietPlan() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (id: string) => {
            const { data } = await api.post(`/diet-plans/${id}/publish`);
            return data.data;
        },
        onSuccess: (_, id) => {
            queryClient.invalidateQueries({ queryKey: ['diet-plans'] });
            queryClient.invalidateQueries({ queryKey: ['diet-plans', id] });
        },
    });
}

interface AssignTemplateInput {
    templateId: string;
    clientId: string;
    startDate: string;
    name?: string;
}

export function useAssignTemplate() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async ({ templateId, clientId, startDate, name }: AssignTemplateInput) => {
            const { data } = await api.post(`/diet-plans/${templateId}/assign`, {
                clientId,
                startDate,
                name,
            });
            return data.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['diet-plans'] });
        },
    });
}
</file>

<file path="backend/prisma/schema.prisma">
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  free
  pro
  clinic
  enterprise
}

enum SubscriptionStatus {
  active
  paused
  cancelled
}

enum UserRole {
  owner
  admin
  dietitian
}

enum Gender {
  male
  female
  other
}

enum ActivityLevel {
  sedentary
  lightly_active
  moderately_active
  very_active
}

enum DietPlanStatus {
  draft
  active
  completed
  paused
}

enum DietPlanVisibility {
  private
  org_shared
  public
}

enum MealType {
  breakfast
  lunch
  snack
  dinner
}

enum MealLogStatus {
  pending
  eaten
  skipped
  substituted
}

enum NoteType {
  SOAP
  DAP
  other
}

enum RecipientType {
  user
  client
}

enum DeliveryStatus {
  pending
  delivered
  failed
}

enum InvoiceStatus {
  unpaid
  sent
  paid
  cancelled
}

enum ReferralSource {
  doctor
  dietitian
  client_referral
  social_media
  website
  other
}

// ============ MODELS ============

model Organization {
  id                    String             @id @default(uuid())
  name                  String             @unique
  description           String?
  logoUrl               String?
  phone                 String?
  email                 String?
  address               String?
  city                  String?
  country               String             @default("IN")
  timezone              String             @default("Asia/Kolkata")
  subscriptionTier      SubscriptionTier   @default(free)
  subscriptionStatus    SubscriptionStatus @default(active)
  subscriptionExpiresAt DateTime?
  maxClients            Int                @default(10)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  deletedAt             DateTime?
  isActive              Boolean            @default(true)

  // Relations
  users            User[]
  clients          Client[]
  dietPlans        DietPlan[]
  foodItems        FoodItem[]
  mealLogs         MealLog[]
  weightLogs       WeightLog[]
  bodyMeasurements BodyMeasurement[]
  sessionNotes     SessionNote[]
  notifications    Notification[]
  activityLogs     ActivityLog[]
  invoices         Invoice[]
  invitations      Invitation[]
  clientReports    ClientReport[]

  @@index([subscriptionStatus])
  @@index([isActive])
}

model User {
  id              String    @id @default(uuid())
  orgId           String
  clerkUserId     String?   @unique
  role            UserRole
  email           String
  fullName        String
  phone           String?
  profilePhotoUrl String?
  licenseNumber   String?
  specialization  String?
  bio             String?
  mfaEnabled      Boolean   @default(false)
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  isActive        Boolean   @default(true)

  // Relations
  organization        Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  clientsPrimary      Client[]      @relation("PrimaryDietitian")
  createdDietPlans    DietPlan[]    @relation("DietPlanCreator")
  createdFoodItems    FoodItem[]    @relation("FoodItemCreator")
  reviewedMealLogs    MealLog[]     @relation("MealLogReviewer")
  createdSessionNotes SessionNote[] @relation("SessionNoteCreator")
  createdInvoices     Invoice[]     @relation("InvoiceCreator")
  activityLogs        ActivityLog[] @relation("UserActivityLog")

  pushTokens String[] @default([]) // Expo push tokens

  @@unique([orgId, email])
  @@index([orgId])
  @@index([clerkUserId])
  @@index([role])
}

model Client {
  id                    String         @id @default(uuid())
  orgId                 String
  primaryDietitianId    String
  email                 String
  phone                 String
  fullName              String
  dateOfBirth           DateTime?      @db.Date
  gender                Gender?
  profilePhotoUrl       String?
  heightCm              Decimal?       @db.Decimal(5, 2)
  currentWeightKg       Decimal?       @db.Decimal(5, 2)
  targetWeightKg        Decimal?       @db.Decimal(5, 2)
  targetCalories        Int?
  targetProteinG        Decimal?       @db.Decimal(5, 1)
  targetCarbsG          Decimal?       @db.Decimal(5, 1)
  targetFatsG           Decimal?       @db.Decimal(5, 1)
  activityLevel         ActivityLevel?
  dietaryPreferences    String[]
  allergies             String[]
  medicalConditions     String[]
  medications           String[]
  healthNotes           String?
  emergencyContactName  String?
  emergencyContactPhone String?
  onboardingCompleted   Boolean        @default(false)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  deletedAt             DateTime?
  createdByUserId       String?
  isActive              Boolean        @default(true)

  // Validation Tags (for diet validation engine)
  intolerances      String[] @default([]) // Separate from allergies (e.g., lactose)
  dietPattern       String? // "vegetarian", "vegan", "non_veg", "pescatarian"
  eggAllowed        Boolean  @default(true)
  eggAvoidDays      String[] @default([]) // ["tuesday", "thursday"]
  dislikes          String[] @default([]) // Food names client dislikes
  avoidCategories   String[] @default([]) // ["fried_foods", "processed"]
  labDerivedTags    String[] @default([]) // ["vitamin_d_deficiency", "high_cholesterol"]
  likedFoods        String[] @default([]) // Food IDs client likes
  preferredCuisines String[] @default([]) // ["indian", "mughlai"]
  foodRestrictions  Json     @default("[]") // Array of FoodRestriction objects for flexible restrictions

  // Referral tracking
  referralSource      ReferralSource?
  referralSourceName  String? // Doctor/Dietitian name if applicable
  referralSourcePhone String? // Contact phone for referrer
  referralCode        String?         @unique
  referredByClientId  String?

  // Relations
  organization     Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  primaryDietitian User              @relation("PrimaryDietitian", fields: [primaryDietitianId], references: [id])
  medicalProfile   MedicalProfile?
  dietPlans        DietPlan[]
  mealLogs         MealLog[]
  weightLogs       WeightLog[]
  bodyMeasurements BodyMeasurement[]
  sessionNotes     SessionNote[]
  invoices         Invoice[]
  referralBenefit  ReferralBenefit?
  clientReports    ClientReport[]
  preferences      ClientPreferences?

  // Self-referential relation for client referrals
  referredByClient Client?  @relation("ClientReferrals", fields: [referredByClientId], references: [id])
  referredClients  Client[] @relation("ClientReferrals")

  pushTokens String[] @default([]) // Expo push tokens

  @@unique([orgId, email])
  @@index([orgId])
  @@index([primaryDietitianId])
  @@index([isActive])
  @@index([referralCode])
  @@index([referredByClientId])
  @@index([orgId, isActive, createdAt])
}

model MedicalProfile {
  id                  String   @id @default(uuid())
  clientId            String   @unique
  diagnoses           String[]
  allergies           String[]
  intolerances        String[]
  medications         String[]
  supplements         String[]
  surgeries           String[]
  familyHistory       String?
  healthNotes         String?
  dietaryRestrictions String?
  labValues           Json?
  labDate             DateTime?
  labDerivedTags      String[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  updatedByUserId     String?

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model DietPlan {
  id               String             @id @default(uuid())
  orgId            String
  clientId         String? // Optional for templates
  createdByUserId  String
  name             String
  description      String?
  startDate        DateTime           @db.Date
  endDate          DateTime?          @db.Date
  targetCalories   Int?
  targetProteinG   Decimal?           @db.Decimal(5, 1)
  targetCarbsG     Decimal?           @db.Decimal(5, 1)
  targetFatsG      Decimal?           @db.Decimal(5, 1)
  targetFiberG     Decimal?           @db.Decimal(5, 1)
  notesForClient   String?
  internalNotes    String?
  status           DietPlanStatus     @default(draft)
  isTemplate       Boolean            @default(false)
  templateCategory String?
  visibility       DietPlanVisibility @default(private)
  publishedAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  deletedAt        DateTime?
  isActive         Boolean            @default(true)

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client?      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  creator      User         @relation("DietPlanCreator", fields: [createdByUserId], references: [id])
  meals        Meal[]

  @@index([orgId])
  @@index([clientId])
  @@index([status])
  @@index([isTemplate])
  @@index([orgId, status, createdAt])
  @@index([clientId, status])
}

model Meal {
  id               String    @id @default(uuid())
  planId           String
  dayOfWeek        Int?
  mealDate         DateTime? @db.Date
  sequenceNumber   Int?
  mealType         MealType
  timeOfDay        String?
  name             String
  description      String?
  instructions     String?
  servingSizeNotes String?
  totalCalories    Int?
  totalProteinG    Decimal?  @db.Decimal(5, 1)
  totalCarbsG      Decimal?  @db.Decimal(5, 1)
  totalFatsG       Decimal?  @db.Decimal(5, 1)
  totalFiberG      Decimal?  @db.Decimal(5, 1)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  createdByUserId  String?

  // Relations
  dietPlan  DietPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  foodItems MealFoodItem[]
  mealLogs  MealLog[]

  @@index([planId])
  @@index([mealDate])
}

model FoodItem {
  id              String   @id @default(uuid())
  orgId           String?
  name            String
  brand           String?
  category        String
  subCategory     String?
  servingSizeG    Decimal  @default(100) @db.Decimal(6, 2)
  calories        Int
  proteinG        Decimal? @db.Decimal(5, 1)
  carbsG          Decimal? @db.Decimal(5, 1)
  fatsG           Decimal? @db.Decimal(5, 1)
  fiberG          Decimal? @db.Decimal(5, 1)
  sodiumMg        Decimal? @db.Decimal(7, 2)
  sugarG          Decimal? @db.Decimal(5, 1)
  isVerified      Boolean  @default(false)
  source          String?
  barcode         String?
  allergenFlags   String[]
  dietaryTags     String[]
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  updatedByUserId String?

  // Validation Tags (for diet validation engine)
  nutritionTags       String[] @default([]) // ["high_protein", "low_carb", "high_sugar"]
  healthFlags         String[] @default([]) // ["diabetic_caution", "heart_caution"]
  cuisineTags         String[] @default([]) // ["indian", "chinese", "mughlai"]
  processingLevel     String? // "raw", "minimally_processed", "processed", "ultra_processed"
  mealSuitabilityTags String[] @default([]) // ["good_for_breakfast", "too_heavy_for_night"]
  dietaryCategory     String? // "vegan", "vegetarian", "veg_with_egg", "non_veg"

  // Relations
  organization  Organization?  @relation(fields: [orgId], references: [id], onDelete: SetNull)
  creator       User?          @relation("FoodItemCreator", fields: [createdByUserId], references: [id])
  mealFoodItems MealFoodItem[]

  @@index([orgId])
  @@index([category])
  @@index([orgId, category])
}

model MealFoodItem {
  id        String   @id @default(uuid())
  mealId    String
  foodId    String
  quantityG Decimal  @db.Decimal(6, 2)
  calories  Int?
  proteinG  Decimal? @db.Decimal(5, 1)
  carbsG    Decimal? @db.Decimal(5, 1)
  fatsG     Decimal? @db.Decimal(5, 1)
  fiberG    Decimal? @db.Decimal(5, 1)
  sortOrder Int      @default(0)
  notes           String?
  optionGroup     Int      @default(0) // 0 = default, 1+ = alternative meal options
  optionLabel     String?              // e.g. "Oatmeal Bowl", "Egg Plate"
  createdAt       DateTime @default(now())
  deletedAt       DateTime?
  createdByUserId String?

  // Relations
  meal     Meal     @relation(fields: [mealId], references: [id], onDelete: Cascade)
  foodItem FoodItem @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([mealId])
  @@index([foodId])
  @@index([mealId, optionGroup])
}

model MealLog {
  id                    String        @id @default(uuid())
  orgId                 String
  clientId              String
  mealId                String
  scheduledDate         DateTime      @db.Date
  scheduledTime         String?
  status                MealLogStatus @default(pending)
  mealPhotoUrl          String?
  mealPhotoSmallUrl     String?
  photoUploadedAt       DateTime?
  aiFoodRecognition     Json?
  clientNotes           String?
  dietitianFeedback     String?
  dietitianFeedbackAt   DateTime?
  reviewedByUserId      String?
  substituteDescription String?
  substituteCaloriesEst Int?
  loggedAt              DateTime?

  // Option tracking (for meals with alternatives)
  chosenOptionGroup Int? // which option the client chose (null = default option 0)

  // Compliance Tracking
  complianceScore  Int? // 0-100
  complianceColor  String? // GREEN, YELLOW, RED
  complianceIssues String[] @default([]) // ["portion_exceeded", "forbidden_food"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  meal         Meal         @relation(fields: [mealId], references: [id], onDelete: Cascade)
  reviewer     User?        @relation("MealLogReviewer", fields: [reviewedByUserId], references: [id])

  @@unique([clientId, mealId, scheduledDate])
  @@index([orgId])
  @@index([clientId])
  @@index([scheduledDate])
  @@index([status])
  @@index([orgId, status, scheduledDate])
  @@index([clientId, scheduledDate])
}

model WeightLog {
  id                       String   @id @default(uuid())
  orgId                    String
  clientId                 String
  weightKg                 Decimal  @db.Decimal(5, 2)
  logDate                  DateTime @db.Date
  logTime                  String?
  notes                    String?
  progressPhotoUrl         String?
  bmi                      Decimal? @db.Decimal(4, 2)
  weightChangeFromPrevious Decimal? @db.Decimal(5, 2)
  isOutlier                Boolean  @default(false)
  createdAt                DateTime @default(now())
  deletedAt                DateTime?
  createdByUserId          String?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, logDate])
  @@index([orgId])
  @@index([clientId])
  @@index([clientId, logDate])
}

model BodyMeasurement {
  id                String   @id @default(uuid())
  orgId             String
  clientId          String
  logDate           DateTime @db.Date
  chestCm           Decimal? @db.Decimal(5, 2)
  waistCm           Decimal? @db.Decimal(5, 2)
  hipsCm            Decimal? @db.Decimal(5, 2)
  thighsCm          Decimal? @db.Decimal(5, 2)
  armsCm            Decimal? @db.Decimal(5, 2)
  bodyFatPercentage Decimal? @db.Decimal(4, 2)
  notes             String?
  createdAt         DateTime @default(now())
  deletedAt         DateTime?
  createdByUserId   String?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([clientId])
}

model SessionNote {
  id              String    @id @default(uuid())
  orgId           String
  clientId        String
  createdByUserId String
  noteType        NoteType
  title           String
  subjective      String?
  objective       String?
  assessment      String?
  plan            String?
  internalNotes   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  creator      User         @relation("SessionNoteCreator", fields: [createdByUserId], references: [id])

  @@index([orgId])
  @@index([clientId])
}

model Notification {
  id                String         @id @default(uuid())
  recipientId       String
  recipientType     RecipientType
  orgId             String
  type              String
  category          String?
  title             String
  message           String
  icon              String?
  deepLink          String?
  relatedEntityType String?
  relatedEntityId   String?
  isRead            Boolean        @default(false)
  readAt            DateTime?
  sentViaChannels   String[]       @default(["push"])
  deliveryStatus    DeliveryStatus @default(pending)
  createdAt         DateTime       @default(now())
  expiresAt         DateTime       @default(dbgenerated("NOW() + INTERVAL '30 days'"))

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([recipientId, recipientType])
  @@index([isRead])
  @@index([orgId])
  @@index([recipientId, recipientType, isRead, createdAt])
}

model ActivityLog {
  id           String   @id @default(uuid())
  orgId        String
  userId       String?
  userType     String?
  action       String
  entityType   String?
  entityId     String?
  oldValues    Json?
  newValues    Json?
  changeDesc   String?
  ipAddress    String?
  userAgent    String?
  status       String   @default("success")
  errorMessage String?
  metadata     Json?
  createdAt    DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User?        @relation("UserActivityLog", fields: [userId], references: [id])

  @@index([orgId])
  @@index([userId])
  @@index([action])
}

model Invoice {
  id              String        @id @default(uuid())
  orgId           String
  clientId        String
  createdByUserId String
  invoiceNumber   String        @unique
  issueDate       DateTime      @db.Date
  dueDate         DateTime      @db.Date
  currency        String        @default("INR")
  subtotal        Decimal       @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  status          InvoiceStatus @default(unpaid)
  notes           String?
  sentAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  creator      User         @relation("InvoiceCreator", fields: [createdByUserId], references: [id])

  @@index([orgId])
  @@index([clientId])
  @@index([status])
}

model Invitation {
  id        String   @id @default(uuid())
  email     String
  role      UserRole
  token     String   @unique
  orgId     String
  expiresAt DateTime
  status    String   @default("pending") // pending, accepted, expired
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([token])
  @@index([email])
}

model ReferralBenefit {
  id               String   @id @default(uuid())
  clientId         String   @unique
  referralCount    Int      @default(0)
  freeMonthsEarned Int      @default(0)
  freeMonthsUsed   Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model ClientReport {
  id         String   @id @default(uuid())
  orgId      String
  clientId   String
  fileName   String
  fileUrl    String
  fileType   String // pdf, image
  reportType String? // blood_test, scan, prescription, other
  notes      String?
  uploadedAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([orgId])
}

model ClientPreferences {
  id               String   @id @default(uuid())
  clientId         String   @unique
  breakfastTime    String?
  lunchTime        String?
  dinnerTime       String?
  snackTime        String?
  canCook          Boolean  @default(true)
  kitchenAvailable Boolean  @default(true)
  hasDietaryCook   Boolean  @default(false)
  weekdayActivity  String?
  weekendActivity  String?
  sportOrHobby     String?
  generalNotes     String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}
</file>

<file path="backend/src/controllers/client.controller.ts">
import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { clientService } from '../services/client.service';

export const createClient = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const client = await clientService.createClient(req.body, req.user.organizationId, req.user.id);
    res.status(201).json({ success: true, data: client });
});

export const getClient = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const client = await clientService.getClient(req.params.id, req.user.organizationId);
    res.status(200).json({ success: true, data: client });
});

export const listClients = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const { clients, meta } = await clientService.listClients(req.user.organizationId, req.query, req.user.role, req.user.id);
    res.status(200).json({ success: true, data: clients, meta });
});

export const updateClient = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const client = await clientService.updateClient(req.params.id, req.body, req.user.organizationId);
    res.status(200).json({ success: true, data: client });
});

export const deleteClient = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    await clientService.deleteClient(req.params.id, req.user.organizationId);
    res.status(204).send();
});

export const getClientProgress = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const data = await clientService.getClientProgress(req.params.id, req.user.organizationId, req.query);
    res.status(200).json({ success: true, data });
});
</file>

<file path="backend/src/controllers/foodItem.controller.ts">
import { Response } from 'express';
import { AuthenticatedRequest } from '../types/auth.types';
import { AppError } from '../errors/AppError';
import { asyncHandler } from '../utils/asyncHandler';
import { foodItemService } from '../services/foodItem.service';
import { foodTaggingService } from '../services/foodTagging.service';
import logger from '../utils/logger';

export const createFoodItem = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const foodItem = await foodItemService.createFoodItem(req.body, req.user.organizationId, req.user.id);

    // Auto-tag in background (merges with any manually provided allergens)
    foodTaggingService.autoTagFood(foodItem.id).catch(err =>
        logger.warn('Auto-tag failed for new food', { foodId: foodItem.id, error: err.message })
    );

    res.status(201).json({
        success: true,
        data: {
            id: foodItem.id,
            organizationId: foodItem.orgId,
            name: foodItem.name,
            brand: foodItem.brand,
            category: foodItem.category,
            subCategory: foodItem.subCategory,
            servingSize: `${foodItem.servingSizeG} g`,
            isGlobal: foodItem.orgId === null,
            isVerified: foodItem.isVerified,
            nutrition: {
                calories: foodItem.calories,
                proteinG: foodItem.proteinG ? Number(foodItem.proteinG) : null,
                carbsG: foodItem.carbsG ? Number(foodItem.carbsG) : null,
                fatsG: foodItem.fatsG ? Number(foodItem.fatsG) : null,
                fiberG: foodItem.fiberG ? Number(foodItem.fiberG) : null,
                sodiumMg: foodItem.sodiumMg ? Number(foodItem.sodiumMg) : null,
                sugarG: foodItem.sugarG ? Number(foodItem.sugarG) : null,
            },
            allergenFlags: foodItem.allergenFlags,
            dietaryTags: foodItem.dietaryTags,
            barcode: foodItem.barcode,
            createdByUserId: foodItem.createdByUserId,
            createdAt: foodItem.createdAt,
        },
    });
});

export const listFoodItems = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const { foodItems, meta } = await foodItemService.listFoodItems(req.user.organizationId, req.query);

    res.status(200).json({
        success: true,
        data: foodItems.map((item) => ({
            id: item.id,
            name: item.name,
            brand: item.brand,
            category: item.category,
            subCategory: item.subCategory,
            servingSize: `${item.servingSizeG} g`,
            isGlobal: item.orgId === null,
            isVerified: item.isVerified,
            nutrition: {
                calories: item.calories,
                proteinG: item.proteinG ? Number(item.proteinG) : null,
                carbsG: item.carbsG ? Number(item.carbsG) : null,
                fatsG: item.fatsG ? Number(item.fatsG) : null,
                fiberG: item.fiberG ? Number(item.fiberG) : null,
            },
            allergenFlags: item.allergenFlags,
            dietaryTags: item.dietaryTags,
            barcode: item.barcode,
            createdBy: item.creator,
        })),
        meta,
    });
});

export const getFoodItem = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const foodItem = await foodItemService.getFoodItem(req.params.id, req.user.organizationId);

    res.status(200).json({
        success: true,
        data: {
            id: foodItem.id,
            organizationId: foodItem.orgId,
            name: foodItem.name,
            brand: foodItem.brand,
            category: foodItem.category,
            subCategory: foodItem.subCategory,
            servingSize: `${foodItem.servingSizeG} g`,
            servingSizeG: Number(foodItem.servingSizeG),
            isGlobal: foodItem.orgId === null,
            isVerified: foodItem.isVerified,
            nutrition: {
                calories: foodItem.calories,
                proteinG: foodItem.proteinG ? Number(foodItem.proteinG) : null,
                carbsG: foodItem.carbsG ? Number(foodItem.carbsG) : null,
                fatsG: foodItem.fatsG ? Number(foodItem.fatsG) : null,
                fiberG: foodItem.fiberG ? Number(foodItem.fiberG) : null,
                sodiumMg: foodItem.sodiumMg ? Number(foodItem.sodiumMg) : null,
                sugarG: foodItem.sugarG ? Number(foodItem.sugarG) : null,
            },
            allergenFlags: foodItem.allergenFlags,
            dietaryTags: foodItem.dietaryTags,
            barcode: foodItem.barcode,
            source: foodItem.source,
            createdBy: foodItem.creator,
            createdAt: foodItem.createdAt,
            updatedAt: foodItem.updatedAt,
        },
    });
});

export const updateFoodItem = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const updated = await foodItemService.updateFoodItem(req.params.id, req.body, req.user.organizationId);

    // Re-tag in background (name or nutrition may have changed)
    foodTaggingService.autoTagFood(updated.id).catch(err =>
        logger.warn('Auto-tag failed for updated food', { foodId: updated.id, error: err.message })
    );

    res.status(200).json({
        success: true,
        data: { id: updated.id, name: updated.name, category: updated.category, updatedAt: updated.updatedAt },
    });
});

export const deleteFoodItem = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    await foodItemService.deleteFoodItem(req.params.id, req.user.organizationId);
    res.status(204).send();
});

export const addFoodToMeal = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const mealFoodItem = await foodItemService.addFoodToMeal(req.params.mealId, req.body, req.user.organizationId);

    res.status(201).json({
        success: true,
        data: {
            id: mealFoodItem.id,
            mealId: mealFoodItem.mealId,
            foodId: mealFoodItem.foodId,
            foodName: mealFoodItem.foodItem.name,
            quantity: Number(mealFoodItem.quantityG),
            unit: 'g',
            nutrition: {
                calories: mealFoodItem.calories,
                proteinG: mealFoodItem.proteinG ? Math.round(Number(mealFoodItem.proteinG) * 10) / 10 : null,
                carbsG: mealFoodItem.carbsG ? Math.round(Number(mealFoodItem.carbsG) * 10) / 10 : null,
                fatsG: mealFoodItem.fatsG ? Math.round(Number(mealFoodItem.fatsG) * 10) / 10 : null,
                fiberG: mealFoodItem.fiberG ? Math.round(Number(mealFoodItem.fiberG) * 10) / 10 : null,
            },
            notes: mealFoodItem.notes,
            sortOrder: mealFoodItem.sortOrder,
        },
    });
});

export const updateMealFoodItem = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    const updated = await foodItemService.updateMealFoodItem(req.params.mealId, req.params.itemId, req.body, req.user.organizationId);

    res.status(200).json({
        success: true,
        data: {
            id: updated.id,
            foodName: updated.foodItem.name,
            quantity: Number(updated.quantityG),
            nutrition: {
                calories: updated.calories,
                proteinG: updated.proteinG ? Math.round(Number(updated.proteinG) * 10) / 10 : null,
            },
        },
    });
});

export const removeFoodFromMeal = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    await foodItemService.removeFoodFromMeal(req.params.mealId, req.params.itemId, req.user.organizationId);
    res.status(204).send();
});

// ============ TAGGING ENDPOINTS ============

export const updateFoodTags = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    await foodItemService.getFoodItem(req.params.id, req.user.organizationId);

    const updated = await foodTaggingService.updateFoodTags(req.params.id, req.body);

    res.status(200).json({
        success: true,
        data: {
            id: updated.id,
            name: updated.name,
            dietaryCategory: updated.dietaryCategory,
            allergenFlags: updated.allergenFlags,
            nutritionTags: updated.nutritionTags,
            healthFlags: updated.healthFlags,
            cuisineTags: updated.cuisineTags,
            processingLevel: updated.processingLevel,
            mealSuitabilityTags: updated.mealSuitabilityTags,
        },
    });
});

export const autoTagFood = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();
    await foodItemService.getFoodItem(req.params.id, req.user.organizationId);

    const updated = await foodTaggingService.autoTagFood(req.params.id);

    res.status(200).json({
        success: true,
        message: 'Food item auto-tagged successfully',
        data: {
            id: updated.id,
            name: updated.name,
            dietaryCategory: updated.dietaryCategory,
            allergenFlags: updated.allergenFlags,
            nutritionTags: updated.nutritionTags,
            healthFlags: updated.healthFlags,
        },
    });
});

export const bulkAutoTagFoods = asyncHandler(async (req: AuthenticatedRequest, res: Response) => {
    if (!req.user) throw AppError.unauthorized();

    const { limit = 100, includeGlobal = false } = req.body;
    const options: { orgId?: string; limit?: number } = { limit };
    if (!includeGlobal) options.orgId = req.user.organizationId;

    const result = await foodTaggingService.bulkAutoTag(options);

    res.status(200).json({
        success: true,
        message: `Processed ${result.processed} food items, updated ${result.updated}`,
        data: result,
    });
});
</file>

<file path="client-app/package.json">
{
  "name": "dietconnect-client",
  "version": "1.0.0",
  "main": "expo-router/entry",
  "scripts": {
    "start": "expo start",
    "android": "expo start --android",
    "ios": "expo start --ios",
    "web": "expo start --web"
  },
  "dependencies": {
    "@expo/metro-runtime": "^6.1.2",
    "@react-native-community/netinfo": "11.4.1",
    "@react-native-picker/picker": "2.11.1",
    "@tanstack/react-query": "^5.90.12",
    "axios": "^1.13.2",
    "expo": "~54.0.33",
    "expo-camera": "^17.0.10",
    "expo-constants": "~18.0.13",
    "expo-document-picker": "^14.0.8",
    "expo-image-picker": "^17.0.10",
    "expo-linking": "~8.0.11",
    "expo-router": "~6.0.23",
    "expo-secure-store": "^15.0.8",
    "expo-splash-screen": "~31.0.13",
    "expo-status-bar": "~3.0.9",
    "lucide-react-native": "^0.562.0",
    "react": "19.1.0",
    "react-native": "0.81.5",
    "react-native-chart-kit": "^6.12.0",
    "react-native-gesture-handler": "~2.28.0",
    "react-native-safe-area-context": "^5.6.2",
    "react-native-screens": "~4.16.0",
    "react-native-svg": "15.12.1",
    "react-native-web": "^0.21.2"
  },
  "devDependencies": {
    "@types/react": "~19.1.0",
    "typescript": "~5.9.2"
  },
  "private": true
}
</file>

<file path="frontend/src/components/modals/add-food-modal.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Modal } from '@/components/ui/modal';
import { Search, Plus, Loader2, AlertTriangle, Ban, Heart, Check, Info } from 'lucide-react';
import { useFoodItems, FoodItem as ApiFoodItem } from '@/lib/hooks/use-food-items';
import { CreateFoodItemModal } from './create-food-item-modal';
import { useValidation, ValidationResult, ValidationSeverity } from '@/lib/hooks/use-validation';

interface AddFoodModalProps {
    isOpen: boolean;
    onClose: () => void;
    mealType?: string;
    optionLabel?: string;
    clientId?: string | null;
    currentDay?: string;
    onAddFood?: (food: LocalFoodItem) => void;
}

// Local interface for the callback, aligning with what the builder expects
interface LocalFoodItem {
    id: string;
    name: string;
    type: 'food' | 'meal' | 'template';
    calories: number;
    protein: number;
    carbs: number;
    fat: number;
    description?: string;
    // Validation data
    validationSeverity?: ValidationSeverity;
    validationAlerts?: Array<{ type: string; severity: string; message: string; recommendation?: string }>;
    canAdd?: boolean;
}

const typeColors = {
    food: 'text-purple-600 bg-purple-100',
    meal: 'text-blue-600 bg-blue-100',
    template: 'text-[#17cf54] bg-[#17cf54]/10',
};

// Get day name from date
const getDayName = (date?: Date): string => {
    const d = date || new Date();
    return d.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
};

// Map meal type string to proper type
const normalizeMealType = (mealType: string): 'breakfast' | 'lunch' | 'snack' | 'dinner' => {
    const lower = mealType.toLowerCase();
    if (lower.includes('breakfast')) return 'breakfast';
    if (lower.includes('lunch')) return 'lunch';
    if (lower.includes('dinner')) return 'dinner';
    return 'snack';
};

export function AddFoodModal({
    isOpen,
    onClose,
    mealType = 'Breakfast',
    optionLabel,
    clientId = null,
    currentDay,
    onAddFood
}: AddFoodModalProps) {
    const [search, setSearch] = useState('');
    const [debouncedSearch, setDebouncedSearch] = useState('');
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [selectedAlert, setSelectedAlert] = useState<ValidationResult | null>(null);

    // Validation hook
    const {
        validateFoods,
        getValidation,
        getBorderClass,
        isValidating,
        clearCache
    } = useValidation(clientId);

    // Debounce search
    useEffect(() => {
        const timer = setTimeout(() => {
            setDebouncedSearch(search);
        }, 500);
        return () => clearTimeout(timer);
    }, [search]);

    // Clear cache when client changes
    useEffect(() => {
        clearCache();
    }, [clientId, clearCache]);

    const { data, isLoading } = useFoodItems({
        q: debouncedSearch,
        pageSize: 20
    });

    const foodItems = data?.data || [];

    // Validate foods when search results change
    useEffect(() => {
        if (foodItems.length > 0 && clientId) {
            const foodIds = foodItems.map((f: ApiFoodItem) => f.id);
            const day = currentDay || getDayName();
            validateFoods(foodIds, {
                currentDay: day,
                mealType: normalizeMealType(mealType)
            });
        }
    }, [foodItems, clientId, currentDay, mealType, validateFoods]);

    // Get validation icon
    const getValidationIcon = (validation: ValidationResult | undefined) => {
        if (!validation) return null;

        switch (validation.severity) {
            case 'RED':
                return <Ban className="w-4 h-4 text-red-500" />;
            case 'YELLOW':
                return <AlertTriangle className="w-4 h-4 text-yellow-500" />;
            case 'GREEN':
                if (validation.alerts.some(a => a.type === 'preference_match' || a.type === 'cuisine_match')) {
                    return <Heart className="w-4 h-4 text-green-500" />;
                }
                return <Check className="w-4 h-4 text-green-500" />;
            default:
                return null;
        }
    };

    const handleFoodClick = (food: ApiFoodItem) => {
        const validation = getValidation(food.id);

        // If RED severity, show alert instead of adding
        if (validation?.severity === 'RED') {
            setSelectedAlert(validation);
            return;
        }

        onAddFood?.({
            id: food.id,
            name: food.name,
            type: 'food',
            calories: food.nutrition.calories,
            protein: food.nutrition.proteinG || 0,
            carbs: food.nutrition.carbsG || 0,
            fat: food.nutrition.fatsG || 0,
            description: `${food.servingSize} • ${food.nutrition.calories} kcal`,
            validationSeverity: validation?.severity,
            validationAlerts: validation?.alerts.map(a => ({
                type: a.type,
                severity: a.severity,
                message: a.message,
                recommendation: a.recommendation,
            })),
            canAdd: validation?.canAdd ?? true
        });
    };

    return (
        <>
            <Modal isOpen={isOpen} onClose={onClose} title={optionLabel ? `Add to ${mealType} > ${optionLabel}` : `Add to ${mealType}`} size="xl">
                {/* Search and Actions */}
                <div className="p-4 border-b border-gray-100 flex gap-4">
                    <div className="relative flex-grow">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                        <input
                            type="text"
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                            className="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 rounded-lg bg-gray-50 focus:ring-[#17cf54] focus:border-[#17cf54] text-gray-900"
                            placeholder="Search food database..."
                            autoFocus
                        />
                    </div>
                    <button
                        onClick={() => setShowCreateModal(true)}
                        className="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex-shrink-0"
                    >
                        <Plus className="w-4 h-4" />
                        Create New
                    </button>
                </div>

                {/* Validation Legend (only show if client is selected) */}
                {clientId && foodItems.length > 0 && (
                    <div className="px-4 py-2 bg-gray-50 border-b border-gray-100 flex items-center gap-4 text-xs">
                        <span className="text-gray-500">Validation:</span>
                        <span className="flex items-center gap-1">
                            <span className="w-3 h-3 rounded-full bg-red-500"></span>
                            <span className="text-gray-600">Blocked</span>
                        </span>
                        <span className="flex items-center gap-1">
                            <span className="w-3 h-3 rounded-full bg-yellow-500"></span>
                            <span className="text-gray-600">Caution</span>
                        </span>
                        <span className="flex items-center gap-1">
                            <span className="w-3 h-3 rounded-full bg-green-500"></span>
                            <span className="text-gray-600">Good Match</span>
                        </span>
                        {isValidating && (
                            <Loader2 className="w-3 h-3 animate-spin text-gray-400 ml-auto" />
                        )}
                    </div>
                )}

                {/* Food Grid */}
                <div className="p-4 max-h-[400px] overflow-y-auto">
                    {isLoading ? (
                        <div className="flex justify-center py-8">
                            <Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" />
                        </div>
                    ) : foodItems.length === 0 ? (
                        <div className="text-center py-8 text-gray-500">
                            {search ? (
                                <div className="space-y-2">
                                    <p>No foods found matching &quot;{search}&quot;.</p>
                                    <button
                                        onClick={() => setShowCreateModal(true)}
                                        className="text-[#17cf54] font-medium hover:underline"
                                    >
                                        Create a new food item
                                    </button>
                                </div>
                            ) : (
                                'Start typing to search foods.'
                            )}
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {foodItems.map((food: ApiFoodItem) => {
                                const validation = clientId ? getValidation(food.id) : undefined;
                                const borderClass = clientId ? getBorderClass(validation?.severity) : 'border-gray-200 hover:border-[#17cf54]';
                                const isBlocked = validation?.severity === 'RED';

                                return (
                                    <div
                                        key={food.id}
                                        className={`border-2 rounded-lg p-4 flex flex-col transition-all group ${borderClass} ${isBlocked
                                                ? 'cursor-not-allowed opacity-75'
                                                : 'cursor-pointer hover:shadow-md'
                                            }`}
                                        onClick={() => handleFoodClick(food)}
                                    >
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="min-w-0 flex-grow">
                                                <p className="font-semibold text-gray-900 truncate" title={food.name}>
                                                    {food.name}
                                                </p>
                                                <div className="flex items-center gap-2 mt-1">
                                                    <span className={`text-xs px-2 py-0.5 rounded-full ${typeColors.food}`}>
                                                        Food
                                                    </span>
                                                    {validation && validation.alerts.length > 0 && (
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setSelectedAlert(validation);
                                                            }}
                                                            className="text-xs text-gray-400 hover:text-gray-600 flex items-center gap-1"
                                                        >
                                                            <Info className="w-3 h-3" />
                                                            {validation.alerts.length}
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            <div className={`p-1 transition-colors ${isBlocked ? 'text-red-400' : 'text-gray-300 group-hover:text-[#17cf54]'
                                                }`}>
                                                {getValidationIcon(validation) || <Plus className="w-5 h-5" />}
                                            </div>
                                        </div>

                                        {/* Alert preview for RED/YELLOW */}
                                        {validation && validation.alerts.length > 0 && (
                                            <p className={`text-xs mb-2 truncate ${validation.severity === 'RED' ? 'text-red-600' :
                                                    validation.severity === 'YELLOW' ? 'text-yellow-600' :
                                                        'text-green-600'
                                                }`}>
                                                {validation.alerts[0].message.replace(/^[⛔🟡✅]\s*/, '')}
                                            </p>
                                        )}

                                        <p className="text-sm text-gray-500 mb-3 flex-grow truncate">
                                            {food.category} • {food.servingSize}
                                        </p>
                                        <div className="text-xs text-gray-500 flex justify-between items-center bg-gray-50 p-2 rounded">
                                            <span className="font-medium">{food.nutrition.calories} Kcal</span>
                                            <div className="flex gap-2">
                                                <span>P:{food.nutrition.proteinG || 0}</span>
                                                <span>C:{food.nutrition.carbsG || 0}</span>
                                                <span>F:{food.nutrition.fatsG || 0}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>

                {/* Footer */}
                <div className="p-4 border-t border-gray-200 flex justify-end gap-3">
                    <button
                        onClick={onClose}
                        className="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                    >
                        Close
                    </button>
                </div>
            </Modal>

            {/* Alert Details Modal */}
            {selectedAlert && (
                <Modal
                    isOpen={!!selectedAlert}
                    onClose={() => setSelectedAlert(null)}
                    title="Validation Details"
                    size="md"
                >
                    <div className="p-4">
                        <div className="flex items-center gap-3 mb-4">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${selectedAlert.severity === 'RED' ? 'bg-red-100' :
                                    selectedAlert.severity === 'YELLOW' ? 'bg-yellow-100' :
                                        'bg-green-100'
                                }`}>
                                {selectedAlert.severity === 'RED' && <Ban className="w-5 h-5 text-red-500" />}
                                {selectedAlert.severity === 'YELLOW' && <AlertTriangle className="w-5 h-5 text-yellow-500" />}
                                {selectedAlert.severity === 'GREEN' && <Check className="w-5 h-5 text-green-500" />}
                            </div>
                            <div>
                                <h3 className="font-semibold text-gray-900">{selectedAlert.foodName}</h3>
                                <p className={`text-sm font-medium ${selectedAlert.severity === 'RED' ? 'text-red-600' :
                                        selectedAlert.severity === 'YELLOW' ? 'text-yellow-600' :
                                            'text-green-600'
                                    }`}>
                                    {selectedAlert.severity === 'RED' ? 'Cannot Add' :
                                        selectedAlert.severity === 'YELLOW' ? 'Add with Caution' :
                                            'Good to Add'}
                                </p>
                            </div>
                        </div>

                        <div className="space-y-2">
                            {selectedAlert.alerts.map((alert, idx) => (
                                <div
                                    key={idx}
                                    className={`p-3 rounded-lg text-sm ${alert.severity === 'RED' ? 'bg-red-50 text-red-700' :
                                            alert.severity === 'YELLOW' ? 'bg-yellow-50 text-yellow-700' :
                                                'bg-green-50 text-green-700'
                                        }`}
                                >
                                    <p>{alert.message}</p>
                                    {alert.recommendation && (
                                        <p className="mt-1 text-xs opacity-75">
                                            💡 {alert.recommendation}
                                        </p>
                                    )}
                                </div>
                            ))}
                        </div>

                        {selectedAlert.canAdd && (
                            <button
                                onClick={() => {
                                    // Allow adding with warning
                                    setSelectedAlert(null);
                                }}
                                className="mt-4 w-full py-2.5 bg-yellow-500 text-white rounded-lg font-medium hover:bg-yellow-600 transition-colors"
                            >
                                Add Anyway
                            </button>
                        )}
                    </div>
                </Modal>
            )}

            <CreateFoodItemModal
                isOpen={showCreateModal}
                onClose={() => setShowCreateModal(false)}
            />
        </>
    );
}
</file>

<file path="frontend/src/lib/hooks/use-clients.ts">
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useApiClient } from '../api/use-api-client';
import type { FoodRestriction } from './use-validation';

// Types
export interface Client {
    id: string;
    fullName: string;
    email: string;
    phone: string;
    dateOfBirth?: string;
    gender?: 'male' | 'female' | 'other';
    currentWeightKg?: number;
    targetWeightKg?: number;
    heightCm?: number;
    isActive: boolean;
    status?: 'active' | 'at-risk' | 'completed';
    createdAt: string;
    updatedAt: string;
    lastActivityAt?: string;
    primaryDietitian?: {
        id: string;
        fullName: string;
    };
    medicalProfile?: {
        allergies: string[];
        conditions: string[];
        medications: string[];
    };
    // Validation-related fields
    allergies?: string[];
    intolerances?: string[];
    dietPattern?: string;
    medicalConditions?: string[];
    foodRestrictions?: FoodRestriction[];
    dislikes?: string[];
    likedFoods?: string[];
    preferredCuisines?: string[];
    // Nutrition targets
    targetCalories?: number | null;
    targetProteinG?: number | null;
    targetCarbsG?: number | null;
    targetFatsG?: number | null;
}

export interface ClientProgress {
    weight: {
        startWeight: number | null;
        currentWeight: number | null;
        targetWeight: number | null;
        totalChange: number | null;
        last30DaysChange: number | null;
        weeklyAvgChange: number | null;
        progressToGoal: number | null;
    };
    meals: {
        total: number;
        eaten: number;
        substituted: number;
        skipped: number;
        pending: number;
        adherencePercentage: number;
        completionPercentage: number;
    };
    activeDietPlans: number;
}

interface PaginatedResponse<T> {
    success: boolean;
    data: T[];
    meta: {
        page: number;
        pageSize: number;
        total: number;
        totalPages: number;
        hasNextPage?: boolean;
        hasPreviousPage?: boolean;
    };
}

interface ClientsParams {
    page?: number;
    pageSize?: number;
    search?: string;
    status?: string;
}

// Hooks
export function useClients(params: ClientsParams = {}) {
    const api = useApiClient();
    const { page = 1, pageSize = 20, search, status } = params;

    return useQuery({
        queryKey: ['clients', page, pageSize, search, status],
        queryFn: async () => {
            const { data } = await api.get<PaginatedResponse<Client>>('/clients', {
                params: { page, pageSize, search, status },
            });
            return data;
        },
    });
}

export function useClient(id: string) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['clients', id],
        queryFn: async () => {
            const { data } = await api.get(`/clients/${id}`);
            return data.data as Client;
        },
        enabled: !!id,
    });
}

export function useClientProgress(clientId: string, params?: { dateFrom?: string; dateTo?: string }) {
    const api = useApiClient();

    return useQuery({
        queryKey: ['clients', clientId, 'progress', params],
        queryFn: async () => {
            const { data } = await api.get(`/clients/${clientId}/progress`, { params });
            const raw = data.data;
            // Map backend field names to frontend interface
            const progress: ClientProgress = {
                weight: {
                    startWeight: raw.weightTrend?.startWeight ?? null,
                    currentWeight: raw.weightTrend?.currentWeight ?? null,
                    targetWeight: raw.weightTrend?.targetWeight ?? null,
                    totalChange: raw.weightTrend?.totalWeightChange ?? null,
                    last30DaysChange: raw.weightTrend?.last30DaysChange ?? null,
                    weeklyAvgChange: raw.weightTrend?.weeklyAverageChange ?? null,
                    progressToGoal: raw.weightTrend?.progressToGoalPercentage ?? null,
                },
                meals: {
                    total: raw.mealAdherence?.totalMeals ?? 0,
                    eaten: raw.mealAdherence?.eatenMeals ?? 0,
                    substituted: raw.mealAdherence?.substitutedMeals ?? 0,
                    skipped: raw.mealAdherence?.skippedMeals ?? 0,
                    pending: raw.mealAdherence?.pendingMeals ?? 0,
                    adherencePercentage: raw.mealAdherence?.adherencePercentage ?? 0,
                    completionPercentage: raw.mealAdherence?.completionPercentage ?? 0,
                },
                activeDietPlans: raw.activeDietPlans ?? 0,
            };
            return progress;
        },
        enabled: !!clientId,
    });
}

export function useCreateClient() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (clientData: Partial<Client>) => {
            const { data } = await api.post('/clients', clientData);
            return data.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['clients'] });
        },
    });
}

export function useUpdateClient() {
    const api = useApiClient();
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async ({ id, ...clientData }: Partial<Client> & { id: string }) => {
            const { data } = await api.patch(`/clients/${id}`, clientData);
            return data.data;
        },
        onSuccess: (_, variables) => {
            queryClient.invalidateQueries({ queryKey: ['clients'] });
            queryClient.invalidateQueries({ queryKey: ['clients', variables.id] });
        },
    });
}
</file>

<file path="backend/src/app.ts">
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import morgan from 'morgan';
import { clerkMiddleware } from '@clerk/express';
import { errorHandler, notFoundHandler } from './middleware/errorHandler';
import logger from './utils/logger';

const app = express();

// Middleware
app.use(express.json());
app.use(cors());
app.use(helmet());
app.use(morgan('dev'));

// Clerk middleware - adds auth info to every request
app.use(clerkMiddleware());

// Health check
app.get('/health', (req, res) => {
    res.status(200).json({ status: 'ok', timestamp: new Date().toISOString() });
});

import authRoutes from './routes/auth.routes';

import organizationRoutes from './routes/organization.routes';
import clientRoutes from './routes/client.routes';
import dietPlanRoutes from './routes/dietPlan.routes';
import mealRoutes from './routes/meal.routes';
import mealLogRoutes from './routes/mealLog.routes';
import weightLogRoutes from './routes/weightLog.routes';
import foodItemRoutes from './routes/foodItem.routes';
import mediaRoutes from './routes/media.routes';
import dashboardRoutes from './routes/dashboard.routes';
import teamRoutes from './routes/team.routes';
import clientAuthRoutes from './routes/clientAuth.routes';
import clientApiRoutes from './routes/clientApi.routes';
import referralRoutes from './routes/referral.routes';
import reportsRoutes from './routes/reports.routes';
import shareRoutes from './routes/share.routes';
import adminReferralRoutes from './routes/adminReferral.routes';
import validationRoutes from './routes/validation.routes';
import onboardingRoutes from './routes/onboarding.routes';
import notificationRoutes from './routes/notification.routes';
import complianceRoutes from './routes/compliance.routes';

// Routes
app.use('/api/v1/auth', authRoutes);
app.use('/api/v1/organizations', organizationRoutes);
app.use('/api/v1/clients', clientRoutes);
app.use('/api/v1/clients/:clientId/onboarding', onboardingRoutes); // Client onboarding
app.use('/api/v1/clients/:clientId/adherence', complianceRoutes); // Compliance & adherence
app.use('/api/v1/notifications', notificationRoutes);
app.use('/api/v1/diet-plans', dietPlanRoutes);
app.use('/api/v1/meals', mealRoutes);
app.use('/api/v1/meal-logs', mealLogRoutes);
app.use('/api/v1/weight-logs', weightLogRoutes);
app.use('/api/v1/food-items', foodItemRoutes);
app.use('/api/v1/dashboard', dashboardRoutes);
app.use('/api/v1/team', teamRoutes);
app.use('/api/v1/share', shareRoutes); // Diet plan sharing (PDF, email, etc)
app.use('/api/v1/referrals', adminReferralRoutes); // Admin referral management
app.use('/api/v1/diet-validation', validationRoutes); // Real-time diet validation
app.use('/media', mediaRoutes); // Public media proxy (no auth required)

// Client Mobile App Routes
app.use('/api/v1/client-auth', clientAuthRoutes);
app.use('/api/v1/client', clientApiRoutes);
app.use('/api/v1/client/referral', referralRoutes);
app.use('/api/v1/client/reports', reportsRoutes);



// Test-only routes (for development testing without Clerk)
if (process.env.NODE_ENV !== 'production') {
    const testRouter = require('./routes/test.routes').default;
    app.use('/test', testRouter);
}

// 404 handler - must be after all routes
app.use(notFoundHandler);

// Global error handler - must be last
app.use(errorHandler);

export default app;
</file>

<file path="frontend/src/app/dashboard/diet-plans/new/page.tsx">
'use client';

import { Suspense } from 'react';
import Link from 'next/link';
import { useSearchParams, useRouter } from 'next/navigation';
import { ArrowLeft, Save, Send, Loader2 } from 'lucide-react';
import { AddFoodModal } from '@/components/modals/add-food-modal';
import { ClientSelector } from '@/components/diet-plan/client-selector';
import { ClientInfoCard } from '@/components/diet-plan/client-info-card';
import { MedicalSidebar } from '@/components/diet-plan/medical-sidebar';
import { DayNavigator } from '@/components/diet-plan/day-navigator';
import { MealEditor } from '@/components/diet-plan/meal-editor';
import { NutritionSummary } from '@/components/diet-plan/nutrition-summary';
import { TemplateSidebar } from '@/components/diet-plan/template-sidebar';
import { useClient } from '@/lib/hooks/use-clients';
import { useDietPlans } from '@/lib/hooks/use-diet-plans';
import { useMealBuilder } from '@/lib/hooks/use-meal-builder';

function BuilderContent() {
    const searchParams = useSearchParams();
    const router = useRouter();
    const clientId = searchParams.get('clientId');
    const isTemplateMode = searchParams.get('template') === 'true';

    const { data: client, isLoading: clientLoading } = useClient(
        !isTemplateMode && clientId ? clientId : ''
    );

    // Fetch templates for sidebar
    const { data: templatesData } = useDietPlans({ isTemplate: true, pageSize: 50 });
    const templates = templatesData?.data || [];

    const builder = useMealBuilder({
        clientId,
        isTemplateMode,
        client,
        onSaved: (isTemplate) => {
            if (isTemplate) {
                router.push('/dashboard/diet-plans?tab=templates');
            } else if (clientId) {
                router.push(`/dashboard/clients/${clientId}`);
            } else {
                router.push('/dashboard/diet-plans');
            }
        },
    });

    // Client selection screen
    if (!isTemplateMode && !clientId) {
        return <ClientSelector />;
    }

    if (!isTemplateMode && clientLoading) {
        return <div className="flex justify-center p-12"><Loader2 className="animate-spin" /></div>;
    }

    if (!isTemplateMode && !client) {
        return <div className="p-8 text-center text-red-500">Client not found.</div>;
    }

    return (
        <div className="flex flex-col h-[calc(100vh-5rem)] -m-6">
            {/* Top Header */}
            <header className="flex items-center justify-between border-b border-gray-200 px-6 py-3 bg-white flex-shrink-0">
                <div className="flex items-center gap-6">
                    <Link
                        href={isTemplateMode ? '/dashboard/diet-plans' : `/dashboard/clients/${clientId}`}
                        className="flex items-center gap-2 text-gray-600 hover:text-gray-900 text-sm font-medium"
                    >
                        <ArrowLeft className="w-4 h-4" />
                        {isTemplateMode ? 'Back to Templates' : 'Back to Client'}
                    </Link>
                    <div className="flex items-center gap-2">
                        <input
                            value={builder.planName}
                            onChange={e => builder.setPlanName(e.target.value)}
                            className="text-gray-900 text-sm font-medium border-none focus:ring-0"
                        />
                        {!isTemplateMode && client && (
                            <>
                                <span className="text-gray-400">|</span>
                                <span className="text-gray-600 text-sm">
                                    {client.fullName} ({client.dateOfBirth ?
                                        Math.floor((new Date().getTime() - new Date(client.dateOfBirth).getTime()) / 3.15576e10) :
                                        '?'
                                    } yrs)
                                </span>
                            </>
                        )}
                        {isTemplateMode && (
                            <>
                                <span className="text-gray-400">|</span>
                                <span className="text-purple-600 text-sm font-medium">Template</span>
                            </>
                        )}
                    </div>
                </div>
                <div className="flex gap-2">
                    {isTemplateMode ? (
                        <button
                            onClick={() => builder.save(false)}
                            disabled={builder.isSaving}
                            className="flex items-center gap-2 h-10 px-4 bg-[#17cf54] hover:bg-[#17cf54]/90 text-white rounded-lg text-sm font-bold transition-colors disabled:opacity-50"
                        >
                            <Save className="w-4 h-4" />
                            {builder.isSaving ? 'Saving...' : 'Save Template'}
                        </button>
                    ) : (
                        <>
                            <button
                                onClick={() => builder.save(false)}
                                disabled={builder.isSaving}
                                className="flex items-center gap-2 h-10 px-4 bg-gray-200 hover:bg-gray-300 text-gray-900 rounded-lg text-sm font-bold transition-colors disabled:opacity-50"
                            >
                                <Save className="w-4 h-4" />
                                Save Draft
                            </button>
                            <button
                                onClick={() => builder.save(true)}
                                disabled={builder.isSaving}
                                className="flex items-center gap-2 h-10 px-4 bg-[#17cf54] hover:bg-[#17cf54]/90 text-white rounded-lg text-sm font-bold transition-colors disabled:opacity-50"
                            >
                                <Send className="w-4 h-4" />
                                Publish
                            </button>
                        </>
                    )}
                </div>
            </header>

            {/* Main Content */}
            <main className="flex-grow grid grid-cols-12 gap-4 p-4 overflow-hidden bg-gray-50">
                {/* Left Sidebar */}
                <aside className="col-span-3 flex flex-col gap-4 overflow-y-auto pr-2">
                    <ClientInfoCard client={client} isTemplateMode={isTemplateMode} />
                    {!isTemplateMode && clientId && (
                        <MedicalSidebar clientId={clientId} />
                    )}
                    <TemplateSidebar
                        templates={templates}
                        applyingTemplateId={builder.applyingTemplateId}
                        onApplyTemplate={builder.applyTemplate}
                    />
                </aside>

                {/* Center - Meal Editor */}
                <section className="col-span-6 flex flex-col gap-4 overflow-y-auto">
                    <DayNavigator
                        planDates={builder.planDates}
                        selectedDayIndex={builder.selectedDayIndex}
                        onSelectDay={builder.setSelectedDayIndex}
                        isTemplateMode={isTemplateMode}
                    />
                    <MealEditor
                        meals={builder.currentMeals}
                        onAddMeal={builder.addMeal}
                        onRemoveMeal={builder.removeMeal}
                        onOpenAddFood={builder.openAddFood}
                        onRemoveFood={builder.removeFood}
                        onUpdateFoodQuantity={builder.updateFoodQuantity}
                        onUpdateMealField={builder.updateMealField}
                        onAddAlternative={builder.addMealOption}
                        onRemoveOption={builder.removeOption}
                        onUpdateOptionLabel={builder.updateOptionLabel}
                    />
                </section>

                {/* Right Sidebar - Nutrition Summary */}
                <NutritionSummary
                    dayNutrition={builder.dayNutrition}
                    targets={builder.targets}
                    hasAllergyWarning={builder.hasAllergyWarning}
                    onTargetsChange={builder.setTargets}
                />
            </main>

            {/* Add Food Modal */}
            <AddFoodModal
                isOpen={builder.showAddFoodModal}
                onClose={() => builder.setShowAddFoodModal(false)}
                mealType={builder.currentMeals.find(m => m.id === builder.activeMealId)?.name || 'Meal'}
                optionLabel={
                    builder.activeOptionGroup > 0
                        ? builder.currentMeals.find(m => m.id === builder.activeMealId)?.foods
                            .find(f => f.optionGroup === builder.activeOptionGroup)?.optionLabel
                            || `Option ${String.fromCharCode(65 + builder.activeOptionGroup)}`
                        : undefined
                }
                clientId={clientId}
                currentDay={builder.planDates[builder.selectedDayIndex]?.day.toLowerCase()}
                onAddFood={builder.addFood}
            />
        </div>
    );
}

export default function DietPlanBuilderPage() {
    return (
        <Suspense fallback={<div className="flex items-center justify-center min-h-screen"><Loader2 className="w-8 h-8 animate-spin text-[#17cf54]" /></div>}>
            <BuilderContent />
        </Suspense>
    );
}
</file>

</files>
